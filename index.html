<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arrow Tune Calculator</title>
  
  <!-- Version Display -->
  <div class="version-tag">Version 2.0.1</div>

  <meta name="description" content="The most accurate, mobile-friendly arrow tuning calculator with real-world hunting advice." />
  <link href="https://rsms.me/inter/inter.css" rel="stylesheet">
  <style>
    :root { --bg:#f8fafc; --card:#ffffff; --text:#1e293b; --light:#64748b; --border:#e2e8f0; --primary:#0ea5e9; --success:#22c55e; --warning:#f59e0b; --danger:#ef4444; }
    .dark { --bg:#0f172a; --card:#1e293b; --text:#e2e8f0; --light:#94a3b8; --border:#334155; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); padding:1rem; min-height:100vh; line-height:1.6; -webkit-tap-highlight-color:transparent; }
    .container { max-width:1400px; margin:auto; display:grid; gap:1.5rem; }
    @media (min-width:1024px) { .container { grid-template-columns:1fr 1fr; } }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:1.5rem; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .card-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:0.75rem; margin-bottom:1rem; font-size:1.3rem; font-weight:600; }
    h1,h2,h3,h4 { color:var(--text); }
    label { display:block; margin:1rem 0 0.4rem; font-weight:600; font-size:0.95rem; }
    input, select, textarea { width:100%; padding:0.75rem; border:1px solid var(--border); border-radius:8px; background:var(--card); color:var(--text); font-size:1rem; }
    input:focus, select:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(14,165,233,0.2); }
    button, .btn { padding:0.75rem 1.2rem; border:none; border-radius:8px; background:var(--primary); color:white; font-weight:600; cursor:pointer; touch-action:manipulation; }
    .btn-small { padding:0.5rem 0.9rem; font-size:0.9rem; }
    .btn-refresh { background:var(--warning); }
    .flex { display:flex; gap:1rem; align-items:center; flex-wrap:wrap; }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    .toggle-switch { position:relative; display:inline-block; width:56px; height:30px; }
    .toggle-switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; cursor:pointer; inset:0; background:#cbd5e1; border-radius:34px; transition:.3s; }
    .slider:before { position:absolute; content:""; height:24px; width:24px; left:3px; bottom:3px; background:white; border-radius:50%; transition:.3s; }
    input:checked + .slider { background:var(--primary); }
    input:checked + .slider:before { transform:translateX(26px); }
    .info-btn { background:none; border:none; font-size:1.4rem; cursor:pointer; color:var(--light); padding:0.5rem; border-radius:50%; transition:0.2s; }
    .info-btn:hover, .info-btn:active { color:var(--primary); transform:scale(1.2); }
    .takeaway { display:none; margin-top:0.8rem; padding:0.8rem; background:rgba(14,165,233,0.08); border-radius:8px; font-size:0.9rem; color:var(--text); line-height:1.5; }
    .takeaway.show { display:block; }
    .patreon-btn { display:block; margin:3rem auto; background:#ff424d; color:white; text-decoration:none; padding:1rem 2rem; border-radius:12px; font-weight:bold; text-align:center; max-width:300px; }
    .light-only { display: block; }
    .dark-only { display: none; }
    .dark .light-only { display: none; }
    .dark .dark-only { display: block; }
  </style>
</head>
<body>
  <div class="container">
    <!-- LEFT: INPUTS -->
    <div id="inputs-column">
      <div class="card">
        <div class="card-header">
          <h1>Arrow Tune Calculator</h1>
          <div class="flex">
            <span style="color:var(--light);">Light</span>
            <label class="toggle-switch"><input type="checkbox" id="darkModeToggle"><span class="slider"></span></label>
            <span style="color:var(--light);">Dark</span>
          </div>
        </div>
        <p style="color:var(--light);">Offline • Mobile-friendly • Live calculations</p>
      </div>

      <div class="card">
        <div class="card-header"><h2>Manage Builds</h2></div>
        <label>Build Name</label>
        <div class="flex"><input type="text" id="buildName" placeholder="e.g. 2025-John-Hoyt70"><button class="btn-small" id="suggestName">Suggest</button></div>
        <div class="flex" style="margin-top:1rem;gap:0.5rem;flex-wrap:wrap;">
          <button id="saveBuild">Save Build</button>
          <select id="loadBuildSelect"><option value="">– Load Build –</option></select>
          <button style="background:var(--danger);" id="deleteBuild">Delete</button>
        </div>
      </div>
      </div>

      <!-- Bow Setup -->
      <div class="card">
        <div class="card-header"><h2>Bow Setup</h2></div>
        <label>Application</label><select id="application"><option>Target / 3D</option><option selected>Hunting</option><option>Other</option></select>
        <label>Shooter Name</label><input type="text" id="shooterName">
        <label>Bow Model</label><input type="text" id="bowModel">
        <div class="grid-2">
          <div><label>Draw Weight (lbs)</label><input type="number" id="drawWeight" value="70" step="0.5"></div>
          <div><label>Draw Length (in)</label><input type="number" id="drawLength" value="29" step="0.25"></div>
        </div>
        <label>IBO Speed (FPS)</label><input type="number" id="iboRating" value="350">
        <label>String Add-ons (grains)</label><input type="number" id="stringWeightSimple" value="25">
        <div class="flex" style="margin-top:1rem;justify-content:space-between;">
          <label>Advanced String Components</label>
          <label class="toggle-switch"><input type="checkbox" id="toggleString"><span class="slider"></span></label>
        </div>
        <div id="stringAdvanced" class="advanced">
          <div class="grid-2">
            <div><label>Peep</label><input type="number" id="peepWeight" value="0" step="0.5"></div>
            <div><label>D-Loop</label><input type="number" id="dloopWeight" value="0" step="0.5"></div>
            <div><label>Kisser</label><input type="number" id="kisserWeight" value="0" step="0.5"></div>
            <div><label>Silencers</label><input type="number" id="silencersWeight" value="0" step="0.5"></div>
          </div>
          <p style="text-align:right;font-weight:600;">Total: <span id="stringTotal">0</span> grains</p>
        </div>
      </div>

      <!-- Arrow Setup -->
      <div class="card">
        <div class="card-header"><h2>Arrow Setup</h2></div>
        <label>Arrow Name</label><input type="text" id="arrowName">
        <label>Arrow Length (in)</label><input type="number" id="arrowLength" value="28.5" step="0.01">
        <label>Total Arrow Weight (grains)</label><input type="number" id="totalArrowWeightSimple" value="450" step="0.1">
        <label>Point Weight (grains)</label><input type="number" id="pointWeight" value="125">
        <label>Balance Point from Nock (in)</label><input type="number" id="balancePoint" value="18.5" step="0.01">
        <div class="flex" style="margin-top:1rem;justify-content:space-between;">
          <label>Advanced Arrow Components</label>
          <label class="toggle-switch"><input type="checkbox" id="toggleArrow"><span class="slider"></span></label>
        </div>
        <div id="arrowAdvanced" class="advanced">
          <div class="grid-2">
            <div><label>Bare Shaft</label><input type="number" id="bareShaft" value="0" step="0.1"></div>
            <div><label>Nock System</label><input type="number" id="nockWeight" value="0" step="0.1"></div>
            <div><label>Wrap</label><input type="number" id="wrapWeight" value="0" step="0.1"></div>
            <div><label>Vane Weight (each)</label><input type="number" id="vaneWeightEach" value="0" step="0.1"></div>
            <div><label>Vane Count</label><input type="number" id="vaneCount" value="0" step="1"></div>
            <div><label>Insert/Outsert</label><input type="number" id="insertWeight" value="0" step="0.5"></div>
            <div><label>Glue / Pin Nock</label><input type="number" id="glueWeight" value="0" step="0.5"></div>
          </div>
          <p style="text-align:right;font-weight:600;">Total: <span id="arrowTotal">0.0</span> grains</p>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><h2>Notes</h2></div>
        <textarea id="notes" rows="4" placeholder="Tuning notes, chronograph data..."></textarea>
      </div>
    </div>

    <!-- RIGHT: OUTPUTS -->
    <div id="outputs-column">
      <!-- Arrow Efficiency -->
      <div class="card">
        <div class="card-header"><h2>Arrow Efficiency</h2></div>
        <div class="grid-2" style="text-align:center;">
          <div class="card">
            <div style="display:flex;align-items:center;justify-content:center;gap:0.5rem;">
              <h3 style="color:var(--primary);margin:0;">Actual Launch FPS</h3>
              <button class="info-btn" data-target="fpsInfo">i</button>
            </div>
            <input type="number" id="actualFPS" step="0.1" style="font-size:2.5rem;text-align:center;border:3px solid var(--primary);border-radius:12px;padding:0.5rem;">
            <button class="btn-small btn-refresh" id="recalcFPS">Recalculate</button>
            <div id="fpsInfo" class="takeaway">
              Higher = flatter trajectory, easier aiming<br>
              Lower = quieter bow, more forgiving on marginal shots<br>
              280–320 FPS = sweet spot for most hunters
            </div>
          </div>

          <div class="card">
            <div style="display:flex;align-items:center;justify-content:center;gap:0.5rem;">
              <h3 style="color:var(--success);margin:0;">GPP</h3>
              <button class="info-btn" data-target="gppInfo">i</button>
            </div>
            <div style="font-size:2.5rem;" id="gppValue">-</div>
            <div id="gppInfo" class="takeaway">
              Grains Per Pound of draw weight<br>
              6.0–8.0 = perfect hunting balance<br>
              Below 6 = too light (loud, weak penetration)<br>
              Above 9 = very heavy (quiet, deep penetration)
            </div>
          </div>

          <div class="card">
            <div style="display:flex;align-items:center;justify-content:center;gap:0.5rem;">
              <h3 style="color:var(--warning);margin:0;">GPI</h3>
              <button class="info-btn" data-target="gpiInfo">i</button>
            </div>
            <div style="font-size:2.5rem;" id="gpiValue">-</div>
            <div id="gpiInfo" class="takeaway">
              Grains Per Inch of arrow length<br>
              10–18 GPI = modern hunting sweet spot<br>
              Higher GPI = better momentum & penetration
            </div>
          </div>

          <div class="card">
            <div style="display:flex;align-items:center;justify-content:center;gap:0.5rem;">
              <h3 style="margin:0;">Total Weight</h3>
              <button class="info-btn" data-target="weightInfo">i</button>
            </div>
            <div style="font-size:2.5rem;" id="finalArrowWeight">-</div>
            <div id="weightInfo" class="takeaway">
              400–550 gr = most popular hunting range<br>
              550+ gr = maximum penetration setup<br>
              350–400 gr = speed setup (3D/target)
            </div>
          </div>
        </div>
      </div>

      <!-- FOC -->
      <div class="card">
        <div class="card-header"><h2>Front of Center (FOC)</h2></div>
        <div style="text-align:center;">
          <div style="font-size:5rem;font-weight:bold;color:var(--primary);" id="focValue">-</div>
          <svg width="100%" height="160" viewBox="0 0 500 160" style="max-width:500px;margin:1rem auto;border:2px solid var(--border);border-radius:12px;">
            <rect x="50" y="70" width="400" height="20" fill="#e2e8f0" rx="10"/>
            <circle cx="250" cy="80" r="16" fill="var(--warning)" stroke="white" stroke-width="4"/>
            <circle id="balanceMarker" cx="250" cy="80" r="20" fill="var(--primary)" stroke="white" stroke-width="5"/>
            <text id="balanceText" x="250" y="130" text-anchor="middle" fill="var(--primary)" font-weight="bold" font-size="20">-</text>
            <rect x="320" y="60" width="130" height="40" fill="var(--success)" opacity="0.25" rx="15"/>
            <text x="385" y="85" text-anchor="middle" fill="var(--success)" font-weight="bold" font-size="16">12-18% Ideal</text>
          </svg>
          <div style="margin-top:1rem;display:flex;align-items:center;justify-content:center;gap:0.5rem;">
            <strong>FOC Explanation</strong>
            <button class="info-btn" data-target="focInfo">i</button>
          </div>
          <div id="focInfo" class="takeaway">
            <strong>12–18% = Perfect hunting FOC</strong><br>
            10–12% = OK for target/3D<br>
            18–25% = Extreme FOC (maximum penetration on big game)<br>
            Higher FOC = arrow flies point-first longer = better penetration
          </div>
        </div>
      </div>

      <!-- Arrow Weight Composition -->
      <div class="card">
        <div class="card-header"><h2>Arrow Weight Composition</h2></div>
        <div style="text-align:center;">
          <svg width="100%" height="200" viewBox="0 0 500 200" style="max-width:500px;margin:1.5rem auto;border:2px solid var(--border);border-radius:12px;">
            <rect x="50" y="90" width="400" height="20" fill="#e2e8f0" rx="10"/>
            <rect x="50" y="90" width="0" height="20" fill="#94a3b8" rx="10" id="shaftBar"/>
            <rect x="50" y="90" width="0" height="20" fill="#0ea5e9" rx="10" id="pointBar"/>
            <rect x="50" y="90" width="0" height="20" fill="#22c55e" rx="10" id="compBar"/>
            <text x="250" y="65" text-anchor="middle" fill="var(--text)" font-size="16" font-weight="600">Arrow Weight Composition</text>
            <text x="150" y="135" text-anchor="middle" fill="#1e293b" class="light-only" font-weight="bold" font-size="15" id="shaftLabel">Shaft: 0%</text>
            <text x="250" y="135" text-anchor="middle" fill="#1e293b" class="light-only" font-weight="bold" font-size="15" id="pointLabel">Point: 0%</text>
            <text x="350" y="135" text-anchor="middle" fill="#1e293b" class="light-only" font-weight="bold" font-size="15" id="compLabel">Components: 0%</text>
            <text x="150" y="135" text-anchor="middle" fill="#e2e8f0" class="dark-only" font-weight="bold" font-size="15" id="shaftLabel-dark">Shaft: 0%</text>
            <text x="250" y="135" text-anchor="middle" fill="#e2e8f0" class="dark-only" font-weight="bold" font-size="15" id="pointLabel-dark">Point: 0%</text>
            <text x="350" y="135" text-anchor="middle" fill="#e2e8f0" class="dark-only" font-weight="bold" font-size="15" id="compLabel-dark">Components: 0%</text>
          </svg>
          <div style="margin-top:1rem;display:flex;align-items:center;justify-content:center;gap:0.5rem;">
            <strong>Why this matters</strong>
            <button class="info-btn" data-target="compInfo">i</button>
          </div>
          <div id="compInfo" class="takeaway">
            Ideal hunting setup: 25–40% in the point<br>
            More point weight = higher FOC = better penetration<br>
            Components (nock, vanes, wrap, insert) add weight behind center = lower FOC
          </div>
        </div>
      </div>

      <!-- Velocity, Trajectory & Impact -->
      <div class="card">
        <div class="card-header"><h2>Velocity, Trajectory & Impact @ <span id="distanceValue">50</span> yards</h2></div>
        <input type="range" id="distanceSlider" min="0" max="120" value="50" style="width:100%;">
        <div style="height:200px;margin:1.5rem 0;background:var(--card);border-radius:12px;overflow:hidden;border:2px solid var(--border);">
          <svg width="100%" height="200" id="velocityCurve">
            <path id="velocityPath" fill="none" stroke="var(--primary)" stroke-width="5"/>
            <circle id="velocityMarker" r="12" fill="var(--primary)"/>
            <text id="velocityLabel" x="50%" y="50" text-anchor="middle" fill="var(--text)" font-weight="bold" font-size="22">-</text>
          </svg>
        </div>
        <div style="height:160px;background:linear-gradient(to top,#87CEEB40 0%,transparent 100%);border-radius:12px;overflow:hidden;border:2px solid var(--border);">
          <svg width="100%" height="160" id="trajectoryArc" viewBox="0 0 500 160">
            <path id="trajPath" fill="none" stroke="#22c55e" stroke-width="5"/>
            <circle id="trajMarker" r="10" fill="#22c55e"/>
            <text id="peakLabel" x="250" y="40" text-anchor="middle" dominant-baseline="middle" fill="#22c55e" font-weight="bold" font-size="18">-</text>
          </svg>
        </div>

        <div class="grid-2" style="margin-top:1rem;">
          <div class="card text-center"><h3 style="color:var(--success);">Launch KE</h3><div style="font-size:3rem;" id="keValue">-</div><small>ft-lbs</small>
            <div class="takeaway">Energy when arrow leaves the bow</div>
          </div>
          <div class="card text-center"><h3 style="color:var(--warning);">Time to Impact</h3><div style="font-size:3rem;" id="timeToImpact">-</div><small>seconds</small>
            <div class="takeaway">How long arrow is in flight<br>Under 0.35s = very fast<br>Above 0.50s = animal may jump string</div>
          </div>
          <div class="card text-center"><h3 style="color:var(--primary);">Impact KE</h3><div style="font-size:3rem;" id="impactKE">-</div><small>ft-lbs</small>
            <div class="takeaway">Energy when arrow hits animal — this is what matters</div>
          </div>
          <div class="card text-center"><h3 style="color:var(--danger);">Impact Momentum</h3><div style="font-size:3rem;" id="impactMom">-</div><small>slug·ft/s</small>
            <div class="takeaway">Best predictor of penetration<br>0.50+ = deer killer<br>0.60+ = elk capable<br>0.80+ = moose/bear capable</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><h2>Game Effectiveness (Ashby/Reality-Based)</h2></div>
        <table><thead><tr><th>Game</th><th>Min KE</th><th>Min Momentum</th><th>Status</th></tr></thead><tbody id="effectivenessTable"></tbody></table>
        <div class="takeaway" style="margin-top:1rem;">
          <strong>Green = Reliable pass-through expected</strong><br>
          <strong>Red = Marginal — may work, may not</strong>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><h2>Build Summary</h2><button class="btn-small" id="copySummary">Copy</button></div>
        <div id="summaryTable" style="font-size:1rem;"></div>
      </div>
    </div>
  </div>

  <a href="https://www.patreon.com/yourname" target="_blank" class="patreon-btn">Support on Patreon</a>

<script>
  // Dark mode
  const darkToggle = document.getElementById('darkModeToggle');
  if (localStorage.getItem('dark')==='1' || (!localStorage.getItem('dark') && matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.body.classList.add('dark'); darkToggle.checked = true;
  }
  darkToggle.addEventListener('change', () => {
    document.body.classList.toggle('dark', darkToggle.checked);
    localStorage.setItem('dark', darkToggle.checked ? '1' : '0');
  });

  // Build system
  const loadSelect = document.getElementById('loadBuildSelect');
  function refreshBuilds() {
    loadSelect.innerHTML = '<option value="">– Load Build –</option>';
    const builds = JSON.parse(localStorage.getItem('atc') || '{}');
    Object.keys(builds).sort().forEach(n => {
      const o = document.createElement('option'); o.value = n; o.textContent = n; loadSelect.appendChild(o);
    });
  }

  document.getElementById('toggleString').onchange = e => document.getElementById('stringAdvanced').style.display = e.target.checked ? 'block' : 'none';
  document.getElementById('toggleArrow').onchange = e => {
    document.getElementById('arrowAdvanced').style.display = e.target.checked ? 'block' : 'none';
    calculateEverything();
  };

  document.getElementById('saveBuild').onclick = () => {
    const n = document.getElementById('buildName').value.trim();
    if (!n) return alert('Name required');
    const data = {};
    document.querySelectorAll('input,select,textarea').forEach(el => data[el.id] = el.value);
    const all = JSON.parse(localStorage.getItem('atc') || '{}');
    all[n] = data;
    localStorage.setItem('atc', JSON.stringify(all));
    alert('Saved!');
    refreshBuilds();
  };

  loadSelect.onchange = () => {
    const n = loadSelect.value;
    if (!n) return;
    const all = JSON.parse(localStorage.getItem('atc') || '{}');
    const d = all[n];
    Object.keys(d).forEach(k => { const el = document.getElementById(k); if (el) el.value = d[k]; });
    calculateEverything();
  };

  document.getElementById('deleteBuild').onclick = () => {
    const n = loadSelect.value;
    if (!n || !confirm('Delete?')) return;
    const all = JSON.parse(localStorage.getItem('atc') || '{}');
    delete all[n];
    localStorage.setItem('atc', JSON.stringify(all));
    refreshBuilds();
  };

  // Suggest Name
  document.getElementById('suggestName').onclick = () => {
    const d = new Date().toISOString().slice(0,10);
    const s = document.getElementById('shooterName').value.trim() || 'Shooter';
    const b = document.getElementById('bowModel').value.trim() || 'Bow';
    const dw = document.getElementById('drawWeight').value || '70';
    const arrow = document.getElementById('arrowName').value.trim() || 'Arrow';
    const weight = getArrowWeight().toFixed(0);
    document.getElementById('buildName').value = `${d}-${s}-${b}-${dw}lb-${arrow}-${weight}gr`;
  };

  function getArrowWeight() {
    const pointWeight = parseFloat(document.getElementById('pointWeight').value) || 125;

    if (document.getElementById('toggleArrow').checked) {
      const advTotal = parseFloat(document.getElementById('arrowTotal').textContent) || 0;
      return advTotal + pointWeight;
    } else {
      return parseFloat(document.getElementById('totalArrowWeightSimple').value) || 0;
    }
  }

  function calculateEverything(recalcFPS = false) {
    const len = parseFloat(document.getElementById('arrowLength').value) || 28;
    const weight = getArrowWeight();
    const balance = parseFloat(document.getElementById('balancePoint').value) || 18.5;
    const ibo = parseFloat(document.getElementById('iboRating').value) || 350;
    const dw = parseFloat(document.getElementById('drawWeight').value) || 70;
    const stringW = document.getElementById('toggleString').checked ?
      ['peepWeight','dloopWeight','kisserWeight','silencersWeight'].reduce((a,id)=>a+(parseFloat(document.getElementById(id).value)||0),0) :
      parseFloat(document.getElementById('stringWeightSimple').value) || 25;

    // Update advanced totals
    if (document.getElementById('toggleString').checked) {
      const total = ['peepWeight','dloopWeight','kisserWeight','silencersWeight'].reduce((a,id)=>a+(parseFloat(document.getElementById(id).value)||0),0);
      document.getElementById('stringTotal').textContent = total;
    }
    if (document.getElementById('toggleArrow').checked) {
      const total = parseFloat(document.getElementById('bareShaft').value||0) +
        parseFloat(document.getElementById('nockWeight').value||0) +
        parseFloat(document.getElementById('wrapWeight').value||0) +
        (parseFloat(document.getElementById('vaneWeightEach').value||0) * parseFloat(document.getElementById('vaneCount').value||0)) +
        parseFloat(document.getElementById('insertWeight').value||0) +
        parseFloat(document.getElementById('glueWeight').value||0);
      document.getElementById('arrowTotal').textContent = total.toFixed(1);
    }

    // Actual FPS – stays forever unless Recalculate clicked
    const fpsInput = document.getElementById('actualFPS');
    let fps = parseFloat(fpsInput.value);
    if (recalcFPS || isNaN(fps) || fps <= 0) {
      const base = ibo * Math.sqrt((450 + stringW) / (450 + weight + stringW));
      fps = base * 0.94;
      fpsInput.value = fps.toFixed(1);
    }

    const foc = ((balance - len/2) / len) * 100;
    document.getElementById('focValue').textContent = foc.toFixed(1) + '%';
    document.getElementById('balanceMarker').setAttribute('cx', 50 + (balance/len)*400);
    document.getElementById('balanceText').textContent = balance.toFixed(2) + '"';

    document.getElementById('gppValue').textContent = (weight/dw).toFixed(1);
    document.getElementById('gpiValue').textContent = (weight/len).toFixed(1);
    document.getElementById('finalArrowWeight').textContent = weight.toFixed(1) + ' gr';

    const launchKE = (weight * fps * fps) / 450240;
    const launchMom = (weight * fps) / 225400;
    document.getElementById('keValue').textContent = launchKE.toFixed(1);

    const distYards = parseFloat(document.getElementById('distanceSlider').value) || 50;
    document.getElementById('distanceValue').textContent = distYards;

    const currentV = fps * Math.exp(-distYards/300);
    const impactKE = (weight * currentV * currentV) / 450240;
    const impactMom = (weight * currentV) / 225400;
    const time = (distYards * 3) / (fps * 0.8);

    document.getElementById('impactKE').textContent = impactKE.toFixed(1);
    document.getElementById('impactMom').textContent = impactMom.toFixed(3);
    document.getElementById('timeToImpact').textContent = time.toFixed(2);
    document.getElementById('velocityLabel').textContent = currentV.toFixed(0) + ' FPS';

    // Velocity curve
    const path = [];
    for (let d = 0; d <= 120; d += 10) {
      const v = fps * Math.exp(-d/300);
      const x = 20 + (d/120)*460;
      const y = 180 - (v/fps)*150;
      path.push(d===0 ? `M ${x} ${y}` : `L ${x} ${y}`);
    }
    document.getElementById('velocityPath').setAttribute('d', path.join(''));
    document.getElementById('velocityMarker').setAttribute('cx', 20 + (distYards/120)*460);
    document.getElementById('velocityMarker').setAttribute('cy', 180 - (currentV/fps)*150);

    // Trajectory arc – FINAL: Stops at slider distance
    const traj = [];
    let peak = 0;
    let peakYard = 0;

    const launchAngleDeg = 3.5;
    const launchAngleRad = launchAngleDeg * Math.PI / 180;
    const v0x = fps * Math.cos(launchAngleRad);
    const v0y = fps * Math.sin(launchAngleRad);

    const maxD = distYards;

    for (let d = 0; d <= maxD; d += 5) {
      const t = d / v0x;
      const y = v0y * t - 16.1 * t * t;
      if (y > peak) {
        peak = y;
        peakYard = d;
      }
      const x = 20 + (d / 120) * 460;
      const sy = Math.max(0, 140 - y * 6);
      traj.push(d === 0 ? `M ${x} 140` : `L ${x} ${sy}`);
    }

    document.getElementById('trajPath').setAttribute('d', traj.join(''));

    const currentT = distYards / v0x;
    const currentY = v0y * currentT - 16.1 * currentT * currentT;
    const markerX = 20 + (distYards / 120) * 460;
    const markerY = Math.max(0, 140 - currentY * 6);
    document.getElementById('trajMarker').setAttribute('cx', markerX);
    document.getElementById('trajMarker').setAttribute('cy', markerY);

    const peakText = `Peak: ${peak.toFixed(1)} ft @ ${peakYard} yd`;
    document.getElementById('peakLabel').textContent = peakText;

    // Arrow Weight Composition
    const isAdv = document.getElementById('toggleArrow').checked;
    let shaft = 0, point = 0, comp = 0;
    if (isAdv) {
      shaft = parseFloat(document.getElementById('bareShaft').value) || 0;
      const nock = parseFloat(document.getElementById('nockWeight').value) || 0;
      const wrap = parseFloat(document.getElementById('wrapWeight').value) || 0;
      const vanes = (parseFloat(document.getElementById('vaneWeightEach').value) || 0) * (parseFloat(document.getElementById('vaneCount').value) || 0);
      const insert = parseFloat(document.getElementById('insertWeight').value) || 0;
      const glue = parseFloat(document.getElementById('glueWeight').value) || 0;
      comp = nock + wrap + vanes + insert + glue;
      point = parseFloat(document.getElementById('pointWeight').value) || 125;
    } else {
      point = parseFloat(document.getElementById('pointWeight').value) || 125;
      shaft = weight - point;
      comp = 0;
    }

    const totalW = 400;
    const shaftW = (shaft / weight) * totalW;
    const pointW = (point / weight) * totalW;
    const compW = (comp / weight) * totalW;

    document.getElementById('shaftBar').setAttribute('width', shaftW);
    document.getElementById('pointBar').setAttribute('x', 50 + shaftW);
    document.getElementById('pointBar').setAttribute('width', pointW);
    document.getElementById('compBar').setAttribute('x', 50 + shaftW + pointW);
    document.getElementById('compBar').setAttribute('width', compW);

    document.getElementById('shaftLabel').textContent = `Shaft: ${((shaft/weight)*100).toFixed(0)}%`;
    document.getElementById('pointLabel').textContent = `Point: ${((point/weight)*100).toFixed(0)}%`;
    document.getElementById('compLabel').textContent = `Comp.: ${((comp/weight)*100).toFixed(0)}%`;

    // Game Effectiveness
    const games = [["Small Game",25,0.30],["Whitetail Deer",55,0.50],["Elk",70,0.60],["Moose / Bear",90,0.80]];
    document.getElementById('effectivenessTable').innerHTML = games.map(g => `
      <tr>
        <td>${g[0]}</td>
        <td>${g[1]}+ ft-lbs</td>
        <td>${g[2].toFixed(2)}+ slug·ft/s</td>
        <td style="color:${impactKE>=g[1] && impactMom>=g[2]?'var(--success)':'var(--danger)'}">
          <strong>${impactKE.toFixed(0)} / ${impactMom.toFixed(3)}</strong>
        </td>
      </tr>
    `).join('');

    // Build Summary
    const summary = {
      "Build Name": document.getElementById('buildName').value || "Unnamed",
      "Shooter": document.getElementById('shooterName').value || "-",
      "Bow Model": document.getElementById('bowModel').value || "-",
      "Draw Weight": dw + " lbs",
      "IBO Speed": ibo + " FPS",
      "Arrow Length": len.toFixed(2) + " in",
      "Total Arrow Weight": weight.toFixed(1) + " gr",
      "Point Weight": point.toFixed(0) + " gr",
      "FOC": foc.toFixed(1) + "%",
      "GPP": (weight/dw).toFixed(1),
      "GPI": (weight/len).toFixed(1),
      "Launch FPS": fps.toFixed(1),
      "Launch KE": launchKE.toFixed(1) + " ft-lbs",
      "Launch Momentum": launchMom.toFixed(3) + " slug·ft/s",
      [`Impact @ ${distYards} yd`]: "",
      "Impact Velocity": currentV.toFixed(0) + " FPS",
      "Impact KE": impactKE.toFixed(1) + " ft-lbs",
      "Impact Momentum": impactMom.toFixed(3) + " slug·ft/s",
      "Time to Impact": time.toFixed(2) + " s",
      "Peak Height": peak.toFixed(1) + " ft @ " + peakYard + " yd"
    };

    document.getElementById('summaryTable').innerHTML = '<table>' + 
      Object.entries(summary).map(([k,v]) => 
        `<tr><td style="font-weight:600;padding:0.5rem;">${k}</td><td style="text-align:right;padding:0.5rem;">${v}</td></tr>`
      ).join('') + '</table>';
  }

  // Recalculate button
  document.getElementById('recalcFPS').onclick = () => calculateEverything(true);

  // Copy to clipboard
  document.getElementById('copySummary').onclick = () => {
    const text = `Arrow Tune Build - ${new Date().toLocaleDateString()}\n\n` +
      `Build: ${document.getElementById('buildName').value||"Unnamed"}\n` +
      `FPS: ${document.getElementById('actualFPS').value}\n` +
      `Weight: ${getArrowWeight().toFixed(1)} gr\n` +
      `FOC: ${document.getElementById('focValue').textContent}\n` +
      `Launch KE: ${document.getElementById('keValue').textContent} ft-lbs\n` +
      `Impact KE @ ${document.getElementById('distanceValue').textContent}yd: ${document.getElementById('impactKE').textContent} ft-lbs\n` +
      `Peak Height: ${document.getElementById('peakLabel').textContent}\n` +
      `Time to Impact: ${document.getElementById('timeToImpact').textContent}s`;
    navigator.clipboard.writeText(text).then(()=>alert('Copied to clipboard!'));
  };

  // Distance slider
  document.getElementById('distanceSlider').oninput = e => { 
    document.getElementById('distanceValue').textContent = e.target.value; 
    calculateEverything(); 
  };

  // All inputs trigger calculation (FPS stays safe)
  document.querySelectorAll('input,select,textarea').forEach(el => {
    el.addEventListener('input', () => {
      if (document.activeElement.id === 'actualFPS') {
        calculateEverything(false);
      } else {
        calculateEverything();
      }
    });
  });

  // Info button toggle functionality (mobile + desktop)
  document.querySelectorAll('.info-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const target = document.getElementById(btn.dataset.target);
      if (target) {
        target.classList.toggle('show');
      }
    });
  });

  // Close takeways when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.info-btn')) {
      document.querySelectorAll('.takeaway').forEach(el => el.classList.remove('show'));
    }
  });

  refreshBuilds();
  calculateEverything();
</script>
</body>
</html>