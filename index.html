<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!--width=device-width — forces page to fit screen width.
      initial-scale=1.0 — loads at correct zoom.
      maximum-scale=1.0, user-scalable=no — prevents pinch zoom 
        (good for PWA feel — optional, remove if you want zoom).-->
  <meta name="viewport" content="width=device-width, 
    initial-scale=1.0, 
    maximum-scale=1.0, 
    user-scalable=yes">
  
  <meta name="mobile-web-app-capable" content="yes">

  <title>ArrowForge – Smart Arrow Tuner</title>
  <meta name="description" content="Offline-first archery calculator with AI advisor. Perfect arrow tuning made simple.">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQXJyb3dGb3JnZSIsInNob3J0X25hbWUiOiJBcnJvd0ZvcmdlIiwic3RhcnRfdXJsIjoiaHR0cHM6Ly9hIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCxiYXNlNjQsdmFsdWUiOiJkYXRhOmltYWdlL3N2Zyt4bWwgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCB5PSIuOWVtIiBmb250LXNpemU9IjkwIj7wn5iBLTwvdGV4dD48L3N2Zz4iLCJzaXplcyI6IjEyOHgxMjgiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCIsInB1cnBvc2UiOiJhbnkgbWFza2FibGUifV19">
  <link href="https://rsms.me/inter/inter.css" rel="stylesheet">

  <!-- PWA Setup -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6f42c1">

  <!-- iOS Support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ArrowForge">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">

  <!-- Standard Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

  <style>
    :root {
      --bg:#f8fafc; --card:#ffffff; --text:#1e293b; --light:#64748b; --border:#e2e8f0;
      --primary:#0ea5e9; --success:#22c55e; --warning:#f59e0b; --danger:#ef4444; --purple:#8b5cf6;
    }
    .dark {
      --bg:#0f172a; --card:#020617; --text:#e2e8f0; --light:#94a3b8; --border:#1e293b;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Inter',sans-serif;
      background:var(--bg);
      color:var(--text);
      padding:0.5rem; /* desktop */
      padding-bottom: env(safe-area-inset-bottom, 1rem); /* extra bottom space for home bar */
      padding-top: env(safe-area-inset-top, 0.5rem);
      min-height:100vh;
    }
    .container {
      max-width:1600px;
      margin:auto;
      display:grid;
      gap:1rem 1.5rem;
    }
    @media (max-width:768px) {
      body {
        padding:1rem;
        padding-bottom: max(1rem, env(safe-area-inset-bottom));
      }
    }
    @media (max-width:1023px) { .container { grid-template-columns:1fr; } }
    @media (min-width:1024px) { .container { grid-template-columns:460px 1fr; } }
    .card {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:1rem;
      box-shadow:0 4px 12px rgba(15,23,42,0.08);
    }

    /* Left-aligned inputs — clean and mobile-friendly */
    .input-row input,
    .input-row select {
      flex:1;
      min-width:140px;
      text-align: left;  /* ← left-aligned values */
      font-size:1rem;
    }

    /* Desktop: slightly larger, still left-aligned */
    @media (min-width:769px) {
      .input-row input, .input-row select {
        max-width:240px;
        text-align: left;  /* keep left on desktop too */
        font-size:1.05rem;
      }
    }

    /* Minimal tick marks for range sliders */
    input[type="range"] {
      -webkit-appearance: none; /* Remove default styling */
      appearance: none;
      background: linear-gradient(to right, 
        transparent 0%, 
        transparent 4%, 
        var(--light) 4%, 
        var(--light) 6%, 
        transparent 6%, 
        transparent 100%
      ) repeat-x;
      background-size: 10% 6px; /* Adjust for interval spacing (10% = every 10 units on 0-100 scale) */
      background-position: 0 center;
    }

    /* Optional: make ticks even subtler */
    .dark input[type="range"] {
      background-color: var(--border);
    }
    
    /* how-to slides*/
    .onboarding-modal {
      background: var(--card-bg);
      color: var(--text);
      border-radius: 16px;
      max-width: 520px;
      width: 100%;
      height: 90vh;
      max-height: 90vh;
      overflow: hidden;
      position: relative;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
    }

    /* Allow clicks to pass through slides to arrows */
    .slides-wrapper {
      flex: 1;
      overflow: hidden;
    }

    .slides-container {
      display: flex;
      width: 100%;
      height: 100%;
      transition: transform 0.4s ease;
      pointer-events: auto;  /* ← ADD THIS — content is clickable, but wrapper isn't */
    }

    .onboarding-slide {
      min-width: 100%;
      width: 100%;
      padding: 2.5rem 2rem;
      box-sizing: border-box;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      font-size: 1.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 2rem;
      cursor: pointer;
      z-index: 10;
    }

    #prevBtn { left: 1rem; }
    #nextBtn { right: 1rem; }

    .dots {
      text-align: center;
      padding: 1rem 0;
      background: var(--card-bg);
    }

    .dot {
      height: 10px;
      width: 10px;
      background: var(--light);
      border-radius: 50%;
      display: inline-block;
      margin: 0 5px;
      cursor: pointer;
      opacity: 0.6;
    }

    .dot.active {
      background: var(--purple);
      opacity: 1;
    }

    #inputs-column .card { padding:0.8rem; }
    #inputs-column input, #inputs-column select { padding:0.5rem; font-size:0.95rem; }
    #outputs-column .card { padding:1.25rem; }
    #outputs-column h2 { font-size:1.4rem; margin-bottom:1rem; }
    .card-header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.75rem; }
    h1 { font-size:1.5rem; margin:0; }
    input, select {
      width:100%;
      border:1px solid var(--border);
      border-radius:8px;
      background:var(--card);
      color:var(--text);
      padding:0.5rem;
    }

    .input-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:0.5rem 0;
      gap:0.75rem;
    }

    .input-row label {
      margin:0;
      font-weight:600;
      font-size:0.95rem;
      white-space:nowrap;
      color:var(--text);
      flex-shrink:0;
    }

    .input-row label::after {
      content:":";
      margin-left:0.25rem;
      color:var(--light);
    }

    /* Left-aligned inputs on all screens */
    .input-row input,
    .input-row select {
      flex:1;
      min-width:140px;
      text-align:left;     /* ← left-aligned everywhere */
      font-size:1rem;
    }

    @media (min-width:769px) {
      .input-row {
        gap:1rem;
      }
      .input-row input,
      .input-row select {
        max-width:240px;
        text-align:left;   /* ← keep left on desktop too */
        font-size:1.05rem;
      }
      .input-row label {
        font-size:1rem;
      }
    }
    .collapsible-trigger {
      cursor:pointer;
      padding:0.75rem 0 0.5rem;
      margin-top:0.75rem;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:600;
      color:var(--primary);
    }
    .collapsible-trigger .chevron {
      font-size:1.5rem;
      transition:transform 0.25s ease;
      color:var(--light);
    }
    .collapsible-trigger.open .chevron { transform:rotate(90deg); }
    .collapsible-content { display:none; padding-top:0.5rem; }
    .collapsible-trigger.open + .collapsible-content { display:block; }
    @media (max-width:768px) {
      .collapsible-mobile .card-content { display:none; }
      .collapsible-mobile.open .card-content { display:block; }
      .mobile-only-trigger {
        display:flex !important;
        cursor:pointer;
        padding:0.75rem 1rem;
        background:var(--card);
        border-top:1px solid var(--border);
        justify-content:space-between;
        align-items:center;
        font-weight:600;
        color:var(--primary);
        margin-top:0.5rem;
        border-radius:0 0 14px 14px;
      }
      .collapsible-mobile.open .mobile-only-trigger .chevron { transform:rotate(90deg); }
    }
    @media (min-width:769px) {
      .mobile-only-trigger { display:none !important; }
      .collapsible-mobile .card-content { display:block !important; }
    }
    .mobile-only-trigger { display:none; }
    button {
      padding:0.5rem 1rem;
      border:none;
      border-radius:999px;
      background:var(--primary);
      color:white;
      font-weight:600;
      font-size:0.95rem;
      line-height:1;
      cursor:pointer;
      min-height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btn-small { padding:0.35rem 0.7rem; font-size:0.85rem; }
    .secondary { background:transparent; color:var(--primary); border:1px solid var(--primary); }
    .flex { display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; }
    .toggle-switch { position:relative; width:50px; height:26px; }
    .toggle-switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; inset:0; background:#cbd5e1; border-radius:34px; transition:.3s; }
    .slider:before { position:absolute; content:""; height:20px; width:20px; left:3px; bottom:3px; background:white; border-radius:50%; transition:.3s; }
    input:checked + .slider { background:var(--primary); }
    input:checked + .slider:before { transform:translateX(24px); }
    .info-overlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.5);
      display:none; align-items:center; justify-content:center; z-index:1000;
    }
    .info-panel {
      background:var(--card);
      border-radius:12px;
      max-width:600px;
      width:90%;
      max-height:90vh;
      padding:1.5rem;
      box-shadow:0 20px 40px rgba(0,0,0,0.3);
      position:relative;
      overflow-y:auto;
    }
    .info-close {
      position:absolute; top:0.8rem; right:1rem;
      background:none; border:none; font-size:1.8rem;
      color:var(--light); cursor:pointer;
    }
  .game-table { width:100%; border-collapse:collapse; font-size:0.95rem; margin-top:0.5rem; }
    .game-table th, .game-table td { padding:0.5rem; text-align:center; border-bottom:1px solid var(--border); }
    .game-table th { background:var(--border); font-weight:600; }
    .send { color:var(--success); font-weight:700; }
    .marginal { color:var(--warning); font-weight:700; }
    .adjust { color:var(--danger); font-weight:700; }
  
  .stats-list { display:flex; flex-direction:column; gap:0.75rem; }
  .stat-item { }
    .bar {
      height:12px;
      border-radius:999px;
      background:var(--border);
      position:relative;
      overflow:visible; /* changed from hidden */
    }

    .stat-row {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .stat-title {
      width: 120px; /* fixed width for all titles — adjust as needed */
      text-align: right;
      flex-shrink: 0;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 0.5rem;
    }

    .stat-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .bar-fill {
      height:100%;
      border-radius:999px;
      transition:width 0.3s ease;
    }

    /* FOC Sweet Spot — Green (default for compound/hunting: 12–18%) */
    .foc-sweet-spot {
      position:absolute;
      top:0;
      left:40%;     /* 12% on 0–30 scale = 40% */
      width:20%;    /* 6% range = 20% of bar */
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
      transition: left 0.3s ease, width 0.3s ease;
    }

    .foc-low-zone, .foc-high-zone {
      position:absolute;
      top:0;
      height:100%;
      background:rgba(245,158,11,0.15); /* yellow */
      border-radius:999px;
      transition: width 0.3s ease;
    }

    .foc-low-zone { left:0; width:40%; }
    .foc-high-zone { left:60%; width:40%; }

    /* bar labels*/
    .bar-labels {
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      margin-top: 0.3rem;
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--light);
      pointer-events: none;
    }

    /* GPP Sweet Spot — Green (balanced 6.5–7.5) */
    .gpp-sweet-spot {
      position:absolute;
      top:0;
      left:30%;     /* 6.5 on 5–10 scale = 30% */
      width:20%;    /* 1 unit range = 20% of bar */
      height:100%;
      background:rgba(34,197,94,0.25); /* green */
      border-radius:999px;
    }

    /* Low GPP — Yellow (<6.5) */
    .gpp-low-zone {
      position:absolute;
      top:0;
      left:0;
      width:30%;
      height:100%;
      background:rgba(245,158,11,0.15); /* yellow */
      border-radius:999px;
    }

    /* High GPP — Yellow (>7.5) */
    .gpp-high-zone {
      position:absolute;
      top:0;
      left:50%;     /* starts at 7.5 */
      width:50%;
      height:100%;
      background:rgba(245,158,11,0.15); /* yellow */
      border-radius:999px;
    }

    /* GPI Sweet Spot — Green (default for compound/hunting: 7–9.5) */
    .gpi-sweet-spot {
      position:absolute;
      top:0;
      left:35%;     /* 7 on 0–20 scale = 35% */
      width:12.5%;  /* 2.5 unit range = 12.5% */
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
      transition: left 0.3s ease, width 0.3s ease;
    }

    .gpi-low-zone, .gpi-high-zone {
      position:absolute;
      top:0;
      height:100%;
      background:rgba(245,158,11,0.15);
      border-radius:999px;
      transition: width 0.3s ease;
    }

    .gpi-low-zone { left:0; width:35%; }
    .gpi-high-zone { left:47.5%; width:52.5%; }

    /* Total Arrow Weight Sweet Spot — Green (default compound/hunting: 450–550) */
    .totalwt-sweet-spot {
      position:absolute;
      top:0;
      left:42%;     /* 450 on 50–1000 scale ≈ 42% */
      width:10.5%;  /* 100 gr range = ~10.5% */
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
      transition: left 0.3s ease, width 0.3s ease;
    }

    .totalwt-low-zone, .totalwt-high-zone {
      position:absolute;
      top:0;
      height:100%;
      background:rgba(245,158,11,0.15);
      border-radius:999px;
      transition: width 0.3s ease;
    }

    .totalwt-low-zone { left:0; width:42%; }
    .totalwt-high-zone { left:52.5%; width:47.5%; }

    /* Stiffness Sweet Spot — Green (default compound/hunting: ~40–60% of bar) */
    .stiffness-sweet-spot {
      position:absolute;
      top:0;
      left:25%;     /* default start */
      width:50%;    /* default width */
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
      transition: left 0.3s ease, width 0.3s ease;
    }

    .stiffness-low-zone, .stiffness-high-zone {
      position:absolute;
      top:0;
      height:100%;
      background:rgba(245,158,11,0.15);
      border-radius:999px;
      transition: width 0.3s ease;
    }

    .stiffness-low-zone { left:0; width:25%; }
    .stiffness-high-zone { left:75%; width:25%; }

    /* Flatness Sweet Spot — Green (under 4.5 ft drop = flat) */
    .flatness-sweet-spot {
      position:absolute;
      top:0;
      left:33.33%;     /* 4.5 ft on ~0–6 ft scale */
      width:66.67%;    /* covers 0–4.5 ft */
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
    }

    .flatness-high-zone {
      position:absolute;
      top:0;
      left:0;
      width:33.33%;
      height:100%;
      background:rgba(245,158,11,0.15); /* yellow for curved */
      border-radius:999px;
    }

    /* Group Stability Zones */
    .group-zero-zone {
      position:absolute;
      top:0;
      left:0;
      width:25%; /* 0/3 */
      height:100%;
      background:rgba(156,163,175,0.25); /* grey */
      border-radius:999px;
    }
    .group-one-zone {
      position:absolute;
      top:0;
      left:25%;
      width:25%;
      height:100%;
      background:rgba(251,191,36,0.3); /* amber yellow — more distinct from orange */
      border-radius:999px;
    }
    .group-two-zone {
      position:absolute;
      top:0;
      left:50%;
      width:25%;
      height:100%;
      background:rgba(251,146,60,0.35); /* keep orange but slightly stronger */
      border-radius:999px;
    }
    .group-three-zone {
      position:absolute;
      top:0;
      left:75%;
      width:25%; /* 3/3 */
      height:100%;
      background:rgba(34,197,94,0.25); /* green */
      border-radius:999px;
    }

    .bar-marker {
      position: absolute;
      top: 0;
      width: 4px;
      height: 100%;
      background: #ef4444; /* red (same as your --danger) */
      border-radius: 2px;
      transform: translateX(-50%);
      transition: left 0.3s ease;
    }

    /* Re-use your existing Quick Stats bar styles, just add fill */
    .bar-fill {
      height: 100%;
      width: 0;
      background: var(--primary);
      border-radius: 999px;
      transition: width 0.3s ease;
    }

    /* Green fill for effective load */
    #effectiveLoadFill {
      background: var(--success) !important;
    }

    .stat-bar-container {
      width: 100%; /* takes full width of the flex item */
      min-width: 240px; /* minimum for small screens */
      max-width: 1000px; /* maximum for large screens — adjust if you want wider */
      margin-right: 0;
      position: relative;
    }

    @media (max-width: 768px) {
      .stat-bar-container {
        max-width: 300px; /* slightly smaller on mobile */
      }
    }

    .info-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem; /* smaller and consistent with text */
      color: var(--primary);
      padding: 0;
      margin-left: 0.4rem;
      line-height: 1;
      opacity: 0.8;
      transition: opacity 0.2s ease;
    }

    .info-btn:hover {
      opacity: 1;
    }

    /* Ensure it looks good in dark mode too */
    .dark .info-btn {
      color: var(--primary);
      opacity: 0.8;
    }

    .dark .info-btn:hover {
      opacity: 1;
    }

    .moving-value {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: .85rem;
      font-weight: 400;
      opacity: 0.9;
      color: var(--text);
      white-space: nowrap;
      pointer-events: none;
      transition: left 0.3s ease;
      z-index: 10;
    }

    .bar-marker {
      background: #ef4444; /* red */
    }

    /* Better spacing for Group Stability 0-1-2-3 labels */
    #groupStabilityValue ~ .stat-bar-container .bar-labels {
      justify-content: space-between;
      width: 100%;
      padding: 0 4px; /* small padding so labels don't touch edges */
    }

    #groupStabilityValue ~ .stat-bar-container .bar-labels span:nth-child(1) { left: 0%; }
    #groupStabilityValue ~ .stat-bar-container .bar-labels span:nth-child(2) { left: 33.33%; }
    #groupStabilityValue ~ .stat-bar-container .bar-labels span:nth-child(3) { left: 66.67%; }
    #groupStabilityValue ~ .stat-bar-container .bar-labels span:nth-child(4) { left: 100%; }

    #groupStabilityValue ~ .stat-bar-container .bar-labels span {
      position: absolute;
      transform: translateX(-50%);
      font-size: 0.85rem;
      color: var(--light);
    }

    #groupStabilityValue ~ .stat-bar-container .bar-labels span:nth-child(4) {
      transform: translateX(-100%); /* align "3" to the right edge */
    }

    .effective-load-sweet-spot {
      position:absolute;
      top:0; left:30%;
      width:50%;
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
    }

    /* Make Effective Draw Weight titles match Game Effectiveness class names */
    .effective-dw-title {
      font-weight: 400;
      font-size: .95rem;
      color: var(--text);
    }

    #summaryTable td:nth-child(2) {
      white-space: pre-wrap;     /* preserves line breaks and wraps long text */
      word-break: break-word;    /* breaks long words if needed */
      max-width: 300px;          /* optional: limit width on desktop for better layout */
    }

    /* Raw Equation Box — light mode default */
    .raw-equation {
      font-family: monospace;
      background: #f1f5f9;
      color: #333;
      padding: 0.75rem;
      border-radius: 8px;
      font-size: 0.95rem;
    }

    /* Dark mode override */
    .dark .raw-equation {
      background: #1e293b;  /* dark slate */
      color: #e2e8f0;       /* light text */
    }

    #loadBuild::-webkit-scrollbar {
      width: 8px;
    }
    #loadBuild::-webkit-scrollbar-track {
      background: var(--card-bg);
    }
    #loadBuild::-webkit-scrollbar-thumb {
      background: var(--purple);
      border-radius: 4px;
    }
    .ai-status {
      display: none;
      color: var(--primary);
      font-style: italic;
      margin-top: 0.5rem;
      text-align: center;
      width: 100%;
    }
    #analyzerModal .info-panel {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
    }
    #analyzerResults strong {
      color: var(--primary);
    }
    #analyzerResults p {
      color: var(--text);
    }
  </style>
</head>
<body>
<div class="container">
  <div id="inputs-column">    <div class="card">
      <div class="card-header" style="display:flex; flex-direction:column; align-items:center; text-align:center; gap:1rem; padding:1.5rem 1rem;">
        <!-- Centered Logo — constrained to column width -->
        <img id="appLogo" src="logo-dark.png" alt="ArrowForge Logo"
             style="height: clamp(100px, 10vw, 150px); width: auto; max-width: 100%; max-height: 150px; object-fit: contain;">

        <!-- Controls below logo -->
        <div class="flex" style="gap:1rem; flex-wrap:wrap; justify-content:center;">
          <span style="color:var(--light);">Light</span>
          <label class="toggle-switch">
            <input type="checkbox" id="darkToggle"><span class="slider"></span>
          </label>
          <span style="color:var(--light);">Dark</span>
          <button onclick="showGettingStarted()" class="secondary">How To</button>
        </div>
      </div>

      <p style="color:var(--light);font-size:0.85rem; margin-top:0.5rem; text-align:center;">ArrowForge • Offline • Live • v0.0.20</p>
    </div>
    
    <div class="card">
      <h2>Build</h2>
      
      <!-- Build Name input — lengthened -->
      <div class="input-row" style="align-items:center; gap:0.5rem; margin-bottom:0.75rem;">
        <label for="buildName" style="min-width:100px;">Build Name</label>
        <input type="text" id="buildName" placeholder="e.g. 2025 Hoyt RX-9 70lb 500gr Elk Heavy"  class="left-align" style="flex:1; width:100%; max-width:none;">
      </div>

      <!-- Load dropdown on its own row — scrollable -->
      <div style="margin-top:0.75rem;">
        <select id="loadBuild" style="width:100%; max-height:200px; overflow-y:auto; padding:0.5rem;">
          <option>– Load Build –</option>
          <!-- options added by JS -->
        </select>
      </div>

      <!-- All buttons on one row — stay inline, wrap only on very small screens -->
      <div style="margin-top:0.75rem; display:flex; justify-content:center; gap:0.5rem; flex-wrap:nowrap; overflow-x:auto; padding:0.25rem 0;">
        <button class="btn-small secondary" onclick="suggestBuildName()">Auto Name</button>
        <button onclick="clearBuildFields()" class="secondary">Clear</button>
        <button id="saveBuild">Save</button>
        <button id="deleteBuild" style="background:var(--danger);">Delete</button>
        <!--REMOVE <button id="aiButton" class="btn-small" style="background:var(--purple);">AI Advisor</button>-->
      </div>
    </div>

    <!---BOW INPUTS-->
    <div class="card" id="bowCard">
      <div class="collapsible-trigger" onclick="this.classList.toggle('open')">
        <span>Bow Details</span>
        <div style="display:flex; align-items:center; gap:0.75rem;">
          <button onclick="event.stopPropagation(); promptBowLookup()"
                  class="btn-small"
                  style="background:var(--purple); padding:0.4rem 0.8rem;">
            AI Lookup ✨
          </button>
          <div id="lookupStatus" class="ai-status"></div>
          <span class="chevron">></span>
        </div>
      </div>
      <div class="collapsible-content">
        <div class="input-row"><label for="appType">Application</label><select id="appType"><option>Target</option><option selected>Hunting</option><option>Other</option></select></div>
        <!---Bow Model-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="bowModel">Model</label>
            <button type="button" onclick="showBowModelPopup()" class="info-btn" title="About Bow Model">ⓘ</button>
          </div>
          <input type="text" id="bowModel" placeholder="Hoyt RX-9" class="left-align" style="flex:1;">
        </div>
        <!---Bow Type-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="bowType">Bow Type</label>
            <button type="button" onclick="showBowTypePopup()" class="info-btn" title="About Bow Type">ⓘ</button>
          </div>
          <select id="bowType" onchange="updatePinCountForTraditional()">
            <option value="compound" selected>Compound</option>
            <option value="recurve">Recurve</option>
            <option value="longbow">Longbow</option>
          </select>
        </div>
        <!---IBO fps-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="ibo">IBO fps</label>
            <button type="button" onclick="showIboPopup()" class="info-btn" title="About IBO Speed">ⓘ</button>
          </div>
          <input type="number" id="ibo" placeholder="340" min="200" max="400" step="1" class="left-align" style="flex:1;">
        </div>  
        <!---Brace Height-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="braceHeight">Brace height in</label>
            <button type="button" onclick="showBraceHeightPopup()" class="info-btn" title="About Brace Height">ⓘ</button>
          </div>
          <input type="number" id="braceHeight" placeholder="6" min="0" max="20" step="0.1" class="left-align" style="flex:1;">
        </div>        
        <!---Cam System-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="camType">Cam System</label>
            <button type="button" onclick="showCamTypePopup()" class="info-btn" title="About Cam System">ⓘ</button>
          </div>
          <input type="text" id="camType" placeholder="e.g. Hybrid, SwitchWeight" class="left-align" style="flex:1;">
        </div>
        <!---Draw Weight-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="drawWt">Draw wt lb</label>
            <button type="button" onclick="showDrawWtPopup()" class="info-btn" title="About Draw Weight">ⓘ</button>
          </div>
          <input type="number" id="drawWt" placeholder="70" min="0" max="120" step="0.5" class="left-align" style="flex:1;">
        </div>
        <!---Draw Length-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="drawLen">Draw length in</label>
            <button type="button" onclick="showDrawLenPopup()" class="info-btn" title="About Draw Length">ⓘ</button>
          </div>
          <input type="number" id="drawLen" placeholder="29" min="0" max="40" step="0.1" class="left-align" style="flex:1;">
        </div>
        <!---Let off %--> 
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="letOff">Let-off %</label>
            <button type="button" onclick="showLetOffPopup()" class="info-btn" title="About Let-off">ⓘ</button>
          </div>
          <input type="number" id="letOff" placeholder="80" min="0" max="90" step="1" class="left-align" style="flex:1;">
        </div> 
        <!---String Weight-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="stringWt">String add-ons gr</label>
            <button type="button" onclick="showStringAddonsPopup()" class="info-btn" title="About String Add-ons">ⓘ</button>
          </div>
          <input type="number" id="stringWt" placeholder="20" min="0" step="0.5" class="left-align" style="flex:1;">
        </div>

        <!---String Details-->
        <div class="collapsible-trigger" onclick="this.classList.toggle('open'); this.nextElementSibling.style.display = this.classList.contains('open') ? 'block' : 'none';">
          <span>String Details</span>
          <span class="chevron">></span>
        </div>
          <div class="collapsible-content">
          <!-- Checkbox to enable detailed string components -->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <label for="useStringDetails">Use detailed components</label>
            <input type="checkbox" id="useStringDetails" onchange="toggleStringDetailsMode()">
          </div>
          <!--Peep Weight-->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="peepWt">Peep weight gr</label>
              <button type="button" onclick="showPeepWtPopup()" class="info-btn" title="About Peep Weight">ⓘ</button>
            </div>
            <input type="number" id="peepWt" placeholder="0" step="0.5" class="left-align" style="flex:1;" min="0" max="30">
          </div>
          <!--D Loop Weight-->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="dloopWt">D-loop gr</label>
              <button type="button" onclick="showDloopWtPopup()" class="info-btn" title="About D-loop Weight">ⓘ</button>
            </div>
            <input type="number" id="dloopWt" placeholder="0" step="0.5" class="left-align" style="flex:1;"min="0" max="30">
          </div>
          <!--Kisser Weight-->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="kisserWt">Kisser gr</label>
              <button type="button" onclick="showKisserWtPopup()" class="info-btn" title="About Kisser Weight">ⓘ</button>
            </div>
            <input type="number" id="kisserWt" placeholder="0" step="0.5" class="left-align" style="flex:1;" min="0" max="20">
          </div>
          <!--Silencer Weight-->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="silencerWt">Silencers gr</label>
              <button type="button" onclick="showSilencerWtPopup()" class="info-btn" title="About Silencers Weight">ⓘ</button>
            </div>
            <input type="number" id="silencerWt" placeholder="0" step="0.5" class="left-align" style="flex:1;" min="0" max="50">
          </div>
          <!-- New total display -->
          <div style="margin-top:1rem; padding:0.75rem; background:var(--border); border-radius:8px; text-align:center;">
            <strong>Total String Add-ons: <span id="stringAddonsTotal">0</span> gr</strong>
            <p style="font-size:0.85rem; color:var(--light); margin-top:0.5rem;">
              Auto-calculated from details above. Edit main field to override.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Sight Pin Zeros Card - Collapsible on all devices -->
    <div class="card" id="sightCard">
      <div class="collapsible-trigger" onclick="this.classList.toggle('open')">
        <span>Sight</span>
        <span class="chevron">></span>
      </div>
      <div class="collapsible-content">
        <!-- Number of Pins with info icon next to label -->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="pinCount">Number of Pins</label>
            <button type="button" onclick="showSightPinsPopup()" class="info-btn" title="About Sight Pin Zeros">ⓘ</button>
          </div>
          <select id="pinCount" style="flex:1;">
            <option value="0">No Pins / Instinctive</option>
            <option value="1">1-pin (Slider or Target)</option>
            <option value="2">2-pin</option>
            <option value="3" selected>3-pin</option>
            <option value="4">4-pin</option>
            <option value="5">5-pin</option>
          </select>
        </div>

        <!-- Dynamic pin zero inputs -->
        <div id="pinInputs" class="left-align" style="margin-top:1rem; display:grid; gap:0.75rem;">
          <!-- JS fills this -->
        </div>

        <p style="font-size:0.9rem; color:var(--light); margin-top:0.75rem;">
          Set exact zero yardage for each pin — common for fixed pins or slider sights.
        </p>
      </div>
    </div>

    <!---ARROW INPUTS-->
    <!-- AI Analyzer Card -->
    <div class="card" id="arrowCard">
      <div class="collapsible-trigger" onclick="this.classList.toggle('open')">
        <span>Arrow Details</span>
        <div style="display:flex; align-items:center; gap:0.75rem;">
          <button onclick="event.stopPropagation(); runAIAnalyzer()"
                  class="btn-small"
                  style="background:var(--purple); padding:0.4rem 0.8rem;">
            AI Analyzer ✨
          </button>
          <!-- Status element - matches AI Lookup style -->
          <div id="analyzerStatus" class="ai-status"></div>
          <span class="chevron">></span>
        </div>
      </div>
      <div class="collapsible-content">
        <!---Arrow Name-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="arrowName">Name</label>
            <button type="button" onclick="showArrowNamePopup()" class="info-btn" title="About Arrow Name">ⓘ</button>
          </div>
          <input type="text" id="arrowName" placeholder="Victory VAP TKO" class="left-align" style="flex:1;">
        </div>        
        <!---Arrow Spine-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="spine">Spine</label>
            <button type="button" onclick="showSpinePopup()" class="info-btn" title="About Spine">ⓘ</button>
          </div>
          <input type="number" id="spine" placeholder="300" min="100" max="600" step="10" class="left-align" style="flex:1;">
        </div>
        <!---Arrow Diameter-->       
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="arrowDia">Diameter</label>
            <button type="button" onclick="showArrowDiaPopup()" class="info-btn" title="About Arrow Diameter">ⓘ</button>
          </div>
          <select id="arrowDia" style="flex:1;">
            <option value="standard">None</option>
            <option value="standard">Standard (~6.5mm / .246")</option>
            <option value="small">Small (~5mm / .204")</option>
            <option value="micro" selected>Micro (~4mm / .166")</option>
          </select>
        </div>
        <!---Arrow Length-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="arrowLen">Length in</label>
            <button type="button" onclick="showArrowLenPopup()" class="info-btn" title="About Arrow Length">ⓘ</button>
          </div>
          <input type="number" id="arrowLen" placeholder="28.5" min="20" max="35" step="0.1" class="left-align" style="flex:1;">
        </div>        
        <!---Total Weight-->        
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="totalWt">Total weight gr</label>
            <button type="button" onclick="showTotalWtInputPopup()" class="info-btn" title="About Total Arrow Weight">ⓘ</button>
          </div>
          <input type="number" id="totalWt" placeholder="495" min="200" max="1000" step="0.5" class="left-align" style="flex:1;">        </div>        
        <!---Point Weight-->           
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="pointWt">Point weight gr</label>
            <button type="button" onclick="showPointWtPopup()" class="info-btn" title="About Point Weight">ⓘ</button>
          </div>
          <input type="number" id="pointWt" placeholder="125" min="50" max="300" step="0.5" class="left-align" style="flex:1;">
        </div>        
        
        <!---Balance Point-->          
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="balancePt">Balance point in</label>
            <button type="button" onclick="showBalancePtPopup()" class="info-btn" title="About Balance Point">ⓘ</button>
          </div>
          <input type="number" id="balancePt" placeholder="17.2" min="10" max="30" step="0.05" class="left-align" style="flex:1;">
        </div>        
        
        <!---Components-->    
        <div class="collapsible-trigger" onclick="this.classList.toggle('open'); this.nextElementSibling.style.display = this.classList.contains('open') ? 'block' : 'none';">
          <span>Component Details</span>
          <span class="chevron">></span>
        </div>

        <div class="collapsible-content">
          <!-- New: Bare Shaft Weight -->

          <!-- Checkbox to enable detailed arrow components -->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <label for="useArrowDetails">Use detailed components</label>
            <input type="checkbox" id="useArrowDetails" onchange="toggleArrowDetailsMode()">
          </div>
          <!--Bare Shaft Weight-->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="bareShaftWt">Bare shaft weight gr</label>
              <button type="button" onclick="showBareShaftWtPopup()" class="info-btn" title="About Bare Shaft Weight">ⓘ</button>
            </div>
            <input type="number" id="bareShaftWt" placeholder="0" min="0" step="0.5" class="left-align" style="flex:1;">
          </div>
          <!--Insert Weight-->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="insertWt">Insert/Outsert gr</label>
              <button type="button" onclick="showInsertWtPopup()" class="info-btn" title="About Insert/Outsert">ⓘ</button>
            </div>
            <input type="number" id="insertWt" placeholder="0" min="0" max="300" step="0.5" class="left-align" style="flex:1;">
          </div>

          <!-- Point Type -->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="pointType">Point Type</label>
              <button type="button" onclick="showPointTypePopup()" class="info-btn" title="About Vane Weight">ⓘ</button>
            </div>
            <select id="pointType" style="flex:1;">
              <option value="Fixed Blade">None</option>
              <option value="Fixed Blade">Fixed Blade</option>
              <option value="Mechanical">Mechanical</option>
              <option value="Field">Field Point</option>
            </select>
          </div>

          <!-- In-Flight Diameter -->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="inFlightDia">In-Flight Diameter in.</label>
              <button type="button" onclick="showInFlightDiaPopup()" class="info-btn" title="About Vane Weight">ⓘ</button>
            </div>
            <input type="number" id="inFlightDia" placeholder="e.g. 1.25" min="0.2" max="5.0" step="0.01" class="left-align" style="flex:1;">
          </div>

          <!--wrap weight-->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="wrapWt">Wrap gr</label>
              <button type="button" onclick="showWrapWtPopup()" class="info-btn" title="About Wrap">ⓘ</button>
            </div>
            <input type="number" id="wrapWt" placeholder="0" min="0" max="30" step="0.5" class="left-align" style="flex:1;">
          </div>

          <!--vane weight each-->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="vaneWt">Vane weight (each) gr</label>
              <button type="button" onclick="showVaneWtPopup()" class="info-btn" title="About Vane Weight">ⓘ</button>
            </div>
            <input type="number" id="vaneWt" placeholder="0" min="0" max="20" step="0.1" class="left-align" style="flex:1;">
          </div>

          <!--vane count-->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="vaneCount">Vane count</label>
              <button type="button" onclick="showVaneCountPopup()" class="info-btn" title="About Vane Count">ⓘ</button>
            </div>
            <input type="number" id="vaneCount" placeholder="0" min="0" max="6" step="1" class="left-align" style="flex:1;">
          </div>

          <!--vane height-->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="vaneHeight">Vane Height (in)</label>
              <button type="button" onclick="showVaneHeightPopup()" class="info-btn" title="About Vane Height">ⓘ</button>
            </div>
            <input type="number" id="vaneHeight" placeholder="0.5" min="0.2" max="5.0" step="0.05" class="left-align" style="flex:1;">
          </div>

          <!--helical-->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="vaneHelical">Helical / Offset</label>
              <button type="button" onclick="showVaneHelicalPopup()" class="info-btn" title="About Helical/Offset">ⓘ</button>
            </div>
            <select id="vaneHelical" style="flex:1;">
              <option value="straight">None</option>
              <option value="straight">Straight</option>
              <option value="slight">Slight Offset</option>
              <option value="moderate">Moderate Offset</option>
              <option value="high">High Offset / Helical</option>
              <option value="max" selected>Max Helical</option>
            </select>
          </div>

          <!--nock weight-->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="nockWt">Nock weight gr</label>
              <button type="button" onclick="showNockWtPopup()" class="info-btn" title="About Nock Weight">ⓘ</button>
            </div>
            <input type="number" id="nockWt" placeholder="0" step="0.5" min="0" max="50" class="left-align" style="flex:1;">
          </div>
          <!--Glue Weight-->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="glueWt">Glue / Pin gr</label>
              <button type="button" onclick="showGlueWtPopup()" class="info-btn" title="About Glue/Pin">ⓘ</button>
            </div>
            <input type="number" id="glueWt" placeholder="0" min="0" max="15" step="0.5" class="left-align" style="flex:1;">
          </div>
          <!-- Arrow Components Total Display -->
          <div style="margin-top:1rem; padding:0.75rem; background:var(--border); border-radius:8px; text-align:center;">
          <strong>Total Arrow Weight: <span id="arrowComponentsTotal">0</span> gr</strong>
          <p style="font-size:0.85rem; color:var(--light); margin-top:0.5rem;">
            Auto-calculated from components. Edit main Total Weight field to override.
          </p>
        </div>
        </div>
      </div>
    </div>
    <!-- Notes Section (collapsible) -->
    <div class="card collapsible-mobile">
      <div class="collapsible-trigger" onclick="this.classList.toggle('open')">
        <span>Notes</span>
        <span class="chevron">></span>
      </div>
      <div class="collapsible-content">
        <textarea id="buildNotes" placeholder="Add any notes about this build... (e.g., tuning tips, broadhead choice, shot results)" style="width:100%; height:120px; padding:0.75rem; border:1px solid var(--border); border-radius:8px; background:var(--card-bg); color:var(--text); font-size:0.95rem; resize:vertical;"></textarea>
      </div>
    </div>
  </div>

  <!-- a small popup window that appears on the screen when the AI Analyzer button is clicked-->
  <div id="analyzerOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;"></div>
  <div id="analyzerModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border:1px solid #ccc; z-index:1000; max-width:90%; max-height:80vh; overflow:auto; box-shadow:0 4px 20px rgba(0,0,0,0.3); border-radius:12px;">
    <h3>AI Arrow Analyzer</h3>
    <div id="analyzerResults" style="white-space:pre-wrap;"></div>
    <button onclick="document.getElementById('analyzerModal').style.display='none'; document.getElementById('analyzerOverlay').style.display='none';" style="margin-top:1rem; padding:0.5rem 1rem; background:var(--purple); color:white; border:none; border-radius:8px; cursor:pointer;">Close</button>
  </div>
  
  <!--OUTPUT COLUMN-->
  <div id="outputs-column">
    <div class="card">
        <h2 style="display:flex; align-items:center; gap:0.75rem; font-size:1.3rem;">
          Live Adjustable Settings
          <button type="button" onclick="showLiveSettingsPopup()" class="info-btn" title="Explain Live Settings">ⓘ</button>
        </h2>
      <div style="margin:1.2rem 0;">
        <div style="display:flex; align-items:center; gap:0.75rem; margin-bottom:0.6rem;">
          <label style="font-weight:600; margin:0;">Actual Speed (fps)</label>
          <button onclick="recalculateAndShowMath()" style="background:none;border:none;cursor:pointer;font-size:1.3rem;color:var(--primary);padding:0;" title="Recalculate and show estimate">Calculate</button>
        </div>
        <div style="display:flex; align-items:center; gap:1rem;">
          <input type="range" id="fpsSlider" min="0" max="400" placeholder="0" step="1" style="background-size: 12.5% 6px;">
          <input type="number" id="fpsInput" placeholder="0" min="0" max="400" style="width:80px; padding:0.45rem; text-align:center; font-weight:600; font-size:1rem;">
        </div>
      </div>
      <div style="margin:1.2rem 0;">
        <label style="display:block; margin-bottom:0.4rem; font-weight:600;">Crosswind (mph)</label>
        <div style="display:flex; align-items:center; gap:1rem;">
          <input type="range" id="windSlider" min="0" max="40" placeholder="0" step="0.1" style="background-size: 12.5% 6px;">
          <input type="number" id="windInput" placeholder="0" min="0" max="40" step="0.1" style="width:70px; padding:0.45rem; text-align:center; font-weight:600; font-size:1rem;">
        </div>
      </div>
      <div style="margin:1.2rem 0;">
        <label style="display:block; margin-bottom:0.4rem; font-weight:600;">Range (yards)</label>
        <div style="display:flex; align-items:center; gap:1rem;">
          <input type="range" id="rangeSlider" min="0" max="150" placeholder="0" step="1" style="background-size: 12.5% 6px;">
          <input type="number" id="rangeInput" placeholder="0" min="0" max="150" style="width:70px; padding:0.45rem; text-align:center; font-weight:600; font-size:1rem;">
        </div>
      </div>
    </div>

    <!-- Effective Draw Weight Card -->
    <div class="card">
      <h2 style="display:flex; align-items:center; gap:0.75rem;">
        Effective Draw Weight
        <button onclick="showEffectiveLoadPopup()" class="info-btn" title="Explain Effective Draw Weight">ⓘ</button>
      </h2>
      <div class="stats-list">
        <!-- Input Draw Weight -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <span class="effective-dw-title">Input Draw Wt.</span>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-fill" id="inputDwFill" style="width:50%; background:var(--primary);"></div>
                  <!--<div class="bar-marker" id="inputDwMarker" style="left:50%;"></div>-->
                </div>
                <span class="moving-value" id="inputDwValue">70 lb</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Calculated Effective Draw Weight -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <span class="effective-dw-title">Effective Load</span>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-fill" id="effectiveLoadFill" style="width:50%; background:var(--success);"></div>
                  <!--<div class="bar-marker" id="effectiveLoadMarker" style="left:50%;"></div>-->
                </div>
                <span class="moving-value" id="effectiveLoadValue">80 lb</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Game Effectiveness card -->
    <div class="card">
      <h2 style="display:flex; align-items:center; gap:0.75rem;">
        Game Effectiveness @ <span id="gameDist">50</span> yd
        <button onclick="showGameMathPopup()" style="background:none;border:none;cursor:pointer;font-size:1.3rem;color:var(--primary);padding:0;" title="Show math breakdown">ⓘ</button>
      </h2>
      <div style="overflow-x:auto;">
        <table class="game-table">
          <thead>
            <tr>
              <th>Class</th>
              <th>KE Min (ft·lbs)</th>
              <th>Mom Min (slug·ft/s)</th>
              <th>Impact KE (ft·lbs)</th>
              <th>Impact Mom (slug·ft/s)</th>
              <th>Result</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Small Game</td>
              <td>15+</td>
              <td>0.20+</td>
              <td id="smallKE">-</td>
              <td id="smallMom">-</td>
              <td id="smallRes" class="send">Send it</td>
            </tr>
            <tr>
              <td>Deer / Antelope</td>
              <td>25+</td>
              <td>0.30+</td>
              <td id="deerKE">-</td>
              <td id="deerMom">-</td>
              <td id="deerRes" class="send">Send it</td>
            </tr>
            <tr>
              <td>Elk / Large Game</td>
              <td>42+</td>
              <td>0.45+</td>
              <td id="elkKE">-</td>
              <td id="elkMom">-</td>
              <td id="elkRes" class="send">Send it</td>
            </tr>
            <tr>
              <td>Toughest Game</td>
              <td>65+</td>
              <td>0.60+</td>
              <td id="mooseKE">-</td>
              <td id="mooseMom">-</td>
              <td id="mooseRes" class="marginal">Marginal</td>
            </tr>
          </tbody>
        </table>
      </div>
      <p style="margin-top:0.75rem;font-size:0.9rem;color:var(--light);text-align:center;">
        Based on kinetic energy and momentum at impact. Broadhead type and shot placement matter!
      </p>
    </div>
    <!-- Quick Stats – Final Polished Version -->
    <div class="card">
      <h2>Arrow Performance</h2>
      <div class="stats-list">
        <!-- FOC -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>FOC</strong>
              <button onclick="showFocPopup()" class="info-btn" title="Explain FOC">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px; position:relative;">
                  <!-- Yellow low zone -->
                  <div class="foc-low-zone"></div>
                  <!-- Green sweet spot (dynamic) -->
                  <div class="foc-sweet-spot"></div>
                  <!-- Yellow high zone -->
                  <div class="foc-high-zone"></div>
                  <div class="bar-marker" id="focMarker" style="left:50%;"></div>
                  <div class="moving-value" id="focValue">0.0%</div>
                </div>
                <div class="bar-labels">
                  <span>low</span>
                  <span>balanced/ideal</span>
                  <span>high</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- GPP -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>GPP</strong>
              <button onclick="showGppPopup()" class="info-btn" title="Explain GPP">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px; position:relative;">
                  <!-- Yellow low zone (<6.5) -->
                  <div class="gpp-low-zone"></div>
                  <!-- Green sweet spot (6.5–7.5) -->
                  <div class="gpp-sweet-spot"></div>
                  <!-- Yellow high zone (>7.5) -->
                  <div class="gpp-high-zone"></div>
                  <div class="bar-marker" id="gppMarker" style="left:50%;"></div>
                </div>
                <div class="bar-labels">
                  <span>light/fast</span>
                  <span>balanced/ideal</span>
                  <span>heavy/quiet</span>
                </div>
                <span class="moving-value" id="gppValue">0.0 gr</span>
              </div>
            </div>
          </div>
        </div>

        <!-- GPI -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>GPI</strong>
              <button onclick="showGpiPopup()" class="info-btn" title="Explain GPI">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px; position:relative;">
                  <!-- Yellow low zone -->
                  <div class="gpi-low-zone"></div>
                  <!-- Green sweet spot (dynamic) -->
                  <div class="gpi-sweet-spot"></div>
                  <!-- Yellow high zone -->
                  <div class="gpi-high-zone"></div>
                  <!-- Bar marker -->
                  <div class="bar-marker" id="gpiMarker" style="left:50%;"></div>
                </div>
                  <div class="bar-labels">
                    <span>light/fast</span>
                    <span>balanced/ideal</span>
                    <span>heavy/stable</span>
                  </div>
                <span class="moving-value" id="gpiValue">0.0 gr/in</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Total Wt -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>Total Wt</strong>
              <button onclick="showTotalWtPopup()" class="info-btn" title="Explain Total Arrow Weight">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px; position:relative;">
                  <!-- Yellow low zone -->
                  <div class="totalwt-low-zone"></div>
                  <!-- Green sweet spot (dynamic) -->
                  <div class="totalwt-sweet-spot"></div>
                  <!-- Yellow high zone -->
                  <div class="totalwt-high-zone"></div>
                  <div class="bar-marker" id="totalWtMarker" style="left:50%;"></div>
                </div>
                <div class="bar-labels">
                  <span>fast/light</span>
                  <span>balanced/ideal</span>
                  <span>heavy/quiet</span>
                </div>
                <span class="moving-value" id="totalWtValue">0 gr</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Stiffness / Forgiveness -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>Stiffness</strong>
              <button onclick="showStiffnessPopup()" class="info-btn" title="Explain Stiffness">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px; position:relative;">
                  <!-- Yellow low zone (too stiff) -->
                  <div class="stiffness-low-zone"></div>
                  <!-- Green sweet spot (dynamic) -->
                  <div class="stiffness-sweet-spot"></div>
                  <!-- Yellow high zone (too weak) -->
                  <div class="stiffness-high-zone"></div>
                  <div class="bar-marker" id="stiffnessMarker" style="left:50%;"></div>
                  <div class="moving-value" id="stiffnessValue">300 (Good)</div>
                </div>
                <div class="bar-labels">
                  <span>Stiffest</span>
                  <span>Good</span>
                  <span>Weakest</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Flatness (20→60 yd) -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>Flatness (20→60 yd)</strong>
              <button onclick="showFlatnessPopup()" class="info-btn" title="Explain Flatness">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px; position:relative;">
                  <!-- Yellow high drop zone (>4.5 ft) -->
                  <div class="flatness-high-zone"></div>
                  <!-- Green sweet spot (<4.5 ft) -->
                  <div class="flatness-sweet-spot"></div>
                  <!-- Bar marker -->
                  <div class="bar-marker" id="flatnessMarker" style="left:50%;"></div>
                </div>
                <div class="bar-labels">
                  <span>curved</span>
                  <span>flat</span>
                  <span>very flat</span>
                </div>
                <span class="moving-value" id="flatnessValue">0.0 ft</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Group Stability (Target / 3D) -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>Group Stability</strong>
              <button onclick="showGroupStabilityPopup()" class="info-btn" title="Explain Group Stability">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px; position:relative;">
                  <!-- Grey for 0/3 -->
                  <div class="group-zero-zone"></div>
                  <!-- Yellow for 1/3 -->
                  <div class="group-one-zone"></div>
                  <!-- Orange for 2/3 -->
                  <div class="group-two-zone"></div>
                  <!-- Green for 3/3 -->
                  <div class="group-three-zone"></div>
                  <div class="bar-marker" id="groupStabilityMarker" style="left:50%;"></div>
                </div>
                <div class="bar-labels">
                  <span>0 of 3</span>
                  <span>1 of 3</span>
                  <span>2 of 3</span>
                  <span>3 of 3</span>
                </div>
                <span class="moving-value" id="groupStabilityValue">0/3</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- New Summary Cards Row -->
    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:1rem; margin-bottom:1.5rem;">

      <!-- Max Height at Range Card -->
      <div class="card">
        <h2 style="display:flex; align-items:center; gap:0.75rem; font-size:1.3rem; margin:0;">
          Max Height at Range
          <button type="button" onclick="showMaxHeightPopup()" class="info-btn" title="Explain Max Height at Range">ⓘ</button>
        </h2>
        <p style="font-size:1.4rem; font-weight:700; margin:0.75rem 0;">
          <span id="maxHeightFt">0.0</span> ft / <span id="maxHeightIn">0.0</span> in
          <br>at <span id="maxHeightDistanceYd">0</span> yd (of <span id="maxHeightRangeYd">50</span> yd)
        </p>
        <p style="font-size:0.9rem; color:var(--light);">
          Highest point above line of sight up to your current range — useful for pin gaps and obstacle clearance.
        </p>
      </div>

      <!-- Downrange Drop Card -->
      <div class="card">
        <h2 style="display:flex; align-items:center; gap:0.75rem; font-size:1.3rem;">
          Downrange Drop
          <button onclick="showDropPopup()" class="info-btn" title="Explain Downrange Drop">ⓘ</button>
        </h2>
        <p style="font-size:1.4rem; font-weight:700; margin:0.75rem 0;">
          <span id="dropFt">0.0</span> ft / <span id="dropIn">0.0</span> in
          <br>at <span id="dropDistanceYd">0</span> yd
        </p>
        <p style="font-size:0.9rem; color:var(--light);">
          How far below line of sight — affects pin gaps and holdover.
        </p>
      </div>

      <!-- Flight Time Card -->
      <div class="card">
        <h2 style="display:flex; align-items:center; gap:0.75rem; font-size:1.3rem;">
          Flight Time
          <button onclick="showFlightTimePopup()" class="info-btn" title="Explain Flight Time">ⓘ</button>
        </h2>
        <p style="font-size:1.4rem; font-weight:700; margin:0.75rem 0;">
          <span id="flightTimeSec">0.000</span> sec
          <br>to <span id="flightDistanceYd">0</span> yd
        </p>
        <p style="font-size:0.9rem; color:var(--light);">
          Animal reaction window — under 0.2 s is very fast.
        </p>
      </div>

       <!-- Wind Drift Card -->
      <div class="card">
        <h2 style="display:flex; align-items:center; gap:0.75rem; font-size:1.3rem;">
          Wind Drift
          <button onclick="showWindDriftPopup()" class="info-btn" title="Explain Wind Drift">ⓘ</button>
        </h2>
        <p style="font-size:1.4rem; font-weight:700; margin:0.75rem 0;">
          <span id="windDriftIn">0.0</span> in
          <br>at <span id="windDriftDistanceYd">0</span> yd (<span id="windDriftMph">0</span> mph crosswind)
        </p>
        <p style="font-size:0.9rem; color:var(--light);">
          Sideways drift in full crosswind — aim this far into wind for compensation.
        </p>
      </div>
    </div>   

    <!-- Build Summary Table (collapsible) -->
    <div class="card collapsible-mobile" id="summaryCard">
      <div class="collapsible-trigger" onclick="this.classList.toggle('open')">
        <span>Build Summary & Export</span>
        <span class="chevron">></span>
      </div>
      <div class="collapsible-content"> <!-- ← changed from card-content -->
        <div style="margin-bottom:1rem;">
          <button id="copyCsvBtn" class="secondary">Copy as CSV</button>
        </div>
        <div style="overflow-x:auto;">
          <table class="game-table" id="summaryTable">
            <tbody>
              <!-- Rows will be filled by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="fpsMathModal" class="info-overlay">
  <div class="info-panel" style="max-width:500px;">
    <button class="info-close" onclick="closeFpsMath()">×</button>
    <h2>FPS Estimate Breakdown</h2>
    <div id="fpsMathPopupContent" style="font-size:0.95rem;line-height:1.5;">
      Fill in bow details to see the estimate.
    </div>
  </div>
</div>
<!-- Game Effectiveness Math Popup Modal -->
<div id="gameMathModal" class="info-overlay">
  <div class="info-panel" style="max-width:600px;">
    <button class="info-close" onclick="closeGameMath()">×</button>
    <h2>Math Breakdown</h2>
    <div id="gameMathContent" style="font-size:0.95rem;line-height:1.5;">
      <!-- Filled by JS -->
    </div>
  </div>
</div>
<div id="aiModal" class="info-overlay">
  <div class="info-panel">
    <button class="info-close" onclick="closeModal()">×</button>
    <h2>AI Arrow Advisor</h2>
    <div id="chatHist" style="max-height:300px;overflow-y:auto;margin-bottom:1rem;padding:0.5rem;background:#00000004;border-radius:8px;"></div>
    <div class="flex">
      <input id="aiIn" type="text" placeholder="Ask about arrows, broadheads, tuning..." style="flex:1;">
      <button onclick="sendAi()" class="btn-small">Send</button>
    </div>
  </div>
</div>

<!---SCRIPTS-->
<script>
const $ = id => document.getElementById(id);
let fpsWasRecalculated = false;

function clearBuildFields() {
  if (!confirm('Clear all input fields? This resets everything to defaults (saved builds are safe).')) {
    return;
  }

  // Reset Build Name
  $('buildName').value = '';

  // Reset all other inputs to defaults (add more as needed)
  $('appType').value = 'Hunting';
  $('bowModel').value = '';
  $('bowType').value = 'compound';
  $('ibo').value = '';
  $('drawWt').value = '70';
  $('drawLen').value = '';
  $('letOff').value = '80';
  $('braceHeight').value = '';
  $('camType').value = 'hybrid';
  $('stringWt').value = '0';
  // Arrow fields
  $('arrowName').value = '';
  $('spine').value = '';
  $('arrowDia').value = 'micro';
  $('arrowLen').value = '';
  $('totalWt').value = '';
  $('pointWt').value = '';
  $('balancePt').value = '';
  $('buildNotes').value = '';
  // Sliders
  $('fpsSlider').value = '278';
  $('fpsInput').value = '278';
  $('windSlider').value = '0';
  $('windInput').value = '0';
  $('rangeSlider').value = '50';
  $('rangeInput').value = '50';

  // Reset Load dropdown to default
  const loadSelect = $('loadBuild');
  if (loadSelect) {
    loadSelect.selectedIndex = 0;  // selects the first option ("– Load Build –")
  }

  calculateEverything();
  alert('All fields cleared!');
}

function showGettingStarted() {
  if (document.getElementById('howToModal')) return;

  const modal = document.createElement('div');
  modal.id = 'howToModal';
  modal.style.cssText = `
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.85); display:flex; align-items:center;
    justify-content:center; z-index:1000; padding:1rem;
  `;

  modal.innerHTML = `
    <div style="background:var(--card-bg); color:#ffffff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); border-radius:16px; max-width:520px; width:100%; max-height:90vh; overflow:hidden; position:relative; box-shadow:0 20px 40px rgba(0,0,0,0.4);">
      <!-- Close button -->
      <button onclick="document.getElementById('howToModal').remove()"
              style="position:absolute; top:1rem; right:1rem; background:rgba(0,0,0,0.5); color:white; border:none; width:44px; height:44px; border-radius:50%; font-size:1.8rem; cursor:pointer; display:flex; align-items:center; justify-content:center; z-index:20;">
        ×
      </button>

      <div class="slides-wrapper">
        <div class="slides-container">
          <!-- Slide 1 - Welcome -->
          <div class="onboarding-slide">
            <h2>Welcome to ArrowForge!</h2>
            <p>Mathematically improve your odds — completely offline and privacy-first.</p>
            <div style="margin:2rem 0; display:flex; justify-content:center;">
              <img src="logo-dark.png" alt="ArrowForge Logo" 
                   style="height:120px; width:auto; max-width:80%;">
            </div>
            <p style="font-size:1.1rem; margin:1rem 0; line-height:1.6;">
              <strong>Answers for everyone:</strong><br>
              What do the pros shoot?<br>
              What's the right arrow for my new bow?<br>
              How to my current arrow builds perform?<br>
              What can I optimize?
            </p>

            <p style="font-size:0.9rem; margin-top:2rem; color:var(--light); text-align:center;">
              Disclaimer: Calculations and AI suggestions are estimates only. Improper bow/arrow setup can cause serious injury, harm or death. Always consult professionals and manufacturers. Use at your own risk.
            </p>
          </div>

          <!-- Slide 2 - Sample Profiles -->
          <div class="onboarding-slide">
            <h3>Try Pro Sample Profiles (Free)</h3>
            <p>Load real-world setups from top archers like Cameron Hanes and Paige Pearce.</p>
            <p style="font-size:3rem; margin:1.5rem 0;">🔥</p>
            <p style="font-size:1.1rem; margin:1rem 0; line-height:1.6;">
              <strong>Answer questions like:</strong><br>
              What do pro hunters shoot for elk?<br>
              How heavy are target arrows?<br>
              What FOC do champions use?
            </p>
          </div>

          <!-- Slide 3 - Get Insights Everywhere -->
          <div class="onboarding-slide">
            <h3>Get Personalized Insights (Free)</h3>
            <p>Click the ⓘ info icons next to any field for custom guidance based on your build.</p>
            <p style="font-size:3rem; margin:1.5rem 0;">ⓘ</p>
            <p style="font-size:1.1rem; margin:1rem 0; line-height:1.6;">
              <strong>Answer questions like:</strong><br>
              How to I measure the Balance Point?<br>
              What can I hunt for at what range?<br>
              How high will my arrow arc?
            </p>
          </div>

          <!-- Slide 4 - Experiment -->
          <div class="onboarding-slide">
            <h3>Experiment Before Buying (Free)</h3>
            <p>Test arrow builds — change weight, spine, point — see performance instantly.</p>
            <p style="font-size:3rem; margin:1.5rem 0;">💡</p>
            <p style="font-size:1.1rem; margin:1rem 0; line-height:1.6;">
              <strong>Answer questions like:</strong><br>
              What will a heavier point do?<br>
              How will a stiffer spine perform?<br>
              Does a heavier lighted nock mess up my FOC?
            </p>
          </div>

          <!-- Slide 5 - Analyze Current Setup -->
          <div class="onboarding-slide">
            <h3>Understand Your Setup (Free)</h3>
            <p>Enter your full bow + arrow build — see real performance data.</p>
            <p style="font-size:3rem; margin:1.5rem 0;">📊</p>
            <p style="font-size:1.1rem; margin:1rem 0; line-height:1.6;">
              <strong>Answer questions like:</strong><br>
              How much crosswind can I tolerate and be on target?<br>
              Is my KE and momentum enough for elk?<br>
              Is my arrow fast enough?
            </p>
          </div>

          <!-- Slide 6 - AI Goal Advisor -->
          <div class="onboarding-slide">
            <h3>AI Goal Advisor (Paid — Coming Soon)</h3>
            <p>Tell AI your goals — get personalized gear ideas.</p>
            <p style="font-size:3rem; margin:1.5rem 0;">✨</p>
            <p style="font-size:1.1rem; margin:1rem 0; line-height:1.6;">
              <strong>Answer questions like:</strong><br>
              What is the perfect arrow configuration?<br>
              How can I improve my current setup?<br>
            </p>
          </div>

          <!-- Slide 7 - AI Full Analysis -->
          <div class="onboarding-slide">
            <h3>AI Full Analysis (Paid — Coming Soon)</h3>
            <p>Enter your setup — AI suggests improvements.</p>
            <p style="font-size:3rem; margin:1.5rem 0;">🚀</p>
            <p style="font-size:1.1rem; margin:1rem 0; line-height:1.6;">
              <strong>Answer questions like:</strong><br>
              How can I get 5 more fps safely?<br>
              What tweak increases my elk lethality?<br>
              What arrow tweaks will improve my FPS?
            </p>
            <p style="margin-top:2rem;">Ready to forge your perfect arrow?</p>
          </div>
        </div>

        <!-- Navigation arrows moved INSIDE slides-wrapper -->
        <button id="prevBtn" class="nav-btn">‹</button>
        <button id="nextBtn" class="nav-btn">›</button>
      </div>

      <!-- Dots -->
      <div class="dots">
        <span class="dot active"></span>
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  const slidesContainer = modal.querySelector('.slides-container');
  const dots = modal.querySelectorAll('.dot');
  let currentSlide = 0;
  const totalSlides = 6;

  function updateSlide() {
    slidesContainer.style.transform = `translateX(-${currentSlide * 100}%)`;
    dots.forEach((dot, i) => dot.classList.toggle('active', i === currentSlide));
  }

  // Close button
  modal.querySelector('button[onclick*="remove"]').onclick = () => modal.remove();

  // Navigation
  modal.querySelector('#prevBtn').onclick = () => {
    currentSlide = currentSlide > 0 ? currentSlide - 1 : totalSlides - 1;
    updateSlide();
  };
  modal.querySelector('#nextBtn').onclick = () => {
    currentSlide = currentSlide < totalSlides - 1 ? currentSlide + 1 : 0;
    updateSlide();
  };
  dots.forEach((dot, i) => dot.onclick = () => {
    currentSlide = i;
    updateSlide();
  });

  // Touch swipe
  let touchStartX = 0;
  modal.addEventListener('touchstart', e => touchStartX = e.touches[0].clientX);
  modal.addEventListener('touchend', e => {
    const touchEndX = e.changedTouches[0].clientX;
    if (touchStartX - touchEndX > 50) modal.querySelector('#nextBtn').click();
    if (touchEndX - touchStartX > 50) modal.querySelector('#prevBtn').click();
  });

  updateSlide();
}

/*Bow Model info icon*/
function showBowModelPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Bow Model</strong></p>
    <p>Enter your bow's make and model (e.g., Hoyt RX-9, Mathews Lift, PSE Supra).</p>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Build naming suggestions</li>
      <li>Future pro sample matching</li>
      <li>Personal reference</li>
    </ul>
    <p>No impact on calculations — purely for your records.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

// AI Helper function
function updateStatus(elementId, message, show = true) {
  const statusEl = document.getElementById(elementId);
  if (!statusEl) return;

  if (show) {
    statusEl.style.display = 'block';
    statusEl.innerHTML = message;
  } else {
    statusEl.style.display = 'none';
    statusEl.innerHTML = '';
  }
}

// AI Lookup Button

async function promptBowLookup() {
  const modelInput = prompt('Enter bow model (full or partial, e.g., "hoyt rx9" or "mathews lift")');
  if (!modelInput) return; // cancelled

  const normalized = modelInput.trim().toLowerCase();

  // Show loading status
  const statusEl = document.getElementById('lookupStatus');
  if (statusEl) {
    statusEl.style.display = 'block';
    statusEl.innerHTML = 'Searching bow specs...';
  }

  // Call the LIVE API first (production endpoint)
  try {
    if (statusEl) statusEl.innerHTML = 'Fetching from AI...';

    const response = await fetch(`https://arrowforgeapp.com/api/bow?model=${encodeURIComponent(normalized)}`);
    if (!response.ok) throw new Error(`API error: ${response.status}`);

    const data = await response.json();

    if (statusEl) statusEl.innerHTML = 'Processing specs...';

    if (data.error) {
      // Fallback to hard-coded if AI fails
      const knownBows = {
        "2025 hoyt rx-9": { type: "compound", ibo: 342, brace: 6.125, cam: "HBX Gen 4" },
        "hoyt carbon rx-9": { type: "compound", ibo: 342, brace: 6.125, cam: "HBX Gen 4" },
        "mathews lift": { type: "compound", ibo: 343, brace: 6.5, cam: "SwitchWeight X" },
      };

      let matched = null;
      for (const key in knownBows) {
        if (normalized.includes(key)) {
          matched = knownBows[key];
          matched.full_name = key;
          break;
        }
      }

      if (matched) {
        prefillBowFields(normalized, matched);
      } else {
        alert(`No specs found for "${normalized}".\nTry a different name or enter manually.`);
      }
      if (statusEl) statusEl.style.display = 'none';
      return;
    }

    if (data.ambiguous) {
      // Build a detailed numbered list
      const options = data.matches.map((m, i) => {
        return `${i + 1}. ${m.full_name} (${m.year || 'unknown year'}) - ${m.ibo || '?'} IBO, ${m.brace || '?'} brace, ${m.cam || 'unknown cam'}`;
      });

      const choice = prompt(
        `${data.clarification || 'Multiple variants found — which one do you have?'}\n\n` +
        `Note: Standard/base model is usually listed first.\n\n` +
        `${options.join('\n')}\n\n` +
        `Enter number (1-${data.matches.length}) or cancel:`
      );

      if (!choice) {
        if (statusEl) statusEl.style.display = 'none';
        return;
      }

      const selectedIndex = parseInt(choice.trim()) - 1;
      if (isNaN(selectedIndex) || selectedIndex < 0 || selectedIndex >= data.matches.length) {
        alert('Invalid selection. Please try again.');
        if (statusEl) statusEl.style.display = 'none';
        return;
      }

      const selected = data.matches[selectedIndex];
      prefillBowFields(selected.full_name, selected);
    } else if (data.matches && data.matches.length > 0) {
      // Single match — auto-fill
      prefillBowFields(data.matches[0].full_name, data.matches[0]);
    } else {
      alert(`No specs found for "${normalized}".\nEnter manually.`);
    }

    if (statusEl) statusEl.style.display = 'none';
  } catch (e) {
    console.error(e);
    alert(`Error connecting to AI. Please enter specs manually.`);
    if (statusEl) statusEl.style.display = 'none';
  }

  calculateEverything();
}

function prefillBowFields(modelName, specs) {
  $('bowModel').value = specs.full_name || modelName;  // Use full_name if available
  $('bowType').value = specs.type || '';
  $('ibo').value = specs.ibo || '';
  $('braceHeight').value = specs.brace || '';
  $('camType').value = specs.cam || '';
  // Optional: alert the full name
  alert(`Found specs for "${specs.full_name || modelName}"!\n\nBow Type: ${specs.type || 'unknown'}\nIBO: ${specs.ibo || 'unknown'} fps\nBrace: ${specs.brace || 'unknown'}"\nCam: ${specs.cam || 'unknown'}\n\nFields updated.`);
}

/*Bow Type info icon*/
function showBowTypePopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Bow Type</strong></p>
    <p>Select your bow style — affects future calculations.</p>
    <hr>
    <p><strong>Compound</strong>: Modern cam system — highest efficiency, used for most hunting/target bows.</p>
    <p><strong>Recurve</strong>: Traditional limbs — lower efficiency, quieter, used in Olympic/traditional archery.</p>
    <p><strong>Longbow</strong>: Classic straight limbs — lowest efficiency, most traditional.</p>
    <hr>
    <p>Currently used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Future speed estimate adjustments</li>
      <li>Sample build filtering</li>
      <li>Personal reference</li>
    </ul>
    <p>No direct impact yet — coming in future updates.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

// Suggest Build Name
function suggestBuildName() {
  const today = new Date();
  const dateStr = today.toISOString().slice(0, 10); // YYYY-MM-DD

  const appType = $('appType')?.value.trim() || 'Hunting';
  const arrowWeight = $('totalWt')?.value.trim() || '???';
  const bowModel = $('bowModel')?.value.trim() || 'Bow';
  const drawWt = $('drawWt')?.value || '??';
  const arrowName = $('arrowName')?.value.trim() || 'Arrow';  // ← NEW: Arrow Name

  const templates = [
    `${dateStr} ${appType} ${bowModel} ${drawWt}lb ${arrowName} ${arrowWeight}gr`,
    `${dateStr} ${bowModel} ${drawWt}lb ${appType} ${arrowName} ${arrowWeight}gr`,
    `${dateStr} ${appType} ${arrowName} Build ${arrowWeight}gr`,
    `${dateStr} ${bowModel} ${appType} ${arrowName} Setup`,
    `${dateStr} ${arrowName} ${arrowWeight}gr ${appType}`
  ];

  // Pick the best template (one without ?? or ???)
  const best = templates.find(t => !t.includes('??') && !t.includes('???') && !t.includes('Arrow')) || templates[0];

  $('buildName').value = best.trim();
}

/*Bow Type Update Pins*/
function updatePinCountForTraditional() {
  const bowType = $('bowType').value;
  const pinCountSelect = $('pinCount');

  if (bowType === 'recurve' || bowType === 'longbow') {
    pinCountSelect.value = '0'; // No Pins / Instinctive
  } else {
    // Optional: reset to 3-pin for compound if desired
    if (pinCountSelect.value === '0') {
      pinCountSelect.value = '3';
    }
  }

  // Rebuild pin inputs to reflect change
  calculateEverything();
}

/*IBO FPS info icon*/
function showIboPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>IBO Speed (fps)</strong></p>
    <p>Manufacturer's advertised speed at standard specs:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>70 lb draw weight</li>
      <li>30" draw length</li>
      <li>350 grain arrow</li>
      <li>No string add-ons</li>
    </ul>
    <hr>
    <p>Used to estimate your real-world speed when you fill bow/arrow details.</p>
    <p>Leave blank or adjust if you know your bow's actual IBO rating.</p>
    <p>Higher IBO = faster potential — but real speed depends on your setup.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Brace Height info icon*/
function showBraceHeightPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Brace Height (inches)</strong></p>
    <p>Distance from bow grip throat to string at rest.</p>
    <hr>
    <p><strong>Typical Range:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>5–6 in: Faster, less forgiving (speed bows)</li>
      <li>6–7 in: Balanced speed & forgiveness (most hunting bows)</li>
      <li>7+ in: Slower, very forgiving (target/long-draw bows)</li>
    </ul>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Future speed estimate tuning</li>
      <li>Build comparison & reference</li>
    </ul>
    <p>Shorter brace = more speed but harsher; longer = smoother & more forgiving.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Brace Height (min 5, max 9) */
const braceHeightInput = document.getElementById('braceHeight');

if (braceHeightInput) {
  braceHeightInput.addEventListener('input', () => {
    let val = parseFloat(braceHeightInput.value);
    if (isNaN(val)) return; // Allow typing

    if (val < braceHeightInput.min) {
      braceHeightInput.value = braceHeightInput.min;
    }
    if (val > braceHeightInput.max) {
      braceHeightInput.value = braceHeightInput.max;
    }

    // Optional: red border for invalid
    if (isNaN(val) || val < braceHeightInput.min || val > braceHeightInput.max) {
      braceHeightInput.style.borderColor = 'red';
    } else {
      braceHeightInput.style.borderColor = '';
    }
  });

  braceHeightInput.addEventListener('blur', () => {
    let val = parseFloat(braceHeightInput.value);
    if (isNaN(val) || val < braceHeightInput.min) {
      braceHeightInput.value = braceHeightInput.min;
    } else if (val > braceHeightInput.max) {
      braceHeightInput.value = braceHeightInput.max;
    }
    braceHeightInput.style.borderColor = ''; // Reset border
  });
}

/* Cam System info icon*/
function showCamTypePopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Cam System</strong></p>
    <p>Type of cam design on your compound bow — affects let-off, speed, and tuning.</p>
    <hr>
    <p><strong>Common Types:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Hybrid</strong>: Smooth draw, high let-off (Hoyt HBX, PSE Evolve)</li>
      <li><strong>Twin/Dual</strong>: Aggressive, fast (older Bowtech, some Mathews)</li>
      <li><strong>Single</strong>: Smooth, forgiving (Solo cams)</li>
      <li><strong>SwitchWeight/DeadLock</strong>: Modular draw length/let-off</li>
    </ul>
    <p>Used for future AI tuning suggestions and performance estimates.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Draw Weight info icon popup */
function showDrawWtPopup() {
  const content = `
    <p><strong>Draw Weight (lb)</strong></p>
    <p>Peak weight your bow is set to — the force needed to pull it back.</p>
    <hr>
    <p><strong>Typical Ranges:</strong></p>
    <ul style="margin-left:1.25rem; font-size:0.9rem;">
      <li>40–60 lb: Lighter — easier to draw, common for women/youth or long holds.</li>
      <li>60–70 lb: Standard hunting — good balance of speed and penetration.</li>
      <li>70–80+ lb: Heavy — max speed/momentum, popular for big game (elk, bear).</li>
    </ul>
    <hr>
    <p><strong>Used for:</strong></p>
    <ul style="margin-left:1.25rem; font-size:0.9rem;">
      <li>FPS estimate (higher = faster)</li>
      <li>Effective Load & spine recommendation</li>
      <li>GPP calculation</li>
    </ul>
    <p>Higher draw weight = more speed & penetration, but harder to shoot accurately.</p>
  `;

  $('gameMathContent').innerHTML = content;
  $('gameMathModal').style.display = 'flex';
}

// Draw Weight (min 30)
const drawWtInput = document.getElementById('drawWt');
drawWtInput.addEventListener('input', () => {
  if (drawWtInput.value < drawWtInput.min) {
    drawWtInput.value = drawWtInput.min;
  }
});
drawWtInput.addEventListener('blur', () => {
  if (drawWtInput.value < drawWtInput.min || isNaN(drawWtInput.value)) {
    drawWtInput.value = drawWtInput.min;
  }
});

drawWtInput.addEventListener('input', () => {
  if (drawWtInput.value < drawWtInput.min) {
    drawWtInput.style.borderColor = 'red';
  } else {
    drawWtInput.style.borderColor = '';
  }
});

if (drawWtInput.value > drawWtInput.max) {
  drawWtInput.value = drawWtInput.max;
}

/*Draw Length info icon*/
function showDrawLenPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Draw Length (inches)</strong></p>
    <p>Distance from nock point to grip pivot point (or anchor) at full draw.</p>
    <hr>
    <p><strong>Typical Ranges (All Bow Types):</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Short (24–27 in)</strong>: Youth, women, shorter adults, or compact styles (common in hunting recurves/longbows).</li>
      <li><strong>Average (27–29 in)</strong>: Most adult archers — "standard" rating point (many bows rated at 28 in).</li>
      <li><strong>Long (30–32+ in)</strong>: Taller archers, long arms, or deep anchors (e.g., target recurves or warbow-style).</li>
    </ul>
    <hr>
    <p><strong>Compound Bows</strong>: Fixed by cam/draw stop — precise and repeatable.</p>
    <p><strong>Recurve/Longbow</strong>: More variable due to form/anchor — often measured to corner of mouth or cheek.</p>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>FPS estimate (longer = more energy = faster)</li>
      <li>Effective Load & spine recommendation</li>
      <li>Arrow tuning & stability</li>
    </ul>
    <p>Longer draw = more speed & power, but can reduce accuracy if form suffers.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

// Draw Length (min 24)
const drawLenInput = document.getElementById('drawLen');
drawLenInput.addEventListener('input', () => {
  if (drawLenInput.value < drawLenInput.min) {
    drawLenInput.value = drawLenInput.min;
  }
});
drawLenInput.addEventListener('blur', () => {
  if (drawLenInput.value < drawLenInput.min || isNaN(drawLenInput.value)) {
    drawLenInput.value = drawLenInput.min;
  }
});


/* Let-Off % info icon popup */
function showLetOffPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Let-Off %</strong></p>
    <p>The percentage of peak draw weight you hold at full draw (the "valley").</p>
    <hr>
    <p><strong>Typical Ranges:</strong></p>
    <ul style="margin-left:1.25rem; font-size:0.9rem;">
      <li>65–75%: Aggressive cams — faster bows, harder to hold steady.</li>
      <li>75–85%: Balanced — most common for hunting (smooth + fast).</li>
      <li>85–90+%: High let-off — easiest to hold, great for long shots or target.</li>
    </ul>
    <hr>
    <p><strong>Used for:</strong></p>
    <ul style="margin-left:1.25rem; font-size:0.9rem;">
      <li>Fine-tuning FPS estimates (higher let-off = slight speed gain).</li>
      <li>Comparing bows & builds.</li>
    </ul>
    <p>Higher let-off makes holding steady easier — ideal for hunting or target shooting.</p>
    <p><em>Recurve/Longbow: N/A (no let-off)</em></p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Let-Off % (min 65, max 90) */
const letOffInput = document.getElementById('letOff'); // Ensure your input has id="letOff"

if (letOffInput) {
  letOffInput.addEventListener('input', () => {
    let val = parseFloat(letOffInput.value);
    if (isNaN(val)) return; // Allow typing, don't reset mid-input

    if (val < letOffInput.min) {
      letOffInput.value = letOffInput.min;
    } else if (val > letOffInput.max) {
      letOffInput.value = letOffInput.max;
    }

    // Red border if invalid
    if (isNaN(val) || val < letOffInput.min || val > letOffInput.max) {
      letOffInput.style.borderColor = 'red';
    } else {
      letOffInput.style.borderColor = '';
    }
  });

  letOffInput.addEventListener('blur', () => {
    let val = parseFloat(letOffInput.value);
    if (isNaN(val) || val < letOffInput.min) {
      letOffInput.value = letOffInput.min;
      letOffInput.style.borderColor = '';
    } else if (val > letOffInput.max) {
      letOffInput.value = letOffInput.max;
      letOffInput.style.borderColor = '';
    }
  });
}

/*String weight*/
function showStringAddonsPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>String Add-ons (grains)</strong></p>
    <p>Total extra weight on the string (peep, D-loop, kisser, silencers, nock).</p>
    <hr>
    <p>Typical total: 20–40 gr (20 gr is a good average for basic setups).</p>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>FPS estimate — every ~10 gr slows ~1 fps</li>
      <li>Real-world speed accuracy</li>
    </ul>
    <p>Fill individual fields below for auto-total, or enter total here directly.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* String add-on checkbox*/
function toggleStringDetailsMode() {
  const checkbox = $('useStringDetails');
  const checked = checkbox?.checked ?? false;

  const detailIds = ['peepWt', 'dloopWt', 'kisserWt', 'silencerWt'];
  const mainInput = $('stringWt');

  detailIds.forEach(id => {
    const input = $(id);
    if (input) {
      input.readOnly = !checked;
      input.style.backgroundColor = checked ? '' : 'var(--border)';
      input.style.opacity = checked ? '' : '0.6';
    }
  });

  if (mainInput) {
    mainInput.readOnly = checked;
    mainInput.style.backgroundColor = checked ? 'var(--border)' : '';
    mainInput.style.opacity = checked ? '0.6' : '';
  }

  calculateEverything(); // update total and display
}

/*Peep  weight info icon*/
function showPeepWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Peep Weight (grains)</strong></p>
    <p>Weight of your peep sight.</p>
    <p>Typical: 8–25 gr (standard ~12–15 gr, large/ verifier ~20+ gr).</p>
    <p>Adds to string weight — slows speed slightly but improves aiming.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Peep Weight (min 0, max 30) */
const peepWtInput = document.getElementById('peepWt');

if (peepWtInput) {
  // Update border on every input change
  function updatePeepBorder() {
    let val = parseFloat(peepWtInput.value);
    // Skip red border if field is empty (allow typing)
    if (peepWtInput.value === '') {
      peepWtInput.style.borderColor = '';
      return;
    }
    // Red border if invalid
    if (isNaN(val) || val < peepWtInput.min || val > peepWtInput.max) {
      peepWtInput.style.borderColor = 'red';
    } else {
      peepWtInput.style.borderColor = '';
    }
  }

  peepWtInput.addEventListener('input', () => {
    let val = parseFloat(peepWtInput.value);
    if (isNaN(val)) return; // Allow typing

    if (val < peepWtInput.min) {
      peepWtInput.value = peepWtInput.min;
    }
    if (val > peepWtInput.max) {
      peepWtInput.value = peepWtInput.max;
    }

    updatePeepBorder();
  });

  peepWtInput.addEventListener('blur', () => {
    let val = parseFloat(peepWtInput.value);
    if (peepWtInput.value === '' || isNaN(val) || val < peepWtInput.min) {
      peepWtInput.value = peepWtInput.min;
    } else if (val > peepWtInput.max) {
      peepWtInput.value = peepWtInput.max;
    }
    peepWtInput.style.borderColor = ''; // Reset border
  });

  // Initial check on load (won't turn red if empty)
  updatePeepBorder();
}

/*DLoop  weight info icon*/
function showDloopWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>D-loop Weight (grains)</strong></p>
    <p>Weight of your D-loop material + nocking point.</p>
    <p>Typical: 5–15 gr (metal nock ~10 gr, tied string ~5 gr).</p>
    <p>Protects string, improves nock fit — small speed impact.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* D-loop Weight (min 0, max 20) */
const dloopWtInput = document.getElementById('dloopWt');

if (dloopWtInput) {
  // Update border on every input change
  function updateDloopBorder() {
    let val = parseFloat(dloopWtInput.value);
    // Skip red border if field is empty (allow typing)
    if (dloopWtInput.value === '') {
      dloopWtInput.style.borderColor = '';
      return;
    }
    // Red border if invalid
    if (isNaN(val) || val < dloopWtInput.min || val > dloopWtInput.max) {
      dloopWtInput.style.borderColor = 'red';
    } else {
      dloopWtInput.style.borderColor = '';
    }
  }

  dloopWtInput.addEventListener('input', () => {
    let val = parseFloat(dloopWtInput.value);
    if (isNaN(val)) return; // Allow typing

    if (val < dloopWtInput.min) {
      dloopWtInput.value = dloopWtInput.min;
    }
    if (val > dloopWtInput.max) {
      dloopWtInput.value = dloopWtInput.max;
    }

    updateDloopBorder();
  });

  dloopWtInput.addEventListener('blur', () => {
    let val = parseFloat(dloopWtInput.value);
    if (dloopWtInput.value === '' || isNaN(val) || val < dloopWtInput.min) {
      dloopWtInput.value = dloopWtInput.min;
    } else if (val > dloopWtInput.max) {
      dloopWtInput.value = dloopWtInput.max;
    }
    dloopWtInput.style.borderColor = ''; // Reset border
  });

  // Initial check on load (won't turn red if empty)
  updateDloopBorder();
}

/*Kisser  weight info icon*/
function showKisserWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Kisser Weight (grains)</strong></p>
    <p>Weight of kisser button (anchor reference).</p>
    <p>Typical: 3–8 gr.</p>
    <p>Helps consistent anchor — minimal speed loss.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Kisser Weight (min 0, max 15) */
const kisserWtInput = document.getElementById('kisserWt');

if (kisserWtInput) {
  // Update border on every input change
  function updateKisserBorder() {
    let val = parseFloat(kisserWtInput.value);
    // Skip red border if field is empty (allow typing)
    if (kisserWtInput.value === '') {
      kisserWtInput.style.borderColor = '';
      return;
    }
    // Red border if invalid
    if (isNaN(val) || val < kisserWtInput.min || val > kisserWtInput.max) {
      kisserWtInput.style.borderColor = 'red';
    } else {
      kisserWtInput.style.borderColor = '';
    }
  }

  kisserWtInput.addEventListener('input', () => {
    let val = parseFloat(kisserWtInput.value);
    if (isNaN(val)) return; // Allow typing

    if (val < kisserWtInput.min) {
      kisserWtInput.value = kisserWtInput.min;
    }
    if (val > kisserWtInput.max) {
      kisserWtInput.value = kisserWtInput.max;
    }

    updateKisserBorder();
  });

  kisserWtInput.addEventListener('blur', () => {
    let val = parseFloat(kisserWtInput.value);
    if (kisserWtInput.value === '' || isNaN(val) || val < kisserWtInput.min) {
      kisserWtInput.value = kisserWtInput.min;
    } else if (val > kisserWtInput.max) {
      kisserWtInput.value = kisserWtInput.max;
    }
    kisserWtInput.style.borderColor = ''; // Reset border
  });

  // Initial check on load (won't turn red if empty)
  updateKisserBorder();
}

/* Silencer weight info icon*/
function showSilencerWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Silencers Weight (grains)</strong></p>
    <p>Weight of string silencers (cat whiskers, wool puffs, etc.).</p>
    <p>Typical: 10–30 gr total (pair).</p>
    <p>Quiets bow — noticeable speed reduction if heavy.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Silencer Weight (min 0, max 60) */
const silencerWtInput = document.getElementById('silencerWt');

if (silencerWtInput) {
  // Update border on every input change
  function updateSilencerBorder() {
    let val = parseFloat(silencerWtInput.value);
    // Skip red border if field is empty (allow typing)
    if (silencerWtInput.value === '') {
      silencerWtInput.style.borderColor = '';
      return;
    }
    // Red border if invalid
    if (isNaN(val) || val < silencerWtInput.min || val > silencerWtInput.max) {
      silencerWtInput.style.borderColor = 'red';
    } else {
      silencerWtInput.style.borderColor = '';
    }
  }

  silencerWtInput.addEventListener('input', () => {
    let val = parseFloat(silencerWtInput.value);
    if (isNaN(val)) return; // Allow typing

    if (val < silencerWtInput.min) {
      silencerWtInput.value = silencerWtInput.min;
    }
    if (val > silencerWtInput.max) {
      silencerWtInput.value = silencerWtInput.max;
    }

    updateSilencerBorder();
  });

  silencerWtInput.addEventListener('blur', () => {
    let val = parseFloat(silencerWtInput.value);
    if (silencerWtInput.value === '' || isNaN(val) || val < silencerWtInput.min) {
      silencerWtInput.value = silencerWtInput.min;
    } else if (val > silencerWtInput.max) {
      silencerWtInput.value = silencerWtInput.max;
    }
    silencerWtInput.style.borderColor = ''; // Reset border
  });

  // Initial check on load (won't turn red if empty)
  updateSilencerBorder();
}

/*Sight pins info icon*/
function showSightPinsPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Sight Pin Zeros</strong></p>
    <p>Set the zero yardage for each pin on your bow sight.</p>
    <hr>
    <p><strong>Compound Bows</strong>: Most use multi-pin sights (e.g., 20/30/40/50 yd) or single-pin sliders.</p>
    <p><strong>Target Recurve</strong>: Usually a single adjustable pin (aperture/dot).</p>
    <p><strong>Traditional Recurve / Longbow</strong>: Typically <strong>no pins</strong> — instinctive, gap shooting, or string walking. Select "No Pins" for pure traditional.</p>
    <hr>
    <p><strong>How to Use:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Select number of pins (0 for instinctive)</li>
      <li>Set exact zero for each (e.g., 20/30/50 yd for skipped pins)</li>
      <li>Simulates moving sight housing or dialing a slider</li>
    </ul>
    <p>Used for build reference and future pin gap/drop analysis.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

// AI Analyzer function
async function runAIAnalyzer() {
  // Show immediate feedback (same as AI Lookup)
  updateStatus('analyzerStatus', 'Analyzing your setup...');

  // Gather inputs (unchanged)
  const appType = $('appType').value || 'Hunting';
  const bowModel = $('bowModel').value.trim() || 'Unknown Bow';
  const drawLen = parseFloat($('drawLen').value) || 28;
  const drawWt = parseFloat($('drawWt').value) || 70;
  const totalWt = parseFloat($('totalWt').value) || 0;
  const pointWt = parseFloat($('pointWt').value) || 125;
  const arrowLen = parseFloat($('arrowLen').value) || drawLen + 0.5;
  const spine = parseFloat($('spine').value) || 300;
  const balancePt = parseFloat($('balancePt').value) || arrowLen / 2 + 1;
  const foc = ((balancePt - arrowLen / 2) / arrowLen) * 100;

  try {
    // Update during fetch
    updateStatus('analyzerStatus', 'Fetching recommendations...');

    const response = await fetch(
      `https://arrowforgeapp.com/api/analyze?` +
      `appType=${encodeURIComponent(appType)}&` +
      `bowModel=${encodeURIComponent(bowModel)}&` +
      `drawLen=${drawLen}&drawWt=${drawWt}&` +
      `totalWt=${totalWt}&pointWt=${pointWt}&arrowLen=${arrowLen}&spine=${spine}&foc=${foc.toFixed(1)}`
    );

    if (!response.ok) throw new Error(`API error: ${response.status}`);

    const data = await response.json();

    // Show AI's status if provided
    if (data.status) {
      updateStatus('analyzerStatus', data.status);
    } else {
      updateStatus('analyzerStatus', 'Processing complete');
    }

    // Build readable HTML (with better dark mode contrast)
    let resultsHTML = '<h3 style="color:var(--text);">AI Arrow Recommendations</h3>';

    if (data.error) {
      resultsHTML += `<p style="color:var(--danger); font-weight:600;">Error: ${data.error}</p>`;
    } else if (data.matches && data.matches.length > 0) {
      if (data.ambiguous) {
        resultsHTML += '<p style="color:var(--light);">Multiple options found — choose the best one:</p>';
        data.matches.forEach((match, i) => {
          resultsHTML += `
            <div style="background:var(--card); padding:0.75rem; margin:0.5rem 0; border-radius:8px; border:1px solid var(--border);">
              <strong style="color:var(--primary);">${i + 1}. ${match.full_name}</strong> (${match.year || 'unknown'})<br>
              <strong style="color:var(--text);">Arrow Length:</strong> Cut to ${match.arrowLength || (drawLen + 0.5).toFixed(1)}"<br>
              <strong style="color:var(--text);">FOC:</strong> ${match.foc || 'unknown'}% | 
              <strong style="color:var(--text);">GPP:</strong> ${match.gpp || 'unknown'} | 
              <strong style="color:var(--text);">GPI:</strong> ${match.gpi || 'unknown'} | 
              <strong style="color:var(--text);">Stiffness:</strong> ${match.stiffness || 'unknown'}<br>
              <strong style="color:var(--text);">Why it fits:</strong> ${match.why}
            </div>`;
        });
      } else {
        const match = data.matches[0];
        resultsHTML += `
          <div style="background:var(--card); padding:1rem; border-radius:8px; border:1px solid var(--border);">
            <strong style="color:var(--primary);">Recommended Arrow: ${match.full_name}</strong> (${match.year || 'unknown'})<br>
            <strong style="color:var(--text);">Arrow Length:</strong> Cut to ${match.arrowLength || (drawLen + 0.5).toFixed(1)}"<br>
            <strong style="color:var(--text);">FOC:</strong> ${match.foc || 'unknown'}% | 
            <strong style="color:var(--text);">GPP:</strong> ${match.gpp || 'unknown'} | 
            <strong style="color:var(--text);">GPI:</strong> ${match.gpi || 'unknown'} | 
            <strong style="color:var(--text);">Stiffness:</strong> ${match.stiffness || 'unknown'}<br>
            <strong style="color:var(--text);">Why it fits:</strong> ${match.why}
          </div>`;
      }
    } else {
      resultsHTML += '<p style="color:var(--light);">No suggestions found. Try entering more details.</p>';
    }

    document.getElementById('analyzerResults').innerHTML = resultsHTML;
    document.getElementById('analyzerModal').style.display = 'block';
    document.getElementById('analyzerOverlay').style.display = 'block';

    // Auto-hide status after results appear
    setTimeout(() => updateStatus('analyzerStatus', '', false), 1500);
  } catch (e) {
    console.error(e);
    updateStatus('analyzerStatus', 'Error connecting to AI', true);
    setTimeout(() => updateStatus('analyzerStatus', '', false), 3000);
  }
}

/*Spine info icon*/
function showSpinePopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Spine</strong></p>
    <p>Arrow stiffness rating — measures how much the shaft flexes under force.</p>
    <hr>
    <p><strong>Typical Ranges:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>300–400 spine: Stiffer — for heavy draw weight (70–90+ lb) or short draw length.</li>
      <li>400–500 spine: Standard — most hunting bows (50–70 lb).</li>
      <li>500–700+ spine: Softer — lighter draw weight (30–50 lb) or longer arrows.</li>
    </ul>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Arrow tuning & forgiveness</li>
      <li>Future spine recommendation</li>
      <li>Build comparison & reference</li>
    </ul>
    <p>Stiffer spine = less flex (more accurate at speed), but less forgiving on release. Softer spine = more flex (forgiving), but can cause erratic flight if too soft.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Spine (min 100, max 600) */
const spineInput = document.getElementById('spine');

if (spineInput) {
  // Update border on every input change
  function updateSpineBorder() {
    let val = parseFloat(spineInput.value);
    // Only apply red if user has typed something invalid
    if (spineInput.value !== '' && (isNaN(val) || val < spineInput.min || val > spineInput.max)) {
      spineInput.style.borderColor = 'red';
    } else {
      spineInput.style.borderColor = '';
    }
  }

  spineInput.addEventListener('input', () => {
    let val = parseFloat(spineInput.value);
    if (isNaN(val)) return; // Allow typing

    if (val < spineInput.min) {
      spineInput.value = spineInput.min;
    }
    if (val > spineInput.max) {
      spineInput.value = spineInput.max;
    }

    updateSpineBorder();
  });

  spineInput.addEventListener('blur', () => {
    let val = parseFloat(spineInput.value);
    if (spineInput.value !== '' && (isNaN(val) || val < spineInput.min)) {
      spineInput.value = spineInput.min;
    } else if (val > spineInput.max) {
      spineInput.value = spineInput.max;
    }
    updateSpineBorder();
  });

  // Initial check: only if value is present
  updateSpineBorder();
}

/*Arrow diameter*/
function showArrowDiaPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Arrow Diameter</strong></p>
    <p>Outside diameter of the shaft — affects wind drift and penetration.</p>
    <hr>
    <p><strong>Standard (~6.5mm / .246")</strong>: Most common — easiest components, durable.</p>
    <p><strong>Small (~5mm / .204")</strong>: Balanced — good wind resistance, standard components.</p>
    <p><strong>Micro (~4mm / .166")</strong>: Best wind drift & penetration — specialized components.</p>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Future wind drift calculation</li>
      <li>Build comparison & reference</li>
    </ul>
    <p>Smaller diameter = less wind drift + better penetration, but trickier components.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Arrow Length info icon*/
function showArrowLenPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Arrow Length (inches)</strong></p>
    <p>Carbon-to-carbon length (from nock throat to end of shaft, not including point).</p>
    <hr>
    <p><strong>Typical Ranges:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>26–28 in: Shorter draw or compact hunting setups</li>
      <li>28–30 in: Most common — average adult male</li>
      <li>30+ in: Long draw lengths or target arrows</li>
    </ul>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>FOC calculation (longer = easier high FOC)</li>
      <li>GPI (grains per inch) calculation</li>
      <li>Stiffness recommendation (longer arrows need stiffer spine)</li>
      <li>Speed estimate (longer = slightly slower)</li>
    </ul>
    <p>Longer arrows = more stable, higher FOC, but slightly less speed.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Arrow Length (min 20, max 35) */
const arrowLenInput = document.getElementById('arrowLen');

if (arrowLenInput) {
  // Update border on every input change
  function updateArrowLenBorder() {
    let val = parseFloat(arrowLenInput.value);
    // Skip red border if field is empty (allow typing)
    if (arrowLenInput.value === '') {
      arrowLenInput.style.borderColor = '';
      return;
    }
    // Red border if invalid
    if (isNaN(val) || val < arrowLenInput.min || val > arrowLenInput.max) {
      arrowLenInput.style.borderColor = 'red';
    } else {
      arrowLenInput.style.borderColor = '';
    }
  }

  arrowLenInput.addEventListener('input', () => {
    // Only update border while typing - no clamping here
    updateArrowLenBorder();
  });

  arrowLenInput.addEventListener('blur', () => {
    let val = parseFloat(arrowLenInput.value);
    if (arrowLenInput.value === '' || isNaN(val) || val < arrowLenInput.min) {
      arrowLenInput.value = arrowLenInput.min;
    } else if (val > arrowLenInput.max) {
      arrowLenInput.value = arrowLenInput.max;
    }
    updateArrowLenBorder(); // Final border check
  });

  // Initial check on load (won't turn red if empty)
  updateArrowLenBorder();
}

/* Total Arrow Weight (Input Field) info icon popup */
function showTotalWtInputPopup() {
  const totalWt = parseFloat($('totalWt').value) || 495;
  const bowType = $('bowType')?.value || 'compound';
  const appType = $('appType')?.value || 'Hunting';

  let sweetMin = 450;
  let sweetMax = 550;
  let typeLabel = "Compound/Hunting";

  if (bowType === 'recurve' || bowType === 'longbow') {
    sweetMin = 400;
    sweetMax = 600;
    typeLabel = "Recurve/Longbow";
  } else if (appType === 'Target') {
    sweetMin = 350;
    sweetMax = 450;
    typeLabel = "Target";
  }

  const isHeavy = totalWt > sweetMax;
  const isLight = totalWt < sweetMin;

  const content = `
    <p><strong>Total Arrow Weight (Input Field)</strong></p>
    <p>This is the master weight value for your finished arrow — everything included (shaft, point, insert, fletching, wrap, glue). It drives nearly every calculation in the app.</p>
    <hr>
    <p><strong>Your Current Value:</strong></p>
    <ul style="margin-left:1.25rem; font-size:0.9rem;">
      <li>Total Arrow Weight: <strong>${totalWt.toFixed(1)} gr</strong></li>
    </ul>
    <hr>
    <p><strong>Typical Arrow Weight Ranges:</strong></p>
    <ul style="margin-left:1.25rem; font-size:0.9rem;">
      <li><strong>Youth/Children</strong> (20–50 lb bows): 250–400 gr — light for easy draw and safety</li>
      <li><strong>Women/Shorter Adults</strong> (40–60 lb): 350–480 gr — balanced speed & forgiveness</li>
      <li><strong>Adult Men (Compound Hunting)</strong> (60–80+ lb): 450–550 gr — ideal penetration & speed</li>
      <li><strong>Target/3D</strong> (40–70 lb): 350–450 gr — lighter for flat trajectory & forgiveness</li>
      <li><strong>Recurve/Longbow</strong> (30–60 lb): 400–600 gr — heavier for momentum & quietness</li>
    </ul>
    <hr>
    <p><strong>Your Build Status:</strong></p>
    <p style="margin-top:0.75rem; font-weight:bold;">
      ${isHeavy ? 'Heavy — more penetration but slower' : 
        isLight ? 'Light — faster but less momentum' : 
        'Your TW is in the ideal range!'}
    </p>
    <hr>
    <p><strong>How to Set This Value:</strong></p>
    <ul style="margin-left:1.25rem; font-size:0.9rem;">
      <li><strong>Manual entry</strong> (here) — quick estimate if you know your finished weight</li>
      <li><strong>Detailed components</strong> (checkbox below) — auto-calculated from individual parts for accuracy</li>
    </ul>
    <hr>
    <p>This value drives:</p>
    <ul style="margin-left:1.25rem; font-size:0.9rem;">
      <li>GPP & GPI</li>
      <li>FOC (if using balance point)</li>
      <li>Kinetic Energy & Momentum</li>
      <li>Game Effectiveness ratings</li>
      <li>Trajectory, drop, flight time</li>
    </ul>
    <p><strong>Pro tip:</strong> Get this as accurate as possible — even 10–20 gr off can change recommendations noticeably.</p>
  `;

  $('gameMathContent').innerHTML = content;
  $('gameMathModal').style.display = 'flex';
}

/* Total Weight (min 200, max 1000) */
const totalWeightInput = document.getElementById('totalWt');

if (totalWeightInput) {
  // Update border on every input change
  function updateTotalWeightBorder() {
    let val = parseFloat(totalWeightInput.value);
    // Skip red border if field is empty (allow typing)
    if (totalWeightInput.value === '') {
      totalWeightInput.style.borderColor = '';
      return;
    }
    // Red border if invalid
    if (isNaN(val) || val < totalWeightInput.min || val > totalWeightInput.max) {
      totalWeightInput.style.borderColor = 'red';
    } else {
      totalWeightInput.style.borderColor = '';
    }
  }

  totalWeightInput.addEventListener('input', () => {
    // Only update border while typing - no clamping here
    updateTotalWeightBorder();
  });

  totalWeightInput.addEventListener('blur', () => {
    let val = parseFloat(totalWeightInput.value);
    if (totalWeightInput.value === '' || isNaN(val) || val < totalWeightInput.min) {
      totalWeightInput.value = totalWeightInput.min;
    } else if (val > totalWeightInput.max) {
      totalWeightInput.value = totalWeightInput.max;
    }
    updateTotalWeightBorder(); // Final border check
  });

  // Initial check on load (won't turn red if empty)
  updateTotalWeightBorder();
}

/* Point Weight info icon */
function showPointWtPopup() {
  const pointWt = parseFloat($('pointWt').value) || 125;
  const bowType = $('bowType')?.value || 'compound';
  const appType = $('appType')?.value || 'Hunting';

  let sweetMin = 100;
  let sweetMax = 175;
  let typeLabel = "Compound/Hunting";

  if (bowType === 'recurve' || bowType === 'longbow') {
    sweetMin = 125;
    sweetMax = 200;
    typeLabel = "Recurve/Longbow";
  } else if (appType === 'Target') {
    sweetMin = 90;
    sweetMax = 120;
    typeLabel = "Target";
  }

  const isHeavy = pointWt > sweetMax;
  const isLight = pointWt < sweetMin;

  $('gameMathContent').innerHTML = `
    <p><strong>Point Weight Math & Usage</strong></p>
    <p>Point weight (broadhead + insert/outsert) is one of the most powerful tuning levers — it dramatically affects FOC, total arrow weight, trajectory, and penetration.</p>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Point Weight: <strong>${pointWt.toFixed(1)} gr</strong></li>
      <li>Setup: <strong>${typeLabel}</strong></li>
    </ul>
    <hr>
    <p><strong>Sweet Spot (highlighted in green):</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Compound/Hunting</strong>: 100–175 gr — balanced FOC & speed</li>
      <li><strong>Target</strong>: 90–120 gr — lower FOC for forgiveness</li>
      <li><strong>Recurve/Longbow</strong>: 125–200 gr — higher FOC for stability</li>
    </ul>
    <p style="margin-top:0.75rem;">
      ${isHeavy ? '<strong>Heavy point — higher FOC & penetration, slower speed</strong>' :
        isLight ? '<strong>Light point — lower FOC, flatter trajectory</strong>' :
        '<strong>Your point weight is in the ideal range!</strong>'}
    </p>
    <hr>
    <p>This value directly influences:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Total Arrow Weight (adds to shaft + components)</li>
      <li>FOC (heavier point = higher FOC)</li>
      <li>Spine recommendation (heavier point = effectively stiffer draw)</li>
      <li>Trajectory & drop</li>
      <li>Kinetic Energy & Momentum</li>
      <li>Game Effectiveness ratings</li>
    </ul>
    <hr>
    <p><strong>Pro Tip:</strong> Changing point weight by even 25 gr can noticeably shift FOC, speed, and penetration — experiment here before buying new heads!</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Point Weight (min 50, max 300) */
const pointWtInput = document.getElementById('pointWt');

if (pointWtInput) {
  // Update border on every input change
  function updatePointWtBorder() {
    let val = parseFloat(pointWtInput.value);
    // Skip red border if field is empty (allow typing)
    if (pointWtInput.value === '') {
      pointWtInput.style.borderColor = '';
      return;
    }
    // Red border if invalid
    if (isNaN(val) || val < pointWtInput.min || val > pointWtInput.max) {
      pointWtInput.style.borderColor = 'red';
    } else {
      pointWtInput.style.borderColor = '';
    }
  }

  pointWtInput.addEventListener('input', () => {
    // Only update border while typing - no clamping here
    updatePointWtBorder();
  });

  pointWtInput.addEventListener('blur', () => {
    let val = parseFloat(pointWtInput.value);
    if (pointWtInput.value === '' || isNaN(val) || val < pointWtInput.min) {
      pointWtInput.value = pointWtInput.min;
    } else if (val > pointWtInput.max) {
      pointWtInput.value = pointWtInput.max;
    }
    updatePointWtBorder(); // Final border check
  });

  // Initial check on load (won't turn red if empty)
  updatePointWtBorder();
}

/*Balance Point info icon*/
function showBalancePtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Balance Point (inches)</strong></p>
    <p>Distance from nock throat to the arrow's physical balance point (center of gravity).</p>
    <hr>
    <p><strong>How to Measure:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Balance arrow on a finger or edge</li>
      <li>Measure from nock throat to balance point</li>
    </ul>
    <hr>
    <p><strong>Typical Values:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>16–17 in: Lower FOC (lighter point)</li>
      <li>17–18 in: Good FOC (most hunting arrows)</li>
      <li>18+ in: High FOC (heavy point/insert)</li>
    </ul>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Accurate FOC calculation</li>
      <li>Build comparison & tuning reference</li>
    </ul>
    <p>Higher balance point = higher FOC = better stability & penetration.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Balance Point (min 10, max 30) */
const balancePtInput = document.getElementById('balancePt');

if (balancePtInput) {
  // Update border on every input change
  function updateBalancePtBorder() {
    let val = parseFloat(balancePtInput.value);
    // Skip red border if field is empty (allow typing)
    if (balancePtInput.value === '') {
      balancePtInput.style.borderColor = '';
      return;
    }
    // Red border if invalid
    if (isNaN(val) || val < balancePtInput.min || val > balancePtInput.max) {
      balancePtInput.style.borderColor = 'red';
    } else {
      balancePtInput.style.borderColor = '';
    }
  }

  balancePtInput.addEventListener('input', () => {
    // Only update border while typing - no clamping here
    updateBalancePtBorder();
  });

  balancePtInput.addEventListener('blur', () => {
    let val = parseFloat(balancePtInput.value);
    if (balancePtInput.value === '' || isNaN(val) || val < balancePtInput.min) {
      balancePtInput.value = balancePtInput.min;
    } else if (val > balancePtInput.max) {
      balancePtInput.value = balancePtInput.max;
    }
    updateBalancePtBorder(); // Final border check
  });

  // Initial check on load (won't turn red if empty)
  updateBalancePtBorder();
}


/*Checkbox behavior*/
function toggleArrowDetailsMode() {
  const checkbox = $('useArrowDetails');
  const checked = checkbox?.checked ?? false;

  const detailIds = ['bareShaftWt', 'insertWt', 'pointType', 'inFlightDia','wrapWt', 'vaneWt', 'vaneCount', 'vaneHeight', 'vaneHelical', 'glueWt','nockWt'];
  const mainInput = $('totalWt');

  detailIds.forEach(id => {
    const input = $(id);
    if (input) {
      if (id === 'vaneHelical') {
        input.disabled = !checked; // select uses disabled
      } else {
        input.readOnly = !checked;
      }
      input.style.backgroundColor = checked ? '' : 'var(--border)';
      input.style.opacity = checked ? '' : '0.6';
    }
  });

  if (mainInput) {
    mainInput.readOnly = checked;
    mainInput.style.backgroundColor = checked ? 'var(--border)' : '';
    mainInput.style.opacity = checked ? '0.6' : '';
  }

  calculateEverything(); // update total and display
}

/*Bare shaft weight info icon*/
function showBareShaftWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Bare Shaft Weight (grains)</strong></p>
    <p>Weight of the arrow shaft only — no point, insert, nock, or fletching.</p>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Future advanced tuning (bare shaft testing)</li>
      <li>Build reference & comparison</li>
    </ul>
    <p>Leave 0 if unknown — not required for current calculations.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Bare Shaft Weight (min 0, max 400) */
const bareShaftWtInput = document.getElementById('bareShaftWt');

if (bareShaftWtInput) {
  bareShaftWtInput.addEventListener('input', () => {
    // No reset here - allow backspace and typing freely
  });

  bareShaftWtInput.addEventListener('blur', () => {
    let val = parseFloat(bareShaftWtInput.value);
    if (bareShaftWtInput.value === '' || isNaN(val) || val < 0) {
      bareShaftWtInput.value = 0; // Reset only on leaving field if invalid/empty
    } else if (val > 400) {
      bareShaftWtInput.value = 400;
    }
  });
}

/* Insert / Outsert Weight info icon */
function showInsertWtPopup() {
  const insertWt = parseFloat($('insertWt').value) || 0;
  const pointWt = parseFloat($('pointWt').value) || 125;
  const totalFront = insertWt + pointWt;

  let weightClass = '';
  if (insertWt >= 100) weightClass = 'Heavy (deep penetration setup)';
  else if (insertWt >= 60) weightClass = 'Moderate (common hybrid)';
  else if (insertWt > 0) weightClass = 'Light (standard insert)';
  else weightClass = 'None';

  $('gameMathContent').innerHTML = `
    <p><strong>Insert / Outsert Weight</strong></p>
    <p>Weight of any internal insert or external outsert (half-out, ethics, HIT, etc.) in grains.</p>
    <p>You may need to <strong>reduce the weight of your Point Weight gr.</strong> if you included (broadhead + insert/outsert).</p>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Insert/Outsert Weight: <strong>${insertWt.toFixed(1)} gr</strong></li>
      <li>Total Front Weight: <strong>${totalFront.toFixed(1)} gr</strong> (insert + point)</li>
      <li>Classification: <strong>${weightClass}</strong></li>
    </ul>
    <hr>
    <p><strong>Common Types & Weights:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Standard aluminum insert: 10–30 gr</li>
      <li>Aluminum half-out: 50–80 gr</li>
      <li>Steel/titanium outsert: 75–125 gr</li>
      <li>Ethics Archery insert: ~100 gr</li>
      <li>Heavy HIT/outserts: 125–200+ gr</li>
    </ul>
    <hr>
    <p><strong>Why It Matters:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Increases FOC (more weight forward)</li>
      <li>Adds total arrow weight → better momentum & penetration</li>
      <li>Strengthens arrow front end (protects shaft from broadhead impact)</li>
      <li>Allows heavier broadheads without weak spine</li>
    </ul>
    <p style="margin-top:0.75rem;">
      Popular for hunting — especially elk/moose setups with 125–200 gr broadheads.
    </p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Insert/Outsert Weight (min 0, max 300) */
const insertWtInput = document.getElementById('insertWt');

if (insertWtInput) {
  // Update border on every input change
  function updateInsertWtBorder() {
    let val = parseFloat(insertWtInput.value);
    // Skip red border if field is empty (allow typing)
    if (insertWtInput.value === '') {
      insertWtInput.style.borderColor = '';
      return;
    }
    // Red border if invalid
    if (isNaN(val) || val < insertWtInput.min || val > insertWtInput.max) {
      insertWtInput.style.borderColor = 'red';
    } else {
      insertWtInput.style.borderColor = '';
    }
  }

  insertWtInput.addEventListener('input', () => {
    let val = parseFloat(insertWtInput.value);
    if (isNaN(val)) return; // Allow typing

    if (val < insertWtInput.min) {
      insertWtInput.value = insertWtInput.min;
    }
    if (val > insertWtInput.max) {
      insertWtInput.value = insertWtInput.max;
    }

    updateInsertWtBorder();
  });

  insertWtInput.addEventListener('blur', () => {
    let val = parseFloat(insertWtInput.value);
    if (insertWtInput.value === '' || isNaN(val) || val < insertWtInput.min) {
      insertWtInput.value = insertWtInput.min;
    } else if (val > insertWtInput.max) {
      insertWtInput.value = insertWtInput.max;
    }
    insertWtInput.style.borderColor = ''; // Reset border
  });

  // Initial check on load (won't turn red if empty)
  updateInsertWtBorder();
}

/* Point Type info icon */
function showPointTypePopup() {
  const pointType = $('pointType').value || 'Fixed Blade';
  const inFlightDia = parseFloat($('inFlightDia').value) || 0;

  $('gameMathContent').innerHTML = `
    <p><strong>Point Type</strong></p>
    <p>Select your broadhead/point type — affects flight characteristics, tuning, and future drag/wind modeling.</p>
    <hr>
    <p><strong>Your Current Selection:</strong> <strong>${pointType}</strong></p>
    <hr>
    <p><strong>Types Explained:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Fixed Blade</strong>: Blades always open — reliable penetration, no moving parts. More drag in flight, can require bow tuning for field-point accuracy.</li>
      <li><strong>Mechanical</strong>: Blades closed in flight (low drag, flies like field point), open on impact for larger cut. Easier to tune, great blood trails, but can fail on heavy bone.</li>
      <li><strong>Field Point</strong>: Practice point — no blades. Minimal drag, perfect for tuning and target shooting.</li>
    </ul>
    <hr>
    <p><strong>Pro Tip:</strong> Mechanicals often have smaller "in-flight diameter" than cutting diameter — enter the closed diameter below for accurate drag modeling.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* In-Flight Diameter info icon */
function showInFlightDiaPopup() {
  const inFlightDia = parseFloat($('inFlightDia').value) || 0;
  const pointType = $('pointType').value || 'Fixed Blade';

  let typical = '';
  if (pointType === 'Mechanical') typical = '0.75–1.0 in (closed blades)';
  else if (pointType === 'Fixed Blade') typical = '1.0–1.5 in (exposed blades)';
  else typical = '0.25–0.3 in (shaft only)';

  $('gameMathContent').innerHTML = `
    <p><strong>In-Flight Diameter (inches)</strong></p>
    <p>Effective frontal diameter during flight — shaft + any exposed blades. Critical for drag and wind drift calculations.</p>
    <hr>
    <p><strong>Your Current Value:</strong> <strong>${inFlightDia.toFixed(2) || '—'} in</strong></p>
    <p><strong>Point Type:</strong> ${pointType}</p>
    <hr>
    <p><strong>Typical Values:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Field Point: 0.25–0.3 in (shaft diameter only)</li>
      <li>Mechanical (closed): 0.75–1.0 in</li>
      <li>Fixed Blade: 1.0–1.5 in (blades exposed)</li>
    </ul>
    <hr>
    <p><strong>Why It Matters:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Larger diameter = more drag → slower speed, more drop, greater wind drift</li>
      <li>Smaller diameter = flatter trajectory, better long-range performance</li>
      <li>Mechanicals fly with small diameter but cut larger on impact</li>
    </ul>
    <p style="margin-top:0.75rem;"><strong>Pro Tip:</strong> For mechanicals, enter the closed/blades-folded diameter — this gives accurate in-flight performance.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* In-Flight Diameter (min 0.2, max 5.0) */
const inFlightDiaInput = document.getElementById('inFlightDia');

if (inFlightDiaInput) {
  // Update border on every input change
  function updateInFlightDiaBorder() {
    let val = parseFloat(inFlightDiaInput.value);
    // Skip red border if field is empty (allow typing)
    if (inFlightDiaInput.value === '') {
      inFlightDiaInput.style.borderColor = '';
      return;
    }
    // Red border if invalid
    if (isNaN(val) || val < inFlightDiaInput.min || val > inFlightDiaInput.max) {
      inFlightDiaInput.style.borderColor = 'red';
    } else {
      inFlightDiaInput.style.borderColor = '';
    }
  }

  inFlightDiaInput.addEventListener('input', () => {
    let val = parseFloat(inFlightDiaInput.value);
    if (isNaN(val)) return; // Allow typing

    if (val < inFlightDiaInput.min) {
      inFlightDiaInput.value = inFlightDiaInput.min;
    }
    if (val > inFlightDiaInput.max) {
      inFlightDiaInput.value = inFlightDiaInput.max;
    }

    updateInFlightDiaBorder();
  });

  inFlightDiaInput.addEventListener('blur', () => {
    let val = parseFloat(inFlightDiaInput.value);
    if (inFlightDiaInput.value === '' || isNaN(val) || val < inFlightDiaInput.min) {
      inFlightDiaInput.value = inFlightDiaInput.min;
    } else if (val > inFlightDiaInput.max) {
      inFlightDiaInput.value = inFlightDiaInput.max;
    }
    inFlightDiaInput.style.borderColor = ''; // Reset border
  });

  // Initial check on load (won't turn red if empty)
  updateInFlightDiaBorder();
}

/*wrap  weight info icon*/
function showWrapWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Wrap Weight (grains)</strong></p>
    <p>Weight of arrow wrap (vinyl decal under vanes).</p>
    <hr>
    <p>Typical: 6–12 gr total (lighter = thinner material).</p>
    <p>Adds custom look and slight FOC — minimal speed impact.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Wrap Weight (min 0, max 30) */
const wrapWtInput = document.getElementById('wrapWt');

if (wrapWtInput) {
  // Update border on every input change
  function updateWrapWtBorder() {
    let val = parseFloat(wrapWtInput.value);
    // Skip red border if field is empty (allow typing)
    if (wrapWtInput.value === '') {
      wrapWtInput.style.borderColor = '';
      return;
    }
    // Red border if invalid
    if (isNaN(val) || val < wrapWtInput.min || val > wrapWtInput.max) {
      wrapWtInput.style.borderColor = 'red';
    } else {
      wrapWtInput.style.borderColor = '';
    }
  }

  wrapWtInput.addEventListener('input', () => {
    let val = parseFloat(wrapWtInput.value);
    if (isNaN(val)) return; // Allow typing

    if (val < wrapWtInput.min) {
      wrapWtInput.value = wrapWtInput.min;
    }
    if (val > wrapWtInput.max) {
      wrapWtInput.value = wrapWtInput.max;
    }

    updateWrapWtBorder();
  });

  wrapWtInput.addEventListener('blur', () => {
    let val = parseFloat(wrapWtInput.value);
    if (wrapWtInput.value === '' || isNaN(val) || val < wrapWtInput.min) {
      wrapWtInput.value = wrapWtInput.min;
    } else if (val > wrapWtInput.max) {
      wrapWtInput.value = wrapWtInput.max;
    }
    wrapWtInput.style.borderColor = ''; // Reset border
  });

  // Initial check on load (won't turn red if empty)
  updateWrapWtBorder();
}

/*Vane  weight info icon*/
function showVaneWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Vane Weight (each, grains)</strong></p>
    <p>Weight of one individual vane/fletching.</p>
    <hr>
    <p>Typical:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Low-profile (2"): 5–8 gr each</li>
      <li>Standard (3–4"): 8–12 gr each</li>
      <li>Blazer-style: ~6 gr each</li>
    </ul>
    <p>Multiplied by vane count for total fletching weight.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Vane Weight (each) (min 0, max 20) */
const vaneWtInput = document.getElementById('vaneWt');

if (vaneWtInput) {
  // Update border on every input change
  function updateVaneWtBorder() {
    let val = parseFloat(vaneWtInput.value);
    // Skip red border if field is empty (allow typing)
    if (vaneWtInput.value === '') {
      vaneWtInput.style.borderColor = '';
      return;
    }
    // Red border if invalid
    if (isNaN(val) || val < vaneWtInput.min || val > vaneWtInput.max) {
      vaneWtInput.style.borderColor = 'red';
    } else {
      vaneWtInput.style.borderColor = '';
    }
  }

  vaneWtInput.addEventListener('input', () => {
    let val = parseFloat(vaneWtInput.value);
    if (isNaN(val)) return; // Allow typing

    if (val < vaneWtInput.min) {
      vaneWtInput.value = vaneWtInput.min;
    }
    if (val > vaneWtInput.max) {
      vaneWtInput.value = vaneWtInput.max;
    }

    updateVaneWtBorder();
  });

  vaneWtInput.addEventListener('blur', () => {
    let val = parseFloat(vaneWtInput.value);
    if (vaneWtInput.value === '' || isNaN(val) || val < vaneWtInput.min) {
      vaneWtInput.value = vaneWtInput.min;
    } else if (val > vaneWtInput.max) {
      vaneWtInput.value = vaneWtInput.max;
    }
    vaneWtInput.style.borderColor = ''; // Reset border
  });

  // Initial check on load (won't turn red if empty)
  updateVaneWtBorder();
}

/* Vane Count info icon*/
function showVaneCountPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Vane Count</strong></p>
    <p>Number of vanes/fletchings on the arrow.</p>
    <hr>
    <p>Common:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>3 vanes: Most popular — stable, common for hunting</li>
      <li>4 vanes: Extra stability — popular for fixed broadheads</li>
      <li>2 vanes: Rare — some target setups</li>
    </ul>
    <p>More vanes = faster stabilization, slightly more weight/drag.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Vane Count (min 0, max 6) */
const vaneCountInput = document.getElementById('vaneCount');

if (vaneCountInput) {
  // Update border on every input change
  function updateVaneCountBorder() {
    let val = parseFloat(vaneCountInput.value);
    // Skip red border if field is empty (allow typing)
    if (vaneCountInput.value === '') {
      vaneCountInput.style.borderColor = '';
      return;
    }
    // Red border if invalid
    if (isNaN(val) || val < vaneCountInput.min || val > vaneCountInput.max) {
      vaneCountInput.style.borderColor = 'red';
    } else {
      vaneCountInput.style.borderColor = '';
    }
  }

  vaneCountInput.addEventListener('input', () => {
    let val = parseFloat(vaneCountInput.value);
    if (isNaN(val)) return; // Allow typing

    if (val < vaneCountInput.min) {
      vaneCountInput.value = vaneCountInput.min;
    }
    if (val > vaneCountInput.max) {
      vaneCountInput.value = vaneCountInput.max;
    }

    updateVaneCountBorder();
  });

  vaneCountInput.addEventListener('blur', () => {
    let val = parseFloat(vaneCountInput.value);
    if (vaneCountInput.value === '' || isNaN(val) || val < vaneCountInput.min) {
      vaneCountInput.value = vaneCountInput.min;
    } else if (val > vaneCountInput.max) {
      vaneCountInput.value = vaneCountInput.max;
    }
    vaneCountInput.style.borderColor = ''; // Reset border
  });

  // Initial check on load (won't turn red if empty)
  updateVaneCountBorder();
}

/*Vane Height info icon*/
function showVaneHeightPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Vane Height (inches)</strong></p>
    <p>Height of the vane from shaft to top edge.</p>
    <hr>
    <p>Typical:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Low-profile (0.4–0.6"): Less wind drift, common for hunting</li>
      <li>Medium (0.7–1"): Balanced — good for broadheads</li>
      <li>High (2"+): Max stabilization — target or heavy broadheads</li>
    </ul>
    <p>Taller = faster arrow correction, more drag/wind effect.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Vane Height (min 0.2, max 5.0) */
const vaneHeightInput = document.getElementById('vaneHeight');

if (vaneHeightInput) {
  // Update border on every input change
  function updateVaneHeightBorder() {
    let val = parseFloat(vaneHeightInput.value);
    // Skip red border if field is empty (allow typing)
    if (vaneHeightInput.value === '') {
      vaneHeightInput.style.borderColor = '';
      return;
    }
    // Red border if invalid
    if (isNaN(val) || val < vaneHeightInput.min || val > vaneHeightInput.max) {
      vaneHeightInput.style.borderColor = 'red';
    } else {
      vaneHeightInput.style.borderColor = '';
    }
  }

  vaneHeightInput.addEventListener('input', () => {
    let val = parseFloat(vaneHeightInput.value);
    if (isNaN(val)) return; // Allow typing

    if (val < vaneHeightInput.min) {
      vaneHeightInput.value = vaneHeightInput.min;
    }
    if (val > vaneHeightInput.max) {
      vaneHeightInput.value = vaneHeightInput.max;
    }

    updateVaneHeightBorder();
  });

  vaneHeightInput.addEventListener('blur', () => {
    let val = parseFloat(vaneHeightInput.value);
    if (vaneHeightInput.value === '' || isNaN(val) || val < vaneHeightInput.min) {
      vaneHeightInput.value = vaneHeightInput.min;
    } else if (val > vaneHeightInput.max) {
      vaneHeightInput.value = vaneHeightInput.max;
    }
    vaneHeightInput.style.borderColor = ''; // Reset border
  });

  // Initial check on load (won't turn red if empty)
  updateVaneHeightBorder();
}

/*Vane Helical info icon*/
function showVaneHelicalPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Helical / Offset</strong></p>
    <p>Angle of the vanes — causes arrow rotation for better stability and broadhead flight.</p>
    <hr>
    <p><strong>Options Explained:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Straight</strong>: No spin — minimal drag, fastest.</li>
      <li><strong>Slight Offset</strong>: ~1–3° — gentle spin, good for field points.</li>
      <li><strong>Moderate Offset</strong>: ~4–6° — balanced, common for hunting.</li>
      <li><strong>High Offset / Helical</strong>: ~7–10° — strong spin, great for fixed broadheads.</li>
      <li><strong>Max Helical</strong>: 11°+ (Bitzenburger right helical max) — fastest spin, best broadhead stabilization.</li>
    </ul>
    <hr>
    <p><strong>Bitzenburger Users:</strong> Use the dial setting (in degrees) to match above — e.g., 3° = Slight, 6° = Moderate, 11–12° = Max.</p>
    <hr>
    <p><strong>How to Use:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>More helical/offset = faster arrow rotation = better broadhead flight & stability</li>
      <li>Trade-off: slightly more drag = minor speed loss</li>
      <li>Fixed-blade broadheads benefit most from high/max helical</li>
    </ul>
    <p>Most hunters use Moderate to Max for reliable broadhead tuning.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Nock weight info icon*/
function showNockWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Nock Weight (grains)</strong></p>
    <p>Extra weight from brass nocking points or tie-on nocks.</p>
    <p>Typical: 5–15 gr (brass ~10 gr).</p>
    <p>Small impact on speed, improves nock fit.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Nock Weight (min 0, max 50) */
const nockWtInput = document.getElementById('nockWt');

if (nockWtInput) {
  // Update border on every input change
  function updateNockWtBorder() {
    let val = parseFloat(nockWtInput.value);
    // Skip red border if field is empty (allow typing)
    if (nockWtInput.value === '') {
      nockWtInput.style.borderColor = '';
      return;
    }
    // Red border if invalid
    if (isNaN(val) || val < nockWtInput.min || val > nockWtInput.max) {
      nockWtInput.style.borderColor = 'red';
    } else {
      nockWtInput.style.borderColor = '';
    }
  }

  nockWtInput.addEventListener('input', () => {
    let val = parseFloat(nockWtInput.value);
    if (isNaN(val)) return; // Allow typing

    if (val < nockWtInput.min) {
      nockWtInput.value = nockWtInput.min;
    }
    if (val > nockWtInput.max) {
      nockWtInput.value = nockWtInput.max;
    }

    updateNockWtBorder();
  });

  nockWtInput.addEventListener('blur', () => {
    let val = parseFloat(nockWtInput.value);
    if (nockWtInput.value === '' || isNaN(val) || val < nockWtInput.min) {
      nockWtInput.value = nockWtInput.min;
    } else if (val > nockWtInput.max) {
      nockWtInput.value = nockWtInput.max;
    }
    nockWtInput.style.borderColor = ''; // Reset border
  });

  // Initial check on load (won't turn red if empty)
  updateNockWtBorder();
}

/*Glue  weight info icon*/
function showGlueWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Glue / Pin Weight (grains)</strong></p>
    <p>Weight of fletching glue, hot melt, or pin nock adhesive.</p>
    <hr>
    <p>Typical: 3–8 gr total.</p>
    <p>Minor contribution — included for maximum accuracy.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Glue / Pin Weight (min 0, max 15) */
const glueWtInput = document.getElementById('glueWt');

if (glueWtInput) {
  // Update border on every input change
  function updateGlueWtBorder() {
    let val = parseFloat(glueWtInput.value);
    // Skip red border if field is empty (allow typing)
    if (glueWtInput.value === '') {
      glueWtInput.style.borderColor = '';
      return;
    }
    // Red border if invalid
    if (isNaN(val) || val < glueWtInput.min || val > glueWtInput.max) {
      glueWtInput.style.borderColor = 'red';
    } else {
      glueWtInput.style.borderColor = '';
    }
  }

  glueWtInput.addEventListener('input', () => {
    let val = parseFloat(glueWtInput.value);
    if (isNaN(val)) return; // Allow typing

    if (val < glueWtInput.min) {
      glueWtInput.value = glueWtInput.min;
    }
    if (val > glueWtInput.max) {
      glueWtInput.value = glueWtInput.max;
    }

    updateGlueWtBorder();
  });

  glueWtInput.addEventListener('blur', () => {
    let val = parseFloat(glueWtInput.value);
    if (glueWtInput.value === '' || isNaN(val) || val < glueWtInput.min) {
      glueWtInput.value = glueWtInput.min;
    } else if (val > glueWtInput.max) {
      glueWtInput.value = glueWtInput.max;
    }
    glueWtInput.style.borderColor = ''; // Reset border
  });

  // Initial check on load (won't turn red if empty)
  updateGlueWtBorder();
}

function calculateEstimatedFPS() {
  const ibo = parseFloat($('ibo').value) || 340;
  const drawWt = parseFloat($('drawWt').value) || 70;
  const drawLen = parseFloat($('drawLen').value) || 29;
  const totalWt = parseFloat($('totalWt').value) || 495;
  const peepWt = parseFloat($('peepWt').value) || 8;
  const dloopWt = parseFloat($('dloopWt').value) || 8;
  const kisserWt = parseFloat($('kisserWt').value) || 0;
  const silencerWt = parseFloat($('silencerWt').value) || 12;
  const nockWt = parseFloat($('nockWt').value) || 10;
  const totalStringAddons = peepWt + dloopWt + kisserWt + silencerWt + nockWt;

  const refDrawWt = 70;
  const refDrawLen = 30;
  const refArrowWt = 350;
  const refStringFree = 20;

  let est = ibo;
  est += (drawWt - refDrawWt) * 1.8;
  est += (drawLen - refDrawLen) * 10;
  est -= Math.max(0, (totalWt - refArrowWt) / 5);
  est -= Math.max(0, (totalStringAddons - refStringFree) / 10);
  est *= 0.97;

  const estimated = Math.max(150, Math.round(est * 10) / 10);

  return {
    estimated: estimated,
    breakdown: {
      base: ibo,
      adjDrawWt: (drawWt - refDrawWt) * 1.8,
      adjDrawLen: (drawLen - refDrawLen) * 10,
      adjArrowWt: -Math.max(0, (totalWt - refArrowWt) / 5),
      adjString: -Math.max(0, (totalStringAddons - refStringFree) / 10),
      correction: est * -0.03
    }
  };
}

function showFpsMathPopup() {
  const content = $('fpsMathPopupContent');
  const currentFps = parseFloat($('fpsSlider').value);
  const hasManualFps = !isNaN(currentFps) && currentFps > 0;

  if (hasManualFps) {
    content.innerHTML = `
      <p><strong>Using your calculated estimated or chronographed speed:</strong> ${currentFps.toFixed(1)} FPS</p>
      <p style="margin-top:0.75rem;color:var(--light);">
        Manual entry overrides estimate — this is the most accurate!
      </p>
    `;
  } else {
    const est = calculateEstimatedFPS();
    content.innerHTML = `
      <p><strong>Calculated estimate:</strong> ${est.estimated.toFixed(1)} FPS</p>
      <p style="margin-top:0.75rem;color:var(--light);font-size:0.9rem;">
        No manual FPS entered — using estimate.
      </p>
    `;
  }
  $('fpsMathModal').style.display = 'flex';
}

function showLiveSettingsPopup() {
  const fps = parseFloat($('fpsSlider').value) || 278;
  const windMph = parseFloat($('windSlider').value) || 0;
  const rangeYd = parseFloat($('rangeSlider').value) || 50;

  $('gameMathContent').innerHTML = `
    <p><strong>Live Settings Math & Usage</strong></p>
    <p>These sliders let you test real-world conditions and see instant updates across the entire app — trajectory, wind drift, flight time, downrange energy, and more.</p>
    <hr>
    <p><strong>Your Current Settings:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Actual Speed: <strong>${fps.toFixed(1)} fps</strong></li>
      <li>Crosswind: <strong>${windMph.toFixed(1)} mph</strong></li>
      <li>Range: <strong>${rangeYd} yd</strong></li>
    </ul>
    <hr>
    <p><strong>What They Affect:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Actual Speed (FPS)</strong> — changes launch velocity. Higher = flatter trajectory, faster flight time, less drop & drift</li>
      <li><strong>Crosswind</strong> — adds sideways drift (full crosswind assumption). Use to test holdover needed</li>
      <li><strong>Range</strong> — target distance. Changes drop, height, flight time, wind drift, and impact energy/momentum</li>
    </ul>
    <hr>
    <p><strong>How to Use It:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Start with your real chronographed speed</li>
      <li>Slide wind up to test worst-case holdover</li>
      <li>Set range to your max ethical distance</li>
      <li>Watch how cards and summary update live</li>
    </ul>
    <p>Perfect for comparing builds under identical field conditions.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

function showEffectiveLoadPopup() {
  const drawWt = parseFloat($('drawWt').value) || 70;
  const arrowLen = parseFloat($('arrowLen').value) || 28.5;
  const pointWt = parseFloat($('pointWt').value) || 125;
  const totalWt = parseFloat($('totalWt').value) || 495;

  const lengthFactor = (arrowLen - 28) * 2.5;
  const pointFactor = (pointWt - 100) * 0.15;
  const weightFactor = (totalWt - 400) * 0.05;
  const effectiveLoad = Math.round(drawWt + lengthFactor + pointFactor + weightFactor);

  $('gameMathContent').innerHTML = `
    <p><strong>Effective Draw Weight Math & Usage</strong></p>
    <p>This estimates the total "load" the arrow shaft actually feels — starting from your bow's draw weight and adding adjustments for arrow length, point weight, and total arrow weight. It's used to recommend spine.</p>
    <hr>
    <p><strong>Raw Equation</strong></p>
    <div class="raw-equation">
        Effective Load = Draw Weight<br>
      + (Arrow Length − 28) × 2.5<br>
      + (Point Weight − 100) × 0.15<br>
      + (Total Arrow Weight − 400) × 0.05
    </div>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Draw Weight: <strong>${drawWt} lb</strong></li>
      <li>Arrow Length: <strong>${arrowLen.toFixed(2)} in</strong></li>
      <li>Point Weight: <strong>${pointWt} gr</strong></li>
      <li>Total Arrow Weight: <strong>${totalWt} gr</strong></li>
      <li>Effective Load: <strong>${effectiveLoad} lb</strong></li>
    </ul>
    <hr>
    <p><strong>Step-by-Step Calculation:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Base: <strong>${drawWt} lb</strong></li>
      <li>Length factor: (${arrowLen.toFixed(2)} − 28) × 2.5 = <strong>${lengthFactor.toFixed(2)}</strong></li>
      <li>Point factor: (${pointWt} − 100) × 0.15 = <strong>${pointFactor.toFixed(2)}</strong></li>
      <li>Weight factor: (${totalWt} − 400) × 0.05 = <strong>${weightFactor.toFixed(2)}</strong></li>
      <li>Effective Load = ${drawWt} + ${lengthFactor.toFixed(2)} + ${pointFactor.toFixed(2)} + ${weightFactor.toFixed(2)} = <strong>${effectiveLoad} lb</strong></li>
    </ul>
    <hr>
    <p>This "effective load" is then mapped to a recommended spine range — similar to modern Easton-style charts.</p>
    <hr>
    <p><strong>Influenced By:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Draw Weight</strong> — biggest factor</li>
      <li><strong>Arrow Length</strong> — longer = higher load</li>
      <li><strong>Point Weight</strong> — heavier = higher load</li>
      <li><strong>Total Arrow Weight</strong> — heavier = higher load</li>
    </ul>
    <p>A higher effective load requires a stiffer spine for optimal tuning.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

function showGameMathPopup() {
  const fps = parseFloat($('fpsSlider').value) || 278;
  const totalWt = parseFloat($('totalWt').value) || 495;
  const rangeYd = parseFloat($('rangeSlider').value) || 50;

  const k = 0.532;
  const retention = Math.exp(-(k * rangeYd) / totalWt);
  const velImpact = Math.round(fps * retention);
  const keImpact = Math.round(totalWt * velImpact * velImpact / 450240);
  const momImpact = parseFloat((totalWt * velImpact / 225400).toFixed(3));

  $('gameMathContent').innerHTML = `
    <p><strong>Game Effectiveness Math & Usage</strong></p>
    <p>Estimates downrange velocity, kinetic energy, and momentum — key indicators of terminal performance on game.</p>
    <hr>
    <p><strong>Raw Equations</strong></p>
    <div class="raw-equation">
      Retention = e^(-k × range / weight)<br>
      Impact Velocity = Launch FPS × Retention<br>
      KE (ft-lbs) = (weight × velocity²) / 450240<br>
      Momentum (slug·ft/s) = (weight × velocity) / 225400
    </div>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Launch Speed: <strong>${fps.toFixed(1)} fps</strong></li>
      <li>Arrow Weight: <strong>${totalWt} gr</strong></li>
      <li>Range: <strong>${rangeYd} yd</strong></li>
      <li>Impact Velocity: <strong>${velImpact} fps</strong></li>
      <li>Impact KE: <strong>${keImpact.toFixed(1)} ft-lbs</strong></li>
      <li>Impact Momentum: <strong>${momImpact.toFixed(3)} slug·ft/s</strong></li>
    </ul>
    <hr>
    <p><strong>Step-by-Step Calculation:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Retention = e^(-0.532 × ${rangeYd} / ${totalWt}) ≈ <strong>${retention.toFixed(3)}</strong> (${(retention * 100).toFixed(1)}%)</li>
      <li>Impact Velocity = ${fps.toFixed(1)} × ${retention.toFixed(3)} ≈ <strong>${velImpact} fps</strong></li>
      <li>KE = (${totalWt} × ${velImpact}²) / 450240 ≈ <strong>${keImpact.toFixed(1)} ft-lbs</strong></li>
      <li>Momentum = (${totalWt} × ${velImpact}) / 225400 ≈ <strong>${momImpact.toFixed(3)} slug·ft/s</strong></li>
    </ul>
    <hr>
    <p><strong>Where do the constants come from?</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>450240</strong> = 2 × gravity × grains per pound (converts grain·fps² to ft-lbs)</li>
      <li><strong>225400</strong> = 450240 / 2 (for momentum in slug·ft/s)</li>
      <li><strong>k = 0.532</strong> — calibrated from real-world hunting arrow data (350–500 gr, typical shafts/broadheads)</li>
    </ul>
    <hr>
    <p><strong>How to Use It (Hunting Guide):</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Small Game</strong>: ≥15 ft-lbs KE, ≥0.20 momentum</li>
      <li><strong>Deer</strong>: ≥25 ft-lbs KE, ≥0.30 momentum</li>
      <li><strong>Elk</strong>: ≥42 ft-lbs KE, ≥0.45 momentum</li>
      <li><strong>Moose</strong>: ≥65 ft-lbs KE, ≥0.60 momentum</li>
    </ul>
    <p>Heavier arrows retain energy better downrange. Faster arrows start higher but bleed off faster.</p>
    <hr>
    <p><strong>Influenced By:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Launch Speed (FPS)</strong> — biggest starting factor</li>
      <li><strong>Total Arrow Weight</strong> — heavier = better retention, more KE/momentum</li>
      <li><strong>Range</strong> — longer = more velocity loss</li>
      <li>Indirect: arrow diameter, broadhead design, fletching (affect drag)</li>
    </ul>
    <p>This is an approximation — real-world results vary with shot placement and animal size.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

function closeGameMath() {
  $('gameMathModal').style.display = 'none';
}

function recalculateAndShowMath() {
  const est = calculateEstimatedFPS();
  const b = est.breakdown;

  $('fpsSlider').value = est.estimated;
  $('fpsInput').value = est.estimated;

  const content = $('fpsMathPopupContent');
  content.innerHTML = `
    <p style="color:var(--success);font-weight:700;">✓ Speed updated to calculated estimate!</p>
    <p><strong>New FPS:</strong> ${est.estimated.toFixed(1)}</p>
    <p style="margin-top:0.75rem;"><strong>Breakdown:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Base IBO: ${b.base.toFixed(0)} FPS</li>
      <li>Draw weight: ${b.adjDrawWt > 0 ? '+' : ''}${b.adjDrawWt.toFixed(1)} FPS</li>
      <li>Draw length: ${b.adjDrawLen > 0 ? '+' : ''}${b.adjDrawLen.toFixed(1)} FPS</li>
      <li>Arrow weight: ${b.adjArrowWt.toFixed(1)} FPS</li>
      <li>String add-ons: ${b.adjString.toFixed(1)} FPS</li>
      <li>Real-world correction: ${b.correction.toFixed(1)} FPS</li>
    </ul>
    <p style="margin-top:0.75rem;color:var(--light);font-size:0.9rem;">
      Your previous value has been replaced with the current estimate.
    </p>
  `;

  $('fpsMathModal').style.display = 'flex';
}

function closeFpsMath() {
  $('fpsMathModal').style.display = 'none';
}

function showFocPopup() {
  const arrowLen = parseFloat($('arrowLen').value) || 28.5;
  const balancePt = parseFloat($('balancePt').value) || 17.2;
  const midPoint = arrowLen / 2;
  const foc = ((balancePt - midPoint) / arrowLen) * 100;

  const bowType = $('bowType')?.value || 'compound';
  const appType = $('appType')?.value || 'Hunting';

  let sweetMin = 12;
  let sweetMax = 18;
  let typeLabel = "Compound/Hunting";

  if (bowType === 'recurve' || bowType === 'longbow') {
    sweetMin = 15;
    sweetMax = 22;
    typeLabel = "Recurve/Longbow";
  } else if (appType === 'Target') {
    sweetMin = 10;
    sweetMax = 14;
    typeLabel = "Target";
  }

  const isSweet = foc >= sweetMin && foc <= sweetMax;

  $('gameMathContent').innerHTML = `
    <p><strong>FOC (Front of Center) Math & Usage</strong></p>
    <p>FOC measures how far the arrow’s balance point sits in front of the midpoint. Higher FOC generally improves broadhead stability and penetration; lower FOC produces flatter trajectories and is more forgiving to shoot.</p>
    <hr>
    <p><strong>Raw Equation</strong></p>
    <div class="raw-equation">      
      FOC = ((Balance Point − Midpoint) ÷ Arrow Length) × 100<br>
      Midpoint = Arrow Length ÷ 2
    </div>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Arrow Length: <strong>${arrowLen.toFixed(2)} in</strong></li>
      <li>Balance Point: <strong>${balancePt.toFixed(2)} in</strong></li>
      <li>Setup: <strong>${typeLabel}</strong></li>
      <li>FOC: <strong>${foc.toFixed(1)}%</strong></li>
    </ul>
    <hr>
    <p><strong>Step-by-Step Calculation:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Midpoint = ${arrowLen.toFixed(2)} ÷ 2 = <strong>${midPoint.toFixed(2)} in</strong></li>
      <li>FOC = ((${balancePt.toFixed(2)} − ${midPoint.toFixed(2)}) ÷ ${arrowLen.toFixed(2)}) × 100 = <strong>${foc.toFixed(1)}%</strong></li>
    </ul>
    <hr>
    <p><strong>Sweet Spot (highlighted in green):</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Compound/Hunting</strong>: 12–18% — good for broadheads & penetration</li>
      <li><strong>Target</strong>: 10–14% — flatter & more forgiving</li>
      <li><strong>Recurve/Longbow</strong>: 15–22% — stability with fingers & heavy arrows</li>
    </ul>
    <p style="margin-top:0.75rem;">
      ${isSweet ? '<strong style="color:var(--success);">Your FOC is in the ideal range for your setup!</strong>' : 
        foc < sweetMin ? '<strong style="color:var(--warning);">Low — flatter but less stable</strong>' : 
        '<strong style="color:var(--warning);">High — very stable but more drop</strong>'}
    </p>
    <hr>
    <p><strong>Influenced By:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Balance Point</strong> — biggest factor (move forward = higher FOC)</li>
      <li><strong>Arrow Length</strong> — longer = slightly lower FOC for same balance point</li>
      <li>Indirect: heavier point/insert/outsert moves balance point forward</li>
    </ul>
  `;
  $('gameMathModal').style.display = 'flex';
}

function showGppPopup() {
  const totalWt = parseFloat($('totalWt').value) || 495;
  const drawWt = parseFloat($('drawWt').value) || 70;
  const gpp = (totalWt / drawWt).toFixed(1);

  const bowType = $('bowType')?.value || 'compound';
  const appType = $('appType')?.value || 'Hunting';

  let sweetMin = 6.5;
  let sweetMax = 7.5;
  let typeLabel = "Compound/Hunting";

  if (bowType === 'recurve' || bowType === 'longbow') {
    sweetMin = 7.5;
    sweetMax = 9.5;
    typeLabel = "Recurve/Longbow";
  } else if (appType === 'Target') {
    sweetMin = 6.0;
    sweetMax = 8.0;
    typeLabel = "Target";
  }

  const isSweet = parseFloat(gpp) >= sweetMin && parseFloat(gpp) <= sweetMax;

  $('gameMathContent').innerHTML = `
    <p><strong>GPP (Grains Per Pound) Math & Usage</strong></p>
    <p>GPP is one of the simplest ways to express how heavy or light your arrow is relative to your bow’s draw weight.</p>
    <hr>
    <p><strong>Raw Equation</strong></p>
    <div class="raw-equation">
      GPP = Total Arrow Weight ÷ Draw Weight
    </div>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Total Arrow Weight: <strong>${totalWt} gr</strong></li>
      <li>Draw Weight: <strong>${drawWt} lb</strong></li>
      <li>Setup: <strong>${typeLabel}</strong></li>
      <li>GPP: <strong>${gpp}</strong></li>
    </ul>
    <hr>
    <p><strong>Step-by-Step Calculation:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>GPP = ${totalWt} ÷ ${drawWt} = <strong>${gpp}</strong></li>
    </ul>
    <hr>
    <p><strong>Sweet Spot (highlighted in green):</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Compound/Hunting</strong>: 6.5–7.5 — balanced speed + penetration</li>
      <li><strong>Target</strong>: 6.0–8.0 — lighter for speed & forgiveness</li>
      <li><strong>Recurve/Longbow</strong>: 7.5–9.5 — heavier for momentum & quietness</li>
    </ul>
    <p style="margin-top:0.75rem;">
      ${isSweet ? '<strong style="color:var(--success);">Your GPP is in the ideal range for your setup!</strong>' : 
        parseFloat(gpp) < sweetMin ? '<strong style="color:var(--warning);">Light — faster but less momentum</strong>' : 
        '<strong style="color:var(--warning);">Heavy — more penetration but slower</strong>'}
    </p>
    <hr>
    <p>GPP also influences velocity retention in this calculator:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Lighter arrows (low GPP) lose speed faster downrange.</li>
      <li>Heavier arrows (high GPP) hold their speed longer.</li>
    </ul>
    <hr>
    <p><strong>Influenced By:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Total Arrow Weight</strong> — biggest factor (heavier = higher GPP)</li>
      <li><strong>Draw Weight</strong> — higher draw weight = lower GPP for same arrow</li>
      <li>Indirect: point weight, inserts, fletching — all add to total weight</li>
    </ul>
  `;
  $('gameMathModal').style.display = 'flex';
}

function showGpiPopup() {
  const totalWt = parseFloat($('totalWt').value) || 495;
  const arrowLen = parseFloat($('arrowLen').value) || 28.5;
  const gpi = (totalWt / arrowLen).toFixed(1);

  const bowType = $('bowType')?.value || 'compound';
  const appType = $('appType')?.value || 'Hunting';

  let sweetMin = 7;
  let sweetMax = 9.5;
  let typeLabel = "Compound/Hunting";

  if (bowType === 'recurve' || bowType === 'longbow') {
    sweetMin = 9;
    sweetMax = 12;
    typeLabel = "Recurve/Longbow";
  } else if (appType === 'Target') {
    sweetMin = 6;
    sweetMax = 8.5;
    typeLabel = "Target";
  }

  const isSweet = parseFloat(gpi) >= sweetMin && parseFloat(gpi) <= sweetMax;

  $('gameMathContent').innerHTML = `
    <p><strong>GPI (Grains Per Inch) Math & Usage</strong></p>
    <p>GPI is the finished arrow weight per inch of shaft length — a measure of shaft density.</p>
    <hr>
    <p><strong>Raw Equation</strong></p>
    <div class="raw-equation">
        GPI = Total Arrow Weight ÷ Arrow Length
    </div>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Total Arrow Weight: <strong>${totalWt} gr</strong></li>
      <li>Arrow Length: <strong>${arrowLen.toFixed(1)} in</strong></li>
      <li>Setup: <strong>${typeLabel}</strong></li>
      <li>GPI: <strong>${gpi} gr/in</strong></li>
    </ul>
    <hr>
    <p><strong>Step-by-Step Calculation:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>GPI = ${totalWt} ÷ ${arrowLen.toFixed(1)} = <strong>${gpi} gr/in</strong></li>
    </ul>
    <hr>
    <p><strong>Sweet Spot (highlighted in green):</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Compound/Hunting</strong>: 7–9.5 — good balance of speed and momentum</li>
      <li><strong>Target</strong>: 6–8.5 — lighter for speed & forgiveness</li>
      <li><strong>Recurve/Longbow</strong>: 9–12 — heavier for momentum & quietness</li>
    </ul>
    <p style="margin-top:0.75rem;">
      ${isSweet ? '<strong style="color:var(--success);">Your GPI is in the ideal range for your setup!</strong>' : 
        parseFloat(gpi) < sweetMin ? '<strong style="color:var(--warning);">Light — faster but less momentum</strong>' : 
        '<strong style="color:var(--warning);">Heavy — more penetration but slower</strong>'}
    </p>
    <hr>
    <p>A lower GPI generally means a lighter, faster shaft. A higher GPI usually indicates a heavier, more robust shaft that boosts momentum and stability, especially for broadheads.</p>
    <hr>
    <p><strong>Influenced By:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Total Arrow Weight</strong> — biggest factor (heavier = higher GPI)</li>
      <li><strong>Arrow Length</strong> — longer = lower GPI for same weight</li>
      <li>Indirect: shaft material, wall thickness, diameter, point/insert weight</li>
    </ul>
    <p>GPI helps inform group stability, velocity retention, and downrange KE/momentum in this calculator.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Arrow Total Weight info icon*/
function showTotalWtPopup() {
  const totalWt = parseFloat($('totalWt').value) || 495;
  const bowType = $('bowType')?.value || 'compound';
  const appType = $('appType')?.value || 'Hunting';

  let sweetMin = 450;
  let sweetMax = 550;
  let typeLabel = "Compound/Hunting";

  if (bowType === 'recurve' || bowType === 'longbow') {
    sweetMin = 400;
    sweetMax = 600;
    typeLabel = "Recurve/Longbow";
  } else if (appType === 'Target') {
    sweetMin = 350;
    sweetMax = 450;
    typeLabel = "Target";
  }

  const isHeavy = totalWt > sweetMax;
  const isLight = totalWt < sweetMin;

  $('gameMathContent').innerHTML = `
    <p><strong>Total Arrow Weight (TW) Math & Usage</strong></p>
    <p>TW is your finished arrow weight in grains — shaft, components, and point all added together. This is the number that drives almost every other output in the app.</p>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Total Arrow Weight: <strong>${totalWt.toFixed(1)} gr</strong></li>
      <li>Setup: <strong>${typeLabel}</strong></li>
    </ul>
    <hr>
    <p><strong>Sweet Spot (highlighted in green):</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Compound/Hunting</strong>: 450–550 — balanced speed & penetration</li>
      <li><strong>Target</strong>: 350–450 — lighter for speed & forgiveness</li>
      <li><strong>Recurve/Longbow</strong>: 400–600 — heavier for momentum & quietness</li>
    </ul>
    <p style="margin-top:0.75rem;">
      ${isHeavy ? '<strong>Heavy — more penetration but slower</strong>' : 
        isLight ? '<strong>Light — faster but less momentum</strong>' : 
        '<strong>Your TW is in the ideal range!</strong>'}
    </p>
    <hr>
    <p>This same TW value is reused in:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>GPP (grains per pound)</li>
      <li>GPI (grains per inch)</li>
      <li>Launch KE and Impact KE</li>
      <li>Momentum and Game Effectiveness</li>
      <li>The Arrow Weight Composition bar</li>
    </ul>
    <hr>
    <p><strong>Influenced By:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>All arrow components (shaft, point, insert, fletching, wrap, glue)</li>
      <li>Use detailed components for maximum accuracy, or enter manually for quick estimate</li>
    </ul>
    <p>If this number is off, every downstream calculation will be off — so get TW as close as possible to your real, finished arrow.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

function showStiffnessPopup() {
  const drawWt = parseFloat($('drawWt').value) || 70;
  const arrowLen = parseFloat($('arrowLen').value) || 28.5;
  const pointWt = parseFloat($('pointWt').value) || 125;
  const totalWt = parseFloat($('totalWt').value) || 495;
  const actualSpine = parseFloat($('spine').value) || 300;

  const lengthFactor = (arrowLen - 28) * 2.5;
  const pointFactor = (pointWt - 100) * 0.15;
  const weightFactor = (totalWt - 400) * 0.05;
  const effectiveLoad = Math.round(drawWt + lengthFactor + pointFactor + weightFactor);
  const recommendedCenter = Math.max(200, Math.min(500, 600 - effectiveLoad * 5));
  const spineDiff = actualSpine - recommendedCenter;

  let status = 'Good';
  if (spineDiff > 100) status = 'Weakest';
  else if (spineDiff < -100) status = 'Stiffest';
  else if (spineDiff > 60) status = 'Weaker';
  else if (spineDiff < -60) status = 'Stiffer';

  const bowType = $('bowType')?.value || 'compound';
  const appType = $('appType')?.value || 'Hunting';

  let typeLabel = "Compound/Hunting";
  if (bowType === 'recurve' || bowType === 'longbow') typeLabel = "Recurve/Longbow";
  else if (appType === 'Target') typeLabel = "Target";

  const isWeak = spineDiff > 0;
  const isStiff = spineDiff < 0;

  $('gameMathContent').innerHTML = `
    <p><strong>Stiffness / Forgiveness Math & Usage</strong></p>
    <p>This compares your actual arrow spine to a recommended range based on draw weight, arrow length, point weight, and total arrow weight — inspired by modern tuning charts.</p>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Draw Weight: <strong>${drawWt} lb</strong></li>
      <li>Arrow Length: <strong>${arrowLen.toFixed(1)} in</strong></li>
      <li>Point Weight: <strong>${pointWt} gr</strong></li>
      <li>Total Arrow Weight: <strong>${totalWt} gr</strong></li>
      <li>Actual Spine: <strong>${actualSpine}</strong></li>
      <li>Setup: <strong>${typeLabel}</strong></li>
      <li>Status: <strong>${status}</strong></li>
    </ul>
    <hr>
    <p><strong>Raw Equation</strong></p>
    <div class="raw-equation">
        Recommended Spine Center = 600 − (Effective Load × 5)<br>
      Effective Load = Draw Weight + (Arrow Length−28)×2.5 + (Point Weight−100)×0.15 + (Total Weight−400)×0.05
    </div>
    <hr>
    <p><strong>Where does the "600" come from?</strong></p>
    <p>The 600 is an empirical constant chosen to map a “standard” hunting setup to a common spine recommendation.</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>A typical 60 lb draw weight, 28" arrow, 100 gr point, ~400 gr total weight gives an effective load ≈ 60 lb.</li>
      <li>600 − (60 × 5) = 300 spine — which is exactly the spine most manufacturers recommend for that setup.</li>
    </ul>
    <p>This constant aligns the calculator with real-world Easton-style spine charts across a wide range of modern compound bow setups. It’s not derived from physics, but from practical tuning experience.</p>
    <hr>
    <p><strong>Step-by-Step Calculation:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Effective load = ${drawWt} + (${arrowLen.toFixed(1)}−28)×2.5 + (${pointWt}−100)×0.15 + (${totalWt}−400)×0.05 = <strong>${effectiveLoad} lb</strong></li>
      <li>Recommended spine center = 600 − (${effectiveLoad} × 5) = <strong>${recommendedCenter}</strong></li>
      <li>Difference = ${actualSpine} − ${recommendedCenter} = <strong>${spineDiff}</strong></li>
      <li>Result: <strong>${status}</strong></li>
    </ul>
    <hr>
    <p><strong>Sweet Spot (highlighted in green):</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Compound/Hunting</strong>: ±60 spine — balanced forgiveness & accuracy</li>
      <li><strong>Target</strong>: ±40 spine — tighter for precision</li>
      <li><strong>Recurve/Longbow</strong>: ±80 spine — wider tolerance for finger release</li>
    </ul>
    <p style="margin-top:0.75rem;">
      ${status === 'Good' ? '<strong style="color:var(--success);">Your spine is in the ideal range!</strong>' :
        isWeak ? '<strong style="color:var(--warning);">Weak — risk of paradox, tuning issues</strong>' :
        '<strong style="color:var(--warning);">Stiff — less forgiving on release errors</strong>'}
    </p>
    <hr>
    <p><strong>How to Adjust:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Too Weak</strong>: Shorten arrow, reduce point weight, or choose stiffer spine</li>
      <li><strong>Too Stiff</strong>: Lengthen arrow, increase point weight, or choose weaker spine</li>
    </ul>
    <p>This is a fast sanity check — always verify with paper tuning and broadhead flight.</p>
    <hr>
    <p><strong>Influenced By:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Draw Weight</strong> — higher = needs stiffer spine</li>
      <li><strong>Arrow Length</strong> — longer = needs stiffer spine</li>
      <li><strong>Point Weight</strong> — heavier = needs stiffer spine</li>
      <li><strong>Total Arrow Weight</strong> — heavier = needs stiffer spine</li>
    </ul>
  `;
  $('gameMathModal').style.display = 'flex';
}

function showFlatnessPopup() {
  const fps = parseFloat($('fpsSlider').value) || 278;
  const arcHeightFt = parseFloat($('flatnessValue').textContent) || 0;

  $('gameMathContent').innerHTML = `
    <p><strong>Flatness (20→60 yd) Math & Usage</strong></p>
    <p>Measures how much extra drop occurs between 20 yd and 60 yd — lower = flatter trajectory.</p>
    <hr>
    <p><strong>Raw Equation</strong></p>
    <div class="raw-equation">
      Extra Drop (ft) = [0.5 × g × (t₆₀² − t₂₀²)] / 12<br>
      where t = distance (ft) / fps, g = 32.174 ft/s²
    </div>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Actual Speed: <strong>${fps.toFixed(1)} fps</strong></li>
      <li>Extra Drop (20→60 yd): <strong>${arcHeightFt.toFixed(1)} ft</strong></li>
    </ul>
    <hr>
    <p><strong>Step-by-Step Calculation:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Time to 60 yd = 180 / ${fps.toFixed(1)} ≈ ${(180/fps).toFixed(3)} sec</li>
      <li>Time to 20 yd = 60 / ${fps.toFixed(1)} ≈ ${(60/fps).toFixed(3)} sec</li>
      <li>Extra drop = 0.5 × 32.174 × [(${ (180/fps).toFixed(3) })² − (${ (60/fps).toFixed(3) })²] × 12 / 12 = <strong>${arcHeightFt.toFixed(1)} ft</strong></li>
    </ul>
    <hr>
    <p><strong>How to Use It (Hunting Guide):</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Under 3 ft = very flat — easy ranging</li>
      <li>3–4.5 ft = good hunting trajectory</li>
      <li>Over 4.5 ft = more drop — limit range or use slider</li>
    </ul>
    <hr>
    <p><strong>Influenced By:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Actual Speed (FPS)</strong> — biggest factor (faster = flatter)</li>
      <li>Indirect: anything that affects FPS (bow power, arrow weight)</li>
    </ul>
  `;
  $('gameMathModal').style.display = 'flex';
}

function showGroupStabilityPopup() {
  const fps = parseFloat($('fpsSlider').value) || 278;
  const foc = parseFloat($('focValue').textContent) || 0;
  const gpi = parseFloat($('gpiValue').textContent) || 0;

  const fpsGood = fps >= 270;
  const focGood = foc >= 12 && foc <= 18;
  const gpiGood = gpi <= 9.5;

  const goodCount = (fpsGood ? 1 : 0) + (focGood ? 1 : 0) + (gpiGood ? 1 : 0);

  $('gameMathContent').innerHTML = `
    <p><strong>Group Stability (Target / 3D) Math & Usage</strong></p>
    <p>This rates how optimized your setup is for tight groups for multiple arrows in target/training shooting based on three key factors known to affect in-flight stability and forgiveness.</p>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Actual Speed: <strong>${fps.toFixed(1)} fps</strong> ${fpsGood ? '✓' : '✗'} (≥270 = good)</li>
      <li>FOC: <strong>${foc.toFixed(1)}%</strong> ${focGood ? '✓' : '✗'} (12–18% = good)</li>
      <li>GPI: <strong>${gpi.toFixed(1)} gr/in</strong> ${gpiGood ? '✓' : '✗'} (≤9.5 = good)</li>
      <li><strong>Score: ${goodCount}/3</strong></li>
    </ul>
    <hr>
    <p><strong>Raw Logic</strong></p>
    <div class="raw-equation">
      Score = (FPS ≥ 270 ? 1 : 0) + (FOC 12–18% ? 1 : 0) + (GPI ≤ 9.5 ? 1 : 0)
    </div>
    <hr>
    <p><strong>Step-by-Step Scoring:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>FPS ≥ 270: ${fpsGood ? 'Yes' : 'No'} → ${fpsGood ? '+1' : '+0'}</li>
      <li>FOC 12–18%: ${focGood ? 'Yes' : 'No'} → ${focGood ? '+1' : '+0'}</li>
      <li>GPI ≤ 9.5: ${gpiGood ? 'Yes' : 'No'} → ${gpiGood ? '+1' : '+0'}</li>
      <li>Total: <strong>${goodCount}/3</strong></li>
    </ul>
    <hr>
    <p><strong>Interpretation:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>3 of 3</strong> = Excellent — tight groups likely with good tuning</li>
      <li><strong>2 of 3</strong> = Very good — small tweaks help</li>
      <li><strong>1 of 3</strong> = Average — more forgiveness trade-offs</li>
      <li><strong>0 of 3</strong> = Challenging — expect larger groups until optimized</li>
    </ul>
    <p>Execution and tuning always matter most — this is just a starting point based on proven target/3D principles.</p>
    <hr>
    <p><strong>Influenced By:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Actual Speed (FPS)</strong> — faster = more stable flight</li>
      <li><strong>FOC</strong> — 12–18% = optimal aerodynamic stability</li>
      <li><strong>GPI</strong> — lighter shafts (≤9.5) = better recovery & forgiveness</li>
    </ul>
  `;
  $('gameMathModal').style.display = 'flex';
}

function showSightPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Sight Pin Zeros</strong></p>
    <p>Many bow sights use fixed pins (20/30/40/50/60 yd) or a single adjustable pin/slider.</p>
    <hr>
    <p>Change "Base Zero" to simulate:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Moving your sight housing up/down</li>
      <li>Dialing a slider for longer range</li>
      <li>Changing your 20 yd zero to 30 yd zero</li>
    </ul>
    <p>Pins are spaced 10 yd apart (common for hunting sights).</p>
    <p>This helps you visualize how your arrow drop aligns with your actual pin gaps.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

function showMaxHeightPopup() {
  const fps = parseFloat($('fpsSlider').value) || 278;
  const rangeYd = parseFloat($('rangeSlider').value) || 50;

  // Recalculate for popup
  const approxThetaDeg = 3;
  const approxThetaRad = approxThetaDeg * Math.PI / 180;
  const v0y = fps * Math.sin(approxThetaRad);
  const v0x = fps * Math.cos(approxThetaRad);
  const timeToRange = (rangeYd * 3) / v0x;
  const timeToPeak = v0y / 32.174;
  const actualTime = Math.min(timeToRange, timeToPeak);
  const maxHeightFt = Math.max(0, v0y * actualTime - 0.5 * 32.174 * actualTime * actualTime);
  const maxHeightIn = (maxHeightFt * 12).toFixed(1);

  const maxHeightDistYd = Math.round(v0x * actualTime / 3);

  $('gameMathContent').innerHTML = `
    <p><strong>Max Height at Range Math & Usage</strong></p>
    <p>Highest point the arrow reaches above the line of sight between launch and your current range.</p>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Actual Speed: <strong>${fps.toFixed(1)} fps</strong></li>
      <li>Current Range: <strong>${rangeYd} yd</strong></li>
      <li>Max Height at Range: <strong>${maxHeightFt.toFixed(1)} ft / ${maxHeightIn} in</strong></li>
      <li>Occurs at: <strong>${maxHeightDistYd} yd</strong></li>
    </ul>
    <hr>
    <p><strong>Raw Equation</strong></p>
    <div class="raw-equation">
      Height (ft) = v₀y × t − 0.5 × g × t²<br>
      where:<br>
      • v₀y = fps × sin(3°) (upward velocity)<br>
      • t = min(time to range, time to peak)<br>
      • g = 32.174 ft/s²
    </div>
    <hr>
    <p><strong>Step-by-Step Calculation (with your values):</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Upward velocity = ${fps.toFixed(1)} × sin(3°) ≈ <strong>${v0y.toFixed(1)} ft/s</strong></li>
      <li>Horizontal velocity ≈ ${v0x.toFixed(1)} ft/s</li>
      <li>Time to ${rangeYd} yd = (${rangeYd} × 3) / ${v0x.toFixed(1)} ≈ <strong>${timeToRange.toFixed(3)} sec</strong></li>
      <li>Time to absolute peak = ${v0y.toFixed(1)} / 32.174 ≈ <strong>${timeToPeak.toFixed(3)} sec</strong></li>
      <li>Actual time used = min(${timeToRange.toFixed(3)}, ${timeToPeak.toFixed(3)}) = <strong>${actualTime.toFixed(3)} sec</strong></li>
      <li>Max height = ${v0y.toFixed(1)} × ${actualTime.toFixed(3)} − 0.5 × 32.174 × (${actualTime.toFixed(3)})² = <strong>${maxHeightFt.toFixed(1)} ft</strong></li>
    </ul>
    <hr>
    <p><strong>How to Use It:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Pin gaps & holdover: higher = more curved trajectory</li>
      <li>Obstacle clearance at your shot distance</li>
      <li>Compare builds: lower height = flatter trajectory</li>
    </ul>
    <hr>
    <p><strong>Influenced By:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Actual Speed (FPS)</strong> — biggest factor (faster = lower height at same range)</li>
      <li><strong>Current Range</strong> — longer range = higher max height (until ~40–45 yd absolute peak)</li>
      <li>Indirect: anything that affects FPS (bow power, arrow weight, string add-ons)</li>
    </ul>
    <p>Note: Uses fixed ~3° launch angle for typical 20 yd zero. Real trajectory may vary slightly with sight setup.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

function showDropPopup() {
  const fps = parseFloat($('fpsSlider').value) || 278;
  const rangeYd = parseFloat($('rangeSlider').value) || 50;

  // Recalculate drop (same as card)
  const dropAtDistance = (distYd) => {
    const distFt = distYd * 3;
    const time = distFt / fps;
    return 0.5 * 32.174 * time * time * 12; // inches total gravity drop
  };

  const dropInTarget = dropAtDistance(rangeYd);
  const drop20 = dropAtDistance(20);
  const relativeDropInTarget = dropInTarget - drop20;
  const dropFtTarget = (relativeDropInTarget / 12).toFixed(1);
  const dropInTargetRounded = relativeDropInTarget.toFixed(1);

  // For step-by-step
  const timeToRange = (rangeYd * 3) / fps;
  const timeTo20 = (20 * 3) / fps;
  const totalDropTarget = dropInTarget.toFixed(1);
  const totalDrop20 = drop20.toFixed(1);

  $('gameMathContent').innerHTML = `
    <p><strong>Downrange Drop Math & Usage</strong></p>
    <p>How far the arrow impacts below your line of sight at the selected range (with a 20 yd zero).</p>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Actual Speed: <strong>${fps.toFixed(1)} fps</strong></li>
      <li>Current Range: <strong>${rangeYd} yd</strong></li>
      <li>Downrange Drop: <strong>${dropFtTarget} ft / ${dropInTargetRounded} in</strong></li>
    </ul>
    <hr>
    <p><strong>Raw Equation</strong></p>
    <div class="raw-equation">
      Drop (in) = [0.5 × g × t² × 12] at range − [0.5 × g × t² × 12] at 20 yd<br>
      where:<br>
      • g = 32.174 ft/s²<br>
      • t = distance in feet / fps<br>
      • × 12 = convert feet to inches
    </div>
    <hr>
    <p><strong>Step-by-Step Calculation (with your values):</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Time to ${rangeYd} yd = (${rangeYd} × 3) / ${fps.toFixed(1)} = <strong>${timeToRange.toFixed(3)} sec</strong></li>
      <li>Total drop at ${rangeYd} yd = 0.5 × 32.174 × (${timeToRange.toFixed(3)})² × 12 = <strong>${totalDropTarget} in</strong></li>
      <li>Time to 20 yd = (20 × 3) / ${fps.toFixed(1)} = <strong>${timeTo20.toFixed(3)} sec</strong></li>
      <li>Total drop at 20 yd = 0.5 × 32.174 × (${timeTo20.toFixed(3)})² × 12 = <strong>${totalDrop20} in</strong></li>
      <li>Relative drop = ${totalDropTarget} − ${totalDrop20} = <strong>${dropInTargetRounded} in</strong></li>
      <li>= <strong>${dropFtTarget} ft</strong></li>
    </ul>
    <hr>
    <p><strong>How to Use It (Hunting Guide):</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Aim this high with your last pin for holdover</li>
      <li>Under 12 in at 50 yd = very flat — easy ranging</li>
      <li>12–24 in = manageable with practice</li>
      <li>Over 36 in = significant drop — limit range or use slider/dial</li>
    </ul>
    <p>Faster arrow + lighter weight = less drop = flatter trajectory.</p>
    <hr>
    <p><strong>Influenced By:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Actual Speed (FPS)</strong> — biggest factor (faster = less drop)</li>
      <li><strong>Current Range</strong> — drop increases with distance squared</li>
      <li>Indirect: anything that affects FPS (bow power, arrow weight, string add-ons)</li>
    </ul>
  `;
  $('gameMathModal').style.display = 'flex';
}

function showFlightTimePopup() {
  // Grab live user values
  const fps = parseFloat($('fpsSlider').value) || 278;
  const totalWt = parseFloat($('totalWt').value) || 495;
  const rangeYd = parseFloat($('rangeSlider').value) || 50;

  // Calculate flight time (same as card)
  const timeTarget = (rangeYd * 3) / fps;

  $('gameMathContent').innerHTML = `
    <p><strong>Flight Time Math & Usage</strong></p>
    <p>Time from release to impact — the animal's "reaction window".</p>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Actual Speed: <strong>${fps.toFixed(1)} fps</strong></li>
      <li>Total Arrow Weight: <strong>${totalWt} gr</strong></li>
      <li>Current Range: <strong>${rangeYd} yd</strong></li>
      <li>Flight Time: <strong>${timeTarget.toFixed(3)} sec</strong></li>
    </ul>
    <hr>
    <p><strong>Raw Equation</strong></p>
    <div class="raw-equation">
      Time (sec) = (Range in yards × 3) / Arrow Speed in fps<br>
      (small upward launch angle ignored for horizontal approximation)
    </div>
    <hr>
    <p><strong>Step-by-Step Calculation (with your values):</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Horizontal distance = ${rangeYd} yd × 3 = <strong>${(rangeYd * 3)} ft</strong></li>
      <li>Horizontal velocity ≈ <strong>${fps.toFixed(1)} fps</strong> (upward angle ~3° ignored)</li>
      <li>Flight time = ${ (rangeYd * 3) } / ${fps.toFixed(1)} = <strong>${timeTarget.toFixed(3)} sec</strong></li>
    </ul>
    <hr>
    <p><strong>How to Use It (Hunting Guide):</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Under 0.2 sec</strong>: Very fast — animal struggles to react ("string jump" rare)</li>
      <li><strong>0.2–0.3 sec</strong>: Average — most hunting setups. Good with calm animals.</li>
      <li><strong>Over 0.3 sec</strong>: Slower — higher risk of jump, especially alert game.</li>
    </ul>
    <p>Your ${timeTarget.toFixed(3)} sec at ${rangeYd} yd is solid for a heavy hunting arrow — great balance of quietness and penetration.</p>
    <hr>
    <p><strong>Influenced By:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Actual Speed (FPS)</strong> — biggest factor (faster = shorter time)</li>
      <li><strong>Current Range</strong> — longer = more time in flight</li>
      <li>Indirect: anything that affects FPS (bow power, arrow weight, string add-ons)</li>
    </ul>
    <p>Heavier arrows are slightly slower but quieter — small trade-off for better penetration.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

function showWindDriftPopup() {
  const fps = parseFloat($('fpsSlider').value) || 278;
  const totalWt = parseFloat($('totalWt').value) || 495;
  const rangeYd = parseFloat($('rangeSlider').value) || 50;
  const windMphValue = parseFloat($('windSlider').value) || 0;
  const arrowDia = $('arrowDia')?.value || 'micro';

  // Read the card's drift value (matches exactly)
  const driftIn = $('windDriftIn').textContent || '0.0';

  // Simple linear TOF for popup explanation (matches card)
  const tof = (rangeYd * 3) / fps;
  const windFps = windMphValue * 1.467;
  const baseDriftFt = windFps * tof * 0.9;

  const diaLabel = {
    'standard': 'Standard (~6.5mm)',
    'small': 'Small (~5mm)',
    'micro': 'Micro (~4mm)'
  }[arrowDia] || 'Micro (~4mm)';

  $('gameMathContent').innerHTML = `
    <p><strong>Wind Drift Math & Usage</strong></p>
    <p>Estimated sideways drift in a full crosswind at current range. Arrows lag behind wind due to inertia and fletching.</p>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Actual Speed: <strong>${fps.toFixed(1)} fps</strong></li>
      <li>Total Arrow Weight: <strong>${totalWt} gr</strong></li>
      <li>Arrow Diameter: <strong>${diaLabel}</strong></li>
      <li>Current Range: <strong>${rangeYd} yd</strong></li>
      <li>Crosswind: <strong>${windMphValue.toFixed(1)} mph</strong></li>
      <li>Wind Drift: <strong>${driftIn} in</strong></li>
    </ul>
    <hr>
    <p><strong>Raw Equation</strong></p>
    <div class="raw-equation">
      <ul style="margin-left:1.25rem;">
        <li><strong>Drift (in)</strong> = (V_wind × t_flight × 0.9) × D_factor × 12</li>
        <li><strong>V_wind</strong> = crosswind speed in feet per second (mph × 1.467)</li>
        <li><strong>t_flight</strong> = flight time to target in seconds ≈ (range in yards × 3) / arrow speed in fps</li>
        <li><strong>0.9</strong> = arrow lag factor (arrows don’t fully move with the wind — typically ~90% of full drift)</li>
        <li><strong>D_factor</strong> = diameter adjustment (1.0 for standard, 0.92 for small, 0.85 for micro)</li>
        <li><strong>× 12</strong> = convert feet of drift to inches</li>
      </ul>
    </div>
    <hr>
    <p><strong>Step-by-Step Calculation:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Flight time = ${rangeYd} × 3 / ${fps.toFixed(1)} = <strong>${tof.toFixed(3)} sec</strong></li>
      <li>Wind speed = ${windMphValue.toFixed(1)} × 1.467 = <strong>${windFps.toFixed(1)} fps</strong></li>
      <li>Base drift = Wind speed × Flight time × arrow lag factor</li>
      <li>Base drift = ${windFps.toFixed(1)} × ${tof.toFixed(3)} × 0.9 = <strong>${baseDriftFt.toFixed(2)} ft</strong></li>
      <li>Diameter factor = <strong>0.92</strong></li>
      <li>Final drift = Base drift × Diameter factor × ft to in conversion</li>
      <li>Final drift = ${baseDriftFt.toFixed(2)} × 0.92 × 12 = <strong>${driftIn} in</strong></li>
    </ul>
    <hr>
    <p><strong>How to Use It (Hunting Guide):</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Aim this far <strong>into the wind</strong> to compensate</li>
      <li>Under 6 in at 50 yd = excellent wind performance</li>
      <li>6–12 in = manageable with practice</li>
      <li>Over 12 in = significant holdover needed</li>
    </ul>
    <p>Smaller diameter + faster arrow = least drift. Micro-diameter arrows shine in wind.</p>
    <hr>
    <p><strong>Influenced By:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Crosswind Speed</strong> — biggest factor (linear impact)</li>
      <li><strong>Range</strong> — longer range = more time in wind = more drift</li>
      <li><strong>Actual Speed (FPS)</strong> — faster arrow = less flight time = less drift</li>
      <li><strong>Arrow Diameter</strong> — smaller = less surface area = less drift</li>
      <li>Indirect: anything that affects FPS (bow power, arrow weight)</li>
    </ul>
  `;
  $('gameMathModal').style.display = 'flex';
}

function calculateEverything() {
  // Parse all inputs first
  const drawWt = parseFloat($('drawWt').value) || 0;
  const totalWt = parseFloat($('totalWt').value) || 0;
  const windMph = parseFloat($('windSlider').value) || 0;
  const rangeYd = parseFloat($('rangeSlider').value) || 0;
  const arrowLen = parseFloat($('arrowLen').value) || 0;
  const balancePt = parseFloat($('balancePt').value) || 0;
  // For the Total Weight
  const pointWt = parseFloat($('pointWt').value) || 0;

  // === Auto-calculate String Add-ons from details ===
  const peepWt = parseFloat($('peepWt').value) || 0;
  const dloopWt = parseFloat($('dloopWt').value) || 0;
  const kisserWt = parseFloat($('kisserWt').value) || 0;
  const silencerWt = parseFloat($('silencerWt').value) || 0;


  const calculatedTotal = peepWt + dloopWt + kisserWt + silencerWt;

  // Declare stringWtInput first
  const stringWtInput = $('stringWt');

  // Update the display total
  const totalEl = $('stringAddonsTotal');
  if (totalEl) totalEl.textContent = calculatedTotal.toFixed(1);

  // Only auto-update main field if user hasn't manually edited it
  if (stringWtInput) {
    const manualEdited = stringWtInput.dataset.manual === 'true';
    if (!manualEdited) {
      stringWtInput.value = calculatedTotal.toFixed(1);
      stringWtInput.dataset.manual = 'false'; // reset flag
    }
  }

  // === Auto-calculate Arrow Components Total ===
  const useArrowDetails = $('useArrowDetails')?.checked ?? true;

  const bareShaftWt = parseFloat($('bareShaftWt').value) || 0;
  const insertWt = parseFloat($('insertWt').value) || 0;
  const wrapWt = parseFloat($('wrapWt').value) || 0;
  const vaneWtEach = parseFloat($('vaneWt').value) || 0;
  const vaneCount = parseFloat($('vaneCount').value) || 0;
  const glueWt = parseFloat($('glueWt').value) || 0;
  const nockWt = parseFloat($('nockWt').value) || 0;

  const calculatedArrowTotal = bareShaftWt + insertWt + wrapWt + (vaneWtEach * vaneCount) + glueWt + pointWt + nockWt;

  // Always update display total
  const arrowTotalEl = $('arrowComponentsTotal');
  if (arrowTotalEl) arrowTotalEl.textContent = calculatedArrowTotal.toFixed(1);

  // Only auto-update main field if useArrowDetails is checked and not manually edited
  const totalWtInput = $('totalWt');
  if (totalWtInput && useArrowDetails) {
    const manualEdited = totalWtInput.dataset.manual === 'true';
    if (!manualEdited) {
      totalWtInput.value = calculatedArrowTotal.toFixed(1);
      totalWtInput.dataset.manual = 'false';
    }
  }

  // FPS Slider
  let userFps = parseFloat($('fpsSlider').value);
  if (isNaN(userFps) || userFps <= 0) {
    const est = calculateEstimatedFPS();
    userFps = est.estimated;
  }
  const fps = userFps;

  // Sync number inputs
  $('windInput').value = windMph;
  $('rangeInput').value = rangeYd;
  $('fpsInput').value = fps;

  // Update game distance
  $('gameDist').textContent = rangeYd;

    // === FOC Progress Bar (SAFE) ===
  const midPoint = arrowLen / 2;
  const foc = ((balancePt - midPoint) / arrowLen) * 100;
  const focClamped = Math.max(0, Math.min(30, foc));

  const focMarker = $('focMarker');
  const focValue = $('focValue');
  if (focMarker) focMarker.style.left = (focClamped / 30 * 100) + '%';
  if (focValue) {
    focValue.style.left = (focClamped / 30 * 100) + '%';
    focValue.textContent = foc.toFixed(1) + '%';
  }

  // === Dynamic FOC Sweet Spot ===
  const focBowType = $('bowType')?.value || 'compound';
  const focAppType = $('appType')?.value || 'Hunting';

  let focSweetLeft = 40;   // default compound/hunting: 12% FOC
  let focSweetWidth = 20;  // 6% range (12–18%)

  if (focBowType === 'recurve' || focBowType === 'longbow') {
    focSweetLeft = 50;     // 15% FOC
    focSweetWidth = 23.33; // ~7% range (15–22%)
  } else if (focAppType === 'Target') {
    focSweetLeft = 33.33;  // 10% FOC
    focSweetWidth = 13.33; // 4% range (10–14%)
  }

  const focSweetSpot = document.querySelector('.foc-sweet-spot');
  if (focSweetSpot) {
    focSweetSpot.style.left = focSweetLeft + '%';
    focSweetSpot.style.width = focSweetWidth + '%';
  }

  const focLowZone = document.querySelector('.foc-low-zone');
  const focHighZone = document.querySelector('.foc-high-zone');
  if (focLowZone) focLowZone.style.width = focSweetLeft + '%';
  if (focHighZone) {
    focHighZone.style.left = (focSweetLeft + focSweetWidth) + '%';
    focHighZone.style.width = (100 - focSweetLeft - focSweetWidth) + '%';
  }

  // === GPP (SAFE) ===
  const gpp = totalWt / drawWt;
  const gppPercent = Math.max(0, Math.min(100, (gpp - 5) / 5 * 100));

  const gppMarker = $('gppMarker');
  const gppValue = $('gppValue');
  if (gppMarker) gppMarker.style.left = `${gppPercent}%`;
  if (gppValue) {
    gppValue.style.left = `${gppPercent}%`;
    gppValue.textContent = gpp.toFixed(1) + ' gr';
  }

    // === Dynamic GPP Sweet Spot ===
  const currentBowType = $('bowType')?.value || 'compound';
  const currentAppType = $('appType')?.value || 'Hunting';

  let gppSweetLeft = 30;   // default compound/hunting: 6.5 GPP
  let gppSweetWidth = 20;  // 1 unit range (6.5–7.5) = 20% of 5–10 bar

  if (currentBowType === 'recurve' || currentBowType === 'longbow') {
    gppSweetLeft = 50;     // 7.5 GPP (higher for traditional)
    gppSweetWidth = 25;    // wider range ~7–9+ (traditional arrows are heavier)
  } else if (currentAppType === 'Target') {
    gppSweetLeft = 20;     // 6.0 GPP (lighter for target)
    gppSweetWidth = 20;    // 6.0–8.0 range
  }

  const gppSweetSpot = document.querySelector('.gpp-sweet-spot');
  if (gppSweetSpot) {
    gppSweetSpot.style.left = gppSweetLeft + '%';
    gppSweetSpot.style.width = gppSweetWidth + '%';
  }

  const gppLowZone = document.querySelector('.gpp-low-zone');
  const gppHighZone = document.querySelector('.gpp-high-zone');
  if (gppLowZone) gppLowZone.style.width = gppSweetLeft + '%';
  if (gppHighZone) {
    gppHighZone.style.left = (gppSweetLeft + gppSweetWidth) + '%';
    gppHighZone.style.width = (100 - gppSweetLeft - gppSweetWidth) + '%';
  }

  // === GPI (SAFE) ===
  const gpi = totalWt / arrowLen;
  const gpiPercent = (gpi / 20) * 100;

  const gpiMarker = $('gpiMarker');
  const gpiValue = $('gpiValue');
  if (gpiMarker) gpiMarker.style.left = `${gpiPercent}%`;
  if (gpiValue) {
    gpiValue.style.left = `${gpiPercent}%`;
    gpiValue.textContent = gpi.toFixed(1) + ' gr/in';
  }

  // === Dynamic GPI Sweet Spot ===
  const bowTypeForGPI = $('bowType')?.value || 'compound';  // ← unique name
  const appType = $('appType')?.value || 'Hunting';

  let gpiSweetLeft = 35;
  let gpiSweetWidth = 12.5;

  if (bowTypeForGPI === 'recurve' || bowTypeForGPI === 'longbow') {
    gpiSweetLeft = 45;
    gpiSweetWidth = 15;
  } else if (appType === 'Target') {
    gpiSweetLeft = 30;
    gpiSweetWidth = 12.5;
  }

  const gpiSweetSpot = document.querySelector('.gpi-sweet-spot');
  if (gpiSweetSpot) {
    gpiSweetSpot.style.left = gpiSweetLeft + '%';
    gpiSweetSpot.style.width = gpiSweetWidth + '%';
  }

  const gpiLowZone = document.querySelector('.gpi-low-zone');
  const gpiHighZone = document.querySelector('.gpi-high-zone');
  if (gpiLowZone) gpiLowZone.style.width = gpiSweetLeft + '%';
  if (gpiHighZone) {
    gpiHighZone.style.left = (gpiSweetLeft + gpiSweetWidth) + '%';
    gpiHighZone.style.width = (100 - gpiSweetLeft - gpiSweetWidth) + '%';
  }

  // === Total Wt (SAFE) ===
  const totalWtPercent = ((totalWt - 50) / 950) * 100;

  const totalWtMarker = $('totalWtMarker');
  const totalWtValue = $('totalWtValue');
  if (totalWtMarker) totalWtMarker.style.left = `${totalWtPercent}%`;
  if (totalWtValue) {
    totalWtValue.style.left = `${totalWtPercent}%`;
    totalWtValue.textContent = Math.round(totalWt) + ' gr';
  }

  // === Dynamic Total Arrow Weight Sweet Spot ===
  const twBowType = $('bowType')?.value || 'compound';
  const twAppType = $('appType')?.value || 'Hunting';

  let twSweetLeft = 42;   // default compound/hunting: 450 gr
  let twSweetWidth = 10.5; // 100 gr range

  if (twBowType === 'recurve' || twBowType === 'longbow') {
    twSweetLeft = 37;     // 400 gr
    twSweetWidth = 21;    // 200 gr range (400–600)
  } else if (twAppType === 'Target') {
    twSweetLeft = 31.6;   // 350 gr
    twSweetWidth = 10.5;  // 100 gr range (350–450)
  }

  const twSweetSpot = document.querySelector('.totalwt-sweet-spot');
  if (twSweetSpot) {
    twSweetSpot.style.left = twSweetLeft + '%';
    twSweetSpot.style.width = twSweetWidth + '%';
  }

  const twLowZone = document.querySelector('.totalwt-low-zone');
  const twHighZone = document.querySelector('.totalwt-high-zone');
  if (twLowZone) twLowZone.style.width = twSweetLeft + '%';
  if (twHighZone) {
    twHighZone.style.left = (twSweetLeft + twSweetWidth) + '%';
    twHighZone.style.width = (100 - twSweetLeft - twSweetWidth) + '%';
  }
  
  // === Game Effectiveness (100% SAFE) ===
  const k = 0.532;
  const retention = Math.exp(- (k * rangeYd) / totalWt);
  const velImpact = Math.round(fps * retention);
  const keImpact = Math.round(totalWt * velImpact * velImpact / 450240);
  const momImpact = parseFloat((totalWt * velImpact / 225400).toFixed(3));
  const classes = [
    {id: 'small', keMin: 15, momMin: 0.20},
    {id: 'deer', keMin: 25, momMin: 0.30},
    {id: 'elk', keMin: 42, momMin: 0.45},
    {id: 'moose', keMin: 65, momMin: 0.60}
  ];
  classes.forEach(c => {
    const keOk = keImpact >= c.keMin;
    const momOk = momImpact >= c.momMin;
    const bothOk = keOk && momOk;

    const keEl = $(`${c.id}KE`);
    const momEl = $(`${c.id}Mom`);
    const resCell = $(`${c.id}Res`);

    if (keEl) keEl.textContent = `${keImpact.toFixed(1)} ${keOk ? '(✓)' : '(×)'}`;
    if (momEl) momEl.textContent = `${momImpact.toFixed(3)} ${momOk ? '(✓)' : '(×)'}`;
    if (resCell) {
      if (bothOk) {
        resCell.textContent = 'Send it';
        resCell.className = 'send';
      } else if (keOk || momOk) {
        resCell.textContent = 'Marginal';
        resCell.className = 'marginal';
      } else {
        resCell.textContent = 'Adjust';
        resCell.className = 'adjust';
      }
    }
  });
  
  // === Stiffness / Forgiveness ===
  const actualSpine = parseFloat($('spine').value) || 300;
  const baseLoad = drawWt;
  const lengthFactor = (arrowLen - 28) * 2.5;
  const pointFactor = (pointWt - 100) * 0.15;
  const weightFactor = (totalWt - 400) * 0.05;
  const effectiveLoad = Math.round(baseLoad + lengthFactor + pointFactor + weightFactor);
  const recommendedCenter = Math.max(200, Math.min(500, 600 - effectiveLoad * 5));
  const spineDiff = actualSpine - recommendedCenter;

  let stiffnessPercent = 50 + spineDiff / 2;

  if (spineDiff > 100) {
    stiffnessPercent = 75 + (spineDiff - 100);
  } else if (spineDiff < -100) {
    stiffnessPercent = 25 + (spineDiff + 100);
  }

  stiffnessPercent = Math.max(0, Math.min(100, stiffnessPercent));

    // === Dynamic Stiffness Sweet Spot ===
  const stiffBowType = $('bowType')?.value || 'compound';
  const stiffAppType = $('appType')?.value || 'Hunting';

  let stiffSweetLeft = 25; // default compound/hunting: 25–75%
  let stiffSweetWidth = 50;

  if (stiffBowType === 'recurve' || stiffBowType === 'longbow') {
    stiffSweetLeft = 20; // slightly wider for traditional
    stiffSweetWidth = 60;
  } else if (stiffAppType === 'Target') {
    stiffSweetLeft = 30; // target likes a bit stiffer
    stiffSweetWidth = 40;
  }

  const stiffSweetSpot = document.querySelector('.stiffness-sweet-spot');
  if (stiffSweetSpot) {
    stiffSweetSpot.style.left = stiffSweetLeft + '%';
    stiffSweetSpot.style.width = stiffSweetWidth + '%';
  }

  const stiffLowZone = document.querySelector('.stiffness-low-zone');
  const stiffHighZone = document.querySelector('.stiffness-high-zone');
  if (stiffLowZone) stiffLowZone.style.width = stiffSweetLeft + '%';
  if (stiffHighZone) {
    stiffHighZone.style.left = (stiffSweetLeft + stiffSweetWidth) + '%';
    stiffHighZone.style.width = (100 - stiffSweetLeft - stiffSweetWidth) + '%';
  }
  

  // === Effective Draw Weight bars (100% SAFE) ===
  const maxLoad = 120;
  const inputDwPercent = (drawWt / maxLoad) * 100;
  const effectivePercent = (effectiveLoad / maxLoad) * 100;

  const inputDwFill = $('inputDwFill');
  const inputDwMarker = $('inputDwMarker');
  const inputDwValue = $('inputDwValue');
  const effectiveLoadFill = $('effectiveLoadFill');
  const effectiveLoadMarker = $('effectiveLoadMarker');
  const effectiveLoadValue = $('effectiveLoadValue');

  if (inputDwFill) inputDwFill.style.width = `${inputDwPercent}%`;
  if (inputDwMarker) inputDwMarker.style.left = `${inputDwPercent}%`;
  if (inputDwValue) {
    inputDwValue.style.left = `${inputDwPercent}%`;
    inputDwValue.textContent = drawWt + ' lb';
  }
  if (effectiveLoadFill) effectiveLoadFill.style.width = `${effectivePercent}%`;
  if (effectiveLoadMarker) effectiveLoadMarker.style.left = `${effectivePercent}%`;
  if (effectiveLoadValue) {
    effectiveLoadValue.style.left = `${effectivePercent}%`;
    effectiveLoadValue.textContent = effectiveLoad + ' lb';
  }

  // Show spine + status
  let status = 'Good';
  if (spineDiff > 100) status = 'Weakest';
  else if (spineDiff < -100) status = 'Stiffest';
  else if (spineDiff > 60) status = 'Weaker)';
  else if (spineDiff < -60) status = 'Stiffer)';

  // Stiffness (SAFE)
  const stiffnessValue = $('stiffnessValue');
  const stiffnessMarker = $('stiffnessMarker');

  if (stiffnessValue) {
    stiffnessValue.textContent = actualSpine + ' (' + status + ')';
    stiffnessValue.style.left = `${stiffnessPercent}%`;
  }
  if (stiffnessMarker) stiffnessMarker.style.left = `${stiffnessPercent}%`;

  // === Flatness Score (20→60 yd) ===
  const g = 32.174;
  const t20 = 20 * 3 / fps;
  const t60 = 60 * 3 / fps;
  const drop20 = 0.5 * g * t20 * t20 * 12;
  const drop60 = 0.5 * g * t60 * t60 * 12;
  const extraDropInches = drop60 - drop20;
  const arcHeightFt = extraDropInches / 12;

  // Marker logic FIRST (right = flatter = better)
  let flatnessPercent = 0;
  if (arcHeightFt < 3) {
    flatnessPercent = 100;
  } else if (arcHeightFt <= 4.5) {
    flatnessPercent = 66.67 + ((arcHeightFt - 3) / 1.5) * 33.33;
  } else {
    flatnessPercent = Math.max(0, 66.67 - ((arcHeightFt - 4.5) / 3) * 66.67);
  }

  // Flatness (SAFE)
  const flatnessValue = $('flatnessValue');
  const flatnessMarker = $('flatnessMarker');

  if (flatnessValue) {
    flatnessValue.textContent = arcHeightFt.toFixed(1) + ' ft';
    flatnessValue.style.left = `${flatnessPercent}%`;
  }
  if (flatnessMarker) flatnessMarker.style.left = `${flatnessPercent}%`;

  // === Dynamic Group Stability Criteria ===
  const groupBowType = $('bowType')?.value || 'compound';  // ← unique name
  const groupAppType = $('appType')?.value || 'Hunting';

  let fpsThreshold = 270;
  let focMin = 12;
  let focMax = 18;
  let gpiThreshold = 9.5;

  if (groupBowType === 'recurve' || groupBowType === 'longbow') {
    fpsThreshold = 220;
    focMin = 15;
    focMax = 22;
    gpiThreshold = 12;
  } else if (groupAppType === 'Target') {
    fpsThreshold = 280;
    gpiThreshold = 8.5;
  }

  const fpsGood = fps >= fpsThreshold;
  const focGood = foc >= focMin && foc <= focMax;
  const gpiGood = gpi <= gpiThreshold;
  const goodCount = (fpsGood ? 1 : 0) + (focGood ? 1 : 0) + (gpiGood ? 1 : 0);
  const groupPercent = (goodCount / 3) * 100;

  // DELETE DEBUG
  console.log('goodCount:', goodCount, 'percent:', groupPercent);

    // Group Stability (SAFE)
  const groupStabilityValue = $('groupStabilityValue');
  const groupStabilityMarker = $('groupStabilityMarker');

  if (groupStabilityValue) groupStabilityValue.textContent = `${goodCount}/3`;
  if (groupStabilityMarker) groupStabilityMarker.style.left = `${groupPercent}%`;

  // === Custom Sight Pin Zeros ===
  const pinCountSelect = $('pinCount');
  const pinCount = pinCountSelect ? Number(pinCountSelect.value) : 3;
  const pinInputsContainer = $('pinInputs');
  if (pinInputsContainer) {
    pinInputsContainer.innerHTML = '';
    if (pinCount > 0) {
      for (let i = 1; i <= pinCount; i++) {
        const defaultZero = i === 1 ? 20 : (i === 2 ? 30 : (i === 3 ? 40 : (i === 4 ? 50 : 60)));
        const pinId = `pin${i}Zero`;
        pinInputsContainer.innerHTML += `
          <div class="input-row">
            <label for="${pinId}">Pin ${i} Zero (yd)</label>
            <input type="number" id="${pinId}" value="${defaultZero}" min="10" max="100" step="5">
          </div>
        `;
      }
    } else {
      pinInputsContainer.innerHTML = '<p style="font-size:0.9rem; color:var(--light); margin:0;">Instinctive shooting — no pins configured.</p>';
    }
  }

  // === Max Height at Range (up to current range slider) ===
  const rangeTarget = rangeYd || 50;

  // Approximate launch angle for 20 yd zero (~3°)
  const approxThetaDeg = 3;
  const approxThetaRad = approxThetaDeg * Math.PI / 180;
  const v0y = fps * Math.sin(approxThetaRad);
  const v0x = fps * Math.cos(approxThetaRad);

  // Time to reach current range
  const timeToRange = (rangeTarget * 3) / v0x;

  // Find max height between 0 and current range
  const timeToPeak = v0y / 32.174; // time to absolute peak
  const actualTime = Math.min(timeToRange, timeToPeak);
  const maxHeightAtRangeFt = Math.max(0, v0y * actualTime - 0.5 * 32.174 * actualTime * actualTime);

  const maxHeightIn = (maxHeightAtRangeFt * 12).toFixed(1);
  const maxHeightFtRounded = maxHeightAtRangeFt.toFixed(1);

  // Distance where max height occurs (within range)
  const maxHeightDistYd = Math.round(v0x * actualTime / 3);

  // Update the card elements
  $('maxHeightFt').textContent = maxHeightFtRounded;
  $('maxHeightIn').textContent = maxHeightIn;
  $('maxHeightDistanceYd').textContent = maxHeightDistYd;
  $('maxHeightRangeYd').textContent = rangeTarget;

  // Downrange drop function (for target range)
  const dropAtDistance = (distYd) => {
    const distFt = distYd * 3;
    const time = distFt / fps;
    return 0.5 * 32.174 * time * time * 12; // inches total gravity drop
  };

  // Downrange Drop at target range
  const dropInTarget = dropAtDistance(rangeTarget);
  const relativeDropInTarget = dropInTarget - dropAtDistance(20);
  const dropFtTarget = (relativeDropInTarget / 12).toFixed(1);
  const dropInTargetRounded = relativeDropInTarget.toFixed(1);
  const dropFtEl = $('dropFt');
  const dropInEl = $('dropIn');
  const dropDistanceYdEl = $('dropDistanceYd');
  if (dropFtEl) dropFtEl.textContent = dropFtTarget;
  if (dropInEl) dropInEl.textContent = dropInTargetRounded;
  if (dropDistanceYdEl) dropDistanceYdEl.textContent = rangeTarget;

  // Flight Time to target
  const timeTarget = (rangeTarget * 3) / fps;
  const flightTimeSecEl = $('flightTimeSec');
  const flightDistanceYdEl = $('flightDistanceYd');
  if (flightTimeSecEl) flightTimeSecEl.textContent = timeTarget.toFixed(3);
  if (flightDistanceYdEl) flightDistanceYdEl.textContent = rangeTarget;

  // === Wind Drift (Realistic for Arrows) ===
  const windMphValue = windMph || 0;
  if (windMphValue > 0 && rangeTarget > 0) {
    const tof = timeTarget; // your TOF is fine

    const windFps = windMphValue * 1.467;

    // Lag factor (higher = less drift; arrows stabilize with fletching)
    let lagFactor = 0.45; // default: ~55% less drift than particle
    const pointType = $('pointType')?.value || 'Fixed Blade';
    if (pointType === 'Mechanical') lagFactor = 0.50; // closed blades = less drag = less drift
    else if (pointType === 'Fixed Blade') lagFactor = 0.40; // exposed blades = more drag = more drift
    else if (pointType === 'Field') lagFactor = 0.55; // minimal drag = least drift

    // Diameter factor (smaller = less drag)
    const diaFactor = {
      'micro': 0.85,
      'small': 0.92,
      'standard': 1.0
    }[$('arrowDia')?.value] || 0.85;

    // In-Flight Diameter override (if entered)
    const inFlightDia = parseFloat($('inFlightDia').value) || 0;
    let finalDiaFactor = diaFactor;
    if (inFlightDia > 0) finalDiaFactor = Math.min(1.5, inFlightDia / 0.3);

    // Base drift (feet)
    let driftFt = windFps * tof * lagFactor * finalDiaFactor;

    // Wind angle (default 90° crosswind)
    const windAngle = 90;
    driftFt *= Math.sin(windAngle * Math.PI / 180);

    const driftIn = (driftFt * 12).toFixed(1);
    $('windDriftIn').textContent = driftIn;
    $('windDriftDistanceYd').textContent = rangeTarget;
    $('windDriftMph').textContent = windMphValue.toFixed(1);
  } else {
    $('windDriftIn').textContent = '0.0';
  }

  // === Update Build Summary Table ===
  const table = $('summaryTable').querySelector('tbody');
  table.innerHTML = ''; // clear

  const addRow = (label, value) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td style="font-weight:600; padding:0.5rem 0;">${label}</td>
      <td style="padding:0.5rem 0;">${value || '-'}</td>
    `;
    table.appendChild(row);
  };

  // === 1. Build & Bow ===
  addRow('Build Name', $('buildName').value || 'Unnamed');
  addRow('Application', $('appType').value);
  addRow('Bow Model', $('bowModel').value || '-');
  addRow('Bow Type', $('bowType').value || '-');
  addRow('IBO Speed', $('ibo').value ? $('ibo').value + ' fps' : '-');
  addRow('Draw Weight', drawWt + ' lb');
  addRow('Draw Length', $('drawLen').value ? $('drawLen').value + ' in' : '-');
  addRow('Let-off', $('letOff').value ? $('letOff').value + '%' : '-');
  addRow('Brace Height', $('braceHeight').value ? $('braceHeight').value + ' in' : '-');
  addRow('Cam System', $('camType').value || '-');
  addRow('String Add-ons', $('stringWt').value + ' gr');

  // === 2. Sight Pins ===
  const bowType = $('bowType')?.value || 'compound';
  const pinCountSummary = Number($('pinCount').value || '3');
  if (bowType === 'recurve' || bowType === 'longbow') {
    addRow('Sight Pins', 'None / Instinctive (Traditional Bow)');
  } else if (pinCountSummary === 0) {
    addRow('Sight Pins', 'None (Slider or Custom)');
  } else {
    for (let i = 1; i <= Math.min(pinCountSummary, 5); i++) {
      const pinZeroEl = $(`pin${i}Zero`);
      if (pinZeroEl) {
        addRow(`Pin ${i} Zero`, pinZeroEl.value + ' yd');
      }
    }
  }

  // === 3. Arrow Specs ===
  addRow('Arrow Name', $('arrowName').value || '-');
  addRow('Spine', actualSpine);
  addRow('Arrow Diameter', {
    'standard': 'Standard (~6.5mm)',
    'small': 'Small (~5mm)',
    'micro': 'Micro (~4mm)'
  }[$('arrowDia').value] || 'Micro (~4mm)');
  addRow('Arrow Length', arrowLen + ' in');
  addRow('Total Arrow Weight', totalWt + ' gr');
  addRow('Point Weight', pointWt + ' gr');
  addRow('Balance Point', balancePt + ' in');

  // === Detailed Arrow Components (only if toggled on) ===
  if (useArrowDetails) {
    addRow('Bare Shaft Weight', $('bareShaftWt').value + ' gr');
    addRow('Insert Weight', $('insertWt').value + ' gr');
    addRow('Point Type', $('pointType').value || 'Fixed Blade');
    addRow('In-Flight Diameter', ($('inFlightDia').value || '—') + ' in');
    addRow('Wrap Weight', $('wrapWt').value + ' gr');
    addRow('Vane Weight', $('vaneWt').value + ' gr (' + $('vaneCount').value + ' × ' + $('vaneHeight').value + '" ' + $('vaneHelical').value + ')');
    addRow('Glue Weight', $('glueWt').value + ' gr');
    addRow('Nock Weight', $('nockWt').value + ' gr');  // if you have this
    // Add any other components you have
  }

  // === 4. Live Settings ===
  addRow('Actual Speed', fps.toFixed(1) + ' fps');
  addRow('Crosswind', windMph.toFixed(1) + ' mph');
  addRow('Range', rangeYd + ' yd');


  // === 5. Game Effectiveness at Current Range ===
  addRow('Impact Velocity', velImpact + ' fps');
  addRow('Impact KE', keImpact.toFixed(1) + ' ft-lbs');
  addRow('Impact Momentum', momImpact.toFixed(3) + ' slug·ft/s');

  // === 6. Core Calculated Stats ===
  addRow('FOC', foc.toFixed(1) + '%');
  addRow('GPP', gpp.toFixed(1));
  addRow('GPI', gpi.toFixed(1) + ' gr/in');
  addRow('Effective Draw Weight', effectiveLoad + ' lb');
  addRow('Stiffness', actualSpine + ' (' + status + ')');
  addRow('Flatness (20→60 yd)', arcHeightFt.toFixed(1) + ' ft arc');
  addRow('Group Stability', `${goodCount}/3 conditions met`);

  // === 7. Trajectory at Current Range ===
  addRow('Max Height at Range', maxHeightFtRounded + ' ft at ' + maxHeightDistYd + ' yd');
  addRow('Flight Time', timeTarget.toFixed(3) + ' sec');
  addRow('Downrange Drop', dropFtTarget + ' ft / ' + dropInTargetRounded + ' in');
  addRow('Wind Drift', $('windDriftIn').textContent + ' in');

  // === Notes (only if they exist, at the very bottom) ===
  const notes = $('buildNotes')?.value.trim();
  if (notes) {
    // Separator line for visual separation
    addRow('────────────────────', '────────────────────');
    
    // Notes row — preserve line breaks as bullets, wrap nicely
    addRow('Notes', notes.replace(/\n/g, ' • '));
  }

}

// Move this outside calculateEverything()
$('copyCsvBtn').addEventListener('click', () => {
  let csv = 'Label,Value\n';
  const rows = $('summaryTable').querySelectorAll('tr');
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length === 2) {
      const label = cells[0].textContent.trim();
      const value = cells[1].textContent.trim();
      csv += `"${label}","${value}"\n`;
    }
  });
  navigator.clipboard.writeText(csv).then(() => {
    alert('Build summary copied to clipboard as CSV!');
  });
});

function closeFpsMath() {
  $('fpsMathModal').style.display = 'none';
}

function closeModal() {
  $('aiModal').style.display = 'none';
}

function sendAi() {
  const msg = $('aiIn').value.trim();
  if (!msg) return;
  $('chatHist').innerHTML += `<p><strong>You:</strong> ${msg}</p>`;
  $('chatHist').innerHTML += `<p style="color:var(--purple);"><strong>AI:</strong> Got it! Example response...</p>`;
  $('aiIn').value = '';
  $('chatHist').scrollTop = $('chatHist').scrollHeight;
}

// Suggest Build Name
document.querySelector('.secondary').addEventListener('click', () => {
  const today = new Date();
  const dateStr = today.toISOString().slice(0, 10);
  const appType = $('appType').value.trim() || 'Hunting';
  const arrowWeight = $('totalWt').value.trim() || '???';
  const bowModel = $('bowModel').value.trim() || 'Bow';
  const drawWt = $('drawWt').value || '??';
  const templates = [
    `${dateStr} ${appType} ${bowModel} ${drawWt}# ${arrowWeight}gr`,
    `${dateStr} ${bowModel} ${drawWt}lb ${appType} ${arrowWeight}gr`,
    `${dateStr} ${appType} Build ${arrowWeight}gr`,
    `${dateStr} ${bowModel} ${appType} Setup`
  ];
  const best = templates.find(t => !t.includes('??') && !t.includes('???')) || templates[0];
  $('buildName').value = best.trim();
});

// Save / Load / Delete Builds
function updateLoadDropdown() {
  const select = $('loadBuild');
  const builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  select.innerHTML = '<option>– Load Build –</option>';
  builds.sort((a, b) => b.date.localeCompare(a.date)).forEach(build => {
    const opt = document.createElement('option');
    opt.value = build.name;
    opt.textContent = `${build.date} – ${build.name}`;
    select.appendChild(opt);
  });
}

// Preloaded Sample Profiles (prefixed with SAMPLE)
const sampleProfiles = [
  {
    name: "SAMPLE Adam Greentree — Elk Heavy",
    date: "2025-01-01",
    appType: "Hunting",
    bowModel: "Hoyt RX-9",
    bowType: "compound",
    letOff: "85",
    braceHeight: "6.125",
    camType: "hybrid",
    ibo: "340",
    drawWt: "78",
    drawLen: "28.5",
    stringWt: "25",
    pinCount: "1",
    pin1Zero: "30",
    arrowName: "Sirius Apollo or Rampage",
    spine: "200",
    arrowDia: "standard",
    arrowLen: "28",
    totalWt: "650",
    pointWt: "250",
    balancePt: "20",
    fpsSlider: "265",
    windSlider: "0",
    rangeSlider: "50",
    useStringDetails: false,
    useArrowDetails: false
  },
  {
    name: "SAMPLE Cameron Hanes Heavy Hunter",
    date: "2025-01-01",
    appType: "Hunting",
    bowModel: "Hoyt RX-9 Ultra",
    bowType: "compound",
    letOff: "85",
    braceHeight: "6.375",
    camType: "hybrid",
    ibo: "340",
    drawWt: "80",
    drawLen: "27",
    stringWt: "20",
    pinCount: "3",
    pin1Zero: "20",
    pin2Zero: "30",
    pin3Zero: "50",
    arrowName: "Easton FMJ",
    spine: "300",
    arrowDia: "standard",
    arrowLen: "27.5",
    totalWt: "500",
    pointWt: "125",
    balancePt: "18",
    fpsSlider: "290",
    windSlider: "0",
    rangeSlider: "50",
    useStringDetails: false,
    useArrowDetails: false
  },
  {
    name: "SAMPLE Ella Gibson — World #1 Compound",
    date: "2025-01-01",
    appType: "Target",
    bowModel: "Hoyt Invicta",
    bowType: "compound",
    letOff: "80",
    braceHeight: "7",
    camType: "hybrid",
    ibo: "345",
    drawWt: "55",
    drawLen: "26.5",
    stringWt: "10",
    pinCount: "5",
    pin1Zero: "20",
    pin2Zero: "30",
    pin3Zero: "40",
    pin4Zero: "50",
    pin5Zero: "60",
    arrowName: "Easton X10",
    spine: "400",
    arrowDia: "micro",
    arrowLen: "27",
    totalWt: "380",
    pointWt: "120",
    balancePt: "16",
    fpsSlider: "310",
    windSlider: "0",
    rangeSlider: "50",
    useStringDetails: false,
    useArrowDetails: false
  },
  {
    name: "SAMPLE James Yates Backcountry",
    date: "2025-01-01",
    appType: "Hunting",
    bowModel: "Hoyt RX-9",
    bowType: "compound",
    letOff: "85",
    braceHeight: "6.125",
    camType: "hybrid",
    ibo: "340",
    drawWt: "70",
    drawLen: "28",
    stringWt: "20",
    pinCount: "3",
    pin1Zero: "20",
    pin2Zero: "30",
    pin3Zero: "50",
    arrowName: "Easton Axis",
    spine: "250",
    arrowDia: "small",
    arrowLen: "28",
    totalWt: "480",
    pointWt: "125",
    balancePt: "17",
    fpsSlider: "285",
    windSlider: "0",
    rangeSlider: "50",
    useStringDetails: false,
    useArrowDetails: false
  },
  {
    name: "SAMPLE John Dudley Nock On Pro",
    date: "2025-01-01",
    appType: "Hunting",
    bowModel: "PSE Nock On Unite",
    bowType: "compound",
    letOff: "85",
    braceHeight: "7",
    camType: "hybrid",
    ibo: "340",
    drawWt: "70",
    drawLen: "29",
    stringWt: "15",
    pinCount: "3",
    pin1Zero: "20",
    pin2Zero: "30",
    pin3Zero: "40",
    arrowName: "Easton Axis",
    spine: "300",
    arrowDia: "small",
    arrowLen: "28",
    totalWt: "450",
    pointWt: "125",
    balancePt: "17",
    fpsSlider: "295",
    windSlider: "0",
    rangeSlider: "50",
    useStringDetails: false,
    useArrowDetails: false
  },
  {
    name: "SAMPLE Josh Bowmar Beast Mode",
    date: "2025-01-01",
    appType: "Hunting",
    bowModel: "PSE Evo NXT",
    bowType: "compound",
    letOff: "80",
    braceHeight: "6.5",
    camType: "hybrid",
    ibo: "342",
    drawWt: "90",
    drawLen: "29",
    stringWt: "20",
    pinCount: "3",
    pin1Zero: "20",
    pin2Zero: "30",
    pin3Zero: "50",
    arrowName: "Victory VAP TKO",
    spine: "200",
    arrowDia: "micro",
    arrowLen: "29",
    totalWt: "520",
    pointWt: "200",
    balancePt: "18.5",
    fpsSlider: "280",
    windSlider: "0",
    rangeSlider: "50",
    useStringDetails: false,
    useArrowDetails: false
  },
  {
    name: "SAMPLE Levi Morgan Champion",
    date: "2025-01-01",
    appType: "Target",
    bowModel: "Mathews TRX",
    bowType: "compound",
    letOff: "80",
    braceHeight: "7",
    camType: "hybrid",
    ibo: "350",
    drawWt: "60",
    drawLen: "27.5",
    stringWt: "10",
    pinCount: "1",
    pin1Zero: "20",
    arrowName: "Altra Centrum",
    spine: "300",
    arrowDia: "micro",
    arrowLen: "27",
    totalWt: "420",
    pointWt: "100",
    balancePt: "16",
    fpsSlider: "310",
    windSlider: "0",
    rangeSlider: "50",
    useStringDetails: false,
    useArrowDetails: false
  },
  {
    name: "SAMPLE Paige Pearce — Pro Hunter",
    date: "2025-01-01",
    appType: "Hunting",
    bowModel: "Hoyt RX-9",
    bowType: "compound",
    letOff: "85",
    braceHeight: "6.125",
    camType: "hybrid",
    ibo: "340",
    drawWt: "60",
    drawLen: "27",
    stringWt: "15",
    pinCount: "3",
    pin1Zero: "20",
    pin2Zero: "30",
    pin3Zero: "50",
    arrowName: "Easton Axis",
    spine: "340",
    arrowDia: "small",
    arrowLen: "27",
    totalWt: "450",
    pointWt: "125",
    balancePt: "17",
    fpsSlider: "290",
    windSlider: "0",
    rangeSlider: "50",
    useStringDetails: false,
    useArrowDetails: false
  },
  {
    name: "SAMPLE Tim Gillingham Gold Tip Pro",
    date: "2025-01-01",
    appType: "Target",
    bowModel: "Bowtech Reckoning",
    bowType: "compound",
    letOff: "80",
    braceHeight: "7",
    camType: "hybrid",
    ibo: "340",
    drawWt: "65",
    drawLen: "28",
    stringWt: "15",
    pinCount: "5",
    pin1Zero: "20",
    pin2Zero: "30",
    pin3Zero: "40",
    pin4Zero: "50",
    pin5Zero: "60",
    arrowName: "Gold Tip Triple X",
    spine: "250",
    arrowDia: "small",
    arrowLen: "28",
    totalWt: "460",
    pointWt: "140",
    balancePt: "17",
    fpsSlider: "295",
    windSlider: "0",
    rangeSlider: "50",
    useStringDetails: false,
    useArrowDetails: false
  }
];

// Load samples on first run
if (!localStorage.getItem('arrowForgeSamplesLoaded')) {
  let builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  sampleProfiles.forEach(sample => {
    if (!builds.some(b => b.name === sample.name)) {
      builds.push(sample);
    }
  });
  localStorage.setItem('arrowForgeBuilds', JSON.stringify(builds));
  localStorage.setItem('arrowForgeSamplesLoaded', 'true');
}

function updateLoadDropdown() {
  const select = $('loadBuild');
  const builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  select.innerHTML = '<option>– Load Build –</option>';
  builds
    .sort((a, b) => {
      const dateA = a.date || '0000-00-00';
      const dateB = b.date || '0000-00-00';
      return dateB.localeCompare(dateA); // newest first
    })
    .forEach(build => {
      const opt = document.createElement('option');
      opt.value = build.name;
      opt.textContent = `${build.date ? build.date + ' – ' : ''}${build.name}`;
      select.appendChild(opt);
    });
}

function saveBuild() {
  const buildName = $('buildName').value.trim();
  if (!buildName) {
    alert('Please enter a Build Name first');
    return;
  }
  const buildData = {
    name: buildName,
    date: new Date().toISOString().slice(0,10),
    appType: $('appType').value,
    bowModel: $('bowModel').value,
    bowType: $('bowType').value,
    ibo: $('ibo').value,
    braceHeight: $('braceHeight').value,
    camType: $('camType').value,
    drawWt: $('drawWt').value,
    drawLen: $('drawLen').value,
    letOff: $('letOff').value,
    stringWt: $('stringWt').value,
    peepWt: $('peepWt').value,
    dloopWt: $('dloopWt').value,
    kisserWt: $('kisserWt').value,
    silencerWt: $('silencerWt').value,
    pinCount: $('pinCount').value,
    pin1Zero: $('pin1Zero')?.value || '20',
    pin2Zero: $('pin2Zero')?.value || '30',
    pin3Zero: $('pin3Zero')?.value || '40',
    pin4Zero: $('pin4Zero')?.value || '50',
    pin5Zero: $('pin5Zero')?.value || '60',
    arrowName: $('arrowName').value,
    spine: $('spine').value,
    arrowDia: $('arrowDia').value,
    arrowLen: $('arrowLen').value,
    totalWt: $('totalWt').value,
    pointWt: $('pointWt').value,
    balancePt: $('balancePt').value,
    bareShaftWt: $('bareShaftWt').value || '0',
    insertWt: $('insertWt').value,
    pointType: $('pointType').value || 'Fixed Blade',
    inFlightDia: $('inFlightDia').value || '',
    wrapWt: $('wrapWt').value,
    vaneWt: $('vaneWt').value,
    vaneHeight: $('vaneHeight').value,
    vaneCount: $('vaneCount').value,
    vaneHelical: $('vaneHelical').value,
    nockWt: $('nockWt').value,
    glueWt: $('glueWt').value,
    buildNotes: $('buildNotes') ? $('buildNotes').value : '',
    fpsSlider: $('fpsSlider').value,
    windSlider: $('windSlider').value,
    rangeSlider: $('rangeSlider').value,
  };
  let builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  builds = builds.filter(b => b.name !== buildName);
  builds.push(buildData);
  localStorage.setItem('arrowForgeBuilds', JSON.stringify(builds));
  updateLoadDropdown();
  alert(`Build "${buildName}" saved!`);
}

function loadBuild() {
  const select = $('loadBuild');
  const selectedName = select.value;
  if (!selectedName || selectedName === '– Load Build –') return;

  const builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  const build = builds.find(b => b.name === selectedName);
  if (!build) return;

  // Force-expand Bow Details
  const bowTrigger = document.querySelector('#bowCard .collapsible-trigger');
  const bowContent = document.querySelector('#bowCard .collapsible-content');
  if (bowTrigger && bowContent) {
    bowTrigger.click(); // use click to trigger your toggle logic
  }

  // Force-expand Arrow Details (always)
  const arrowTrigger = document.querySelector('#arrowCard .collapsible-trigger');
  const arrowContent = document.querySelector('#arrowCard .collapsible-content');
  if (arrowTrigger && arrowContent) {
    arrowTrigger.click(); // use click for reliability
  }

  // Delay for DOM update
  setTimeout(() => {
    // Debug: check if arrowName and spine exist
    console.log('Arrow Name element:', $('arrowName'));
    console.log('Spine element:', $('spine'));
    console.log('Point Type element:', $('pointType'));

    // Restore bow fields
    if ($('buildName')) $('buildName').value = build.name || '';
    if ($('appType')) $('appType').value = build.appType || 'Hunting';
    if ($('bowModel')) $('bowModel').value = build.bowModel || '';
    if ($('bowType')) $('bowType').value = build.bowType || 'compound';
    if ($('ibo')) $('ibo').value = build.ibo || '';
    if ($('drawWt')) $('drawWt').value = build.drawWt || '';
    if ($('drawLen')) $('drawLen').value = build.drawLen || '';
    if ($('letOff')) $('letOff').value = build.letOff || '';
    if ($('braceHeight')) $('braceHeight').value = build.braceHeight || '';
    if ($('camType')) $('camType').value = build.camType || '';

    // String add-ons
    if ($('stringWt')) $('stringWt').value = build.stringWt || '0';
    if ($('peepWt')) $('peepWt').value = build.peepWt || '0';
    if ($('dloopWt')) $('dloopWt').value = build.dloopWt || '0';
    if ($('kisserWt')) $('kisserWt').value = build.kisserWt || '0';
    if ($('silencerWt')) $('silencerWt').value = build.silencerWt || '0';

    // Pin count & zeros
    if ($('pinCount')) $('pinCount').value = build.pinCount || '3';
    if ($('pin1Zero')) $('pin1Zero').value = build.pin1Zero || '20';
    if ($('pin2Zero')) $('pin2Zero').value = build.pin2Zero || '30';
    if ($('pin3Zero')) $('pin3Zero').value = build.pin3Zero || '40';
    if ($('pin4Zero')) $('pin4Zero').value = build.pin4Zero || '50';
    if ($('pin5Zero')) $('pin5Zero').value = build.pin5Zero || '60';

    // Arrow specs (basic)
    if ($('arrowName')) $('arrowName').value = build.arrowName || '';
    if ($('spine')) $('spine').value = build.spine || '';
    if ($('arrowDia')) $('arrowDia').value = build.arrowDia || 'micro';
    if ($('arrowLen')) $('arrowLen').value = build.arrowLen || '';
    if ($('totalWt')) $('totalWt').value = build.totalWt || '';
    if ($('pointWt')) $('pointWt').value = build.pointWt || '';
    if ($('balancePt')) $('balancePt').value = build.balancePt || '';

    // Arrow details — detailed components
    if ($('useArrowDetails')) $('useArrowDetails').checked = build.useArrowDetails ?? true;
    if ($('bareShaftWt')) $('bareShaftWt').value = build.bareShaftWt || '0';
    if ($('insertWt')) $('insertWt').value = build.insertWt || '0';
    if ($('pointType')) $('pointType').value = build.pointType || 'Fixed Blade';
    if ($('inFlightDia')) $('inFlightDia').value = build.inFlightDia || '';
    if ($('wrapWt')) $('wrapWt').value = build.wrapWt || '0';
    if ($('vaneWt')) $('vaneWt').value = build.vaneWt || '0';
    if ($('vaneCount')) $('vaneCount').value = build.vaneCount || '0';
    if ($('vaneHeight')) $('vaneHeight').value = build.vaneHeight || '';
    if ($('vaneHelical')) $('vaneHelical').value = build.vaneHelical || 'None';
    if ($('glueWt')) $('glueWt').value = build.glueWt || '0';
    if ($('nockWt')) $('nockWt').value = build.nockWt || '0';

    // Build Notes
    if ($('buildNotes')) $('buildNotes').value = build.buildNotes || '';

    // Sliders
    if ($('fpsSlider')) $('fpsSlider').value = build.fpsSlider || '278';
    if ($('fpsInput')) $('fpsInput').value = build.fpsSlider || '278';
    if ($('windSlider')) $('windSlider').value = build.windSlider || '0';
    if ($('windInput')) $('windInput').value = build.windSlider || '0';
    if ($('rangeSlider')) $('rangeSlider').value = build.rangeSlider || '50';
    if ($('rangeInput')) $('rangeInput').value = build.rangeSlider || '50';

    // Re-calculate everything after loading
    calculateEverything();

    alert(`Build "${build.name}" loaded!`);
  }, 500); // increased delay to 500ms
}

function deleteBuild() {
  const select = $('loadBuild');
  const selectedName = select.value;
  if (!selectedName || selectedName === '– Load Build –') {
    alert('Select a build to delete');
    return;
  }
  if (confirm(`Delete "${selectedName}" forever?`)) {
    let builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
    builds = builds.filter(b => b.name !== selectedName);
    localStorage.setItem('arrowForgeBuilds', JSON.stringify(builds));
    updateLoadDropdown();
    alert(`Build deleted`);
  }
}

// String weight listener 
['peepWt', 'dloopWt', 'kisserWt', 'silencerWt', 'nockWt'].forEach(id => {
  const el = $(id);
  if (el) el.addEventListener('input', calculateEverything);
});

// Sight Pin listener
// Rebuild pin inputs when pinCount changes
const pinCountSelect = $('pinCount');
if (pinCountSelect) {
  pinCountSelect.addEventListener('change', () => {
    calculateEverything();
  });
}

// Arrow components auto-sum listeners
['bareShaftWt', 'insertWt', 'wrapWt', 'vaneWt', 'vaneCount', 'glueWt', 'pointWt'].forEach(id => {
  const el = $(id);
  if (el) el.addEventListener('input', calculateEverything);
});

// Manual override for Total Arrow Weight
const totalWtInput = $('totalWt');
if (totalWtInput) {
  totalWtInput.addEventListener('input', () => {
    totalWtInput.dataset.manual = 'true';
  });
}

// Add this with other listeners (outside calculateEverything)
const stringWtInput = $('stringWt');
if (stringWtInput) {
  stringWtInput.addEventListener('input', () => {
    stringWtInput.dataset.manual = 'true';
  });
}

function syncSlider(sliderId, inputId) {
  const slider = $(sliderId);
  const input = $(inputId);
  if (!slider || !input) return;
  slider.addEventListener('input', () => {
    input.value = slider.value;
    calculateEverything(); // optional, if you have calculations
  });
  input.addEventListener('input', () => {
    let val = parseFloat(input.value);
    if (isNaN(val)) val = slider.min;
    val = Math.max(slider.min, Math.min(slider.max, val));
    slider.value = val;
    input.value = val;
    calculateEverything();
  });
}

// Capitalize Bow Model
$('bowModel').addEventListener('input', e => {
  e.target.value = toTitleCase(e.target.value);
});

// Capitalize Arrow Name
$('arrowName').addEventListener('input', e => {
  e.target.value = toTitleCase(e.target.value);
});

//Capitalize the first letter of each word
function toTitleCase(str) {
  return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
}

// Connect the sliders
syncSlider('fpsSlider', 'fpsInput');
syncSlider('windSlider', 'windInput');
syncSlider('rangeSlider', 'rangeInput');

// Event listeners
document.querySelectorAll('input, select').forEach(el => {
  el.addEventListener('input', calculateEverything);
});
// dark model toggle
$('darkToggle').addEventListener('change', e => {
  const isDark = e.target.checked;

  // Toggle dark mode class on body
  document.body.classList.toggle('dark', isDark);

  // Save preference
  localStorage.setItem('darkMode', isDark);

  // Swap logo
  const logoImg = document.getElementById('appLogo');
  if (logoImg) {
    logoImg.src = isDark ? 'logo-dark.png' : 'logo-light.png';
  }
});
//REMOVE $('aiButton').addEventListener('click', () => $('aiModal').style.display = 'flex');
$('saveBuild').addEventListener('click', saveBuild);
$('loadBuild').addEventListener('change', loadBuild);
$('deleteBuild').addEventListener('click', deleteBuild);

// Restore dark mode and logo on page load
const savedDark = localStorage.getItem('darkMode') === 'true';
if (savedDark) {
  document.body.classList.add('dark');
  $('darkToggle').checked = true;

  // Restore dark logo
  const logoImg = document.getElementById('appLogo');
  if (logoImg) logoImg.src = 'logo-dark.png';
} else {
  // Ensure light logo on fresh load
  const logoImg = document.getElementById('appLogo');
  if (logoImg) logoImg.src = 'logo-light.png';
}

// Close modal when clicking/tapping outside the content
document.getElementById('gameMathModal').addEventListener('click', function(e) {
  if (e.target === this) {  // clicked the overlay itself
    this.style.display = 'none';
  }
});

document.getElementById('gameMathModal').addEventListener('touchend', function(e) {
  if (e.target === this) {
    this.style.display = 'none';
  }
});

// Prevent clicks/touches inside the modal content from closing it
const modalContent = document.querySelector('#gameMathModal .info-panel'); // adjust selector if needed
if (modalContent) {
  modalContent.addEventListener('click', function(e) {
    e.stopPropagation();
  });
  modalContent.addEventListener('touchend', function(e) {
    e.stopPropagation();
  });
}

// Optional: Also close with Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && $('gameMathModal').style.display === 'flex') {
    $('gameMathModal').style.display = 'none';
  }
});

// Show "How To" onboarding on first visit only
if (!localStorage.getItem('hasSeenOnboarding')) {
  showGettingStarted();
  localStorage.setItem('hasSeenOnboarding', 'true');
}

// set initial state
updateLoadDropdown();
calculateEverything();
toggleStringDetailsMode(); 
toggleArrowDetailsMode();
</script>

<!--contact information-->
<footer style="text-align:center; padding:1rem; color:var(--light); font-size:0.9rem; margin-top:2rem;">
  <p style="font-size:0.8rem; color:var(--light); text-align:center; margin-top:1rem;">
  <strong>Disclaimer:</strong> ArrowForge is a tuning and calculation tool for informational purposes only. All recommendations, calculations, and AI-generated suggestions are estimates based on user input and general archery data. They are not guaranteed accurate or safe for your specific equipment.<br><br>
  Incorrect bow setup (e.g., too weak spine, excessive draw weight, or improper tuning) can cause equipment failure, injury, or death. Always consult manufacturer guidelines, a qualified archery professional, and test setups safely. Use at your own risk — Frontier Forge LLC is not liable for any damage, harm or injury.
  <br><br></p>

  <p>Questions? Feedback? Email <a href="mailto:arrowforgeapp@tuta.io" style="color:var(--purple);">arrowforgeapp@tuta.io</a><br></p>
  <p>ArrowForge v0.0.20 — Built for archers, by archers 🏹<br></br></p>
  <span style="font-size:0.8rem; opacity:0.8;">© 2025 Frontier Forge LLC -    © 2025 <a href="/about.html" style="color:var(--light);">About</a></span>
</footer>

</body>
</html>