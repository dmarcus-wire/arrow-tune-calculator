<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArrowForge – Smart Arrow Tuner</title>
  <meta name="description" content="Offline-first archery calculator with AI advisor. Perfect arrow tuning made simple.">
  <!-- PWA: makes it installable on phones -->
  <meta name="theme-color" content="#0ea5e9">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQXJyb3dGb3JnZSIsInNob3J0X25hbWUiOiJBcnJvd0ZvcmdlIiwic3RhcnRfdXJsIjoiaHR0cHM6Ly9hIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCxiYXNlNjQsdmFsdWUiOiJkYXRhOmltYWdlL3N2Zyt4bWwgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCB5PSIuOWVtIiBmb250LXNpemU9IjkwIj7wn5iBLTwvdGV4dD48L3N2Zz4iLCJzaXplcyI6IjEyOHgxMjgiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCIsInB1cnBvc2UiOiJhbnkgbWFza2FibGUifV19">
  <link href="https://rsms.me/inter/inter.css" rel="stylesheet">
  <style>
  /* ===================================================================
     COLOR THEME — light & dark mode
     =================================================================== */
  :root {
    --bg:#f8fafc; --card:#ffffff; --text:#1e293b; --light:#64748b; --border:#e2e8f0;
    --primary:#0ea5e9; --success:#22c55e; --warning:#f59e0b; --danger:#ef4444; --purple:#8b5cf6;
  }
  .dark {
    --bg:#0f172a; --card:#020617; --text:#e2e8f0; --light:#94a3b8; --border:#1e293b;
  }

  /* ===================================================================
     BASIC LAYOUT — 2-column on desktop, stacked on mobile
     =================================================================== */
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family:'Inter',sans-serif;
    background:var(--bg);
    color:var(--text);
    padding:0.5rem;
    min-height:100vh;
  }
  .container {
    max-width:1600px;
    margin:auto;
    display:grid;
    gap:1rem 1.5rem;
  }
  @media (max-width:1023px) { .container { grid-template-columns:1fr; } }
  @media (min-width:1024px) {
    .container {
      grid-template-columns: 460px 1fr;
    }
  }

  /* ===================================================================
     CARD STYLES — inputs are tight, dashboard is spacious
     =================================================================== */
  .card {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px;
    padding:1rem;
    box-shadow:0 4px 12px rgba(15,23,42,0.08);
  }
  #inputs-column .card { padding:0.8rem; }
  #inputs-column label { margin:0.5rem 0 0.2rem; font-size:0.9rem; }
  #inputs-column input, #inputs-column select { padding:0.5rem; font-size:0.95rem; }
  #outputs-column .card { padding:1.25rem; }
  #outputs-column h2 { font-size:1.4rem; margin-bottom:1rem; }

  /* ===================================================================
     COMMON UI ELEMENTS
     =================================================================== */
  .card-header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.75rem; }
  h1 { font-size:1.5rem; margin:0; }
  input, select {
    width:100%;
    border:1px solid var(--border);
    border-radius:8px;
    background:var(--card);
    color:var(--text);
    padding:0.5rem;
  }

  /* ============================================================= */
  /* UNIVERSAL INLINE LABELS – looks great on mobile AND desktop   */
  /* ============================================================= */
  .input-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 0.5rem 0;
    gap: 0.75rem;
  }
  .input-row label {
    margin: 0;
    font-weight: 600;
    font-size: 0.95rem;
    white-space: nowrap;
    color: var(--text);
    flex-shrink: 0;
  }
  .input-row label::after {
    content: ":";
    margin-left: 0.25rem;
    color: var(--light);
  }
  .input-row input,
  .input-row select {
    flex: 1;
    min-width: 140px;
    text-align: right;
    font-size: 1rem;
  }
  @media (min-width: 769px) {
    .input-row { gap: 1rem; }
    .input-row input, .input-row select {
      max-width: 240px;
      text-align: left;
      font-size: 1.05rem;
    }
    .input-row label { font-size: 1rem; }
  }

  /* ============================================================= */
  /* COLLAPSIBLE SECTIONS – CLEAN & FINAL (no duplicates)           */
  /* ============================================================= */

  /* Inner collapsibles (String Details, Component Details) – work on all devices */
  .collapsible-trigger {
    cursor: pointer;
    padding: 0.75rem 0 0.5rem 0;
    margin-top: 0.75rem;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    color: var(--primary);
  }
  .collapsible-trigger .chevron {
    font-size: 1.5rem;
    transition: transform 0.25s ease;
    color: var(--light);
  }
  .collapsible-trigger.open .chevron {
    transform: rotate(90deg);
  }
  .collapsible-content {
    display: none;
    padding-top: 0.5rem;
  }
  .collapsible-trigger.open + .collapsible-content {
    display: block;
  }

  /* Mobile-only collapse for Bow & Arrow cards */
  @media (max-width: 768px) {
    .collapsible-mobile .card-content {
      display: none;
    }
    .collapsible-mobile.open .card-content {
      display: block;
    }
    .mobile-only-trigger {
      display: flex !important;
      cursor: pointer;
      padding: 0.75rem 1rem;
      background: var(--card);
      border-top: 1px solid var(--border);
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      color: var(--primary);
      margin-top: 0.5rem;
      border-radius: 0 0 14px 14px;
    }
    .collapsible-mobile.open .mobile-only-trigger .chevron {
      transform: rotate(90deg);
    }
  }

  /* Desktop: always show Bow/Arrow content, hide mobile trigger */
  @media (min-width: 769px) {
    .mobile-only-trigger {
      display: none !important;
    }
    .collapsible-mobile .card-content {
      display: block !important;
    }
  }

  /* Default state for mobile trigger (hidden until media query overrides) */
  .mobile-only-trigger {
    display: none;
  }

  /* ============================================================= */
  /* BUTTONS & OTHER UI                                            */
  /* ============================================================= */
  button {
    padding:0.5rem 1rem;
    border:none;
    border-radius:999px;
    background:var(--primary);
    color:white;
    font-weight:600;
    font-size:0.95rem;
    line-height:1;
    cursor:pointer;
  }
  button, .btn-small {
    min-height:44px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
  }
  .btn-small { padding:0.35rem 0.7rem; font-size:0.85rem; }
  .secondary { background:transparent; color:var(--primary); border:1px solid var(--primary); }
  .flex { display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; }
  .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:0.5rem; }
  @media (max-width:640px) { .grid-2 { grid-template-columns:1fr; } }

  /* Dark mode toggle */
  .toggle-switch { position:relative; width:50px; height:26px; }
  .toggle-switch input { opacity:0; width:0; height:0; }
  .slider { position:absolute; inset:0; background:#cbd5e1; border-radius:34px; transition:.3s; }
  .slider:before { position:absolute; content:""; height:20px; width:20px; left:3px; bottom:3px; background:white; border-radius:50%; transition:.3s; }
  input:checked + .slider { background:var(--primary); }
  input:checked + .slider:before { transform:translateX(24px); }

  /* Progress bars */
  .bar { height:8px; border-radius:999px; background:var(--border); margin:0.4rem 0; position:relative; overflow:hidden; }
  .bar-fill { height:100%; background:linear-gradient(to right,var(--success),var(--warning)); transition:width 0.3s ease; }

  /* Dashboard tiles */
  .dashboard-grid { display:grid; gap:0.75rem; grid-template-columns:repeat(auto-fit, minmax(120px,1fr)); }
  .dash-tile { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:0.8rem; text-align:center; }
  .dash-value { font-size:1.6rem; font-weight:800; margin:0.2rem 0; }
  .dash-label { font-size:0.8rem; color:var(--light); }

  /* Game table */
  .game-table { width:100%; border-collapse:collapse; font-size:0.95rem; }
  .game-table th, .game-table td { padding:0.4rem; text-align:left; border-bottom:1px solid var(--border); }
  .send { color:var(--success); font-weight:700; }
  .marginal { color:var(--warning); font-weight:700; }
  .no { color:var(--danger); font-weight:700; }

  /* Trajectory canvas */
  canvas { width:100%; height:200px; margin:1rem 0; background:#00000004; border-radius:8px; }

  /* AI Modal */
  .info-overlay {
    position:fixed; inset:0; background:rgba(0,0,0,0.5);
    display:none; align-items:center; justify-content:center; z-index:1000;
  }
  .info-panel {
    background:var(--card);
    border-radius:12px;
    max-width:600px;
    width:90%;
    max-height:90vh;
    padding:1.5rem;
    box-shadow:0 20px 40px rgba(0,0,0,0.3);
    position:relative;
    overflow-y:auto;
  }
  .info-close {
    position:absolute; top:0.8rem; right:1rem;
    background:none; border:none; font-size:1.8rem;
    color:var(--light); cursor:pointer;
  }
</style>
</head>
<body>

<!-- ============================================================= -->
<!-- LEFT COLUMN – INPUTS (compact & efficient)                  -->
<!-- ============================================================= -->
 
<div class="container">

<div id="inputs-column">

  <!-- Header -->
  <div class="card">
    <div class="card-header">
      <h1>ArrowForge</h1>
      <div class="flex">
        <span style="color:var(--light);">Light</span>
        <label class="toggle-switch">
          <input type="checkbox" id="darkToggle"><span class="slider"></span>
        </label>
        <span style="color:var(--light);">Dark</span>
        <button id="aiButton" class="btn-small" style="background:var(--purple);">AI Advisor</button>
      </div>
    </div>
    <p style="color:var(--light);font-size:0.85rem;">Offline • Live • v1.0</p>
  </div>

<!-- ============================================================= -->
<!-- LEFT COLUMN – BUILD (compact & efficient)                  -->
<!-- ============================================================= --> 

  <!-- Build Card -->
  <div class="card">
    <h2>Build</h2>
    <div class="input-row">
      <label for="buildName">Build Name</label>
      <div class="flex" style="gap:0.5rem;">
        <input type="text" id="buildName" placeholder="e.g. 2025 Elk Slayer">
        <button class="btn-small secondary">Suggest</button>
      </div>
    </div>
    <div class="flex" style="margin-top:0.75rem; gap:0.5rem;">
      <button id="saveBuild">Save</button>
      <select id="loadBuild" style="flex:1;"><option>– Load Build –</option></select>
      <button id="deleteBuild" style="background:var(--danger);">Delete</button>
    </div>
  </div>

<!-- ============================================================= -->
<!-- LEFT COLUMN – BOW (compact & efficient)                  -->
<!-- ============================================================= --> 

<!-- BOW CARD – FIXED for mobile -->
<div class="card collapsible-mobile" id="bowCard">
  <!-- Header always visible -->
  <h2 style="margin:0 0 0.75rem 0;">Bow</h2>
  
  <!-- Content – hidden on mobile until opened -->
  <div class="card-content">
    <div class="input-row"><label for="appType">Application</label><select id="appType"><option>Target</option><option selected>Hunting</option><option>Other</option></select></div>
    <div class="input-row"><label for="bowModel">Model</label><input type="text" id="bowModel" placeholder="Hoyt RX-9"></div>
    <div class="input-row"><label for="ibo">IBO fps</label><input type="number" id="ibo" value="340"></div>
    <div class="input-row"><label for="drawWt">Draw wt lb</label><input type="number" id="drawWt" value="70" step="0.5"></div>
    <div class="input-row"><label for="drawLen">Draw length in</label><input type="number" id="drawLen" value="29" step="0.1"></div>
    <div class="input-row"><label for="stringWt">String add-ons gr</label><input type="number" id="stringWt" value="20"></div>

    <!-- String Details – collapsible (unchanged) -->
    <div class="collapsible-trigger" onclick="toggleSection('stringDetails')">
      <span>String Details</span>
      <span class="chevron">></span>
    </div>
    <div id="stringDetails" class="collapsible-content">
        <div class="input-row"><label for="peepWt">Peep weight gr</label><input type="number" id="peepWt" value="8" step="0.5"></div>
        <div class="input-row"><label for="dloopWt">D-loop gr</label><input type="number" id="dloopWt" value="8" step="0.5"></div>
        <div class="input-row"><label for="kisserWt">Kisser gr</label><input type="number" id="kisserWt" value="0" step="0.5"></div>
        <div class="input-row"><label for="silencerWt">Silencers gr</label><input type="number" id="silencerWt" value="12" step="0.5"></div>
        <div class="input-row"><label for="nockWt">Nock weight gr</label><input type="number" id="nockWt" value="10" step="0.5"></div>
        <div style="margin-top:0.75rem;text-align:right;font-weight:600;color:var(--primary);">
          Total string add-ons: <span id="totalStringDisplay">38</span> gr
        </div>
    </div>
  </div>

  <!-- MOBILE TRIGGER – always visible on mobile, hidden on desktop -->
  <div class="mobile-only-trigger" onclick="toggleMobileCard('bowCard')">
    <span>Bow Details</span>
    <span class="chevron">></span>
  </div>
</div>

<!-- ============================================================= -->
<!-- LEFT COLUMN – ARROW (compact & efficient)                  -->
<!-- ============================================================= --> 

<!-- ARROW CARD – FIXED similarly -->
<div class="card collapsible-mobile" id="arrowCard">
  <h2 style="margin:0 0 0.75rem 0;">Arrow</h2>
  <div class="card-content">
    <div class="input-row"><label for="arrowName">Name</label><input type="text" id="arrowName" placeholder="Victory VAP TKO"></div>
    <div class="input-row"><label for="spine">Spine</label><input type="number" id="spine" value="300"></div>
    <div class="input-row"><label for="arrowLen">Length in</label><input type="number" id="arrowLen" value="28.5" step="0.1"></div>
    <div class="input-row"><label for="totalWt">Total weight gr</label><input type="number" id="totalWt" value="495" step="0.5"></div>
    <div class="input-row"><label for="pointWt">Point weight gr</label><input type="number" id="pointWt" value="125"></div>
    <div class="input-row"><label for="balancePt">Balance point in</label><input type="number" id="balancePt" value="17.2" step="0.05"></div>

    <!-- Component Details – collapsible (unchanged) -->
    <div class="collapsible-trigger" onclick="toggleSection('componentDetails')">
      <span>Component Details</span>
      <span class="chevron">></span>
    </div>
    <div id="componentDetails" class="collapsible-content">
        <div class="input-row"><label for="insertWt">Insert/Outsert gr</label><input type="number" id="insertWt" value="50" step="0.5"></div>
        <div class="input-row"><label for="wrapWt">Wrap gr</label><input type="number" id="wrapWt" value="8" step="0.5"></div>
        <div class="input-row"><label for="vaneWt">Vane weight (each) gr</label><input type="number" id="vaneWt" value="8" step="0.1"></div>
        <div class="input-row"><label for="vaneCount">Vane count</label><input type="number" id="vaneCount" value="3"></div>
        <div class="input-row"><label for="glueWt">Glue / Pin gr</label><input type="number" id="glueWt" value="5" step="0.5"></div>
        <div style="margin-top:0.75rem;text-align:right;font-weight:600;color:var(--primary);">
          Total components: <span id="totalCompDisplay">71</span> gr
        </div>
    </div>
  </div>

  <div class="mobile-only-trigger" onclick="toggleMobileCard('arrowCard')">
    <span>Arrow Details</span>
    <span class="chevron">></span>
  </div>
</div>

  <!-- ============================================================= -->
  <!-- RIGHT COLUMN – DASHBOARD (big & bold)                       -->
  <!-- ============================================================= -->
  <div id="outputs-column">

    <!-- Live Settings – your original skinny sliders, fully working -->
    <div class="card">
      <h2>Live Settings</h2>

      <!-- Actual Speed (fps) -->
      <div style="margin:1.2rem 0;">
        <label style="display:block; margin-bottom:0.4rem; font-weight:600;">Actual Speed (fps)</label>
        <div style="display:flex; align-items:center; gap:1rem;">
          <input type="range" id="fpsSlider" min="150" max="400" value="278" step="1"
                style="flex:1; height:6px; border-radius:3px; background:var(--border);">
          <input type="number" id="fpsInput" value="278" min="150" max="400"
                style="width:70px; padding:0.45rem; text-align:center; font-weight:600; font-size:1rem;">
        </div>
      </div>

      <!-- Crosswind (mph) -->
      <div style="margin:1.2rem 0;">
        <label style="display:block; margin-bottom:0.4rem; font-weight:600;">Crosswind (mph)</label>
        <div style="display:flex; align-items:center; gap:1rem;">
          <input type="range" id="windSlider" min="0" max="40" value="5" step="0.5"
                style="flex:1; height:6px; border-radius:3px; background:var(--border);">
          <input type="number" id="windInput" value="5" min="0" max="40" step="0.5"
                style="width:70px; padding:0.45rem; text-align:center; font-weight:600; font-size:1rem;">
        </div>
      </div>

      <!-- Range (yards) -->
      <div style="margin:1.2rem 0;">
        <label style="display:block; margin-bottom:0.4rem; font-weight:600;">Range (yards)</label>
        <div style="display:flex; align-items:center; gap:1rem;">
          <input type="range" id="rangeSlider" min="10" max="150" value="50" step="1"
                style="flex:1; height:6px; border-radius:3px; background:var(--border);">
          <input type="number" id="rangeInput" value="50" min="10" max="150"
                style="width:70px; padding:0.45rem; text-align:center; font-weight:600; font-size:1rem;">
        </div>
      </div>
    </div>

    <!-- Game effectiveness table -->
    <div class="card">
      <h2>Game Readiness @ <span id="gameDist">50</span> yd</h2>
      <table class="game-table">
        <thead><tr><th>Animal</th><th>Min KE</th><th>Min Mom</th><th>Result</th></tr></thead>
        <tbody>
          <tr><td>Small Game</td><td>15 ft-lbs</td><td>0.20</td><td id="smallRes" class="send">Send it</td></tr>
          <tr><td>Deer</td><td>25 ft-lbs</td><td>0.30</td><td id="deerRes" class="send">Send it</td></tr>
          <tr><td>Elk</td><td>42 ft-lbs</td><td>0.44</td><td id="elkRes" class="send">Send it</td></tr>
          <tr><td>Moose/Tough</td><td>65 ft-lbs</td><td>0.65</td><td id="mooseRes" class="marginal">Marginal</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Launch → Impact bars -->
    <div class="card">
      <h2>Launch → @ <span id="barDist">50</span> yd</h2>

      <label>Velocity</label>
      <div class="bar"><div id="velFill" class="bar-fill"></div></div>
      <div class="flex" style="justify-content:space-between;font-size:0.9rem;">
        <span id="velLaunch">278</span> fps → <span id="velImpact">245</span> fps
      </div>

      <label style="margin-top:0.75rem;">Kinetic Energy</label>
      <div class="bar"><div id="keFill" class="bar-fill"></div></div>
      <div class="flex" style="justify-content:space-between;font-size:0.9rem;">
        <span id="keLaunch">85</span> → <span id="keImpact">66</span> ft-lbs
      </div>

      <label style="margin-top:0.75rem;">Momentum</label>
      <div class="bar"><div id="momFill" class="bar-fill"></div></div>
      <div class="flex" style="justify-content:space-between;font-size:0.9rem;">
        <span id="momLaunch">0.59</span> → <span id="momImpact">0.53</span> slug·ft/s
      </div>
    </div>

    <!-- Trajectory graph -->
    <div class="card">
      <h2>Trajectory</h2>
      <canvas id="trajChart"></canvas>
      <p style="text-align:center;color:var(--light);font-size:0.85rem;">
        Peak height: <span id="peakHt">4.2</span> ft • Flight time: <span id="flightTime">0.61</span> s
      </p>
    </div>

    <!-- Quick stats grid -->
    <div class="card">
      <h2>Quick Stats</h2>
      <div class="dashboard-grid">
        <div class="dash-tile"><div class="dash-value" id="focVal">15.2</div><div class="dash-label">FOC %</div></div>
        <div class="dash-tile"><div class="dash-value" id="gppVal">7.1</div><div class="dash-label">GPP</div></div>
        <div class="dash-tile"><div class="dash-value" id="gpiVal">17.4</div><div class="dash-label">GPI</div></div>
        <div class="dash-tile"><div class="dash-value" id="driftVal">4.1</div><div class="dash-label">Wind Drift in</div></div>
        <div class="dash-tile"><div class="dash-value" id="stiffVal">Ideal</div><div class="dash-label">Forgiveness</div></div>
      </div>
    </div>

  </div> <!-- end outputs-column -->
</div> <!-- end container -->

<!-- ============================================================= -->
<!-- AI ADVISOR MODAL (hidden until clicked)                     -->
<!-- ============================================================= -->
<div id="aiModal" class="info-overlay">
  <div class="info-panel">
    <button class="info-close" onclick="closeModal()">×</button>
    <h2>AI Arrow Advisor</h2>
    <div id="chatHist" style="max-height:300px;overflow-y:auto;margin-bottom:1rem;padding:0.5rem;background:#00000004;border-radius:8px;"></div>
    <div class="flex">
      <input id="aiIn" type="text" placeholder="Ask about arrows, broadheads, tuning..." style="flex:1;">
      <button onclick="sendAi()" class="btn-small">Send</button>
    </div>
  </div>
</div>

<script>
/* ============================================================= */
/* GLOBAL HELPERS                                               */
/* ============================================================= */
const $ = id => document.getElementById(id);

/* ============================================================= */
/* SLIDER SYNC — connects sliders to number inputs               */
/* ============================================================= */
function syncSlider(sliderId, inputId) {
  const slider = $(sliderId);
  const input = $(inputId);

  if (!slider || !input) return;

  slider.addEventListener('input', () => {
    input.value = slider.value;
    if (sliderId === 'rangeSlider') $('rangeVal').textContent = slider.value;
    calculateEverything();
  });

  input.addEventListener('input', () => {
    let val = parseFloat(input.value);
    if (isNaN(val)) val = slider.min;
    val = Math.max(slider.min, Math.min(slider.max, val));
    slider.value = val;
    input.value = val;
    if (sliderId === 'rangeSlider') $('rangeVal').textContent = val;
    calculateEverything();
  });
}

// Connect FPS, Wind, Range sliders
syncSlider('fpsSlider', 'fpsInput');
syncSlider('windSlider', 'windInput');
syncSlider('rangeSlider', 'rangeInput');

/* ============================================================= */
/* MAIN CALCULATION ENGINE – NOW USES SLIDER VALUES              */
/* ============================================================= */
function calculateEverything() {
  // SLIDER VALUES
  const fps     = parseFloat($('fpsSlider').value) || 278;
  const windMph = parseFloat($('windSlider').value) || 5;
  const rangeYd = parseFloat($('rangeSlider').value) || 50;

  // Sync number inputs
  $('fpsInput').value = fps;
  $('windInput').value = windMph;
  $('rangeInput').value = rangeYd;
  $('rangeVal').textContent = rangeYd;
  $('gameDist').textContent = rangeYd;
  $('barDist').textContent = rangeYd;

  // Your existing arrow/bow values
  const drawWt      = parseFloat($('drawWt').value) || 70;
  const totalWt     = parseFloat($('totalWt').value) || 495;
  const pointWt     = parseFloat($('pointWt').value) || 125;
  const arrowLen    = parseFloat($('arrowLen').value) || 28.5;
  const balancePt   = parseFloat($('balancePt').value) || 17.2;

  // FOC
  const midPoint = arrowLen / 2;
  const foc = ((balancePt - midPoint) / arrowLen) * 100;
  $('focVal').textContent = foc.toFixed(1);

  // GPP & GPI
  $('gppVal').textContent = (totalWt / drawWt).toFixed(1);
  $('gpiVal').textContent = (totalWt / arrowLen).toFixed(1);

  // VELOCITY RETENTION (uses slider FPS)
  const retention = Math.pow(0.985, rangeYd / 10);
  const velImpact = Math.round(fps * retention);
  $('velLaunch').textContent = fps;
  $('velImpact').textContent = velImpact;
  $('velFill').style.width = (retention * 100) + '%';

  // KE (uses slider FPS)
  const keLaunch = Math.round(totalWt * fps * fps / 450240);
  const keImpact = Math.round(totalWt * velImpact * velImpact / 450240);
  $('keLaunch').textContent = keLaunch;
  $('keImpact').textContent = keImpact;
  $('keFill').style.width = (keImpact / keLaunch * 100) + '%';

  // MOMENTUM (uses slider FPS)
  const momLaunch = (totalWt * fps / 225400).toFixed(2);
  const momImpact = (totalWt * velImpact / 225400).toFixed(2);
  $('momLaunch').textContent = momLaunch;
  $('momImpact').textContent = momImpact;
  $('momFill').style.width = (momImpact / momLaunch * 100) + '%';

  // Game table
  const gameBands = [
    {id:'smallRes', ke:15, mom:0.20},
    {id:'deerRes',  ke:25, mom:0.30},
    {id:'elkRes',   ke:42, mom:0.44},
    {id:'mooseRes', ke:65, mom:0.65}
  ];
  gameBands.forEach(b => {
    const ok = keImpact >= b.ke && parseFloat(momImpact) >= b.mom;
    const marginal = keImpact >= b.ke * 0.9 || parseFloat(momImpact) >= b.mom * 0.9;
    $(b.id).textContent = ok ? 'Send it' : marginal ? 'Marginal' : 'No';
    $(b.id).className = ok ? 'send' : marginal ? 'marginal' : 'no';
  });

  // Wind drift (uses slider wind & range)
  $('driftVal').textContent = (0.065 * rangeYd * rangeYd * windMph / totalWt).toFixed(1);

  // Spine forgiveness
  const effectiveDw = drawWt + (pointWt/25) + (arrowLen-28);
  const recSpine = Math.round(400 - effectiveDw*5);
  const delta = (parseFloat($('spine').value)||300) - recSpine;
  let text = 'Ideal';
  if (delta < -30) text = 'Very Stiff';
  else if (delta < -10) text = 'Stiff';
  else if (delta > 30) text = 'Very Weak';
  else if (delta > 10) text = 'Weak';
  $('stiffVal').textContent = text;

  // Flight time & peak
  const flightTime = ((rangeYd * 3) / ((fps + velImpact)/2)).toFixed(2);
  $('flightTime').textContent = flightTime;
  const peakFt = (fps * fps * 0.5) / 64.4 / 12;
  $('peakHt').textContent = peakFt.toFixed(1);

  // Trajectory
  const ctx = $('trajChart').getContext('2d');
  const w = ctx.canvas.width = ctx.canvas.parentElement.clientWidth;
  const h = ctx.canvas.height = 200;
  ctx.clearRect(0,0,w,h);
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--primary');
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.moveTo(0, h-20);
  for (let x=0; x<=w; x+=4) {
    const t = (x/w) * flightTime;
    const y = h - 20 - (fps * 0.707 * t - 16.1 * t * t) * 8;
    ctx.lineTo(x, y);
  }
  ctx.stroke();
}

/* EVENT LISTENERS */
document.querySelectorAll('input, select').forEach(el => {
  el.addEventListener('input', calculateEverything);
});
$('darkToggle').addEventListener('change', e => {
  document.body.classList.toggle('dark', e.target.checked);
});

/* COLLAPSIBLE */
function toggleSection(id) {
  const trigger = document.querySelector(`[onclick="toggleSection('${id}')"]`);
  if (trigger) trigger.classList.toggle('open');
}

/* MOBILE COLLAPSIBLE */
function toggleMobileCard(cardId) {
  if (window.innerWidth <= 768) {
    document.getElementById(cardId).classList.toggle('open');
  }
}

/* AI MODAL */
$('aiButton').addEventListener('click', () => $('aiModal').style.display = 'flex');
function closeModal() { $('aiModal').style.display = 'none'; }
function sendAi() {
  const msg = $('aiIn').value.trim();
  if (!msg) return;
  $('chatHist').innerHTML += `<p><strong>You:</strong> ${msg}</p>`;
  $('chatHist').innerHTML += `<p style="color:var(--purple);"><strong>AI:</strong> Got it! Example response...</p>`;
  $('aiIn').value = '';
  $('chatHist').scrollTop = $('chatHist').scrollHeight;
}

/* PWA */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('data:,').catch(() => {});
}

/* INIT */
calculateEverything();
</script>
</body>
</html>