<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arrow Tune Calculator</title>
  <meta name="description" content="Offline arrow tuning calculator – FOC, velocity, impact KE, composition, and more." />
  <link href="https://rsms.me/inter/inter.css" rel="stylesheet">
<style>
  :root {
    --bg:#f8fafc;
    --card:#ffffff;
    --text:#1e293b;
    --light:#64748b;
    --border:#e2e8f0;
    --primary:#0ea5e9;
    --success:#22c55e;
    --warning:#f59e0b;
    --danger:#ef4444;

    /* extra surfaces for tiles */
    --surface-muted:#f1f5f9;
    --surface-strong-shadow:rgba(15,23,42,0.22);
    --tile-shadow:rgba(15,23,42,0.16);
  }
  .dark {
    --bg:#0f172a;
    --card:#020617;
    --text:#e2e8f0;
    --light:#94a3b8;
    --border:#1e293b;
    --surface-muted:#020617;
    --surface-strong-shadow:rgba(0,0,0,0.6);
    --tile-shadow:rgba(0,0,0,0.5);
  }

  * {
    margin:0;
    padding:0;
    box-sizing:border-box;
  }

  body {
    font-family:'Inter',sans-serif;
    background:var(--bg);
    color:var(--text);
    padding:1rem;
    min-height:100vh;
    line-height:1.6;
  }

  .container {
    max-width:1400px;
    margin:auto;
    display:grid;
    gap:1.5rem;
  }
  @media (min-width:1024px) {
    .container { grid-template-columns:1fr 1fr; }
  }

  /* Top-level cards (big sections) */
  .card {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px;
    padding:1.5rem;
    box-shadow:0 18px 45px var(--surface-strong-shadow);
    position:relative;
  }

  /* Slight spacing between stacked cards in each column */
  #inputs-column > .card + .card,
  #outputs-column > .card + .card,
  .outputs-column > .card + .card {
    margin-top:1rem;
  }

  /* Inner subcards (like the game panel inside Performance) */
  .subcard {
    background:var(--surface-muted);
    border:1px solid rgba(148,163,184,0.35);
    border-radius:12px;
    box-shadow:0 10px 28px var(--tile-shadow);
    padding:1rem;
  }

  .card-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-bottom:1px solid var(--border);
    padding-bottom:0.75rem;
    margin-bottom:0.9rem;
    font-size:1.2rem;
    font-weight:600;
  }
  .card-header.compact {
    padding-bottom:0.5rem;
    margin-bottom:0.5rem;
    border-bottom:none;
  }

  .card-subtitle {
    font-size:0.9rem;
    color:var(--light);
    margin-bottom:0.9rem;
  }

  h1,h2,h3,h4 { color:var(--text); }

  label {
    display:block;
    margin:1rem 0 0.4rem;
    font-weight:600;
    font-size:0.95rem;
  }

  input, select, textarea {
    width:100%;
    padding:0.75rem;
    border:1px solid var(--border);
    border-radius:8px;
    background:var(--card);
    color:var(--text);
    font-size:1rem;
  }
  input:focus, select:focus, textarea:focus {
    outline:none;
    border-color:var(--primary);
    box-shadow:0 0 0 3px rgba(14,165,233,0.25);
  }

  button {
    padding:0.75rem 1.2rem;
    border:none;
    border-radius:999px;
    background:var(--primary);
    color:white;
    font-weight:600;
    cursor:pointer;
    font-size:0.95rem;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:0.25rem;
  }
  button:hover {
    filter:brightness(1.05);
  }

  .btn-small {
    padding:0.45rem 0.9rem;
    font-size:0.85rem;
    border-radius:999px;
  }

  .secondary-btn {
    background:transparent;
    color:var(--primary);
    border:1px solid rgba(14,165,233,0.5);
  }
  .secondary-btn.small {
    padding:0.3rem 0.7rem;
    font-size:0.8rem;
  }

  .btn-refresh { background:var(--warning); }

  .flex {
    display:flex;
    gap:1rem;
    align-items:center;
  }

  .grid-2 {
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:1rem;
  }

  /* Metric grid: 2 columns of tiles */
  .metric-grid {
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:1rem;
    margin-top:0.5rem;
  }

  /* Tile = little card inside a card */
  .metric-tile {
    display:flex;
    flex-direction:column;
    height:100%;
    padding:0.9rem 1rem;
    border-radius:12px;
    background:var(--surface-muted);
    border:1px solid rgba(148,163,184,0.4);
    box-shadow:0 10px 26px var(--tile-shadow);
  }

  .metric-header-row {
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:0.35rem;
  }

  .metric-title {
    display:flex;
    align-items:center;
    gap:0.35rem;
    font-size:0.9rem;
    font-weight:600;
    color:var(--light);
  }

  .metric-main-value {
    display:flex;
    align-items:flex-end;
    gap:0.3rem;
    justify-content:flex-start;
    margin:0.25rem 0 0.15rem;
  }

  .metric-main-value span,
  .metric-main-value input {
    margin:0 !important;
  }

  .metric-value,
  .metric-main-value span:first-child {
    font-size:2.1rem;
    line-height:1.05;
    font-weight:700;
  }

  .metric-unit {
    font-size:0.9rem;
    color:var(--light);
    font-weight:500;
    margin-bottom:0.2rem;
  }

  .metric-note {
    margin-top:0.25rem;
    font-size:0.8rem;
    color:var(--light);
  }

  /* Make AWC tile span both metric-grid columns */
  .metric-grid .awc-wide {
    grid-column: span 2;
  }

  .text-center { text-align:center; }

  .toggle-switch {
    position:relative;
    display:inline-block;
    width:56px;
    height:30px;
  }
  .toggle-switch input { opacity:0; width:0; height:0; }
  .slider {
    position:absolute;
    cursor:pointer;
    inset:0;
    background:#cbd5e1;
    border-radius:34px;
    transition:.3s;
  }
  .slider:before {
    position:absolute;
    content:"";
    height:24px;
    width:24px;
    left:3px;
    bottom:3px;
    background:white;
    border-radius:50%;
    transition:.3s;
  }
  input:checked + .slider { background:var(--primary); }
  input:checked + .slider:before { transform:translateX(26px); }

  .info-btn {
    font-size:1.0rem;
    color:var(--primary);
    background:none;
    border:none;
    cursor:pointer;
    padding:0;
  }
  .info-btn.small {
    font-size:0.85rem;
  }
  .info-btn:hover {
    transform:scale(1.1);
  }

  .math-btn {
    font-size:0.85rem;
    color:var(--primary);
    background:none;
    border:none;
    cursor:pointer;
    opacity:0.9;
    padding:0;
  }
  .math-btn:hover {
    opacity:1;
    transform:scale(1.1);
  }

  .advanced {
    display:none;
    margin-top:1rem;
    padding-top:1rem;
    border-top:1px solid var(--border);
  }

  table {
    width:100%;
    border-collapse:collapse;
    margin-top:0.5rem;
    font-size:0.95rem;
  }
  th, td {
    padding:0.6rem;
    text-align:left;
    border-bottom:1px solid var(--border);
  }
  th {
    background:var(--bg);
    font-weight:600;
  }

  .data-table {
    margin-top:0.3rem;
  }

  /* Build Summary table spacing */
  #summaryTable {
    margin-top:0.25rem;
    font-size:1rem;
  }
  #summaryTable table {
    width:100%;
    border-collapse:separate;
    border-spacing:0 0.4rem;
  }
  #summaryTable td {
    border-bottom:none;
    padding:0.25rem 0;
  }
  #summaryTable td:first-child {
    padding-right:1.8rem;
    font-weight:600;
  }
  #summaryTable td:last-child {
    text-align:right;
  }

  .build-summary {
    margin-top:0.5rem;
  }

  .build-summary button {
    margin-top:0.75rem;
  }

  .patreon-btn,
  .patreon-link {
    display:block;
    margin:2.25rem auto 0;
    background:#ff424d;
    color:white;
    text-decoration:none;
    padding:0.9rem 2rem;
    border-radius:999px;
    font-weight:bold;
    text-align:center;
    max-width:320px;
    box-shadow:0 18px 40px rgba(248,113,113,0.5);
  }

  .light-only { display:block; }
  .dark-only { display:none; }
  .dark .light-only { display:none; }
  .dark .dark-only { display:block; }

  /* Make the whole right column look consistent */
  .outputs-column {
    display:flex;
    flex-direction:column;
    gap:1rem;
  }

  #outputs-column,
  #outputs-column * {
    font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif !important;
    letter-spacing:-0.02em;
  }
  #outputs-column h3 {
    font-size:1.05rem !important;
    margin:0 0 0.4rem 0;
    font-weight:700 !important;
  }

  #smallGameStatus,
  #deerStatus,
  #elkStatus,
  #mooseStatus {
    font-size:2rem !important;
    font-weight:800 !important;
  }

  #outputs-column small {
    font-weight:500 !important;
    font-size:0.9rem;
    opacity:0.85;
  }

  #toast {
    position:fixed;
    bottom:1.5rem;
    right:1.5rem;
    background:var(--card);
    color:var(--text);
    border:1px solid var(--border);
    padding:0.6rem 1.1rem;
    border-radius:999px;
    box-shadow:0 6px 18px rgba(15,23,42,0.25);
    font-size:0.9rem;
    opacity:0;
    pointer-events:none;
    transition:opacity 0.25s ease-out;
    z-index:999;
  }

  /* FOC bar */
  .foc-scale {
    display:flex;
    align-items:center;
    gap:0.5rem;
    margin-top:0.35rem;
    font-size:0.8rem;
    color:var(--light);
  }
  .foc-bar {
    position:relative;
    flex:1;
    height:10px;
    border-radius:999px;
    background:var(--bg);
    overflow:hidden;
  }
  .foc-ideal {
    position:absolute;
    left:40%;
    width:20%;
    top:1px;
    bottom:1px;
    border-radius:999px;
    background:var(--success);
    opacity:0.25;
  }
  .foc-marker {
    position:absolute;
    top:-4px;
    width:0;
    height:18px;
    border-left:2px solid var(--primary);
  }

  /* Composition bar */
  .composition-bar {
    position:relative;
    height:10px;
    border-radius:999px;
    background:var(--bg);
    overflow:hidden;
    display:flex;
    margin-top:0.4rem;
  }
  .comp-segment {
    height:100%;
  }
  .comp-segment.shaft { background:#94a3b8; }
  .comp-segment.point { background:#0ea5e9; }
  .comp-segment.comps { background:#22c55e; }

  /* Performance controls (distance slider + wind) */
  .performance-controls {
    display:flex;
    flex-direction:column;
    gap:0.4rem;
  }
  .field-label {
    font-size:0.85rem;
    font-weight:600;
    color:var(--light);
  }
  .field-row {
    display:flex;
    flex-direction:column;
    gap:0.35rem;
  }
  .number-input.small {
    max-width:140px;
  }
  .distance-ticks {
    display:flex;
    justify-content:space-between;
    font-size:0.7rem;
    color:var(--light);
    margin-top:0.15rem;
  }

  .drop-table {
    margin-top:0.9rem;
  }

  /* Overlay panels */
  .info-overlay {
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.55);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:998;
  }
  .info-overlay.open {
    display:flex;
  }
  .info-panel {
    background:var(--card);
    color:var(--text);
    border-radius:12px;
    max-width:420px;
    width:90%;
    max-height:80vh;
    padding:1.25rem 1.5rem;
    box-shadow:0 20px 40px rgba(15,23,42,0.35);
    position:relative;
    overflow-y:auto;
  }
  .info-panel h2 {
    margin:0 0 0.5rem 0;
    font-size:1.2rem;
  }
  .info-panel p {
    font-size:0.95rem;
    margin:0.35rem 0;
    color:var(--light);
  }
  .info-close {
    position:absolute;
    top:0.6rem;
    right:0.75rem;
    border:none;
    background:transparent;
    font-size:1.4rem;
    cursor:pointer;
    color:var(--light);
  }
  .info-close:hover {
    color:var(--primary);
  }

  @media (max-width:768px) {
    body {
      padding:0.75rem;
    }
    .container {
      gap:1rem;
      grid-template-columns:1fr;
    }
    .card {
      padding:1.25rem;
    }
    .grid-2 {
      grid-template-columns:1fr;
    }
    .flex {
      flex-wrap:wrap;
    }
    .metric-grid {
      grid-template-columns:1fr;
    }
  }

  /* Performance control strip: FPS / Wind / Distance */
    .perf-grid {
      display: grid;
      grid-template-rows: auto auto;
      gap: 0.75rem;
    }

    .perf-top {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .perf-box {
      background: var(--surface-muted);
      border: 1px solid rgba(148,163,184,0.45);
      border-radius: 12px;
      padding: 0.85rem 1rem;
      box-shadow: 0 10px 24px var(--tile-shadow);
    }

    .perf-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.35rem;
    }

    .perf-label-actions {
      display: flex;
      align-items: center;
      gap: 0.35rem;  /* space between ⓘ, ∑, editable */
    }

    .perf-slider-left {
      display: flex;
      align-items: center;
      gap: 0.35rem;  /* space between "Distance", ⓘ, ∑ */
    }

    .perf-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--light);
    }

    .perf-edit-pill {
      font-size: 0.7rem;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      color: var(--light);
      background: rgba(15,23,42,0.02);
    }

    .perf-input-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .perf-input-row input {
      max-width: 120px;
      border-radius: 999px;
      padding: 0.55rem 0.9rem;
      font-weight: 600;
    }

    .perf-unit {
      font-size: 0.85rem;
      color: var(--light);
    }

    .perf-hint {
      font-size: 0.75rem;
      color: var(--light);
      margin-top: 0.3rem;
    }

    /* Slider row under both */
    .perf-slider-box {
      background: var(--surface-muted);
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.45);
      padding: 0.85rem 1rem 1rem;
      box-shadow: 0 10px 24px var(--tile-shadow);
    }

    .perf-slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.35rem;
    }

    .perf-slider-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--light);
    }

    .perf-distance-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--primary);
    }

    .perf-slider-box input[type="range"] {
      width: 100%;
    }

    /* keep your existing distance-ticks styling if you have it */
</style>
</head>
<body>
  <div class="container">
    <!-- LEFT: INPUTS -->
    <div id="inputs-column">
      <!-- Title / Theme card -->
      <div class="card">
        <div class="card-header">
          <h1>Arrow Tune Calculator</h1>
          <div class="flex">
            <span style="color:var(--light);">Light</span>
            <label class="toggle-switch">
              <input type="checkbox" id="darkModeToggle"><span class="slider"></span>
            </label>
            <span style="color:var(--light);">Dark</span>
          </div>
        </div>
        <p style="color:var(--light);">
          Offline • Mobile-friendly • Live calculations<br>
          <span style="font-size:0.9rem; color:var(--primary); font-weight:600;">Version 2.0.15</span>
        </p>
      </div>

      <!-- Your Setups -->
      <div class="card">
        <div class="card-header">
          <h2>Your Setups</h2>
        </div>
        <label>
          Build Name
          <button class="info-btn" type="button" data-info="buildName">ⓘ</button>
        </label>
        <div class="flex">
          <input type="text" id="buildName" placeholder="e.g. 2025 Hoyt RX-9 70lb 500gr">
          <button class="btn-small" id="suggestName">Suggest</button>
        </div>
        <div class="flex" style="margin-top:1rem;gap:0.5rem;flex-wrap:wrap;">
          <button id="saveBuild">Save Build</button>
          <select id="loadBuildSelect"><option value="">– Load Build –</option></select>
          <button style="background:var(--danger);" id="deleteBuild">Delete</button>
        </div>
      </div>

      <!-- Bow Setup -->
      <div class="card">
        <div class="card-header">
          <h3>Bow Setup</h3>
          <button class="info-btn" type="button" data-info="bowModel">ⓘ</button>
        </div>
        <div class="grid-2">
          <div>
            <label>
              Bow Model
              <button class="info-btn" type="button" data-info="bowModel">ⓘ</button>
            </label>
            <input type="text" id="bowModel">
          </div>
          <div>
            <label>
              IBO/ATA Speed (FPS)
              <button class="info-btn" type="button" data-info="iboRating">ⓘ</button>
            </label>
            <input type="number" id="iboRating" value="0" step="0.5">
          </div>
          <div>
            <label>
              Draw Weight (lbs)
              <button class="info-btn" type="button" data-info="drawWeight">ⓘ</button>
            </label>
            <input type="number" id="drawWeight" value="70" step="0.5">
          </div>
          <div>
            <label>
              Draw Length (in)
              <button class="info-btn" type="button" data-info="drawLength">ⓘ</button>
            </label>
            <input type="number" id="drawLength" value="30" step="0.5">
          </div>
          <div>
            <label>
              String Add-ons (gr)
              <button class="info-btn" type="button" data-info="stringWeightSimple">ⓘ</button>
            </label>
            <input type="number" id="stringWeightSimple" value="0" step="0.5">
          </div>
          <div>
            <label>
              Application
              <button class="info-btn" type="button" data-info="application">ⓘ</button>
            </label>
            <select id="application">
              <option>Target / 3D</option>
              <option selected>Hunting</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div class="flex" style="margin-top:1rem;justify-content:space-between;">
          <label>
            Advanced String Components
            <button class="info-btn" type="button" data-info="toggleString">ⓘ</button>
          </label>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleString"><span class="slider"></span>
          </label>
        </div>
        <div id="stringAdvanced" class="advanced">
          <div class="grid-2">
            <div>
              <label>
                Peep
                <button class="info-btn" type="button" data-info="peepWeight">ⓘ</button>
              </label>
              <input type="number" id="peepWeight" value="0" step="0.5">
            </div>
            <div>
              <label>
                D-Loop
                <button class="info-btn" type="button" data-info="dloopWeight">ⓘ</button>
              </label>
              <input type="number" id="dloopWeight" value="0" step="0.5">
            </div>
            <div>
              <label>
                Kisser
                <button class="info-btn" type="button" data-info="kisserWeight">ⓘ</button>
              </label>
              <input type="number" id="kisserWeight" value="0" step="0.5">
            </div>
            <div>
              <label>
                Silencers
                <button class="info-btn" type="button" data-info="silencersWeight">ⓘ</button>
              </label>
              <input type="number" id="silencersWeight" value="0" step="0.5">
            </div>
          </div>
          <p style="text-align:right;font-weight:600;">
            Total: <span id="stringTotal">0</span> grains
          </p>
        </div>
      </div>

      <!-- Arrow Setup -->
      <div class="card">
        <div class="card-header">
          <h3>Arrow Setup</h3>
          <button class="info-btn" type="button" data-info="arrowName">ⓘ</button>
        </div>

        <!-- Arrow name + spine aligned -->
        <div class="grid-2">
          <div>
            <label>
              Arrow Name
              <button class="info-btn" type="button" data-info="arrowName">ⓘ</button>
            </label>
            <input type="text" id="arrowName">
          </div>
          <div>
            <label>
              Arrow Spine Stiffness
              <button class="info-btn" type="button" data-info="arrowSpine">ⓘ</button>
            </label>
            <input type="number" id="arrowSpine" value="340" step="10">
          </div>
        </div>

        <div class="grid-2">
          <div>
            <label>
              Arrow Length (in)
              <button class="info-btn" type="button" data-info="arrowLength">ⓘ</button>
            </label>
            <input type="number" id="arrowLength" value="28.5" step="0.5">
          </div>
          <div>
            <label>
              Total Arrow Weight (gr)
              <button class="info-btn" type="button" data-info="totalArrowWeightSimple">ⓘ</button>
            </label>
            <input type="number" id="totalArrowWeightSimple" value="450" step="0.5">
            <small id="totalWeightHint"
                   style="display:block;margin-top:0.25rem;font-size:0.85rem;color:var(--light);">
            </small>
          </div>
          <div>
            <label>
              Point Weight (gr)
              <button class="info-btn" type="button" data-info="pointWeight">ⓘ</button>
            </label>
            <input type="number" id="pointWeight" value="150" step="0.5">
          </div>
          <div>
            <label>
              Balance Point (in)
              <button class="info-btn" type="button" data-info="balancePoint">ⓘ</button>
            </label>
            <input type="number" id="balancePoint" value="18.5" step="0.05">
          </div>
        </div>

        <div class="flex" style="margin-top:1rem;justify-content:space-between;">
          <label>
            Advanced Arrow Components
            <button class="info-btn" type="button" data-info="toggleArrow">ⓘ</button>
          </label>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleArrow"><span class="slider"></span>
          </label>
        </div>
        <div id="arrowAdvanced" class="advanced">
          <div class="grid-2">
            <div>
              <label>
                Bare Shaft
                <button class="info-btn" type="button" data-info="bareShaft">ⓘ</button>
              </label>
              <input type="number" id="bareShaft" value="0" step="0.1">
            </div>
            <div>
              <label>
                Nock System
                <button class="info-btn" type="button" data-info="nockWeight">ⓘ</button>
              </label>
              <input type="number" id="nockWeight" value="0" step="0.1">
            </div>
            <div>
              <label>
                Wrap
                <button class="info-btn" type="button" data-info="wrapWeight">ⓘ</button>
              </label>
              <input type="number" id="wrapWeight" value="0" step="0.1">
            </div>
            <div>
              <label>
                Vane Weight (each)
                <button class="info-btn" type="button" data-info="vaneWeightEach">ⓘ</button>
              </label>
              <input type="number" id="vaneWeightEach" value="0" step="0.1">
            </div>
            <div>
              <label>
                Vane Count
                <button class="info-btn" type="button" data-info="vaneCount">ⓘ</button>
              </label>
              <input type="number" id="vaneCount" value="0" step="1">
            </div>
            <div>
              <label>
                Insert/Outsert
                <button class="info-btn" type="button" data-info="insertWeight">ⓘ</button>
              </label>
              <input type="number" id="insertWeight" value="50" step="0.5">
            </div>
            <div>
              <label>
                Glue / Pin Nock
                <button class="info-btn" type="button" data-info="glueWeight">ⓘ</button>
              </label>
              <input type="number" id="glueWeight" value="0" step="0.5">
            </div>
          </div>
          <p style="text-align:right;font-weight:600;">
            Total: <span id="arrowTotal">0.0</span> grains
          </p>
        </div>
      </div>

      <!-- Notes -->
      <div class="card">
        <div class="card-header">
          <h3>Notes</h3>
          <button class="info-btn" type="button" data-info="notes">ⓘ</button>
        </div>
        <textarea id="notes" rows="4" placeholder="Tuning notes..."></textarea>
      </div>
    </div>

       <!-- RIGHT: OUTPUTS & ANALYSIS -->
      <div id="outputs-column">

        <!-- YOUR SETTINGS: Actual FPS + Crosswind + Distance -->
        <section class="card">
          <div class="card-header">
            <h2>Your Settings</h2>
            <button class="info-btn" type="button" data-info="velocitySection">ⓘ</button>
          </div>
          <p class="card-subtitle" style="font-size:0.9rem;color:var(--light);margin-bottom:0.75rem;">
            Adjust these values to drive the calculations to optimize your next shot.
          </p>

          <!-- FPS + Windage + Distance controls -->
          <div class="perf-grid">
            <!-- Row 1: FPS + Windage -->
            <div class="perf-top">
              <!-- FPS editable box -->
              <div class="perf-box">
                <div class="perf-label-row">
                  <div class="metric-title">
                    <span class="perf-label">Launch FPS</span>
                    <button class="info-btn small" type="button" data-info="actualFPS">ⓘ</button>
                    <button class="math-btn" type="button" data-math="fps">∑</button>
                  </div>
                  <!-- <span class="perf-edit-pill">editable</span> -->
                </div>
                <div class="perf-input-row">
                  <input
                    id="actualFPS"
                    type="number"
                    inputmode="decimal"
                    step="0.5"
                    min="100"
                    max="400"
                    placeholder="Estimate or chrono"
                  />
                  <button id="recalcFPS" type="button" class="secondary-btn small">
                    Calculate
                  </button>
                </div>
                <p class="perf-hint">
                  Type your real chrono speed, or tap <strong>Calc from Inputs</strong> to estimate.
                </p>
              </div>

              <!-- Windage editable box -->
              <div class="perf-box">
                <div class="perf-label-row">
                  <div class="metric-title">
                    <span class="perf-label">Crosswind</span>
                    <button class="info-btn small" type="button" data-info="windDrift">ⓘ</button>
                    <button class="math-btn" type="button" data-math="windDrift">∑</button>
                  </div>
                  <!-- <span class="perf-edit-pill">editable</span> -->
                </div>
                <div class="perf-input-row">
                  <input
                    id="windMph"
                    type="number"
                    inputmode="decimal"
                    step="0.5"
                    min="0"
                    value="0"
                  />
                  <span class="perf-unit">mph</span>
                </div>
                <p class="perf-hint">
                  Full-value side wind used for the drift estimate.
                </p>
              </div>
            </div>

            <!-- Row 2: Distance slider under both -->
            <div class="perf-slider-box">
              <div class="perf-slider-header">
                <div class="metric-title">
                  <span class="perf-slider-label">Distance</span>
                  <span class="perf-distance-value">
                    <span id="distanceValue">50</span> yd
                  </span>
                </div>
                <span class="perf-edit-pill">adjust</span>
              </div>
              <input
                id="distanceSlider"
                type="range"
                min="10"
                max="150"
                step="1"
                value="50"
              />
              <div class="distance-ticks" id="distanceTicks">
                <span>10</span><span>20</span><span>30</span><span>40</span>
                <span>50</span><span>60</span><span>70</span><span>80</span>
                <span>90</span><span>100</span><span>110</span><span>120</span>
                <span>130</span><span>140</span><span>150</span>
              </div>
            </div>
          </div>
        </section>

        <!-- PERFORMANCE CALCULATIONS -->
        <section class="card">
          <div class="card-header">
            <h2>Performance Calculations</h2>
            <button class="info-btn" type="button" data-info="performanceCalculations">ⓘ</button>
          </div>

          <!-- GAME EFFECTIVENESS / TARGET INSIGHTS FIRST -->
          <div class="subcard" id="gameCard" style="margin-top:0.25rem;">
            <div class="card-header compact" style="border-bottom:none;padding-bottom:0.25rem;margin-bottom:0.5rem;">
              <h3 id="gameCardTitle" style="margin:0;">Game Effectiveness</h3>
              <div style="display:flex;align-items:center;gap:0.35rem;">
                <button class="info-btn" type="button" data-info="gameEffectiveness">ⓘ</button>
                <button class="math-btn" type="button" data-math="game">∑</button>
              </div>
            </div>
        

            <!-- Hunting mode panel -->
            <div id="huntingMode">
              <div class="metric-grid">
                <div class="metric-tile">
                  <div class="metric-title">Small Game</div>
                  <div class="metric-main-value" style="font-size:2.2rem;">
                    <span id="smallGameStatus">–</span>
                  </div>
                  <p class="metric-note" style="font-size:0.8rem;color:var(--light);">
                    ~12+ ft-lbs KE (baseline).
                  </p>
                </div>

                <div class="metric-tile">
                  <div class="metric-title">Deer / Antelope</div>
                  <div class="metric-main-value" style="font-size:2.2rem;">
                    <span id="deerStatus">–</span>
                  </div>
                  <p class="metric-note" style="font-size:0.8rem;color:var(--light);">
                    ~25+ ft-lbs KE • ~0.30 slug·ft/s.
                  </p>
                </div>

                <div class="metric-tile">
                  <div class="metric-title">Elk / Large Game</div>
                  <div class="metric-main-value" style="font-size:2.2rem;">
                    <span id="elkStatus">–</span>
                  </div>
                  <p class="metric-note" style="font-size:0.8rem;color:var(--light);">
                    42–65 ft-lbs • 0.44–0.65 slug·ft/s.
                  </p>
                </div>

                <div class="metric-tile">
                  <div class="metric-title">Tough Game</div>
                  <div class="metric-main-value" style="font-size:2.2rem;">
                    <span id="mooseStatus">–</span>
                  </div>
                  <p class="metric-note" style="font-size:0.8rem;color:var(--light);">
                    65+ ft-lbs • 0.65+ slug·ft/s.
                  </p>
                </div>
              </div>

              <p id="gameMessage" class="metric-note" style="font-size:0.85rem;color:var(--light);margin-top:0.5rem;">
                Impact values are compared at the selected distance — a conservative “send it / adjust” helper, not a guarantee.
              </p>
            </div>

            <!-- Target / 3D mode panel -->
            <div id="targetMode" style="display:none; margin-top:0.75rem;">
              <div class="metric-grid">
                <div class="metric-tile">
                  <div class="metric-header-row" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.25rem;">
                    <div class="metric-title">
                      <span>Group Stability</span>
                      <button class="info-btn small" type="button" data-info="groupStability">ⓘ</button>
                      <button class="math-btn" type="button" data-math="groupStability">∑</button>
                    </div>
                  </div>
                  <div class="metric-main-value" style="font-size:2.2rem;">
                    <span id="groupStabilityBadge">–</span>
                  </div>
                  <p class="metric-note" style="font-size:0.85rem;color:var(--light);margin-top:0.35rem;">
                    Uses FPS, FOC, and GPI to approximate how forgiving this build should feel.
                  </p>
                </div>

                <div class="metric-tile">
                  <div class="metric-header-row" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.25rem;">
                    <div class="metric-title">
                      <span>Flatness Score</span>
                      <button class="info-btn small" type="button" data-info="flatnessScore">ⓘ</button>
                      <button class="math-btn" type="button" data-math="flatnessScore">∑</button>
                    </div>
                  </div>
                  <div class="metric-main-value" style="font-size:2.2rem;">
                    <span id="flatnessScoreValue">–</span>
                  </div>
                  <p class="metric-note" style="font-size:0.85rem;color:var(--light);margin-top:0.35rem;">
                    Based on extra drop from 20 → 60 yd (Very Flat / Flat / Curved).
                  </p>
                </div>
              </div>

              <div class="drop-table" style="margin-top:0.75rem;">
                <div class="metric-header-row" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.25rem;">
                  <div class="metric-title">
                    <span>Downrange Arrow Drop</span>
                    <button class="info-btn small" type="button" data-info="sightMarks">ⓘ</button>
                  </div>
                </div>
                <table class="data-table" id="dropTable">
                  <thead>
                    <tr>
                      <th>Distance</th>
                      <th>Drop (inches)</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- filled by script -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Velocity + Peak Height row -->
          <div class="metric-grid" style="margin-top:1.25rem;">
            <div class="metric-tile">
              <div class="metric-header-row">
                <div class="metric-title">
                  <span>Velocity @ <span id="velocityDistanceLabel">50</span> yd</span>
                  <button class="info-btn small" type="button" data-info="velocityAtDistance">ⓘ</button>
                  <button class="math-btn" type="button" data-math="velocity">∑</button>
                </div>
              </div>
              <div class="metric-main-value" style="font-size:2rem;display:flex;align-items:baseline;gap:0.25rem;">
                <span id="velocityAtDistance">-</span>
                <span class="metric-unit" style="font-size:0.9rem;color:var(--light);">FPS</span>
              </div>
              <p class="metric-note" style="font-size:0.85rem;color:var(--light);margin-top:0.35rem;">
                Estimated speed at selected distance.
              </p>
            </div>

            <div class="metric-tile">
              <div class="metric-header-row">
                <div class="metric-title">
                  <span>Peak Height</span>
                  <button class="info-btn small" type="button" data-info="peakHeight">ⓘ</button>
                  <button class="math-btn" type="button" data-math="peakHeight">∑</button>
                </div>
              </div>
              <div class="metric-main-value" style="font-size:2rem;display:flex;align-items:baseline;gap:0.25rem;">
                <span id="peakHeightValue">-</span>
                <span class="metric-unit" style="font-size:0.9rem;color:var(--light);">ft</span>
              </div>
              <p class="metric-note" style="font-size:0.85rem;color:var(--light);margin-top:0.35rem;">
                Apex around <span id="peakDistanceValue">25</span> yd above a flat launch line.
              </p>
            </div>
          </div>

          <!-- KE / Time / Impact metrics -->
          <div class="metric-grid">
            <div class="metric-tile">
              <div class="metric-header-row">
                <div class="metric-title">
                  <span>Launch KE</span>
                  <button class="info-btn small" type="button" data-info="launchKE">ⓘ</button>
                  <button class="math-btn" type="button" data-math="keLaunch">∑</button>
                </div>
              </div>
              <div class="metric-main-value" style="font-size:2rem;display:flex;align-items:baseline;gap:0.25rem;">
                <span id="keValue">-</span>
                <span class="metric-unit" style="font-size:0.9rem;color:var(--light);">ft-lbs</span>
              </div>
              <p class="metric-note" style="font-size:0.85rem;color:var(--light);margin-top:0.35rem;">
                Energy at the bow.
              </p>
            </div>

            <div class="metric-tile">
              <div class="metric-header-row">
                <div class="metric-title">
                  <span>Time to Impact</span>
                  <button class="info-btn small" type="button" data-info="timeToImpact">ⓘ</button>
                  <button class="math-btn" type="button" data-math="timeToImpact">∑</button>
                </div>
              </div>
              <div class="metric-main-value" style="font-size:2rem;display:flex;align-items:baseline;gap:0.25rem;">
                <span id="timeToImpact">-</span>
                <span class="metric-unit" style="font-size:0.9rem;color:var(--light);">sec</span>
              </div>
              <p class="metric-note" style="font-size:0.85rem;color:var(--light);margin-top:0.35rem;">
                How long the arrow is in the air.
              </p>
            </div>

            <div class="metric-tile">
              <div class="metric-header-row">
                <div class="metric-title">
                  <span>Impact KE</span>
                  <button class="info-btn small" type="button" data-info="impactKE">ⓘ</button>
                  <button class="math-btn" type="button" data-math="impactKE">∑</button>
                </div>
              </div>
              <div class="metric-main-value" style="font-size:2rem;display:flex;align-items:baseline;gap:0.25rem;">
                <span id="impactKE">-</span>
                <span class="metric-unit" style="font-size:0.9rem;color:var(--light);">ft-lbs</span>
              </div>
              <p class="metric-note" style="font-size:0.85rem;color:var(--light);margin-top:0.35rem;">
                Energy at the selected distance.
              </p>
            </div>

            <div class="metric-tile">
              <div class="metric-header-row">
                <div class="metric-title">
                  <span>Impact Momentum</span>
                  <button class="info-btn small" type="button" data-info="impactMom">ⓘ</button>
                  <button class="math-btn" type="button" data-math="impactMom">∑</button>
                </div>
              </div>
              <div class="metric-main-value" style="font-size:2rem;display:flex;align-items:baseline;gap:0.25rem;">
                <span id="impactMom">-</span>
                <span class="metric-unit" style="font-size:0.9rem;color:var(--light);">slug·ft/s</span>
              </div>
              <p class="metric-note" style="font-size:0.85rem;color:var(--light);margin-top:0.35rem;">
                Momentum at the selected distance.
              </p>
            </div>
          </div>

          <!-- Stiffness / Wind drift row -->
          <div class="metric-grid">
            <div class="metric-tile">
              <div class="metric-header-row">
                <div class="metric-title">
                  <span>Stiffness / Forgiveness</span>
                  <button class="info-btn small" type="button" data-info="stiffness">ⓘ</button>
                  <button class="math-btn" type="button" data-math="stiffness">∑</button>
                </div>
              </div>
              <div class="metric-main-value" style="font-size:2rem;display:flex;align-items:baseline;gap:0.25rem;">
                <span id="stiffnessBadge">–</span>
              </div>
              <p id="stiffnessHint" class="metric-note" style="font-size:0.85rem;color:var(--light);margin-top:0.35rem;">
                Enter draw, length, spine, and point weight to see a chart-style match.
              </p>
            </div>

            <div class="metric-tile">
              <div class="metric-header-row">
                <div class="metric-title">
                  <span>Wind Drift</span>
                  <button class="info-btn small" type="button" data-info="windDrift">ⓘ</button>
                  <button class="math-btn" type="button" data-math="windDrift">∑</button>
                </div>
              </div>
              <div class="metric-main-value" style="font-size:2rem;display:flex;align-items:baseline;gap:0.25rem;">
                <span id="windDriftValue">-</span>
                <span class="metric-unit" style="font-size:0.9rem;color:var(--light);">in</span>
              </div>
              <p class="metric-note" style="font-size:0.85rem;color:var(--light);margin-top:0.35rem;">
                Approximate side drift at the selected distance & wind.
              </p>
            </div>
          </div>
        </section>

        <!-- ARROW EFFICIENCY BETWEEN PERFORMANCE & BUILD SUMMARY -->
        <section class="card">
          <div class="card-header">
            <h2>Arrow Efficiency</h2>
            <button class="info-btn" type="button" data-info="arrowEfficiency">ⓘ</button>
          </div>

          <div class="metric-grid">
            <!-- GPP -->
            <div class="metric-tile">
              <div class="metric-header-row">
                <div class="metric-title">
                  <span>GPP</span>
                  <button class="info-btn small" type="button" data-info="gpp">ⓘ</button>
                  <button class="math-btn" type="button" data-math="gpp">∑</button>
                </div>
              </div>
              <div class="metric-main-value">
                <span id="gppValue">-</span>
                <span class="metric-unit">gr/lb</span>
              </div>
              <p id="gppHint" class="metric-note">
                <!-- script fills: light / all-around / heavy -->
              </p>
            </div>

            <!-- GPI -->
            <div class="metric-tile">
              <div class="metric-header-row">
                <div class="metric-title">
                  <span>GPI</span>
                  <button class="info-btn small" type="button" data-info="gpi">ⓘ</button>
                  <button class="math-btn" type="button" data-math="gpi">∑</button>
                </div>
              </div>
              <div class="metric-main-value">
                <span id="gpiValue">-</span>
                <span class="metric-unit">gr/in</span>
              </div>
              <p class="metric-note">
                Grains per inch based on finished arrow.
              </p>
            </div>

            <!-- Total Weight (TW) -->
            <div class="metric-tile">
              <div class="metric-header-row">
                <div class="metric-title">
                  <span>TW</span>
                  <button class="info-btn small" type="button" data-info="finalArrowWeight">ⓘ</button>
                  <button class="math-btn" type="button" data-math="tw">∑</button>
                </div>
              </div>
              <div class="metric-main-value">
                <span id="finalArrowWeight">-</span>
                <span class="metric-unit">gr</span>
              </div>
              <p class="metric-note">
                Total finished arrow weight.
              </p>
            </div>

            <!-- FOC -->
            <div class="metric-tile">
              <div class="metric-header-row">
                <div class="metric-title">
                  <span>FOC</span>
                  <button class="info-btn small" type="button" data-info="foc">ⓘ</button>
                  <button class="math-btn" type="button" data-math="foc">∑</button>
                </div>
              </div>
              <div class="metric-main-value">
                <span id="focValue">-</span>
                <span class="metric-unit">%</span>
              </div>
              <div class="foc-bar-wrapper" style="margin-top:0.25rem;">
                <div class="foc-bar-track" style="position:relative;height:10px;border-radius:999px;background:var(--bg);overflow:hidden;">
                  <div class="foc-bar-fill" id="focBarFill" style="position:absolute;left:0;top:0;bottom:0;border-radius:999px;background:var(--primary);opacity:0.25;width:0%;"></div>
                  <div class="foc-ideal-range" style="position:absolute;top:1px;bottom:1px;border-radius:999px;background:var(--success);opacity:0.25;left:40%;width:20%;"></div>
                  <div class="foc-marker" id="focMarker" style="position:absolute;top:-4px;width:0;height:18px;border-left:2px solid var(--primary);"></div>
                </div>
                <div class="foc-bar-labels" style="display:flex;justify-content:space-between;font-size:0.8rem;color:var(--light);margin-top:0.25rem;">
                  <span>0%</span>
                  <span>30%</span>
                </div>
              </div>
              <p id="focHint" class="metric-note">
                <!-- script sets guidance -->
              </p>
            </div>

            <!-- Arrow Weight Composition (AWC) spans both columns -->
            <div class="metric-tile awc-wide">
              <div class="metric-header-row">
                <div class="metric-title">
                  <span>AWC</span>
                  <button class="info-btn small" type="button" data-info="composition">ⓘ</button>
                  <button class="math-btn" type="button" data-math="awc">∑</button>
                </div>
              </div>
              <div class="comp-bar-track" style="position:relative;height:10px;border-radius:999px;background:var(--bg);overflow:hidden;display:flex;">
                <div class="comp-seg comp-seg-shaft" id="compShaftSeg" style="height:100%;"></div>
                <div class="comp-seg comp-seg-point" id="compPointSeg" style="height:100%;"></div>
                <div class="comp-seg comp-seg-other" id="compOtherSeg" style="height:100%;"></div>
              </div>
              <p id="compTotalLabel" class="metric-note" style="margin-top:0.35rem;">
                Shaft: 0% • Point: 0% • Components: 0%
              </p>
              <div class="comp-legend">
                <span><span class="comp-dot comp-dot-shaft"></span><span id="shaftPctLabel">Shaft: 0%</span></span>
                <span><span class="comp-dot comp-dot-point"></span><span id="pointPctLabel">Point: 0%</span></span>
                <span><span class="comp-dot comp-dot-other"></span><span id="compPctLabel">Comp.: 0%</span></span>
              </div>
            </div>
          </div>
        </section>

        <!-- BUILD SUMMARY LAST -->
        <section class="card">
          <div class="card-header">
            <h2>Build Summary</h2>
            <button class="info-btn" type="button" data-info="buildSummary">ⓘ</button>
          </div>

          <div class="build-summary" id="summaryTable">
            <!-- script injects <table>...</table> -->
          </div>
          <button id="copySummary" type="button" class="btn-small" style="margin-top:0.75rem;">
            Copy
          </button>
        </section>

        <!-- Patreon / Support link -->
        <a
          class="patreon-btn"
          href="https://patreon.com/ArrowTuneCalculator?utm_medium=unknown&utm_source=join_link&utm_campaign=creatorshare_creator&utm_content=copyLink"
          target="_blank"
          rel="noopener noreferrer"
        >
          Support the project on Patreon ❤️
        </a>
      </div> <!-- end outputs-column -->
    </div> <!-- end container -->

    <!-- Math Popup -->
    <div class="info-overlay" id="mathOverlay">
      <div class="info-panel" id="mathPanel">
        <button class="info-close" id="mathClose">&times;</button>
        <h2>Math Details</h2>
        <div id="mathContent"></div>
      </div>
    </div>

    <!-- Info Popup -->
    <div class="info-overlay" id="infoOverlay">
      <div class="info-panel" id="infoPanel">
        <button class="info-close" id="infoClose">&times;</button>
        <h2 id="infoTitle"></h2>
        <div id="infoBody"></div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <!-- SCRIPT SECTION BEGIN -->
<script>
/* ============================================================
   VARIABLES + UTILITIES
============================================================ */
const $ = (id) => document.getElementById(id);

// Inputs
const bowModelEl = $("bowModel");
const iboEl = $("iboRating");
const drawWeightEl = $("drawWeight");
const drawLengthEl = $("drawLength");

const stringSimpleEl = $("stringWeightSimple");
const toggleStringEl = $("toggleString");
const peepEl = $("peepWeight");
const dloopEl = $("dloopWeight");
const kisserEl = $("kisserWeight");
const silencersEl = $("silencersWeight");
const stringAdvTotalEl = $("stringTotal");

const arrowNameEl = $("arrowName");
const arrowSpineEl = $("arrowSpine");
const arrowLengthEl = $("arrowLength");
const totalArrowWeightSimpleEl = $("totalArrowWeightSimple");
const pointWeightEl = $("pointWeight");
const balancePointEl = $("balancePoint");

const toggleArrowEl = $("toggleArrow");
const bareShaftEl = $("bareShaft");
const nockWeightEl = $("nockWeight");
const wrapWeightEl = $("wrapWeight");
const vaneWeightEachEl = $("vaneWeightEach");
const vaneCountEl = $("vaneCount");
const insertWeightEl = $("insertWeight");
const glueWeightEl = $("glueWeight");

const applicationEl = $("application");

const notesEl = $("notes");

// Performance inputs
const distanceSliderEl = $("distanceSlider");
const windMphEl = $("windMph");

// Outputs
const fpsEl = $("actualFPS");
const fpsSourceEl = $("fpsSource");
const gppValueEl = $("gppValue");
const gpiValueEl = $("gpiValue");
const twEl = $("finalArrowWeight");

const focValueEl = $("focValue");
const focBarFillEl = $("focBarFill");
const focMarkerEl = $("focMarker");
const focHintEl = $("focHint");

const compShaftSegEl = $("compShaftSeg");
const compPointSegEl = $("compPointSeg");
const compOtherSegEl = $("compOtherSeg");
const compTotalLabelEl = $("compTotalLabel");
const shaftPctLabelEl = $("shaftPctLabel");
const pointPctLabelEl = $("pointPctLabel");
const compPctLabelEl = $("compPctLabel");

const velocityAtDistanceEl = $("velocityAtDistance");
const peakHeightValueEl = $("peakHeightValue");
const peakDistanceValueEl = $("peakDistanceValue");
const keValueEl = $("keValue");
const timeToImpactEl = $("timeToImpact");
const impactKEEl = $("impactKE");
const impactMomEl = $("impactMom");
const windDriftValueEl = $("windDriftValue");
const distanceValueEl = $("distanceValue");

// Spine + Game + Target Outputs
const stiffnessBadgeEl = $("stiffnessBadge");
const stiffnessHintEl = $("stiffnessHint");

const smallStatusEl = $("smallGameStatus");
const deerStatusEl = $("deerStatus");
const elkStatusEl = $("elkStatus");
const mooseStatusEl = $("mooseStatus");
const gameMessageEl = $("gameMessage");

// Target Insights – tolerate different ID variants
const groupStabilityBadgeEl =
  $("groupStabilityBadge") ||
  $("groupStabilityValue") ||
  $("groupStability");

const flatnessScoreValueEl =
  $("flatnessScoreValue") ||
  $("flatnessScore") ||
  $("flatnessValue");

const dropTableEl = $("dropTable").querySelector("tbody");

// Build Summary
const summaryTableEl = $("summaryTable");
const copySummaryBtn = $("copySummary");

const infoOverlay = $("infoOverlay");
const infoPanel = $("infoPanel");
const infoTitle = $("infoTitle");
const infoBody = $("infoBody");
const infoClose = $("infoClose");

const mathOverlay = $("mathOverlay");
const mathPanel = $("mathPanel");
const mathClose = $("mathClose");
const mathContent = $("mathContent");

// TOAST
const toast = $("toast");

/* ============================================================
   INFO CONTENT
============================================================ */

const INFO_CONTENT = {
  buildName: `
    <h2>Build Name</h2>
    <p>
      A human-friendly label for this bow + arrow setup. It’s used as the name
      when you save, load, and compare builds.
    </p>
    <p>
      The <strong>Suggest</strong> button auto-builds a name using date, bow model,
      draw weight, arrow name, and total arrow weight so your builds stay organized.
    </p>
  `,
  bowModel: `
    <h2>Bow Model</h2>
    <p>
      The make and model of your bow (e.g., "2025 Hoyt RX-9").
      This is saved with the build and used in the suggested build name.
    </p>
    <p>
      It doesn’t change the math directly, but it makes it easier to track which
      numbers go with which bow.
    </p>
  `,
  iboRating: `
    <h2>IBO / ATA Speed Rating</h2>
    <p>
      The manufacturer’s advertised max speed in feet per second (FPS), usually at
      70 lb draw, 30&quot; draw length, and a 350 gr arrow.
    </p>
    <p>
      This app uses that rating to <strong>estimate your real-world launch FPS</strong>
      until you replace it with chronograph data.
    </p>
  `,
  drawWeight: `
    <h2>Draw Weight (lbs)</h2>
    <p>
      How many pounds you pull at full draw. It controls how much energy the bow can
      put into the arrow.
    </p>
    <p>
      In this calculator, draw weight is used with total arrow weight to compute
      <strong>GPP (grains per pound)</strong>, which helps classify your arrow as
      light, all-around, or heavy for hunting and penetration.
    </p>
  `,
  drawLength: `
    <h2>Draw Length (inches)</h2>
    <p>
      How far you pull the string at full draw (your personal power stroke).
      Factory IBO speeds assume 30&quot; draw; shorter draws usually shoot slower.
    </p>
    <p>
      This value is saved with your build so your FPS, KE, and trajectory can be
      interpreted in the context of <em>your</em> form, not just factory specs.
    </p>
  `,
  stringWeightSimple: `
    <h2>String Add-ons (grains)</h2>
    <p>
      The combined weight of everything on your string (peep, loop, kisser, silencers),
      entered as a single number.
    </p>
    <p>
      This is used in the launch FPS estimate. Heavier strings generally reduce
      real-world FPS slightly compared to the IBO rating.
    </p>
    <p>
      Turn on <strong>Advanced String Components</strong> if you want to enter each
      piece separately.
    </p>
  `,
  application: `
    <h2>Application</h2>
    <p>
      High-level use for this setup: Target/3D, Hunting, or Other. This is saved in your
      build and is used to switch between <strong>Game Effectiveness</strong> (Hunting)
      and <strong>Target Insights</strong> (Target / Other).
    </p>
    <p>
      It does not change the underlying physics, but it changes how the results are
      summarized for you.
    </p>
  `,
  toggleString: `
    <h2>Advanced String Components</h2>
    <p>
      Turn this on if you want to enter the weights of your peep, D-loop, kisser, and
      silencers separately.
    </p>
    <p>
      When enabled, the app <strong>sums the detailed values</strong> and uses that
      total in the FPS estimate instead of the single String Add-ons field.
    </p>
  `,
  peepWeight: `
    <h2>Peep Weight</h2>
    <p>
      Weight of your peep sight in grains. Included in total string weight and the
      launch FPS estimate when Advanced String Components are enabled.
    </p>
  `,
  dloopWeight: `
    <h2>D-Loop Weight</h2>
    <p>
      Total weight of your D-loop in grains. Included in total string weight and the
      launch FPS estimate in Advanced mode.
    </p>
  `,
  kisserWeight: `
    <h2>Kisser Button Weight</h2>
    <p>
      Weight of your kisser button in grains. Included in total string weight and FPS
      estimation when using Advanced String Components.
    </p>
  `,
  silencersWeight: `
    <h2>Silencers Weight</h2>
    <p>
      Combined weight of all string silencers in grains. Included in total string
      weight and launch FPS estimation in Advanced mode.
    </p>
  `,
  arrowName: `
    <h2>Arrow Name</h2>
    <p>
      A label for the arrow itself (e.g., "Easton Axis 5mm 300 spine").
      Used in the suggested build name and saved with the build.
    </p>
    <p>
      It doesn’t change calculations, but makes it much easier to track which shaft
      you’re tuning.
    </p>
  `,
  arrowSpine: `
    <h2>Arrow Spine Stiffness</h2>
    <p>
      The <strong>static spine rating</strong> printed on your shaft (e.g., 250, 300, etc).
    </p>
    <p>
      The Stiffness / Forgiveness card compares this value to a chart-style
      recommendation based on draw weight, arrow length, and point weight.
    </p>
    <p>
      If it shows <strong>Adjust</strong>, consider:
    </p>
    <ul style="margin-left:1.25rem;">
      <li>moving closer or limiting your max range</li>
      <li>changing point weight</li>
      <li>moving to a stiffer or weaker spine as indicated</li>
    </ul>
  `,
  arrowLength: `
    <h2>Arrow Length</h2>
    <p>
      Measured from the throat of the nock to the <strong>end of the shaft</strong>
      (not including the point).
    </p>
    <p>
      This is used for <strong>GPI (grains per inch)</strong> and for the
      <strong>FOC calculation</strong> so the app knows the total shaft length
      your balance point is measured over.
    </p>
  `,
  totalArrowWeightSimple: `
    <h2>Total Arrow Weight (Simple Mode)</h2>
    <p>
      The full arrow weight in grains (shaft + insert/outsert + vanes + wrap + nock + point),
      entered as a single number.
    </p>
    <p>
      When Advanced Arrow Components is <strong>off</strong>, this value drives all
      weight-based metrics: GPP, KE, momentum, impact energy, and Build Summary.
    </p>
    <p>
      Turn on Advanced mode if you want the app to calculate total weight from individual components.
    </p>
  `,
  pointWeight: `
    <h2>Point Weight</h2>
    <p>
      Weight of your field point or broadhead in grains.
    </p>
    <p>
      Used in the <strong>FOC calculation</strong>, the
      <strong>Arrow Weight Composition</strong> bar, and total arrow weight
      when Advanced mode is enabled.
    </p>
  `,
  balancePoint: `
    <h2>Balance Point from Nock</h2>
    <p>
      Measure from the nock throat (string contact point) to the point where the
      arrow balances perfectly on a finger or edge.
    </p>
    <p>
      This value, together with arrow length, is used to compute
      <strong>FOC (Front of Center)</strong>.
    </p>
  `,
  toggleArrow: `
    <h2>Advanced Arrow Components</h2>
    <p>
      Enable this if you want to enter the weights of the shaft, vanes, wrap, insert,
      nock, and glue separately.
    </p>
    <p>
      In Advanced mode, the app <strong>adds up all components plus point weight</strong>
      to get total arrow weight instead of using the single Total Arrow Weight field.
    </p>
  `,
  bareShaft: `
    <h2>Bare Shaft Weight</h2>
    <p>
      Weight of the cut shaft only (no insert, vanes, wrap, nock, or point).
    </p>
    <p>
      Used in the total arrow weight and the shaft portion of the
      <strong>Arrow Weight Composition</strong> bar.
    </p>
  `,
  nockWeight: `
    <h2>Nock System Weight</h2>
    <p>
      Weight of your nock or pin-nock system in grains.
    </p>
    <p>
      Included in total arrow weight and counted as part of “Components” in the
      Arrow Weight Composition bar.
    </p>
  `,
  wrapWeight: `
    <h2>Wrap Weight</h2>
    <p>
      Total weight of any arrow wrap or cap wrap in grains.
    </p>
    <p>
      Included in total arrow weight and treated as “Components” in the composition bar.
    </p>
  `,
  vaneWeightEach: `
    <h2>Vane Weight (each)</h2>
    <p>
      Weight of a single vane or feather in grains.
    </p>
    <p>
      The app multiplies this by <strong>Vane Count</strong>, then adds it to total arrow
      weight as part of “Components”.
    </p>
  `,
  vaneCount: `
    <h2>Vane Count</h2>
    <p>
      How many vanes or feathers are on the arrow (3-fletch, 4-fletch, etc.).
    </p>
    <p>
      Used with Vane Weight (each) to compute total fletching weight for the
      arrow weight and composition breakdown.
    </p>
  `,
  insertWeight: `
    <h2>Insert / Outsert Weight</h2>
    <p>
      Weight of your insert or outsert system in grains.
    </p>
    <p>
      Included in total arrow weight and treated as “Components” in the
      Arrow Weight Composition bar.
    </p>
  `,
  glueWeight: `
    <h2>Glue / Pin Nock Weight</h2>
    <p>
      An estimate of the combined weight of glue, pin bushings, and any small
      hardware at the nock or insert end.
    </p>
    <p>
      Included in total arrow weight and the “Components” portion of the composition bar.
    </p>
  `,
  notes: `
    <h2>Notes</h2>
    <p>
      Free-form notes saved with this build — great for recording paper tune results,
      broadhead groups, chrono strings, or field observations.
    </p>
    <p>
      Notes are stored in your saved build so you can revisit why a setup worked
      (or didn’t) later.
    </p>
  `,
  arrowEfficiency: `
    <h2>Arrow Efficiency</h2>
    <p>
      A quick overview of how your bow’s energy, arrow weight, and balance are working together.
    </p>
    <p>
      This section summarizes your main tuning metrics: launch speed, GPP, GPI, total arrow weight,
      FOC, and component breakdown.
    </p>
  `,
  yourSettings: `
    <h2>Your Settings</h2>
    <p>
      This section contains the <strong>inputs you can directly adjust</strong> to shape 
      the rest of the performance calculations.
    </p>

    <p><strong>Launch FPS</strong> – Enter your chronographed speed, or let the app estimate it from your IBO rating with simple rule-of-thumb adjustments for draw weight, draw length, arrow weight, and string add-ons. Always trust your chrono over the estimate when you have it.</p>

    <p><strong>Crosswind (mph)</strong> – A full-value side wind used for the Wind Drift estimate. Changing this helps visualize how stable your arrow is downrange.</p>

    <p><strong>Distance Slider</strong> – Sets the target yardage for all calculations below, including velocity at distance, peak height, time of flight, energy, momentum, and effectiveness.</p>

    <p>
      Think of this group as your <strong>primary tuning controls</strong>: adjust them to see 
      how your build behaves in real-world shooting conditions.
    </p>
  `,
    velocitySection: `
    <h2>Performance @ Distance</h2>
    <p>
      This card shows how your arrow behaves at the <strong>current distance</strong>
      you’ve set (with the slider or by typing a yardage).
    </p>
    <p>It pulls everything together from your build:</p>
    <ul style="margin-left:1.25rem;">
      <li><strong>Velocity</strong> – estimated arrow speed at that yardage.</li>
      <li><strong>Peak Height</strong> – how high the arrow arcs above a
          level launch line before dropping back toward the target.</li>
      <li><strong>Time to Impact</strong> – how long the arrow is in the air.</li>
      <li><strong>Impact KE & Momentum</strong> – energy and momentum carried into the target.</li>
      <li><strong>Wind Drift</strong> – side drift from a full-value crosswind you set in mph.</li>
    </ul>
    <p>
      Use this as your <strong>“real-world feel” panel</strong>:
      slide (or type) the distance, tweak launch FPS or arrow weight, and watch how
      the arc, impact numbers, and drift change together.
    </p>
    <p>
      The math behind each tile is available with the small 
      <strong>Math</strong> buttons, so you can see the exact formulas and
      how your numbers plug into them.
    </p>
  `,
    performance: `
    <h2>Performance @ Distance</h2>
    <p>
      Same as the <strong>Performance @ Distance</strong> card: it shows
      velocity, arc height, time-of-flight, impact KE/momentum, and wind drift
      at the distance you’ve set.
    </p>
    <p>
      Adjust the yardage, launch FPS, or arrow build and watch how the
      numbers change. Use it as a quick, visual way to compare setups.
    </p>
  `,
  performanceCalculations: `
    <h2>Performance Calculations</h2>
    <p>
      These are the physics-based estimates for how your arrow flies and hits
      at the distance you’ve chosen. They pull directly from your launch FPS,
      arrow weight, and the simple ballistic models described in each Math popup.
    </p>
    <p>
      Treat them as <strong>sanity checks and comparison tools</strong>, not
      replacements for real shooting and sight tape work.
    </p>
  `,
  actualFPS: `
    <h2>FPS</h2>
    <p>
      The speed the arrow leaves the bow, in feet per second.
    </p>
    <p>
      If you don’t have chronograph data yet, the app makes a <strong>ballpark estimate</strong>
      from your IBO rating and simple adjustments for draw weight, draw length, arrow weight,
      and string add-ons.
    </p>
    <p>
      It’s meant to get you close enough to compare builds and see trends – not to replace a
      real chrono. When you do have chrono numbers, enter them here and the calculator will
      treat that as the source of truth.
    </p>
  `,
  gpp: `
    <h2>GPP (Grains per Pound)</h2>
    <p>
      Total arrow weight divided by draw weight (grains per pound of draw).
    </p>
    <p>
      It’s a simple way to see if your arrow is light, all-around, or heavy for your bow.
      The app uses this to give guidance on where your setup sits in that spectrum.
    </p>
  `,
  gpi: `
    <h2>GPI (Grains per Inch)</h2>
    <p>
      Average grains per inch of length based on your total arrow weight and arrow length.
    </p>
    <p>
      Useful for comparing shafts and seeing how heavy your finished arrow is per inch,
      especially when switching between cut lengths.
    </p>
  `,
  finalArrowWeight: `
    <h2>TW (Total Weight)</h2>
    <p>
      The final arrow weight in grains (shaft + components + point).
    </p>
    <p>
      This drives nearly every other output: GPP, KE, momentum, impact, and the composition bar.
      Getting this number accurate is critical for realistic results.
    </p>
  `,
  foc: `
    <h2>FOC (Front of Center)</h2>
    <p>
      FOC shows how far forward the balance point is, expressed as a percentage of arrow length.
      More weight toward the front usually helps broadhead stability and penetration.
    </p>
    <p>
      The bar shows your value on a 0–30% scale, with a highlighted band for
      <strong>12–18%</strong>, a common sweet spot for many hunting setups.
    </p>
  `,
  composition: `
    <h2>AWC (Arrow Weight Composition)</h2>
    <p>
      A visual breakdown of how your arrow’s total weight is split between
      <strong>shaft</strong>, <strong>point</strong>, and other components.
    </p>
    <p>
      This is helpful for understanding where your mass is concentrated, and how changing
      inserts, vanes, or point weight affects overall build and FOC.
    </p>
  `,
  velocitySection: `
    <h2>Performance @ Distance</h2>
    <p>
      Use the slider to set a target distance. The app then estimates:
      arrow speed at that distance, peak height of the arc, time of flight,
      and impact energy/momentum.
    </p>
    <p>
      Great for visualizing how your arrow behaves at different ranges and 
      how much it slows down over distance.
    </p>
  `,
    velocityAtDistance: `
    <h2>Velocity</h2>
    <p>
      Estimated arrow speed at the selected yardage based on your launch FPS and
      a simple decay model that <strong>scales with arrow weight</strong>.
      Lighter arrows (lower GPP) shed speed faster; heavier arrows hang onto
      speed a bit longer.
    </p>
    <p>
      Under the hood the calculator uses an exponential curve:
      v(d) = v₀ × e^(−d / L), where <strong>L</strong> is an effective
      “speed-retention distance” in yards. L is tuned from your
      grains-per-pound (GPP) so it behaves like common hunting setups:
    </p>
    <ul style="margin-left:1.25rem;">
      <li>~5–6 GPP → shorter L (faster speed loss)</li>
      <li>~7 GPP → mid L (neutral reference)</li>
      <li>~8–9 GPP → longer L (better speed retention)</li>
    </ul>
    <p>
      This feeds the impact KE and momentum calculations and gives you a feel
      for how much speed you’re giving up as range increases.
    </p>
  `,
  timeToImpact: `
    <h2>Time to Impact</h2>
    <p>
      Estimated time (in seconds) for the arrow to reach the target at the current
      distance slider setting.
    </p>
    <p>
      This gives a feel for how “snappy” or “loopy” your setup is, and is useful when
      thinking about animal movement and string jump.
    </p>
  `,
  impactKE: `
    <h2>Impact Kinetic Energy</h2>
    <p>
      The arrow’s kinetic energy at the target distance in ft-lbs, using the
      estimated velocity at that distance.
    </p>
    <p>
      This value is compared against common minimums in the <strong>Game Effectiveness</strong>
      section to give a rough “Send it / Adjust” suggestion.
    </p>
  `,
  impactMom: `
    <h2>Impact Momentum</h2>
    <p>
      The arrow’s momentum at impact in slug·ft/s.
    </p>
    <p>
      Momentum favors heavier arrows and is another way to evaluate penetration potential,
      especially at longer distances.
    </p>
  `,
  windDrift: `
    <h2>Wind Drift</h2>
    <p>
      Approximate side drift (in inches) from a full-value crosswind at the
      selected distance.
    </p>
    <p>
      Model: drift ≈ 0.065 × distance² × wind / arrowWeight
    </p>
    <p>
      This scales realistically with distance, wind speed, and arrow mass:
      heavier arrows drift less; lighter arrows drift more.
    </p>
    <p>
      If you see big drift values, consider:
    </p>
    <ul style="margin-left:1.25rem;">
      <li>moving closer for windy shots</li>
      <li>increasing arrow mass</li>
      <li>reducing effective crosswind (shooting with the wind, not against it)</li>
    </ul>
  `,
  gameEffectiveness: `
    <h2>Game Effectiveness / Target Insights</h2>
    <p>
      In <strong>Hunting</strong> mode, this compares your impact <strong>kinetic energy</strong> and
      <strong>momentum</strong> at the chosen distance against conservative thresholds
      for four game classes.
    </p>
    <p>
      If a tile shows <strong>Adjust</strong>, think in terms of options:
    </p>
    <ul style="margin-left:1.25rem;">
      <li>move closer to reduce distance and drift</li>
      <li>increase arrow weight or optimize FOC</li>
      <li>tune your spine (stiffer or weaker as indicated)</li>
    </ul>
    <p>
      In <strong>Target / 3D / Other</strong> modes, this panel switches to 
      <strong>Target Insights</strong>:
    </p>
    <ul  style="margin-left:1.25rem;">
      <li>Group Stability badge (Tight / Average) based on FPS, FOC, and GPI.</li>
      <li>Flatness score using a simple 60 yd arc approximation.</li>
      <li>Downrange Arrow Drop simulator: relative drop from a 20 yd zero at 30–70 yd.</li>
    </ul>
    <p>
      Think of both views as <strong>sanity checks and tuning helpers</strong>, not guarantees.
      Broadhead design, shot angle, flight quality, and shot placement still matter more
      than any single number.
    </p>
  `,
  groupStability: `
    <h2>Group Stability (Target / 3D)</h2>
    <p>
      This badge is a <strong>sanity check</strong> for how forgiving your setup
      should feel on paper when tuned well and shot with good form.
    </p>
    <p>It looks at three things together:</p>
    <ul style="margin-left:1.25rem;">
      <li><strong>FPS</strong> – overall launch speed of the arrow.</li>
      <li><strong>FOC</strong> – how far forward the balance point is.</li>
      <li><strong>GPI</strong> – finished grains-per-inch of arrow length.</li>
    </ul>
    <p>
      Behind the scenes, the calculator looks for a combination like:
    </p>
    <ul style="margin-left:1.25rem;">
      <li>Launch speed ≳ <strong>270 FPS</strong></li>
      <li>FOC in the <strong>12–18%</strong> sweet spot</li>
      <li>Finished GPI ≲ <strong>9.5 gr/in</strong></li>
    </ul>
    <p>
      When you’re close to that zone, the badge tends toward
      <strong>Tight</strong>. Outside of it, the badge reads
      <strong>Average</strong> — still fully usable, just not as optimized on paper.
    </p>
    <p>
      It’s not a scoring system or a guarantee of X&quot; groups — it’s a quick,
      <strong>comparison tool</strong> for different builds so you can see which
      ones should feel more forgiving at the same distance.
    </p>
  `,
  peakHeight: `
    <h2>Peak Height vs Downrange Drop</h2>
    <p>
      Most sight tapes and pin gaps are built from <strong>downrange drop</strong> —
      how far the arrow falls <em>below your line of sight</em> at 30, 40, 50+ yards.
      Your line of sight (peep to pin) is tilted slightly upward when you zero at a
      distance like 20 yards.
    </p>
    <p>
      <strong>Peak Height</strong> is a different view of the same flight. Here we
      look at the arrow’s <strong>maximum height above the level launch line</strong>
      — a flat line running straight out from the bow at release.
    </p>
    <p>
      The arrow leaves the bow at a small upward angle, rises to an apex, then falls
      toward the target. Peak Height tells you:
    </p>
    <ul style="margin-left:1rem;">
      <li>whether your arrow will clear brush, branches, or blind windows</li>
      <li>how “arched” the true trajectory is</li>
      <li>how forgiving the setup is at longer ranges</li>
    </ul>
    <p>
      Because <strong>drop</strong> is measured below the angled line of sight and
      <strong>Peak Height</strong> is measured above a horizontal launch line, the
      two numbers will <strong>not match</strong> even at the same yardage — they are
      referenced to different lines.
    </p>
  `,
  flatnessScore: `
    <h2>Flatness Score (20 → 60 yd)</h2>
    <p>
      Flatness looks at <strong>how tall your arc needs to be by 60 yards</strong>
      when you are zeroed at 20 yards.
    </p>
    <p>
      Under the hood, the calculator:
    </p>
    <ul style="margin-left:1.25rem;">
      <li>Uses your launch FPS to model gravity drop at 20 and 60 yd.</li>
      <li>Measures the extra drop from <strong>20 → 60 yd</strong>.</li>
      <li>Turns that into an effective arc height and maps it to a label.</li>
    </ul>
    <p>
      Roughly:
    </p>
    <ul style="margin-left:1.25rem;">
      <li><strong>Very Flat</strong> – effective arc &lt; ~3 ft by 60 yd</li>
      <li><strong>Flat</strong> – ~3–4.5 ft of effective arc</li>
      <li><strong>Curved</strong> – &gt; ~4.5 ft of effective arc</li>
    </ul>
    <p>
      Use this as a <strong>comparison tool</strong> between builds — it’s not meant
      to replace a dedicated sight tape or ballistic solver, just to show whether a
      build is more “flat bow” or “loopy 3D rig” by the time it gets to 60 yards.
    </p>
  `,
  sightMarks: `
    <h2>Downrange Arrow Drop Simulator</h2>
    <p>
      This table shows the <strong>relative drop</strong> (in inches) between a
      <strong>20 yd zero</strong> and longer distances (30–70 yd), using the same
      simple ballistic model as the trajectory and time-of-flight estimates.
    </p>
    <p>
      Think of it as: if you are perfectly sighted at 20 yd, how much farther the
      arrow has to fall at 30, 40, 50, 60, and 70 yd. Bigger numbers mean more
      sight gap and wider pin spacing.
    </p>
  `,
  buildSummary: `
    <h2>Build Summary</h2>
    <p>
      A snapshot of all the key inputs and outputs for your current setup:
      bow specs, arrow specs, FOC, GPP/GPI, launch speed, energy, momentum,
      and impact numbers at the selected distance.
    </p>
    <p>
      The <strong>Copy</strong> button copies this table as text so you can paste it
      into notes, messages, forums, or spreadsheets.
    </p>
  `
};

/* ============================================================
   EASY HELPERS
============================================================ */

let toastTimer;
function showToast(msg) {
  toast.textContent = msg;
  toast.style.opacity = '1';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { toast.style.opacity = '0'; }, 2000);
}

const clamp = (val, min, max) => Math.max(min, Math.min(max, val));
const toGrains = (g) => parseFloat(g) || 0;
const toNumber = (v) => parseFloat(v) || 0;

/* ============================================================
   DARK MODE
============================================================ */

const darkToggle = $("darkModeToggle");
if (
  localStorage.getItem('dark') === '1' ||
  (!localStorage.getItem('dark') && matchMedia('(prefers-color-scheme: dark)').matches)
) {
  document.body.classList.add('dark');
  darkToggle.checked = true;
}
darkToggle.addEventListener('change', () => {
  document.body.classList.toggle('dark', darkToggle.checked);
  localStorage.setItem('dark', darkToggle.checked ? '1' : '0');
});

/* ============================================================
   SAVED BUILDS
============================================================ */

const loadSelect = $("loadBuildSelect");

function refreshBuilds() {
  loadSelect.innerHTML = '<option value="">– Load Build –</option>';
  const builds = JSON.parse(localStorage.getItem('atc') || '{}');
  const keys = Object.keys(builds).sort();

  if (keys.length === 0) {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'No saved builds yet';
    opt.disabled = true;
    loadSelect.appendChild(opt);
    return;
  }

  keys.forEach(n => {
    const o = document.createElement('option');
    o.value = n;
    o.textContent = n;
    loadSelect.appendChild(o);
  });
}

function updateArrowWeightMode() {
  const simpleTotal = totalArrowWeightSimpleEl;
  const hint = $("totalWeightHint");
  const isAdv = toggleArrowEl.checked;

  if (isAdv) {
    simpleTotal.readOnly = true;
    simpleTotal.style.opacity = 0.6;
    hint.textContent = 'Total arrow weight is now calculated from components.';
  } else {
    simpleTotal.readOnly = false;
    simpleTotal.style.opacity = 1;
    hint.textContent = '';
  }
}

toggleStringEl.onchange = e => {
  $("stringAdvanced").style.display = e.target.checked ? 'block' : 'none';
  calculateEverything();
};

toggleArrowEl.onchange = e => {
  $("arrowAdvanced").style.display = e.target.checked ? 'block' : 'none';
  updateArrowWeightMode();
  calculateEverything();
};

$("saveBuild").onclick = () => {
  const n = $("buildName").value.trim();
  if (!n) return alert('Name required');
  const all = JSON.parse(localStorage.getItem('atc') || '{}');

  if (all[n] && !confirm(`Overwrite existing build "${n}"?`)) {
    return;
  }

  const data = {};
  document.querySelectorAll('input,select,textarea').forEach(el => {
    if (!el.id) return;
    if (el.type === 'checkbox') {
      data[el.id] = { type: 'checkbox', checked: el.checked };
    } else {
      data[el.id] = { type: 'value', value: el.value };
    }
  });

  all[n] = data;
  localStorage.setItem('atc', JSON.stringify(all));
  showToast('Build saved');
  refreshBuilds();
};

loadSelect.onchange = () => {
  const n = loadSelect.value;
  if (!n) return;
  const all = JSON.parse(localStorage.getItem('atc') || '{}');
  const d = all[n];
  if (!d) return;

  Object.keys(d).forEach(id => {
    const el = $(id);
    if (!el) return;

    const stored = d[id];

    if (stored && typeof stored === 'object' && 'type' in stored) {
      if (stored.type === 'checkbox') {
        el.checked = !!stored.checked;
        el.dispatchEvent(new Event('change'));
      } else {
        el.value = stored.value ?? '';
      }
    } else {
      if (el.type !== 'checkbox') {
        el.value = stored ?? '';
      }
    }
  });

  updateArrowWeightMode();
  calculateEverything();
  showToast('Build loaded');
};

$("deleteBuild").onclick = () => {
  let n = loadSelect.value;

  const typed = $("buildName").value.trim();
  if (!n && typed) n = typed;

  if (!n) {
    alert('Select a saved build or type its exact name to delete it.');
    return;
  }

  const all = JSON.parse(localStorage.getItem('atc') || '{}');

  if (!all[n]) {
    alert(`No saved build named "${n}" was found.`);
    return;
  }

  if (!confirm(`Delete build "${n}"?`)) return;

  delete all[n];
  localStorage.setItem('atc', JSON.stringify(all));
  refreshBuilds();
  loadSelect.value = '';
  showToast('Build deleted');
};

$("suggestName").onclick = () => {
  const d = new Date().toISOString().slice(0,10);
  const b = bowModelEl.value.trim() || 'Bow';
  const dw = drawWeightEl.value || '70';
  const arrow = arrowNameEl.value.trim() || 'Arrow';
  const weight = getArrowWeight().toFixed(0);
  const app = applicationEl.value || '';

  $("buildName").value =
    `${d} ${b} ${dw}lb ${arrow} ${weight}gr (${app})`;
};

/* ============================================================
   FPS SOURCE MARKERS
============================================================ */

const fpsInput = $("actualFPS");
const fpsSource = $("fpsSource");

function markFpsEstimated() {
  if (fpsSource) {
    fpsSource.textContent = 'Estimated from IBO & rules of thumb';
  }
  window.fpsSource = 'estimated';
}

function markFpsChrono() {
  if (fpsSource) {
    fpsSource.textContent = 'Manual (chrono) entry';
  }
  window.fpsSource = 'chrono';
}

/* ============================================================
   CORE MATH HELPERS
============================================================ */

function getArrowWeight() {
  const pointWeight = parseFloat(pointWeightEl.value) || 125;

  if (toggleArrowEl.checked) {
    const bare   = parseFloat(bareShaftEl.value)        || 0;
    const nock   = parseFloat(nockWeightEl.value)       || 0;
    const wrap   = parseFloat(wrapWeightEl.value)       || 0;
    const vanes  = (parseFloat(vaneWeightEachEl.value)  || 0) *
                   (parseFloat(vaneCountEl.value)       || 0);
    const insert = parseFloat(insertWeightEl.value)     || 0;
    const glue   = parseFloat(glueWeightEl.value)       || 0;

    const advTotal = bare + nock + wrap + vanes + insert + glue;
    $("arrowTotal").textContent = advTotal.toFixed(1);

    return advTotal + pointWeight;
  }

  return parseFloat(totalArrowWeightSimpleEl.value) || 0;
}

function getNumeric(id) {
  const el = $(id);
  if (!el) return NaN;

  const raw =
    el.tagName === 'INPUT'
      ? el.value
      : (el.textContent || el.innerText || '');

  const num = parseFloat(String(raw).replace(/[^\d.-]/g, ''));
  return Number.isFinite(num) ? num : NaN;
}

// Simple drop model for sight-based math
function computeDropInches(distanceYards, fps, zeroYards = 20) {
  if (!Number.isFinite(fps) || fps <= 0) return NaN;

  const gFt = 32.174;      // gravity in ft/s^2
  const v0  = fps;
  const RzFt = zeroYards * 3;

  let sin2theta = (RzFt * gFt) / (v0 * v0);
  if (sin2theta <= 0) return NaN;
  sin2theta = Math.min(1, Math.max(0, sin2theta));
  const theta = 0.5 * Math.asin(sin2theta);

  const cosTheta = Math.cos(theta);
  const sinTheta = Math.sin(theta);
  if (cosTheta <= 1e-6) return NaN;

  const dFt = distanceYards * 3;
  const t   = dFt / (v0 * cosTheta);

  const yFt = v0 * sinTheta * t - 0.5 * gFt * t * t;
  const dropIn = -yFt * 12;
  return dropIn;
}

// Simple drop model for sight-based math
function computeDropInches(distanceYards, fps, zeroYards = 20) {
  if (!Number.isFinite(fps) || fps <= 0) return NaN;

  const gFt = 32.174;      // gravity in ft/s^2
  const v0  = fps;
  const RzFt = zeroYards * 3;

  let sin2theta = (RzFt * gFt) / (v0 * v0);
  if (sin2theta <= 0) return NaN;
  sin2theta = Math.min(1, Math.max(0, sin2theta));
  const theta = 0.5 * Math.asin(sin2theta);

  const cosTheta = Math.cos(theta);
  const sinTheta = Math.sin(theta);
  if (cosTheta <= 1e-6) return NaN;

  const dFt = distanceYards * 3;
  const t   = dFt / (v0 * cosTheta);

  const yFt = v0 * sinTheta * t - 0.5 * gFt * t * t;
  const dropIn = -yFt * 12;
  return dropIn;
}

/**
 * Velocity decay length (L) in yards.
 * Heavier arrows (higher GPP) keep speed longer → larger L.
 * Lighter arrows (lower GPP) lose speed faster → smaller L.
 */
function getVelocityDecayYards(weightGrains, drawWeightLbs) {
  if (!Number.isFinite(weightGrains) || !Number.isFinite(drawWeightLbs) || drawWeightLbs <= 0) {
    return 300; // neutral fallback
  }

  const gpp = weightGrains / drawWeightLbs;   // grains-per-pound
  let delta = gpp - 7;                        // 7 GPP = neutral
  delta = clamp(delta, -2, 2);               // clamp between ~5–9 GPP

  const base = 300;      // neutral retention distance in yards
  const perGpp = 35;     // ~35 yd change in L per GPP step

  // 5 GPP → ~230 yd, 7 GPP → 300 yd, 9 GPP → ~370 yd
  return base + delta * perGpp;
}

/* ============================================================
   TARGET PANEL METRICS (Target / 3D / Other)
============================================================ */

function updateTargetPanelMetrics() {
  const mode = applicationEl.value;
  if (mode === 'Hunting') return; // only for Target / Other

  const fps = getNumeric('actualFPS');
  const foc = getNumeric('focValue');
  const gpi = getNumeric('gpiValue');

  // Group stability badge – use the same thresholds as the description
  if (groupStabilityBadgeEl) {
    if (Number.isFinite(fps) && Number.isFinite(foc) && Number.isFinite(gpi)) {
      const isTight =
        fps >= 270 &&      // solid speed
        foc >= 12 && foc <= 18 && // sweet-spot FOC band
        gpi <= 9.5;        // not overly heavy per inch

      groupStabilityBadgeEl.textContent = isTight ? 'Tight' : 'Average';
    } else {
      groupStabilityBadgeEl.textContent = '–';
    }
  }

  // Flatness score via extra drop from 20→60 yd
  if (flatnessScoreValueEl) {
    let label = '–';
    if (Number.isFinite(fps) && fps > 0) {
      const baseDrop20 = computeDropInches(20, fps);
      const drop60 = computeDropInches(60, fps);
      if (Number.isFinite(baseDrop20) && Number.isFinite(drop60)) {
        const extraDrop = drop60 - baseDrop20;
        const peakFt = Math.max(0, extraDrop / 12);

        if (peakFt < 3.0)      label = 'Very Flat';
        else if (peakFt < 4.5) label = 'Flat';
        else                   label = 'Curved';
      }
    }
    flatnessScoreValueEl.textContent = label;
  }

  // Drop table
  if (dropTableEl) {
    const distances = [20, 30, 40, 50, 60, 70];
    dropTableEl.innerHTML = '';

    distances.forEach(d => {
      const tr = document.createElement('tr');
      const tdDist = document.createElement('td');
      const tdDrop = document.createElement('td');

      tdDist.textContent = d.toString();

      if (!Number.isFinite(fps) || fps <= 0) {
        tdDrop.textContent = d === 20 ? '0.0' : '–';
      } else {
        let drop = computeDropInches(d, fps);
        if (!Number.isFinite(drop)) {
          tdDrop.textContent = d === 20 ? '0.0' : '–';
        } else {
          if (d === 20) drop = 0;
          tdDrop.textContent = drop.toFixed(1);
        }
      }

      tr.appendChild(tdDist);
      tr.appendChild(tdDrop);
      dropTableEl.appendChild(tr);
    });
  }
}

/* ============================================================
   APPLICATION MODE (Hunting vs Target)
============================================================ */

function updateApplicationPanels() {
  const mode = applicationEl.value;
  const huntingMode = (mode === 'Hunting');

  const huntingPanel = $("huntingMode");
  const targetPanel  = $("targetMode");
  const titleEl      = $("gameCardTitle");

  if (huntingPanel) {
    huntingPanel.style.display = huntingMode ? '' : 'none';
  }
  if (targetPanel) {
    targetPanel.style.display = huntingMode ? 'none' : '';
  }
  if (titleEl) {
    titleEl.textContent = huntingMode ? 'Game Effectiveness' : 'Target Insights';
  }

  if (!huntingMode) {
    updateTargetPanelMetrics();
  }
}

/* ============================================================
   MASTER CALCULATION
============================================================ */

function calculateEverything(recalcFPS = false) {
  const len = parseFloat(arrowLengthEl.value) || 28;
  const weight = getArrowWeight();
  const balance = parseFloat(balancePointEl.value) || 18.5;
  const ibo = parseFloat(iboEl.value) || 350;
  const dw = parseFloat(drawWeightEl.value) || 70;
  const drawLenVal = parseFloat(drawLengthEl.value) || 30;
  const point = parseFloat(pointWeightEl.value) || 125;
  const arrowSpine = parseFloat(arrowSpineEl.value) || NaN;

  const stringW = toggleStringEl.checked
    ? ['peepWeight','dloopWeight','kisserWeight','silencersWeight']
        .reduce((a,id)=>a+(parseFloat($(id).value)||0),0)
    : (parseFloat(stringSimpleEl.value) || 25);

  if (toggleStringEl.checked) {
    const total = ['peepWeight','dloopWeight','kisserWeight','silencersWeight']
      .reduce((a,id)=>a+(parseFloat($(id).value)||0),0);
    stringAdvTotalEl.textContent = total.toFixed(1);
  }

  let fps = parseFloat(fpsInput.value);
  if (recalcFPS || isNaN(fps) || fps <= 0) {
    // Rule-of-thumb IBO adjustments
    const refDW = 70;
    const refDL = 30;
    const refArrow = 350;

    const baseIbo = ibo || 300;
    const dwDelta = dw - refDW;
    const dlDelta = drawLenVal - refDL;
    const awDelta = weight - refArrow;
    const extraString = Math.max(0, stringW - 20);

    const adjFromDw      = dwDelta * 2;          // ~2 fps per pound
    const adjFromDl      = dlDelta * 10;         // ~10 fps per inch
    const adjFromWeight  = -(awDelta / 10) * 1.5;// ~1–2 fps per 10 gr above 350
    const adjFromString  = -(extraString / 10) * 1.5; // extra string mass penalty

    let estimated = baseIbo + adjFromDw + adjFromDl + adjFromWeight + adjFromString;

    // Soft real-world factor (gentle nudge down vs factory IBO)
    estimated *= 0.97;

    // Keep within a sane band
    estimated = Math.max(150, estimated);

    fps = estimated;
    fpsInput.value = fps.toFixed(1);
    markFpsEstimated();
  }

  // FOC
  const foc = ((balance - len/2) / len) * 100;

  focValueEl.textContent = foc.toFixed(1) + '%';

  const focClamped = Math.max(0, Math.min(30, isFinite(foc) ? foc : 0));
  const markerLeft = (focClamped / 30) * 100;
  if (focMarkerEl)  focMarkerEl.style.left  = markerLeft + '%';
  if (focBarFillEl) focBarFillEl.style.width = markerLeft + '%';

  if (!isFinite(foc)) {
    focHintEl.textContent = 'Enter arrow length, balance point, and weight to compute FOC.';
    focHintEl.style.color = 'var(--light)';
  } else if (foc >= 12 && foc <= 18) {
    focHintEl.textContent = 'Ideal range for many broadhead hunting setups.';
    focHintEl.style.color = 'var(--success)';
  } else if (foc < 10) {
    focHintEl.textContent = 'Very low FOC – may be less stable with broadheads.';
    focHintEl.style.color = 'var(--danger)';
  } else if (foc > 20) {
    focHintEl.textContent = 'Very high FOC – great penetration focus, but watch speed and tune.';
    focHintEl.style.color = 'var(--warning)';
  } else {
    focHintEl.textContent = 'Workable range; many setups run 10–20%.';
    focHintEl.style.color = 'var(--light)';
  }

  // GPP / GPI / TW
  const gpp = weight / dw;
  const gpi = weight / len;
  gppValueEl.textContent = gpp.toFixed(1);
  gpiValueEl.textContent = gpi.toFixed(1);
  twEl.textContent = weight.toFixed(1);

  const gppHint = $("gppHint");
  let gppText = '';
  let gppColor = 'var(--light)';
  if (gpp < 5) {
    gppText = 'Very light – often not recommended for most hunting bows.';
    gppColor = 'var(--danger)';
  } else if (gpp < 6) {
    gppText = 'Light arrow – flatter trajectory, more 3D/target style.';
  } else if (gpp <= 8) {
    gppText = 'Solid all-around hunting weight.';
    gppColor = 'var(--success)';
  } else {
    gppText = 'Heavy arrow – penetration-focused setups.';
  }
  if (gppHint) {
    gppHint.textContent = gppText;
    gppHint.style.color = gppColor;
  }

  // Launch KE / Momentum
  const launchKE = (weight * fps * fps) / 450240;
  const launchMom = (weight * fps) / 225400;
  keValueEl.textContent = launchKE.toFixed(1);

  // Distance & velocity @ distance
  const distYards = parseFloat(distanceSliderEl.value) || 50;
  $("distanceValue").textContent = distYards;

  // Velocity decay tuned by grains-per-pound (GPP):
  // lighter arrows (low GPP) shed speed faster, heavier arrows shed speed slower.
  const decayYards = getVelocityDecayYards(weight, dw);
  const currentV = fps * Math.exp(-distYards / decayYards);
  const impactKE = (weight * currentV * currentV) / 450240;
  const impactMom = (weight * currentV) / 225400;
  const time = (distYards * 3) / (fps * 0.8);

  impactKEEl.textContent = impactKE.toFixed(1);
  impactMomEl.textContent = impactMom.toFixed(3);
  timeToImpactEl.textContent = time.toFixed(2);

  $("velocityDistanceLabel").textContent = distYards;
  velocityAtDistanceEl.textContent = currentV.toFixed(0);

  // Peak height (horizontal launch line model)
  const g = 32.174;
  const v0 = fps;
  const R_ft = distYards * 3;

  let peakHeightFt = 0;
  let peakYard = 0;
  if (v0 > 0 && R_ft > 0) {
    let sin2theta = (R_ft * g) / (v0 * v0);
    if (sin2theta > 0) {
      sin2theta = Math.min(1, Math.max(0, sin2theta));
      const theta = 0.5 * Math.asin(sin2theta);
      const sinTheta = Math.sin(theta);
      peakHeightFt = (v0 * v0 * sinTheta * sinTheta) / (2 * g);
      peakYard = distYards / 2;
    }
  }
  peakHeightValueEl.textContent = peakHeightFt.toFixed(1);
  peakDistanceValueEl.textContent = peakYard.toFixed(0);

  // Wind drift
  const windMph = parseFloat(windMphEl.value) || 10;
  const driftIn = 0.065 * (distYards * distYards) * windMph / Math.max(weight, 1);
  windDriftValueEl.textContent = driftIn.toFixed(1);

  // Composition bar
  const isAdv = toggleArrowEl.checked;
  let shaft = 0, pointW = 0, comp = 0;
  if (isAdv) {
    shaft = parseFloat(bareShaftEl.value) || 0;
    const nock   = parseFloat(nockWeightEl.value) || 0;
    const wrap   = parseFloat(wrapWeightEl.value) || 0;
    const vanes  = (parseFloat(vaneWeightEachEl.value) || 0) *
                   (parseFloat(vaneCountEl.value) || 0);
    const insert = parseFloat(insertWeightEl.value) || 0;
    const glue   = parseFloat(glueWeightEl.value) || 0;
    comp  = nock + wrap + vanes + insert + glue;
    pointW = point;
  } else {
    pointW = point;
    shaft = Math.max(0, weight - pointW);
    comp  = 0;
  }

  let shaftPct = 0, pointPct = 0, compPct = 0;
  if (weight > 0) {
    shaftPct = (shaft / weight) * 100;
    pointPct = (pointW / weight) * 100;
    compPct  = (comp  / weight) * 100;
  }

  const totalPct = shaftPct + pointPct + compPct;
  if (totalPct > 0 && Math.abs(totalPct - 100) > 0.5) {
    shaftPct = (shaftPct / totalPct) * 100;
    pointPct = (pointPct / totalPct) * 100;
    compPct  = (compPct  / totalPct) * 100;
  }

  if (compShaftSegEl) compShaftSegEl.style.width = shaftPct.toFixed(1) + '%';
  if (compPointSegEl) compPointSegEl.style.width = pointPct.toFixed(1) + '%';
  if (compOtherSegEl) compOtherSegEl.style.width = compPct.toFixed(1) + '%';

  if (compTotalLabelEl) compTotalLabelEl.textContent = weight > 0 ? `${weight.toFixed(1)} gr total` : '-';
  if (shaftPctLabelEl) shaftPctLabelEl.textContent = `Shaft: ${shaftPct.toFixed(0)}%`;
  if (pointPctLabelEl) pointPctLabelEl.textContent = `Point: ${pointPct.toFixed(0)}%`;
  if (compPctLabelEl)  compPctLabelEl.textContent  = `Comp.: ${compPct.toFixed(0)}%`;

  // Spine stiffness / forgiveness — tuned to chart-like behavior
  const spineBadge = stiffnessBadgeEl;
  const spineHint  = stiffnessHintEl;
  let effWeight = dw + 5 * (len - 28) + (point - 100) / 25;
  let recSpine = effWeight > 0 ? 22000 / effWeight : NaN; // tuned constant

  if (
    spineBadge && spineHint &&
    Number.isFinite(arrowSpine) && Number.isFinite(recSpine)
  ) {
    const delta = arrowSpine - recSpine;
    let label = 'Good';
    let detail = '';

    if (Math.abs(delta) <= 30) {
      label = 'Good';
      detail = `Arrow spine ≈ ${arrowSpine.toFixed(0)}, recommended ≈ ${recSpine.toFixed(0)}. Solid chart-style match.`;
      spineBadge.style.color = 'var(--success)';
    } else if (delta < -30) {
      // arrowSpine smaller than recSpine → stiffer
      label = 'Adjust';
      detail =
        `On the stiff side (arrow ${arrowSpine.toFixed(0)} vs ~${recSpine.toFixed(0)}). ` +
        `You can add point weight, lengthen the arrow slightly, or move to a weaker shaft.`;
      spineBadge.style.color = 'var(--warning)';
    } else {
      // arrowSpine larger than recSpine → weaker
      label = 'Adjust';
      detail =
        `On the weak side (arrow ${arrowSpine.toFixed(0)} vs ~${recSpine.toFixed(0)}). ` +
        `Consider moving closer, reducing point weight, or stepping to a stiffer shaft.`;
      spineBadge.style.color = 'var(--danger)';
    }

    spineBadge.textContent = label;
    spineHint.textContent = detail;
  } else if (spineBadge && spineHint) {
    spineBadge.textContent = '–';
    spineBadge.style.color = 'var(--light)';
    spineHint.textContent = 'Enter draw, arrow length, point weight, and spine to get a chart-like match check.';
  }

  // Game bands – conservative *minimum* thresholds (no upper cap)
  // KE mins are based on common Easton-style guidance:
  // 15–25 ft-lbs Small, 25–41 Medium (deer), 42–65 Large (elk),
  // 65–80 Toughest. Momentum mins are ballpark heuristics.
  const games = [
    {
      id: "smallGameStatus",
      label: "Small Game",
      keMin: 15,          // ft-lbs
      momMin: 0.20        // slug·ft/s
    },
    {
      id: "deerStatus",
      label: "Deer / Antelope",
      keMin: 25,
      momMin: 0.30
    },
    {
      id: "elkStatus",
      label: "Elk / Large Game",
      keMin: 42,
      momMin: 0.45
    },
    {
      id: "mooseStatus",
      label: "Toughest Game",
      keMin: 65,
      momMin: 0.60
    }
  ];

  games.forEach(gm => {
    const meetsKE  = impactKE  >= gm.keMin;
    const meetsMom = impactMom >= gm.momMin;

    gm.meetsKE  = meetsKE;
    gm.meetsMom = meetsMom;
    gm.ok       = meetsKE && meetsMom;

    const el = $(gm.id);
    if (!el) return;

    if (gm.ok) {
      // Overgunned or right on the line both show as "Send it"
      el.textContent = "Send it";
      el.style.color = "var(--success)";
    } else {
      el.textContent = "Adjust";
      el.style.color = "var(--warning)";
    }
  });

  // Build summary
  const summary = {
    "Build Name": $("buildName").value || "Unnamed",
    "Bow Model": bowModelEl.value || "-",
    "Draw Weight": dw + " lbs",
    "IBO Speed": ibo + " FPS",
    "Arrow Length": len.toFixed(2) + " in",
    "Total Arrow Weight": weight.toFixed(1) + " gr",
    "Point Weight": point.toFixed(0) + " gr",
    "Arrow Spine": Number.isFinite(arrowSpine) ? arrowSpine.toFixed(0) : "-",
    "FOC": foc.toFixed(1) + "%",
    "GPP": gpp.toFixed(1),
    "GPI": gpi.toFixed(1),
    "Launch FPS": fps.toFixed(1),
    "Launch KE": launchKE.toFixed(1) + " ft-lbs",
    "Launch Momentum": launchMom.toFixed(3) + " slug·ft/s",
    "Impact @ distance": `${distYards} yd`,
    "Impact Velocity": currentV.toFixed(0) + " FPS",
    "Impact KE": impactKE.toFixed(1) + " ft-lbs",
    "Impact Momentum": impactMom.toFixed(3) + " slug·ft/s",
    "Time to Impact": time.toFixed(2) + " s",
    "Wind Drift": driftIn.toFixed(1) + " in @ " + windMph.toFixed(0) + " mph"
  };

  summaryTableEl.innerHTML =
    '<table>' +
    Object.entries(summary).map(([k, v]) =>
      `<tr><td>${k}</td><td>${v}</td></tr>`
    ).join('') +
    '</table>';

  window.latestSummary = summary;

  // Recompute FPS estimate breakdown for math popup
  const refDW = 70;
  const refDL = 30;
  const refArrow = 350;
  const baseIbo = ibo || 300;
  const dwDelta = dw - refDW;
  const dlDelta = drawLenVal - refDL;
  const awDelta = weight - refArrow;
  const extraString = Math.max(0, stringW - 20);

  const adjFromDw      = dwDelta * 2;
  const adjFromDl      = dlDelta * 10;
  const adjFromWeight  = -(awDelta / 10) * 1.5;
  const adjFromString  = -(extraString / 10) * 1.5;

  let estimatedFps = baseIbo + adjFromDw + adjFromDl + adjFromWeight + adjFromString;
  estimatedFps *= 0.97;
  estimatedFps = Math.max(150, estimatedFps);

  window.math = {
    foc: { len, balance, mid: len / 2, value: foc },
    gpp: { weight, dw, value: gpp },
    gpi: { weight, len, value: gpi },
    tw:  { weight },
    fps: {
      ibo,
      stringW,
      weight,
      drawWeight: dw,
      drawLength: drawLenVal,
      refDrawWeight: refDW,
      refDrawLength: refDL,
      refArrowWeight: refArrow,
      baseFps: baseIbo,
      adjFromDrawWeight: adjFromDw,
      adjFromDrawLength: adjFromDl,
      adjFromArrowWeight: adjFromWeight,
      adjFromStringWeight: adjFromString,
      estimatedFps,
      usedFps: fps,
      source: window.fpsSource || 'estimated'
    },
    keLaunch: {
      weight,
      fps,
      value: launchKE
    },
    velocity: {
      launchFps: fps,
      distYards,
      decayYards,          // effective retention distance L (yards)
      gpp,                 // grains-per-pound snapshot
      value: currentV
    },
    peakHeight: {
      launchFps: fps,
      distYards,
      peakHeightFt,
      peakYard
    },
    impactKE: {
      weight,
      distYards,
      impactV: currentV,
      value: impactKE
    },
    impactMom: {
      weight,
      distYards,
      impactV: currentV,
      value: impactMom
    },
    timeToImpact: {
      distYards,
      value: time,
      launchFps: fps
    },
    wind: {
      distYards,
      windMph,
      weight,
      value: driftIn
    },
    game: {
      distYards,
      impactKE,
      impactMom,
      bands: games
    },
    awc: {
      weight,
      shaft,
      point: pointW,
      comp,
      shaftPct,
      pointPct,
      compPct
    },
    spine: {
      drawWeight: dw,
      arrowLength: len,
      pointWeight: point,
      effectiveWeight: effWeight,
      recommendedSpine: recSpine,
      arrowSpine,
      weight,
    }
  };

  updateApplicationPanels();
}

/* ============================================================
   BUTTONS & INPUT LISTENERS
============================================================ */

$("recalcFPS").onclick = () => calculateEverything(true);

copySummaryBtn.onclick = () => {
  if (!window.latestSummary) {
    calculateEverything(false);
  }
  const summary = window.latestSummary || {};
  const lines = [
    `Arrow Tune Build - ${new Date().toLocaleDateString()}`,
    ''
  ];

  Object.entries(summary).forEach(([k, v]) => {
    if (v === '') return;
    lines.push(`${k}: ${v}`);
  });

  const text = lines.join('\n');
  navigator.clipboard.writeText(text).then(() => showToast('Summary copied'));
};

distanceSliderEl.oninput = e => {
  $("distanceValue").textContent = e.target.value;
  calculateEverything();
};

// Let the user edit the distance (yd) by clicking the printed value
const distanceDisplayEl = $("distanceValue");

function setDistanceFromInput(rawVal) {
  let d = parseFloat(rawVal);
  if (!Number.isFinite(d)) return;

  const min = parseFloat(distanceSliderEl.min || "10");
  const max = parseFloat(distanceSliderEl.max || "100");
  d = clamp(d, min, max);

  distanceSliderEl.value = d;
  distanceDisplayEl.textContent = d.toFixed(0);
  calculateEverything();
}

if (distanceDisplayEl) {
  // Make it tabbable for keyboard users
  distanceDisplayEl.setAttribute("tabindex", "0");

  distanceDisplayEl.addEventListener("click", () => {
    const current = distanceSliderEl.value || "50";

    // Create a temporary number input inside the label
    const input = document.createElement("input");
    input.type = "number";
    input.value = current;
    input.min = distanceSliderEl.min || "10";
    input.max = distanceSliderEl.max || "100";
    input.step = distanceSliderEl.step || "1";
    input.style.width = "4rem";
    input.style.textAlign = "center";
    input.style.background = "transparent";
    input.style.border = "1px solid var(--border)";
    input.style.borderRadius = "4px";
    input.style.color = "inherit";
    input.style.font = "inherit";

    distanceDisplayEl.textContent = "";
    distanceDisplayEl.appendChild(input);
    input.focus();
    input.select();

    function commit() {
      setDistanceFromInput(input.value);
    }

    function cancel() {
      distanceDisplayEl.textContent = current;
    }

    input.addEventListener("blur", commit);

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        commit();
      } else if (e.key === "Escape") {
        cancel();
        input.blur();
      }
    });
  });

  // Optional: allow Enter from keyboard focus (without mouse click)
  distanceDisplayEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      distanceDisplayEl.click();
    }
  });
}

/* Click the printed distance to type a value (keyboard entry) */
if (distanceValueEl && distanceSliderEl) {
  distanceValueEl.style.cursor = 'pointer';
  distanceValueEl.title = 'Click to type a distance in yards';

  distanceValueEl.addEventListener('click', () => {
    const current = parseFloat(distanceSliderEl.value) || 50;
    const min = parseFloat(distanceSliderEl.min) || 5;
    const max = parseFloat(distanceSliderEl.max) || 100;
    const input = prompt(`Enter target distance in yards (${min}–${max}):`, current);

    if (input === null) return;
    const val = parseFloat(input);
    if (!Number.isFinite(val)) {
      alert('Please enter a valid number for distance.');
      return;
    }

    const clamped = clamp(val, min, max);
    distanceSliderEl.value = clamped;
    distanceValueEl.textContent = clamped;
    calculateEverything();
  });
}

document.querySelectorAll('input,select,textarea').forEach(el => {
  el.addEventListener('input', () => {
    if (document.activeElement.id === 'actualFPS') {
      markFpsChrono();
      calculateEverything(false);
    } else {
      calculateEverything();
    }
  });
});

/* ============================================================
   INFO + MATH OVERLAYS
============================================================ */

function openInfo(key) {
  if (!infoOverlay || !infoBody) return;

  infoBody.innerHTML = INFO_CONTENT[key] || `
    <h2>Info</h2>
    <p>More details coming soon.</p>
  `;

  infoOverlay.classList.add('open');
}

function openMath(key) {
  if (!infoOverlay || !infoBody) return;
  if (!window.math) {
    calculateEverything(false);
  }
  const m = window.math || {};
  let html = '';

  if (key === 'foc' && m.foc) {
    const f = m.foc;
    html = `
      <h2>FOC Math</h2>
      <p><strong>Formula:</strong> FOC = ((Balance Point − (Arrow Length ÷ 2)) ÷ Arrow Length) × 100</p>
      <p>Arrow Length = ${f.len.toFixed(2)} in</p>
      <p>Midpoint = ${f.mid.toFixed(2)} in</p>
      <p>Balance Point = ${f.balance.toFixed(2)} in</p>
      <p>FOC = ((${f.balance.toFixed(2)} − ${f.mid.toFixed(2)}) ÷ ${f.len.toFixed(2)}) × 100
         = <strong>${f.value.toFixed(1)}%</strong></p>
    `;
  } else if (key === 'gpp' && m.gpp) {
    const g = m.gpp;
    html = `
      <h2>GPP Math</h2>
      <p><strong>Formula:</strong> GPP = Total Arrow Weight ÷ Draw Weight</p>
      <p>Total Arrow Weight = ${g.weight.toFixed(1)} gr</p>
      <p>Draw Weight = ${g.dw.toFixed(1)} lb</p>
      <p>GPP = ${g.weight.toFixed(1)} ÷ ${g.dw.toFixed(1)} = <strong>${g.value.toFixed(1)}</strong></p>
    `;
  } else if (key === 'gpi' && m.gpi) {
    const g = m.gpi;
    html = `
      <h2>GPI Math</h2>
      <p><strong>Formula:</strong> GPI = Total Arrow Weight ÷ Arrow Length</p>
      <p>Total Arrow Weight = ${g.weight.toFixed(1)} gr</p>
      <p>Arrow Length = ${g.len.toFixed(2)} in</p>
      <p>GPI = ${g.weight.toFixed(1)} ÷ ${g.len.toFixed(2)} = <strong>${g.value.toFixed(1)}</strong></p>
    `;
  } else if (key === 'tw' && m.tw) {
    const t = m.tw;
    html = `
      <h2>Total Arrow Weight</h2>
      <p>This is the finished arrow weight used for all other calculations.</p>
      <p>Total Arrow Weight = <strong>${t.weight.toFixed(1)} grains</strong></p>
    `;
  } else if (key === 'fps' && m.fps) {
    const f = m.fps;
    html = `
      <h2>FPS Estimate Math</h2>
      <p>
        When you don’t have a chronograph reading, the app uses a 
        <strong>rule-of-thumb estimate</strong> based on your bow’s IBO rating:
      </p>
      <ul style="margin-left:1.25rem;">
        <li>Start from IBO (often 30&quot;/70 lb/350 gr arrow).</li>
        <li>Adjust a few FPS per pound above or below 70 lb.</li>
        <li>Adjust roughly 8–12 FPS per inch above or below 30&quot; draw.</li>
        <li>Trim 1–2 FPS per extra ~5–10 grains above 350 gr arrow weight.</li>
        <li>Subtract a few FPS for peep, D-loop, silencers, and other string add-ons.</li>
      </ul>
      <p><strong>Your inputs:</strong></p>
      <ul style="margin-left:1.25rem;">
        <li>IBO / ATA rating: ${f.ibo.toFixed(0)} FPS (base)</li>
        <li>Draw weight: ${f.drawWeight.toFixed(1)} lb (ref ~${f.refDrawWeight} lb)</li>
        <li>Draw length: ${f.drawLength.toFixed(2)} in (ref ~${f.refDrawLength} in)</li>
        <li>Arrow weight: ${f.weight.toFixed(1)} gr (ref ~${f.refArrowWeight} gr)</li>
        <li>String add-ons: ${f.stringW.toFixed(1)} gr (first ~20 gr assumed “free”)</li>
      </ul>
      <p><strong>Approximate breakdown:</strong></p>
      <ul style="margin-left:1.25rem;">
        <li>Base IBO: ${f.baseFps.toFixed(1)} FPS</li>
        <li>Draw weight adjustment: ${f.adjFromDrawWeight.toFixed(1)} FPS</li>
        <li>Draw length adjustment: ${f.adjFromDrawLength.toFixed(1)} FPS</li>
        <li>Arrow weight adjustment: ${f.adjFromArrowWeight.toFixed(1)} FPS</li>
        <li>String add-ons adjustment: ${f.adjFromStringWeight.toFixed(1)} FPS</li>
      </ul>
      <p>
        After a small real-world correction, the estimate lands at 
        <strong>${f.estimatedFps.toFixed(1)} FPS</strong>.
      </p>
      <p>
        FPS used in calculations: <strong>${f.usedFps.toFixed(1)} FPS</strong>
        (${f.source === 'chrono' ? 'manual (chrono) entry' : 'estimated from IBO & rules of thumb'}).
      </p>
      <p>
        Always treat this as a <strong>ballpark</strong> until you can confirm with an actual chronograph.
      </p>
    `;
  } else if (key === 'keLaunch' && m.keLaunch) {
    const k = m.keLaunch;
    html = `
      <h2>Launch Kinetic Energy</h2>
      <p>
        Kinetic energy (KE) is a measure of how much <strong>work</strong> your arrow can do on impact.
        It depends on both arrow <strong>mass</strong> and <strong>speed</strong>, and is one of the
        classic ways bowhunters compare setups.
      </p>
      <p><strong>Formula (archery units):</strong></p>
      <p>
        KE (ft-lbs) = (Arrow Weight (grains) × Velocity (fps)²) ÷ 450240
      </p>
      <p>
        The constant <strong>450240</strong> packs in all the unit conversions to go from
        grains and feet-per-second to foot-pounds of energy:
      </p>
      <ul style="margin-left:1.25rem;">
        <li>7000 grains = 1 pound of mass</li>
        <li>g ≈ 32.174 ft/s² (acceleration due to gravity)</li>
        <li>KE = ½ × m × v², with m in slugs → all rolled into 450240</li>
      </ul>
      <p><strong>Your numbers at launch:</strong></p>
      <ul style="margin-left:1.25rem;">
        <li>Arrow Weight = <strong>${k.weight.toFixed(1)} gr</strong></li>
        <li>Launch Velocity = <strong>${k.fps.toFixed(1)} fps</strong></li>
      </ul>
      <p>Step-by-step:</p>
      <p>
        KE = (${k.weight.toFixed(1)} × ${k.fps.toFixed(1)}²) ÷ 450240
      </p>
      <p>
        KE ≈ <strong>${k.value.toFixed(1)} ft-lbs</strong> at the bow.
      </p>
      <p style="margin-top:0.5rem;">
        Downrange, the calculator repeats this same formula using your
        <strong>estimated velocity at distance</strong> to show how much energy is left
        at the target for the Game Effectiveness panel.
      </p>
    `;
  } else if (key === 'velocity' && m.velocity) {
    const v = m.velocity;
    const L = Number.isFinite(v.decayYards) && v.decayYards > 0 ? v.decayYards : 300;
    const exponent = -v.distYards / L;

    html = `
      <h2>Velocity at Distance</h2>
      <p><strong>Model:</strong> v(d) = v₀ × e^(−d / L)</p>
      <p>
        v₀ is your launch FPS, d is distance in yards, and L is an
        effective “speed-retention distance” in yards.
      </p>
      <p><strong>Your inputs:</strong></p>
      <ul style="margin-left:1.25rem;">
        <li>Launch velocity v₀ = ${v.launchFps.toFixed(1)} FPS</li>
        <li>Distance d = ${v.distYards.toFixed(0)} yd</li>
        <li>Current GPP ≈ ${Number.isFinite(v.gpp) ? v.gpp.toFixed(2) : '–'} gr/lb</li>
        <li>Retention distance L ≈ ${L.toFixed(0)} yd</li>
      </ul>
      <p><strong>Computation:</strong></p>
      <p>
        v(d) = ${v.launchFps.toFixed(1)} × e<sup>${exponent.toFixed(3)}</sup>
        ≈ <strong>${v.value.toFixed(0)} FPS</strong>
      </p>
      <p style="margin-top:0.5rem;">
        Lower GPP arrows get a smaller L (they slow down faster); higher GPP
        arrows get a larger L (they keep speed longer). This keeps the curve
        in the ballpark of real hunting rigs without trying to be a full
        drag-coefficient ballistic solver.
      </p>
    `;
  } else if (key === 'peakHeight' && m.peakHeight) {
    const p = m.peakHeight;
    html = `
      <h2>Peak Height Math</h2>
      <p>
        Uses a level-ground projectile model to find the apex above a horizontal
        launch line for your selected distance.
      </p>
      <p>Peak Height ≈ <strong>${p.peakHeightFt.toFixed(1)} ft</strong> at about
         <strong>${p.peakYard.toFixed(0)} yd</strong>.</p>
      <p>
        This is a different reference line than sight-based drop, so it will not
        match the Flatness / Drop values one-for-one.
      </p>
    `;
  } else if (key === 'impactKE' && m.impactKE) {
    const k = m.impactKE;
    html = `
      <h2>Impact Kinetic Energy</h2>
      <p><strong>Formula:</strong> KE = (Arrow Weight × Impact Velocity²) ÷ 450240</p>
      <p>Arrow Weight = ${k.weight.toFixed(1)} gr</p>
      <p>Impact Velocity at ${k.distYards.toFixed(0)} yd = ${k.impactV.toFixed(1)} FPS</p>
      <p>KE ≈ <strong>${k.value.toFixed(1)} ft-lbs</strong></p>
    `;
  } else if (key === 'impactMom' && m.impactMom) {
    const mom = m.impactMom;
    html = `
      <h2>Impact Momentum</h2>
      <p><strong>Formula:</strong> Momentum = (Arrow Weight × Impact Velocity) ÷ 225400</p>
      <p>Arrow Weight = ${mom.weight.toFixed(1)} gr</p>
      <p>Impact Velocity at ${mom.distYards.toFixed(0)} yd = ${mom.impactV.toFixed(1)} FPS</p>
      <p>Momentum ≈ <strong>${mom.value.toFixed(3)} slug·ft/s</strong></p>
    `;
  } else if (key === 'timeToImpact' && m.timeToImpact) {
    const t = m.timeToImpact;
    html = `
      <h2>Time to Impact</h2>
      <p>Distance = ${t.distYards.toFixed(0)} yd</p>
      <p>Launch FPS ≈ ${t.launchFps.toFixed(1)}</p>
      <p>Estimated time ≈ <strong>${t.value.toFixed(2)} s</strong></p>
    `;
  } else if ((key === 'wind' || key === 'windDrift') && m.wind) {
    const w = m.wind;
    html = `
      <h2>Wind Drift Math</h2>
      <p><strong>Approximate model:</strong></p>
      <p>drift ≈ 0.065 × distance² × wind / arrowWeight</p>
      <p>Distance = ${w.distYards.toFixed(0)} yd</p>
      <p>Wind = ${w.windMph.toFixed(0)} mph</p>
      <p>Arrow Weight ≈ ${w.weight.toFixed(1)} gr</p>
      <p>Drift ≈ <strong>${w.value.toFixed(1)} in</strong></p>
    `;
  } else if (key === 'game' && m.game) {
    const g = m.game;
    const rows = (g.bands || []).map(b => {
      const status    = b.ok ? 'Send it' : 'Adjust';
      const keStatus  = g.impactKE  >= b.keMin  ? '✓' : '×';
      const momStatus = g.impactMom >= b.momMin ? '✓' : '×';

      return `
        <tr>
          <td>${b.label}</td>
          <td>${b.keMin.toFixed(0)}+</td>
          <td>${b.momMin.toFixed(2)}+</td>
          <td>${g.impactKE.toFixed(1)} (${keStatus})</td>
          <td>${g.impactMom.toFixed(3)} (${momStatus})</td>
          <td>${status}</td>
        </tr>
      `;
    }).join('');

    html = `
      <h2>Game Effectiveness Math</h2>
      <p>At ${g.distYards.toFixed(0)} yd this build is carrying:</p>
      <ul style="margin-left:1.25rem;">
        <li>Impact KE = <strong>${g.impactKE.toFixed(1)} ft-lbs</strong></li>
        <li>Impact Momentum = <strong>${g.impactMom.toFixed(3)} slug·ft/s</strong></li>
      </ul>
      <p>
        Each band below is a <strong>minimum</strong> guideline: being “overgunned”
        (well above the line) still shows as <strong>Send it</strong>. 
      </p>
      <div style="overflow-x:auto;margin-top:0.5rem;">
        <table style="font-size:0.9rem;margin-top:0;">
          <thead>
            <tr>
              <th>Class</th>
              <th>KE Min (ft-lbs)</th>
              <th>Mom Min (slug·ft/s)</th>
              <th>Your KE</th>
              <th>Your Mom</th>
              <th>Result</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      </div>
      <p style="margin-top:0.5rem;">
        These are <em>conservative</em> sanity checks, not guarantees. Broadhead design, 
        arrow flight, and shot placement still matter more than any single number.
      </p>  
    `;
  } else if (key === 'awc' && m.awc) {
    const a = m.awc;
    html = `
      <h2>Arrow Weight Composition Math</h2>
      <p>Total Arrow Weight = <strong>${a.weight.toFixed(1)} gr</strong></p>
      <p>Breakdown:</p>
      <ul>
        <li><strong>Shaft:</strong> ${a.shaft.toFixed(1)} gr (${a.shaftPct.toFixed(0)}%)</li>
        <li><strong>Point:</strong> ${a.point.toFixed(1)} gr (${a.pointPct.toFixed(0)}%)</li>
        <li><strong>Components:</strong> ${a.comp.toFixed(1)} gr (${a.compPct.toFixed(0)}%)</li>
      </ul>
    `;
  } else if (key === 'sightMarks') {
    const fps = getNumeric('actualFPS');
    if (!Number.isFinite(fps) || fps <= 0) {
      html = `
        <h2>Downrange Arrow Drop Math</h2>
        <p>Enter a valid launch FPS to compute relative drop from a 20 yd zero.</p>
      `;
    } else {
      const distances = [20, 30, 40, 50, 60, 70];
      const base20 = computeDropInches(20, fps);
      const rows = distances.map(d => {
        const drop = computeDropInches(d, fps);
        let rel = drop - base20;
        if (d === 20) rel = 0;
        const relStr = Number.isFinite(rel) ? rel.toFixed(1) : '–';
        return `<tr><td>${d}</td><td>${relStr}</td></tr>`;
      }).join('');

      html = `
        <h2>Downrange Arrow Drop Math</h2>
        <p>
          We estimate gravity drop at each distance, then subtract the 20 yd value
          so 20 yd is always 0.0 in.
        </p>
        <div style="overflow-x:auto;margin-top:0.5rem;">
          <table style="font-size:0.9rem;margin-top:0;">
            <thead>
              <tr>
                <th>Distance (yd)</th>
                <th>Drop vs 20 yd (in)</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }
  } else if (key === 'groupStability' || key === 'stiffness') {
    const fps = getNumeric('actualFPS');
    const foc = getNumeric('focValue');
    const gpi = getNumeric('gpiValue');

    if (!Number.isFinite(fps) || !Number.isFinite(foc) || !Number.isFinite(gpi)) {
      html = `
        <h2>Group Stability Math</h2>
        <p>
          Enter launch FPS, FOC, and arrow length/weight so the app can estimate
          group stability.
        </p>
      `;
    } else {
      const isTight =
        fps >= 270 &&
        foc >= 12 && foc <= 18 &&
        gpi <= 9.5;

      const label = isTight ? 'Tight' : 'Average';

      html = `
        <h2>Group Stability Math</h2>
        <p>Current values:</p>
        <ul style="margin-left:1.25rem;">
          <li>FPS = <strong>${fps.toFixed(1)}</strong></li>
          <li>FOC = <strong>${foc.toFixed(1)}%</strong></li>
          <li>GPI = <strong>${gpi.toFixed(1)}</strong></li>
        </ul>
        <p>Badge result: <strong>${label}</strong>.</p>
        <p>
          The calculator flags <strong>Tight</strong> when all of these are true:
        </p>
        <ul style="margin-left:1.25rem;">
          <li>Launch FPS ≳ <strong>270</strong></li>
          <li>FOC between <strong>12–18%</strong></li>
          <li>GPI ≲ <strong>9.5 gr/in</strong></li>
        </ul>
        <p>
          Anything outside that zone is labeled <strong>Average</strong> — still fully
          usable, but not as optimized on paper for forgiveness and small groups.
        </p>
      `;
    }
  } else if (key === 'flatnessScore') {
    const fps = getNumeric('actualFPS');
    if (!Number.isFinite(fps) || fps <= 0) {
      html = `
        <h2>Flatness Score Math</h2>
        <p>
          Enter a valid launch FPS so the app can estimate the trajectory arc
          between 20 and 60 yards.
        </p>
      `;
    } else {
      const baseDrop20 = computeDropInches(20, fps);
      const drop60 = computeDropInches(60, fps);
      let peakFt = NaN;
      let label = '–';

      if (Number.isFinite(baseDrop20) && Number.isFinite(drop60)) {
        const extraDrop = drop60 - baseDrop20;
        peakFt = Math.max(0, extraDrop / 12);

        if (peakFt < 3.0)      label = 'Very Flat';
        else if (peakFt < 4.5) label = 'Flat';
        else                   label = 'Curved';
      }

      html = `
        <h2>Flatness Score Math</h2>
        <p>
          We model gravity drop at <strong>20 yd</strong> and <strong>60 yd</strong>,
          then look at how much additional drop happens between those points.
        </p>
        <p>
          That extra drop is converted into an effective arc height by 60 yd.
        </p>
        <p>
          Approximate effective height by 60 yd:
          <strong>${Number.isFinite(peakFt) ? peakFt.toFixed(2) : '–'} ft</strong>
        </p>
        <p>Score label: <strong>${label}</strong></p>
        <ul style="margin-left:1.25rem;">
          <li><strong>Very Flat</strong> → effective arc &lt; ~3 ft</li>
          <li><strong>Flat</strong> → ~3–4.5 ft</li>
          <li><strong>Curved</strong> → &gt; ~4.5 ft</li>
        </ul>
        <p>
          Use this to compare builds — it isn’t meant to be exact sight tape data,
          just a feel for how “flat” the rig is by 60 yards.
        </p>
      `;
    }
  }

  if (!html) {
    html = `
      <h2>Math</h2>
      <p>Math details are not available for this section yet.</p>
    `;
  }

  infoBody.innerHTML = html;
  infoOverlay.classList.add('open');
}

if (infoClose) {
  infoClose.addEventListener('click', () => infoOverlay.classList.remove('open'));
}

if (infoOverlay) {
  infoOverlay.addEventListener('click', (e) => {
    if (e.target === infoOverlay) infoOverlay.classList.remove('open');
  });
}

document.querySelectorAll('.info-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.preventDefault();
    const key = btn.dataset.info;
    if (key) openInfo(key);
  });
});

document.querySelectorAll('.math-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.preventDefault();
    const key = btn.dataset.math;
    if (key) openMath(key);
  });
});

/* ============================================================
   INITIALIZE
============================================================ */

refreshBuilds();
updateArrowWeightMode();
calculateEverything(true);
</script>
</body>
</html>