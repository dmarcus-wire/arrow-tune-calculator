<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArrowForge – Smart Arrow Tuner</title>
  <meta name="description" content="Offline-first archery calculator with AI advisor. Perfect arrow tuning made simple.">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQXJyb3dGb3JnZSIsInNob3J0X25hbWUiOiJBcnJvd0ZvcmdlIiwic3RhcnRfdXJsIjoiaHR0cHM6Ly9hIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCxiYXNlNjQsdmFsdWUiOiJkYXRhOmltYWdlL3N2Zyt4bWwgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCB5PSIuOWVtIiBmb250LXNpemU9IjkwIj7wn5iBLTwvdGV4dD48L3N2Zz4iLCJzaXplcyI6IjEyOHgxMjgiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCIsInB1cnBvc2UiOiJhbnkgbWFza2FibGUifV19">
  <link href="https://rsms.me/inter/inter.css" rel="stylesheet">
  <style>
    :root {
      --bg:#f8fafc; --card:#ffffff; --text:#1e293b; --light:#64748b; --border:#e2e8f0;
      --primary:#0ea5e9; --success:#22c55e; --warning:#f59e0b; --danger:#ef4444; --purple:#8b5cf6;
    }
    .dark {
      --bg:#0f172a; --card:#020617; --text:#e2e8f0; --light:#94a3b8; --border:#1e293b;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Inter',sans-serif;
      background:var(--bg);
      color:var(--text);
      padding:0.5rem;
      min-height:100vh;
    }
    .container {
      max-width:1600px;
      margin:auto;
      display:grid;
      gap:1rem 1.5rem;
    }
    @media (max-width:1023px) { .container { grid-template-columns:1fr; } }
    @media (min-width:1024px) { .container { grid-template-columns:460px 1fr; } }
    .card {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:1rem;
      box-shadow:0 4px 12px rgba(15,23,42,0.08);
    }

    /* Minimal tick marks for range sliders */
    input[type="range"] {
      -webkit-appearance: none; /* Remove default styling */
      appearance: none;
      background: linear-gradient(to right, 
        transparent 0%, 
        transparent 4%, 
        var(--light) 4%, 
        var(--light) 6%, 
        transparent 6%, 
        transparent 100%
      ) repeat-x;
      background-size: 10% 6px; /* Adjust for interval spacing (10% = every 10 units on 0-100 scale) */
      background-position: 0 center;
    }

    /* Optional: make ticks even subtler */
    .dark input[type="range"] {
      background-color: var(--border);
    }

    #inputs-column .card { padding:0.8rem; }
    #inputs-column input, #inputs-column select { padding:0.5rem; font-size:0.95rem; }
    #outputs-column .card { padding:1.25rem; }
    #outputs-column h2 { font-size:1.4rem; margin-bottom:1rem; }
    .card-header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.75rem; }
    h1 { font-size:1.5rem; margin:0; }
    input, select {
      width:100%;
      border:1px solid var(--border);
      border-radius:8px;
      background:var(--card);
      color:var(--text);
      padding:0.5rem;
    }
    .input-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:0.5rem 0;
      gap:0.75rem;
    }
    .input-row label {
      margin:0;
      font-weight:600;
      font-size:0.95rem;
      white-space:nowrap;
      color:var(--text);
      flex-shrink:0;
    }
    .input-row label::after { content:":"; margin-left:0.25rem; color:var(--light); }
    .input-row input, .input-row select {
      flex:1;
      min-width:140px;
      text-align:right;
      font-size:1rem;
    }
    @media (min-width:769px) {
      .input-row { gap:1rem; }
      .input-row input, .input-row select { max-width:240px; text-align:left; font-size:1.05rem; }
      .input-row label { font-size:1rem; }
    }
    .collapsible-trigger {
      cursor:pointer;
      padding:0.75rem 0 0.5rem;
      margin-top:0.75rem;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:600;
      color:var(--primary);
    }
    .collapsible-trigger .chevron {
      font-size:1.5rem;
      transition:transform 0.25s ease;
      color:var(--light);
    }
    .collapsible-trigger.open .chevron { transform:rotate(90deg); }
    .collapsible-content { display:none; padding-top:0.5rem; }
    .collapsible-trigger.open + .collapsible-content { display:block; }
    @media (max-width:768px) {
      .collapsible-mobile .card-content { display:none; }
      .collapsible-mobile.open .card-content { display:block; }
      .mobile-only-trigger {
        display:flex !important;
        cursor:pointer;
        padding:0.75rem 1rem;
        background:var(--card);
        border-top:1px solid var(--border);
        justify-content:space-between;
        align-items:center;
        font-weight:600;
        color:var(--primary);
        margin-top:0.5rem;
        border-radius:0 0 14px 14px;
      }
      .collapsible-mobile.open .mobile-only-trigger .chevron { transform:rotate(90deg); }
    }
    @media (min-width:769px) {
      .mobile-only-trigger { display:none !important; }
      .collapsible-mobile .card-content { display:block !important; }
    }
    .mobile-only-trigger { display:none; }
    button {
      padding:0.5rem 1rem;
      border:none;
      border-radius:999px;
      background:var(--primary);
      color:white;
      font-weight:600;
      font-size:0.95rem;
      line-height:1;
      cursor:pointer;
      min-height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btn-small { padding:0.35rem 0.7rem; font-size:0.85rem; }
    .secondary { background:transparent; color:var(--primary); border:1px solid var(--primary); }
    .flex { display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; }
    .toggle-switch { position:relative; width:50px; height:26px; }
    .toggle-switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; inset:0; background:#cbd5e1; border-radius:34px; transition:.3s; }
    .slider:before { position:absolute; content:""; height:20px; width:20px; left:3px; bottom:3px; background:white; border-radius:50%; transition:.3s; }
    input:checked + .slider { background:var(--primary); }
    input:checked + .slider:before { transform:translateX(24px); }
    .info-overlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.5);
      display:none; align-items:center; justify-content:center; z-index:1000;
    }
    .info-panel {
      background:var(--card);
      border-radius:12px;
      max-width:600px;
      width:90%;
      max-height:90vh;
      padding:1.5rem;
      box-shadow:0 20px 40px rgba(0,0,0,0.3);
      position:relative;
      overflow-y:auto;
    }
    .info-close {
      position:absolute; top:0.8rem; right:1rem;
      background:none; border:none; font-size:1.8rem;
      color:var(--light); cursor:pointer;
    }
  .game-table { width:100%; border-collapse:collapse; font-size:0.95rem; margin-top:0.5rem; }
    .game-table th, .game-table td { padding:0.5rem; text-align:center; border-bottom:1px solid var(--border); }
    .game-table th { background:var(--border); font-weight:600; }
    .send { color:var(--success); font-weight:700; }
    .marginal { color:var(--warning); font-weight:700; }
    .adjust { color:var(--danger); font-weight:700; }
  </style>
</head>
<body>
<div class="container">
  <div id="inputs-column">
    <div class="card">
      <div class="card-header">
        <h1>ArrowForge</h1>
        <div class="flex">
          <span style="color:var(--light);">Light</span>
          <label class="toggle-switch">
            <input type="checkbox" id="darkToggle"><span class="slider"></span>
          </label>
          <span style="color:var(--light);">Dark</span>
          <button id="aiButton" class="btn-small" style="background:var(--purple);">AI Advisor</button>
        </div>
      </div>
      <p style="color:var(--light);font-size:0.85rem;">Offline • Live • v0.0.4</p>
    </div>
    <div class="card">
      <h2>Build</h2>
      <div class="input-row">
        <label for="buildName">Build Name</label>
        <div class="flex" style="gap:0.5rem;">
          <input type="text" id="buildName" placeholder="e.g. 2025 Elk Slayer">
          <button class="btn-small secondary">Suggest</button>
        </div>
      </div>
      <div class="flex" style="margin-top:0.75rem; gap:0.5rem;">
        <button id="saveBuild">Save</button>
        <select id="loadBuild" style="flex:1;"><option>– Load Build –</option></select>
        <button id="deleteBuild" style="background:var(--danger);">Delete</button>
      </div>
    </div>
    <div class="card collapsible-mobile" id="bowCard">
      <h2 style="margin:0 0 0.75rem 0;">Bow</h2>
      <div class="card-content">
        <div class="input-row"><label for="appType">Application</label><select id="appType"><option>Target</option><option selected>Hunting</option><option>Other</option></select></div>
        <div class="input-row"><label for="bowModel">Model</label><input type="text" id="bowModel" placeholder="Hoyt RX-9"></div>
        <div class="input-row"><label for="ibo">IBO fps</label><input type="number" id="ibo" value="340"></div>
        <div class="input-row"><label for="drawWt">Draw wt lb</label><input type="number" id="drawWt" value="70" step="0.5"></div>
        <div class="input-row"><label for="drawLen">Draw length in</label><input type="number" id="drawLen" value="29" step="0.1"></div>
        <div class="input-row"><label for="stringWt">String add-ons gr</label><input type="number" id="stringWt" value="20"></div>
        <div class="collapsible-trigger" onclick="this.classList.toggle('open'); this.nextElementSibling.style.display = this.classList.contains('open') ? 'block' : 'none';">
          <span>String Details</span>
          <span class="chevron">></span>
        </div>
        <div class="collapsible-content">
          <div class="input-row"><label for="peepWt">Peep weight gr</label><input type="number" id="peepWt" value="0" step="0.5"></div>
          <div class="input-row"><label for="dloopWt">D-loop gr</label><input type="number" id="dloopWt" value="0" step="0.5"></div>
          <div class="input-row"><label for="kisserWt">Kisser gr</label><input type="number" id="kisserWt" value="0" step="0.5"></div>
          <div class="input-row"><label for="silencerWt">Silencers gr</label><input type="number" id="silencerWt" value="0" step="0.5"></div>
          <div class="input-row"><label for="nockWt">Nock weight gr</label><input type="number" id="nockWt" value="0" step="0.5"></div>
        </div>
      </div>
      <div class="mobile-only-trigger" onclick="this.parentElement.classList.toggle('open')">
        <span>Bow Details</span>
        <span class="chevron">></span>
      </div>
    </div>
    <div class="card collapsible-mobile" id="arrowCard">
      <h2 style="margin:0 0 0.75rem 0;">Arrow</h2>
      <div class="card-content">
        <div class="input-row"><label for="arrowName">Name</label><input type="text" id="arrowName" placeholder="Victory VAP TKO"></div>
        <div class="input-row"><label for="spine">Spine</label><input type="number" id="spine" value="300"></div>
        <div class="input-row"><label for="arrowLen">Length in</label><input type="number" id="arrowLen" value="28.5" step="0.1"></div>
        <div class="input-row"><label for="totalWt">Total weight gr</label><input type="number" id="totalWt" value="495" step="0.5"></div>
        <div class="input-row"><label for="pointWt">Point weight gr</label><input type="number" id="pointWt" value="125"></div>
        <div class="input-row"><label for="balancePt">Balance point in</label><input type="number" id="balancePt" value="17.2" step="0.05"></div>
        <div class="collapsible-trigger" onclick="this.classList.toggle('open'); this.nextElementSibling.style.display = this.classList.contains('open') ? 'block' : 'none';">
          <span>Component Details</span>
          <span class="chevron">></span>
        </div>
        <div class="collapsible-content">
          <div class="input-row"><label for="insertWt">Insert/Outsert gr</label><input type="number" id="insertWt" value="0" step="0.5"></div>
          <div class="input-row"><label for="wrapWt">Wrap gr</label><input type="number" id="wrapWt" value="0" step="0.5"></div>
          <div class="input-row"><label for="vaneWt">Vane weight (each) gr</label><input type="number" id="vaneWt" value="0" step="0.1"></div>
          <div class="input-row"><label for="vaneCount">Vane count</label><input type="number" id="vaneCount" value="0"></div>
          <div class="input-row"><label for="glueWt">Glue / Pin gr</label><input type="number" id="glueWt" value="0" step="0.5"></div>
        </div>
      </div>
      <div class="mobile-only-trigger" onclick="this.parentElement.classList.toggle('open')">
        <span>Arrow Details</span>
        <span class="chevron">></span>
      </div>
    </div>
  </div>
  <div id="outputs-column">
    <div class="card">
      <h2>Live Settings</h2>
      <div style="margin:1.2rem 0;">
        <div style="display:flex; align-items:center; gap:0.75rem; margin-bottom:0.6rem;">
          <label style="font-weight:600; margin:0;">Actual Speed (fps)</label>
          <button onclick="recalculateAndShowMath()" style="background:none;border:none;cursor:pointer;font-size:1.3rem;color:var(--primary);padding:0;" title="Recalculate and show estimate">Calculate</button>
        </div>
        <div style="display:flex; align-items:center; gap:1rem;">
          <input type="range" id="fpsSlider" min="150" max="400" value="278" step="1" style="background-size: 12.5% 6px;">
          <input type="number" id="fpsInput" value="278" min="150" max="400" style="width:80px; padding:0.45rem; text-align:center; font-weight:600; font-size:1rem;">
        </div>
      </div>
      <div style="margin:1.2rem 0;">
        <label style="display:block; margin-bottom:0.4rem; font-weight:600;">Crosswind (mph)</label>
        <div style="display:flex; align-items:center; gap:1rem;">
          <input type="range" id="windSlider" min="0" max="40" value="0" step="0.1" style="background-size: 12.5% 6px;">
          <input type="number" id="windInput" value="0" min="0" max="40" step="0.1" style="width:70px; padding:0.45rem; text-align:center; font-weight:600; font-size:1rem;">
        </div>
      </div>
      <div style="margin:1.2rem 0;">
        <label style="display:block; margin-bottom:0.4rem; font-weight:600;">Range (yards)</label>
        <div style="display:flex; align-items:center; gap:1rem;">
          <input type="range" id="rangeSlider" min="5" max="150" value="0" step="1" style="background-size: 12.5% 6px;">
          <input type="number" id="rangeInput" value="0" min="5" max="150" style="width:70px; padding:0.45rem; text-align:center; font-weight:600; font-size:1rem;">
        </div>
      </div>
    </div>
        <!-- Game Effectiveness card -->
    <div class="card">
      <h2 style="display:flex; align-items:center; gap:0.75rem;">
        Game Effectiveness @ <span id="gameDist">50</span> yd
        <button onclick="showGameMathPopup()" style="background:none;border:none;cursor:pointer;font-size:1.3rem;color:var(--primary);padding:0;" title="Show math breakdown">ⓘ</button>
      </h2>
      <div style="overflow-x:auto;">
        <table class="game-table">
          <thead>
            <tr>
              <th>Class</th>
              <th>KE Min (ft·lbs)</th>
              <th>Mom Min (slug·ft/s)</th>
              <th>Impact KE (ft·lbs)</th>
              <th>Impact Mom (slug·ft/s)</th>
              <th>Result</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Small Game</td>
              <td>15+</td>
              <td>0.20+</td>
              <td id="smallKE">-</td>
              <td id="smallMom">-</td>
              <td id="smallRes" class="send">Send it</td>
            </tr>
            <tr>
              <td>Deer / Antelope</td>
              <td>25+</td>
              <td>0.30+</td>
              <td id="deerKE">-</td>
              <td id="deerMom">-</td>
              <td id="deerRes" class="send">Send it</td>
            </tr>
            <tr>
              <td>Elk / Large Game</td>
              <td>42+</td>
              <td>0.45+</td>
              <td id="elkKE">-</td>
              <td id="elkMom">-</td>
              <td id="elkRes" class="send">Send it</td>
            </tr>
            <tr>
              <td>Toughest Game</td>
              <td>65+</td>
              <td>0.60+</td>
              <td id="mooseKE">-</td>
              <td id="mooseMom">-</td>
              <td id="mooseRes" class="marginal">Marginal</td>
            </tr>
          </tbody>
        </table>
      </div>
      <p style="margin-top:0.75rem;font-size:0.9rem;color:var(--light);text-align:center;">
        Based on kinetic energy and momentum at impact. Broadhead type and shot placement matter!
      </p>
    </div>
  </div>
</div>
<div id="fpsMathModal" class="info-overlay">
  <div class="info-panel" style="max-width:500px;">
    <button class="info-close" onclick="closeFpsMath()">×</button>
    <h2>FPS Estimate Breakdown</h2>
    <div id="fpsMathPopupContent" style="font-size:0.95rem;line-height:1.5;">
      Fill in bow details to see the estimate.
    </div>
  </div>
</div>
<!-- Game Effectiveness Math Popup Modal -->
<div id="gameMathModal" class="info-overlay">
  <div class="info-panel" style="max-width:600px;">
    <button class="info-close" onclick="closeGameMath()">×</button>
    <h2>Game Effectiveness Math Breakdown</h2>
    <div id="gameMathContent" style="font-size:0.95rem;line-height:1.5;">
      <!-- Filled by JS -->
    </div>
  </div>
</div>
<div id="aiModal" class="info-overlay">
  <div class="info-panel">
    <button class="info-close" onclick="closeModal()">×</button>
    <h2>AI Arrow Advisor</h2>
    <div id="chatHist" style="max-height:300px;overflow-y:auto;margin-bottom:1rem;padding:0.5rem;background:#00000004;border-radius:8px;"></div>
    <div class="flex">
      <input id="aiIn" type="text" placeholder="Ask about arrows, broadheads, tuning..." style="flex:1;">
      <button onclick="sendAi()" class="btn-small">Send</button>
    </div>
  </div>
</div>
<script>
const $ = id => document.getElementById(id);
let fpsWasRecalculated = false;

function calculateEstimatedFPS() {
  const ibo = parseFloat($('ibo').value) || 340;
  const drawWt = parseFloat($('drawWt').value) || 70;
  const drawLen = parseFloat($('drawLen').value) || 29;
  const totalWt = parseFloat($('totalWt').value) || 495;
  const peepWt = parseFloat($('peepWt').value) || 8;
  const dloopWt = parseFloat($('dloopWt').value) || 8;
  const kisserWt = parseFloat($('kisserWt').value) || 0;
  const silencerWt = parseFloat($('silencerWt').value) || 12;
  const nockWt = parseFloat($('nockWt').value) || 10;
  const totalStringAddons = peepWt + dloopWt + kisserWt + silencerWt + nockWt;

  const refDrawWt = 70;
  const refDrawLen = 30;
  const refArrowWt = 350;
  const refStringFree = 20;

  let est = ibo;
  est += (drawWt - refDrawWt) * 1.8;
  est += (drawLen - refDrawLen) * 10;
  est -= Math.max(0, (totalWt - refArrowWt) / 5);
  est -= Math.max(0, (totalStringAddons - refStringFree) / 10);
  est *= 0.97;

  const estimated = Math.max(150, Math.round(est * 10) / 10);

  return {
    estimated: estimated,
    breakdown: {
      base: ibo,
      adjDrawWt: (drawWt - refDrawWt) * 1.8,
      adjDrawLen: (drawLen - refDrawLen) * 10,
      adjArrowWt: -Math.max(0, (totalWt - refArrowWt) / 5),
      adjString: -Math.max(0, (totalStringAddons - refStringFree) / 10),
      correction: est * -0.03
    }
  };
}

function showFpsMathPopup() {
  const content = $('fpsMathPopupContent');
  const currentFps = parseFloat($('fpsSlider').value);
  const hasManualFps = !isNaN(currentFps) && currentFps > 0;

  if (hasManualFps) {
    content.innerHTML = `
      <p><strong>Using your chronographed speed:</strong> ${currentFps.toFixed(1)} FPS</p>
      <p style="margin-top:0.75rem;color:var(--light);">
        Manual entry overrides estimate — this is the most accurate!
      </p>
    `;
  } else {
    const est = calculateEstimatedFPS();
    content.innerHTML = `
      <p><strong>Calculated estimate:</strong> ${est.estimated.toFixed(1)} FPS</p>
      <p style="margin-top:0.75rem;color:var(--light);font-size:0.9rem;">
        No manual FPS entered — using estimate.
      </p>
    `;
  }
  $('fpsMathModal').style.display = 'flex';
}

function showGameMathPopup() {
  const rangeYd = parseFloat($('rangeSlider').value) || 50;
  const fps = parseFloat($('fpsSlider').value) || 278;
  const totalWt = parseFloat($('totalWt').value) || 495;

  const k = 0.532;
  const retention = Math.exp(- (k * rangeYd) / totalWt);
  const velImpact = Math.round(fps * retention);
  const keImpact = Math.round(totalWt * velImpact * velImpact / 450240);
  const momImpact = parseFloat((totalWt * velImpact / 225400).toFixed(3));

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>Launch Speed:</strong> ${fps} fps</p>
    <p><strong>Arrow Weight:</strong> ${totalWt} gr</p>
    <p><strong>Range:</strong> ${rangeYd} yd</p>
    <hr>
    <p><strong>Velocity Retention Model:</strong></p>
    <p>retention = e^(-k × range / weight)</p>
    <p>k = 0.532 (calibrated for typical hunting arrows)</p>
    <p>Retention = ${retention.toFixed(3)} (${(retention * 100).toFixed(1)}%)</p>
    <p><strong>Impact Velocity:</strong> ${velImpact} fps</p>
    <hr>
    <p><strong>Impact KE:</strong> ${keImpact.toFixed(1)} ft-lbs</p>
    <p>KE = (weight × velocity²) / 450240</p>
    <p>KE = (${totalWt} × ${velImpact}²) / 450240</p>
    <hr>
    <p><strong>Impact Momentum:</strong> ${momImpact.toFixed(3)} slug·ft/s</p>
    <p>Momentum = (weight × velocity) / 225400</p>
    <p>Momentum = (${totalWt} × ${velImpact}) / 225400</p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      <strong>Where do the constants come from?</strong><br>
      • 450240 = 2 × 32.174 × 7000 (converts grain·fps² to ft-lbs)<br>
      • 225400 = 450240 / 2 (for momentum in slug·ft/s)<br>
      • k = 0.532 is calibrated from real-world hunting arrow data (350–500gr arrows, typical shafts/broadheads).<br><br>
      This is an approximation using arrow mass for drag resistance.<br>
      Real-world results vary with arrow diameter, broadhead, fletching, and air density.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function closeGameMath() {
  $('gameMathModal').style.display = 'none';
}

function recalculateAndShowMath() {
  const est = calculateEstimatedFPS();
  const b = est.breakdown;

  $('fpsSlider').value = est.estimated;
  $('fpsInput').value = est.estimated;

  const content = $('fpsMathPopupContent');
  content.innerHTML = `
    <p style="color:var(--success);font-weight:700;">✓ Speed updated to calculated estimate!</p>
    <p><strong>New FPS:</strong> ${est.estimated.toFixed(1)}</p>
    <p style="margin-top:0.75rem;"><strong>Breakdown:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Base IBO: ${b.base.toFixed(0)} FPS</li>
      <li>Draw weight: ${b.adjDrawWt > 0 ? '+' : ''}${b.adjDrawWt.toFixed(1)} FPS</li>
      <li>Draw length: ${b.adjDrawLen > 0 ? '+' : ''}${b.adjDrawLen.toFixed(1)} FPS</li>
      <li>Arrow weight: ${b.adjArrowWt.toFixed(1)} FPS</li>
      <li>String add-ons: ${b.adjString.toFixed(1)} FPS</li>
      <li>Real-world correction: ${b.correction.toFixed(1)} FPS</li>
    </ul>
    <p style="margin-top:0.75rem;color:var(--light);font-size:0.9rem;">
      Your previous value has been replaced with the current estimate.
    </p>
  `;

  $('fpsMathModal').style.display = 'flex';
}

function closeFpsMath() {
  $('fpsMathModal').style.display = 'none';
}

function calculateEverything() {
  const drawWt = parseFloat($('drawWt').value) || 70;
  const totalWt = parseFloat($('totalWt').value) || 495;
  const windMph = parseFloat($('windSlider').value) || 0;
  const rangeYd = parseFloat($('rangeSlider').value) || 50;

  let userFps = parseFloat($('fpsSlider').value);
  if (isNaN(userFps) || userFps <= 0) {
    const est = calculateEstimatedFPS();
    userFps = est.estimated;
  }
  const fps = userFps;

  // Sync number inputs
  $('windInput').value = windMph;
  $('rangeInput').value = rangeYd;
  $('fpsInput').value = fps;

  // Update game distance
  $('gameDist').textContent = rangeYd;

  // === Game Effectiveness ===
  const k = 0.532; // Calibrated constant for hunting arrows (based on typical Cd, rho, A)
  const retention = Math.exp(- (k * rangeYd) / totalWt); // Better model: retention depends on mass
  const velImpact = Math.round(fps * retention);
  const keImpact = Math.round(totalWt * velImpact * velImpact / 450240);
  const momImpact = parseFloat((totalWt * velImpact / 225400).toFixed(3));

  const classes = [
    {id: 'small', keMin: 15, momMin: 0.20},
    {id: 'deer', keMin: 25, momMin: 0.30},
    {id: 'elk', keMin: 42, momMin: 0.45},
    {id: 'moose', keMin: 65, momMin: 0.60}
  ];

  classes.forEach(c => {
    const keOk = keImpact >= c.keMin;
    const momOk = momImpact >= c.momMin;
    const bothOk = keOk && momOk;

    $(`${c.id}KE`).textContent = `${keImpact.toFixed(1)} ${keOk ? '(✓)' : '(×)'}`;
    $(`${c.id}Mom`).textContent = `${momImpact.toFixed(3)} ${momOk ? '(✓)' : '(×)'}`;

    const resCell = $(`${c.id}Res`);
    if (bothOk) {
      resCell.textContent = 'Send it';
      resCell.className = 'send';
    } else if (keOk || momOk) {
      resCell.textContent = 'Marginal';
      resCell.className = 'marginal';
    } else {
      resCell.textContent = 'Adjust';
      resCell.className = 'adjust';
    }
  });
}

function closeFpsMath() {
  $('fpsMathModal').style.display = 'none';
}

function closeModal() {
  $('aiModal').style.display = 'none';
}

function sendAi() {
  const msg = $('aiIn').value.trim();
  if (!msg) return;
  $('chatHist').innerHTML += `<p><strong>You:</strong> ${msg}</p>`;
  $('chatHist').innerHTML += `<p style="color:var(--purple);"><strong>AI:</strong> Got it! Example response...</p>`;
  $('aiIn').value = '';
  $('chatHist').scrollTop = $('chatHist').scrollHeight;
}

// Suggest Build Name
document.querySelector('.secondary').addEventListener('click', () => {
  const today = new Date();
  const dateStr = today.toISOString().slice(0, 10);
  const appType = $('appType').value.trim() || 'Hunting';
  const arrowWeight = $('totalWt').value.trim() || '???';
  const bowModel = $('bowModel').value.trim() || 'Bow';
  const drawWt = $('drawWt').value || '??';
  const templates = [
    `${dateStr} ${appType} ${bowModel} ${drawWt}# ${arrowWeight}gr`,
    `${dateStr} ${bowModel} ${drawWt}lb ${appType} ${arrowWeight}gr`,
    `${dateStr} ${appType} Build ${arrowWeight}gr`,
    `${dateStr} ${bowModel} ${appType} Setup`
  ];
  const best = templates.find(t => !t.includes('??') && !t.includes('???')) || templates[0];
  $('buildName').value = best.trim();
});

// Save / Load / Delete Builds
function updateLoadDropdown() {
  const select = $('loadBuild');
  const builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  select.innerHTML = '<option>– Load Build –</option>';
  builds.sort((a, b) => b.date.localeCompare(a.date)).forEach(build => {
    const opt = document.createElement('option');
    opt.value = build.name;
    opt.textContent = `${build.date} – ${build.name}`;
    select.appendChild(opt);
  });
}

function saveBuild() {
  const buildName = $('buildName').value.trim();
  if (!buildName) {
    alert('Please enter a Build Name first');
    return;
  }
  const buildData = {
    name: buildName,
    date: new Date().toISOString().slice(0,10),
    appType: $('appType').value,
    bowModel: $('bowModel').value,
    ibo: $('ibo').value,
    drawWt: $('drawWt').value,
    drawLen: $('drawLen').value,
    stringWt: $('stringWt').value,
    peepWt: $('peepWt').value,
    dloopWt: $('dloopWt').value,
    kisserWt: $('kisserWt').value,
    silencerWt: $('silencerWt').value,
    nockWt: $('nockWt').value,
    arrowName: $('arrowName').value,
    spine: $('spine').value,
    arrowLen: $('arrowLen').value,
    totalWt: $('totalWt').value,
    pointWt: $('pointWt').value,
    balancePt: $('balancePt').value,
    insertWt: $('insertWt').value,
    wrapWt: $('wrapWt').value,
    vaneWt: $('vaneWt').value,
    vaneCount: $('vaneCount').value,
    glueWt: $('glueWt').value,
    fpsSlider: $('fpsSlider').value,
    windSlider: $('windSlider').value,
    rangeSlider: $('rangeSlider').value,
  };
  let builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  builds = builds.filter(b => b.name !== buildName);
  builds.push(buildData);
  localStorage.setItem('arrowForgeBuilds', JSON.stringify(builds));
  updateLoadDropdown();
  alert(`Build "${buildName}" saved!`);
}

function loadBuild() {
  const select = $('loadBuild');
  const selectedName = select.value;
  if (!selectedName || selectedName === '– Load Build –') return;
  const builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  const build = builds.find(b => b.name === selectedName);
  if (!build) return;
  $('buildName').value = build.name;
  $('appType').value = build.appType || 'Hunting';
  $('bowModel').value = build.bowModel || '';
  $('ibo').value = build.ibo || '';
  $('drawWt').value = build.drawWt || '';
  $('drawLen').value = build.drawLen || '';
  $('stringWt').value = build.stringWt || '';
  $('peepWt').value = build.peepWt || '8';
  $('dloopWt').value = build.dloopWt || '8';
  $('kisserWt').value = build.kisserWt || '0';
  $('silencerWt').value = build.silencerWt || '12';
  $('nockWt').value = build.nockWt || '10';
  $('arrowName').value = build.arrowName || '';
  $('spine').value = build.spine || '';
  $('arrowLen').value = build.arrowLen || '';
  $('totalWt').value = build.totalWt || '';
  $('pointWt').value = build.pointWt || '';
  $('balancePt').value = build.balancePt || '';
  $('insertWt').value = build.insertWt || '50';
  $('wrapWt').value = build.wrapWt || '8';
  $('vaneWt').value = build.vaneWt || '8';
  $('vaneCount').value = build.vaneCount || '3';
  $('glueWt').value = build.glueWt || '5';
  alert(`Build "${build.name}" loaded!`);
  $('fpsSlider').value = build.fpsSlider || '278';
  $('fpsInput').value = build.fpsSlider || '278';
  $('windSlider').value = build.windSlider || '5';
  $('windInput').value = build.windSlider || '5';
  $('rangeSlider').value = build.rangeSlider || '50';
  $('rangeInput').value = build.rangeSlider || '50';
  calculateEverything(); // to sync everything
}

function deleteBuild() {
  const select = $('loadBuild');
  const selectedName = select.value;
  if (!selectedName || selectedName === '– Load Build –') {
    alert('Select a build to delete');
    return;
  }
  if (confirm(`Delete "${selectedName}" forever?`)) {
    let builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
    builds = builds.filter(b => b.name !== selectedName);
    localStorage.setItem('arrowForgeBuilds', JSON.stringify(builds));
    updateLoadDropdown();
    alert(`Build deleted`);
  }
}

function syncSlider(sliderId, inputId) {
  const slider = $(sliderId);
  const input = $(inputId);
  if (!slider || !input) return;
  slider.addEventListener('input', () => {
    input.value = slider.value;
    calculateEverything(); // optional, if you have calculations
  });
  input.addEventListener('input', () => {
    let val = parseFloat(input.value);
    if (isNaN(val)) val = slider.min;
    val = Math.max(slider.min, Math.min(slider.max, val));
    slider.value = val;
    input.value = val;
    calculateEverything();
  });
}

// Capitalize Bow Model
$('bowModel').addEventListener('input', e => {
  e.target.value = toTitleCase(e.target.value);
});

// Capitalize Arrow Name
$('arrowName').addEventListener('input', e => {
  e.target.value = toTitleCase(e.target.value);
});

//Capitalize the first letter of each word
function toTitleCase(str) {
  return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
}

// Connect the sliders
syncSlider('fpsSlider', 'fpsInput');
syncSlider('windSlider', 'windInput');
syncSlider('rangeSlider', 'rangeInput');

// Event listeners
document.querySelectorAll('input, select').forEach(el => {
  el.addEventListener('input', calculateEverything);
});
$('darkToggle').addEventListener('change', e => {
  document.body.classList.toggle('dark', e.target.checked);
});
$('aiButton').addEventListener('click', () => $('aiModal').style.display = 'flex');
$('saveBuild').addEventListener('click', saveBuild);
$('loadBuild').addEventListener('change', loadBuild);
$('deleteBuild').addEventListener('click', deleteBuild);

// Init
updateLoadDropdown();
calculateEverything();
</script>
</body>
</html>