<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Arrow Tune Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!--
    Arrow Tune Calculator
    Author: David Marcus (GitHub: dmarcus-wire)
    Maintainer: David Marcus

    Description:
      A simple browser-based tool to calculate arrow weight, FOC,
      grains per pound, grains per inch, and basic kinetic data (FPS & momentum),
      with visualizations focused on arrow balance, weight distribution,
      and a simple trajectory arc over distance.

    Tech:
      - Single self-contained HTML file (HTML + CSS + JS)
      - No external libraries or frameworks
      - Runs locally in any modern browser

    License: MIT
  -->

  <style>
    /* ---------------------------
       THEME VARIABLES
       --------------------------- */

    :root {
      /* Dark (default) */
      --bg: #020617;
      --bg-card: #020617;
      --bg-elevated: #020617;
      --bg-input: #020617;
      --border: #1f2937;
      --border-soft: #111827;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --axis: #1f2937;
    }

    /* Light mode with archery/hunting feel (tan/olive/earthy) */
    .light-mode {
      --bg: #f5f5f0;           /* warm off-white */
      --bg-card: #fffaf2;      /* soft parchment */
      --bg-elevated: #fffbf2;  /* slightly brighter card */
      --bg-input: #fff7e6;     /* light tan input */
      --border: #e2ddcf;       /* warm soft border */
      --border-soft: #d5c8af;  /* slightly darker edge */
      --text: #1f2933;         /* deep charcoal */
      --text-muted: #6b7280;   /* neutral muted */
      --axis: #d0c4aa;         /* light tan axis lines */
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text);
      transition:
        background-color 0.35s ease,
        color 0.35s ease;
    }

    .page {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
      transition: background-color 0.35s ease;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .meta {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 16px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 16px;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid var(--border);
      margin-bottom: 12px;
      transition:
        background-color 0.35s ease,
        border-color 0.35s ease,
        color 0.35s ease;
    }

    .card h2 {
      font-size: 1rem;
      margin: 0 0 6px 0;
      color: var(--text);
    }

    .card .card-subtitle {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .field {
      display: flex;
      flex-direction: column;
      margin-bottom: 8px;
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .field label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .field input,
    .field textarea {
      border-radius: 6px;
      border: 1px solid var(--border);
      padding: 6px 8px;
      font-size: 0.9rem;
      background: var(--bg-input);
      color: var(--text);
      outline: none;
      transition:
        background-color 0.35s ease,
        color 0.35s ease,
        border-color 0.35s ease;
    }

    .field textarea {
      min-height: 80px;
      resize: vertical;
    }

    .field input:focus,
    .field textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #1d4ed8;
    }

    .results-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .results-row span.label {
      color: var(--text-muted);
    }

    .results-row span.value {
      font-weight: 600;
      color: var(--text);
    }

    .foc-tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
      margin-left: 4px;
    }

    .foc-low { background: #3b0764; color: #e9d5ff; }
    .foc-normal { background: #064e3b; color: #bbf7d0; }
    .foc-high { background: #7f1d1d; color: #fecaca; }

    /* GPP tags */
    .gpp-low { background: #7f1d1d; color: #fecaca; }
    .gpp-normal { background: #064e3b; color: #bbf7d0; }
    .gpp-high { background: #1e3a8a; color: #bfdbfe; }

    /* GPI (full arrow) tags */
    .gpi-light { background: #7f1d1d; color: #fecaca; }
    .gpi-normal { background: #064e3b; color: #bbf7d0; }
    .gpi-heavy { background: #1e3a8a; color: #bfdbfe; }
    .gpi-ultra { background: #4c1d95; color: #e9d5ff; }

    /* Arrow balance bar */
    .arrow-visual {
      margin-top: 4px;
      text-align: center;
    }

    .arrow-track {
      position: relative;
      width: 100%;
      max-width: 420px;
      height: 14px;
      margin: 0 auto;
      border-radius: 999px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-soft);
      overflow: hidden;
      transition:
        background-color 0.35s ease,
        border-color 0.35s ease;
    }

    .arrow-center-line {
      position: absolute;
      left: 50%;
      top: 0;
      width: 2px;
      height: 100%;
      background: #22c55e;
    }

    .arrow-balance-marker {
      position: absolute;
      top: 0;
      width: 8px;
      height: 100%;
      border-radius: 999px;
      background: #f97316;
      transform: translateX(-50%);
    }

    .arrow-axis {
      position: absolute;
      left: 0;
      right: 0;
      top: 50%;
      height: 2px;
      background: #1f2937;
      transform: translateY(-50%);
    }

    .arrow-legend {
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .arrow-ends {
      display: flex;
      justify-content: space-between;
      max-width: 420px;
      margin: 0 auto 2px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Weight composition bar */
    .weight-bar {
      margin-top: 8px;
      width: 100%;
      max-width: 420px;
      height: 14px;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid var(--border-soft);
      background: var(--bg-elevated);
      display: flex;
      position: relative;
      transition:
        background-color 0.35s ease,
        border-color 0.35s ease;
    }
    .weight-shaft { background: #1d4ed8; }
    .weight-point { background: #ea580c; }
    .weight-fletch { background: #a855f7; }

    .weight-mid-line {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 50%;
      width: 2px;
      background: #111827;
      pointer-events: none;
    }

    .weight-legend {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--text-muted);
      flex-wrap: wrap;
    }

    .dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      margin-right: 4px;
    }

    /* FOC shift gauge: back vs front */
    .foc-shift-visual {
      margin-top: 4px;
      text-align: center;
    }

    .foc-shift-track {
      position: relative;
      width: 100%;
      max-width: 420px;
      height: 10px;
      margin: 0 auto;
      border-radius: 999px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-soft);
      overflow: hidden;
      transition:
        background-color 0.35s ease,
        border-color 0.35s ease;
    }

    .foc-shift-band {
      position: absolute;
      top: 0;
      height: 100%;
      left: 75%;
      width: 20%;
      background: rgba(34, 197, 94, 0.16);
      pointer-events: none;
    }

    .foc-shift-zero {
      position: absolute;
      left: 50%;
      top: 0;
      width: 2px;
      height: 100%;
      background: #4ade80;
    }

    .foc-shift-marker {
      position: absolute;
      top: -2px;
      width: 10px;
      height: 14px;
      border-radius: 999px;
      background: #f97316;
      transform: translateX(-50%);
    }

    .foc-shift-labels {
      display: flex;
      justify-content: space-between;
      max-width: 420px;
      margin: 3px auto 0;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .foc-shift-details {
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--text);
    }

    .note {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 6px;
      transition: color 0.35s ease;
    }

    .note-strong {
      color: var(--text);
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .footer {
      margin-top: 12px;
      font-size: 0.75rem;
      color: #4b5563;
    }

    /* Visualization sub-blocks inside cards */
    .viz-block {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: var(--bg-elevated);
      transition:
        background-color 0.35s ease,
        border-color 0.35s ease;
    }

    .viz-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
      text-align: left;
    }

    /* Trajectory arc graph */
    .traj-graph {
      width: 100%;
      max-width: 420px;
      height: 140px;
      display: block;
      margin: 4px auto 0;
    }

    .traj-axis {
      stroke: var(--axis);
      stroke-width: 0.6;
      transition: stroke 0.35s ease;
    }

    #trajGraphLine {
      stroke: #3b82f6;
      stroke-width: 1.5;
      fill: none;
    }

    .traj-legend {
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: center;
    }

    .traj-label {
      fill: var(--text-muted);
      font-size: 4px;
      transition: fill 0.35s ease;
    }

    /* Momentum band & help badge */
    .momentum-band-text {
      font-size: 0.8rem;
    }

    .help-badge {
      display: inline-block;
      margin-top: 3px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: var(--bg-elevated);
      font-size: 0.7rem;
      color: var(--text);
      cursor: pointer;
      transition:
        background-color 0.35s ease,
        color 0.35s ease,
        border-color 0.35s ease;
    }

    .help-badge:hover {
      border-color: #3b82f6;
    }

    .help-panel {
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: var(--bg-elevated);
      font-size: 0.75rem;
      color: var(--text-muted);
      transition:
        background-color 0.35s ease,
        border-color 0.35s ease,
        color 0.35s ease;
    }

    .help-panel ul {
      margin: 4px 0 0 16px;
      padding: 0;
    }

    .help-panel li {
      margin: 2px 0;
    }

    /* Data table */
    .data-table-wrapper {
      overflow-x: auto;
      margin-top: 4px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      min-width: 100%;
    }

    .data-table th,
    .data-table td {
      border: 1px solid var(--border);
      padding: 4px 6px;
      text-align: left;
      white-space: nowrap;
      transition: background-color 0.35s ease, border-color 0.35s ease, color 0.35s ease;
    }

    .data-table th {
      background: var(--bg-card);
      color: var(--text-muted);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .data-table tbody tr:nth-child(odd) {
      background: var(--bg-card);
    }

    .data-table tbody tr:nth-child(even) {
      background: var(--bg-elevated);
    }

    /* Theme toggle button (reuses help-badge) */
    #themeToggle {
      margin-left: auto;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    #themeToggle span {
      font-size: 0.7rem;
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Arrow Tune Calculator</h1>
    <div class="subtitle">
      Enter your bow and arrow details to see weight, FOC, grains per pound, grains per inch, and basic kinetic data.
    </div>

    <div class="meta">
      <span id="appVersion">v0.9.8</span>
      <span>â€¢</span>
      <span id="buildDateText">Build date: 2025-11-23</span>

      <button id="themeToggle" class="help-badge">
        <span id="themeToggleIcon">ðŸŒ™</span>
        <span id="themeToggleText">Dark</span>
      </button>
    </div>

    <div class="grid">
      <!-- LEFT: INPUTS + NOTES -->
      <div>
        <!-- Bow -->
        <div class="card">
          <h2>Bow</h2>
          <div class="card-subtitle">
            Basic bow setup so we can relate arrow weight to draw weight and estimate speed and momentum.
          </div>
          <div class="field-row">
            <div class="field">
              <label
                for="bowDrawWeightLb"
                title="Bow draw weight in pounds at your full draw length."
              >
                Draw weight (lb)
              </label>
              <input id="bowDrawWeightLb" type="number" value="70" step="0.1" />
            </div>
            <div class="field">
              <label
                for="bowDrawLengthIn"
                title="Your bow's draw length setting in inches."
              >
                Draw length (in)
              </label>
              <input id="bowDrawLengthIn" type="number" value="28" step="0.1" />
            </div>
          </div>
          <div class="field-row">
            <div class="field">
              <label
                for="launchFps"
                title="Estimated arrow speed at the bow, in feet per second."
              >
                Launch speed estimate (fps)
              </label>
              <input id="launchFps" type="number" value="280" step="1" />
            </div>
            <div class="field">
              <label
                for="fpsLossPer10Yards"
                title="Approximate speed loss in fps for every 10 yards of travel."
              >
                Speed loss / 10 yards (fps)
              </label>
              <input id="fpsLossPer10Yards" type="number" value="3" step="0.5" />
            </div>
          </div>
          <div class="field">
            <label
              for="bowModel"
              title="Bow model and year for reference, since FPS is tied to bow design and performance."
            >
              Bow model &amp; year
            </label>
            <input
              id="bowModel"
              type="text"
              placeholder="e.g. 2025 Hoyt RX-9"
            />
          </div>
        </div>

        <!-- Arrow Info -->
        <div class="card">
          <h2>Arrow Info</h2>
          <div class="card-subtitle">
            High-level info so you can label and compare different arrow builds.
          </div>
          <div class="field">
            <label
              for="arrowName"
              title="Optional name for this arrow setup, such as brand and model."
            >
              Arrow name
            </label>
            <input
              id="arrowName"
              type="text"
              placeholder="e.g. Easton Axis 5mm 300 spine"
            />
          </div>
          <div class="field">
            <label
              for="arrowSpine"
              title="Arrow spine rating (stiffness), such as 250, 300, 340, 400."
            >
              Arrow spine (rating)
            </label>
            <input
              id="arrowSpine"
              type="number"
              step="1"
              placeholder="e.g. 300"
            />
          </div>
        </div>

        <!-- Arrow Shaft & Total Weight -->
        <div class="card">
          <h2>Arrow Shaft & Total Weight</h2>
          <div class="card-subtitle">
            Arrow length, bare shaft weight, and the finished total arrow weight from your scale.
          </div>
          <div class="field-row">
            <div class="field">
              <label
                for="arrowLengthIn"
                title="Finished arrow length from nock throat to end of shaft (no point), in inches."
              >
                Arrow length (in)
              </label>
              <input id="arrowLengthIn" type="number" value="28.25" step="0.01" />
            </div>
            <div class="field">
              <label
                for="bareShaftWeightGr"
                title="Weight of the bare arrow shaft only, without any components, in grains."
              >
                Bare shaft weight (gr, optional)
              </label>
              <input id="bareShaftWeightGr" type="number" value="300" step="0.1" />
            </div>
          </div>
          <div class="field">
            <label
              for="totalArrowWeightGrInput"
              title="Finished arrow weight on your scale, including all components. If set, this value is used for all calculations."
            >
              Total arrow weight (gr)
            </label>
            <input
              id="totalArrowWeightGrInput"
              type="number"
              value="509.8"
              step="0.1"
            />
          </div>
          <div class="note">
            Most people only need to enter arrow length, total arrow weight, and balance point. Component weights are optional.
          </div>
        </div>

        <!-- Components (Advanced) -->
        <div class="card">
          <h2>Components (Advanced)</h2>
          <div class="card-subtitle">
            Detailed component weights are only needed if you track each part with a small scale.
          </div>

          <div class="note">
            You can skip this section if you don't know individual component weights. The calculator will still use your total arrow weight above for FOC, GPP, momentum, and trajectory.
          </div>

          <div class="field" style="margin-top:6px;">
            <label style="font-size:0.8rem; display:flex; align-items:center; gap:6px;">
              <input type="checkbox" id="enableComponentDetails" />
              <span>Show advanced component breakdown</span>
            </label>
          </div>

          <div id="componentDetails" style="display:none; margin-top:4px;">
            <div class="field-row">
              <div class="field">
                <label
                  for="nockWeightGr"
                  title="Weight of the arrow nock in grains."
                >
                  Nock weight (gr)
                </label>
                <input id="nockWeightGr" type="number" value="10" step="0.1" />
              </div>
              <div class="field">
                <label
                  for="wrapWeightGr"
                  title="Total weight of any arrow wrap in grains. Use 0 if you don't use wraps."
                >
                  Wrap weight (gr, optional)
                </label>
                <input id="wrapWeightGr" type="number" value="0" step="0.1" />
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label
                  for="vaneCount"
                  title="Number of vanes or fletchings on the arrow, usually 3 or 4."
                >
                  Vane count
                </label>
                <input id="vaneCount" type="number" value="3" step="1" />
              </div>
              <div class="field">
                <label
                  for="vaneWeightGr"
                  title="Weight in grains of a single vane or fletching."
                >
                  Vane weight each (gr)
                </label>
                <input id="vaneWeightGr" type="number" value="9" step="0.1" />
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label
                  for="insertWeightGr"
                  title="Weight in grains of the insert, outsert, or half-out component."
                >
                  Insert / outsert (gr)
                </label>
                <input id="insertWeightGr" type="number" value="50" step="0.1" />
              </div>
              <div class="field">
                <label
                  for="pointWeightGr"
                  title="Weight in grains of the point or broadhead."
                >
                  Point weight (gr)
                </label>
                <input id="pointWeightGr" type="number" value="150" step="0.1" />
              </div>
            </div>

            <div class="field">
              <label
                for="glueWeightGr"
                title="Estimated total glue weight in grains (vanes, insert, nock). 5â€“10 grains is common."
              >
                Glue weight (gr, estimate)
              </label>
              <input id="glueWeightGr" type="number" value="8" step="0.1" />
            </div>
          </div>
        </div>

        <!-- Balance Point -->
        <div class="card">
          <h2>Balance Point</h2>
          <div class="card-subtitle">
            Where the finished arrow actually balances, which drives FOC and front/back weight bias.
          </div>
          <div class="field">
            <label
              for="balancePointIn"
              title="Distance from the nock throat to the balance point of the finished arrow, in inches."
            >
              Balance point from nock (in)
            </label>
            <input id="balancePointIn" type="number" value="18.5" step="0.01" />
          </div>
          <div class="note">
            Measure from the nock throat to the balance point of the finished arrow.
          </div>
        </div>

        <!-- Notes -->
        <div class="card">
          <h2>Notes</h2>
          <div class="card-subtitle">
            Freeform notes for this build â€” tuning details, hunts, broadheads used, and anything else you want to remember.
          </div>
          <div class="field">
            <label
              for="userNotes"
              title="Any notes about this arrow, bow, tuning, or hunt. Not saved permanently yet."
            >
              Notes for this arrow setup
            </label>
            <textarea id="userNotes" placeholder="Example: Broadhead tune at 30 yards, used on elk hunt, etc."></textarea>
          </div>
          <div class="note">
            Notes stay in this browser tab only for now. Future versions may allow saving multiple arrows.
          </div>
        </div>
      </div>

      <!-- RIGHT: RESULTS & VISUALS -->
      <div>
        <!-- Core results -->
        <div class="card">
          <h2>Results</h2>
          <div class="card-subtitle">
            Big-picture summary of your arrow build: total weight, FOC, grains per pound, and grains per inch.
          </div>

          <div class="results-row">
            <span class="label">Arrow</span>
            <span class="value" id="arrowNameDisplay">Unnamed arrow</span>
          </div>
          <div class="results-row">
            <span class="label">Spine</span>
            <span class="value" id="arrowSpineDisplay">â€“</span>
          </div>

          <div class="results-row" style="margin-top:4px;">
            <span class="label">Total arrow weight</span>
            <span class="value" id="totalArrowWeightGr">â€“</span>
          </div>
          <div class="results-row">
            <span class="label">
              FOC
              <span id="focTag" class="foc-tag foc-normal" style="display:none;"></span>
            </span>
            <span class="value" id="focPercent">â€“</span>
          </div>
          <div class="results-row">
            <span class="label">
              Grains per pound (GPP)
              <span id="gppTag" class="foc-tag gpp-normal" style="display:none;"></span>
            </span>
            <span class="value" id="grainsPerPound">â€“</span>
          </div>
          <div class="results-row">
            <span class="label">Shaft GPI (bare shaft)</span>
            <span class="value" id="shaftGpi">â€“</span>
          </div>
          <div class="results-row">
            <span class="label">
              Arrow GPI (full arrow)
              <span id="gpiTag" class="foc-tag gpi-normal" style="display:none;"></span>
            </span>
            <span class="value" id="arrowGpi">â€“</span>
          </div>

          <div class="note">
            <span
              id="resultsHelpToggle"
              class="help-badge"
              title="Click to expand explanations of FOC, GPP, and GPI classifications."
            >
              Learn more about these bands
            </span>
          </div>

          <div id="resultsHelpPanel" class="help-panel" style="display:none;">
            <div class="note-strong">About FOC, GPP, and GPI Bands</div>

            <p style="margin:4px 0;">
              These classifications are based on common bowhunting tuning guidance, manufacturer data,
              and widely adopted rules of thumb used by coaches and hunters.
            </p>

            <ul>
              <li>
                <strong>FOC (Front of Center)</strong><br />
                â€¢ <em>Low (&lt;10%)</em> â€” more forgiving flight but less stable with broadheads<br />
                â€¢ <em>Typical hunting (10â€“18%)</em> â€” most stable, good overall penetration<br />
                â€¢ <em>High (&gt;18%)</em> â€” strong penetration, but can require careful spine tuning
              </li>

              <li>
                <strong>GPP (Grains per Pound)</strong><br />
                â€¢ <em>Light (&lt;5.3 gpp)</em> â€” fast &amp; flat but lower momentum<br />
                â€¢ <em>Typical hunting (5.3â€“6.3 gpp)</em> â€” good blend of speed &amp; penetration<br />
                â€¢ <em>Heavy (&gt;6.3 gpp)</em> â€” quieter, higher momentum, slower trajectory
              </li>

              <li>
                <strong>GPI (Full arrow grains-per-inch)</strong><br />
                â€¢ <em>Light (&lt;9.0 gpi)</em> â€” common for deer / longer shots<br />
                â€¢ <em>Typical hunting (9.0â€“11.0 gpi)</em> â€” where most hunters land<br />
                â€¢ <em>Heavy (11â€“13 gpi)</em> â€” elk, bear, penetration builds<br />
                â€¢ <em>Ultra-heavy (&gt;13 gpi)</em> â€” Ashby-style setups, short-range focus
              </li>
            </ul>

            <p style="margin:4px 0;">
              These bands help compare arrow builds, but
              <strong>tuning and shot placement matter more than the numbers alone.</strong>
            </p>
          </div>
        </div>

        <!-- Kinetics: FPS, Momentum & Trajectory -->
        <div class="card">
          <h2>Kinetics (FPS, Momentum & Trajectory)</h2>
          <div class="card-subtitle">
            How hard and how fast the arrow is moving at the bow and downrange, plus a simplified flight arc.
          </div>

          <div class="results-row">
            <span class="label">Launch</span>
            <span class="value" id="launchKineticsDisplay">â€“ fps / â€“ slugÂ·ft/s</span>
          </div>

          <div class="results-row">
            <span class="label">
              Distance 1
              <span class="note">
                (<input
                  id="dist1Yards"
                  type="number"
                  value="30"
                  step="1"
                  style="width: 3rem; background: var(--bg-input); color: var(--text); border:1px solid var(--border); border-radius:4px; padding:2px 4px; font-size:0.75rem;"
                  title="Distance in yards for the first FPS/momentum estimate."
                /> yd)
              </span>
            </span>
            <span class="value" id="dist1KineticsDisplay">â€“ fps / â€“ slugÂ·ft/s</span>
          </div>

          <div class="results-row">
            <span class="label">
              Distance 2
              <span class="note">
                (<input
                  id="dist2Yards"
                  type="number"
                  value="60"
                  step="1"
                  style="width: 3rem; background: var(--bg-input); color: var(--text); border:1px solid var(--border); border-radius:4px; padding:2px 4px; font-size:0.75rem;"
                  title="Distance in yards for the second FPS/momentum estimate. This also drives the arc range."
                /> yd)
              </span>
            </span>
            <span class="value" id="dist2KineticsDisplay">â€“ fps / â€“ slugÂ·ft/s</span>
          </div>

          <div class="results-row">
            <span class="label">Game momentum band (farthest distance)</span>
            <span class="value">
              <span id="momentumBandLabel" class="momentum-band-text">â€“</span>
            </span>
          </div>

          <div class="note">
            Momentum is computed as: (arrow grains Ã— fps) / 225,400.
            Values are approximate and based on your launch FPS and speed loss settings.
          </div>

          <div class="note">
            <span
              id="bandsHelpToggle"
              class="help-badge"
              title="Click to expand a short explanation of how these bands are commonly used."
            >
              Learn more about these bands
            </span>
          </div>

          <div
            id="bandsHelpPanel"
            class="help-panel"
            style="display: none;"
          >
            <div class="note-strong">
              These bands are rules of thumb â€” not guarantees.
            </div>
            <p style="margin:4px 0%;">
              They come from:
            </p>
            <ul>
              <li>Arrow penetration studies that focus on <strong>momentum</strong> (like Dr. Ed Ashbyâ€™s work).</li>
              <li>Common <strong>kinetic energy charts</strong> published by arrow and broadhead manufacturers.</li>
            </ul>
            <p style="margin:4px 0%;">
              Typical interpretations:
            </p>
            <ul>
              <li><strong>~0.25â€“0.35 slugÂ·ft/s</strong>: small game, turkey.</li>
              <li><strong>~0.30â€“0.45 slugÂ·ft/s</strong>: deer-sized game (whitetail, pronghorn).</li>
              <li><strong>~0.45â€“0.60+ slugÂ·ft/s</strong>: larger game like elk or black bear.</li>
              <li><strong>0.60+ slugÂ·ft/s</strong>: very large or dangerous game.</li>
            </ul>
            <p style="margin:4px 0%;">
              They assume sharp, well-built broadheads and legal setups.
              <strong>Shot placement, arrow flight, and local regulations matter more than any single number.</strong>
            </p>
          </div>

          <!-- Trajectory arc visualization -->
          <div class="viz-block">
            <div class="viz-title">Trajectory Arc (Distance vs Height)</div>
            <div class="note" style="margin-top:0; margin-bottom:4px;">
              Shows a simple arc from bow to target based on your arc range, with a little extra room beyond the target.
            </div>

            <div class="note" style="margin-top:0; margin-bottom:4px;">
              Arc range:
              <input
                id="trajMaxDistanceYards"
                type="number"
                value="80"
                step="5"
                style="width: 3.5rem; background: var(--bg-input); color: var(--text); border:1px solid var(--border); border-radius:4px; padding:2px 4px; font-size:0.75rem;"
                title="Maximum distance (yards) for the displayed arc. Horizontal axis will extend slightly beyond this."
              /> yd (visual only)
            </div>

            <svg
              id="trajGraph"
              viewBox="0 0 100 60"
              preserveAspectRatio="none"
              class="traj-graph"
            >
              <!-- Axes: x = yards, y = feet -->
              <line x1="0" y1="50" x2="100" y2="50" class="traj-axis"></line>
              <line x1="0" y1="10" x2="0" y2="50" class="traj-axis"></line>

              <!-- Axis labels -->
              <text x="50" y="58" text-anchor="middle" class="traj-label">
                Distance (yards)
              </text>
              <text
                x="2"
                y="12"
                text-anchor="start"
                class="traj-label"
              >
                Height (feet)
              </text>

              <!-- Data line (yards -> feet arc) -->
              <polyline id="trajGraphLine" points=""></polyline>

              <!-- Peak dot & label -->
              <circle id="trajPeakDot" r="1.3" fill="#f97316" cx="-10" cy="-10"></circle>
              <text
                id="trajPeakLabel"
                x="-10"
                y="-10"
                text-anchor="middle"
                class="traj-label"
              ></text>

              <!-- Launch angle line & label at left -->
              <line
                id="trajAngleLine"
                x1="0"
                y1="50"
                x2="-10"
                y2="-10"
                stroke="#22c55e"
                stroke-width="0.8"
              ></line>
              <text
                id="trajAngleLabel"
                x="8"
                y="46"
                text-anchor="start"
                class="traj-label"
              ></text>

              <!-- Impact momentum label at right (raised & nudged left) -->
              <text
                id="trajImpactMomentumLabel"
                x="90"
                y="18"
                text-anchor="end"
                class="traj-label"
              ></text>
            </svg>
            <div class="traj-legend" id="trajGraphLegend">
              Left = bow, right = target. Arc height, angle & impact momentum are approximate.
            </div>
          </div>
        </div>

        <!-- FOC & weight visuals -->
        <div class="card">
          <h2>FOC & Weight Distribution</h2>
          <div class="card-subtitle">
            Visuals that show how weight is spread along the arrow and how far forward the balance point sits.
          </div>

          <!-- 1) Arrow balance along length (above FOC gauge) -->
          <div class="viz-block arrow-visual">
            <div class="viz-title">Arrow Balance (Nock â†’ Point)</div>
            <div class="arrow-ends">
              <span>Nock / back of arrow</span>
              <span>Point / front of arrow</span>
            </div>
            <div class="arrow-track">
              <div class="arrow-axis"></div>
              <div class="arrow-center-line"></div>
              <div id="balanceMarker" class="arrow-balance-marker"></div>
            </div>
            <div class="arrow-legend">
              Green line = geometric center, orange marker = balance point (driven by FOC).
            </div>
          </div>

          <!-- 2) FOC Shift Gauge -->
          <div class="viz-block foc-shift-visual">
            <div class="viz-title">FOC Shift Gauge</div>
            <div class="foc-shift-track">
              <!-- Recommended FOC band (~10â€“18% forward of center) -->
              <div class="foc-shift-band"></div>
              <div class="foc-shift-zero"></div>
              <div id="focShiftMarker" class="foc-shift-marker"></div>
            </div>
            <div class="foc-shift-labels">
              <span>More weight toward nock / behind center</span>
              <span>More weight toward point / forward of center</span>
            </div>
            <div class="foc-shift-details" id="focShiftDetails">
              FOC shift: â€“
            </div>
            <div class="note" style="margin-top:4px;">
              Shaded zone â‰ˆ common bowhunting FOC range (~10â€“18% forward of center).
            </div>
          </div>

          <!-- 3) Weight composition bar -->
          <div class="viz-block weight-visual">
            <div class="viz-title">Weight Composition</div>
            <div class="weight-bar">
              <div class="weight-mid-line"></div>
              <div id="weightShaft" class="weight-shaft"></div>
              <div id="weightPoint" class="weight-point"></div>
              <div id="weightFletch" class="weight-fletch"></div>
            </div>
            <div class="weight-legend">
              <span><span class="dot" style="background:#1d4ed8;"></span> Shaft</span>
              <span><span class="dot" style="background:#ea580c;"></span> Point system</span>
              <span><span class="dot" style="background:#a855f7;"></span> Nock / wrap / vanes + glue</span>
            </div>
            <div class="note" id="weightTotals">
              Shaft: â€“ gr (â€“ %) â€¢ Point system: â€“ gr (â€“ %) â€¢ Nock / wrap / vanes + glue: â€“ gr (â€“ %)
            </div>
            <div class="note">
              Center line shows the halfway mark: if the blue shaft segment crosses it, more than half of total arrow weight is in the shaft.
            </div>
          </div>
        </div>

        <!-- Data Table -->
        <div class="card">
          <h2>Data Table (Inputs & Calculated)</h2>
          <div class="card-subtitle">
            Spreadsheet-style view of what you entered and what the calculator derived from it, with source labels.
          </div>
          <div class="data-table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Field</th>
                  <th>Source</th>
                  <th>Value</th>
                  <th>Units</th>
                </tr>
              </thead>
              <tbody id="summaryTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      Built by David Marcus â€¢ Arrow Tune Calculator â€¢ MIT Licensed
    </div>
  </div>

  <script>
    // -----------------------------
    // Helper functions
    // -----------------------------
    function readNumber(id) {
      const el = document.getElementById(id);
      const value = parseFloat(el?.value ?? "");
      return isNaN(value) ? 0 : value;
    }

    function formatNumber(value, digits) {
      if (!isFinite(value)) return "â€“";
      return value.toFixed(digits);
    }

    function updateArrowNameDisplay() {
      const nameInput = document.getElementById("arrowName");
      const nameDisplay = document.getElementById("arrowNameDisplay");
      if (!nameInput || !nameDisplay) return;

      const value = nameInput.value.trim();
      nameDisplay.textContent = value || "Unnamed arrow";
    }

    function estimateFpsAtDistance(launchFps, fpsLossPer10Yards, distanceYards) {
      if (!isFinite(launchFps) || launchFps <= 0) return NaN;
      if (!isFinite(fpsLossPer10Yards) || fpsLossPer10Yards < 0) return launchFps;

      const loss = (fpsLossPer10Yards * distanceYards) / 10;
      const v = launchFps - loss;
      const vClamped = v > 0 ? v : 0;
      return vClamped;
    }

    function computeMomentumSlugFtPerSec(arrowWeightGrains, fps) {
      if (!isFinite(arrowWeightGrains) || !isFinite(fps)) return NaN;
      if (arrowWeightGrains <= 0 || fps <= 0) return NaN;
      // mass (slugs) = grains / 225,400; momentum = mass * velocity.
      return (arrowWeightGrains * fps) / 225400;
    }

    function classifyMomentumBand(momentum) {
      if (!isFinite(momentum) || momentum <= 0) return null;

      if (momentum < 0.25) {
        return "very light / target practice";
      } else if (momentum < 0.35) {
        return "small game";
      } else if (momentum < 0.45) {
        return "deer-size game";
      } else if (momentum < 0.60) {
        return "large game (elk/bear)";
      } else {
        return "very large / dangerous game";
      }
    }

    /**
     * Update a simple leftâ†’right trajectory arc:
     *  - X axis = distance in yards (0 â†’ slightly beyond arcRangeYards)
     *  - Y axis = height in feet (fixed 0â€“20 ft)
     * The arc range slider chooses how far the arrow flies; the graph adds a little extra
     * horizontal space beyond that, with tighter scaling at close range so the arc is visible.
     */
    function updateTrajectoryGraph(launchFps, arcRangeYards, impactMomentum) {
      const lineEl = document.getElementById("trajGraphLine");
      const legendEl = document.getElementById("trajGraphLegend");
      const peakDot = document.getElementById("trajPeakDot");
      const peakLabel = document.getElementById("trajPeakLabel");
      const angleLine = document.getElementById("trajAngleLine");
      const angleLabel = document.getElementById("trajAngleLabel");
      const impactLabel = document.getElementById("trajImpactMomentumLabel");

      if (
        !lineEl ||
        !legendEl ||
        !peakDot ||
        !peakLabel ||
        !angleLine ||
        !angleLabel ||
        !impactLabel
      ) return;

      const AXIS_MAX_HEIGHT_FEET = 20;  // fixed vertical scale

      if (!isFinite(arcRangeYards) || arcRangeYards <= 0) {
        lineEl.setAttribute("points", "");
        legendEl.textContent =
          "Left = bow, right = target. Arc height, angle & impact momentum are approximate.";
        // move peak & angle elements off-canvas / clear text
        peakDot.setAttribute("cx", "-10");
        peakDot.setAttribute("cy", "-10");
        peakLabel.setAttribute("x", "-10");
        peakLabel.setAttribute("y", "-10");
        peakLabel.textContent = "";
        angleLine.setAttribute("x2", "-10");
        angleLine.setAttribute("y2", "-10");
        angleLabel.textContent = "";
        impactLabel.textContent = "";
        return;
      }

      const effectiveRangeYards = Math.max(arcRangeYards, 0);

      let axisMaxYards;
      if (effectiveRangeYards < 40) {
        axisMaxYards = effectiveRangeYards * 1.15;
      } else if (effectiveRangeYards < 80) {
        axisMaxYards = effectiveRangeYards * 1.10;
      } else {
        axisMaxYards = effectiveRangeYards + 5;
      }
      axisMaxYards = Math.max(axisMaxYards, effectiveRangeYards + 2, 10);

      const baseFps = isFinite(launchFps) && launchFps > 0 ? launchFps : 280;
      const speedFactor = 280 / baseFps; // slower arrows = slightly more arc

      const refRangeYards = 60;
      const normalized = effectiveRangeYards / refRangeYards;
      let HmaxFeet = 4.5 * normalized * normalized * speedFactor;
      HmaxFeet = Math.max(0.3, Math.min(HmaxFeet, AXIS_MAX_HEIGHT_FEET));

      const steps = 30;
      const points = [];

      for (let i = 0; i <= steps; i++) {
        const t = i / steps;
        const dYards = effectiveRangeYards * t;

        const heightFeet = HmaxFeet * 4 * t * (1 - t);

        const x = (dYards / axisMaxYards) * 100;
        let yNorm = heightFeet / AXIS_MAX_HEIGHT_FEET;
        if (yNorm < 0) yNorm = 0;
        if (yNorm > 1) yNorm = 1;
        const y = 50 - yNorm * 40;

        points.push(`${x},${y}`);
      }

      lineEl.setAttribute("points", points.join(" "));

      const midYards = effectiveRangeYards / 2;
      const xPeak = (midYards / axisMaxYards) * 100;
      const yPeakNorm = HmaxFeet / AXIS_MAX_HEIGHT_FEET;
      const yPeak = 50 - yPeakNorm * 40;

      peakDot.setAttribute("cx", xPeak.toString());
      peakDot.setAttribute("cy", yPeak.toString());
      peakLabel.setAttribute("x", xPeak.toString());
      peakLabel.setAttribute("y", (yPeak + 5).toString());
      peakLabel.textContent = HmaxFeet.toFixed(1) + " ft";

      const rangeFeet = effectiveRangeYards * 3;
      let angleDeg = 0;
      if (rangeFeet > 0 && HmaxFeet > 0) {
        const angleRad = Math.atan((4 * HmaxFeet) / rangeFeet);
        angleDeg = angleRad * (180 / Math.PI);
      }

      const originX = 0;
      const originY = 50;
      const angleSvgRad = angleDeg * (Math.PI / 180);
      const lineLen = 12;
      const x2 = originX + Math.cos(angleSvgRad) * lineLen;
      const y2 = originY - Math.sin(angleSvgRad) * lineLen;

      angleLine.setAttribute("x1", originX.toString());
      angleLine.setAttribute("y1", originY.toString());
      angleLine.setAttribute("x2", x2.toString());
      angleLine.setAttribute("y2", y2.toString());
      angleLabel.textContent =
        angleDeg > 0 ? "~" + angleDeg.toFixed(1) + "Â°" : "";

      if (isFinite(impactMomentum) && impactMomentum > 0) {
        impactLabel.textContent = "~" + impactMomentum.toFixed(3) + " slugÂ·ft/s";
      } else {
        impactLabel.textContent = "";
      }

      legendEl.textContent =
        "Horizontal axis â‰ˆ 0â€“" +
        Math.round(axisMaxYards) +
        " yd (arc set to ~" +
        Math.round(effectiveRangeYards) +
        " yd). Peak height â‰ˆ " +
        HmaxFeet.toFixed(1) +
        " ft, launch angle â‰ˆ " +
        angleDeg.toFixed(1) +
        "Â°, impact â‰ˆ " +
        (isFinite(impactMomentum) ? impactMomentum.toFixed(3) + " slugÂ·ft/s" : "â€“") +
        ".";
    }

    // -----------------------------
    // Main calculation & UI update
    // -----------------------------
    function calculateAndUpdate() {
      // Bow
      const bowDrawWeightLb = readNumber("bowDrawWeightLb");
      const bowDrawLengthIn = readNumber("bowDrawLengthIn");
      const launchFps = readNumber("launchFps");
      const fpsLossPer10Yards = readNumber("fpsLossPer10Yards");

      // Distances
      const dist1Yards = readNumber("dist1Yards");
      const dist2Yards = readNumber("dist2Yards");
      const trajMaxDistanceYards = readNumber("trajMaxDistanceYards");

      let arcRangeYards = trajMaxDistanceYards > 0 ? trajMaxDistanceYards : 10;

      // Arrow geometry
      const arrowLengthIn = readNumber("arrowLengthIn");
      const bareShaftWeightGr = readNumber("bareShaftWeightGr");
      const totalArrowWeightGrInput = readNumber("totalArrowWeightGrInput");

      // Components
      const nockWeightGr = readNumber("nockWeightGr");
      const wrapWeightGr = readNumber("wrapWeightGr");
      const vaneCount = readNumber("vaneCount");
      const vaneWeightGr = readNumber("vaneWeightGr");
      const insertWeightGr = readNumber("insertWeightGr");
      const pointWeightGr = readNumber("pointWeightGr");
      const glueWeightGr = readNumber("glueWeightGr");

      // Attributes
      const balancePointIn = readNumber("balancePointIn");
      const arrowSpine = readNumber("arrowSpine");

      // Notes
      const userNotesEl = document.getElementById("userNotes");
      const userNotesStr = userNotesEl ? userNotesEl.value.trim() : "";

      const now = new Date();
      const timestampStr = now.toLocaleString();

      const shaftWeightGr = bareShaftWeightGr;
      const pointSystemWeightGr = insertWeightGr + pointWeightGr;
      const fletchingSystemWeightGr =
        nockWeightGr +
        wrapWeightGr +
        vaneCount * vaneWeightGr +
        glueWeightGr;

      const componentTotal =
        shaftWeightGr + pointSystemWeightGr + fletchingSystemWeightGr;

      // Decide which total arrow weight to use:
      // 1) Prefer the explicit total arrow weight input if provided.
      // 2) Otherwise, fall back to sum of shaft + components.
      let totalArrowWeightGr = 0;
      if (totalArrowWeightGrInput > 0) {
        totalArrowWeightGr = totalArrowWeightGrInput;
      } else {
        totalArrowWeightGr = componentTotal;
      }

      let focPercent = NaN;
      let focShiftIn = NaN;
      if (arrowLengthIn > 0) {
        const centerIn = arrowLengthIn / 2;
        focShiftIn = balancePointIn - centerIn;
        focPercent = (focShiftIn / arrowLengthIn) * 100;
      }

      let grainsPerPound = NaN;
      if (bowDrawWeightLb > 0 && totalArrowWeightGr > 0) {
        grainsPerPound = totalArrowWeightGr / bowDrawWeightLb;
      }

      let shaftGpi = NaN;
      let arrowGpi = NaN;
      if (arrowLengthIn > 0) {
        if (shaftWeightGr > 0) {
          shaftGpi = shaftWeightGr / arrowLengthIn;
        }
        if (totalArrowWeightGr > 0) {
          arrowGpi = totalArrowWeightGr / arrowLengthIn;
        }
      }

      const arrowNameInput = document.getElementById("arrowName");
      const arrowNameStr = arrowNameInput
        ? (arrowNameInput.value.trim() || "Unnamed arrow")
        : "Unnamed arrow";

      const totalEl = document.getElementById("totalArrowWeightGr");
      const focEl = document.getElementById("focPercent");
      const gppEl = document.getElementById("grainsPerPound");
      const shaftGpiEl = document.getElementById("shaftGpi");
      const arrowGpiEl = document.getElementById("arrowGpi");
      const spineDisplayEl = document.getElementById("arrowSpineDisplay");

      if (totalEl) {
        totalEl.textContent = totalArrowWeightGr > 0
          ? formatNumber(totalArrowWeightGr, 1) + " gr"
          : "â€“";
      }
      if (focEl) {
        focEl.textContent = isFinite(focPercent)
          ? formatNumber(focPercent, 1) + " %"
          : "â€“";
      }
      if (gppEl) {
        gppEl.textContent = isFinite(grainsPerPound)
          ? formatNumber(grainsPerPound, 1) + " gpp"
          : "â€“";
      }
      if (shaftGpiEl) {
        shaftGpiEl.textContent = isFinite(shaftGpi)
          ? formatNumber(shaftGpi, 2) + " gr/in"
          : "â€“";
      }
      if (arrowGpiEl) {
        arrowGpiEl.textContent = isFinite(arrowGpi)
          ? formatNumber(arrowGpi, 2) + " gr/in"
          : "â€“";
      }
      if (spineDisplayEl) {
        spineDisplayEl.textContent = arrowSpine > 0 ? arrowSpine.toString() : "â€“";
      }

      const focTag = document.getElementById("focTag");
      if (focTag) {
        focTag.style.display = isFinite(focPercent) ? "inline-block" : "none";
        if (isFinite(focPercent)) {
          focTag.classList.remove("foc-low", "foc-normal", "foc-high");
          let text = "";
          if (focPercent < 10) {
            focTag.classList.add("foc-low");
            text = "Low";
          } else if (focPercent <= 18) {
            focTag.classList.add("foc-normal");
            text = "Typical hunting";
          } else {
            focTag.classList.add("foc-high");
            text = "High";
          }
          focTag.textContent = text;
        }
      }

      const gppTag = document.getElementById("gppTag");
      if (gppTag) {
        const gpp = grainsPerPound;
        gppTag.style.display = isFinite(gpp) ? "inline-block" : "none";
        if (isFinite(gpp)) {
          gppTag.classList.remove("gpp-low", "gpp-normal", "gpp-high");
          let text = "";
          if (gpp < 5.3) {
            gppTag.classList.add("gpp-low");
            text = "Light";
          } else if (gpp <= 6.3) {
            gppTag.classList.add("gpp-normal");
            text = "Typical hunting";
          } else {
            gppTag.classList.add("gpp-high");
            text = "Heavy";
          }
          gppTag.textContent = text;
        }
      }

      const gpiTag = document.getElementById("gpiTag");
      if (gpiTag) {
        const gpi = arrowGpi;
        gpiTag.style.display = isFinite(gpi) ? "inline-block" : "none";
        if (isFinite(gpi)) {
          gpiTag.classList.remove("gpi-light", "gpi-normal", "gpi-heavy", "gpi-ultra");
          let text = "";
          if (gpi < 9.0) {
            gpiTag.classList.add("gpi-light");
            text = "Light";
          } else if (gpi <= 11.0) {
            gpiTag.classList.add("gpi-normal");
            text = "Typical hunting";
          } else if (gpi <= 13.0) {
            gpiTag.classList.add("gpi-heavy");
            text = "Heavy";
          } else {
            gpiTag.classList.add("gpi-ultra");
            text = "Ultra-heavy";
          }
          gpiTag.textContent = text;
        }
      }

      const launchFpsUsed = launchFps > 0 ? launchFps : NaN;
      const fps1 = estimateFpsAtDistance(
        launchFpsUsed,
        fpsLossPer10Yards,
        dist1Yards
      );
      const fps2 = estimateFpsAtDistance(
        launchFpsUsed,
        fpsLossPer10Yards,
        dist2Yards
      );

      const launchMomentum = computeMomentumSlugFtPerSec(
        totalArrowWeightGr,
        launchFpsUsed
      );
      const momentum1 = computeMomentumSlugFtPerSec(totalArrowWeightGr, fps1);
      const momentum2 = computeMomentumSlugFtPerSec(totalArrowWeightGr, fps2);

      const launchKineticsDisplay =
        document.getElementById("launchKineticsDisplay");
      const dist1KineticsDisplay =
        document.getElementById("dist1KineticsDisplay");
      const dist2KineticsDisplay =
        document.getElementById("dist2KineticsDisplay");
      const momentumBandLabel = document.getElementById("momentumBandLabel");

      if (launchKineticsDisplay) {
        const fpsText = isFinite(launchFpsUsed)
          ? formatNumber(launchFpsUsed, 0) + " fps"
          : "â€“ fps";
        const momText = isFinite(launchMomentum)
          ? formatNumber(launchMomentum, 3) + " slugÂ·ft/s"
          : "â€“ slugÂ·ft/s";
        launchKineticsDisplay.textContent = fpsText + " / " + momText;
      }
      if (dist1KineticsDisplay) {
        const fpsText = isFinite(fps1)
          ? formatNumber(fps1, 0) + " fps"
          : "â€“ fps";
        const momText = isFinite(momentum1)
          ? formatNumber(momentum1, 3) + " slugÂ·ft/s"
          : "â€“ slugÂ·ft/s";
        dist1KineticsDisplay.textContent = fpsText + " / " + momText;
      }
      if (dist2KineticsDisplay) {
        const fpsText = isFinite(fps2)
          ? formatNumber(fps2, 0) + " fps"
          : "â€“ fps";
        const momText = isFinite(momentum2)
          ? formatNumber(momentum2, 3) + " slugÂ·ft/s"
          : "â€“ slugÂ·ft/s";
        dist2KineticsDisplay.textContent = fpsText + " / " + momText;
      }

      if (momentumBandLabel) {
        const farthestDist = Math.max(dist1Yards, dist2Yards, arcRangeYards);
        if (!isFinite(farthestDist) || farthestDist <= 0 || totalArrowWeightGr <= 0) {
          momentumBandLabel.textContent = "â€“";
        } else {
          const fpsFar = estimateFpsAtDistance(
            launchFpsUsed,
            fpsLossPer10Yards,
            farthestDist
          );
          const momentumFar = computeMomentumSlugFtPerSec(
            totalArrowWeightGr,
            fpsFar
          );
          const bandName = classifyMomentumBand(momentumFar);
          if (!bandName || !isFinite(momentumFar) || momentumFar <= 0) {
            momentumBandLabel.textContent = "â€“";
          } else {
            momentumBandLabel.textContent =
              "At ~" +
              Math.round(farthestDist) +
              " yd: " +
              formatNumber(momentumFar, 3) +
              " slugÂ·ft/s â†’ in the '" +
              bandName +
              "' band.";
          }
        }
      }

      const fpsImpact = estimateFpsAtDistance(
        launchFpsUsed,
        fpsLossPer10Yards,
        arcRangeYards
      );
      const impactMomentum = computeMomentumSlugFtPerSec(
        totalArrowWeightGr,
        fpsImpact
      );

      updateTrajectoryGraph(launchFpsUsed, arcRangeYards, impactMomentum);

      const balanceMarker = document.getElementById("balanceMarker");
      if (balanceMarker) {
        if (arrowLengthIn > 0 && isFinite(balancePointIn)) {
          let ratio = balancePointIn / arrowLengthIn;
          if (ratio < 0) ratio = 0;
          if (ratio > 1) ratio = 1;
          const percent = ratio * 100;
          balanceMarker.style.left = percent + "%";
        } else {
          balanceMarker.style.left = "50%";
        }
      }

      const focShiftMarker = document.getElementById("focShiftMarker");
      const focShiftDetails = document.getElementById("focShiftDetails");

      if (focShiftMarker) {
        if (isFinite(focPercent)) {
          const MAX_RANGE = 20;
          let ratio = focPercent / MAX_RANGE;
          if (ratio < -1) ratio = -1;
          if (ratio > 1) ratio = 1;
          const percent = 50 + ratio * 50;
          focShiftMarker.style.left = percent + "%";
        } else {
          focShiftMarker.style.left = "50%";
        }
      }

      if (focShiftDetails) {
        if (isFinite(focShiftIn) && isFinite(focPercent)) {
          const direction =
            focShiftIn > 0
              ? "forward of center"
              : focShiftIn < 0
              ? "behind center"
              : "exactly at center";
          const inches = Math.abs(focShiftIn);
          if (inches === 0) {
            focShiftDetails.textContent =
              "FOC shift: 0.00 in (0.0 %) â€“ balance at exact center.";
          } else {
            focShiftDetails.textContent =
              "FOC shift: " +
              formatNumber(inches, 2) +
              " in (" +
              formatNumber(Math.abs(focPercent), 1) +
              " %) " +
              direction +
              ".";
          }
        } else {
          focShiftDetails.textContent = "FOC shift: â€“";
        }
      }

      const weightShaft = document.getElementById("weightShaft");
      const weightPoint = document.getElementById("weightPoint");
      const weightFletch = document.getElementById("weightFletch");
      const weightTotalsEl = document.getElementById("weightTotals");

      if (weightShaft && weightPoint && weightFletch) {
        if (componentTotal > 0) {
          const shaftPct = (shaftWeightGr / componentTotal) * 100;
          const pointPct = (pointSystemWeightGr / componentTotal) * 100;
          const fletchPct =
            (fletchingSystemWeightGr / componentTotal) * 100;

          weightShaft.style.width = shaftPct + "%";
          weightPoint.style.width = pointPct + "%";
          weightFletch.style.width = fletchPct + "%";

          if (weightTotalsEl) {
            weightTotalsEl.textContent =
              "Shaft: " +
              formatNumber(shaftWeightGr, 1) +
              " gr (" +
              formatNumber(shaftPct, 1) +
              " %) â€¢ Point system: " +
              formatNumber(pointSystemWeightGr, 1) +
              " gr (" +
              formatNumber(pointPct, 1) +
              " %) â€¢ Nock / wrap / vanes + glue: " +
              formatNumber(fletchingSystemWeightGr, 1) +
              " gr (" +
              formatNumber(fletchPct, 1) +
              " %)";
          }
        } else {
          weightShaft.style.width = "33%";
          weightPoint.style.width = "33%";
          weightFletch.style.width = "34%";
          if (weightTotalsEl) {
            weightTotalsEl.textContent =
              "Shaft: â€“ gr (â€“ %) â€¢ Point system: â€“ gr (â€“ %) â€¢ Nock / wrap / vanes + glue: â€“ gr (â€“ %)";
          }
        }
      }

      const tableBody = document.getElementById("summaryTableBody");
      if (tableBody) {
        const rows = [];

        rows.push(["Meta", "Timestamp", "Auto", timestampStr, ""]);

        rows.push(["Bow", "Draw weight", "Input", formatNumber(bowDrawWeightLb, 1), "lb"]);
        rows.push(["Bow", "Draw length", "Input", formatNumber(bowDrawLengthIn, 1), "in"]);
        rows.push(["Bow", "Launch speed estimate", "Input", formatNumber(launchFps, 0), "fps"]);
        rows.push(["Bow", "Speed loss / 10 yd", "Input", formatNumber(fpsLossPer10Yards, 1), "fps/10yd"]);

        rows.push(["Distances", "Distance 1", "Input", formatNumber(dist1Yards, 0), "yd"]);
        rows.push(["Distances", "Distance 2", "Input", formatNumber(dist2Yards, 0), "yd"]);
        rows.push(["Distances", "Arc range (visual)", "Input", formatNumber(arcRangeYards, 0), "yd"]);

        rows.push(["Arrow", "Name", "Input", arrowNameStr, ""]);
        rows.push(["Arrow", "Spine", "Input", arrowSpine > 0 ? arrowSpine.toString() : "â€“", ""]);
        rows.push(["Arrow", "Arrow length", "Input", formatNumber(arrowLengthIn, 2), "in"]);
        rows.push(["Arrow", "Bare shaft weight", "Input", formatNumber(bareShaftWeightGr, 1), "gr"]);

        rows.push([
          "Calculated",
          "Total arrow weight",
          totalArrowWeightGrInput > 0 ? "Input (total field)" : "Calculated (components)",
          totalArrowWeightGr > 0 ? formatNumber(totalArrowWeightGr, 1) : "â€“",
          "gr"
        ]);

        rows.push(["Components", "Nock weight", "Input", formatNumber(nockWeightGr, 1), "gr"]);
        rows.push(["Components", "Wrap weight", "Input", formatNumber(wrapWeightGr, 1), "gr"]);
        rows.push(["Components", "Vane count", "Input", formatNumber(vaneCount, 0), ""]);
        rows.push(["Components", "Vane weight each", "Input", formatNumber(vaneWeightGr, 1), "gr"]);
        rows.push(["Components", "Insert / outsert", "Input", formatNumber(insertWeightGr, 1), "gr"]);
        rows.push(["Components", "Point weight", "Input", formatNumber(pointWeightGr, 1), "gr"]);
        rows.push(["Components", "Glue weight (est.)", "Input", formatNumber(glueWeightGr, 1), "gr"]);

        rows.push(["Balance", "Balance point from nock", "Input", formatNumber(balancePointIn, 2), "in"]);

        rows.push(["Calculated", "FOC", "Calculated", isFinite(focPercent) ? formatNumber(focPercent, 1) : "â€“", "%"]);
        rows.push(["Calculated", "Grains per pound (GPP)", "Calculated", isFinite(grainsPerPound) ? formatNumber(grainsPerPound, 1) : "â€“", "gpp"]);
        rows.push(["Calculated", "Shaft GPI (bare)", "Calculated", isFinite(shaftGpi) ? formatNumber(shaftGpi, 2) : "â€“", "gr/in"]);
        rows.push(["Calculated", "Arrow GPI (full)", "Calculated", isFinite(arrowGpi) ? formatNumber(arrowGpi, 2) : "â€“", "gr/in"]);

        rows.push(["Kinetics", "Launch speed", "Calculated", isFinite(launchFpsUsed) ? formatNumber(launchFpsUsed, 0) : "â€“", "fps"]);
        rows.push(["Kinetics", "Launch momentum", "Calculated", isFinite(launchMomentum) ? formatNumber(launchMomentum, 3) : "â€“", "slugÂ·ft/s"]);
        rows.push(["Kinetics", "Speed @ Dist 1", "Calculated", isFinite(fps1) ? formatNumber(fps1, 0) : "â€“", "fps"]);
        rows.push(["Kinetics", "Momentum @ Dist 1", "Calculated", isFinite(momentum1) ? formatNumber(momentum1, 3) : "â€“", "slugÂ·ft/s"]);
        rows.push(["Kinetics", "Speed @ Dist 2", "Calculated", isFinite(fps2) ? formatNumber(fps2, 0) : "â€“", "fps"]);
        rows.push(["Kinetics", "Momentum @ Dist 2", "Calculated", isFinite(momentum2) ? formatNumber(momentum2, 3) : "â€“", "slugÂ·ft/s"]);

        rows.push(["Notes", "Notes", "Input", userNotesStr || "â€”", ""]);

        let html = "";
        for (const [cat, field, source, value, units] of rows) {
          html += "<tr>" +
            "<td>" + cat + "</td>" +
            "<td>" + field + "</td>" +
            "<td>" + source + "</td>" +
            "<td>" + value + "</td>" +
            "<td>" + units + "</td>" +
            "</tr>";
        }
        tableBody.innerHTML = html;
      }
    }

    // -----------------------------
    // Theme toggle
    // -----------------------------
    function updateThemeToggleLabel() {
      const icon = document.getElementById("themeToggleIcon");
      const text = document.getElementById("themeToggleText");
      const isLight = document.body.classList.contains("light-mode");

      if (!icon || !text) return;

      if (isLight) {
        icon.textContent = "ðŸŒž";
        text.textContent = "Light";
      } else {
        icon.textContent = "ðŸŒ™";
        text.textContent = "Dark";
      }
    }

    function initTheme() {
      const saved = localStorage.getItem("arrowTuneTheme");
      if (saved === "light") {
        document.body.classList.add("light-mode");
      }
      updateThemeToggleLabel();

      const btn = document.getElementById("themeToggle");
      if (btn) {
        btn.addEventListener("click", () => {
          const isLight = document.body.classList.toggle("light-mode");
          localStorage.setItem("arrowTuneTheme", isLight ? "light" : "dark");
          updateThemeToggleLabel();
        });
      }
    }

    // -----------------------------
    // Initial setup & event wiring
    // -----------------------------
    const inputIds = [
      "bowDrawWeightLb",
      "bowDrawLengthIn",
      "launchFps",
      "fpsLossPer10Yards",
      "dist1Yards",
      "dist2Yards",
      "trajMaxDistanceYards",
      "arrowLengthIn",
      "bareShaftWeightGr",
      "totalArrowWeightGrInput",
      "nockWeightGr",
      "wrapWeightGr",
      "vaneCount",
      "vaneWeightGr",
      "insertWeightGr",
      "pointWeightGr",
      "glueWeightGr",
      "balancePointIn",
      "arrowSpine",
    ];

    inputIds.forEach((id) => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("input", calculateAndUpdate);
      }
    });

    const arrowNameInput = document.getElementById("arrowName");
    if (arrowNameInput) {
      arrowNameInput.addEventListener("input", () => {
        updateArrowNameDisplay();
        calculateAndUpdate();
      });
    }

    const notesEl = document.getElementById("userNotes");
    if (notesEl) {
      notesEl.addEventListener("input", calculateAndUpdate);
    }

    // Keep Trajectory Arc range loosely in sync with Distance 2 (one-way).
    const trajInput = document.getElementById("trajMaxDistanceYards");
    const dist2Input = document.getElementById("dist2Yards");
    if (trajInput && dist2Input) {
      trajInput.value = dist2Input.value;

      dist2Input.addEventListener("input", () => {
        trajInput.value = dist2Input.value;
        calculateAndUpdate();
      });

      trajInput.addEventListener("input", () => {
        calculateAndUpdate();
      });
    }

    // Momentum bands help toggle
    const bandsHelpToggle = document.getElementById("bandsHelpToggle");
    const bandsHelpPanel = document.getElementById("bandsHelpPanel");
    if (bandsHelpToggle && bandsHelpPanel) {
      bandsHelpToggle.addEventListener("click", () => {
        const isHidden =
          bandsHelpPanel.style.display === "none" ||
          bandsHelpPanel.style.display === "";
        bandsHelpPanel.style.display = isHidden ? "block" : "none";
      });
    }

    // Results (FOC/GPP/GPI) help toggle
    const resultsHelpToggle = document.getElementById("resultsHelpToggle");
    const resultsHelpPanel = document.getElementById("resultsHelpPanel");

    if (resultsHelpToggle && resultsHelpPanel) {
      resultsHelpToggle.addEventListener("click", () => {
        const isHidden =
          resultsHelpPanel.style.display === "none" ||
          resultsHelpPanel.style.display === "";
        resultsHelpPanel.style.display = isHidden ? "block" : "none";
      });
    }

    // Component breakdown visibility toggle
    const compToggle = document.getElementById("enableComponentDetails");
    const compDetails = document.getElementById("componentDetails");
    if (compToggle && compDetails) {
      const syncVisibility = () => {
        compDetails.style.display = compToggle.checked ? "block" : "none";
      };
      compToggle.addEventListener("change", syncVisibility);
      syncVisibility();
    }

    updateArrowNameDisplay();
    initTheme();
    calculateAndUpdate();
  </script>
</body>
</html>
