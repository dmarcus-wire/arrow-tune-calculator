<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Arrow Tune Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!--
    Arrow Tune Calculator
    Author: David Marcus (GitHub: dmarcus-wire)
    Maintainer: David Marcus

    Description:
      A simple browser-based tool to calculate arrow weight, FOC,
      grains per pound, grains per inch, and basic kinetic data (FPS & momentum),
      with visualizations focused on arrow balance, weight distribution,
      and a simple trajectory arc over distance.

    Tech:
      - Single self-contained HTML file (HTML + CSS + JS)
      - No external libraries or frameworks
      - Runs locally in any modern browser

    License: MIT
  -->

  <style>
    /* ---------------------------
       THEME VARIABLES
       --------------------------- */

    :root {
      /* Dark (default) */
      --bg: #020617;
      --bg-card: #020617;
      --bg-elevated: #020617;
      --bg-input: #020617;
      --border: #1f2937;
      --border-soft: #111827;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --axis: #1f2937;
    }

    /* Light mode with archery/hunting feel (tan/olive/earthy) */
    .light-mode {
      --bg: #f5f5f0;
      --bg-card: #fffaf2;
      --bg-elevated: #fffbf2;
      --bg-input: #fff7e6;
      --border: #e2ddcf;
      --border-soft: #d5c8af;
      --text: #1f2933;
      --text-muted: #6b7280;
      --axis: #d0c4aa;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text);
      transition:
        background-color 0.35s ease,
        color 0.35s ease;
    }

    .page {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
      transition: background-color 0.35s ease;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .meta {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 16px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 16px;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid var(--border);
      margin-bottom: 12px;
      transition:
        background-color 0.35s ease,
        border-color 0.35s ease,
        color 0.35s ease;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .card h2 {
      font-size: 1rem;
      margin: 0;
      color: var(--text);
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin: 0;
    }

    .info-btn {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: var(--bg-elevated);
      color: var(--text-muted);
      font-size: 0.7rem;
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      transition:
        background-color 0.25s ease,
        border-color 0.25s ease,
        color 0.25s ease;
    }

    .info-btn:hover {
      border-color: #3b82f6;
      color: #bfdbfe;
    }

    .info-panel {
      display: none;
      margin-bottom: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px dashed var(--border-soft);
      background: var(--bg-elevated);
      font-size: 0.75rem;
      color: var(--text-muted);
      transition:
        background-color 0.35s ease,
        border-color 0.35s ease,
        color 0.35s ease;
    }

    .info-panel p {
      margin: 2px 0;
    }

    .field {
      display: flex;
      flex-direction: column;
      margin-bottom: 8px;
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .field label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .field input,
    .field textarea {
      border-radius: 6px;
      border: 1px solid var(--border);
      padding: 6px 8px;
      font-size: 0.9rem;
      background: var(--bg-input);
      color: var(--text);
      outline: none;
      transition:
        background-color 0.35s ease,
        color 0.35s ease,
        border-color 0.35s ease;
    }

    .field textarea {
      min-height: 80px;
      resize: vertical;
    }

    .field input:focus,
    .field textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #1d4ed8;
    }

    .results-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .results-row span.label {
      color: var(--text-muted);
    }

    .results-row span.value {
      font-weight: 600;
      color: var(--text);
    }

    .foc-tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
      margin-left: 4px;
    }

    .foc-low { background: #3b0764; color: #e9d5ff; }
    .foc-normal { background: #064e3b; color: #bbf7d0; }
    .foc-high { background: #7f1d1d; color: #fecaca; }

    .gpp-low { background: #7f1d1d; color: #fecaca; }
    .gpp-normal { background: #064e3b; color: #bbf7d0; }
    .gpp-high { background: #1e3a8a; color: #bfdbfe; }

    .gpi-light { background: #7f1d1d; color: #fecaca; }
    .gpi-normal { background: #064e3b; color: #bbf7d0; }
    .gpi-heavy { background: #1e3a8a; color: #bfdbfe; }
    .gpi-ultra { background: #4c1d95; color: #e9d5ff; }

    .arrow-visual {
      margin-top: 4px;
      text-align: center;
    }

    .arrow-track {
      position: relative;
      width: 100%;
      max-width: 420px;
      height: 14px;
      margin: 0 auto;
      border-radius: 999px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-soft);
      overflow: hidden;
      transition:
        background-color 0.35s ease,
        border-color 0.35s ease;
    }

    .arrow-center-line {
      position: absolute;
      left: 50%;
      top: 0;
      width: 2px;
      height: 100%;
      background: #22c55e;
    }

    .arrow-balance-marker {
      position: absolute;
      top: 0;
      width: 8px;
      height: 100%;
      border-radius: 999px;
      background: #f97316;
      transform: translateX(-50%);
    }

    .arrow-axis {
      position: absolute;
      left: 0;
      right: 0;
      top: 50%;
      height: 2px;
      background: #1f2937;
      transform: translateY(-50%);
    }

    .arrow-legend {
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .arrow-ends {
      display: flex;
      justify-content: space-between;
      max-width: 420px;
      margin: 0 auto 2px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .weight-bar {
      margin-top: 8px;
      width: 100%;
      max-width: 420px;
      height: 14px;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid var(--border-soft);
      background: var(--bg-elevated);
      display: flex;
      position: relative;
      transition:
        background-color 0.35s ease,
        border-color 0.35s ease;
    }
    .weight-shaft { background: #1d4ed8; }
    .weight-point { background: #ea580c; }
    .weight-fletch { background: #a855f7; }

    .weight-mid-line {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 50%;
      width: 2px;
      background: #111827;
      pointer-events: none;
    }

    .weight-legend {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--text-muted);
      flex-wrap: wrap;
    }

    .dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      margin-right: 4px;
    }

    .foc-shift-visual {
      margin-top: 4px;
      text-align: center;
    }

    .foc-shift-track {
      position: relative;
      width: 100%;
      max-width: 420px;
      height: 10px;
      margin: 0 auto;
      border-radius: 999px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-soft);
      overflow: hidden;
      transition:
        background-color 0.35s ease,
        border-color 0.35s ease;
    }

    .foc-shift-band {
      position: absolute;
      top: 0;
      height: 100%;
      left: 75%;
      width: 20%;
      background: rgba(34, 197, 94, 0.16);
      pointer-events: none;
    }

    .foc-shift-zero {
      position: absolute;
      left: 50%;
      top: 0;
      width: 2px;
      height: 100%;
      background: #4ade80;
    }

    .foc-shift-marker {
      position: absolute;
      top: -2px;
      width: 10px;
      height: 14px;
      border-radius: 999px;
      background: #f97316;
      transform: translateX(-50%);
    }

    .foc-shift-labels {
      display: flex;
      justify-content: space-between;
      max-width: 420px;
      margin: 3px auto 0;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .foc-shift-details {
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--text);
    }

    .note {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 6px;
      transition: color 0.35s ease;
    }

    .note-strong {
      color: var(--text);
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .footer {
      margin-top: 12px;
      font-size: 0.75rem;
      color: #4b5563;
    }

    .viz-block {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: var(--bg-elevated);
      transition:
        background-color 0.35s ease,
        border-color 0.35s ease;
    }

    .viz-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .traj-graph {
      width: 100%;
      max-width: 420px;
      height: 140px;
      display: block;
      margin: 4px auto 0;
    }

    .traj-axis {
      stroke: var(--axis);
      stroke-width: 0.6;
      transition: stroke 0.35s ease;
    }

    #trajGraphLine {
      stroke: #3b82f6;
      stroke-width: 1.5;
      fill: none;
    }

    .traj-legend {
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: center;
    }

    .traj-label {
      fill: var(--text-muted);
      font-size: 4px;
      transition: fill 0.35s ease;
    }

    .momentum-band-text {
      font-size: 0.8rem;
    }

    .help-badge {
      display: inline-block;
      margin-top: 3px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: var(--bg-elevated);
      font-size: 0.7rem;
      color: var(--text);
      cursor: pointer;
      transition:
        background-color 0.35s ease,
        color 0.35s ease,
        border-color 0.35s ease;
    }

    .help-badge:hover {
      border-color: #3b82f6;
    }

    .help-panel {
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: var(--bg-elevated);
      font-size: 0.75rem;
      color: var(--text-muted);
      transition:
        background-color 0.35s ease,
        border-color 0.35s ease,
        color 0.35s ease;
    }

    .help-panel ul {
      margin: 4px 0 0 16px;
      padding: 0;
    }

    .help-panel li {
      margin: 2px 0;
    }

    .data-table-wrapper {
      overflow-x: auto;
      margin-top: 4px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      min-width: 100%;
    }

    .data-table th,
    .data-table td {
      border: 1px solid var(--border);
      padding: 4px 6px;
      text-align: left;
      white-space: nowrap;
      transition:
        background-color 0.35s ease,
        border-color 0.35s ease,
        color 0.35s ease;
    }

    .data-table th {
      background: var(--bg-card);
      color: var(--text-muted);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .data-table tbody tr:nth-child(odd) {
      background: var(--bg-card);
    }

    .data-table tbody tr:nth-child(even) {
      background: var(--bg-elevated);
    }

    #themeToggle {
      margin-left: auto;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    #themeToggle span {
      font-size: 0.7rem;
    }

    .csv-controls {
      margin-bottom: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .csv-btn {
      border: none;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 0.7rem;
      cursor: pointer;
      background: var(--bg-elevated);
      color: var(--text);
      border: 1px solid var(--border-soft);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition:
        background-color 0.35s ease,
        color 0.35s ease,
        border-color 0.35s ease;
    }

    .csv-btn:hover {
      border-color: #3b82f6;
    }

    .csv-btn span {
      font-size: 0.8rem;
    }

    .csv-upload-label {
      position: relative;
      overflow: hidden;
    }

    .csv-upload-label input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    /* Saved builds layout */
    .saved-builds-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-top: 4px;
    }

    .saved-builds-row select {
      padding: 3px 6px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-input);
      color: var(--text);
      font-size: 0.8rem;
    }

    .saved-builds-row button {
      font-size: 0.7rem;
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Arrow Tune Calculator</h1>
    <div class="subtitle">
      Enter your bow and arrow details to see weight, FOC, grains per pound, grains per inch, and basic kinetic data.
    </div>

    <div class="meta">
      <span id="appVersion">v0.9.10</span>
      <span>‚Ä¢</span>
      <span id="buildDateText">Build date: 2025-11-24</span>

      <button id="themeToggle" class="help-badge">
        <span id="themeToggleIcon">üåô</span>
        <span id="themeToggleText">Dark</span>
      </button>
    </div>

    <div class="grid">
      <!-- LEFT: INPUTS + NOTES + SAVED BUILDS -->
      <div>
        <!-- Bow -->
        <div class="card">
          <div class="card-header">
            <h2>Bow</h2>
            <button
              class="info-btn"
              data-info-target="bowInfo"
              title="Show information about this section"
            >
              i
            </button>
          </div>
          <div id="bowInfo" class="info-panel">
            <p>Basic bow setup so we can relate arrow weight to draw weight and estimate speed and momentum.</p>
          </div>

          <div class="field-row">
            <div class="field">
              <label
                for="bowDrawWeightLb"
                title="Bow draw weight in pounds at your full draw length."
              >
                Draw weight (lb)
              </label>
              <input id="bowDrawWeightLb" type="number" value="70" step="0.1" />
            </div>
            <div class="field">
              <label
                for="bowDrawLengthIn"
                title="Your bow's draw length setting in inches."
              >
                Draw length (in)
              </label>
              <input id="bowDrawLengthIn" type="number" value="28" step="0.1" />
            </div>
          </div>
          <div class="field-row">
            <div class="field">
              <label
                for="launchFps"
                title="Estimated arrow speed at the bow, in feet per second."
              >
                Launch speed estimate (fps)
              </label>
              <input id="launchFps" type="number" value="280" step="1" />
            </div>
            <div class="field">
              <label
                for="fpsLossPer10Yards"
                title="Approximate speed loss in fps for every 10 yards of travel."
              >
                Speed loss / 10 yards (fps)
              </label>
              <input id="fpsLossPer10Yards" type="number" value="3" step="0.5" />
            </div>
          </div>
          <div class="field">
            <label
              for="bowModel"
              title="Bow model and year for reference, since FPS is tied to bow design and performance."
            >
              Bow model &amp; year
            </label>
            <input
              id="bowModel"
              type="text"
              placeholder="e.g. 2025 Hoyt RX-9"
            />
          </div>
        </div>

        <!-- Arrow Info -->
        <div class="card">
          <div class="card-header">
            <h2>Arrow Info</h2>
            <button
              class="info-btn"
              data-info-target="arrowInfo"
              title="Show information about this section"
            >
              i
            </button>
          </div>
          <div id="arrowInfo" class="info-panel">
            <p>High-level info so you can label and compare different arrow builds.</p>
          </div>

          <div class="field">
            <label
              for="arrowName"
              title="Optional name for this arrow setup, such as brand and model."
            >
              Arrow name
            </label>
            <input
              id="arrowName"
              type="text"
              placeholder="e.g. Easton Axis 5mm 300 spine"
            />
          </div>
          <div class="field">
            <label
              for="arrowSpine"
              title="Arrow spine rating (stiffness), such as 250, 300, 340, 400."
            >
              Arrow spine (rating)
            </label>
            <input
              id="arrowSpine"
              type="number"
              step="1"
              placeholder="e.g. 300"
            />
          </div>
        </div>

        <!-- Arrow Shaft & Total Weight -->
        <div class="card">
          <div class="card-header">
            <h2>Arrow Shaft &amp; Total Weight</h2>
            <button
              class="info-btn"
              data-info-target="shaftInfo"
              title="Show information about this section"
            >
              i
            </button>
          </div>
          <div id="shaftInfo" class="info-panel">
            <p>Arrow length and the finished total arrow weight from your scale. Component details are optional.</p>
            <p>Most people only need arrow length, total arrow weight, and balance point. If you enter a full component breakdown in the advanced section, that total will be used instead of this field.</p>
          </div>

          <div class="field-row">
            <div class="field">
              <label
                for="arrowLengthIn"
                title="Finished arrow length from nock throat to end of shaft (no point), in inches."
              >
                Arrow length (in)
              </label>
              <input id="arrowLengthIn" type="number" value="28.25" step="0.01" />
            </div>
            <div class="field">
              <label
                for="totalArrowWeightGrInput"
                title="Finished arrow weight on your scale, including all components. Used when a full component breakdown is not provided."
              >
                Total arrow weight (gr)
              </label>
              <input
                id="totalArrowWeightGrInput"
                type="number"
                value="509.8"
                step="0.1"
              />
            </div>
          </div>
        </div>

        <!-- Components (Advanced) -->
        <div class="card">
          <div class="card-header">
            <h2>Components (Advanced)</h2>
            <button
              class="info-btn"
              data-info-target="componentsInfo"
              title="Show information about this section"
            >
              i
            </button>
          </div>
          <div id="componentsInfo" class="info-panel">
            <p>Detailed component weights, including bare shaft, are only needed if you track each part with a small scale.</p>
            <p>If you complete all the main component fields (bare shaft, nock, vanes, insert, point), the calculator will use their sum as the total arrow weight. Otherwise, it will use the total arrow weight field above.</p>
          </div>

          <div class="field" style="margin-top:6px;">
            <label style="font-size:0.8rem; display:flex; align-items:center; gap:6px;">
              <input type="checkbox" id="enableComponentDetails" />
              <span>Show advanced component breakdown</span>
            </label>
          </div>

          <div id="componentDetails" style="display:none; margin-top:4px;">
            <div class="field">
              <label
                for="bareShaftWeightGr"
                title="Weight of the bare arrow shaft only, without any components, in grains."
              >
                Bare shaft weight (gr)
              </label>
              <input id="bareShaftWeightGr" type="number" value="300" step="0.1" />
            </div>

            <div class="field-row">
              <div class="field">
                <label
                  for="nockWeightGr"
                  title="Weight of the arrow nock in grains."
                >
                  Nock weight (gr)
                </label>
                <input id="nockWeightGr" type="number" value="10" step="0.1" />
              </div>
              <div class="field">
                <label
                  for="wrapWeightGr"
                  title="Total weight of any arrow wrap in grains. Use 0 if you don't use wraps."
                >
                  Wrap weight (gr, optional)
                </label>
                <input id="wrapWeightGr" type="number" value="0" step="0.1" />
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label
                  for="vaneCount"
                  title="Number of vanes or fletchings on the arrow, usually 3 or 4."
                >
                  Vane count
                </label>
                <input id="vaneCount" type="number" value="3" step="1" />
              </div>
              <div class="field">
                <label
                  for="vaneWeightGr"
                  title="Weight in grains of a single vane or fletching."
                >
                  Vane weight each (gr)
                </label>
                <input id="vaneWeightGr" type="number" value="9" step="0.1" />
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label
                  for="insertWeightGr"
                  title="Weight in grains of the insert, outsert, or half-out component."
                >
                  Insert / outsert (gr)
                </label>
                <input id="insertWeightGr" type="number" value="50" step="0.1" />
              </div>
              <div class="field">
                <label
                  for="pointWeightGr"
                  title="Weight in grains of the point or broadhead."
                >
                  Point weight (gr)
                </label>
                <input id="pointWeightGr" type="number" value="150" step="0.1" />
              </div>
            </div>

            <div class="field">
              <label
                for="glueWeightGr"
                title="Estimated total glue weight in grains (vanes, insert, nock). 5‚Äì10 grains is common."
              >
                Glue weight (gr, estimate)
              </label>
              <input id="glueWeightGr" type="number" value="8" step="0.1" />
            </div>
          </div>
        </div>

        <!-- Balance Point -->
        <div class="card">
          <div class="card-header">
            <h2>Balance Point</h2>
            <button
              class="info-btn"
              data-info-target="balanceInfo"
              title="Show information about this section"
            >
              i
            </button>
          </div>
          <div id="balanceInfo" class="info-panel">
            <p>Where the finished arrow actually balances, which drives FOC and front/back weight bias.</p>
            <p>Measure from the nock throat to the balance point of the finished arrow.</p>
          </div>

          <div class="field">
            <label
              for="balancePointIn"
              title="Distance from the nock throat to the balance point of the finished arrow, in inches."
            >
              Balance point from nock (in)
            </label>
            <input id="balancePointIn" type="number" value="18.5" step="0.01" />
          </div>
        </div>

        <!-- Notes -->
        <div class="card">
          <div class="card-header">
            <h2>Notes</h2>
            <button
              class="info-btn"
              data-info-target="notesInfo"
              title="Show information about this section"
            >
              i
            </button>
          </div>
          <div id="notesInfo" class="info-panel">
            <p>Freeform notes for this build ‚Äî tuning details, hunts, broadheads used, and anything else you want to remember.</p>
            <p>Notes stay in this browser tab only for now. Future versions may allow saving multiple arrows.</p>
          </div>

          <div class="field">
            <label
              for="userNotes"
              title="Any notes about this arrow, bow, tuning, or hunt. Not saved permanently yet."
            >
              Notes for this arrow setup
            </label>
            <textarea id="userNotes" placeholder="Example: Broadhead tune at 30 yards, used on elk hunt, etc."></textarea>
          </div>
        </div>

        <!-- Saved Builds -->
        <div class="card">
          <div class="card-header">
            <h2>Saved Builds</h2>
            <button
              class="info-btn"
              data-info-target="savedBuildsInfo"
              title="Show information about this section"
            >
              i
            </button>
          </div>
          <div id="savedBuildsInfo" class="info-panel">
            <p>Save and load complete arrow setups in this browser only. Builds are stored locally using your browser's storage (no cloud account required).</p>
          </div>

          <div class="field">
            <label for="buildNameInput">Build name</label>
            <input
              id="buildNameInput"
              type="text"
              placeholder="e.g. Elk 2025 ‚Äì 70lb / 520gr"
            />
          </div>

          <div class="saved-builds-row">
            <select id="savedBuildsSelect">
              <option value="">(No saved builds)</option>
            </select>
          </div>

          <div class="saved-builds-row" style="margin-top:4px;">
            <button id="saveBuildBtn" class="csv-btn" type="button">
              üíæ Save / overwrite
            </button>
            <button id="loadBuildBtn" class="csv-btn" type="button">
              üì§ Load selected
            </button>
            <button id="deleteBuildBtn" class="csv-btn" type="button">
              ‚ùå Delete selected
            </button>
          </div>
        </div>
      </div>

      <!-- RIGHT: RESULTS & VISUALS -->
      <div>
        <!-- Core results -->
        <div class="card">
          <div class="card-header">
            <h2>Results</h2>
            <button
              class="info-btn"
              data-info-target="resultsInfo"
              title="Show information about this section"
            >
              i
            </button>
          </div>
          <div id="resultsInfo" class="info-panel">
            <p>Big-picture summary of your arrow build: total weight, FOC, grains per pound, grains per inch.</p>
          </div>

          <div class="results-row">
            <span class="label">Arrow</span>
            <span class="value" id="arrowNameDisplay">Unnamed arrow</span>
          </div>
          <div class="results-row">
            <span class="label">Spine</span>
            <span class="value" id="arrowSpineDisplay">‚Äì</span>
          </div>

          <div class="results-row" style="margin-top:4px;">
            <span class="label">Total arrow weight</span>
            <span class="value" id="totalArrowWeightGr">‚Äì</span>
          </div>
          <div class="results-row">
            <span class="label">
              FOC
              <span id="focTag" class="foc-tag foc-normal" style="display:none;"></span>
            </span>
            <span class="value" id="focPercent">‚Äì</span>
          </div>
          <div class="results-row">
            <span class="label">
              Grains per pound (GPP)
              <span id="gppTag" class="foc-tag gpp-normal" style="display:none;"></span>
            </span>
            <span class="value" id="grainsPerPound">‚Äì</span>
          </div>
          <div class="results-row">
            <span class="label">Shaft GPI (bare shaft)</span>
            <span class="value" id="shaftGpi">‚Äì</span>
          </div>
          <div class="results-row">
            <span class="label">
              Arrow GPI (full arrow)
              <span id="gpiTag" class="foc-tag gpi-normal" style="display:none;"></span>
            </span>
            <span class="value" id="arrowGpi">‚Äì</span>
          </div>

          <div class="note">
            <span
              id="resultsHelpToggle"
              class="help-badge"
              title="Click to expand explanations of FOC, GPP, and GPI classifications."
            >
              Learn more about these bands
            </span>
          </div>

          <div id="resultsHelpPanel" class="help-panel" style="display:none;">
            <div class="note-strong">About FOC, GPP, and GPI Bands</div>

            <p style="margin:4px 0;">
              These classifications are based on common bowhunting tuning guidance, manufacturer data,
              and widely adopted rules of thumb used by coaches and hunters.
            </p>

            <ul>
              <li>
                <strong>FOC (Front of Center)</strong><br />
                ‚Ä¢ <em>Low (&lt;10%)</em> ‚Äî more forgiving flight but less stable with broadheads<br />
                ‚Ä¢ <em>Typical hunting (10‚Äì18%)</em> ‚Äî most stable, good overall penetration<br />
                ‚Ä¢ <em>High (&gt;18%)</em> ‚Äî strong penetration, but can require careful spine tuning
              </li>

              <li>
                <strong>GPP (Grains per Pound)</strong><br />
                ‚Ä¢ <em>Light (&lt;5.3 gpp)</em> ‚Äî fast &amp; flat but lower momentum<br />
                ‚Ä¢ <em>Typical hunting (5.3‚Äì6.3 gpp)</em> ‚Äî good blend of speed &amp; penetration<br />
                ‚Ä¢ <em>Heavy (&gt;6.3 gpp)</em> ‚Äî quieter, higher momentum, slower trajectory
              </li>

              <li>
                <strong>GPI (Full arrow grains-per-inch)</strong><br />
                ‚Ä¢ <em>Light (&lt;9.0 gpi)</em> ‚Äî common for deer / longer shots<br />
                ‚Ä¢ <em>Typical hunting (9.0‚Äì11.0 gpi)</em> ‚Äî where most hunters land<br />
                ‚Ä¢ <em>Heavy (11‚Äì13 gpi)</em> ‚Äî elk, bear, penetration builds<br />
                ‚Ä¢ <em>Ultra-heavy (&gt;13 gpi)</em> ‚Äî Ashby-style setups, short-range focus
              </li>
            </ul>

            <p style="margin:4px 0;">
              These bands help compare arrow builds, but
              <strong>tuning and shot placement matter more than the numbers alone.</strong>
            </p>
          </div>
        </div>

        <!-- Kinetics: FPS, Momentum & Trajectory -->
        <div class="card">
          <div class="card-header">
            <h2>Kinetics (FPS, Momentum &amp; Trajectory)</h2>
            <button
              class="info-btn"
              data-info-target="kineticsInfo"
              title="Show information about this section"
            >
              i
            </button>
          </div>
          <div id="kineticsInfo" class="info-panel">
            <p>How hard and how fast the arrow is moving at the bow and downrange, plus a simplified flight arc.</p>
            <p>Momentum is computed as: <code>(arrow grains √ó fps) / 225,400</code>. These are still approximations, but they help compare different builds under similar conditions.</p>
          </div>

          <!-- 1) FPS & Momentum -->
          <div class="viz-block">
            <div class="viz-title">1) FPS &amp; Momentum at Distances</div>

            <div class="results-row">
              <span class="label">Launch</span>
              <span class="value" id="launchKineticsDisplay">‚Äì fps / ‚Äì slug¬∑ft/s</span>
            </div>

            <div class="results-row">
              <span class="label">
                Distance 1
                <span class="note">
                  (<input
                    id="dist1Yards"
                    type="number"
                    value="30"
                    step="1"
                    style="width: 3rem; background: var(--bg-input); color: var(--text); border:1px solid var(--border); border-radius:4px; padding:2px 4px; font-size:0.75rem;"
                    title="Distance in yards for the first FPS/momentum estimate."
                  /> yd)
                </span>
              </span>
              <span class="value" id="dist1KineticsDisplay">‚Äì fps / ‚Äì slug¬∑ft/s</span>
            </div>

            <div class="results-row">
              <span class="label">
                Distance 2
                <span class="note">
                  (<input
                    id="dist2Yards"
                    type="number"
                    value="60"
                    step="1"
                    style="width: 3rem; background: var(--bg-input); color: var(--text); border:1px solid var(--border); border-radius:4px; padding:2px 4px; font-size:0.75rem;"
                    title="Distance in yards for the second FPS/momentum estimate. This also drives the arc range."
                  /> yd)
                </span>
              </span>
              <span class="value" id="dist2KineticsDisplay">‚Äì fps / ‚Äì slug¬∑ft/s</span>
            </div>
          </div>

          <!-- 2) Game momentum band (farthest distance) -->
          <div class="viz-block">
            <div class="viz-title">2) Game momentum band (farthest distance)</div>

            <div class="results-row">
              <span id="momentumBandLabel" class="value momentum-band-text">‚Äì</span>
            </div>

            <div class="note">
              <span
                id="bandsHelpToggle"
                class="help-badge"
                title="Click to expand a short explanation of how these bands are commonly used."
              >
                Learn more about these bands
              </span>
            </div>

            <div
              id="bandsHelpPanel"
              class="help-panel"
              style="display: none;"
            >
              <div class="note-strong">
                These bands are rules of thumb ‚Äî not guarantees.
              </div>
              <p style="margin:4px 0%;">
                Momentum is computed as: <code>(arrow grains √ó fps) / 225,400</code>.
                Values here are approximate and depend on your launch FPS and speed loss settings.
              </p>
              <p style="margin:4px 0%;">
                They come from:
              </p>
              <ul>
                <li>Arrow penetration studies that focus on <strong>momentum</strong> (like Dr. Ed Ashby‚Äôs work).</li>
                <li>Common <strong>kinetic energy charts</strong> published by arrow and broadhead manufacturers.</li>
              </ul>
              <p style="margin:4px 0%;">
                Typical interpretations:
              </p>
              <ul>
                <li><strong>~0.25‚Äì0.35 slug¬∑ft/s</strong>: small game, turkey.</li>
                <li><strong>~0.30‚Äì0.45 slug¬∑ft/s</strong>: deer-sized game (whitetail, pronghorn).</li>
                <li><strong>~0.45‚Äì0.60+ slug¬∑ft/s</strong>: larger game like elk or black bear.</li>
                <li><strong>0.60+ slug¬∑ft/s</strong>: very large or dangerous game.</li>
              </ul>
              <p style="margin:4px 0%;">
                They assume sharp, well-built broadheads and legal setups.
                <strong>Shot placement, arrow flight, and local regulations matter more than any single number.</strong>
              </p>
            </div>
          </div>

          <!-- 3) Trajectory arc visualization -->
          <div class="viz-block">
            <div class="viz-title">
              3) Trajectory Arc (Distance vs Height)
              <button
                class="info-btn"
                data-info-target="trajectoryInfo"
                title="Show information about this visualization"
              >
                i
              </button>
            </div>
            <div id="trajectoryInfo" class="info-panel">
              <p>Shows a simple arc from bow to target based on your arc range, with a little extra room beyond the target.</p>
            </div>

            <div class="note" style="margin-top:0; margin-bottom:4px;">
              Arc range:
              <input
                id="trajMaxDistanceYards"
                type="number"
                value="80"
                step="5"
                style="width: 3.5rem; background: var(--bg-input); color: var(--text); border:1px solid var(--border); border-radius:4px; padding:2px 4px; font-size:0.75rem;"
                title="Maximum distance (yards) for the displayed arc. Horizontal axis will extend slightly beyond this."
              /> yd (visual only)
            </div>

            <svg
              id="trajGraph"
              viewBox="0 0 100 60"
              preserveAspectRatio="none"
              class="traj-graph"
            >
              <!-- Axes: x = yards, y = feet -->
              <line x1="0" y1="50" x2="100" y2="50" class="traj-axis"></line>
              <line x1="0" y1="10" x2="0" y2="50" class="traj-axis"></line>

              <!-- Axis labels -->
              <text x="50" y="58" text-anchor="middle" class="traj-label">
                Distance (yards)
              </text>
              <text
                x="2"
                y="12"
                text-anchor="start"
                class="traj-label"
              >
                Height (feet)
              </text>

              <!-- Data line (yards -> feet arc) -->
              <polyline id="trajGraphLine" points=""></polyline>

              <!-- Peak dot & label -->
              <circle id="trajPeakDot" r="1.3" fill="#f97316" cx="-10" cy="-10"></circle>
              <text
                id="trajPeakLabel"
                x="-10"
                y="-10"
                text-anchor="middle"
                class="traj-label"
              ></text>

              <!-- Launch angle line & label at left -->
              <line
                id="trajAngleLine"
                x1="0"
                y1="50"
                x2="-10"
                y2="-10"
                stroke="#22c55e"
                stroke-width="0.8"
              ></line>
              <text
                id="trajAngleLabel"
                x="8"
                y="46"
                text-anchor="start"
                class="traj-label"
              ></text>

              <!-- Impact momentum label at right (raised & nudged left) -->
              <text
                id="trajImpactMomentumLabel"
                x="90"
                y="18"
                text-anchor="end"
                class="traj-label"
              ></text>
            </svg>
            <div class="traj-legend" id="trajGraphLegend">
              Left = bow, right = target. Arc height, angle & impact momentum are approximate.
            </div>
          </div>
        </div>

        <!-- FOC & weight visuals -->
        <div class="card">
          <div class="card-header">
            <h2>FOC &amp; Weight Distribution</h2>
            <button
              class="info-btn"
              data-info-target="focInfo"
              title="Show information about this section"
            >
              i
            </button>
          </div>
          <div id="focInfo" class="info-panel">
            <p>Visuals that show how weight is spread along the arrow and how far forward the balance point sits.</p>
          </div>

          <!-- 1) Arrow balance along length (above FOC gauge) -->
          <div class="viz-block arrow-visual">
            <div class="viz-title">
              Arrow Balance (Nock ‚Üí Point)
              <button
                class="info-btn"
                data-info-target="balanceVizInfo"
                title="Show information about this visualization"
              >
                i
              </button>
            </div>
            <div id="balanceVizInfo" class="info-panel">
              <p>Green line = geometric center, orange marker = balance point (driven by FOC).</p>
            </div>

            <div class="arrow-ends">
              <span>Nock / back of arrow</span>
              <span>Point / front of arrow</span>
            </div>
            <div class="arrow-track">
              <div class="arrow-axis"></div>
              <div class="arrow-center-line"></div>
              <div id="balanceMarker" class="arrow-balance-marker"></div>
            </div>
            <div class="arrow-legend">
              Shows where along the shaft your arrow actually balances from nock to point.
            </div>
          </div>

          <!-- 2) FOC Shift Gauge -->
          <div class="viz-block foc-shift-visual">
            <div class="viz-title">
              FOC Shift Gauge
              <button
                class="info-btn"
                data-info-target="focShiftInfo"
                title="Show information about this visualization"
              >
                i
              </button>
            </div>
            <div id="focShiftInfo" class="info-panel">
              <p>Shaded zone ‚âà common bowhunting FOC range (~10‚Äì18% forward of center).</p>
            </div>

            <div class="foc-shift-track">
              <!-- Recommended FOC band (~10‚Äì18% forward of center) -->
              <div class="foc-shift-band"></div>
              <div class="foc-shift-zero"></div>
              <div id="focShiftMarker" class="foc-shift-marker"></div>
            </div>
            <div class="foc-shift-labels">
              <span>More weight toward nock / behind center</span>
              <span>More weight toward point / forward of center</span>
            </div>
            <div class="foc-shift-details" id="focShiftDetails">
              FOC shift: ‚Äì
            </div>
          </div>

          <!-- 3) Weight composition bar -->
          <div class="viz-block weight-visual">
            <div class="viz-title">
              Weight Composition
              <button
                class="info-btn"
                data-info-target="weightInfo"
                title="Show information about this visualization"
              >i</button>
            </div>

            <div id="weightInfo" class="info-panel" style="display:none;">
              <p>
                Center line shows the halfway mark: if the blue shaft segment crosses it,
                more than half of total arrow weight is in the shaft.
              </p>
            </div>

            <div style="display:flex; justify-content:center;">
              <div class="weight-bar">
                <div class="weight-mid-line"></div>
                <div id="weightShaft" class="weight-shaft"></div>
                <div id="weightPoint" class="weight-point"></div>
                <div id="weightFletch" class="weight-fletch"></div>
              </div>
            </div>

            <div class="weight-legend">
              <span><span class="dot" style="background:#1d4ed8;"></span> Shaft</span>
              <span><span class="dot" style="background:#ea580c;"></span> Point system</span>
              <span><span class="dot" style="background:#a855f7;"></span> Nock / wrap / vanes + glue</span>
            </div>
            <div class="note" id="weightTotals">
              Shaft: ‚Äì gr (‚Äì %)<br>
              Point system: ‚Äì gr (‚Äì %)<br>
              Nock / wrap / vanes + glue: ‚Äì gr (‚Äì %)
            </div>
          </div>
        </div>

        <!-- Data Table -->
        <div class="card">
          <div class="card-header">
            <h2>Data Table (Inputs &amp; Calculated)</h2>
            <button
              class="info-btn"
              data-info-target="dataTableInfo"
              title="Show information about this section"
            >
              i
            </button>
          </div>
          <div id="dataTableInfo" class="info-panel">
            <p>Spreadsheet-style view of what you entered and what the calculator derived from it, with source labels.</p>
            <p>You can copy or download this table as CSV, and later re-upload it to restore your input values.</p>
          </div>

          <div class="csv-controls">
            <button id="copyCsvBtn" class="csv-btn" type="button">
              <span>üìã</span>
              <span>Copy table CSV</span>
            </button>
            <button id="downloadCsvBtn" class="csv-btn" type="button">
              <span>üíæ</span>
              <span>Download table CSV</span>
            </button>
            <button id="downloadInputsCsvBtn" class="csv-btn" type="button">
              <span>üéØ</span>
              <span>Download inputs-only CSV</span>
            </button>
            <label class="csv-btn csv-upload-label">
              <span>üìÇ</span>
              <span>Upload CSV (restore inputs)</span>
              <input id="uploadInputsCsv" type="file" accept=".csv" />
            </label>
          </div>

          <div class="data-table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Field</th>
                  <th>Source</th>
                  <th>Value</th>
                  <th>Units</th>
                </tr>
              </thead>
              <tbody id="summaryTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      Built by David Marcus ‚Ä¢ Arrow Tune Calculator ‚Ä¢ MIT Licensed
    </div>
  </div>

  <script>
    function readNumber(id) {
      const el = document.getElementById(id);
      const value = parseFloat(el?.value ?? "");
      return isNaN(value) ? 0 : value;
    }

    function formatNumber(value, digits) {
      if (!isFinite(value)) return "‚Äì";
      return value.toFixed(digits);
    }

    function updateArrowNameDisplay() {
      const nameInput = document.getElementById("arrowName");
      const nameDisplay = document.getElementById("arrowNameDisplay");
      if (!nameInput || !nameDisplay) return;

      const value = nameInput.value.trim();
      nameDisplay.textContent = value || "Unnamed arrow";
    }

    function estimateFpsAtDistance(launchFps, fpsLossPer10Yards, distanceYards) {
      if (!isFinite(launchFps) || launchFps <= 0) return NaN;
      if (!isFinite(fpsLossPer10Yards) || fpsLossPer10Yards < 0) return launchFps;

      const loss = (fpsLossPer10Yards * distanceYards) / 10;
      const v = launchFps - loss;
      const vClamped = v > 0 ? v : 0;
      return vClamped;
    }

    function computeMomentumSlugFtPerSec(arrowWeightGrains, fps) {
      if (!isFinite(arrowWeightGrains) || !isFinite(fps)) return NaN;
      if (arrowWeightGrains <= 0 || fps <= 0) return NaN;
      return (arrowWeightGrains * fps) / 225400;
    }

    function classifyMomentumBand(momentum) {
      if (!isFinite(momentum) || momentum <= 0) return null;

      if (momentum < 0.25) {
        return "very light / target practice";
      } else if (momentum < 0.35) {
        return "small game";
      } else if (momentum < 0.45) {
        return "deer-size game";
      } else if (momentum < 0.60) {
        return "large game (elk/bear)";
      } else {
        return "very large / dangerous game";
      }
    }

    function updateTrajectoryGraph(launchFps, arcRangeYards, impactMomentum) {
      const lineEl = document.getElementById("trajGraphLine");
      const legendEl = document.getElementById("trajGraphLegend");
      const peakDot = document.getElementById("trajPeakDot");
      const peakLabel = document.getElementById("trajPeakLabel");
      const angleLine = document.getElementById("trajAngleLine");
      const angleLabel = document.getElementById("trajAngleLabel");
      const impactLabel = document.getElementById("trajImpactMomentumLabel");

      if (
        !lineEl ||
        !legendEl ||
        !peakDot ||
        !peakLabel ||
        !angleLine ||
        !angleLabel ||
        !impactLabel
      ) return;

      const AXIS_MAX_HEIGHT_FEET = 20;

      if (!isFinite(arcRangeYards) || arcRangeYards <= 0) {
        lineEl.setAttribute("points", "");
        legendEl.textContent =
          "Left = bow, right = target. Arc height, angle & impact momentum are approximate.";
        peakDot.setAttribute("cx", "-10");
        peakDot.setAttribute("cy", "-10");
        peakLabel.setAttribute("x", "-10");
        peakLabel.setAttribute("y", "-10");
        peakLabel.textContent = "";
        angleLine.setAttribute("x2", "-10");
        angleLine.setAttribute("y2", "-10");
        angleLabel.textContent = "";
        impactLabel.textContent = "";
        return;
      }

      const effectiveRangeYards = Math.max(arcRangeYards, 0);

      let axisMaxYards;
      if (effectiveRangeYards < 40) {
        axisMaxYards = effectiveRangeYards * 1.15;
      } else if (effectiveRangeYards < 80) {
        axisMaxYards = effectiveRangeYards * 1.10;
      } else {
        axisMaxYards = effectiveRangeYards + 5;
      }
      axisMaxYards = Math.max(axisMaxYards, effectiveRangeYards + 2, 10);

      const baseFps = isFinite(launchFps) && launchFps > 0 ? launchFps : 280;
      const speedFactor = 280 / baseFps;

      const refRangeYards = 60;
      const normalized = effectiveRangeYards / refRangeYards;
      let HmaxFeet = 4.5 * normalized * normalized * speedFactor;
      HmaxFeet = Math.max(0.3, Math.min(HmaxFeet, AXIS_MAX_HEIGHT_FEET));

      const steps = 30;
      const points = [];

      for (let i = 0; i <= steps; i++) {
        const t = i / steps;
        const dYards = effectiveRangeYards * t;

        const heightFeet = HmaxFeet * 4 * t * (1 - t);

        const x = (dYards / axisMaxYards) * 100;
        let yNorm = heightFeet / AXIS_MAX_HEIGHT_FEET;
        if (yNorm < 0) yNorm = 0;
        if (yNorm > 1) yNorm = 1;
        const y = 50 - yNorm * 40;

        points.push(`${x},${y}`);
      }

      lineEl.setAttribute("points", points.join(" "));

      const midYards = effectiveRangeYards / 2;
      const xPeak = (midYards / axisMaxYards) * 100;
      const yPeakNorm = HmaxFeet / AXIS_MAX_HEIGHT_FEET;
      const yPeak = 50 - yPeakNorm * 40;

      peakDot.setAttribute("cx", xPeak.toString());
      peakDot.setAttribute("cy", yPeak.toString());
      peakLabel.setAttribute("x", xPeak.toString());
      peakLabel.setAttribute("y", (yPeak + 5).toString());
      peakLabel.textContent = HmaxFeet.toFixed(1) + " ft";

      const rangeFeet = effectiveRangeYards * 3;
      let angleDeg = 0;
      if (rangeFeet > 0 && HmaxFeet > 0) {
        const angleRad = Math.atan((4 * HmaxFeet) / rangeFeet);
        angleDeg = angleRad * (180 / Math.PI);
      }

      const originX = 0;
      const originY = 50;
      const angleSvgRad = angleDeg * (Math.PI / 180);
      const lineLen = 12;
      const x2 = originX + Math.cos(angleSvgRad) * lineLen;
      const y2 = originY - Math.sin(angleSvgRad) * lineLen;

      angleLine.setAttribute("x1", originX.toString());
      angleLine.setAttribute("y1", originY.toString());
      angleLine.setAttribute("x2", x2.toString());
      angleLine.setAttribute("y2", y2.toString());
      angleLabel.textContent =
        angleDeg > 0 ? "~" + angleDeg.toFixed(1) + "¬∞" : "";

      if (isFinite(impactMomentum) && impactMomentum > 0) {
        impactLabel.textContent = "~" + impactMomentum.toFixed(3) + " slug¬∑ft/s";
      } else {
        impactLabel.textContent = "";
      }

      legendEl.textContent =
        "Horizontal axis ‚âà 0‚Äì" +
        Math.round(axisMaxYards) +
        " yd (arc set to ~" +
        Math.round(effectiveRangeYards) +
        " yd). Peak height ‚âà " +
        HmaxFeet.toFixed(1) +
        " ft, launch angle ‚âà " +
        angleDeg.toFixed(1) +
        "¬∞, impact ‚âà " +
        (isFinite(impactMomentum) ? impactMomentum.toFixed(3) + " slug¬∑ft/s" : "‚Äì") +
        ".";
    }

    function calculateAndUpdate() {
      const bowDrawWeightLb = readNumber("bowDrawWeightLb");
      const bowDrawLengthIn = readNumber("bowDrawLengthIn");
      const launchFps = readNumber("launchFps");
      const fpsLossPer10Yards = readNumber("fpsLossPer10Yards");

      const dist1Yards = readNumber("dist1Yards");
      const dist2Yards = readNumber("dist2Yards");
      const trajMaxDistanceYards = readNumber("trajMaxDistanceYards");

      let arcRangeYards = trajMaxDistanceYards > 0 ? trajMaxDistanceYards : 10;

      const arrowLengthIn = readNumber("arrowLengthIn");
      const totalArrowWeightGrInput = readNumber("totalArrowWeightGrInput");

      const bareShaftWeightGr = readNumber("bareShaftWeightGr");
      const nockWeightGr = readNumber("nockWeightGr");
      const wrapWeightGr = readNumber("wrapWeightGr");
      const vaneCount = readNumber("vaneCount");
      const vaneWeightGr = readNumber("vaneWeightGr");
      const insertWeightGr = readNumber("insertWeightGr");
      const pointWeightGr = readNumber("pointWeightGr");
      const glueWeightGr = readNumber("glueWeightGr");

      const balancePointIn = readNumber("balancePointIn");
      const arrowSpine = readNumber("arrowSpine");

      const userNotesEl = document.getElementById("userNotes");
      const userNotesStr = userNotesEl ? userNotesEl.value.trim() : "";

      const bowModelInput = document.getElementById("bowModel");
      const bowModelStr = bowModelInput ? bowModelInput.value.trim() : "";

      const compToggleEl = document.getElementById("enableComponentDetails");
      const advancedEnabled = !!(compToggleEl && compToggleEl.checked);

      const now = new Date();
      const timestampStr = now.toLocaleString();

      const shaftWeightGr = bareShaftWeightGr;
      const pointSystemWeightGr = insertWeightGr + pointWeightGr;
      const fletchingSystemWeightGr =
        nockWeightGr +
        wrapWeightGr +
        vaneCount * vaneWeightGr +
        glueWeightGr;

      const componentTotal =
        shaftWeightGr + pointSystemWeightGr + fletchingSystemWeightGr;

      let weightCompString = "‚Äì";

      // --- NEW TOTAL ARROW WEIGHT LOGIC ---
      let totalArrowWeightGr = 0;
      let totalSource = "";

      if (advancedEnabled) {
        // Use sum of components when advanced breakdown is on
        totalArrowWeightGr = componentTotal > 0 ? componentTotal : 0;
        totalSource = "Components sum (advanced)";
      } else {
        // Use total arrow weight field when advanced breakdown is off
        totalArrowWeightGr = totalArrowWeightGrInput > 0 ? totalArrowWeightGrInput : 0;
        totalSource = "Total field (Arrow Shaft & Total Weight)";
      }

      let focPercent = NaN;
      let focShiftIn = NaN;
      if (arrowLengthIn > 0) {
        const centerIn = arrowLengthIn / 2;
        focShiftIn = balancePointIn - centerIn;
        focPercent = (focShiftIn / arrowLengthIn) * 100;
      }

      let grainsPerPound = NaN;
      if (bowDrawWeightLb > 0 && totalArrowWeightGr > 0) {
        grainsPerPound = totalArrowWeightGr / bowDrawWeightLb;
      }

      let shaftGpi = NaN;
      let arrowGpi = NaN;
      if (arrowLengthIn > 0) {
        if (shaftWeightGr > 0) {
          shaftGpi = shaftWeightGr / arrowLengthIn;
        }
        if (totalArrowWeightGr > 0) {
          arrowGpi = totalArrowWeightGr / arrowLengthIn;
        }
      }

      const arrowNameInput = document.getElementById("arrowName");
      const arrowNameStr = arrowNameInput
        ? (arrowNameInput.value.trim() || "Unnamed arrow")
        : "Unnamed arrow";

      const totalEl = document.getElementById("totalArrowWeightGr");
      const focEl = document.getElementById("focPercent");
      const gppEl = document.getElementById("grainsPerPound");
      const shaftGpiEl = document.getElementById("shaftGpi");
      const arrowGpiEl = document.getElementById("arrowGpi");
      const spineDisplayEl = document.getElementById("arrowSpineDisplay");

      if (totalEl) {
        totalEl.textContent = totalArrowWeightGr > 0
          ? formatNumber(totalArrowWeightGr, 1) + " gr"
          : "‚Äì";
      }
      if (focEl) {
        focEl.textContent = isFinite(focPercent)
          ? formatNumber(focPercent, 1) + " %"
          : "‚Äì";
      }
      if (gppEl) {
        gppEl.textContent = isFinite(grainsPerPound)
          ? formatNumber(grainsPerPound, 1) + " gpp"
          : "‚Äì";
      }
      if (shaftGpiEl) {
        shaftGpiEl.textContent = isFinite(shaftGpi)
          ? formatNumber(shaftGpi, 2) + " gr/in"
          : "‚Äì";
      }
      if (arrowGpiEl) {
        arrowGpiEl.textContent = isFinite(arrowGpi)
          ? formatNumber(arrowGpi, 2) + " gr/in"
          : "‚Äì";
      }
      if (spineDisplayEl) {
        spineDisplayEl.textContent = arrowSpine > 0 ? arrowSpine.toString() : "‚Äì";
      }

      // Band labels for Data Table
      let focBandLabel = "";
      let gppBandLabel = "";
      let gpiBandLabel = "";
      let momentumBandResultStr = "‚Äì";

      const focTag = document.getElementById("focTag");
      if (focTag) {
        focTag.style.display = isFinite(focPercent) ? "inline-block" : "none";
        if (isFinite(focPercent)) {
          focTag.classList.remove("foc-low", "foc-normal", "foc-high");
          let text = "";
          if (focPercent < 10) {
            focTag.classList.add("foc-low");
            text = "Low";
          } else if (focPercent <= 18) {
            focTag.classList.add("foc-normal");
            text = "Typical hunting";
          } else {
            focTag.classList.add("foc-high");
            text = "High";
          }
          focTag.textContent = text;
          focBandLabel = text;
        }
      }

      const gppTag = document.getElementById("gppTag");
      if (gppTag) {
        const gpp = grainsPerPound;
        gppTag.style.display = isFinite(gpp) ? "inline-block" : "none";
        if (isFinite(gpp)) {
          gppTag.classList.remove("gpp-low", "gpp-normal", "gpp-high");
          let text = "";
          if (gpp < 5.3) {
            gppTag.classList.add("gpp-low");
            text = "Light";
          } else if (gpp <= 6.3) {
            gppTag.classList.add("gpp-normal");
            text = "Typical hunting";
          } else {
            gppTag.classList.add("gpp-high");
            text = "Heavy";
          }
          gppTag.textContent = text;
          gppBandLabel = text;
        }
      }

      const gpiTag = document.getElementById("gpiTag");
      if (gpiTag) {
        const gpi = arrowGpi;
        gpiTag.style.display = isFinite(gpi) ? "inline-block" : "none";
        if (isFinite(gpi)) {
          gpiTag.classList.remove("gpi-light", "gpi-normal", "gpi-heavy", "gpi-ultra");
          let text = "";
          if (gpi < 9.0) {
            gpiTag.classList.add("gpi-light");
            text = "Light";
          } else if (gpi <= 11.0) {
            gpiTag.classList.add("gpi-normal");
            text = "Typical hunting";
          } else if (gpi <= 13.0) {
            gpiTag.classList.add("gpi-heavy");
            text = "Heavy";
          } else {
            gpiTag.classList.add("gpi-ultra");
            text = "Ultra-heavy";
          }
          gpiTag.textContent = text;
          gpiBandLabel = text;
        }
      }

      const launchFpsUsed = launchFps > 0 ? launchFps : NaN;
      const fps1 = estimateFpsAtDistance(
        launchFpsUsed,
        fpsLossPer10Yards,
        dist1Yards
      );
      const fps2 = estimateFpsAtDistance(
        launchFpsUsed,
        fpsLossPer10Yards,
        dist2Yards
      );

      const launchMomentum = computeMomentumSlugFtPerSec(
        totalArrowWeightGr,
        launchFpsUsed
      );
      const momentum1 = computeMomentumSlugFtPerSec(totalArrowWeightGr, fps1);
      const momentum2 = computeMomentumSlugFtPerSec(totalArrowWeightGr, fps2);

      const launchKineticsDisplay =
        document.getElementById("launchKineticsDisplay");
      const dist1KineticsDisplay =
        document.getElementById("dist1KineticsDisplay");
      const dist2KineticsDisplay =
        document.getElementById("dist2KineticsDisplay");
      const momentumBandLabel = document.getElementById("momentumBandLabel");

      if (launchKineticsDisplay) {
        const fpsText = isFinite(launchFpsUsed)
          ? formatNumber(launchFpsUsed, 0) + " fps"
          : "‚Äì fps";
        const momText = isFinite(launchMomentum)
          ? formatNumber(launchMomentum, 3) + " slug¬∑ft/s"
          : "‚Äì slug¬∑ft/s";
        launchKineticsDisplay.textContent = fpsText + " / " + momText;
      }
      if (dist1KineticsDisplay) {
        const fpsText = isFinite(fps1)
          ? formatNumber(fps1, 0) + " fps"
          : "‚Äì fps";
        const momText = isFinite(momentum1)
          ? formatNumber(momentum1, 3) + " slug¬∑ft/s"
          : "‚Äì slug¬∑ft/s";
        dist1KineticsDisplay.textContent = fpsText + " / " + momText;
      }
      if (dist2KineticsDisplay) {
        const fpsText = isFinite(fps2)
          ? formatNumber(fps2, 0) + " fps"
          : "‚Äì fps";
        const momText = isFinite(momentum2)
          ? formatNumber(momentum2, 3) + " slug¬∑ft/s"
          : "‚Äì slug¬∑ft/s";
        dist2KineticsDisplay.textContent = fpsText + " / " + momText;
      }

      if (momentumBandLabel) {
        const farthestDist = Math.max(dist1Yards, dist2Yards, arcRangeYards);
        if (!isFinite(farthestDist) || farthestDist <= 0 || totalArrowWeightGr <= 0) {
          momentumBandLabel.textContent = "‚Äì";
          momentumBandResultStr = "‚Äì";
        } else {
          const fpsFar = estimateFpsAtDistance(
            launchFpsUsed,
            fpsLossPer10Yards,
            farthestDist
          );
          const momentumFar = computeMomentumSlugFtPerSec(
            totalArrowWeightGr,
            fpsFar
          );
          const bandName = classifyMomentumBand(momentumFar);
          if (!bandName || !isFinite(momentumFar) || momentumFar <= 0) {
            momentumBandLabel.textContent = "‚Äì";
            momentumBandResultStr = "‚Äì";
          } else {
            const txt =
              "At ~" +
              Math.round(farthestDist) +
              " yd: " +
              formatNumber(momentumFar, 3) +
              " slug¬∑ft/s ‚Üí classified as '" +
              bandName +
              "'.";
            momentumBandLabel.textContent = txt;
            momentumBandResultStr = txt;
          }
        }
      }

      const fpsImpact = estimateFpsAtDistance(
        launchFpsUsed,
        fpsLossPer10Yards,
        arcRangeYards
      );
      const impactMomentum = computeMomentumSlugFtPerSec(
        totalArrowWeightGr,
        fpsImpact
      );

      updateTrajectoryGraph(launchFpsUsed, arcRangeYards, impactMomentum);

      const balanceMarker = document.getElementById("balanceMarker");
      if (balanceMarker) {
        if (arrowLengthIn > 0 && isFinite(balancePointIn)) {
          let ratio = balancePointIn / arrowLengthIn;
          if (ratio < 0) ratio = 0;
          if (ratio > 1) ratio = 1;
          const percent = ratio * 100;
          balanceMarker.style.left = percent + "%";
        } else {
          balanceMarker.style.left = "50%";
        }
      }

      const focShiftMarker = document.getElementById("focShiftMarker");
      const focShiftDetails = document.getElementById("focShiftDetails");

      if (focShiftMarker) {
        if (isFinite(focPercent)) {
          const MAX_RANGE = 20;
          let ratio = focPercent / MAX_RANGE;
          if (ratio < -1) ratio = -1;
          if (ratio > 1) ratio = 1;
          const percent = 50 + ratio * 50;
          focShiftMarker.style.left = percent + "%";
        } else {
          focShiftMarker.style.left = "50%";
        }
      }

      if (focShiftDetails) {
        if (isFinite(focShiftIn) && isFinite(focPercent)) {
          const direction =
            focShiftIn > 0
              ? "forward of center"
              : focShiftIn < 0
              ? "behind center"
              : "exactly at center";
          const inches = Math.abs(focShiftIn);
          if (inches === 0) {
            focShiftDetails.textContent =
              "FOC shift: 0.00 in (0.0 %) ‚Äì balance at exact center.";
          } else {
            focShiftDetails.textContent =
              "FOC shift: " +
              formatNumber(inches, 2) +
              " in (" +
              formatNumber(Math.abs(focPercent), 1) +
              " %) " +
              direction +
              ".";
          }
        } else {
          focShiftDetails.textContent = "FOC shift: ‚Äì";
        }
      }

      const weightShaft = document.getElementById("weightShaft");
      const weightPoint = document.getElementById("weightPoint");
      const weightFletch = document.getElementById("weightFletch");
      const weightTotalsEl = document.getElementById("weightTotals");

      if (weightShaft && weightPoint && weightFletch) {
        if (componentTotal > 0) {
          const shaftPct = (shaftWeightGr / componentTotal) * 100;
          const pointPct = (pointSystemWeightGr / componentTotal) * 100;
          const fletchPct =
            (fletchingSystemWeightGr / componentTotal) * 100;

          weightShaft.style.width = shaftPct + "%";
          weightPoint.style.width = pointPct + "%";
          weightFletch.style.width = fletchPct + "%";

          if (weightTotalsEl) {
            weightTotalsEl.innerHTML =
              "Shaft: " +
              formatNumber(shaftWeightGr, 1) +
              " gr (" +
              formatNumber(shaftPct, 1) +
              " %)<br>" +
              "Point system: " +
              formatNumber(pointSystemWeightGr, 1) +
              " gr (" +
              formatNumber(pointPct, 1) +
              " %)<br>" +
              "Nock / wrap / vanes + glue: " +
              formatNumber(fletchingSystemWeightGr, 1) +
              " gr (" +
              formatNumber(fletchPct, 1) +
              " %)";
          }

          weightCompString =
            "Shaft: " +
            formatNumber(shaftWeightGr, 1) +
            " gr (" +
            formatNumber(shaftPct, 1) +
            " %); " +
            "Point system: " +
            formatNumber(pointSystemWeightGr, 1) +
            " gr (" +
            formatNumber(pointPct, 1) +
            " %); " +
            "Nock / wrap / vanes + glue: " +
            formatNumber(fletchingSystemWeightGr, 1) +
            " gr (" +
            formatNumber(fletchPct, 1) +
            " %)";
        } else {
          weightShaft.style.width = "33%";
          weightPoint.style.width = "33%";
          weightFletch.style.width = "34%";
          if (weightTotalsEl) {
            weightTotalsEl.innerHTML =
              "Shaft: ‚Äì gr (‚Äì %)<br>" +
              "Point system: ‚Äì gr (‚Äì %)<br>" +
              "Nock / wrap / vanes + glue: ‚Äì gr (‚Äì %)";
          }
          weightCompString = "‚Äì";
        }
      }

      const tableBody = document.getElementById("summaryTableBody");
      if (tableBody) {
        const rows = [];

        // Meta
        rows.push(["Meta", "Timestamp", "Auto", timestampStr, ""]);

        // Arrow
        rows.push(["Arrow", "Name", "Input", arrowNameStr, ""]);
        rows.push(["Arrow", "Spine", "Input", arrowSpine > 0 ? arrowSpine.toString() : "‚Äì", ""]);
        rows.push(["Arrow", "Arrow length", "Input", formatNumber(arrowLengthIn, 2), "in"]);

        // Bow
        rows.push(["Bow", "Bow model & year", "Input", bowModelStr || "‚Äî", ""]);
        rows.push(["Bow", "Draw weight", "Input", formatNumber(bowDrawWeightLb, 1), "lb"]);
        rows.push(["Bow", "Draw length", "Input", formatNumber(bowDrawLengthIn, 1), "in"]);
        rows.push(["Bow", "Launch speed estimate", "Input", formatNumber(launchFps, 0), "fps"]);
        rows.push(["Bow", "Speed loss / 10 yd", "Input", formatNumber(fpsLossPer10Yards, 1), "fps/10yd"]);

        // Distances
        rows.push(["Distances", "Distance 1", "Input", formatNumber(dist1Yards, 0), "yd"]);
        rows.push(["Distances", "Distance 2", "Input", formatNumber(dist2Yards, 0), "yd"]);
        rows.push(["Distances", "Arc range (visual)", "Input", formatNumber(arcRangeYards, 0), "yd"]);

        // Components
        rows.push(["Components", "Bare shaft weight", "Input", formatNumber(bareShaftWeightGr, 1), "gr"]);
        rows.push(["Components", "Nock weight", "Input", formatNumber(nockWeightGr, 1), "gr"]);
        rows.push(["Components", "Wrap weight", "Input", formatNumber(wrapWeightGr, 1), "gr"]);
        rows.push(["Components", "Vane count", "Input", formatNumber(vaneCount, 0), ""]);
        rows.push(["Components", "Vane weight each", "Input", formatNumber(vaneWeightGr, 1), "gr"]);
        rows.push(["Components", "Insert / outsert", "Input", formatNumber(insertWeightGr, 1), "gr"]);
        rows.push(["Components", "Point weight", "Input", formatNumber(pointWeightGr, 1), "gr"]);
        rows.push(["Components", "Glue weight (est.)", "Input", formatNumber(glueWeightGr, 1), "gr"]);

        // Total arrow weight (with new source)
        rows.push([
          "Calculated",
          "Total arrow weight",
          totalSource,
          totalArrowWeightGr > 0 ? formatNumber(totalArrowWeightGr, 1) : "‚Äì",
          "gr"
        ]);

        // Balance
        rows.push(["Balance", "Balance point from nock", "Input", formatNumber(balancePointIn, 2), "in"]);

        // Calculated metrics
        rows.push(["Calculated", "FOC", "Calculated", isFinite(focPercent) ? formatNumber(focPercent, 1) : "‚Äì", "%"]);
        rows.push(["Calculated", "FOC band", "Calculated", focBandLabel || "‚Äì", ""]);
        rows.push(["Calculated", "Grains per pound (GPP)", "Calculated", isFinite(grainsPerPound) ? formatNumber(grainsPerPound, 1) : "‚Äì", "gpp"]);
        rows.push(["Calculated", "GPP band", "Calculated", gppBandLabel || "‚Äì", ""]);
        rows.push(["Calculated", "Shaft GPI (bare)", "Calculated", isFinite(shaftGpi) ? formatNumber(shaftGpi, 2) : "‚Äì", "gr/in"]);
        rows.push(["Calculated", "Arrow GPI (full)", "Calculated", isFinite(arrowGpi) ? formatNumber(arrowGpi, 2) : "‚Äì", "gr/in"]);
        rows.push(["Calculated", "Arrow GPI band", "Calculated", gpiBandLabel || "‚Äì", ""]);
        rows.push(["Calculated", "Weight composition", "Calculated", weightCompString, ""]);

        // Kinetics
        rows.push(["Kinetics", "Launch speed", "Calculated", isFinite(launchFpsUsed) ? formatNumber(launchFpsUsed, 0) : "‚Äì", "fps"]);
        rows.push(["Kinetics", "Launch momentum", "Calculated", isFinite(launchMomentum) ? formatNumber(launchMomentum, 3) : "‚Äì", "slug¬∑ft/s"]);
        rows.push(["Kinetics", "Speed @ Dist 1", "Calculated", isFinite(fps1) ? formatNumber(fps1, 0) : "‚Äì", "fps"]);
        rows.push(["Kinetics", "Momentum @ Dist 1", "Calculated", isFinite(momentum1) ? formatNumber(momentum1, 3) : "‚Äì", "slug¬∑ft/s"]);
        rows.push(["Kinetics", "Speed @ Dist 2", "Calculated", isFinite(fps2) ? formatNumber(fps2, 0) : "‚Äì", "fps"]);
        rows.push(["Kinetics", "Momentum @ Dist 2", "Calculated", isFinite(momentum2) ? formatNumber(momentum2, 3) : "‚Äì", "slug¬∑ft/s"]);
        rows.push(["Kinetics", "Game momentum band (farthest distance)", "Calculated", momentumBandResultStr, ""]);

        // Notes
        rows.push(["Notes", "Notes", "Input", userNotesStr || "‚Äî", ""]);

        let html = "";
        for (const [cat, field, source, value, units] of rows) {
          html += "<tr>" +
            "<td>" + cat + "</td>" +
            "<td>" + field + "</td>" +
            "<td>" + source + "</td>" +
            "<td>" + value + "</td>" +
            "<td>" + units + "</td>" +
            "</tr>";
        }
        tableBody.innerHTML = html;
      }
    }

    function updateThemeToggleLabel() {
      const icon = document.getElementById("themeToggleIcon");
      const text = document.getElementById("themeToggleText");
      const isLight = document.body.classList.contains("light-mode");

      if (!icon || !text) return;

      if (isLight) {
        icon.textContent = "üåû";
        text.textContent = "Light";
      } else {
        icon.textContent = "üåô";
        text.textContent = "Dark";
      }
    }

    function initTheme() {
      const saved = localStorage.getItem("arrowTuneTheme");
      if (saved === "light") {
        document.body.classList.add("light-mode");
      }
      updateThemeToggleLabel();

      const btn = document.getElementById("themeToggle");
      if (btn) {
        btn.addEventListener("click", () => {
          const isLight = document.body.classList.toggle("light-mode");
          localStorage.setItem("arrowTuneTheme", isLight ? "light" : "dark");
          updateThemeToggleLabel();
        });
      }
    }

    function initInfoPanels() {
      const buttons = document.querySelectorAll(".info-btn");
      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const targetId = btn.getAttribute("data-info-target");
          if (!targetId) return;
          const panel = document.getElementById(targetId);
          if (!panel) return;
          const isHidden =
            panel.style.display === "none" ||
            panel.style.display === "";
          panel.style.display = isHidden ? "block" : "none";
        });
      });
    }

    const inputIds = [
      "bowDrawWeightLb",
      "bowDrawLengthIn",
      "launchFps",
      "fpsLossPer10Yards",
      "dist1Yards",
      "dist2Yards",
      "trajMaxDistanceYards",
      "arrowLengthIn",
      "totalArrowWeightGrInput",
      "bareShaftWeightGr",
      "nockWeightGr",
      "wrapWeightGr",
      "vaneCount",
      "vaneWeightGr",
      "insertWeightGr",
      "pointWeightGr",
      "glueWeightGr",
      "balancePointIn",
      "arrowSpine",
    ];

    inputIds.forEach((id) => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("input", calculateAndUpdate);
      }
    });

    const arrowNameInput = document.getElementById("arrowName");
    if (arrowNameInput) {
      arrowNameInput.addEventListener("input", () => {
        updateArrowNameDisplay();
        calculateAndUpdate();
      });
    }

    const bowModelInput = document.getElementById("bowModel");
    if (bowModelInput) {
      bowModelInput.addEventListener("input", calculateAndUpdate);
    }

    const notesEl = document.getElementById("userNotes");
    if (notesEl) {
      notesEl.addEventListener("input", calculateAndUpdate);
    }

    const trajInput = document.getElementById("trajMaxDistanceYards");
    const dist2Input = document.getElementById("dist2Yards");
    if (trajInput && dist2Input) {
      trajInput.value = dist2Input.value;

      dist2Input.addEventListener("input", () => {
        trajInput.value = dist2Input.value;
        calculateAndUpdate();
      });

      trajInput.addEventListener("input", () => {
        calculateAndUpdate();
      });
    }

    const bandsHelpToggle = document.getElementById("bandsHelpToggle");
    const bandsHelpPanel = document.getElementById("bandsHelpPanel");
    if (bandsHelpToggle && bandsHelpPanel) {
      bandsHelpToggle.addEventListener("click", () => {
        const isHidden =
          bandsHelpPanel.style.display === "none" ||
          bandsHelpPanel.style.display === "";
        bandsHelpPanel.style.display = isHidden ? "block" : "none";
      });
    }

    const resultsHelpToggle = document.getElementById("resultsHelpToggle");
    const theResultsHelpPanel = document.getElementById("resultsHelpPanel");

    if (resultsHelpToggle && theResultsHelpPanel) {
      resultsHelpToggle.addEventListener("click", () => {
        const isHidden =
          theResultsHelpPanel.style.display === "none" ||
          theResultsHelpPanel.style.display === "";
        theResultsHelpPanel.style.display = isHidden ? "block" : "none";
      });
    }

    const compToggle = document.getElementById("enableComponentDetails");
    const compDetails = document.getElementById("componentDetails");
    if (compToggle && compDetails) {
      const syncVisibility = () => {
        compDetails.style.display = compToggle.checked ? "block" : "none";
      };
      compToggle.addEventListener("change", () => {
        syncVisibility();
        calculateAndUpdate(); // recalc because toggle affects total weight logic
      });
      syncVisibility();
    }

    // --- CSV helpers ---

    function escapeCsvValue(val) {
      if (val == null) return "";
      val = String(val);
      if (/[",\n]/.test(val)) {
        return '"' + val.replace(/"/g, '""') + '"';
      }
      return val;
    }

    function tableToCsv() {
      const table = document.querySelector(".data-table");
      if (!table) return "";

      const rows = [];
      const headerCells = table.querySelectorAll("thead th");
      const headerVals = Array.from(headerCells).map((th) =>
        th.textContent.trim()
      );
      rows.push(headerVals.map(escapeCsvValue).join(","));

      const bodyRows = table.querySelectorAll("tbody tr");
      bodyRows.forEach((tr) => {
        const cells = tr.querySelectorAll("td");
        const vals = Array.from(cells).map((td) =>
          escapeCsvValue(td.textContent.trim())
        );
        rows.push(vals.join(","));
      });

      return rows.join("\n");
    }

    function downloadCsvFile(filename, text) {
      const blob = new Blob([text], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function parseCsvLine(line) {
      const result = [];
      let current = "";
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const ch = line[i];

        if (ch === '"') {
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === "," && !inQuotes) {
          result.push(current);
          current = "";
        } else {
          current += ch;
        }
      }
      result.push(current);
      return result;
    }

    function applyCsvToInputs(csvText) {
      const lines = csvText.split(/\r?\n/).filter((l) => l.trim() !== "");
      if (lines.length < 2) return;

      const header = parseCsvLine(lines[0]);
      const idxCategory = header.indexOf("Category");
      const idxField = header.indexOf("Field");
      const idxValue = header.indexOf("Value");

      if (idxCategory === -1 || idxField === -1 || idxValue === -1) {
        console.warn("CSV header does not match expected Data Table format.");
        return;
      }

      const mapping = {
        "Bow|Draw weight": "bowDrawWeightLb",
        "Bow|Draw length": "bowDrawLengthIn",
        "Bow|Launch speed estimate": "launchFps",
        "Bow|Speed loss / 10 yd": "fpsLossPer10Yards",
        "Bow|Bow model & year": "bowModel",
        "Arrow|Name": "arrowName",
        "Arrow|Spine": "arrowSpine",
        "Arrow|Arrow length": "arrowLengthIn",
        "Distances|Distance 1": "dist1Yards",
        "Distances|Distance 2": "dist2Yards",
        "Distances|Arc range (visual)": "trajMaxDistanceYards",
        "Components|Bare shaft weight": "bareShaftWeightGr",
        "Components|Nock weight": "nockWeightGr",
        "Components|Wrap weight": "wrapWeightGr",
        "Components|Vane count": "vaneCount",
        "Components|Vane weight each": "vaneWeightGr",
        "Components|Insert / outsert": "insertWeightGr",
        "Components|Point weight": "pointWeightGr",
        "Components|Glue weight (est.)": "glueWeightGr",
        "Calculated|Total arrow weight": "totalArrowWeightGrInput",
        "Balance|Balance point from nock": "balancePointIn",
        "Notes|Notes": "userNotes",
      };

      for (let i = 1; i < lines.length; i++) {
        const row = parseCsvLine(lines[i]);
        if (row.length < header.length) continue;

        const category = row[idxCategory].trim();
        const field = row[idxField].trim();
        let value = row[idxValue];

        const key = category + "|" + field;
        const elementId = mapping[key];
        if (!elementId) continue;

        const el = document.getElementById(elementId);
        if (!el) continue;

        if (el.tagName === "INPUT") {
          if (el.type === "number") {
            const numeric = parseFloat(value);
            el.value = isNaN(numeric) ? "" : numeric;
          } else {
            el.value = value;
          }
        } else if (el.tagName === "TEXTAREA") {
          el.value = value;
        }
      }

      updateArrowNameDisplay();
      calculateAndUpdate();
    }

    // --- Inputs-only CSV exporter ---

    function inputsToCsv() {
      const fields = [
        { id: "bowDrawWeightLb", label: "Bow draw weight (lb)" },
        { id: "bowDrawLengthIn", label: "Bow draw length (in)" },
        { id: "launchFps", label: "Launch FPS" },
        { id: "fpsLossPer10Yards", label: "Speed loss per 10yd" },
        { id: "bowModel", label: "Bow model & year" },
        { id: "arrowName", label: "Arrow name" },
        { id: "arrowSpine", label: "Arrow spine" },
        { id: "arrowLengthIn", label: "Arrow length (in)" },
        { id: "totalArrowWeightGrInput", label: "Total arrow weight (gr)" },
        { id: "bareShaftWeightGr", label: "Bare shaft weight (gr)" },
        { id: "nockWeightGr", label: "Nock weight (gr)" },
        { id: "wrapWeightGr", label: "Wrap weight (gr)" },
        { id: "vaneCount", label: "Vane count" },
        { id: "vaneWeightGr", label: "Vane weight each (gr)" },
        { id: "insertWeightGr", label: "Insert / outsert (gr)" },
        { id: "pointWeightGr", label: "Point weight (gr)" },
        { id: "glueWeightGr", label: "Glue weight (gr)" },
        { id: "balancePointIn", label: "Balance point from nock (in)" },
        { id: "dist1Yards", label: "Distance 1 (yd)" },
        { id: "dist2Yards", label: "Distance 2 (yd)" },
        { id: "trajMaxDistanceYards", label: "Arc range (yd)" },
        { id: "userNotes", label: "Notes" },
      ];

      const compToggle = document.getElementById("enableComponentDetails");
      const advancedEnabled = !!(compToggle && compToggle.checked);

      const rows = [];
      rows.push(["ElementId", "Label", "Value", "AdvancedComponentsEnabled"].map(escapeCsvValue).join(","));

      fields.forEach(({ id, label }) => {
        const el = document.getElementById(id);
        if (!el) return;
        const value = el.value ?? "";
        rows.push([
          escapeCsvValue(id),
          escapeCsvValue(label),
          escapeCsvValue(value),
          escapeCsvValue(advancedEnabled ? "true" : "false"),
        ].join(","));
      });

      return rows.join("\n");
    }

    function initCsvButtons() {
      const copyBtn = document.getElementById("copyCsvBtn");
      const downloadBtn = document.getElementById("downloadCsvBtn");
      const downloadInputsBtn = document.getElementById("downloadInputsCsvBtn");
      const uploadInput = document.getElementById("uploadInputsCsv");

      if (copyBtn) {
        copyBtn.addEventListener("click", async () => {
          const csv = tableToCsv();
          if (!csv) return;
          try {
            await navigator.clipboard.writeText(csv);
            copyBtn.textContent = "Copied!";
            setTimeout(() => {
              copyBtn.innerHTML = '<span>üìã</span><span>Copy table CSV</span>';
            }, 1200);
          } catch (e) {
            console.error("Clipboard write failed:", e);
            alert("Could not copy CSV to clipboard.");
          }
        });
      }

      if (downloadBtn) {
        downloadBtn.addEventListener("click", () => {
          const csv = tableToCsv();
          if (!csv) return;
          downloadCsvFile("arrow-tune-data.csv", csv);
        });
      }

      if (downloadInputsBtn) {
        downloadInputsBtn.addEventListener("click", () => {
          const csv = inputsToCsv();
          if (!csv) return;
          downloadCsvFile("arrow-tune-inputs.csv", csv);
        });
      }

      if (uploadInput) {
        uploadInput.addEventListener("change", (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (evt) => {
            const text = evt.target?.result;
            if (typeof text === "string") {
              applyCsvToInputs(text);
            }
          };
          reader.readAsText(file);
          e.target.value = "";
        });
      }
    }

    // --- Saved builds (localStorage) ---

    const SAVED_BUILDS_KEY = "arrowTuneSavedBuilds_v1";

    function loadSavedBuilds() {
      try {
        const raw = localStorage.getItem(SAVED_BUILDS_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        if (typeof parsed === "object" && parsed !== null) {
          return parsed;
        }
      } catch (e) {
        console.warn("Failed to parse saved builds:", e);
      }
      return {};
    }

    function saveSavedBuilds(builds) {
      try {
        localStorage.setItem(SAVED_BUILDS_KEY, JSON.stringify(builds));
      } catch (e) {
        console.warn("Failed to save builds:", e);
      }
    }

    function refreshSavedBuildsSelect() {
      const select = document.getElementById("savedBuildsSelect");
      if (!select) return;
      const builds = loadSavedBuilds();
      const current = select.value;

      select.innerHTML = '<option value="">(No saved builds)</option>';
      const names = Object.keys(builds).sort((a, b) =>
        a.toLowerCase().localeCompare(b.toLowerCase())
      );
      names.forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });

      if (names.includes(current)) {
        select.value = current;
      }
    }

    function getAllInputState() {
      const ids = [
        "bowDrawWeightLb",
        "bowDrawLengthIn",
        "launchFps",
        "fpsLossPer10Yards",
        "bowModel",
        "arrowName",
        "arrowSpine",
        "arrowLengthIn",
        "totalArrowWeightGrInput",
        "bareShaftWeightGr",
        "nockWeightGr",
        "wrapWeightGr",
        "vaneCount",
        "vaneWeightGr",
        "insertWeightGr",
        "pointWeightGr",
        "glueWeightGr",
        "balancePointIn",
        "dist1Yards",
        "dist2Yards",
        "trajMaxDistanceYards",
        "userNotes",
      ];
      const state = { fields: {}, advancedEnabled: false };

      ids.forEach((id) => {
        const el = document.getElementById(id);
        if (el) {
          state.fields[id] = el.value ?? "";
        }
      });

      const compToggle = document.getElementById("enableComponentDetails");
      state.advancedEnabled = !!(compToggle && compToggle.checked);

      return state;
    }

    function applyInputState(state) {
      if (!state || typeof state !== "object") return;

      const fields = state.fields || {};
      Object.entries(fields).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.value = value;
      });

      const compToggle = document.getElementById("enableComponentDetails");
      if (compToggle) {
        compToggle.checked = !!state.advancedEnabled;
        const compDetails = document.getElementById("componentDetails");
        if (compDetails) {
          compDetails.style.display = compToggle.checked ? "block" : "none";
        }
      }

      updateArrowNameDisplay();
      calculateAndUpdate();
    }

    function initSavedBuilds() {
      refreshSavedBuildsSelect();

      const saveBtn = document.getElementById("saveBuildBtn");
      const loadBtn = document.getElementById("loadBuildBtn");
      const deleteBtn = document.getElementById("deleteBuildBtn");
      const nameInput = document.getElementById("buildNameInput");
      const select = document.getElementById("savedBuildsSelect");

      if (saveBtn && nameInput && select) {
        saveBtn.addEventListener("click", () => {
          const name = nameInput.value.trim();
          if (!name) {
            alert("Please enter a build name before saving.");
            return;
          }
          const builds = loadSavedBuilds();
          builds[name] = getAllInputState();
          saveSavedBuilds(builds);
          refreshSavedBuildsSelect();
          select.value = name;
        });
      }

      if (loadBtn && select) {
        loadBtn.addEventListener("click", () => {
          const name = select.value;
          if (!name) {
            alert("Please select a saved build to load.");
            return;
          }
          const builds = loadSavedBuilds();
          const state = builds[name];
          if (!state) {
            alert("Saved build not found.");
            return;
          }
          applyInputState(state);
          const nameInputEl = document.getElementById("buildNameInput");
          if (nameInputEl) {
            nameInputEl.value = name;
          }
        });
      }

      if (deleteBtn && select) {
        deleteBtn.addEventListener("click", () => {
          const name = select.value;
          if (!name) {
            alert("Please select a saved build to delete.");
            return;
          }
          if (!confirm(`Delete saved build "${name}"?`)) return;

          const builds = loadSavedBuilds();
          delete builds[name];
          saveSavedBuilds(builds);
          refreshSavedBuildsSelect();
        });
      }
    }

    updateArrowNameDisplay();
    initTheme();
    initInfoPanels();
    calculateAndUpdate();
    initCsvButtons();
    initSavedBuilds();
  </script>
</body>
</html>
