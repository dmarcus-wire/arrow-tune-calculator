<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arrow Tune Calculator</title>
  <meta name="description" content="Offline arrow tuning calculator – FOC, velocity, impact KE, composition, and more." />
  <link href="https://rsms.me/inter/inter.css" rel="stylesheet">
  <style>
    :root { --bg:#f8fafc; --card:#ffffff; --text:#1e293b; --light:#64748b; --border:#e2e8f0; --primary:#0ea5e9; --success:#22c55e; --warning:#f59e0b; --danger:#ef4444; }
    .dark { --bg:#0f172a; --card:#1e293b; --text:#e2e8f0; --light:#94a3b8; --border:#334155; }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family:'Inter',sans-serif;
      background:var(--bg);
      color:var(--text);
      padding:1rem;
      min-height:100vh;
      line-height:1.6;
    }

    .container {
      max-width:1400px;
      margin:auto;
      display:grid;
      gap:1.5rem;
    }
    @media (min-width:1024px) {
      .container { grid-template-columns:1fr 1fr; }
    }

    .card {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:1.5rem;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }

    .subcard {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      padding: 1rem;
    }

    .card-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid var(--border);
      padding-bottom:0.75rem;
      margin-bottom:1rem;
      font-size:1.3rem;
      font-weight:600;
    }

    h1,h2,h3,h4 { color:var(--text); }

    label {
      display:block;
      margin:1rem 0 0.4rem;
      font-weight:600;
      font-size:0.95rem;
    }

    input, select, textarea {
      width:100%;
      padding:0.75rem;
      border:1px solid var(--border);
      border-radius:8px;
      background:var(--card);
      color:var(--text);
      font-size:1rem;
    }
    input:focus, select:focus, textarea:focus {
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(14,165,233,0.2);
    }

    button {
      padding:0.75rem 1.2rem;
      border:none;
      border-radius:8px;
      background:var(--primary);
      color:white;
      font-weight:600;
      cursor:pointer;
    }
    .btn-small { padding:0.5rem 0.9rem; font-size:0.9rem; }
    .btn-refresh { background:var(--warning); }

    .flex { display:flex; gap:1rem; align-items:center; }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }

    /* NEW: helper to center everything in Performance cards */
    .text-center { text-align:center; }

    .toggle-switch {
      position:relative;
      display:inline-block;
      width:56px;
      height:30px;
    }
    .toggle-switch input { opacity:0; width:0; height:0; }
    .slider {
      position:absolute;
      cursor:pointer;
      inset:0;
      background:#cbd5e1;
      border-radius:34px;
      transition:.3s;
    }
    .slider:before {
      position:absolute;
      content:"";
      height:24px;
      width:24px;
      left:3px;
      bottom:3px;
      background:white;
      border-radius:50%;
      transition:.3s;
    }
    input:checked + .slider { background:var(--primary); }
    input:checked + .slider:before { transform:translateX(26px); }

    .info-btn {
      font-size: 1.0rem;
      color: var(--primary);
      background: none;
      border: none;
    }
    .info-btn:hover {
      opacity: 1;
      transform: scale(1.2);   /* nice hover pop */
    }

    .advanced {
      display:none;
      margin-top:1rem;
      padding-top:1rem;
      border-top:1px solid var(--border);
    }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:0.5rem;
      font-size:0.95rem;
    }
    th, td {
      padding:0.6rem;
      text-align:left;
      border-bottom:1px solid var(--border);
    }
    th { background:var(--bg); font-weight:600; }

    .patreon-btn {
      display:block;
      margin:3rem auto;
      background:#ff424d;
      color:white;
      text-decoration:none;
      padding:1rem 2rem;
      border-radius:12px;
      font-weight:bold;
      text-align:center;
      max-width:300px;
    }

    .light-only { display: block; }
    .dark-only { display: none; }
    .dark .light-only { display: none; }
    .dark .dark-only { display: block; }

    #outputs-column,
    #outputs-column * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
      font-weight: 600 !important;
      letter-spacing: -0.02em;
    }
    #outputs-column h3 {
      font-size: 1.15rem !important;
      margin: 0 0 0.4rem 0;
      font-weight: 700 !important;
    }
    #outputs-column div[style*="font-size:2.5rem"],
    #outputs-column div[style*="font-size:3rem"] {
      font-size: 2.6rem !important;
      line-height: 1.1;
    }
    /* Removed special #focValue override so it matches other card values */

    #smallGameStatus,
    #deerStatus,
    #elkStatus,
    #mooseStatus {
      font-size: 2.4rem !important;
      font-weight: 800 !important;
    }
    #outputs-column small {
      font-weight: 500 !important;
      font-size: 0.9rem;
      opacity: 0.85;
    }

    /* Toast */
    #toast {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 0.6rem 1.1rem;
      border-radius: 999px;
      box-shadow: 0 6px 18px rgba(15,23,42,0.25);
      font-size: 0.9rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease-out;
      z-index: 999;
    }

    /* Compact FOC bar */
    .foc-bar-wrapper { margin-top: 0.25rem; }

    .foc-bar-track {
      position: relative;
      height: 10px;
      border-radius: 999px;
      background: var(--bg);
      overflow: hidden;
    }

    .foc-bar-fill {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      border-radius: 999px;
      background: var(--primary);
      opacity: 0.25;
      width: 0%;
    }

    .foc-ideal-range {
      position: absolute;
      top: 1px;
      bottom: 1px;
      border-radius: 999px;
      background: var(--success);
      opacity: 0.25;
      left: 40%;
      width: 20%;
    }

    .foc-marker {
      position: absolute;
      top: -4px;
      width: 0;
      height: 18px;
      border-left: 2px solid var(--primary);
    }

    .foc-bar-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--light);
      margin-top: 0.25rem;
    }

    /* Compact composition bar */
    .comp-bar-track {
      position: relative;
      height: 10px;
      border-radius: 999px;
      background: var(--bg);
      overflow: hidden;
      display: flex;
    }

    .comp-seg { height: 100%; }

    .comp-seg-shaft { background: #94a3b8; }
    .comp-seg-point { background: #0ea5e9; }
    .comp-seg-other { background: #22c55e; }

    .comp-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: var(--light);
    }

    .comp-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      margin-right: 0.25rem;
    }

    .comp-dot-shaft { background: #94a3b8; }
    .comp-dot-point { background: #0ea5e9; }
    .comp-dot-other { background: #22c55e; }

    /* Info overlay */
    .info-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 998;
    }
    .info-overlay.open {
      display: flex;
    }
    .info-panel {
      background: var(--card);
      color: var(--text);
      border-radius: 12px;
      max-width: 420px;
      width: 90%;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 20px 40px rgba(15,23,42,0.35);
      position: relative;
    }
    .info-panel h2 {
      margin: 0 0 0.5rem 0;
      font-size: 1.2rem;
    }
    .info-panel p {
      font-size: 0.95rem;
      margin: 0.35rem 0;
      color: var(--light);
    }
    .info-close {
      position:absolute;
      top:0.6rem;
      right:0.75rem;
      border:none;
      background:transparent;
      font-size:1.4rem;
      cursor:pointer;
      color: var(--light);
    }
    .info-close:hover {
      color: var(--primary);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- LEFT: INPUTS -->
    <div id="inputs-column">
      <div class="card">
        <div class="card-header">
          <h1>Arrow Tune Calculator</h1>
          <div class="flex">
            <span style="color:var(--light);">Light</span>
            <label class="toggle-switch">
              <input type="checkbox" id="darkModeToggle"><span class="slider"></span>
            </label>
            <span style="color:var(--light);">Dark</span>
          </div>
        </div>
        <p style="color:var(--light);">
          Offline • Mobile-friendly • Live calculations<br>
          <span style="font-size:0.9rem; color:var(--primary); font-weight:600;">Version 2.0.9</span>
        </p>
      </div>

      <div class="subcard" style="margin-top:1rem;">
        <div class="card-header">
          <h3>Your Setups</h3>
        </div>
        <label>
          Build Name
          <button class="info-btn" type="button" data-info="buildName">ⓘ</button>
        </label>
        <div class="flex">
          <input type="text" id="buildName" placeholder="e.g. 2025 Hoyt RX-9 70lb 500gr">
          <button class="btn-small" id="suggestName">Suggest</button>
        </div>
        <div class="flex" style="margin-top:1rem;gap:0.5rem;flex-wrap:wrap;">
          <button id="saveBuild">Save Build</button>
          <select id="loadBuildSelect"><option value="">– Load Build –</option></select>
          <button style="background:var(--danger);" id="deleteBuild">Delete</button>
        </div>
      </div>

      <!-- Bow Setup -->
      <div class="subcard" style="margin-top:1rem;">
        <div class="card-header">
          <h3>Bow Setup</h3>
          <button class="info-btn" type="button" data-info="bowModel">ⓘ</button>
        </div>
        <div class="grid-2">
          <div>
            <label>
              Bow Model
              <button class="info-btn" type="button" data-info="bowModel">ⓘ</button>
            </label>
            <input type="text" id="bowModel" step="0.5">
          </div>
          <div>
            <label>
              IBO/ATA Speed (FPS)
              <button class="info-btn" type="button" data-info="iboRating">ⓘ</button>
            </label>
            <input type="number" id="iboRating" value="0" step="0.5">
          </div>
          <div>
            <label>
              Draw Weight (lbs)
              <button class="info-btn" type="button" data-info="drawWeight">ⓘ</button>
            </label>
            <input type="number" id="drawWeight" value="70" step="0.5">
          </div>
          <div>
            <label>
              Draw Length (in)
              <button class="info-btn" type="button" data-info="drawLength">ⓘ</button>
            </label>
            <input type="number" id="drawLength" value="29" step="0.5">
          </div>
          <div>
            <label>
              String Add-ons (gr)
              <button class="info-btn" type="button" data-info="stringWeightSimple">ⓘ</button>
            </label>
            <input type="number" id="stringWeightSimple" value="0" step="0.5">
          </div>
          <div>
            <label>
              Application
              <button class="info-btn" type="button" data-info="application">ⓘ</button>
            </label>
            <select id="application">
              <option>Target / 3D</option>
              <option selected>Hunting</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div class="flex" style="margin-top:1rem;justify-content:space-between;">
          <label>
            Advanced String Components
            <button class="info-btn" type="button" data-info="toggleString">ⓘ</button>
          </label>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleString"><span class="slider"></span>
          </label>
        </div>
        <div id="stringAdvanced" class="advanced">
          <div class="grid-2">
            <div>
              <label>
                Peep
                <button class="info-btn" type="button" data-info="peepWeight">ⓘ</button>
              </label>
              <input type="number" id="peepWeight" value="0" step="0.5">
            </div>
            <div>
              <label>
                D-Loop
                <button class="info-btn" type="button" data-info="dloopWeight">ⓘ</button>
              </label>
              <input type="number" id="dloopWeight" value="0" step="0.5">
            </div>
            <div>
              <label>
                Kisser
                <button class="info-btn" type="button" data-info="kisserWeight">ⓘ</button>
              </label>
              <input type="number" id="kisserWeight" value="0" step="0.5">
            </div>
            <div>
              <label>
                Silencers
                <button class="info-btn" type="button" data-info="silencersWeight">ⓘ</button>
              </label>
              <input type="number" id="silencersWeight" value="0" step="0.5">
            </div>
          </div>
          <p style="text-align:right;font-weight:600;">
            Total: <span id="stringTotal">0</span> grains
          </p>
        </div>
      </div>

      <!-- Arrow Setup -->
      <div class="subcard" style="margin-top:1rem;">
        <div class="card-header">
          <h3>Arrow Setup</h3>
          <button class="info-btn" type="button" data-info="arrowName">ⓘ</button>
        </div>
        <label>
          Arrow Name
          <button class="info-btn" type="button" data-info="arrowName">ⓘ</button>
        </label>
        <input type="text" id="arrowName">
        <div class="grid-2">
          <div>
            <label>
              Arrow Length (in)
              <button class="info-btn" type="button" data-info="arrowLength">ⓘ</button>
            </label>
            <input type="number" id="arrowLength" value="28.5" step="0.5">
          </div>
          <div>
            <label>
              Total Arrow Weight (gr)
              <button class="info-btn" type="button" data-info="totalArrowWeightSimple">ⓘ</button>
            </label>
            <input type="number" id="totalArrowWeightSimple" value="450" step="0.5">
            <small id="totalWeightHint"
                   style="display:block;margin-top:0.25rem;font-size:0.85rem;color:var(--light);">
            </small>
          </div>
          <div>
            <label>
              Point Weight (gr)
              <button class="info-btn" type="button" data-info="pointWeight">ⓘ</button>
            </label>
            <input type="number" id="pointWeight" value="125" step="0.5">
          </div>
          <div>
            <label>
              Balance Point (in)
              <button class="info-btn" type="button" data-info="balancePoint">ⓘ</button>
            </label>
            <input type="number" id="balancePoint" value="18.5" step="0.05">
          </div>
        </div>

        <div class="flex" style="margin-top:1rem;justify-content:space-between;">
          <label>
            Advanced Arrow Components
            <button class="info-btn" type="button" data-info="toggleArrow">ⓘ</button>
          </label>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleArrow"><span class="slider"></span>
          </label>
        </div>
        <div id="arrowAdvanced" class="advanced">
          <div class="grid-2">
            <div>
              <label>
                Bare Shaft
                <button class="info-btn" type="button" data-info="bareShaft">ⓘ</button>
              </label>
              <input type="number" id="bareShaft" value="0" step="0.1">
            </div>
            <div>
              <label>
                Nock System
                <button class="info-btn" type="button" data-info="nockWeight">ⓘ</button>
              </label>
              <input type="number" id="nockWeight" value="0" step="0.1">
            </div>
            <div>
              <label>
                Wrap
                <button class="info-btn" type="button" data-info="wrapWeight">ⓘ</button>
              </label>
              <input type="number" id="wrapWeight" value="0" step="0.1">
            </div>
            <div>
              <label>
                Vane Weight (each)
                <button class="info-btn" type="button" data-info="vaneWeightEach">ⓘ</button>
              </label>
              <input type="number" id="vaneWeightEach" value="0" step="0.1">
            </div>
            <div>
              <label>
                Vane Count
                <button class="info-btn" type="button" data-info="vaneCount">ⓘ</button>
              </label>
              <input type="number" id="vaneCount" value="0" step="1">
            </div>
            <div>
              <label>
                Insert/Outsert
                <button class="info-btn" type="button" data-info="insertWeight">ⓘ</button>
              </label>
              <input type="number" id="insertWeight" value="0" step="0.5">
            </div>
            <div>
              <label>
                Glue / Pin Nock
                <button class="info-btn" type="button" data-info="glueWeight">ⓘ</button>
              </label>
              <input type="number" id="glueWeight" value="0" step="0.5">
            </div>
          </div>
          <p style="text-align:right;font-weight:600;">
            Total: <span id="arrowTotal">0.0</span> grains
          </p>
        </div>
      </div>

      <div class="subcard" style="margin-top:1rem;">
        <div class="card-header">
          <h3>Notes</h3>
          <button class="info-btn" type="button" data-info="notes">ⓘ</button>
        </div>

        <textarea id="notes" rows="4" placeholder="Tuning notes..."></textarea>
      </div>
    </div>

    <!-- RIGHT: OUTPUTS -->
    <div id="outputs-column">
      <!-- Arrow Efficiency + FOC + Weight Composition -->
      <div class="card">
        <div class="card-header">
          <h2>Arrow Efficiency</h2>
          <button class="info-btn" type="button" data-info="arrowEfficiency">ⓘ</button>
        </div>

        <!-- Primary efficiency outputs -->
        <div class="grid-2" style="text-align:center; margin-bottom:1.5rem;">
          <div class="card">
            <div style="display:flex;justify-content:center;align-items:center;gap:0.25rem;">
              <h3 style="color:var(--primary);margin:0;text-align:center;">FPS</h3>
              <button class="info-btn" type="button" data-info="actualFPS">ⓘ</button>
            </div>
            <input type="number" id="actualFPS" step="0.1"
                   style="font-size:2.5rem;text-align:center;border:3px solid var(--primary);border-radius:12px;padding:0.5rem;">
            <button class="btn-small btn-refresh" id="recalcFPS">Recalculate</button>
            <small id="fpsSource"
                   style="display:block;margin-top:0.35rem;font-size:0.8rem;color:var(--light);">
            </small>
          </div>

          <div class="card">
            <div style="display:flex;justify-content:center;align-items:center;gap:0.25rem;">
              <h3 style="color:var(--primary);margin:0;text-align:center;">GPP</h3>
              <button class="info-btn" type="button" data-info="gpp">ⓘ</button>
            </div>
            <div style="font-size:2.5rem;" id="gppValue">-</div>
            <small id="gppHint"
                   style="display:block;margin-top:0.35rem;font-size:0.8rem;color:var(--light);">
              Grains per pound of draw weight.
            </small>
          </div>
          <div class="card">
            <div style="display:flex;justify-content:center;align-items:center;gap:0.25rem;">
              <h3 style="color:var(--primary);margin:0;text-align:center;">GPI</h3>
              <button class="info-btn" type="button" data-info="gpi">ⓘ</button>
            </div>
            <div style="font-size:2.5rem;" id="gpiValue">-</div>
          </div>
          <div class="card">
            <div style="display:flex;justify-content:center;align-items:center;gap:0.25rem;">
              <h3 style="color:var(--primary);margin:0;text-align:center;">TW</h3>
              <button class="info-btn" type="button" data-info="finalArrowWeight">ⓘ</button>
            </div>
            <div style="font-size:2.5rem;" id="finalArrowWeight">-</div>
          </div>
        </div>

        <!-- FOC + Composition subcards -->
        <div class="grid-2" style="gap:1rem;">
          <!-- FOC SUBCARD -->
          <div class="subcard">
            <div style="display:flex;justify-content:center;align-items:center;gap:0.25rem;margin-bottom:0.5rem;">
              <h3 style="margin:0;color:var(--primary);text-align:center;">FOC</h3>
              <button class="info-btn" type="button" data-info="foc">ⓘ</button>
            </div>
            <div style="text-align:center;margin-bottom:0.5rem;">
              <!-- Updated FOC value style to match other cards: same size, default color -->
              <div id="focValue"
                   style="font-size:2.5rem;font-weight:800;">-</div>
              <div style="font-size:0.9rem;color:var(--light);">
                Ideal Range: 12–18%
              </div>
            </div>

            <div class="foc-bar-wrapper">
              <div class="foc-bar-track">
                <div id="focBarFill" class="foc-bar-fill"></div>
                <div class="foc-ideal-range"></div>
                <div id="focMarker" class="foc-marker"></div>
              </div>
              <div class="foc-bar-labels">
                <span>0%</span><span>30%</span>
              </div>
            </div>

            <small id="focHint"
                   style="display:block;margin-top:0.5rem;font-size:0.85rem;color:var(--light);">
              FOC helps with broadhead stability and penetration.
            </small>
          </div>

          <!-- Arrow Weight Composition SUBCARD -->
          <div class="subcard">
            <div style="display:flex;justify-content:center;align-items:center;gap:0.25rem;margin-bottom:0.5rem;">
              <h3 style="margin:0;color:var(--primary);text-align:center;">AWC</h3>
              <button class="info-btn" type="button" data-info="composition">ⓘ</button>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:0.5rem;">
              <span id="compTotalLabel" style="font-size:0.9rem;color:var(--light);">-</span>
            </div>

            <div class="comp-bar-track">
              <div id="compShaftSeg" class="comp-seg comp-seg-shaft" style="width:0%;"></div>
              <div id="compPointSeg" class="comp-seg comp-seg-point" style="width:0%;"></div>
              <div id="compOtherSeg" class="comp-seg comp-seg-other" style="width:0%;"></div>
            </div>

            <div class="comp-legend">
              <span style="white-space:nowrap;">
                <span class="comp-dot comp-dot-shaft"></span>
                <span id="shaftPctLabel">Shaft: 0%</span>
              </span>
              <span style="white-space:nowrap;">
                <span class="comp-dot comp-dot-point"></span>
                <span id="pointPctLabel">Point: 0%</span>
              </span>
              <span style="white-space:nowrap;">
                <span class="comp-dot comp-dot-other"></span>
                <span id="compPctLabel">Comp.: 0%</span>
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Velocity, Trajectory & Impact -> Performance -->
      <div class="card">
        <div class="card-header">
          <h2>Performance @ <span id="distanceValue">50</span> yards</h2>
          <button class="info-btn" type="button" data-info="velocitySection">ⓘ</button>
        </div>

        <!-- Distance slider -->
        <input type="range" id="distanceSlider" min="0" max="120" value="50" list="distanceTicks" style="width:100%;">
        <datalist id="distanceTicks">
          <option value="0" label="0"></option>
          <option value="20" label="20"></option>
          <option value="40" label="40"></option>
          <option value="60" label="60"></option>
          <option value="80" label="80"></option>
          <option value="100" label="100"></option>
          <option value="120" label="120"></option>
        </datalist>

        <!-- Simple metric cards for velocity & peak height -->
        <div class="grid-2" style="margin-top:1.25rem;">
          <div class="card text-center">
            <div style="display:flex;justify-content:center;align-items:center;gap:0.25rem;">
              <h3 style="margin:0;color:var(--success);text-align:center;">Velocity</h3>
              <button class="info-btn" type="button" data-info="velocityAtDistance">ⓘ</button>
            </div>
            <div style="font-size:3rem;" id="velocityAtDistance">-</div>
            <small>
              FPS at <span id="velocityDistanceLabel">50</span> yd (estimated at target)
            </small>
          </div>
          <div class="card text-center">
            <div style="display:flex;justify-content:center;align-items:center;gap:0.25rem;">
              <h3 style="margin:0;color:var(--success);text-align:center;">Peak Height</h3>
              <button class="info-btn" type="button" data-info="peakHeight">ⓘ</button>
            </div>
            <div style="font-size:3rem;" id="peakHeightValue">-</div>
            <small>
              highest point 
              <span id="peakDistanceValue">-</span> yd to target
            </small>
          </div>
        </div>

        <!-- KE / impact cards -->
        <div class="grid-2" style="margin-top:1rem;">
          <div class="card text-center">
            <div style="display:flex;justify-content:center;align-items:center;gap:0.25rem;">
              <h3 style="color:var(--success);margin:0;text-align:center;">Launch KE</h3>
              <button class="info-btn" type="button" data-info="launchKE">ⓘ</button>
            </div>
            <div style="font-size:3rem;" id="keValue">-</div>
            <small>ft-lbs</small>
          </div>
          <div class="card text-center">
            <div style="display:flex;justify-content:center;align-items:center;gap:0.25rem;">
              <h3 style="color:var(--success);margin:0;text-align:center;">Time to Impact</h3>
              <button class="info-btn" type="button" data-info="timeToImpact">ⓘ</button>
            </div>
            <div style="font-size:3rem;" id="timeToImpact">-</div>
            <small>seconds</small>
          </div>
          <div class="card text-center">
            <div style="display:flex;justify-content:center;align-items:center;gap:0.25rem;">
              <h3 style="color:var(--success);margin:0;text-align:center;">Impact KE</h3>
              <button class="info-btn" type="button" data-info="impactKE">ⓘ</button>
            </div>
            <div style="font-size:3rem;" id="impactKE">-</div>
            <small>ft-lbs</small>
          </div>
          <div class="card text-center">
            <div style="display:flex;justify-content:center;align-items:center;gap:0.25rem;">
              <h3 style="color:var(--success);margin:0;text-align:center;">Impact Momentum</h3>
              <button class="info-btn" type="button" data-info="impactMom">ⓘ</button>
            </div>
            <div style="font-size:3rem;" id="impactMom">-</div>
            <small>slug·ft/s</small>
          </div>
        </div>
      </div>

      <!-- Game Effectiveness -->
      <div class="card">
        <div class="card-header">
          <h2>Game Effectiveness</h2>
          <button class="info-btn" type="button" data-info="gameEffectiveness">ⓘ</button>
        </div>

        <div style="margin-bottom:0.75rem;font-size:0.95rem;color:var(--light);">
          Impact @ <span id="gameDistanceDisplay">50</span> yd:
          <span id="gameKE">–</span> ft-lbs,
          <span id="gameMom">–</span> slug·ft/s
        </div>

        <div class="grid-2" style="text-align:center; gap:1rem;">
          <div class="card">
            <h3 style="margin:0;">Small / Thin-skinned</h3>
            <div style="font-size:1.1rem; margin:0.5rem 0;">Min: 25 ft-lbs • 0.30 slug·ft/s</div>
            <div style="font-size:2.8rem; font-weight:bold;" id="smallGameStatus">Send it</div>
          </div>

          <div class="card">
            <h3 style="margin:0;">Medium Game</h3>
            <div style="font-size:1.1rem; margin:0.5rem 0;">Min: 50 ft-lbs • 0.45 slug·ft/s</div>
            <div style="font-size:2.8rem; font-weight:bold;" id="deerStatus">Send it</div>
          </div>

          <div class="card">
            <h3 style="margin:0;">Large / Tough Game</h3>
            <div style="font-size:1.1rem; margin:0.5rem 0;">Min: 65 ft-lbs • 0.60 slug·ft/s</div>
            <div style="font-size:2.8rem; font-weight:bold;" id="elkStatus">Send it</div>
          </div>

          <div class="card">
            <h3 style="margin:0;">Dangerous / Extreme</h3>
            <div style="font-size:1.1rem; margin:0.5rem 0;">Min: 85 ft-lbs • 0.75 slug·ft/s</div>
            <div style="font-size:2.8rem; font-weight:bold;" id="mooseStatus">Send it</div>
          </div>
        </div>
      </div>

      <!-- Build Summary -->
      <div class="card">
        <div class="card-header">
          <h2>Build Summary</h2>
          <div class="flex" style="gap:0.5rem;">
            <button class="info-btn" type="button" data-info="buildSummary">ⓘ</button>
            <button class="btn-small" id="copySummary">Copy</button>
          </div>
        </div>
        <div id="summaryTable" style="font-size:1rem;"></div>
      </div>
    </div>
  </div>

  <a href="https://www.patreon.com/cw/ArrowTuneCalculator" target="_blank" class="patreon-btn">
    Support on Patreon
  </a>

  <div id="toast"></div>

  <!-- Info overlay -->
  <div id="infoOverlay" class="info-overlay">
    <div class="info-panel">
      <button class="info-close" type="button" aria-label="Close info">&times;</button>
      <div id="infoContent"></div>
    </div>
  </div>

<script>
  // --- Info panel content ---
  const INFO_CONTENT = {
    // Setups
    buildName: `
      <h2>Build Name</h2>
      <p>
        A human-friendly label for this bow + arrow setup. It’s used as the name
        when you save, load, and compare builds.
      </p>
      <p>
        The <strong>Suggest</strong> button auto-builds a name using date, bow model,
        draw weight, arrow name, and total arrow weight so your builds stay organized.
      </p>
    `,

    // Bow setup
    bowModel: `
      <h2>Bow Model</h2>
      <p>
        The make and model of your bow (e.g., "2025 Hoyt RX-9").
        This is saved with the build and used in the suggested build name.
      </p>
      <p>
        It doesn’t change the math directly, but it makes it easier to track which
        numbers go with which bow.
      </p>
    `,
    iboRating: `
      <h2>IBO / ATA Speed Rating</h2>
      <p>
        The manufacturer’s advertised max speed in feet per second (FPS), usually at
        70 lb draw, 30&quot; draw length, and a 350 gr arrow.
      </p>
      <p>
        This app uses that rating to <strong>estimate your real-world launch FPS</strong>
        based on your actual draw weight, arrow weight, and string weight until you
        replace it with chronograph data.
      </p>
    `,
    drawWeight: `
      <h2>Draw Weight (lbs)</h2>
      <p>
        How many pounds you pull at full draw. It controls how much energy the bow can
        put into the arrow.
      </p>
      <p>
        In this calculator, draw weight is used with total arrow weight to compute
        <strong>GPP (grains per pound)</strong>, which helps classify your arrow as
        light, all-around, or heavy for hunting and penetration.
      </p>
    `,
    drawLength: `
      <h2>Draw Length (inches)</h2>
      <p>
        How far you pull the string at full draw (your personal power stroke).
        Factory IBO speeds assume 30&quot; draw; shorter draws usually shoot slower.
      </p>
      <p>
        This value is saved with your build so your FPS, KE, and trajectory can be
        interpreted in the context of <em>your</em> form, not just factory specs.
      </p>
    `,
    stringWeightSimple: `
      <h2>String Add-ons (grains)</h2>
      <p>
        The combined weight of everything on your string (peep, loop, kisser, silencers),
        entered as a single number.
      </p>
      <p>
        This is used in the launch FPS estimate. Heavier strings generally reduce
        real-world FPS slightly compared to the IBO rating.
      </p>
      <p>
        Turn on <strong>Advanced String Components</strong> if you want to enter each
        piece separately.
      </p>
    `,
    application: `
      <h2>Application</h2>
      <p>
        High-level use for this setup: Target/3D, Hunting, or Other. This is saved in your
        build and may be used in future presets and recommendations.
      </p>
      <p>
        It does not change today’s calculations but helps keep your builds organized.
      </p>
    `,
    toggleString: `
      <h2>Advanced String Components</h2>
      <p>
        Turn this on if you want to enter the weights of your peep, D-loop, kisser, and
        silencers separately.
      </p>
      <p>
        When enabled, the app <strong>sums the detailed values</strong> and uses that
        total in the FPS estimate instead of the single String Add-ons field.
      </p>
    `,
    peepWeight: `
      <h2>Peep Weight</h2>
      <p>
        Weight of your peep sight in grains. Included in total string weight and the
        launch FPS estimate when Advanced String Components are enabled.
      </p>
    `,
    dloopWeight: `
      <h2>D-Loop Weight</h2>
      <p>
        Total weight of your D-loop in grains. Included in total string weight and the
        launch FPS estimate in Advanced mode.
      </p>
    `,
    kisserWeight: `
      <h2>Kisser Button Weight</h2>
      <p>
        Weight of your kisser button in grains. Included in total string weight and FPS
        estimation when using Advanced String Components.
      </p>
    `,
    silencersWeight: `
      <h2>Silencers Weight</h2>
      <p>
        Combined weight of all string silencers in grains. Included in total string
        weight and launch FPS estimation in Advanced mode.
      </p>
    `,

    // Arrow setup
    arrowName: `
      <h2>Arrow Name</h2>
      <p>
        A label for the arrow itself (e.g., "Easton Axis 5mm 300 spine").
        Used in the suggested build name and saved with the build.
      </p>
      <p>
        It doesn’t change calculations, but makes it much easier to track which shaft
        you’re tuning.
      </p>
    `,
    arrowLength: `
      <h2>Arrow Length</h2>
      <p>
        Measured from the throat of the nock to the <strong>end of the shaft</strong>
        (not including the point).
      </p>
      <p>
        This is used for <strong>GPI (grains per inch)</strong> and for the
        <strong>FOC calculation</strong> so the app knows the total shaft length
        your balance point is measured over.
      </p>
    `,
    totalArrowWeightSimple: `
      <h2>Total Arrow Weight (Simple Mode)</h2>
      <p>
        The full arrow weight in grains (shaft + insert/outsert + vanes + wrap + nock + point),
        entered as a single number.
      </p>
      <p>
        When Advanced Arrow Components is <strong>off</strong>, this value drives all
        weight-based metrics: GPP, KE, momentum, impact energy, and Build Summary.
      </p>
      <p>
        Turn on Advanced mode if you want the app to calculate total weight from individual components.
      </p>
    `,
    pointWeight: `
      <h2>Point Weight</h2>
      <p>
        Weight of your field point or broadhead in grains.
      </p>
      <p>
        Used in the <strong>FOC calculation</strong>, the
        <strong>Arrow Weight Composition</strong> bar, and total arrow weight
        when Advanced mode is enabled.
      </p>
    `,
    balancePoint: `
      <h2>Balance Point from Nock</h2>
      <p>
        Measure from the nock throat (string contact point) to the point where the
        arrow balances perfectly on a finger or edge.
      </p>
      <p>
        This value, together with arrow length, is used to compute
        <strong>FOC (Front of Center)</strong>.
      </p>
    `,
    toggleArrow: `
      <h2>Advanced Arrow Components</h2>
      <p>
        Enable this if you want to enter the weights of the shaft, vanes, wrap, insert,
        nock, and glue separately.
      </p>
      <p>
        In Advanced mode, the app <strong>adds up all components plus point weight</strong>
        to get total arrow weight instead of using the single Total Arrow Weight field.
      </p>
    `,
    bareShaft: `
      <h2>Bare Shaft Weight</h2>
      <p>
        Weight of the cut shaft only (no insert, vanes, wrap, nock, or point).
      </p>
      <p>
        Used in the total arrow weight and the shaft portion of the
        <strong>Arrow Weight Composition</strong> bar.
      </p>
    `,
    nockWeight: `
      <h2>Nock System Weight</h2>
      <p>
        Weight of your nock or pin-nock system in grains.
      </p>
      <p>
        Included in total arrow weight and counted as part of “Components” in the
        Arrow Weight Composition bar.
      </p>
    `,
    wrapWeight: `
      <h2>Wrap Weight</h2>
      <p>
        Total weight of any arrow wrap or cap wrap in grains.
      </p>
      <p>
        Included in total arrow weight and treated as “Components” in the composition bar.
      </p>
    `,
    vaneWeightEach: `
      <h2>Vane Weight (each)</h2>
      <p>
        Weight of a single vane or feather in grains.
      </p>
      <p>
        The app multiplies this by <strong>Vane Count</strong>, then adds it to total arrow
        weight as part of “Components”.
      </p>
    `,
    vaneCount: `
      <h2>Vane Count</h2>
      <p>
        How many vanes or feathers are on the arrow (3-fletch, 4-fletch, etc.).
      </p>
      <p>
        Used with Vane Weight (each) to compute total fletching weight for the
        arrow weight and composition breakdown.
      </p>
    `,
    insertWeight: `
      <h2>Insert / Outsert Weight</h2>
      <p>
        Weight of your insert or outsert system in grains.
      </p>
      <p>
        Included in total arrow weight and treated as “Components” in the
        Arrow Weight Composition bar.
      </p>
    `,
    glueWeight: `
      <h2>Glue / Pin Nock Weight</h2>
      <p>
        An estimate of the combined weight of glue, pin bushings, and any small
        hardware at the nock or insert end.
      </p>
      <p>
        Included in total arrow weight and the “Components” portion of the composition bar.
      </p>
    `,

    // Notes
    notes: `
      <h2>Notes</h2>
      <p>
        Free-form notes saved with this build — great for recording paper tune results,
        broadhead groups, chrono strings, or field observations.
      </p>
      <p>
        Notes are stored in your saved build so you can revisit why a setup worked
        (or didn’t) later.
      </p>
    `,

    // Outputs – Arrow Efficiency
    arrowEfficiency: `
      <h2>Arrow Efficiency</h2>
      <p>
        A quick overview of how your bow’s energy, arrow weight, and balance are working together.
      </p>
      <p>
        This section summarizes your main tuning metrics: launch speed, GPP, GPI, total arrow weight,
        FOC, and component breakdown.
      </p>
    `,
    actualFPS: `
      <h2>FPS</h2>
      <p>
        The speed the arrow leaves the bow, in feet per second.
      </p>
      <p>
        The app first <strong>estimates</strong> this value from your IBO rating, draw weight,
        arrow weight, and string weight, but you can overwrite it with chronograph data for
        more accurate KE, momentum, and impact predictions.
      </p>
    `,
    gpp: `
      <h2>GPP (Grains per Pound)</h2>
      <p>
        Total arrow weight divided by draw weight (grains per pound of draw).
      </p>
      <p>
        It’s a simple way to see if your arrow is light, all-around, or heavy for your bow.
        The app uses this to give guidance on where your setup sits in that spectrum.
      </p>
    `,
    gpi: `
      <h2>GPI (Grains per Inch)</h2>
      <p>
        Average grains per inch of length based on your total arrow weight and arrow length.
      </p>
      <p>
        Useful for comparing shafts and seeing how heavy your finished arrow is per inch,
        especially when switching between cut lengths.
      </p>
    `,
    finalArrowWeight: `
      <h2>TW (Total Weight)</h2>
      <p>
        The final arrow weight in grains (shaft + components + point).
      </p>
      <p>
        This drives nearly every other output: GPP, KE, momentum, impact, and the composition bar.
        Getting this number accurate is critical for realistic results.
      </p>
    `,
    foc: `
      <h2>FOC (Front of Center)</h2>
      <p>
        FOC shows how far forward the balance point is, expressed as a percentage of arrow length.
        More weight toward the front usually helps broadhead stability and penetration.
      </p>
      <p>
        The bar shows your value on a 0–30% scale, with a highlighted band for
        <strong>12–18%</strong>, a common sweet spot for many hunting setups.
      </p>
    `,
    composition: `
      <h2>AWC (Arrow Weight Composition)</h2>
      <p>
        A visual breakdown of how your arrow’s total weight is split between
        <strong>shaft</strong>, <strong>point</strong>, and other components.
      </p>
      <p>
        This is helpful for understanding where your mass is concentrated, and how changing
        inserts, vanes, or point weight affects overall build and FOC.
      </p>
    `,

    // Velocity / trajectory / impact
    velocitySection: `
      <h2>Performance @ Distance</h2>
      <p>
        Use the slider to set a target distance. The app then estimates:
        arrow speed at that distance, peak height of the arc, time of flight,
        and impact energy/momentum.
      </p>
      <p>
        Great for visualizing how your arrow behaves at different ranges and 
        how much it slows down over distance.
      </p>
    `,
    velocityAtDistance: `
      <h2>Velocity</h2>
      <p>
        Estimated arrow speed at the selected yardage based on your launch FPS and
        a simple decay model.
      </p>
      <p>
        This feeds the impact KE and momentum calculations and gives you a sense of
        how much speed you’re giving up at longer shots.
      </p>
    `,
    peakHeight: `
      <h2>Peak Height</h2>
      <p>
        The approximate maximum height of the arrow’s flight path above a flat line
        from you to the target, in feet.
      </p>
      <p>
        For a level shot, the peak typically occurs about halfway to the target.
        This is useful for understanding <strong>clearance through trees, brush,
        or shooting windows</strong>.
      </p>
    `,
    launchKE: `
      <h2>Launch Kinetic Energy</h2>
      <p>
        The arrow’s kinetic energy at the bow (in ft-lbs), based on total arrow weight
        and launch FPS.
      </p>
      <p>
        This is a common metric for comparing setups and is often used as a baseline for
        game recommendations.
      </p>
    `,
    timeToImpact: `
      <h2>Time to Impact</h2>
      <p>
        Estimated time (in seconds) for the arrow to reach the target at the current
        distance slider setting.
      </p>
      <p>
        This gives a feel for how “snappy” or “loopy” your setup is, and is useful when
        thinking about animal movement and string jump.
      </p>
    `,
    impactKE: `
      <h2>Impact Kinetic Energy</h2>
      <p>
        The arrow’s kinetic energy at the target distance in ft-lbs, using the
        estimated velocity at that distance.
      </p>
      <p>
        This value is compared against common minimums in the <strong>Game Effectiveness</strong>
        section to give a rough “Send it / Don’t” suggestion.
      </p>
    `,
    impactMom: `
      <h2>Impact Momentum</h2>
      <p>
        The arrow’s momentum at impact in slug·ft/s.
      </p>
      <p>
        Momentum favors heavier arrows and is another way to evaluate penetration potential,
        especially at longer distances.
      </p>
    `,

    // Game effectiveness
    gameEffectiveness: `
      <h2>Game Effectiveness</h2>
      <p>
        Uses your <strong>impact KE</strong> and <strong>impact momentum</strong> at the
        selected distance and compares them to common minimums for different game sizes.
      </p>
      <p>
        Each card shows a recommended minimum and a simple result:
        <strong>"Send it"</strong> if both KE and momentum thresholds are met,
        or <strong>"Don’t"</strong> if you’re below that class’s guideline.
      </p>
      <p>
        These are <em>guidelines</em>, not hard rules — shot placement, broadhead choice,
        and animal angle still matter a lot.
      </p>
    `,

    // Build summary
    buildSummary: `
      <h2>Build Summary</h2>
      <p>
        A snapshot of all the key inputs and outputs for your current setup:
        bow specs, arrow specs, FOC, GPP/GPI, launch speed, energy, momentum,
        and impact numbers at the selected distance.
      </p>
      <p>
        The <strong>Copy</strong> button copies this table as text so you can paste it
        into notes, messages, forums, or spreadsheets.
      </p>
    `
  };

  let toastTimer;
  function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.style.opacity = '1';
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => { toast.style.opacity = '0'; }, 2000);
  }

  // Dark mode
  const darkToggle = document.getElementById('darkModeToggle');
  if (
    localStorage.getItem('dark') === '1' ||
    (!localStorage.getItem('dark') && matchMedia('(prefers-color-scheme: dark)').matches)
  ) {
    document.body.classList.add('dark');
    darkToggle.checked = true;
  }
  darkToggle.addEventListener('change', () => {
    document.body.classList.toggle('dark', darkToggle.checked);
    localStorage.setItem('dark', darkToggle.checked ? '1' : '0');
  });

  // Build system
  const loadSelect = document.getElementById('loadBuildSelect');
  function refreshBuilds() {
    loadSelect.innerHTML = '<option value="">– Load Build –</option>';
    const builds = JSON.parse(localStorage.getItem('atc') || '{}');
    const keys = Object.keys(builds).sort();

    if (keys.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'No saved builds yet';
      opt.disabled = true;
      loadSelect.appendChild(opt);
      return;
    }

    keys.forEach(n => {
      const o = document.createElement('option');
      o.value = n;
      o.textContent = n;
      loadSelect.appendChild(o);
    });
  }

  // Arrow weight mode UI
  function updateArrowWeightMode() {
    const toggle = document.getElementById('toggleArrow');
    const simpleTotal = document.getElementById('totalArrowWeightSimple');
    const hint = document.getElementById('totalWeightHint');
    const isAdv = toggle.checked;

    if (isAdv) {
      simpleTotal.readOnly = true;
      simpleTotal.style.opacity = 0.6;
      hint.textContent =
        'In Advanced mode, total arrow weight is calculated from shaft, vanes, insert, nock, wrap, glue, and point.';
    } else {
      simpleTotal.readOnly = false;
      simpleTotal.style.opacity = 1;
    }
  }

  // Show/hide advanced sections + recalc
  document.getElementById('toggleString').onchange = e => {
    document.getElementById('stringAdvanced').style.display = e.target.checked ? 'block' : 'none';
    calculateEverything();
  };

  document.getElementById('toggleArrow').onchange = e => {
    document.getElementById('arrowAdvanced').style.display = e.target.checked ? 'block' : 'none';
    updateArrowWeightMode();
    calculateEverything();
  };

  // Save build (with checkbox support & overwrite confirmation)
  document.getElementById('saveBuild').onclick = () => {
    const n = document.getElementById('buildName').value.trim();
    if (!n) return alert('Name required');
    const all = JSON.parse(localStorage.getItem('atc') || '{}');

    if (all[n] && !confirm(`Overwrite existing build "${n}"?`)) {
      return;
    }

    const data = {};
    document.querySelectorAll('input,select,textarea').forEach(el => {
      if (!el.id) return;
      if (el.type === 'checkbox') {
        data[el.id] = { type: 'checkbox', checked: el.checked };
      } else {
        data[el.id] = { type: 'value', value: el.value };
      }
    });

    all[n] = data;
    localStorage.setItem('atc', JSON.stringify(all));
    showToast('Build saved');
    refreshBuilds();
  };

  // Load build (handles new structured format + legacy simple values)
  loadSelect.onchange = () => {
    const n = loadSelect.value;
    if (!n) return;
    const all = JSON.parse(localStorage.getItem('atc') || '{}');
    const d = all[n];
    if (!d) return;

    Object.keys(d).forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;

      const stored = d[id];

      if (stored && typeof stored === 'object' && 'type' in stored) {
        if (stored.type === 'checkbox') {
          el.checked = !!stored.checked;
          el.dispatchEvent(new Event('change'));
        } else {
          el.value = stored.value ?? '';
        }
      } else {
        if (el.type !== 'checkbox') {
          el.value = stored ?? '';
        }
      }
    });

    updateArrowWeightMode();
    calculateEverything();
    showToast('Build loaded');
  };

  document.getElementById('deleteBuild').onclick = () => {
    let n = loadSelect.value;

    // If nothing is selected, fall back to the typed build name
    if (!n) {
      const typed = document.getElementById('buildName').value.trim();
      if (typed) n = typed;
    }

    if (!n) {
      alert('Select a saved build or type its exact name to delete it.');
      return;
    }

    const all = JSON.parse(localStorage.getItem('atc') || '{}');

    if (!all[n]) {
      alert(`No saved build named "${n}" was found.`);
      return;
    }

    if (!confirm(`Delete build "${n}"?`)) return;

    delete all[n];
    localStorage.setItem('atc', JSON.stringify(all));
    refreshBuilds();
    loadSelect.value = '';
    showToast('Build deleted');
  };

  // Suggest Name
  document.getElementById('suggestName').onclick = () => {
    const d = new Date().toISOString().slice(0,10);
    const b = document.getElementById('bowModel').value.trim() || 'Bow';
    const dw = document.getElementById('drawWeight').value || '70';
    const arrow = document.getElementById('arrowName').value.trim() || 'Arrow';
    const weight = getArrowWeight().toFixed(0);
    document.getElementById('buildName').value = `${d} ${b} ${dw}lb ${arrow} ${weight}gr`;
  };

  // FPS source indicators
  const fpsInput = document.getElementById('actualFPS');
  const fpsSource = document.getElementById('fpsSource');

  function markFpsEstimated() {
    if (fpsSource) {
      fpsSource.textContent = 'Estimated from IBO, draw, arrow & string weight';
    }
  }

  function markFpsChrono() {
    if (fpsSource) {
      fpsSource.textContent = 'Using manual FPS (chronograph)';
    }
  }

  // Arrow weight helper
  function getArrowWeight() {
    const pointWeight = parseFloat(document.getElementById('pointWeight').value) || 125;

    if (document.getElementById('toggleArrow').checked) {
      const bare   = parseFloat(document.getElementById('bareShaft').value)        || 0;
      const nock   = parseFloat(document.getElementById('nockWeight').value)       || 0;
      const wrap   = parseFloat(document.getElementById('wrapWeight').value)       || 0;
      const vanes  = (parseFloat(document.getElementById('vaneWeightEach').value)  || 0) *
                     (parseFloat(document.getElementById('vaneCount').value)       || 0);
      const insert = parseFloat(document.getElementById('insertWeight').value)     || 0;
      const glue   = parseFloat(document.getElementById('glueWeight').value)       || 0;

      const advTotal = bare + nock + wrap + vanes + insert + glue;
      document.getElementById('arrowTotal').textContent = advTotal.toFixed(1);

      return advTotal + pointWeight;
    }

    return parseFloat(document.getElementById('totalArrowWeightSimple').value) || 0;
  }

  function calculateEverything(recalcFPS = false) {
    const len = parseFloat(document.getElementById('arrowLength').value) || 28;
    const weight = getArrowWeight();
    const balance = parseFloat(document.getElementById('balancePoint').value) || 18.5;
    const ibo = parseFloat(document.getElementById('iboRating').value) || 350;
    const dw = parseFloat(document.getElementById('drawWeight').value) || 70;
    const stringW = document.getElementById('toggleString').checked
      ? ['peepWeight','dloopWeight','kisserWeight','silencersWeight']
          .reduce((a,id)=>a+(parseFloat(document.getElementById(id).value)||0),0)
      : (parseFloat(document.getElementById('stringWeightSimple').value) || 25);

    if (document.getElementById('toggleString').checked) {
      const total = ['peepWeight','dloopWeight','kisserWeight','silencersWeight']
        .reduce((a,id)=>a+(parseFloat(document.getElementById(id).value)||0),0);
      document.getElementById('stringTotal').textContent = total;
    }

    // FPS
    let fps = parseFloat(fpsInput.value);
    if (recalcFPS || isNaN(fps) || fps <= 0) {
      const base = ibo * Math.sqrt((450 + stringW) / (450 + weight + stringW));
      fps = base * 0.94;
      fpsInput.value = fps.toFixed(1);
      markFpsEstimated();
    }

    // FOC
    const foc = ((balance - len/2) / len) * 100;
    const focValEl   = document.getElementById('focValue');
    const focMarker  = document.getElementById('focMarker');
    const focBarFill = document.getElementById('focBarFill');
    const focHint    = document.getElementById('focHint');

    focValEl.textContent = foc.toFixed(1) + '%';

    const focClamped = Math.max(0, Math.min(30, isFinite(foc) ? foc : 0));
    const markerLeft = (focClamped / 30) * 100;
    if (focMarker)  focMarker.style.left  = markerLeft + '%';
    if (focBarFill) focBarFill.style.width = markerLeft + '%';

    if (!isFinite(foc)) {
      focHint.textContent = 'Enter arrow length, balance point, and weight to compute FOC.';
      focHint.style.color = 'var(--light)';
    } else if (foc >= 12 && foc <= 18) {
      focHint.textContent = 'Ideal range for hunting.';
      focHint.style.color = 'var(--success)';
    } else if (foc < 10) {
      focHint.textContent = 'Very low FOC – may be less stable with broadheads.';
      focHint.style.color = 'var(--danger)';
    } else if (foc > 20) {
      focHint.textContent = 'Very high FOC – heavy front can reduce speed but increase penetration focus.';
      focHint.style.color = 'var(--warning)';
    } else {
      focHint.textContent = 'Workable range; many setups run 10–20%.';
      focHint.style.color = 'var(--light)';
    }

    // GPP / GPI / final weight
    const gpp = weight / dw;
    const gpi = weight / len;
    document.getElementById('gppValue').textContent = gpp.toFixed(1);
    document.getElementById('gpiValue').textContent = gpi.toFixed(1);
    document.getElementById('finalArrowWeight').textContent = weight.toFixed(1);

    const gppHint = document.getElementById('gppHint');
    let gppText = '';
    let gppColor = 'var(--light)';
    if (gpp < 5) {
      gppText = 'Very light – often not recommended for most hunting bows.';
      gppColor = 'var(--danger)';
    } else if (gpp < 6) {
      gppText = 'Light arrow – flatter trajectory, more 3D/target style.';
    } else if (gpp <= 8) {
      gppText = 'Solid all-around hunting weight.';
      gppColor = 'var(--success)';
    } else {
      gppText = 'Heavy arrow – penetration-focused setups.';
    }
    if (gppHint) {
      gppHint.textContent = gppText;
      gppHint.style.color = gppColor;
    }

    // KE and momentum
    const launchKE = (weight * fps * fps) / 450240;
    const launchMom = (weight * fps) / 225400;
    document.getElementById('keValue').textContent = launchKE.toFixed(1);

    const distYards = parseFloat(document.getElementById('distanceSlider').value) || 50;
    document.getElementById('distanceValue').textContent = distYards;

    const currentV = fps * Math.exp(-distYards/300);
    const impactKE = (weight * currentV * currentV) / 450240;
    const impactMom = (weight * currentV) / 225400;
    const time = (distYards * 3) / (fps * 0.8);

    document.getElementById('impactKE').textContent = impactKE.toFixed(1);
    document.getElementById('impactMom').textContent = impactMom.toFixed(3);
    document.getElementById('timeToImpact').textContent = time.toFixed(2);

    // Velocity card
    document.getElementById('velocityDistanceLabel').textContent = distYards;
    document.getElementById('velocityAtDistance').textContent = currentV.toFixed(0);

    // Closed-form projectile peak height (in feet, symmetric trajectory)
    const g = 32.174;              // ft/s^2
    const v0 = fps;                // ft/s
    const R_ft = distYards * 3;    // yards -> feet

    let peakHeightFt = 0;
    let peakYard = 0;
    if (v0 > 0 && R_ft > 0) {
      let sin2theta = (R_ft * g) / (v0 * v0);
      if (sin2theta > 0) {
        sin2theta = Math.min(1, Math.max(0, sin2theta));
        const theta = 0.5 * Math.asin(sin2theta);
        const sinTheta = Math.sin(theta);
        peakHeightFt = (v0 * v0 * sinTheta * sinTheta) / (2 * g);
        peakYard = distYards / 2;
      }
    }
    document.getElementById('peakHeightValue').textContent = peakHeightFt.toFixed(1);
    document.getElementById('peakDistanceValue').textContent = peakYard.toFixed(0);

    // Game effectiveness header
    document.getElementById('gameDistanceDisplay').textContent = distYards;
    document.getElementById('gameKE').textContent = impactKE.toFixed(1);
    document.getElementById('gameMom').textContent = impactMom.toFixed(3);

    // Arrow Weight Composition – percentages & bar
    const isAdv = document.getElementById('toggleArrow').checked;
    let shaft = 0, point = 0, comp = 0;
    if (isAdv) {
      shaft = parseFloat(document.getElementById('bareShaft').value) || 0;
      const nock   = parseFloat(document.getElementById('nockWeight').value) || 0;
      const wrap   = parseFloat(document.getElementById('wrapWeight').value) || 0;
      const vanes  = (parseFloat(document.getElementById('vaneWeightEach').value) || 0) *
                     (parseFloat(document.getElementById('vaneCount').value) || 0);
      const insert = parseFloat(document.getElementById('insertWeight').value) || 0;
      const glue   = parseFloat(document.getElementById('glueWeight').value) || 0;
      comp  = nock + wrap + vanes + insert + glue;
      point = parseFloat(document.getElementById('pointWeight').value) || 125;
    } else {
      point = parseFloat(document.getElementById('pointWeight').value) || 125;
      shaft = Math.max(0, weight - point);
      comp  = 0;
    }

    let shaftPct = 0, pointPct = 0, compPct = 0;
    if (weight > 0) {
      shaftPct = (shaft / weight) * 100;
      pointPct = (point / weight) * 100;
      compPct  = (comp  / weight) * 100;
    }

    const totalPct = shaftPct + pointPct + compPct;
    if (totalPct > 0 && Math.abs(totalPct - 100) > 0.5) {
      shaftPct = (shaftPct / totalPct) * 100;
      pointPct = (pointPct / totalPct) * 100;
      compPct  = (compPct  / totalPct) * 100;
    }

    const segShaft = document.getElementById('compShaftSeg');
    const segPoint = document.getElementById('compPointSeg');
    const segOther = document.getElementById('compOtherSeg');

    if (segShaft) segShaft.style.width = shaftPct.toFixed(1) + '%';
    if (segPoint) segPoint.style.width = pointPct.toFixed(1) + '%';
    if (segOther) segOther.style.width = compPct.toFixed(1) + '%';

    const labelTotal = document.getElementById('compTotalLabel');
    const labelShaft = document.getElementById('shaftPctLabel');
    const labelPoint = document.getElementById('pointPctLabel');
    const labelComp  = document.getElementById('compPctLabel');

    if (labelTotal) labelTotal.textContent = weight > 0 ? `${weight.toFixed(1)} gr total` : '-';
    if (labelShaft) labelShaft.textContent = `Shaft: ${shaftPct.toFixed(0)}%`;
    if (labelPoint) labelPoint.textContent = `Point: ${pointPct.toFixed(0)}%`;
    if (labelComp)  labelComp.textContent  = `Comp.: ${compPct.toFixed(0)}%`;

    // Game Effectiveness statuses (green if Send it, red if Don't)
    const games = [
      { ke: 25, mom: 0.30, id: "smallGameStatus" },
      { ke: 50, mom: 0.45, id: "deerStatus" },
      { ke: 55, mom: 0.50, id: "elkStatus" },
      { ke: 70, mom: 0.6, id: "mooseStatus" }
    ];

    games.forEach(gm => {
      const ok = impactKE >= gm.ke && impactMom >= gm.mom;
      const el = document.getElementById(gm.id);
      el.textContent = ok ? "Send it" : "Don’t";
      el.style.color = ok ? "var(--success)" : "var(--danger)";
    });

    // Build Summary table
    const summary = {
      "Build Name": document.getElementById('buildName').value || "Unnamed",
      "Bow Model": document.getElementById('bowModel').value || "-",
      "Draw Weight": dw + " lbs",
      "IBO Speed": ibo + " FPS",
      "Arrow Length": len.toFixed(2) + " in",
      "Total Arrow Weight": weight.toFixed(1) + " gr",
      "Point Weight": (parseFloat(document.getElementById('pointWeight').value) || 125).toFixed(0) + " gr",
      "FOC": foc.toFixed(1) + "%",
      "GPP": gpp.toFixed(1),
      "GPI": gpi.toFixed(1),
      "Launch FPS": fps.toFixed(1),
      "Launch KE": launchKE.toFixed(1) + " ft-lbs",
      "Launch Momentum": launchMom.toFixed(3) + " slug·ft/s",
      [`Impact @ ${distYards} yd`]: "",
      "Impact Velocity": currentV.toFixed(0) + " FPS",
      "Impact KE": impactKE.toFixed(1) + " ft-lbs",
      "Impact Momentum": impactMom.toFixed(3) + " slug·ft/s",
      "Time to Impact": time.toFixed(2) + " s"
    };

    document.getElementById('summaryTable').innerHTML =
      '<table>' +
      Object.entries(summary).map(([k,v]) =>
        `<tr><td style="font-weight:600;padding:0.5rem;">${k}</td><td style="text-align:right;padding:0.5rem;">${v}</td></tr>`
      ).join('') +
      '</table>';

    // Store latest summary for copy button
    window.latestSummary = summary;
  }

  // Recalculate button
  document.getElementById('recalcFPS').onclick = () => calculateEverything(true);

  // Copy summary button
  document.getElementById('copySummary').onclick = () => {
    if (!window.latestSummary) {
      calculateEverything(false);
    }
    const summary = window.latestSummary || {};
    const lines = [
      `Arrow Tune Build - ${new Date().toLocaleDateString()}`,
      ''
    ];

    Object.entries(summary).forEach(([k, v]) => {
      if (v === '') return; // Skip empty header row like "Impact @ 41 yd": ""
      lines.push(`${k}: ${v}`);
    });

    const text = lines.join('\n');
    navigator.clipboard.writeText(text).then(() => showToast('Summary copied'));
  };

  // Distance slider
  document.getElementById('distanceSlider').oninput = e => {
    document.getElementById('distanceValue').textContent = e.target.value;
    calculateEverything();
  };

  // All inputs trigger calculation (FPS stays manual if you're actively editing it)
  document.querySelectorAll('input,select,textarea').forEach(el => {
    el.addEventListener('input', () => {
      if (document.activeElement.id === 'actualFPS') {
        markFpsChrono();
        calculateEverything(false);
      } else {
        calculateEverything();
      }
    });
  });

  // Info overlay wiring
  const infoOverlay = document.getElementById('infoOverlay');
  const infoContent = document.getElementById('infoContent');
  const infoClose = document.querySelector('.info-close');

  function openInfo(key) {
    if (!infoOverlay || !infoContent) return;
    infoContent.innerHTML = INFO_CONTENT[key] || `
      <h2>Info</h2>
      <p>More details coming soon.</p>
    `;
    infoOverlay.classList.add('open');
  }

  if (infoClose) {
    infoClose.addEventListener('click', () => infoOverlay.classList.remove('open'));
  }

  if (infoOverlay) {
    infoOverlay.addEventListener('click', (e) => {
      if (e.target === infoOverlay) infoOverlay.classList.remove('open');
    });
  }

  document.querySelectorAll('.info-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const key = btn.dataset.info;
      if (key) openInfo(key);
    });
  });

  // Init
  refreshBuilds();
  updateArrowWeightMode();
  calculateEverything(true);
</script>
</body>
</html>