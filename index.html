<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArrowForge – Smart Arrow Tuner</title>
  <meta name="description" content="Offline-first archery calculator with AI advisor. Perfect arrow tuning made simple.">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQXJyb3dGb3JnZSIsInNob3J0X25hbWUiOiJBcnJvd0ZvcmdlIiwic3RhcnRfdXJsIjoiaHR0cHM6Ly9hIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCxiYXNlNjQsdmFsdWUiOiJkYXRhOmltYWdlL3N2Zyt4bWwgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCB5PSIuOWVtIiBmb250LXNpemU9IjkwIj7wn5iBLTwvdGV4dD48L3N2Zz4iLCJzaXplcyI6IjEyOHgxMjgiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCIsInB1cnBvc2UiOiJhbnkgbWFza2FibGUifV19">
  <link href="https://rsms.me/inter/inter.css" rel="stylesheet">
  <style>
    :root {
      --bg:#f8fafc; --card:#ffffff; --text:#1e293b; --light:#64748b; --border:#e2e8f0;
      --primary:#0ea5e9; --success:#22c55e; --warning:#f59e0b; --danger:#ef4444; --purple:#8b5cf6;
    }
    .dark {
      --bg:#0f172a; --card:#020617; --text:#e2e8f0; --light:#94a3b8; --border:#1e293b;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Inter',sans-serif;
      background:var(--bg);
      color:var(--text);
      padding:0.5rem; /* desktop */
      padding-bottom: env(safe-area-inset-bottom, 1rem); /* extra bottom space for home bar */
      padding-top: env(safe-area-inset-top, 0.5rem);
      min-height:100vh;
    }
    .container {
      max-width:1600px;
      margin:auto;
      display:grid;
      gap:1rem 1.5rem;
    }
    @media (max-width:768px) {
      body {
        padding:1rem;
        padding-bottom: max(1rem, env(safe-area-inset-bottom));
      }
    }
    @media (max-width:1023px) { .container { grid-template-columns:1fr; } }
    @media (min-width:1024px) { .container { grid-template-columns:460px 1fr; } }
    .card {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:1rem;
      box-shadow:0 4px 12px rgba(15,23,42,0.08);
    }

    /* Minimal tick marks for range sliders */
    input[type="range"] {
      -webkit-appearance: none; /* Remove default styling */
      appearance: none;
      background: linear-gradient(to right, 
        transparent 0%, 
        transparent 4%, 
        var(--light) 4%, 
        var(--light) 6%, 
        transparent 6%, 
        transparent 100%
      ) repeat-x;
      background-size: 10% 6px; /* Adjust for interval spacing (10% = every 10 units on 0-100 scale) */
      background-position: 0 center;
    }

    /* Optional: make ticks even subtler */
    .dark input[type="range"] {
      background-color: var(--border);
    }

    #inputs-column .card { padding:0.8rem; }
    #inputs-column input, #inputs-column select { padding:0.5rem; font-size:0.95rem; }
    #outputs-column .card { padding:1.25rem; }
    #outputs-column h2 { font-size:1.4rem; margin-bottom:1rem; }
    .card-header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.75rem; }
    h1 { font-size:1.5rem; margin:0; }
    input, select {
      width:100%;
      border:1px solid var(--border);
      border-radius:8px;
      background:var(--card);
      color:var(--text);
      padding:0.5rem;
    }
    .input-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:0.5rem 0;
      gap:0.75rem;
    }
    .input-row label {
      margin:0;
      font-weight:600;
      font-size:0.95rem;
      white-space:nowrap;
      color:var(--text);
      flex-shrink:0;
    }
    .input-row label::after { content:":"; margin-left:0.25rem; color:var(--light); }
    .input-row input, .input-row select {
      flex:1;
      min-width:140px;
      text-align:right;
      font-size:1rem;
    }
    @media (min-width:769px) {
      .input-row { gap:1rem; }
      .input-row input, .input-row select { max-width:240px; text-align:left; font-size:1.05rem; }
      .input-row label { font-size:1rem; }
    }
    .collapsible-trigger {
      cursor:pointer;
      padding:0.75rem 0 0.5rem;
      margin-top:0.75rem;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:600;
      color:var(--primary);
    }
    .collapsible-trigger .chevron {
      font-size:1.5rem;
      transition:transform 0.25s ease;
      color:var(--light);
    }
    .collapsible-trigger.open .chevron { transform:rotate(90deg); }
    .collapsible-content { display:none; padding-top:0.5rem; }
    .collapsible-trigger.open + .collapsible-content { display:block; }
    @media (max-width:768px) {
      .collapsible-mobile .card-content { display:none; }
      .collapsible-mobile.open .card-content { display:block; }
      .mobile-only-trigger {
        display:flex !important;
        cursor:pointer;
        padding:0.75rem 1rem;
        background:var(--card);
        border-top:1px solid var(--border);
        justify-content:space-between;
        align-items:center;
        font-weight:600;
        color:var(--primary);
        margin-top:0.5rem;
        border-radius:0 0 14px 14px;
      }
      .collapsible-mobile.open .mobile-only-trigger .chevron { transform:rotate(90deg); }
    }
    @media (min-width:769px) {
      .mobile-only-trigger { display:none !important; }
      .collapsible-mobile .card-content { display:block !important; }
    }
    .mobile-only-trigger { display:none; }
    button {
      padding:0.5rem 1rem;
      border:none;
      border-radius:999px;
      background:var(--primary);
      color:white;
      font-weight:600;
      font-size:0.95rem;
      line-height:1;
      cursor:pointer;
      min-height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btn-small { padding:0.35rem 0.7rem; font-size:0.85rem; }
    .secondary { background:transparent; color:var(--primary); border:1px solid var(--primary); }
    .flex { display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; }
    .toggle-switch { position:relative; width:50px; height:26px; }
    .toggle-switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; inset:0; background:#cbd5e1; border-radius:34px; transition:.3s; }
    .slider:before { position:absolute; content:""; height:20px; width:20px; left:3px; bottom:3px; background:white; border-radius:50%; transition:.3s; }
    input:checked + .slider { background:var(--primary); }
    input:checked + .slider:before { transform:translateX(24px); }
    .info-overlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.5);
      display:none; align-items:center; justify-content:center; z-index:1000;
    }
    .info-panel {
      background:var(--card);
      border-radius:12px;
      max-width:600px;
      width:90%;
      max-height:90vh;
      padding:1.5rem;
      box-shadow:0 20px 40px rgba(0,0,0,0.3);
      position:relative;
      overflow-y:auto;
    }
    .info-close {
      position:absolute; top:0.8rem; right:1rem;
      background:none; border:none; font-size:1.8rem;
      color:var(--light); cursor:pointer;
    }
  .game-table { width:100%; border-collapse:collapse; font-size:0.95rem; margin-top:0.5rem; }
    .game-table th, .game-table td { padding:0.5rem; text-align:center; border-bottom:1px solid var(--border); }
    .game-table th { background:var(--border); font-weight:600; }
    .send { color:var(--success); font-weight:700; }
    .marginal { color:var(--warning); font-weight:700; }
    .adjust { color:var(--danger); font-weight:700; }
  
  .stats-list { display:flex; flex-direction:column; gap:0.75rem; }
  .stat-item { }
    .bar {
      height:12px;
      border-radius:999px;
      background:var(--border);
      position:relative;
      overflow:visible; /* changed from hidden */
    }

    .stat-row {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .stat-title {
      width: 120px; /* fixed width for all titles — adjust as needed */
      text-align: right;
      flex-shrink: 0;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 0.5rem;
    }

    .stat-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .bar-fill {
      height:100%;
      border-radius:999px;
      transition:width 0.3s ease;
    }
    .sweet-spot {
      position:absolute;
      top:0; 
      left:40%; /* 12% of 30% scale = 40% position */
      width:20%; /* 6% range (18-12) = 20% of bar */
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
    }

    .bar-labels {
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      margin-top: 0.3rem;
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--light);
      pointer-events: none;
    }

    .gpp-sweet-spot {
      position:absolute;
      top:0; 
      left:30%; /* 6.5 on 5-10 scale = 30% position */
      width:20%; /* 1 unit range (7.5-6.5) = 20% of bar */
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
    }

    .gpi-sweet-spot {
      position:absolute;
      top:0; 
      left:35%; /* 7 GPI = 35% of 0–20 scale */
      width:12.5%; /* 2.5 unit range (9.5-7) = 12.5% of bar */
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
    }

    .totalwt-sweet-spot {
      position:absolute;
      top:0; left:31.58%; /* 350 on 50-1000 scale = ~31.58% */
      width:21.05%; /* 200 unit range (550-350) = ~21.05% of bar */
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
    }

    .stiffness-sweet-spot {
      position:absolute;
      top:0; 
      left:25%;
      width:50%;
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
    }

    .flatness-sweet-spot {
        position: absolute;
        top: 0;
        left: 33.33%; /* starts at ~4.5 ft on the bar (right = flatter) */
        width: 66.67%; /* covers from ~4.5 ft to 0 ft (Very Flat) */
        height: 100%;
        background: rgba(34,197,94,0.25);
        border-radius: 999px;
      }

    .group-stability-sweet-spot {
      position: absolute;
      top: 0;
      left: 66.67%; /* starts at 2/3 mark */
      width: 33.33%; /* covers 2 to 3 */
      height: 100%;
      background: rgba(34,197,94,0.25);
      border-radius: 999px;
    }

    .bar-marker {
      position: absolute;
      top: 0;
      width: 4px;
      height: 100%;
      background: #ef4444; /* red (same as your --danger) */
      border-radius: 2px;
      transform: translateX(-50%);
      transition: left 0.3s ease;
    }

    /* Re-use your existing Quick Stats bar styles, just add fill */
    .bar-fill {
      height: 100%;
      width: 0;
      background: var(--primary);
      border-radius: 999px;
      transition: width 0.3s ease;
    }

    /* Green fill for effective load */
    #effectiveLoadFill {
      background: var(--success) !important;
    }

    .stat-bar-container {
      width: 100%; /* takes full width of the flex item */
      min-width: 240px; /* minimum for small screens */
      max-width: 1000px; /* maximum for large screens — adjust if you want wider */
      margin-right: 0;
      position: relative;
    }

    @media (max-width: 768px) {
      .stat-bar-container {
        max-width: 300px; /* slightly smaller on mobile */
      }
    }

    .info-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem; /* smaller and consistent with text */
      color: var(--primary);
      padding: 0;
      margin-left: 0.4rem;
      line-height: 1;
      opacity: 0.8;
      transition: opacity 0.2s ease;
    }

    .info-btn:hover {
      opacity: 1;
    }

    /* Ensure it looks good in dark mode too */
    .dark .info-btn {
      color: var(--primary);
      opacity: 0.8;
    }

    .dark .info-btn:hover {
      opacity: 1;
    }

    .moving-value {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: .85rem;
      font-weight: 400;
      opacity: 0.9;
      color: var(--text);
      white-space: nowrap;
      pointer-events: none;
      transition: left 0.3s ease;
      z-index: 10;
    }

    .bar-marker {
      background: #ef4444; /* red */
    }

    /* Better spacing for Group Stability 0-1-2-3 labels */
    #groupStabilityValue ~ .stat-bar-container .bar-labels {
      justify-content: space-between;
      width: 100%;
      padding: 0 4px; /* small padding so labels don't touch edges */
    }

    #groupStabilityValue ~ .stat-bar-container .bar-labels span:nth-child(1) { left: 0%; }
    #groupStabilityValue ~ .stat-bar-container .bar-labels span:nth-child(2) { left: 33.33%; }
    #groupStabilityValue ~ .stat-bar-container .bar-labels span:nth-child(3) { left: 66.67%; }
    #groupStabilityValue ~ .stat-bar-container .bar-labels span:nth-child(4) { left: 100%; }

    #groupStabilityValue ~ .stat-bar-container .bar-labels span {
      position: absolute;
      transform: translateX(-50%);
      font-size: 0.85rem;
      color: var(--light);
    }

    #groupStabilityValue ~ .stat-bar-container .bar-labels span:nth-child(4) {
      transform: translateX(-100%); /* align "3" to the right edge */
    }

    .effective-load-sweet-spot {
      position:absolute;
      top:0; left:30%;
      width:50%;
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
    }

    /* Make Effective Draw Weight titles match Game Effectiveness class names */
    .effective-dw-title {
      font-weight: 400;
      font-size: .95rem;
      color: var(--text);
    }
  </style>
</head>
<body>
<div class="container">
  <div id="inputs-column">
    <div class="card">
      <div class="card-header">
        <h1>ArrowForge</h1>
        <div class="flex">
          <span style="color:var(--light);">Light</span>
          <label class="toggle-switch">
            <input type="checkbox" id="darkToggle"><span class="slider"></span>
          </label>
          <span style="color:var(--light);">Dark</span>
          <button id="aiButton" class="btn-small" style="background:var(--purple);">AI Advisor</button>
        </div>
      </div>
      <p style="color:var(--light);font-size:0.85rem;">Offline • Live • v0.0.11</p>
    </div>
    <div class="card">
      <h2>Build</h2>
      <div class="input-row">
        <label for="buildName">Build Name</label>
        <div class="flex" style="gap:0.5rem;">
          <input type="text" id="buildName" placeholder="e.g. 2025 Elk Slayer">
          <button class="btn-small secondary">Suggest</button>
        </div>
      </div>
      <div class="flex" style="margin-top:0.75rem; gap:0.5rem;">
        <button id="saveBuild">Save</button>
        <select id="loadBuild" style="flex:1;"><option>– Load Build –</option></select>
        <button id="deleteBuild" style="background:var(--danger);">Delete</button>
      </div>
    </div>

    <!---BOW INPUTS-->
        <div class="card" id="bowCard">
      <div class="collapsible-trigger" onclick="this.classList.toggle('open')">
        <span>Bow Details</span>
        <span class="chevron">></span>
      </div>
      <div class="collapsible-content">
        <div class="input-row"><label for="appType">Application</label><select id="appType"><option>Target</option><option selected>Hunting</option><option>Other</option></select></div>
        <!---Bow Model-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="bowModel">Model</label>
            <button type="button" onclick="showBowModelPopup()" class="info-btn" title="About Bow Model">ⓘ</button>
          </div>
          <input type="text" id="bowModel" placeholder="Hoyt RX-9" style="flex:1;">
        </div>
        <!---Bow Type-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="bowType">Bow Type</label>
            <button type="button" onclick="showBowTypePopup()" class="info-btn" title="About Bow Type">ⓘ</button>
          </div>
          <select id="bowType" onchange="updatePinCountForTraditional()">
            <option value="compound" selected>Compound</option>
            <option value="recurve">Recurve</option>
            <option value="longbow">Longbow</option>
          </select>
        </div>
        <!---IBO fps-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="ibo">IBO fps</label>
            <button type="button" onclick="showIboPopup()" class="info-btn" title="About IBO Speed">ⓘ</button>
          </div>
          <input type="number" id="ibo" value="340" min="200" max="400" step="1" style="flex:1;">
        </div>  
        <!---Brace Height-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="braceHeight">Brace height in</label>
            <button type="button" onclick="showBraceHeightPopup()" class="info-btn" title="About Brace Height">ⓘ</button>
          </div>
          <input type="number" id="braceHeight" value="6" min="4" max="9" step="0.1" style="flex:1;">
        </div>        
        <!---Cam System-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="camType">Cam System</label>
            <button type="button" onclick="showCamTypePopup()" class="info-btn" title="About Cam System">ⓘ</button>
          </div>
          <select id="camType" style="flex:1;">
            <option value="hybrid">Hybrid / Binary</option>
            <option value="single">Single Cam</option>
            <option value="twin">Twin / Dual Cam</option>
            <option value="n/a">N/A (Recurve/Longbow)</option>
          </select>
        </div>
        <!---Draw Weight-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="drawWt">Draw wt lb</label>
            <button type="button" onclick="showDrawWtPopup()" class="info-btn" title="About Draw Weight">ⓘ</button>
          </div>
          <input type="number" id="drawWt" value="70" min="30" max="100" step="0.5" style="flex:1;">
        </div>
        <!---Draw Length-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="drawLen">Draw length in</label>
            <button type="button" onclick="showDrawLenPopup()" class="info-btn" title="About Draw Length">ⓘ</button>
          </div>
          <input type="number" id="drawLen" value="29" min="24" max="34" step="0.1" style="flex:1;">
        </div>
        <!---Let off %--> 
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="letOff">Let-off %</label>
            <button type="button" onclick="showLetOffPopup()" class="info-btn" title="About Let-off">ⓘ</button>
          </div>
          <input type="number" id="letOff" value="80" min="65" max="90" step="1" style="flex:1;">
        </div> 
        <!---String Weight-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="stringWt">String add-ons gr</label>
            <button type="button" onclick="showStringAddonsPopup()" class="info-btn" title="About String Add-ons">ⓘ</button>
          </div>
          <input type="number" id="stringWt" value="20" min="0" step="0.5" style="flex:1;" data-manual="false">
        </div>

        <!---String Details-->
        <div class="collapsible-trigger" onclick="this.classList.toggle('open'); this.nextElementSibling.style.display = this.classList.contains('open') ? 'block' : 'none';">
          <span>String Details</span>
          <span class="chevron">></span>
        </div>
          <div class="collapsible-content">
          <!-- Checkbox to enable detailed string components -->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <label for="useStringDetails">Use detailed components</label>
            <input type="checkbox" id="useStringDetails" onchange="toggleStringDetailsMode()">
          </div>

          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="peepWt">Peep weight gr</label>
              <button type="button" onclick="showPeepWtPopup()" class="info-btn" title="About Peep Weight">ⓘ</button>
            </div>
            <input type="number" id="peepWt" value="0" step="0.5" style="flex:1;">
          </div>
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="dloopWt">D-loop gr</label>
              <button type="button" onclick="showDloopWtPopup()" class="info-btn" title="About D-loop Weight">ⓘ</button>
            </div>
            <input type="number" id="dloopWt" value="0" step="0.5" style="flex:1;">
          </div>
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="kisserWt">Kisser gr</label>
              <button type="button" onclick="showKisserWtPopup()" class="info-btn" title="About Kisser Weight">ⓘ</button>
            </div>
            <input type="number" id="kisserWt" value="0" step="0.5" style="flex:1;">
          </div>
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="silencerWt">Silencers gr</label>
              <button type="button" onclick="showSilencerWtPopup()" class="info-btn" title="About Silencers Weight">ⓘ</button>
            </div>
            <input type="number" id="silencerWt" value="0" step="0.5" style="flex:1;">
          </div>
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="nockWt">Nock weight gr</label>
              <button type="button" onclick="showNockWtPopup()" class="info-btn" title="About Nock Weight">ⓘ</button>
            </div>
            <input type="number" id="nockWt" value="0" step="0.5" style="flex:1;">
          </div>
          <!-- New total display -->
          <div style="margin-top:1rem; padding:0.75rem; background:var(--border); border-radius:8px; text-align:center;">
            <strong>Total String Add-ons: <span id="stringAddonsTotal">0</span> gr</strong>
            <p style="font-size:0.85rem; color:var(--light); margin-top:0.5rem;">
              Auto-calculated from details above. Edit main field to override.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Sight Pin Zeros Card - Collapsible on all devices -->
    <div class="card" id="sightCard">
      <div class="collapsible-trigger" onclick="this.classList.toggle('open')">
        <span>Sight Pin Zeros</span>
        <span class="chevron">></span>
      </div>
      <div class="collapsible-content">
        <!-- Number of Pins with info icon next to label -->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="pinCount">Number of Pins</label>
            <button type="button" onclick="showSightPinsPopup()" class="info-btn" title="About Sight Pin Zeros">ⓘ</button>
          </div>
          <select id="pinCount" style="flex:1;">
            <option value="0">No Pins / Instinctive</option>
            <option value="1">1-pin (Slider or Target)</option>
            <option value="2">2-pin</option>
            <option value="3" selected>3-pin</option>
            <option value="4">4-pin</option>
            <option value="5">5-pin</option>
          </select>
        </div>

        <!-- Dynamic pin zero inputs -->
        <div id="pinInputs" style="margin-top:1rem; display:grid; gap:0.75rem;">
          <!-- JS fills this -->
        </div>

        <p style="font-size:0.9rem; color:var(--light); margin-top:0.75rem;">
          Set exact zero yardage for each pin — common for fixed pins or slider sights.
        </p>
      </div>
    </div>

    <!---ARROW INPUTS-->
    <div class="card" id="arrowCard">
      <div class="collapsible-trigger" onclick="this.classList.toggle('open')">
        <span>Arrow Details</span>
        <span class="chevron">></span>
      </div>
      <div class="collapsible-content">
        <!---Arrow Name-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="arrowName">Name</label>
            <button type="button" onclick="showArrowNamePopup()" class="info-btn" title="About Arrow Name">ⓘ</button>
          </div>
          <input type="text" id="arrowName" placeholder="Victory VAP TKO" style="flex:1;">
        </div>        
        <!---Arrow Spine-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="spine">Spine</label>
            <button type="button" onclick="showSpinePopup()" class="info-btn" title="About Spine">ⓘ</button>
          </div>
          <input type="number" id="spine" value="300" min="100" max="600" step="10" style="flex:1;">
        </div>
        <!---Arrow Diameter-->       
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="arrowDia">Diameter</label>
            <button type="button" onclick="showArrowDiaPopup()" class="info-btn" title="About Arrow Diameter">ⓘ</button>
          </div>
          <select id="arrowDia" style="flex:1;">
            <option value="standard">Standard (~6.5mm / .246")</option>
            <option value="small">Small (~5mm / .204")</option>
            <option value="micro" selected>Micro (~4mm / .166")</option>
          </select>
        </div>
        <!---Arrow Length-->
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="arrowLen">Length in</label>
            <button type="button" onclick="showArrowLenPopup()" class="info-btn" title="About Arrow Length">ⓘ</button>
          </div>
          <input type="number" id="arrowLen" value="28.5" min="24" max="34" step="0.1" style="flex:1;">
        </div>        
        <!---Total Weight-->        
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="totalWt">Total weight gr</label>
            <button type="button" onclick="showTotalWtPopup()" class="info-btn" title="About Total Arrow Weight">ⓘ</button>
          </div>
          <input type="number" id="totalWt" value="495" min="200" max="1000" step="0.5" style="flex:1;" data-manual="false">        </div>        
        <!---Point Weight-->           
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="pointWt">Point weight gr</label>
            <button type="button" onclick="showPointWtPopup()" class="info-btn" title="About Point Weight">ⓘ</button>
          </div>
          <input type="number" id="pointWt" value="125" min="50" max="300" step="5" style="flex:1;">
        </div>        
        
        <!---Balance Point-->          
        <div class="input-row" style="align-items:center; gap:0.5rem;">
          <div style="display:flex; align-items:center; gap:0.4rem;">
            <label for="balancePt">Balance point in</label>
            <button type="button" onclick="showBalancePtPopup()" class="info-btn" title="About Balance Point">ⓘ</button>
          </div>
          <input type="number" id="balancePt" value="17.2" min="10" max="30" step="0.05" style="flex:1;">
        </div>        
        
        <!---Components-->    
        <div class="collapsible-trigger" onclick="this.classList.toggle('open'); this.nextElementSibling.style.display = this.classList.contains('open') ? 'block' : 'none';">
          <span>Component Details</span>
          <span class="chevron">></span>
        </div>

        <div class="collapsible-content">
          <!-- New: Bare Shaft Weight -->

          <!-- Checkbox to enable detailed arrow components -->
          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <label for="useArrowDetails">Use detailed components</label>
            <input type="checkbox" id="useArrowDetails" onchange="toggleArrowDetailsMode()">
          </div>

          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="bareShaftWt">Bare shaft weight gr</label>
              <button type="button" onclick="showBareShaftWtPopup()" class="info-btn" title="About Bare Shaft Weight">ⓘ</button>
            </div>
            <input type="number" id="bareShaftWt" value="0" min="0" step="0.5" style="flex:1;">
          </div>

          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="insertWt">Insert/Outsert gr</label>
              <button type="button" onclick="showInsertWtPopup()" class="info-btn" title="About Insert/Outsert">ⓘ</button>
            </div>
            <input type="number" id="insertWt" value="0" step="0.5" style="flex:1;">
          </div>

          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="wrapWt">Wrap gr</label>
              <button type="button" onclick="showWrapWtPopup()" class="info-btn" title="About Wrap">ⓘ</button>
            </div>
            <input type="number" id="wrapWt" value="0" step="0.5" style="flex:1;">
          </div>

          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="vaneWt">Vane weight (each) gr</label>
              <button type="button" onclick="showVaneWtPopup()" class="info-btn" title="About Vane Weight">ⓘ</button>
            </div>
            <input type="number" id="vaneWt" value="0" step="0.1" style="flex:1;">
          </div>

          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="vaneCount">Vane count</label>
              <button type="button" onclick="showVaneCountPopup()" class="info-btn" title="About Vane Count">ⓘ</button>
            </div>
            <input type="number" id="vaneCount" value="0" min="0" max="6" style="flex:1;">
          </div>

          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="vaneHeight">Vane Height (in)</label>
              <button type="button" onclick="showVaneHeightPopup()" class="info-btn" title="About Vane Height">ⓘ</button>
            </div>
            <input type="number" id="vaneHeight" value="0.5" min="0.2" max="0.8" step="0.05" style="flex:1;">
          </div>

          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="vaneHelical">Helical / Offset</label>
              <button type="button" onclick="showVaneHelicalPopup()" class="info-btn" title="About Helical/Offset">ⓘ</button>
            </div>
            <select id="vaneHelical" style="flex:1;">
              <option value="straight">Straight</option>
              <option value="slight">Slight Offset</option>
              <option value="moderate">Moderate Offset</option>
              <option value="high">High Offset / Helical</option>
              <option value="max" selected>Max Helical</option>
            </select>
          </div>

          <div class="input-row" style="align-items:center; gap:0.5rem;">
            <div style="display:flex; align-items:center; gap:0.4rem;">
              <label for="glueWt">Glue / Pin gr</label>
              <button type="button" onclick="showGlueWtPopup()" class="info-btn" title="About Glue/Pin">ⓘ</button>
            </div>
            <input type="number" id="glueWt" value="0" step="0.5" style="flex:1;">
          </div>
          <!-- Arrow Components Total Display -->
          <div style="margin-top:1rem; padding:0.75rem; background:var(--border); border-radius:8px; text-align:center;">
          <strong>Total Arrow Weight: <span id="arrowComponentsTotal">0</span> gr</strong>
          <p style="font-size:0.85rem; color:var(--light); margin-top:0.5rem;">
            Auto-calculated from components. Edit main Total Weight field to override.
          </p>
        </div>
        </div>
      </div>
    </div>
  </div>

  <!--OUTPUT COLUMN-->
  <div id="outputs-column">
    <div class="card">
      <h2>Live Settings</h2>
      <div style="margin:1.2rem 0;">
        <div style="display:flex; align-items:center; gap:0.75rem; margin-bottom:0.6rem;">
          <label style="font-weight:600; margin:0;">Actual Speed (fps)</label>
          <button onclick="recalculateAndShowMath()" style="background:none;border:none;cursor:pointer;font-size:1.3rem;color:var(--primary);padding:0;" title="Recalculate and show estimate">Calculate</button>
        </div>
        <div style="display:flex; align-items:center; gap:1rem;">
          <input type="range" id="fpsSlider" min="150" max="400" value="278" step="1" style="background-size: 12.5% 6px;">
          <input type="number" id="fpsInput" value="278" min="150" max="400" style="width:80px; padding:0.45rem; text-align:center; font-weight:600; font-size:1rem;">
        </div>
      </div>
      <div style="margin:1.2rem 0;">
        <label style="display:block; margin-bottom:0.4rem; font-weight:600;">Crosswind (mph)</label>
        <div style="display:flex; align-items:center; gap:1rem;">
          <input type="range" id="windSlider" min="0" max="40" value="0" step="0.1" style="background-size: 12.5% 6px;">
          <input type="number" id="windInput" value="0" min="0" max="40" step="0.1" style="width:70px; padding:0.45rem; text-align:center; font-weight:600; font-size:1rem;">
        </div>
      </div>
      <div style="margin:1.2rem 0;">
        <label style="display:block; margin-bottom:0.4rem; font-weight:600;">Range (yards)</label>
        <div style="display:flex; align-items:center; gap:1rem;">
          <input type="range" id="rangeSlider" min="5" max="150" value="0" step="1" style="background-size: 12.5% 6px;">
          <input type="number" id="rangeInput" value="0" min="5" max="150" style="width:70px; padding:0.45rem; text-align:center; font-weight:600; font-size:1rem;">
        </div>
      </div>
    </div>

    <!-- Effective Draw Weight Card -->
    <div class="card">
      <h2 style="display:flex; align-items:center; gap:0.75rem;">
        Effective Draw Weight
        <button onclick="showEffectiveLoadPopup()" class="info-btn" title="Explain Effective Draw Weight">ⓘ</button>
      </h2>
      <div class="stats-list">
        <!-- Input Draw Weight -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <span class="effective-dw-title">Input Draw Wt.</span>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-fill" id="inputDwFill" style="width:50%; background:var(--primary);"></div>
                  <div class="bar-marker" id="inputDwMarker" style="left:50%;"></div>
                </div>
                <span class="moving-value" id="inputDwValue">70 lb</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Calculated Effective Draw Weight -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <span class="effective-dw-title">Effective Load</span>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-fill" id="effectiveLoadFill" style="width:50%; background:var(--success);"></div>
                  <div class="bar-marker" id="effectiveLoadMarker" style="left:50%;"></div>
                </div>
                <span class="moving-value" id="effectiveLoadValue">80 lb</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Game Effectiveness card -->
    <div class="card">
      <h2 style="display:flex; align-items:center; gap:0.75rem;">
        Game Effectiveness @ <span id="gameDist">50</span> yd
        <button onclick="showGameMathPopup()" style="background:none;border:none;cursor:pointer;font-size:1.3rem;color:var(--primary);padding:0;" title="Show math breakdown">ⓘ</button>
      </h2>
      <div style="overflow-x:auto;">
        <table class="game-table">
          <thead>
            <tr>
              <th>Class</th>
              <th>KE Min (ft·lbs)</th>
              <th>Mom Min (slug·ft/s)</th>
              <th>Impact KE (ft·lbs)</th>
              <th>Impact Mom (slug·ft/s)</th>
              <th>Result</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Small Game</td>
              <td>15+</td>
              <td>0.20+</td>
              <td id="smallKE">-</td>
              <td id="smallMom">-</td>
              <td id="smallRes" class="send">Send it</td>
            </tr>
            <tr>
              <td>Deer / Antelope</td>
              <td>25+</td>
              <td>0.30+</td>
              <td id="deerKE">-</td>
              <td id="deerMom">-</td>
              <td id="deerRes" class="send">Send it</td>
            </tr>
            <tr>
              <td>Elk / Large Game</td>
              <td>42+</td>
              <td>0.45+</td>
              <td id="elkKE">-</td>
              <td id="elkMom">-</td>
              <td id="elkRes" class="send">Send it</td>
            </tr>
            <tr>
              <td>Toughest Game</td>
              <td>65+</td>
              <td>0.60+</td>
              <td id="mooseKE">-</td>
              <td id="mooseMom">-</td>
              <td id="mooseRes" class="marginal">Marginal</td>
            </tr>
          </tbody>
        </table>
      </div>
      <p style="margin-top:0.75rem;font-size:0.9rem;color:var(--light);text-align:center;">
        Based on kinetic energy and momentum at impact. Broadhead type and shot placement matter!
      </p>
    </div>
    <!-- Quick Stats – Final Polished Version -->
    <div class="card">
      <h2>Quick Stats</h2>
      <div class="stats-list">
        <!-- FOC -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>FOC %</strong>
              <button onclick="showFocPopup()" class="info-btn" title="Explain FOC">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-marker" id="focMarker" style="left:50%;"></div>
                  <div class="sweet-spot"></div>
                </div>
                <div class="bar-labels">
                  <span>tail heavy</span>
                  <span>balanced</span>
                  <span>tip heavy</span>
                </div>
                <span class="moving-value" id="focValue">0.0%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- GPP -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>GPP</strong>
              <button onclick="showGppPopup()" class="info-btn" title="Explain GPP">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-marker" id="gppMarker" style="left:50%;"></div>
                  <div class="gpp-sweet-spot"></div>
                </div>
                <div class="bar-labels">
                  <span>light</span>
                  <span>balanced</span>
                  <span>heavy</span>
                </div>
                <span class="moving-value" id="gppValue">0.0 gr</span>
              </div>
            </div>
          </div>
        </div>

        <!-- GPI -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>GPI</strong>
              <button onclick="showGpiPopup()" class="info-btn" title="Explain GPI">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-marker" id="gpiMarker" style="left:50%;"></div>
                  <div class="gpi-sweet-spot"></div>
                </div>
                <div class="bar-labels">
                  <span>light</span>
                  <span>balanced</span>
                  <span>heavy</span>
                </div>
                <span class="moving-value" id="gpiValue">0.0 gr/in</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Total Wt -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>Total Wt</strong>
              <button onclick="showTotalWtPopup()" class="info-btn" title="Explain Total Weight">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-marker" id="totalWtMarker" style="left:50%;"></div>
                  <div class="totalwt-sweet-spot"></div>
                </div>
                <div class="bar-labels">
                  <span>light</span>
                  <span>medium</span>
                  <span>heavy</span>
                </div>
                <span class="moving-value" id="totalWtValue">0 gr</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Stiffness -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>Stiffness</strong>
              <button onclick="showStiffnessPopup()" class="info-btn" title="Explain Stiffness">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-marker" id="stiffnessMarker" style="left:50%;"></div>
                  <div class="stiffness-sweet-spot"></div>
                </div>
                <div class="bar-labels">
                  <span>stiff</span>
                  <span>good</span>
                  <span>weak</span>
                </div>
                <span class="moving-value" id="stiffnessValue">300</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Flatness -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>Flatness</strong>
              <button onclick="showFlatnessPopup()" class="info-btn" title="Explain Flatness">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-marker" id="flatnessMarker" style="left:50%;"></div>
                  <div class="flatness-sweet-spot"></div>
                </div>
                <div class="bar-labels">
                  <span>curved</span>
                  <span>flat</span>
                  <span>very flat</span>
                </div>
                <span class="moving-value" id="flatnessValue">0.0 ft</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Group Stability -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>Stability</strong>
              <button onclick="showGroupStabilityPopup()" class="info-btn" title="Explain Group Stability">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-marker" id="groupStabilityMarker" style="left:50%;"></div>
                  <div class="group-stability-sweet-spot"></div>
                </div>
                <div class="bar-labels">
                  <span>0</span>
                  <span>1</span>
                  <span>2</span>
                  <span>3</span>
                </div>
                <span class="moving-value" id="groupStabilityValue">0/3</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- New Summary Cards Row -->
    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:1rem; margin-bottom:1.5rem;">
      <!-- Peak Height Card -->
      <div class="card">
        <h2 style="display:flex; align-items:center; gap:0.75rem; font-size:1.3rem;">
          Peak Height
          <button onclick="showPeakHeightPopup()" class="info-btn" title="Explain Peak Height">ⓘ</button>
        </h2>
        <p style="font-size:1.4rem; font-weight:700; margin:0.75rem 0;">
          <span id="peakHeightFt">0.0</span> ft / <span id="peakHeightIn">0.0</span> in
          <br>at <span id="peakDistanceYd">0</span> yd
        </p>
        <p style="font-size:0.9rem; color:var(--light);">
          Max height above launch line — great for clearing brush or blind windows.
        </p>
      </div>

      <!-- Downrange Drop Card -->
      <div class="card">
        <h2 style="display:flex; align-items:center; gap:0.75rem; font-size:1.3rem;">
          Downrange Drop
          <button onclick="showDropPopup()" class="info-btn" title="Explain Downrange Drop">ⓘ</button>
        </h2>
        <p style="font-size:1.4rem; font-weight:700; margin:0.75rem 0;">
          <span id="dropFt">0.0</span> ft / <span id="dropIn">0.0</span> in
          <br>at <span id="dropDistanceYd">0</span> yd
        </p>
        <p style="font-size:0.9rem; color:var(--light);">
          How far below line of sight — affects pin gaps and holdover.
        </p>
      </div>

      <!-- Flight Time Card -->
      <div class="card">
        <h2 style="display:flex; align-items:center; gap:0.75rem; font-size:1.3rem;">
          Flight Time
          <button onclick="showFlightTimePopup()" class="info-btn" title="Explain Flight Time">ⓘ</button>
        </h2>
        <p style="font-size:1.4rem; font-weight:700; margin:0.75rem 0;">
          <span id="flightTimeSec">0.000</span> sec
          <br>to <span id="flightDistanceYd">0</span> yd
        </p>
        <p style="font-size:0.9rem; color:var(--light);">
          Animal reaction window — under 0.2 s is very fast.
        </p>
      </div>
    </div>

    <!-- Build Summary Table (collapsible) -->
    <div class="card collapsible-mobile" id="summaryCard">
      <div class="collapsible-trigger" onclick="this.classList.toggle('open')">
        <span>Build Summary & Export</span>
        <span class="chevron">></span>
      </div>
      <div class="collapsible-content"> <!-- ← changed from card-content -->
        <div style="margin-bottom:1rem;">
          <button id="copyCsvBtn" class="secondary">Copy as CSV</button>
        </div>
        <div style="overflow-x:auto;">
          <table class="game-table" id="summaryTable">
            <tbody>
              <!-- Rows will be filled by JS -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="mobile-only-trigger" onclick="this.parentElement.classList.toggle('open')">
        <span>Details</span>
        <span class="chevron">></span>
      </div>
    </div>
  </div>
</div>
<div id="fpsMathModal" class="info-overlay">
  <div class="info-panel" style="max-width:500px;">
    <button class="info-close" onclick="closeFpsMath()">×</button>
    <h2>FPS Estimate Breakdown</h2>
    <div id="fpsMathPopupContent" style="font-size:0.95rem;line-height:1.5;">
      Fill in bow details to see the estimate.
    </div>
  </div>
</div>
<!-- Game Effectiveness Math Popup Modal -->
<div id="gameMathModal" class="info-overlay">
  <div class="info-panel" style="max-width:600px;">
    <button class="info-close" onclick="closeGameMath()">×</button>
    <h2>Math Breakdown</h2>
    <div id="gameMathContent" style="font-size:0.95rem;line-height:1.5;">
      <!-- Filled by JS -->
    </div>
  </div>
</div>
<div id="aiModal" class="info-overlay">
  <div class="info-panel">
    <button class="info-close" onclick="closeModal()">×</button>
    <h2>AI Arrow Advisor</h2>
    <div id="chatHist" style="max-height:300px;overflow-y:auto;margin-bottom:1rem;padding:0.5rem;background:#00000004;border-radius:8px;"></div>
    <div class="flex">
      <input id="aiIn" type="text" placeholder="Ask about arrows, broadheads, tuning..." style="flex:1;">
      <button onclick="sendAi()" class="btn-small">Send</button>
    </div>
  </div>
</div>

<!---SCRIPTS-->
<script>
const $ = id => document.getElementById(id);
let fpsWasRecalculated = false;

/*Bow Model info icon*/
function showBowModelPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Bow Model</strong></p>
    <p>Enter your bow's make and model (e.g., Hoyt RX-9, Mathews Lift, PSE Supra).</p>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Build naming suggestions</li>
      <li>Future pro sample matching</li>
      <li>Personal reference</li>
    </ul>
    <p>No impact on calculations — purely for your records.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Bow Type info icon*/
function showBowTypePopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Bow Type</strong></p>
    <p>Select your bow style — affects future calculations.</p>
    <hr>
    <p><strong>Compound</strong>: Modern cam system — highest efficiency, used for most hunting/target bows.</p>
    <p><strong>Recurve</strong>: Traditional limbs — lower efficiency, quieter, used in Olympic/traditional archery.</p>
    <p><strong>Longbow</strong>: Classic straight limbs — lowest efficiency, most traditional.</p>
    <hr>
    <p>Currently used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Future speed estimate adjustments</li>
      <li>Sample build filtering</li>
      <li>Personal reference</li>
    </ul>
    <p>No direct impact yet — coming in future updates.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Bow Type Update Pins*/
function updatePinCountForTraditional() {
  const bowType = $('bowType').value;
  const pinCountSelect = $('pinCount');

  if (bowType === 'recurve' || bowType === 'longbow') {
    pinCountSelect.value = '0'; // No Pins / Instinctive
  } else {
    // Optional: reset to 3-pin for compound if desired
    if (pinCountSelect.value === '0') {
      pinCountSelect.value = '3';
    }
  }

  // Rebuild pin inputs to reflect change
  calculateEverything();
}

/*IBO FPS info icon*/
function showIboPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>IBO Speed (fps)</strong></p>
    <p>Manufacturer's advertised speed at standard specs:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>70 lb draw weight</li>
      <li>30" draw length</li>
      <li>350 grain arrow</li>
      <li>No string add-ons</li>
    </ul>
    <hr>
    <p>Used to estimate your real-world speed when you fill bow/arrow details.</p>
    <p>Leave blank or adjust if you know your bow's actual IBO rating.</p>
    <p>Higher IBO = faster potential — but real speed depends on your setup.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Brace Height info icon*/
function showBraceHeightPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Brace Height (inches)</strong></p>
    <p>Distance from bow grip throat to string at rest.</p>
    <hr>
    <p><strong>Typical Range:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>5–6 in: Faster, less forgiving (speed bows)</li>
      <li>6–7 in: Balanced speed & forgiveness (most hunting bows)</li>
      <li>7+ in: Slower, very forgiving (target/long-draw bows)</li>
    </ul>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Future speed estimate tuning</li>
      <li>Build comparison & reference</li>
    </ul>
    <p>Shorter brace = more speed but harsher; longer = smoother & more forgiving.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Cam System info icon*/
function showCamTypePopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Cam System</strong></p>
    <p>Type of cam on your compound bow — affects efficiency, speed, and tuning.</p>
    <hr>
    <p><strong>Hybrid / Binary</strong>: Most efficient — smooth draw, high speed, level nock travel.</p>
    <p>Examples: Hoyt HBX Xact, Bowtech DeadLock, Mathews Switchweight, PSE Evolve, Elite Enkore.</p>
    <hr>
    <p><strong>Single Cam</strong>: Simple, quiet, easy tuning — slightly less efficient, very reliable.</p>
    <p>Examples: Older Mathews SoloCam, Bear Legit, Diamond Edge, some entry-level bows.</p>
    <hr>
    <p><strong>Twin / Dual Cam</strong>: Fast and aggressive — high speed, but harder to tune and more maintenance.</p>
    <p>Examples: Classic PSE models, some high-performance speed bows, older aggressive designs.</p>
    <hr>
    <p><strong>N/A</strong>: For recurve/longbow (no cams).</p>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Future speed estimate fine-tuning</li>
      <li>Build comparison & reference</li>
    </ul>
    <p>Hybrid/binary cams dominate modern hunting bows for best performance and forgiveness.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Draw Weight info icon*/
function showDrawWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Draw Weight (lb)</strong></p>
    <p>Peak weight your bow is set to — the force needed to pull it back.</p>
    <hr>
    <p><strong>Typical Ranges:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>40–60 lb: Lighter — easier to draw, common for women/youth or long holds.</li>
      <li>60–70 lb: Standard hunting — good balance of speed and penetration.</li>
      <li>70–80+ lb: Heavy — max speed/momentum, popular for big game (elk, bear).</li>
    </ul>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>FPS estimate (higher = faster)</li>
      <li>Effective Load & spine recommendation</li>
      <li>GPP calculation</li>
    </ul>
    <p>Higher draw weight = more speed & penetration, but harder to shoot accurately.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Draw Length info icon*/
function showDrawLenPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Draw Length (inches)</strong></p>
    <p>Distance from nock point to grip pivot point (or anchor) at full draw.</p>
    <hr>
    <p><strong>Typical Ranges (All Bow Types):</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Short (24–27 in)</strong>: Youth, women, shorter adults, or compact styles (common in hunting recurves/longbows).</li>
      <li><strong>Average (27–29 in)</strong>: Most adult archers — "standard" rating point (many bows rated at 28 in).</li>
      <li><strong>Long (30–32+ in)</strong>: Taller archers, long arms, or deep anchors (e.g., target recurves or warbow-style).</li>
    </ul>
    <hr>
    <p><strong>Compound Bows</strong>: Fixed by cam/draw stop — precise and repeatable.</p>
    <p><strong>Recurve/Longbow</strong>: More variable due to form/anchor — often measured to corner of mouth or cheek.</p>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>FPS estimate (longer = more energy = faster)</li>
      <li>Effective Load & spine recommendation</li>
      <li>Arrow tuning & stability</li>
    </ul>
    <p>Longer draw = more speed & power, but can reduce accuracy if form suffers.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}


/*Let Off % info icon*/
function showLetOffPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Let-off %</strong></p>
    <p>Percentage of peak draw weight you hold at full draw (valley).</p>
    <hr>
    <p><strong>Typical Ranges:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>65–75%: Aggressive cams — faster, harder to hold (speed bows)</li>
      <li>75–85%: Balanced — most hunting bows (smooth & fast)</li>
      <li>85–90+%: High let-off — easier to hold, common in target/hunting hybrids</li>
    </ul>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Future speed estimate fine-tuning (higher let-off = slight speed gain)</li>
      <li>Build comparison & reference</li>
    </ul>
    <p>Higher let-off = easier to hold steady for longer, great for hunting or target.</p>
    <p><em>Recurve/Longbow: N/A (no let-off)</em></p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*String weight*/
function showStringAddonsPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>String Add-ons (grains)</strong></p>
    <p>Total extra weight on the string (peep, D-loop, kisser, silencers, nock).</p>
    <hr>
    <p>Typical total: 20–40 gr (20 gr is a good average for basic setups).</p>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>FPS estimate — every ~10 gr slows ~1 fps</li>
      <li>Real-world speed accuracy</li>
    </ul>
    <p>Fill individual fields below for auto-total, or enter total here directly.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* String add-on checkbox*/
function toggleStringDetailsMode() {
  const checkbox = $('useStringDetails');
  const checked = checkbox?.checked ?? false;

  const detailIds = ['peepWt', 'dloopWt', 'kisserWt', 'silencerWt', 'nockWt'];
  const mainInput = $('stringWt');

  detailIds.forEach(id => {
    const input = $(id);
    if (input) {
      input.readOnly = !checked;
      input.style.backgroundColor = checked ? '' : 'var(--border)';
      input.style.opacity = checked ? '' : '0.6';
    }
  });

  if (mainInput) {
    mainInput.readOnly = checked;
    mainInput.style.backgroundColor = checked ? 'var(--border)' : '';
    mainInput.style.opacity = checked ? '0.6' : '';
  }

  calculateEverything(); // update total and display
}

/*Peep  weight info icon*/
function showPeepWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Peep Weight (grains)</strong></p>
    <p>Weight of your peep sight.</p>
    <p>Typical: 8–25 gr (standard ~12–15 gr, large/ verifier ~20+ gr).</p>
    <p>Adds to string weight — slows speed slightly but improves aiming.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*DLoop  weight info icon*/
function showDloopWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>D-loop Weight (grains)</strong></p>
    <p>Weight of your D-loop material + nocking point.</p>
    <p>Typical: 5–15 gr (metal nock ~10 gr, tied string ~5 gr).</p>
    <p>Protects string, improves nock fit — small speed impact.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Kisser  weight info icon*/
function showKisserWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Kisser Weight (grains)</strong></p>
    <p>Weight of kisser button (anchor reference).</p>
    <p>Typical: 3–8 gr.</p>
    <p>Helps consistent anchor — minimal speed loss.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Silencer weight info icon*/
function showSilencerWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Silencers Weight (grains)</strong></p>
    <p>Weight of string silencers (cat whiskers, wool puffs, etc.).</p>
    <p>Typical: 10–30 gr total (pair).</p>
    <p>Quiets bow — noticeable speed reduction if heavy.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Nock weight info icon*/
function showNockWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Nock Weight (grains)</strong></p>
    <p>Extra weight from brass nocking points or tie-on nocks.</p>
    <p>Typical: 5–15 gr (brass ~10 gr).</p>
    <p>Small impact on speed, improves nock fit.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Sight pins info icon*/
function showSightPinsPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Sight Pin Zeros</strong></p>
    <p>Set the zero yardage for each pin on your bow sight.</p>
    <hr>
    <p><strong>Compound Bows</strong>: Most use multi-pin sights (e.g., 20/30/40/50 yd) or single-pin sliders.</p>
    <p><strong>Target Recurve</strong>: Usually a single adjustable pin (aperture/dot).</p>
    <p><strong>Traditional Recurve / Longbow</strong>: Typically <strong>no pins</strong> — instinctive, gap shooting, or string walking. Select "No Pins" for pure traditional.</p>
    <hr>
    <p><strong>How to Use:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Select number of pins (0 for instinctive)</li>
      <li>Set exact zero for each (e.g., 20/30/50 yd for skipped pins)</li>
      <li>Simulates moving sight housing or dialing a slider</li>
    </ul>
    <p>Used for build reference and future pin gap/drop analysis.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Arrow Name info icon*/
function showArrowNamePopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Arrow Name</strong></p>
    <p>Enter the make and model of your arrow shaft.</p>
    <p>Examples:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Victory VAP TKO</li>
      <li>Easton Axis 5mm</li>
      <li>Gold Tip Hunter XT</li>
      <li>Black Eagle Outlaw</li>
    </ul>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Build naming suggestions</li>
      <li>Personal reference & organization</li>
      <li>Future sample matching</li>
    </ul>
    <p>No impact on calculations — just for your records.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Arrow Spine info icon*/
function showSpinePopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Spine (deflection rating)</strong></p>
    <p>Arrow shaft stiffness — lower number = stiffer shaft.</p>
    <hr>
    <p><strong>Common Ranges:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>600–400: Light draw / long arrows — very flexible</li>
      <li>400–300: Standard hunting (60–70 lb) — most popular</li>
      <li>300–200: Heavy draw (70–80+ lb) — stiff for speed & penetration</li>
      <li>200 and below: Extreme setups or micro-diameter shafts</li>
    </ul>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Stiffness / Forgiveness rating (matches your effective load)</li>
      <li>Build comparison & tuning reference</li>
    </ul>
    <p>App recommends "Good" range based on your draw weight, arrow length, and point weight.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Arrow diameter*/
function showArrowDiaPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Arrow Diameter</strong></p>
    <p>Outside diameter of the shaft — affects wind drift and penetration.</p>
    <hr>
    <p><strong>Standard (~6.5mm / .246")</strong>: Most common — easiest components, durable.</p>
    <p><strong>Small (~5mm / .204")</strong>: Balanced — good wind resistance, standard components.</p>
    <p><strong>Micro (~4mm / .166")</strong>: Best wind drift & penetration — specialized components.</p>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Future wind drift calculation</li>
      <li>Build comparison & reference</li>
    </ul>
    <p>Smaller diameter = less wind drift + better penetration, but trickier components.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Arrow Length info icon*/
function showArrowLenPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Arrow Length (inches)</strong></p>
    <p>Carbon-to-carbon length (from nock throat to end of shaft, not including point).</p>
    <hr>
    <p><strong>Typical Ranges:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>26–28 in: Shorter draw or compact hunting setups</li>
      <li>28–30 in: Most common — average adult male</li>
      <li>30+ in: Long draw lengths or target arrows</li>
    </ul>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>FOC calculation (longer = easier high FOC)</li>
      <li>GPI (grains per inch) calculation</li>
      <li>Stiffness recommendation (longer arrows need stiffer spine)</li>
      <li>Speed estimate (longer = slightly slower)</li>
    </ul>
    <p>Longer arrows = more stable, higher FOC, but slightly less speed.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Arrow Total Weight info icon*/
function showTotalWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Total Arrow Weight (grains)</strong></p>
    <p>Complete arrow weight including shaft, point, insert, nock, fletching, wrap, glue — everything.</p>
    <hr>
    <p><strong>Typical Hunting Ranges:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>350–450 gr: Light/fast — flatter trajectory, common for speed setups</li>
      <li>450–550 gr: Heavy hunting — best penetration/momentum (most popular)</li>
      <li>550+ gr: Extreme heavy — elk/moose or traditional bows</li>
    </ul>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>FOC, GPP, GPI calculations</li>
      <li>Speed estimate (heavier = slower)</li>
      <li>Game Effectiveness (KE & momentum)</li>
      <li>Downrange drop & flight time</li>
    </ul>
    <p>Heavier arrows = more penetration & quieter, but slower and more drop.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Point Weight info icon*/
function showPointWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Point Weight (grains)</strong></p>
    <p>Total weight of broadhead or field point (including insert if used).</p>
    <hr>
    <p><strong>Common Hunting Weights:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>85–100 gr: Light/fast — flatter trajectory</li>
      <li>100–125 gr: Most popular — balanced speed & penetration</li>
      <li>125–150+ gr: Heavy — max momentum for big game</li>
    </ul>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>FOC calculation (heavier point = higher FOC)</li>
      <li>Total arrow weight & GPP</li>
      <li>Stiffness recommendation (heavier point weakens dynamic spine)</li>
      <li>Speed estimate (heavier = slower)</li>
    </ul>
    <p>Heavier point = more FOC & penetration, but slightly slower and more drop.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Balance Point info icon*/
function showBalancePtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Balance Point (inches)</strong></p>
    <p>Distance from nock throat to the arrow's physical balance point (center of gravity).</p>
    <hr>
    <p><strong>How to Measure:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Balance arrow on a finger or edge</li>
      <li>Measure from nock throat to balance point</li>
    </ul>
    <hr>
    <p><strong>Typical Values:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>16–17 in: Lower FOC (lighter point)</li>
      <li>17–18 in: Good FOC (most hunting arrows)</li>
      <li>18+ in: High FOC (heavy point/insert)</li>
    </ul>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Accurate FOC calculation</li>
      <li>Build comparison & tuning reference</li>
    </ul>
    <p>Higher balance point = higher FOC = better stability & penetration.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Checkbox behavior*/
function toggleArrowDetailsMode() {
  const checkbox = $('useArrowDetails');
  const checked = checkbox?.checked ?? false;

  const detailIds = ['bareShaftWt', 'insertWt', 'wrapWt', 'vaneWt', 'vaneCount', 'vaneHeight', 'vaneHelical', 'glueWt'];
  const mainInput = $('totalWt');

  detailIds.forEach(id => {
    const input = $(id);
    if (input) {
      if (id === 'vaneHelical') {
        input.disabled = !checked; // select uses disabled
      } else {
        input.readOnly = !checked;
      }
      input.style.backgroundColor = checked ? '' : 'var(--border)';
      input.style.opacity = checked ? '' : '0.6';
    }
  });

  if (mainInput) {
    mainInput.readOnly = checked;
    mainInput.style.backgroundColor = checked ? 'var(--border)' : '';
    mainInput.style.opacity = checked ? '0.6' : '';
  }

  calculateEverything(); // update total and display
}

/*Bare shaft weight info icon*/
function showBareShaftWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Bare Shaft Weight (grains)</strong></p>
    <p>Weight of the arrow shaft only — no point, insert, nock, or fletching.</p>
    <hr>
    <p>Used for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Future advanced tuning (bare shaft testing)</li>
      <li>Build reference & comparison</li>
    </ul>
    <p>Leave 0 if unknown — not required for current calculations.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Insert/Out  weight info icon*/
function showInsertWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Insert / Outsert Weight (grains)</strong></p>
    <p>Weight of internal insert or external outsert (half-out, ethics, etc.).</p>
    <hr>
    <p>Typical:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Aluminum half-out: 50–80 gr</li>
      <li>Steel/titanium outsert: 75–125 gr</li>
      <li>Ethics insert: ~100 gr</li>
    </ul>
    <p>Adds FOC and strengthens front end — popular for heavy points.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*wrap  weight info icon*/
function showWrapWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Wrap Weight (grains)</strong></p>
    <p>Weight of arrow wrap (vinyl decal under vanes).</p>
    <hr>
    <p>Typical: 6–12 gr total (lighter = thinner material).</p>
    <p>Adds custom look and slight FOC — minimal speed impact.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Vane  weight info icon*/
function showVaneWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Vane Weight (each, grains)</strong></p>
    <p>Weight of one individual vane/fletching.</p>
    <hr>
    <p>Typical:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Low-profile (2"): 5–8 gr each</li>
      <li>Standard (3–4"): 8–12 gr each</li>
      <li>Blazer-style: ~6 gr each</li>
    </ul>
    <p>Multiplied by vane count for total fletching weight.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/* Vane Count info icon*/
function showVaneCountPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Vane Count</strong></p>
    <p>Number of vanes/fletchings on the arrow.</p>
    <hr>
    <p>Common:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>3 vanes: Most popular — stable, common for hunting</li>
      <li>4 vanes: Extra stability — popular for fixed broadheads</li>
      <li>2 vanes: Rare — some target setups</li>
    </ul>
    <p>More vanes = faster stabilization, slightly more weight/drag.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Vane Height info icon*/
function showVaneHeightPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Vane Height (inches)</strong></p>
    <p>Height of the vane from shaft to top edge.</p>
    <hr>
    <p>Typical:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Low-profile (0.4–0.6"): Less wind drift, common for hunting</li>
      <li>Medium (0.7–1"): Balanced — good for broadheads</li>
      <li>High (2"+): Max stabilization — target or heavy broadheads</li>
    </ul>
    <p>Taller = faster arrow correction, more drag/wind effect.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Vane Helical info icon*/
function showVaneHelicalPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Helical / Offset</strong></p>
    <p>Angle of the vanes — causes arrow rotation for better stability and broadhead flight.</p>
    <hr>
    <p><strong>Options Explained:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Straight</strong>: No spin — minimal drag, fastest.</li>
      <li><strong>Slight Offset</strong>: ~1–3° — gentle spin, good for field points.</li>
      <li><strong>Moderate Offset</strong>: ~4–6° — balanced, common for hunting.</li>
      <li><strong>High Offset / Helical</strong>: ~7–10° — strong spin, great for fixed broadheads.</li>
      <li><strong>Max Helical</strong>: 11°+ (Bitzenburger right helical max) — fastest spin, best broadhead stabilization.</li>
    </ul>
    <hr>
    <p><strong>Bitzenburger Users:</strong> Use the dial setting (in degrees) to match above — e.g., 3° = Slight, 6° = Moderate, 11–12° = Max.</p>
    <hr>
    <p><strong>How to Use:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>More helical/offset = faster arrow rotation = better broadhead flight & stability</li>
      <li>Trade-off: slightly more drag = minor speed loss</li>
      <li>Fixed-blade broadheads benefit most from high/max helical</li>
    </ul>
    <p>Most hunters use Moderate to Max for reliable broadhead tuning.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

/*Gllue  weight info icon*/
function showGlueWtPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Glue / Pin Weight (grains)</strong></p>
    <p>Weight of fletching glue, hot melt, or pin nock adhesive.</p>
    <hr>
    <p>Typical: 3–8 gr total.</p>
    <p>Minor contribution — included for maximum accuracy.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

function calculateEstimatedFPS() {
  const ibo = parseFloat($('ibo').value) || 340;
  const drawWt = parseFloat($('drawWt').value) || 70;
  const drawLen = parseFloat($('drawLen').value) || 29;
  const totalWt = parseFloat($('totalWt').value) || 495;
  const peepWt = parseFloat($('peepWt').value) || 8;
  const dloopWt = parseFloat($('dloopWt').value) || 8;
  const kisserWt = parseFloat($('kisserWt').value) || 0;
  const silencerWt = parseFloat($('silencerWt').value) || 12;
  const nockWt = parseFloat($('nockWt').value) || 10;
  const totalStringAddons = peepWt + dloopWt + kisserWt + silencerWt + nockWt;

  const refDrawWt = 70;
  const refDrawLen = 30;
  const refArrowWt = 350;
  const refStringFree = 20;

  let est = ibo;
  est += (drawWt - refDrawWt) * 1.8;
  est += (drawLen - refDrawLen) * 10;
  est -= Math.max(0, (totalWt - refArrowWt) / 5);
  est -= Math.max(0, (totalStringAddons - refStringFree) / 10);
  est *= 0.97;

  const estimated = Math.max(150, Math.round(est * 10) / 10);

  return {
    estimated: estimated,
    breakdown: {
      base: ibo,
      adjDrawWt: (drawWt - refDrawWt) * 1.8,
      adjDrawLen: (drawLen - refDrawLen) * 10,
      adjArrowWt: -Math.max(0, (totalWt - refArrowWt) / 5),
      adjString: -Math.max(0, (totalStringAddons - refStringFree) / 10),
      correction: est * -0.03
    }
  };
}

function showFpsMathPopup() {
  const content = $('fpsMathPopupContent');
  const currentFps = parseFloat($('fpsSlider').value);
  const hasManualFps = !isNaN(currentFps) && currentFps > 0;

  if (hasManualFps) {
    content.innerHTML = `
      <p><strong>Using your chronographed speed:</strong> ${currentFps.toFixed(1)} FPS</p>
      <p style="margin-top:0.75rem;color:var(--light);">
        Manual entry overrides estimate — this is the most accurate!
      </p>
    `;
  } else {
    const est = calculateEstimatedFPS();
    content.innerHTML = `
      <p><strong>Calculated estimate:</strong> ${est.estimated.toFixed(1)} FPS</p>
      <p style="margin-top:0.75rem;color:var(--light);font-size:0.9rem;">
        No manual FPS entered — using estimate.
      </p>
    `;
  }
  $('fpsMathModal').style.display = 'flex';
}

function showEffectiveLoadPopup() {
  // Recalculate everything needed (same as in calculateEverything)
  const drawWt = parseFloat($('drawWt').value) || 70;
  const arrowLen = parseFloat($('arrowLen').value) || 28.5;
  const pointWt = parseFloat($('pointWt').value) || 125;
  const totalWt = parseFloat($('totalWt').value) || 495;

  const lengthFactor = (arrowLen - 28) * 2.5;
  const pointFactor = (pointWt - 100) * 0.15;
  const weightFactor = (totalWt - 400) * 0.05;
  const effectiveLoad = Math.round(drawWt + lengthFactor + pointFactor + weightFactor);

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>Effective Draw Weight Math</strong></p>
    <p>The calculator starts from your real draw weight and adds tuned bumps for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Longer arrows (more leverage on the shaft)</li>
      <li>Heavier points (more load out front)</li>
      <li>Overall finished arrow weight</li>
    </ul>
    <hr>
    <p><strong>Your inputs:</strong></p>
    <p>• Draw weight ≈ ${drawWt.toFixed(1)} lb</p>
    <p>• Arrow length ≈ ${arrowLen.toFixed(2)} in</p>
    <p>• Point weight ≈ ${pointWt} gr</p>
    <p>• Total arrow weight ≈ ${totalWt.toFixed(1)} gr</p>
    <hr>
    <p><strong>Breakdown:</strong></p>
    <p>Base: ${drawWt} lb</p>
    <p>+ Length factor: +${lengthFactor.toFixed(2)}</p>
    <p>+ Point factor: +${pointFactor.toFixed(2)}</p>
    <p>+ Weight factor: +${weightFactor.toFixed(2)}</p>
    <p><strong>Effective load ≈ ${effectiveLoad} lb</strong></p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      This is the "load" the shaft actually feels — used to recommend spine.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function showGameMathPopup() {
  const rangeYd = parseFloat($('rangeSlider').value) || 50;
  const fps = parseFloat($('fpsSlider').value) || 278;
  const totalWt = parseFloat($('totalWt').value) || 495;

  const k = 0.532;
  const retention = Math.exp(- (k * rangeYd) / totalWt);
  const velImpact = Math.round(fps * retention);
  const keImpact = Math.round(totalWt * velImpact * velImpact / 450240);
  const momImpact = parseFloat((totalWt * velImpact / 225400).toFixed(3));

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>Launch Speed:</strong> ${fps} fps</p>
    <p><strong>Arrow Weight:</strong> ${totalWt} gr</p>
    <p><strong>Range:</strong> ${rangeYd} yd</p>
    <hr>
    <p><strong>Velocity Retention Model:</strong></p>
    <p>retention = e^(-k × range / weight)</p>
    <p>k = 0.532 (calibrated for typical hunting arrows)</p>
    <p>Retention = ${retention.toFixed(3)} (${(retention * 100).toFixed(1)}%)</p>
    <p><strong>Impact Velocity:</strong> ${velImpact} fps</p>
    <hr>
    <p><strong>Impact KE:</strong> ${keImpact.toFixed(1)} ft-lbs</p>
    <p>KE = (weight × velocity²) / 450240</p>
    <p>KE = (${totalWt} × ${velImpact}²) / 450240</p>
    <hr>
    <p><strong>Impact Momentum:</strong> ${momImpact.toFixed(3)} slug·ft/s</p>
    <p>Momentum = (weight × velocity) / 225400</p>
    <p>Momentum = (${totalWt} × ${velImpact}) / 225400</p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      <strong>Where do the constants come from?</strong><br>
      • 450240 = 2 × 32.174 × 7000 (converts grain·fps² to ft-lbs)<br>
      • 225400 = 450240 / 2 (for momentum in slug·ft/s)<br>
      • k = 0.532 is calibrated from real-world hunting arrow data (350–500gr arrows, typical shafts/broadheads).<br><br>
      This is an approximation using arrow mass for drag resistance.<br>
      Real-world results vary with arrow diameter, broadhead, fletching, and air density.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function closeGameMath() {
  $('gameMathModal').style.display = 'none';
}

function recalculateAndShowMath() {
  const est = calculateEstimatedFPS();
  const b = est.breakdown;

  $('fpsSlider').value = est.estimated;
  $('fpsInput').value = est.estimated;

  const content = $('fpsMathPopupContent');
  content.innerHTML = `
    <p style="color:var(--success);font-weight:700;">✓ Speed updated to calculated estimate!</p>
    <p><strong>New FPS:</strong> ${est.estimated.toFixed(1)}</p>
    <p style="margin-top:0.75rem;"><strong>Breakdown:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Base IBO: ${b.base.toFixed(0)} FPS</li>
      <li>Draw weight: ${b.adjDrawWt > 0 ? '+' : ''}${b.adjDrawWt.toFixed(1)} FPS</li>
      <li>Draw length: ${b.adjDrawLen > 0 ? '+' : ''}${b.adjDrawLen.toFixed(1)} FPS</li>
      <li>Arrow weight: ${b.adjArrowWt.toFixed(1)} FPS</li>
      <li>String add-ons: ${b.adjString.toFixed(1)} FPS</li>
      <li>Real-world correction: ${b.correction.toFixed(1)} FPS</li>
    </ul>
    <p style="margin-top:0.75rem;color:var(--light);font-size:0.9rem;">
      Your previous value has been replaced with the current estimate.
    </p>
  `;

  $('fpsMathModal').style.display = 'flex';
}

function closeFpsMath() {
  $('fpsMathModal').style.display = 'none';
}

function showFocPopup() {
  const arrowLen = parseFloat($('arrowLen').value) || 28.5;
  const balancePt = parseFloat($('balancePt').value) || 17.2;
  const midPoint = arrowLen / 2;
  const focPercent = ((balancePt - midPoint) / arrowLen) * 100;

  const content = $('gameMathContent'); // reuse modal
  content.innerHTML = `
    <p><strong>FOC (Front of Center) Math</strong></p>
    <p>FOC measures how far the arrow’s balance point sits in front of the midpoint. Higher FOC generally improves broadhead stability and penetration; lower FOC produces flatter trajectories and is more forgiving to shoot.</p>
    <hr>
    <p><strong>Formula:</strong></p>
    <p>FOC = ((Balance Point − Midpoint) ÷ Arrow Length) × 100</p>
    <hr>
    <p><strong>Your inputs:</strong></p>
    <p>• Arrow Length = ${arrowLen.toFixed(2)} in</p>
    <p>• Midpoint = Arrow Length ÷ 2 = ${midPoint.toFixed(2)} in</p>
    <p>• Balance Point = ${balancePt.toFixed(2)} in</p>
    <hr>
    <p><strong>Step-by-step:</strong></p>
    <p>FOC = ((${balancePt.toFixed(2)} − ${midPoint.toFixed(2)}) ÷ ${arrowLen.toFixed(2)}) × 100</p>
    <p>FOC = <strong>${focPercent.toFixed(1)}%</strong></p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      Typical hunting arrows fall between 10–18%. Higher FOC (18%+) is often preferred for fixed-blade broadheads and heavier setups, while moderate FOC (12–16%) gives a good blend of forgiveness and stability.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function showGppPopup() {
  const totalWt = parseFloat($('totalWt').value) || 495;
  const drawWt = parseFloat($('drawWt').value) || 70;
  const gpp = (totalWt / drawWt).toFixed(1);

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>GPP (Grains Per Pound)</strong></p>
    <p>GPP is one of the simplest ways to express how heavy or light your arrow is relative to your bow’s draw weight.</p>
    <p><strong>Formula:</strong> GPP = Total Arrow Weight ÷ Draw Weight</p>
    <p>Your GPP = ${totalWt} gr ÷ ${drawWt} lb = <strong>${gpp}</strong></p>
    <hr>
    <p><strong>Interpretation:</strong></p>
    <p>• Low GPP (≈5–6) → fast, flat, loud, lower momentum</p>
    <p>• Mid GPP (≈6.5–7.5) → balanced speed + penetration (highlighted)</p>
    <p>• High GPP (≈8–10+) → slower, quiet, higher momentum, bow-friendly</p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      GPP also influences velocity retention in this calculator:<br>
      • Lighter arrows (low GPP) lose speed faster downrange.<br>
      • Heavier arrows (high GPP) hold their speed longer.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function showGpiPopup() {
  const totalWt = parseFloat($('totalWt').value) || 495;
  const arrowLen = parseFloat($('arrowLen').value) || 28.5;
  const gpi = (totalWt / arrowLen).toFixed(1);

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>GPI (Grains Per Inch)</strong></p>
    <p>GPI tells you how much of your arrow’s finished weight comes from the shaft itself. It is simply your total arrow weight divided by your arrow length.</p>
    <p><strong>Formula:</strong> GPI = Total Arrow Weight ÷ Arrow Length</p>
    <p>Your GPI = ${totalWt} gr ÷ ${arrowLen.toFixed(1)} in = <strong>${gpi}</strong></p>
    <hr>
    <p>A lower GPI generally means a lighter, faster shaft (often thinner-walled or smaller diameter). A higher GPI usually indicates a heavier, more robust shaft that can boost momentum and stability, especially for broadheads.</p>
    <p>Unlike spine, GPI is not a stiffness rating — it’s purely a mass-per-inch measurement.</p>
    <p>Sweet spot (highlighted): 7–9.5 — good balance of speed and momentum for most hunting setups.</p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      GPI helps inform group stability, velocity retention, and downrange KE/momentum in this calculator.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function showTotalWtPopup() {
  const totalWt = parseFloat($('totalWt').value) || 495; // <-- add this line

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>Total Arrow Weight (TW) Math</strong></p>
    <p>TW is your finished arrow weight in grains — shaft, components, and point all added together. This is the number that drives almost every other output in the app.</p>
    <p><strong>Your build:</strong></p>
    <p>Total Arrow Weight = <strong>${totalWt.toFixed(1)} grains</strong></p>
    <hr>
    <p>This same TW value is reused in:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>GPP (grains per pound)</li>
      <li>GPI (grains per inch)</li>
      <li>Launch KE and Impact KE</li>
      <li>Momentum and Game Effectiveness</li>
      <li>The Arrow Weight Composition bar</li>
    </ul>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      If this number is off, every downstream calculation will be off with it — so TW is the most important value to get as close as possible to your real, finished arrow.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function showStiffnessPopup() {
  const drawWt = parseFloat($('drawWt').value) || 70;
  const arrowLen = parseFloat($('arrowLen').value) || 28.5;
  const pointWt = parseFloat($('pointWt').value) || 125;
  const totalWt = parseFloat($('totalWt').value) || 495;
  const actualSpine = parseFloat($('spine').value) || 300;

  const lengthFactor = (arrowLen - 28) * 2.5;
  const pointFactor = (pointWt - 100) * 0.15;
  const weightFactor = (totalWt - 400) * 0.05;
  const effectiveLoad = Math.round(drawWt + lengthFactor + pointFactor + weightFactor);

  const recommendedCenter = Math.max(200, Math.min(500, 600 - effectiveLoad * 5));
  const spineDiff = actualSpine - recommendedCenter;

  let status = 'Good';
  if (spineDiff > 50) status = 'Weak';
  else if (spineDiff < -50) status = 'Stiff';

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>Stiffness / Forgiveness Math</strong></p>
    <p>This badge compares your actual arrow spine to a recommended spine band built from draw weight, arrow length, point weight, and finished arrow weight — similar in spirit to a modernized Easton-style chart.</p>
    <hr>
    <p><strong>1) Build an “effective draw weight”</strong></p>
    <p>The calculator starts from your real draw weight and adds tuned bumps for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Longer arrows (more leverage on the shaft)</li>
      <li>Heavier points (more load out front)</li>
      <li>Overall finished arrow weight</li>
    </ul>
    <p>Your inputs for this build are:</p>
    <p>• Draw weight ≈ ${drawWt.toFixed(1)} lb</p>
    <p>• Arrow length ≈ ${arrowLen.toFixed(2)} in</p>
    <p>• Point weight ≈ ${pointWt} gr</p>
    <p>• Total arrow weight ≈ ${totalWt.toFixed(1)} gr</p>
    <p>Those are combined into a single load number the shaft “feels”:<br>
    <strong>effective draw weight ≈ ${effectiveLoad} lb</strong></p>
    <hr>
    <p><strong>2) Map effective draw weight → spine band</strong></p>
    <p>That effective load is then mapped to a static spine band — lighter loads want weaker shafts (higher spine numbers), heavier loads want stiffer shafts (lower spine numbers).</p>
    <p>Recommended spine band center ≈ <strong>${recommendedCenter}</strong></p>
    <hr>
    <p><strong>3) Compare your spine to the chart recommendation</strong></p>
    <p>• Your actual spine = ${actualSpine}</p>
    <p>• Recommended center spine = ${recommendedCenter}</p>
    <p>• Difference = ${actualSpine} − ${recommendedCenter} = ${spineDiff}</p>
    <p><strong>Result: ${status}</strong></p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      <strong>Good</strong> — Your actual spine is very close to the recommended number. Tuning should be straightforward.<br>
      <strong>Adjust (Stiff)</strong> — Arrow is too stiff (lower spine number than recommended). Add point weight or move to weaker spine.<br>
      <strong>Adjust (Weak)</strong> — Arrow is too weak (higher spine number than recommended). Shorten arrow or move to stiffer spine.<br><br>
      This doesn’t replace paper tuning or broadhead flight testing, but it gives a fast “does this shaft live in the right neighborhood?” sanity check.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function showFlatnessPopup() {
  let currentFps = parseFloat($('fpsSlider').value);
  if (isNaN(currentFps) || currentFps <= 0) {
    const est = calculateEstimatedFPS();
    currentFps = est.estimated;
  }
  const fps = currentFps; // now available

  const g = 32.174;
  const t20 = 20 * 3 / fps;
  const t60 = 60 * 3 / fps;
  const drop20 = 0.5 * g * t20 * t20 * 12;
  const drop60 = 0.5 * g * t60 * t60 * 12;
  const extraDropInches = drop60 - drop20;
  const arcHeightFt = extraDropInches / 12;

  let status = 'Curved';
  if (arcHeightFt < 3) status = 'Very Flat';
  else if (arcHeightFt <= 4.5) status = 'Flat';

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>Flatness Score (20→60 yd) Math</strong></p>
    <p>Flatness looks at how tall your arc needs to be by 60 yards when you are zeroed at 20 yards.</p>
    <hr>
    <p><strong>1) Compute gravity drop at 20 and 60 yd</strong></p>
    <p>Using your launch FPS ≈ ${fps.toFixed(0)} fps</p>
    <p>Drop at 20 yd ≈ ${drop20.toFixed(1)} in</p>
    <p>Drop at 60 yd ≈ ${drop60.toFixed(1)} in</p>
    <hr>
    <p><strong>2) Re-anchor to your 20 yd zero</strong></p>
    <p>Extra drop 20 → 60 yd = ${extraDropInches.toFixed(1)} in</p>
    <hr>
    <p><strong>3) Convert extra drop into effective arc height</strong></p>
    <p>Height ≈ extra drop ÷ 12 = <strong>${arcHeightFt.toFixed(2)} ft</strong></p>
    <hr>
    <p><strong>4) Map height → Flatness label</strong></p>
    <p>Your current build falls into: <strong>${status}</strong></p>
    <p>• Very Flat → effective arc < ~3 ft</p>
    <p>• Flat → ~3–4.5 ft</p>
    <p>• Curved → > ~4.5 ft</p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      Use this to compare builds — it isn’t meant to be exact sight tape data, just a feel for how “flat” the rig is by 60 yards with your current FPS.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function showGroupStabilityPopup() {
  // Recalculate everything needed for the popup
  const arrowLen = parseFloat($('arrowLen').value) || 28.5;
  const balancePt = parseFloat($('balancePt').value) || 17.2;
  const totalWt = parseFloat($('totalWt').value) || 495;
  const fps = parseFloat($('fpsSlider').value) || 278;

  const midPoint = arrowLen / 2;
  const foc = ((balancePt - midPoint) / arrowLen) * 100;
  const gpi = totalWt / arrowLen;

  const fpsGood = fps >= 270;
  const focGood = foc >= 12 && foc <= 18;
  const gpiGood = gpi <= 9.5;

  const goodCount = (fpsGood ? 1 : 0) + (focGood ? 1 : 0) + (gpiGood ? 1 : 0);

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>Group Stability (Target / 3D)</strong></p>
    <p>This rates how optimized your setup is for tight groups in target/3D shooting.</p>
    <hr>
    <p><strong>Current score: ${goodCount}/3</strong></p>
    <p>• FPS ≥ 270: ${fpsGood ? '✓' : '✗'} (${fps.toFixed(0)} fps)</p>
    <p>• FOC 12–18%: ${focGood ? '✓' : '✗'} (${foc.toFixed(1)}%)</p>
    <p>• GPI ≤ 9.5: ${gpiGood ? '✓' : '✗'} (${gpi.toFixed(1)} gr/in)</p>
    <hr>
    <p>3/3 = Tight groups likely with good tuning<br>
       2/3 = Close — small tweaks help<br>
       0–1/3 = Average — more forgiveness trade-offs</p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      Execution and tuning always matter most — this is just a starting point.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function showSightPopup() {
  $('gameMathContent').innerHTML = `
    <p><strong>Sight Pin Zeros</strong></p>
    <p>Many bow sights use fixed pins (20/30/40/50/60 yd) or a single adjustable pin/slider.</p>
    <hr>
    <p>Change "Base Zero" to simulate:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Moving your sight housing up/down</li>
      <li>Dialing a slider for longer range</li>
      <li>Changing your 20 yd zero to 30 yd zero</li>
    </ul>
    <p>Pins are spaced 10 yd apart (common for hunting sights).</p>
    <p>This helps you visualize how your arrow drop aligns with your actual pin gaps.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

function showPeakHeightPopup() {
  // Grab live user values for personalized display
  const fps = parseFloat($('fpsSlider').value) || 278;

  // Recalculate with current FPS
  const approxThetaDeg = 3;
  const approxThetaRad = approxThetaDeg * Math.PI / 180;
  const v0y = fps * Math.sin(approxThetaRad);
  const peakHeightFt = (v0y * v0y) / (2 * 32.174);
  const timeToPeak = v0y / 32.174;
  const peakDistanceYd = Math.round((fps * Math.cos(approxThetaRad) * timeToPeak) / 3);

  $('gameMathContent').innerHTML = `
    <p><strong>Peak Height Math & Usage</strong></p>
    <p>The highest point your arrow reaches above the launch line (not line of sight).</p>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Actual Speed: <strong>${fps.toFixed(1)} fps</strong></li>
      <li>Peak Height: <strong>${peakHeightFt.toFixed(1)} ft / ${(peakHeightFt * 12).toFixed(1)} in</strong></li>
      <li>Occurs at: <strong>${peakDistanceYd} yd</strong></li>
    </ul>
    <hr>
    <p><strong>Why Doesn't This Change with the Range Slider?</strong></p>
    <p>Peak height is a property of the <strong>entire trajectory arc</strong> — determined by launch speed and upward angle (fixed for 20 yd zero). It always occurs near the midpoint of the full flight path (~80–90 yd vacuum range), around 40–45 yd for hunting speeds.</p>
    <p>The Range slider only changes where you're aiming — not the shape of the arc itself.</p>
    <p>Example: At 50 yd range, your arrow is already <strong>past the peak</strong> and dropping (see Downrange Drop card).</p>
    <hr>
    <p><strong>Step-by-Step Calculation:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Upward velocity ≈ ${fps.toFixed(1)} × sin(3°) ≈ ${v0y.toFixed(1)} ft/s</li>
      <li>Height = (v₀ sinθ)² / (2g) = <strong>${peakHeightFt.toFixed(1)} ft</strong></li>
      <li>Distance to peak ≈ <strong>${peakDistanceYd} yd</strong></li>
    </ul>
    <hr>
    <p><strong>How to Use It:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Brush/Branch Clearance:</strong> Must clear obstacles on steep shots.</li>
      <li><strong>Blind Window Shots:</strong> Higher peak = safer over frame.</li>
      <li><strong>Compare Builds:</strong> Faster arrows = higher/farther peak.</li>
    </ul>
    <p>Influenced by: <strong>Actual Speed (FPS)</strong> — primary factor.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

function showDropPopup() {
  // Get current user values
  const fps = parseFloat($('fpsSlider').value) || 278;
  const totalWt = parseFloat($('totalWt').value) || 495;
  const rangeYd = parseFloat($('rangeSlider').value) || 50;

  // Calculate actual drop values (same as in cards)
  const dropAtDistance = (distYd) => {
    const distFt = distYd * 3;
    const time = distFt / fps;
    return 0.5 * 32.174 * time * time * 12; // inches total gravity drop
  };
  const dropInTarget = dropAtDistance(rangeYd);
  const drop20 = dropAtDistance(20);
  const relativeDropInTarget = dropInTarget - drop20;
  const dropFtTarget = (relativeDropInTarget / 12).toFixed(1);
  const dropInTargetRounded = relativeDropInTarget.toFixed(1);

  $('gameMathContent').innerHTML = `
    <p><strong>Downrange Drop Math & Usage</strong></p>
    <p>How far the arrow impacts <strong>below your line of sight</strong> at the selected Range (with a 20 yd zero).</p>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Actual Speed: <strong>${fps.toFixed(1)} fps</strong></li>
      <li>Total Arrow Weight: <strong>${totalWt} gr</strong></li>
      <li>Current Range: <strong>${rangeYd} yd</strong></li>
      <li>Downrange Drop: <strong>${dropFtTarget} ft / ${dropInTargetRounded} in</strong></li>
    </ul>
    <hr>
    <p><strong>Calculation:</strong></p>
    <p>Extra gravity drop beyond your 20 yd zero.</p>
    <p>Step-by-step:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Total gravity drop at ${rangeYd} yd: ${(dropInTarget).toFixed(1)} in</li>
      <li>Total gravity drop at 20 yd: ${(drop20).toFixed(1)} in</li>
      <li>Extra drop = ${dropInTarget.toFixed(1)} − ${drop20.toFixed(1)} = <strong>${relativeDropInTarget.toFixed(1)} in</strong></li>
      <li>= <strong>${dropFtTarget} ft</strong></li>
    </ul>
    <hr>
    <p><strong>How to Use It:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Pin Gaps & Holdover:</strong> Aim this high above vitals with your last pin.</li>
      <li><strong>Ethical Range:</strong> If drop > vital zone (~12–18 in), consider it your max accurate range.</li>
      <li><strong>Compare Builds:</strong> Faster/lighter arrows = less drop = flatter trajectory.</li>
    </ul>
    <p>Influenced by: <strong>Actual Speed</strong> (biggest), <strong>Total Arrow Weight</strong> (retains speed), and <strong>Range</strong>.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

function showFlightTimePopup() {
  // Grab live user values
  const fps = parseFloat($('fpsSlider').value) || 278;
  const rangeYd = parseFloat($('rangeSlider').value) || 50;
  const totalWt = parseFloat($('totalWt').value) || 495;

  // Calculate flight time (same as card)
  const timeTarget = (rangeYd * 3) / fps;

  $('gameMathContent').innerHTML = `
    <p><strong>Flight Time Math & Usage</strong></p>
    <p>Time from release to impact — the animal's "reaction window".</p>
    <hr>
    <p><strong>Your Current Build:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Actual Speed: <strong>${fps.toFixed(1)} fps</strong></li>
      <li>Total Arrow Weight: <strong>${totalWt} gr</strong></li>
      <li>Current Range: <strong>${rangeYd} yd</strong></li>
      <li>Flight Time: <strong>${timeTarget.toFixed(3)} sec</strong></li>
    </ul>
    <hr>
    <p><strong>Step-by-Step Calculation:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Horizontal distance = ${rangeYd} yd × 3 = ${rangeYd * 3} ft</li>
      <li>Horizontal velocity ≈ ${fps.toFixed(1)} fps (small upward angle ignored for approximation)</li>
      <li>Time = distance / velocity = ${ (rangeYd * 3).toFixed(0) } / ${fps.toFixed(1)} ≈ <strong>${timeTarget.toFixed(3)} sec</strong></li>
    </ul>
    <hr>
    <p><strong>How to Use It (Hunting Guide):</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li><strong>Under 0.2 sec</strong>: Very fast — animal struggles to react ("string jump" rare)</li>
      <li><strong>0.2–0.3 sec</strong>: Average — most hunting setups. Good with calm animals.</li>
      <li><strong>Over 0.3 sec</strong>: Slower — higher risk of jump, especially alert game.</li>
    </ul>
    <p>Your ${timeTarget.toFixed(3)} sec at ${rangeYd} yd is solid for a heavy hunting arrow — great balance of quietness and penetration.</p>
    <hr>
    <p>Influenced by: <strong>Actual Speed (FPS)</strong> and <strong>Range</strong>. Heavier arrows slightly slower but quieter.</p>
  `;
  $('gameMathModal').style.display = 'flex';
}

function calculateEverything() {
  // Parse all inputs first
  const drawWt = parseFloat($('drawWt').value) || 70;
  const totalWt = parseFloat($('totalWt').value) || 495;
  const windMph = parseFloat($('windSlider').value) || 0;
  const rangeYd = parseFloat($('rangeSlider').value) || 50;
  const arrowLen = parseFloat($('arrowLen').value) || 28.5;
  const balancePt = parseFloat($('balancePt').value) || 17.2;
  // For the Total Weight
  const pointWt = parseFloat($('pointWt').value) || 125;

  // === Auto-calculate String Add-ons from details ===
  const peepWt = parseFloat($('peepWt').value) || 0;
  const dloopWt = parseFloat($('dloopWt').value) || 0;
  const kisserWt = parseFloat($('kisserWt').value) || 0;
  const silencerWt = parseFloat($('silencerWt').value) || 0;
  const nockWt = parseFloat($('nockWt').value) || 0;

  const calculatedTotal = peepWt + dloopWt + kisserWt + silencerWt + nockWt;

  // Declare stringWtInput first
  const stringWtInput = $('stringWt');

  // Update the display total
  const totalEl = $('stringAddonsTotal');
  if (totalEl) totalEl.textContent = calculatedTotal.toFixed(1);

  // Only auto-update main field if user hasn't manually edited it
  if (stringWtInput) {
    const manualEdited = stringWtInput.dataset.manual === 'true';
    if (!manualEdited) {
      stringWtInput.value = calculatedTotal.toFixed(1);
      stringWtInput.dataset.manual = 'false'; // reset flag
    }
  }

  // === Auto-calculate Arrow Components Total ===
  const useArrowDetails = $('useArrowDetails')?.checked ?? true;

  const bareShaftWt = parseFloat($('bareShaftWt').value) || 0;
  const insertWt = parseFloat($('insertWt').value) || 0;
  const wrapWt = parseFloat($('wrapWt').value) || 0;
  const vaneWtEach = parseFloat($('vaneWt').value) || 0;
  const vaneCount = parseFloat($('vaneCount').value) || 0;
  const glueWt = parseFloat($('glueWt').value) || 0;

  const calculatedArrowTotal = bareShaftWt + insertWt + wrapWt + (vaneWtEach * vaneCount) + glueWt + pointWt;

  // Always update display total
  const arrowTotalEl = $('arrowComponentsTotal');
  if (arrowTotalEl) arrowTotalEl.textContent = calculatedArrowTotal.toFixed(1);

  // Only auto-update main field if useArrowDetails is checked and not manually edited
  const totalWtInput = $('totalWt');
  if (totalWtInput && useArrowDetails) {
    const manualEdited = totalWtInput.dataset.manual === 'true';
    if (!manualEdited) {
      totalWtInput.value = calculatedArrowTotal.toFixed(1);
      totalWtInput.dataset.manual = 'false';
    }
  }

  // FPS Slider
  let userFps = parseFloat($('fpsSlider').value);
  if (isNaN(userFps) || userFps <= 0) {
    const est = calculateEstimatedFPS();
    userFps = est.estimated;
  }
  const fps = userFps;

  // Sync number inputs
  $('windInput').value = windMph;
  $('rangeInput').value = rangeYd;
  $('fpsInput').value = fps;

  // Update game distance
  $('gameDist').textContent = rangeYd;

    // === FOC Progress Bar (SAFE) ===
  const midPoint = arrowLen / 2;
  const foc = ((balancePt - midPoint) / arrowLen) * 100;
  const focClamped = Math.max(0, Math.min(30, foc));

  const focMarker = $('focMarker');
  const focValue = $('focValue');
  if (focMarker) focMarker.style.left = (focClamped / 30 * 100) + '%';
  if (focValue) {
    focValue.style.left = (focClamped / 30 * 100) + '%';
    focValue.textContent = foc.toFixed(1) + '%';
  }

  // === GPP (SAFE) ===
  const gpp = totalWt / drawWt;
  const gppPercent = Math.max(0, Math.min(100, (gpp - 5) / 5 * 100));

  const gppMarker = $('gppMarker');
  const gppValue = $('gppValue');
  if (gppMarker) gppMarker.style.left = `${gppPercent}%`;
  if (gppValue) {
    gppValue.style.left = `${gppPercent}%`;
    gppValue.textContent = gpp.toFixed(1) + ' gr';
  }

  // === GPI (SAFE) ===
  const gpi = totalWt / arrowLen;
  const gpiPercent = (gpi / 20) * 100;

  const gpiMarker = $('gpiMarker');
  const gpiValue = $('gpiValue');
  if (gpiMarker) gpiMarker.style.left = `${gpiPercent}%`;
  if (gpiValue) {
    gpiValue.style.left = `${gpiPercent}%`;
    gpiValue.textContent = gpi.toFixed(1) + ' gr/in';
  }

  // === Total Wt (SAFE) ===
  const totalWtPercent = ((totalWt - 50) / 950) * 100;

  const totalWtMarker = $('totalWtMarker');
  const totalWtValue = $('totalWtValue');
  if (totalWtMarker) totalWtMarker.style.left = `${totalWtPercent}%`;
  if (totalWtValue) {
    totalWtValue.style.left = `${totalWtPercent}%`;
    totalWtValue.textContent = Math.round(totalWt) + ' gr';
  }

    // === Game Effectiveness (100% SAFE) ===
  const k = 0.532;
  const retention = Math.exp(- (k * rangeYd) / totalWt);
  const velImpact = Math.round(fps * retention);
  const keImpact = Math.round(totalWt * velImpact * velImpact / 450240);
  const momImpact = parseFloat((totalWt * velImpact / 225400).toFixed(3));
  const classes = [
    {id: 'small', keMin: 15, momMin: 0.20},
    {id: 'deer', keMin: 25, momMin: 0.30},
    {id: 'elk', keMin: 42, momMin: 0.45},
    {id: 'moose', keMin: 65, momMin: 0.60}
  ];
  classes.forEach(c => {
    const keOk = keImpact >= c.keMin;
    const momOk = momImpact >= c.momMin;
    const bothOk = keOk && momOk;

    const keEl = $(`${c.id}KE`);
    const momEl = $(`${c.id}Mom`);
    const resCell = $(`${c.id}Res`);

    if (keEl) keEl.textContent = `${keImpact.toFixed(1)} ${keOk ? '(✓)' : '(×)'}`;
    if (momEl) momEl.textContent = `${momImpact.toFixed(3)} ${momOk ? '(✓)' : '(×)'}`;
    if (resCell) {
      if (bothOk) {
        resCell.textContent = 'Send it';
        resCell.className = 'send';
      } else if (keOk || momOk) {
        resCell.textContent = 'Marginal';
        resCell.className = 'marginal';
      } else {
        resCell.textContent = 'Adjust';
        resCell.className = 'adjust';
      }
    }
  });

    // === Stiffness / Forgiveness ===
  const actualSpine = parseFloat($('spine').value) || 300;
  const baseLoad = drawWt;
  const lengthFactor = (arrowLen - 28) * 2.5;
  const pointFactor = (pointWt - 100) * 0.15;
  const weightFactor = (totalWt - 400) * 0.05;
  const effectiveLoad = Math.round(baseLoad + lengthFactor + pointFactor + weightFactor);
  const recommendedCenter = Math.max(200, Math.min(500, 600 - effectiveLoad * 5));
  const spineDiff = actualSpine - recommendedCenter;

  let stiffnessPercent = 50 + spineDiff / 2;

  if (spineDiff > 100) {
    stiffnessPercent = 75 + (spineDiff - 100);
  } else if (spineDiff < -100) {
    stiffnessPercent = 25 + (spineDiff + 100);
  }

  stiffnessPercent = Math.max(0, Math.min(100, stiffnessPercent));

    // === Effective Draw Weight bars (100% SAFE) ===
  const maxLoad = 100;
  const inputDwPercent = (drawWt / maxLoad) * 100;
  const effectivePercent = (effectiveLoad / maxLoad) * 100;

  const inputDwFill = $('inputDwFill');
  const inputDwMarker = $('inputDwMarker');
  const inputDwValue = $('inputDwValue');
  const effectiveLoadFill = $('effectiveLoadFill');
  const effectiveLoadMarker = $('effectiveLoadMarker');
  const effectiveLoadValue = $('effectiveLoadValue');

  if (inputDwFill) inputDwFill.style.width = `${inputDwPercent}%`;
  if (inputDwMarker) inputDwMarker.style.left = `${inputDwPercent}%`;
  if (inputDwValue) {
    inputDwValue.style.left = `${inputDwPercent}%`;
    inputDwValue.textContent = drawWt + ' lb';
  }
  if (effectiveLoadFill) effectiveLoadFill.style.width = `${effectivePercent}%`;
  if (effectiveLoadMarker) effectiveLoadMarker.style.left = `${effectivePercent}%`;
  if (effectiveLoadValue) {
    effectiveLoadValue.style.left = `${effectivePercent}%`;
    effectiveLoadValue.textContent = effectiveLoad + ' lb';
  }

  // Show spine + status
  let status = 'Good';
  if (spineDiff > 100) status = 'Weakest';
  else if (spineDiff < -100) status = 'Stiffest';
  else if (spineDiff > 60) status = 'Weaker)';
  else if (spineDiff < -60) status = 'Stiffer)';

  // Stiffness (SAFE)
  const stiffnessValue = $('stiffnessValue');
  const stiffnessMarker = $('stiffnessMarker');

  if (stiffnessValue) {
    stiffnessValue.textContent = actualSpine + ' (' + status + ')';
    stiffnessValue.style.left = `${stiffnessPercent}%`;
  }
  if (stiffnessMarker) stiffnessMarker.style.left = `${stiffnessPercent}%`;

  // === Flatness Score (20→60 yd) ===
  const g = 32.174;
  const t20 = 20 * 3 / fps;
  const t60 = 60 * 3 / fps;
  const drop20 = 0.5 * g * t20 * t20 * 12;
  const drop60 = 0.5 * g * t60 * t60 * 12;
  const extraDropInches = drop60 - drop20;
  const arcHeightFt = extraDropInches / 12;

  // Marker logic FIRST (right = flatter = better)
  let flatnessPercent = 0;
  if (arcHeightFt < 3) {
    flatnessPercent = 100;
  } else if (arcHeightFt <= 4.5) {
    flatnessPercent = 66.67 + ((arcHeightFt - 3) / 1.5) * 33.33;
  } else {
    flatnessPercent = Math.max(0, 66.67 - ((arcHeightFt - 4.5) / 3) * 66.67);
  }

  // Flatness (SAFE)
  const flatnessValue = $('flatnessValue');
  const flatnessMarker = $('flatnessMarker');

  if (flatnessValue) {
    flatnessValue.textContent = arcHeightFt.toFixed(1) + ' ft';
    flatnessValue.style.left = `${flatnessPercent}%`;
  }
  if (flatnessMarker) flatnessMarker.style.left = `${flatnessPercent}%`;

  // === Group Stability (Target / 3D) ===
  const fpsGood = fps >= 270;
  const focGood = foc >= 12 && foc <= 18;
  const gpiGood = gpi <= 9.5;

  const goodCount = (fpsGood ? 1 : 0) + (focGood ? 1 : 0) + (gpiGood ? 1 : 0);
  const groupPercent = (goodCount / 3) * 100; // 0, 33.33, 66.67, 100

  // DELETE DEBUG
  console.log('goodCount:', goodCount, 'percent:', groupPercent);

    // Group Stability (SAFE)
  const groupStabilityValue = $('groupStabilityValue');
  const groupStabilityMarker = $('groupStabilityMarker');

  if (groupStabilityValue) groupStabilityValue.textContent = `${goodCount}/3`;
  if (groupStabilityMarker) groupStabilityMarker.style.left = `${groupPercent}%`;

  // === Custom Sight Pin Zeros ===
  const pinCountSelect = $('pinCount');
  const pinCount = pinCountSelect ? Number(pinCountSelect.value) : 3;
  const pinInputsContainer = $('pinInputs');
  if (pinInputsContainer) {
    pinInputsContainer.innerHTML = '';
    if (pinCount > 0) {
      for (let i = 1; i <= pinCount; i++) {
        const defaultZero = i === 1 ? 20 : (i === 2 ? 30 : (i === 3 ? 40 : (i === 4 ? 50 : 60)));
        const pinId = `pin${i}Zero`;
        pinInputsContainer.innerHTML += `
          <div class="input-row">
            <label for="${pinId}">Pin ${i} Zero (yd)</label>
            <input type="number" id="${pinId}" value="${defaultZero}" min="10" max="100" step="5">
          </div>
        `;
      }
    } else {
      pinInputsContainer.innerHTML = '<p style="font-size:0.9rem; color:var(--light); margin:0;">Instinctive shooting — no pins configured.</p>';
    }
  }

  // === Trajectory Calculations for New Cards ===
  const approxThetaDeg = 3; // typical upward angle for 20 yd zero
  const approxThetaRad = approxThetaDeg * Math.PI / 180;
  const v0y = fps * Math.sin(approxThetaRad);
  const peakHeightFt = (v0y * v0y) / (2 * 32.174);
  const timeToPeak = v0y / 32.174;
  const peakDistanceYd = (fps * Math.cos(approxThetaRad) * timeToPeak) / 3;

  // Downrange drop function (for target range)
  const dropAtDistance = (distYd) => {
    const distFt = distYd * 3;
    const time = distFt / fps;
    return 0.5 * 32.174 * time * time * 12; // inches total gravity drop
  };

  // Update the 3 new summary cards (SAFE)
  const rangeTarget = rangeYd || 50;

  // Peak Height
  const peakFt = peakHeightFt.toFixed(1);
  const peakIn = (peakHeightFt * 12).toFixed(1);
  const peakHeightFtEl = $('peakHeightFt');
  const peakHeightInEl = $('peakHeightIn');
  const peakDistanceYdEl = $('peakDistanceYd');
  if (peakHeightFtEl) peakHeightFtEl.textContent = peakFt;
  if (peakHeightInEl) peakHeightInEl.textContent = peakIn;
  if (peakDistanceYdEl) peakDistanceYdEl.textContent = Math.round(peakDistanceYd);

  // Downrange Drop at target range
  const dropInTarget = dropAtDistance(rangeTarget);
  const relativeDropInTarget = dropInTarget - dropAtDistance(20);
  const dropFtTarget = (relativeDropInTarget / 12).toFixed(1);
  const dropInTargetRounded = relativeDropInTarget.toFixed(1);
  const dropFtEl = $('dropFt');
  const dropInEl = $('dropIn');
  const dropDistanceYdEl = $('dropDistanceYd');
  if (dropFtEl) dropFtEl.textContent = dropFtTarget;
  if (dropInEl) dropInEl.textContent = dropInTargetRounded;
  if (dropDistanceYdEl) dropDistanceYdEl.textContent = rangeTarget;

  // Flight Time to target
  const timeTarget = (rangeTarget * 3) / fps;
  const flightTimeSecEl = $('flightTimeSec');
  const flightDistanceYdEl = $('flightDistanceYd');
  if (flightTimeSecEl) flightTimeSecEl.textContent = timeTarget.toFixed(3);
  if (flightDistanceYdEl) flightDistanceYdEl.textContent = rangeTarget;

    // === Update Build Summary Table ===
  const table = $('summaryTable').querySelector('tbody');
  table.innerHTML = ''; // clear

  const addRow = (label, value) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td style="font-weight:600; padding:0.5rem 0;">${label}</td>
      <td style="padding:0.5rem 0;">${value || '-'}</td>
    `;
    table.appendChild(row);
  };

  // User Inputs
  // === Bow Inputs ===
  addRow('Build Name', $('buildName').value || 'Unnamed');
  addRow('Application', $('appType').value);
  addRow('Bow Model', $('bowModel').value || '-');
  addRow('Bow Type', $('bowType').value || '-');
  addRow('IBO Speed', $('ibo').value ? $('ibo').value + ' fps' : '-');
  addRow('Draw Weight', drawWt + ' lb');
  addRow('Draw Length', $('drawLen').value ? $('drawLen').value + ' in' : '-');
  addRow('Let-off', $('letOff').value ? $('letOff').value + '%' : '-');
  addRow('Brace Height', $('braceHeight').value ? $('braceHeight').value + ' in' : '-');
  addRow('Cam System', $('camType').value || '-');
  addRow('String Add-ons', $('stringWt').value + ' gr');

  // === Sight Pin Zeros in Summary (100% safe) ===
  const bowType = $('bowType')?.value || 'compound';
  const pinCountSummary = Number($('pinCount')?.value || '3');

  if (bowType === 'recurve' || bowType === 'longbow') {
    addRow('Sight Pins', 'None / Instinctive (Traditional Bow)');
  } else if (pinCountSummary === 0) {
    addRow('Sight Pins', 'None (Slider or Custom)');
  } else {
    for (let i = 1; i <= Math.min(pinCountSummary, 5); i++) {
      const pinZeroEl = $(`pin${i}Zero`);
      if (pinZeroEl) {
        addRow(`Pin ${i} Zero`, pinZeroEl.value + ' yd');
      }
    }
  }

  // Arrow inputs continue...
  addRow('Arrow Name', $('arrowName').value);
  addRow('Spine', actualSpine);
    addRow('Arrow Diameter', {
    'standard': 'Standard (~6.5mm)',
    'small': 'Small (~5mm)',
    'micro': 'Micro (~4mm)'
  }[$('arrowDia').value] || 'Micro (~4mm)');
  addRow('Arrow Length', arrowLen + ' in');
  addRow('Total Arrow Weight', totalWt + ' gr');
  addRow('Point Weight', pointWt + ' gr');
  addRow('Balance Point', balancePt + ' in');
  addRow('Actual Speed', fps.toFixed(1) + ' fps');
  addRow('Crosswind', windMph.toFixed(1) + ' mph');
  addRow('Range', rangeYd + ' yd');

  // Calculated Outputs
  addRow('FOC', foc.toFixed(1) + '%');
  addRow('GPP', gpp.toFixed(1));
  addRow('GPI', gpi.toFixed(1) + ' gr/in');

  addRow('Effective Draw Weight', effectiveLoad + ' lb');
  
  // Add stiffness with status
  let stiffnessStatus = 'Good';
  if (spineDiff > 100) stiffnessStatus = 'Weakest';
  else if (spineDiff < -100) stiffnessStatus = 'Stiffest';
  else if (spineDiff > 60) stiffnessStatus = 'Weaker';
  else if (spineDiff < -60) stiffnessStatus = 'Stiffer';

  addRow('Stiffness', actualSpine + ' (' + stiffnessStatus + ')');

  // Calculated Outputs 
  addRow('Flatness (20→60 yd)', arcHeightFt.toFixed(1) + ' ft arc');
  addRow('Group Stability', `${goodCount}/3 conditions met`);

  // Trajectory
  addRow('Peak Height', peakHeightFt.toFixed(1) + ' ft');
  addRow('Peak Distance', Math.round(peakDistanceYd) + ' yd');

  // Downrange Drop
  addRow('Drop at 30 yd', $(`drop30`).textContent);
  addRow('Drop at 40 yd', $(`drop40`).textContent);
  addRow('Drop at 50 yd', $(`drop50`).textContent);
  addRow('Drop at 60 yd', $(`drop60`).textContent);
  addRow('Drop at 70 yd', $(`drop70`).textContent);

  // Game Effectiveness
  addRow('Impact Velocity @ ' + rangeYd + ' yd', velImpact + ' fps');
  addRow('Impact KE @ ' + rangeYd + ' yd', keImpact.toFixed(1) + ' ft-lbs');
  addRow('Impact Momentum @ ' + rangeYd + ' yd', momImpact.toFixed(3) + ' slug·ft/s');
}

// Move this outside calculateEverything()
$('copyCsvBtn').addEventListener('click', () => {
  let csv = 'Label,Value\n';
  const rows = $('summaryTable').querySelectorAll('tr');
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length === 2) {
      const label = cells[0].textContent.trim();
      const value = cells[1].textContent.trim();
      csv += `"${label}","${value}"\n`;
    }
  });
  navigator.clipboard.writeText(csv).then(() => {
    alert('Build summary copied to clipboard as CSV!');
  });
});

function closeFpsMath() {
  $('fpsMathModal').style.display = 'none';
}

function closeModal() {
  $('aiModal').style.display = 'none';
}

function sendAi() {
  const msg = $('aiIn').value.trim();
  if (!msg) return;
  $('chatHist').innerHTML += `<p><strong>You:</strong> ${msg}</p>`;
  $('chatHist').innerHTML += `<p style="color:var(--purple);"><strong>AI:</strong> Got it! Example response...</p>`;
  $('aiIn').value = '';
  $('chatHist').scrollTop = $('chatHist').scrollHeight;
}

// Suggest Build Name
document.querySelector('.secondary').addEventListener('click', () => {
  const today = new Date();
  const dateStr = today.toISOString().slice(0, 10);
  const appType = $('appType').value.trim() || 'Hunting';
  const arrowWeight = $('totalWt').value.trim() || '???';
  const bowModel = $('bowModel').value.trim() || 'Bow';
  const drawWt = $('drawWt').value || '??';
  const templates = [
    `${dateStr} ${appType} ${bowModel} ${drawWt}# ${arrowWeight}gr`,
    `${dateStr} ${bowModel} ${drawWt}lb ${appType} ${arrowWeight}gr`,
    `${dateStr} ${appType} Build ${arrowWeight}gr`,
    `${dateStr} ${bowModel} ${appType} Setup`
  ];
  const best = templates.find(t => !t.includes('??') && !t.includes('???')) || templates[0];
  $('buildName').value = best.trim();
});

// Save / Load / Delete Builds
function updateLoadDropdown() {
  const select = $('loadBuild');
  const builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  select.innerHTML = '<option>– Load Build –</option>';
  builds.sort((a, b) => b.date.localeCompare(a.date)).forEach(build => {
    const opt = document.createElement('option');
    opt.value = build.name;
    opt.textContent = `${build.date} – ${build.name}`;
    select.appendChild(opt);
  });
}

// Preloaded Sample Profiles (prefixed with SAMPLE)
const sampleProfiles = [
  {
    name: "SAMPLE Cameron Hanes Heavy Hunter",
    date: "2025-01-01",
    appType: "Hunting",
    bowModel: "Hoyt RX-9 Ultra",
    bowType: "compound",
    letOff: "85",
    braceHeight: "6.375",
    camType: "hybrid",
    ibo: "340",
    drawWt: "80",
    drawLen: "27",
    stringWt: "20",
    pinCount: "3",
    pin1Zero: "20",
    pin2Zero: "30",
    pin3Zero: "50",
    arrowName: "Easton FMJ",
    spine: "300",
    arrowDia: "standard",
    arrowLen: "27.5",
    totalWt: "500",
    pointWt: "125",
    balancePt: "18",
    fpsSlider: "290",
    useStringDetails: false,
    useArrowDetails: false
  },
  {
    name: "SAMPLE Josh Bowmar Beast Mode",
    date: "2025-01-01",
    appType: "Hunting",
    bowModel: "PSE Evo NXT",
    bowType: "compound",
    letOff: "80",
    braceHeight: "6.5",
    camType: "hybrid",
    ibo: "342",
    drawWt: "90",
    drawLen: "29",
    stringWt: "20",
    pinCount: "3",
    pin1Zero: "20",
    pin2Zero: "30",
    pin3Zero: "50",
    arrowName: "Victory VAP TKO",
    spine: "200",
    arrowDia: "micro",
    arrowLen: "29",
    totalWt: "520",
    pointWt: "200",
    balancePt: "18.5",
    fpsSlider: "280",
    useStringDetails: false,
    useArrowDetails: false
  },
  {
    name: "SAMPLE John Dudley Nock On Pro",
    date: "2025-01-01",
    appType: "Hunting",
    bowModel: "PSE Nock On Unite",
    bowType: "compound",
    letOff: "85",
    braceHeight: "7",
    camType: "hybrid",
    ibo: "340",
    drawWt: "70",
    drawLen: "29",
    stringWt: "15",
    pinCount: "3",
    pin1Zero: "20",
    pin2Zero: "30",
    pin3Zero: "40",
    arrowName: "Easton Axis",
    spine: "300",
    arrowDia: "small",
    arrowLen: "28",
    totalWt: "450",
    pointWt: "125",
    balancePt: "17",
    fpsSlider: "295",
    useStringDetails: false,
    useArrowDetails: false
  },
  {
    name: "SAMPLE Levi Morgan Champion",
    date: "2025-01-01",
    appType: "Target",
    bowModel: "Mathews TRX",
    bowType: "compound",
    letOff: "80",
    braceHeight: "7",
    camType: "hybrid",
    ibo: "350",
    drawWt: "60",
    drawLen: "27.5",
    stringWt: "10",
    pinCount: "1",
    pin1Zero: "20",
    arrowName: "Altra Centrum",
    spine: "300",
    arrowDia: "micro",
    arrowLen: "27",
    totalWt: "420",
    pointWt: "100",
    balancePt: "16",
    fpsSlider: "310",
    useStringDetails: false,
    useArrowDetails: false
  },
  {
    name: "SAMPLE Tim Gillingham Gold Tip Pro",
    date: "2025-01-01",
    appType: "Target",
    bowModel: "Bowtech Reckoning",
    bowType: "compound",
    letOff: "80",
    braceHeight: "7",
    camType: "hybrid",
    ibo: "340",
    drawWt: "65",
    drawLen: "28",
    stringWt: "15",
    pinCount: "5",
    pin1Zero: "20",
    pin2Zero: "30",
    pin3Zero: "40",
    pin4Zero: "50",
    pin5Zero: "60",
    arrowName: "Gold Tip Triple X",
    spine: "250",
    arrowDia: "small",
    arrowLen: "28",
    totalWt: "460",
    pointWt: "140",
    balancePt: "17",
    fpsSlider: "295",
    useStringDetails: false,
    useArrowDetails: false
  },
  {
    name: "SAMPLE James Yates Backcountry",
    date: "2025-01-01",
    appType: "Hunting",
    bowModel: "Hoyt RX-9",
    bowType: "compound",
    letOff: "85",
    braceHeight: "6.125",
    camType: "hybrid",
    ibo: "340",
    drawWt: "70",
    drawLen: "28",
    stringWt: "20",
    pinCount: "3",
    pin1Zero: "20",
    pin2Zero: "30",
    pin3Zero: "50",
    arrowName: "Easton Axis",
    spine: "250",
    arrowDia: "small",
    arrowLen: "28",
    totalWt: "480",
    pointWt: "125",
    balancePt: "17",
    fpsSlider: "285",
    useStringDetails: false,
    useArrowDetails: false
  }
];

// Load samples on first run
if (!localStorage.getItem('arrowForgeSamplesLoaded')) {
  let builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  sampleProfiles.forEach(sample => {
    if (!builds.some(b => b.name === sample.name)) {
      builds.push(sample);
    }
  });
  localStorage.setItem('arrowForgeBuilds', JSON.stringify(builds));
  localStorage.setItem('arrowForgeSamplesLoaded', 'true');
}

function updateLoadDropdown() {
  const select = $('loadBuild');
  const builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  select.innerHTML = '<option>– Load Build –</option>';
  builds
    .sort((a, b) => {
      const dateA = a.date || '0000-00-00';
      const dateB = b.date || '0000-00-00';
      return dateB.localeCompare(dateA); // newest first
    })
    .forEach(build => {
      const opt = document.createElement('option');
      opt.value = build.name;
      opt.textContent = `${build.date ? build.date + ' – ' : ''}${build.name}`;
      select.appendChild(opt);
    });
}

function saveBuild() {
  const buildName = $('buildName').value.trim();
  if (!buildName) {
    alert('Please enter a Build Name first');
    return;
  }
  const buildData = {
    name: buildName,
    date: new Date().toISOString().slice(0,10),
    appType: $('appType').value,
    bowModel: $('bowModel').value,
    bowType: $('bowType').value,
    ibo: $('ibo').value,
    drawWt: $('drawWt').value,
    drawLen: $('drawLen').value,
    letOff: $('letOff').value,
    braceHeight: $('braceHeight').value,
    camType: $('camType').value,
    stringWt: $('stringWt').value,
    peepWt: $('peepWt').value,
    dloopWt: $('dloopWt').value,
    kisserWt: $('kisserWt').value,
    silencerWt: $('silencerWt').value,
    nockWt: $('nockWt').value,
    pinCount: $('pinCount').value,
    pin1Zero: $('pin1Zero')?.value || '20',
    pin2Zero: $('pin2Zero')?.value || '30',
    pin3Zero: $('pin3Zero')?.value || '40',
    pin4Zero: $('pin4Zero')?.value || '50',
    pin5Zero: $('pin5Zero')?.value || '60',
    arrowName: $('arrowName').value,
    spine: $('spine').value,
    arrowDia: $('arrowDia').value,
    arrowLen: $('arrowLen').value,
    totalWt: $('totalWt').value,
    pointWt: $('pointWt').value,
    balancePt: $('balancePt').value,
    bareShaftWt: $('bareShaftWt').value || '0',
    insertWt: $('insertWt').value,
    wrapWt: $('wrapWt').value,
    vaneWt: $('vaneWt').value,
    vaneHeight: $('vaneHeight').value,
    vaneCount: $('vaneCount').value,
    vaneHelical: $('vaneHelical').value,
    glueWt: $('glueWt').value,
    fpsSlider: $('fpsSlider').value,
    windSlider: $('windSlider').value,
    rangeSlider: $('rangeSlider').value,
  };
  let builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  builds = builds.filter(b => b.name !== buildName);
  builds.push(buildData);
  localStorage.setItem('arrowForgeBuilds', JSON.stringify(builds));
  updateLoadDropdown();
  alert(`Build "${buildName}" saved!`);
}

function loadBuild() {
  const select = $('loadBuild');
  const selectedName = select.value;
  if (!selectedName || selectedName === '– Load Build –') return;
  const builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  const build = builds.find(b => b.name === selectedName);
  if (!build) return;

  // Set all fields first
  $('buildName').value = build.name;
  $('appType').value = build.appType || 'Hunting';
  $('bowModel').value = build.bowModel || '';
  $('bowType').value = build.bowType || 'compound';
  $('letOff').value = build.letOff || '80';
  $('braceHeight').value = build.braceHeight || '6';
  $('camType').value = build.camType || 'hybrid';
  $('ibo').value = build.ibo || '';
  $('drawWt').value = build.drawWt || '';
  $('drawLen').value = build.drawLen || '';
  $('stringWt').value = build.stringWt || '';
  $('peepWt').value = build.peepWt || '8';
  $('dloopWt').value = build.dloopWt || '8';
  $('kisserWt').value = build.kisserWt || '0';
  $('silencerWt').value = build.silencerWt || '12';
  $('nockWt').value = build.nockWt || '10';

  // Pin count with override
  let pinCountValue = build.pinCount || '3';
  if (build.bowType === 'recurve' || build.bowType === 'longbow') {
    pinCountValue = '0';
  }
  $('pinCount').value = pinCountValue;

  // Restore checkbox states
  if ($('useStringDetails')) $('useStringDetails').checked = build.useStringDetails ?? false;
  if ($('useArrowDetails')) $('useArrowDetails').checked = build.useArrowDetails ?? false;

  // Arrow fields
  $('arrowName').value = build.arrowName || '';
  $('spine').value = build.spine || '';
  $('arrowDia').value = build.arrowDia || 'micro';
  $('arrowLen').value = build.arrowLen || '';
  $('totalWt').value = build.totalWt || '';
  $('pointWt').value = build.pointWt || '';
  $('balancePt').value = build.balancePt || '';
  $('bareShaftWt').value = build.bareShaftWt || '0';
  $('insertWt').value = build.insertWt || '0';
  $('wrapWt').value = build.wrapWt || '0';
  $('vaneWt').value = build.vaneWt || '0';
  $('vaneCount').value = build.vaneCount || '0';
  $('vaneHeight').value = build.vaneHeight || '0.5';
  $('vaneHelical').value = build.vaneHelical || 'max';
  $('glueWt').value = build.glueWt || '0';

  // Sliders
  $('fpsSlider').value = build.fpsSlider || '278';
  $('fpsInput').value = build.fpsSlider || '278';
  $('windSlider').value = build.windSlider || '5';
  $('windInput').value = build.windSlider || '5';
  $('rangeSlider').value = build.rangeSlider || '50';
  $('rangeInput').value = build.rangeSlider || '50';

  alert(`Build "${build.name}" loaded!`);

  // ONLY ONE call at the end — after all fields are set
  calculateEverything();
}

function deleteBuild() {
  const select = $('loadBuild');
  const selectedName = select.value;
  if (!selectedName || selectedName === '– Load Build –') {
    alert('Select a build to delete');
    return;
  }
  if (confirm(`Delete "${selectedName}" forever?`)) {
    let builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
    builds = builds.filter(b => b.name !== selectedName);
    localStorage.setItem('arrowForgeBuilds', JSON.stringify(builds));
    updateLoadDropdown();
    alert(`Build deleted`);
  }
}

// String weight listener 
['peepWt', 'dloopWt', 'kisserWt', 'silencerWt', 'nockWt'].forEach(id => {
  const el = $(id);
  if (el) el.addEventListener('input', calculateEverything);
});

// Sight Pin listener
// Rebuild pin inputs when pinCount changes
const pinCountSelect = $('pinCount');
if (pinCountSelect) {
  pinCountSelect.addEventListener('change', () => {
    calculateEverything();
  });
}

// Arrow components auto-sum listeners
['bareShaftWt', 'insertWt', 'wrapWt', 'vaneWt', 'vaneCount', 'glueWt', 'pointWt'].forEach(id => {
  const el = $(id);
  if (el) el.addEventListener('input', calculateEverything);
});

// Manual override for Total Arrow Weight
const totalWtInput = $('totalWt');
if (totalWtInput) {
  totalWtInput.addEventListener('input', () => {
    totalWtInput.dataset.manual = 'true';
  });
}

// Add this with other listeners (outside calculateEverything)
const stringWtInput = $('stringWt');
if (stringWtInput) {
  stringWtInput.addEventListener('input', () => {
    stringWtInput.dataset.manual = 'true';
  });
}

function syncSlider(sliderId, inputId) {
  const slider = $(sliderId);
  const input = $(inputId);
  if (!slider || !input) return;
  slider.addEventListener('input', () => {
    input.value = slider.value;
    calculateEverything(); // optional, if you have calculations
  });
  input.addEventListener('input', () => {
    let val = parseFloat(input.value);
    if (isNaN(val)) val = slider.min;
    val = Math.max(slider.min, Math.min(slider.max, val));
    slider.value = val;
    input.value = val;
    calculateEverything();
  });
}

// Capitalize Bow Model
$('bowModel').addEventListener('input', e => {
  e.target.value = toTitleCase(e.target.value);
});

// Capitalize Arrow Name
$('arrowName').addEventListener('input', e => {
  e.target.value = toTitleCase(e.target.value);
});

//Capitalize the first letter of each word
function toTitleCase(str) {
  return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
}

// Connect the sliders
syncSlider('fpsSlider', 'fpsInput');
syncSlider('windSlider', 'windInput');
syncSlider('rangeSlider', 'rangeInput');

// Event listeners
document.querySelectorAll('input, select').forEach(el => {
  el.addEventListener('input', calculateEverything);
});
$('darkToggle').addEventListener('change', e => {
  document.body.classList.toggle('dark', e.target.checked);
});
$('aiButton').addEventListener('click', () => $('aiModal').style.display = 'flex');
$('saveBuild').addEventListener('click', saveBuild);
$('loadBuild').addEventListener('change', loadBuild);
$('deleteBuild').addEventListener('click', deleteBuild);

// set initial state
updateLoadDropdown();
calculateEverything();
toggleStringDetailsMode(); 
toggleArrowDetailsMode();
</script>
</body>
</html>