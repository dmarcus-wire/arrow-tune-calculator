<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arrow Tune Calculator</title>
  <meta name="description" content="Offline arrow tuning calculator – FOC, velocity, impact KE, composition, and more." />
  <link href="https://rsms.me/inter/inter.css" rel="stylesheet">
  <style>
    :root { --bg:#f8fafc; --card:#ffffff; --text:#1e293b; --light:#64748b; --border:#e2e8f0; --primary:#0ea5e9; --success:#22c55e; --warning:#f59e0b; --danger:#ef4444; }
    .dark { --bg:#0f172a; --card:#1e293b; --text:#e2e8f0; --light:#94a3b8; --border:#334155; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); padding:1rem; min-height:100vh; line-height:1.6; }
    .container { max-width:1400px; margin:auto; display:grid; gap:1.5rem; }
    @media (min-width:1024px) { .container { grid-template-columns:1fr 1fr; } }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:1.5rem; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .card-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:0.75rem; margin-bottom:1rem; font-size:1.3rem; font-weight:600; }
    h1,h2,h3,h4 { color:var(--text); }
    label { display:block; margin:1rem 0 0.4rem; font-weight:600; font-size:0.95rem; }
    input, select, textarea { width:100%; padding:0.75rem; border:1px solid var(--border); border-radius:8px; background:var(--card); color:var(--text); font-size:1rem; }
    input:focus, select:focus, textarea:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(14,165,233,0.2); }
    button { padding:0.75rem 1.2rem; border:none; border-radius:8px; background:var(--primary); color:white; font-weight:600; cursor:pointer; }
    .btn-small { padding:0.5rem 0.9rem; font-size:0.9rem; }
    .btn-refresh { background:var(--warning); }
    .flex { display:flex; gap:1rem; align-items:center; }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    .toggle-switch { position:relative; display:inline-block; width:56px; height:30px; }
    .toggle-switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; cursor:pointer; inset:0; background:#cbd5e1; border-radius:34px; transition:.3s; }
    .slider:before { position:absolute; content:""; height:24px; width:24px; left:3px; bottom:3px; background:white; border-radius:50%; transition:.3s; }
    input:checked + .slider { background:var(--primary); }
    input:checked + .slider:before { transform:translateX(26px); }
    .info-btn { background:none; border:none; font-size:1.4rem; cursor:help; color:var(--light); }
    .info-btn:hover { color:var(--primary); }
    .advanced { display:none; margin-top:1rem; padding-top:1rem; border-top:1px solid var(--border); }
    table { width:100%; border-collapse:collapse; margin-top:0.5rem; font-size:0.95rem; }
    th, td { padding:0.6rem; text-align:left; border-bottom:1px solid var(--border); }
    th { background:var(--bg); font-weight:600; }
    .patreon-btn { display:block; margin:3rem auto; background:#ff424d; color:white; text-decoration:none; padding:1rem 2rem; border-radius:12px; font-weight:bold; text-align:center; max-width:300px; }
    .light-only { display: block; }
    .dark-only { display: none; }
    .dark .light-only { display: none; }
    .dark .dark-only { display: block; }

    #outputs-column,
    #outputs-column * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
      font-weight: 600 !important;
      letter-spacing: -0.02em;
    }
    #outputs-column h3 {
      font-size: 1.15rem !important;
      margin: 0 0 0.4rem 0;
      font-weight: 700 !important;
    }
    #outputs-column div[style*="font-size:2.5rem"],
    #outputs-column div[style*="font-size:3rem"] {
      font-size: 2.6rem !important;
      line-height: 1.1;
    }
    #focValue {
      font-size: 4.2rem !important;
      line-height: 1;
    }
    #smallGameStatus,
    #deerStatus,
    #elkStatus,
    #mooseStatus {
      font-size: 2.4rem !important;
      font-weight: 800 !important;
    }
    #outputs-column small {
      font-weight: 500 !important;
      font-size: 0.9rem;
      opacity: 0.85;
    }

    /* Toast */
    #toast {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 0.6rem 1.1rem;
      border-radius: 999px;
      box-shadow: 0 6px 18px rgba(15,23,42,0.25);
      font-size: 0.9rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease-out;
      z-index: 999;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- LEFT: INPUTS -->
    <div id="inputs-column">
      <div class="card">
        <div class="card-header">
          <h1>Arrow Tune Calculator</h1>
          <div class="flex">
            <span style="color:var(--light);">Light</span>
            <label class="toggle-switch"><input type="checkbox" id="darkModeToggle"><span class="slider"></span></label>
            <span style="color:var(--light);">Dark</span>
          </div>
        </div>
        <p style="color:var(--light);">Offline • Mobile-friendly • Live calculations<br>
          <span style="font-size:0.9rem; color:var(--primary); font-weight:600;">Version 2.0.5</span>
        </p>
      </div>

      <div class="card">
        <div class="card-header"><h2>Your Setups</h2><button class="info-btn" title="Save and load your setups">i</button></div>
        <label>Build Name</label>
        <div class="flex">
          <input type="text" id="buildName" placeholder="e.g. 2025 Hoyt RX-9 70lb 500gr">
          <button class="btn-small" id="suggestName">Suggest</button>
        </div>
        <div class="flex" style="margin-top:1rem;gap:0.5rem;flex-wrap:wrap;">
          <button id="saveBuild">Save Build</button>
          <select id="loadBuildSelect"><option value="">– Load Build –</option></select>
          <button style="background:var(--danger);" id="deleteBuild">Delete</button>
        </div>
      </div>

      <!-- Bow Setup -->
      <div class="card">
        <div class="card-header"><h2>Bow Setup</h2><button class="info-btn" title="Your bow specs">i</button></div>
        <div class="grid-2">
          <div><label>Bow Model</label><input type="text" id="bowModel" step="0.5"></div>
          <div><label>IBO/ATA Speed (FPS)</label><input type="number" id="iboRating" value="0" step="0.5"></div>
          <div><label>Draw Weight (lbs)</label><input type="number" id="drawWeight" value="70" step="0.5"></div>
          <div><label>Draw Length (in)</label><input type="number" id="drawLength" value="29" step="0.5"></div>
          <div><label>String Add-ons (grains)</label><input type="number" id="stringWeightSimple" value="0" step="0.5"></div>
          <div>
            <label>Application</label>
            <select id="application">
              <option>Target / 3D</option>
              <option selected>Hunting</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div class="flex" style="margin-top:1rem;justify-content:space-between;">
          <label>Advanced String Components</label>
          <label class="toggle-switch"><input type="checkbox" id="toggleString"><span class="slider"></span></label>
        </div>
        <div id="stringAdvanced" class="advanced">
          <div class="grid-2">
            <div><label>Peep</label><input type="number" id="peepWeight" value="0" step="0.5"></div>
            <div><label>D-Loop</label><input type="number" id="dloopWeight" value="0" step="0.5"></div>
            <div><label>Kisser</label><input type="number" id="kisserWeight" value="0" step="0.5"></div>
            <div><label>Silencers</label><input type="number" id="silencersWeight" value="0" step="0.5"></div>
          </div>
          <p style="text-align:right;font-weight:600;">Total: <span id="stringTotal">0</span> grains</p>
        </div>
      </div>

      <!-- Arrow Setup -->
      <div class="card">
        <div class="card-header"><h2>Arrow Setup</h2><button class="info-btn" title="Measure from nock throat to end of shaft">i</button></div>
        <label>Arrow Name</label><input type="text" id="arrowName">
        <div class="grid-2">
          <div><label>Arrow Length (in)</label><input type="number" id="arrowLength" value="28.5" step="0.5"></div>
          <div>
            <label>Total Arrow Weight (grains)</label>
            <input type="number" id="totalArrowWeightSimple" value="450" step="0.5">
            <small id="totalWeightHint" style="display:block;margin-top:0.25rem;font-size:0.85rem;color:var(--light);">
              When Advanced Components is off, this is the full arrow weight (shaft + point + components).
            </small>
          </div>
          <div><label>Point Weight (grains)</label><input type="number" id="pointWeight" value="125" step="0.5"></div>
          <div><label>Balance Point from Nock (in)</label><input type="number" id="balancePoint" value="18.5" step="0.05"></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:space-between;">
          <label>Advanced Arrow Components</label>
          <label class="toggle-switch"><input type="checkbox" id="toggleArrow"><span class="slider"></span></label>
        </div>
        <div id="arrowAdvanced" class="advanced">
          <div class="grid-2">
            <div><label>Bare Shaft</label><input type="number" id="bareShaft" value="0" step="0.1"></div>
            <div><label>Nock System</label><input type="number" id="nockWeight" value="0" step="0.1"></div>
            <div><label>Wrap</label><input type="number" id="wrapWeight" value="0" step="0.1"></div>
            <div><label>Vane Weight (each)</label><input type="number" id="vaneWeightEach" value="0" step="0.1"></div>
            <div><label>Vane Count</label><input type="number" id="vaneCount" value="0" step="1"></div>
            <div><label>Insert/Outsert</label><input type="number" id="insertWeight" value="0" step="0.5"></div>
            <div><label>Glue / Pin Nock</label><input type="number" id="glueWeight" value="0" step="0.5"></div>
          </div>
          <p style="text-align:right;font-weight:600;">Total: <span id="arrowTotal">0.0</span> grains</p>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><h2>Notes</h2></div>
        <textarea id="notes" rows="4" placeholder="Tuning notes, chronograph data..."></textarea>
        <small style="display:block;margin-top:0.35rem;font-size:0.85rem;color:var(--light);">
          Notes are saved with your build.
        </small>
      </div>
    </div>

    <!-- RIGHT: OUTPUTS -->
    <div id="outputs-column">
      <!-- Arrow Efficiency -->
      <div class="card">
        <div class="card-header"><h2>Arrow Efficiency</h2></div>
        <div class="grid-2" style="text-align:center;">
          <div class="card">
            <h3 style="color:var(--primary);">Actual Launch FPS</h3>
            <input type="number" id="actualFPS" step="0.1" style="font-size:2.5rem;text-align:center;border:3px solid var(--primary);border-radius:12px;padding:0.5rem;">
            <button class="btn-small btn-refresh" id="recalcFPS">Recalculate</button>
            <small id="fpsSource" style="display:block;margin-top:0.35rem;font-size:0.85rem;color:var(--light);">
              Estimated from IBO, draw, arrow &amp; string weight
            </small>
          </div>
          <div class="card">
            <h3 style="color:var(--success);">GPP</h3>
            <div style="font-size:2.5rem;" id="gppValue">-</div>
            <small id="gppHint" style="display:block;margin-top:0.25rem;font-size:0.85rem;color:var(--light);"></small>
          </div>
          <div class="card">
            <h3 style="color:var(--warning);">GPI</h3>
            <div style="font-size:2.5rem;" id="gpiValue">-</div>
          </div>
          <div class="card">
            <h3>Total Weight</h3>
            <div style="font-size:2.5rem;" id="finalArrowWeight">-</div>
          </div>
        </div>
      </div>

      <!-- FOC -->
      <div class="card">
        <div class="card-header"><h2>Front of Center (FOC)</h2></div>
        <div style="text-align:center;">
          <div style="font-size:5rem;font-weight:bold;color:var(--primary);" id="focValue">-</div>
          <svg width="100%" height="160" viewBox="0 0 500 160" style="max-width:500px;margin:1rem auto;border:2px solid var(--border);border-radius:12px;">
            <rect x="50" y="70" width="400" height="20" fill="#e2e8f0" rx="10"/>
            <circle cx="250" cy="80" r="16" fill="var(--warning)" stroke="white" stroke-width="4"/>
            <circle id="balanceMarker" cx="250" cy="80" r="20" fill="var(--primary)" stroke="white" stroke-width="5"/>
            <text id="balanceText" x="250" y="130" text-anchor="middle" fill="var(--primary)" font-weight="bold" font-size="20">-</text>
            <rect x="320" y="60" width="130" height="40" fill="var(--success)" opacity="0.25" rx="15"/>
            <text x="385" y="85" text-anchor="middle" fill="var(--success)" font-weight="bold" font-size="16">12-18% Ideal</text>
          </svg>
        </div>
      </div>

      <!-- Arrow Weight Composition -->
      <div class="card">
        <div class="card-header"><h2>Arrow Weight Composition</h2></div>
        <div style="text-align:center;">
          <svg width="100%" height="200" viewBox="0 0 500 200" style="max-width:500px;margin:1.5rem auto;border:2px solid var(--border);border-radius:12px;">
            <rect x="50" y="90" width="400" height="20" fill="#e2e8f0" rx="10"/>
            <rect x="50" y="90" width="0" height="20" fill="#94a3b8" rx="10" id="shaftBar"/>
            <rect x="50" y="90" width="0" height="20" fill="#0ea5e9" rx="10" id="pointBar"/>
            <rect x="50" y="90" width="0" height="20" fill="#22c55e" rx="10" id="compBar"/>
            <text x="250" y="65" text-anchor="middle" fill="var(--text)" font-size="16" font-weight="600">Arrow Weight Composition</text>
            <text x="150" y="135" text-anchor="middle" fill="#1e293b" class="light-only" font-weight="bold" font-size="15" id="shaftLabel">Shaft: 0%</text>
            <text x="250" y="135" text-anchor="middle" fill="#1e293b" class="light-only" font-weight="bold" font-size="15" id="pointLabel">Point: 0%</text>
            <text x="350" y="135" text-anchor="middle" fill="#1e293b" class="light-only" font-weight="bold" font-size="15" id="compLabel">Components: 0%</text>
            <text x="150" y="135" text-anchor="middle" fill="#e2e8f0" class="dark-only" font-weight="bold" font-size="15" id="shaftLabel-dark">Shaft: 0%</text>
            <text x="250" y="135" text-anchor="middle" fill="#e2e8f0" class="dark-only" font-weight="bold" font-size="15" id="pointLabel-dark">Point: 0%</text>
            <text x="350" y="135" text-anchor="middle" fill="#e2e8f0" class="dark-only" font-weight="bold" font-size="15" id="compLabel-dark">Components: 0%</text>
          </svg>
        </div>
      </div>

      <!-- Velocity, Trajectory & Impact (card-only version) -->
      <div class="card">
        <div class="card-header">
          <h2>Velocity, Trajectory & Impact @ <span id="distanceValue">50</span> yards</h2>
        </div>

        <!-- Distance slider -->
        <input type="range" id="distanceSlider" min="0" max="120" value="50" list="distanceTicks" style="width:100%;">
        <datalist id="distanceTicks">
          <option value="0" label="0"></option>
          <option value="20" label="20"></option>
          <option value="40" label="40"></option>
          <option value="60" label="60"></option>
          <option value="80" label="80"></option>
          <option value="100" label="100"></option>
          <option value="120" label="120"></option>
        </datalist>

        <!-- NEW: simple metric cards for velocity & peak height -->
        <div class="grid-2" style="margin-top:1.25rem;">
          <div class="card text-center">
            <h3>Velocity @ <span id="velocityDistanceLabel">50</span> yd</h3>
            <div style="font-size:3rem;" id="velocityAtDistance">-</div>
            <small>FPS (estimated at target)</small>
          </div>
          <div class="card text-center">
            <h3>Peak Height on Flight</h3>
            <div style="font-size:3rem;" id="peakHeightValue">-</div>
              <small>
                ft above line • highest point at
                <span id="peakDistanceValue">-</span> yd before the target
              </small>
          </div>
        </div>

        <!-- Existing KE / impact cards -->
        <div class="grid-2" style="margin-top:1rem;">
          <div class="card text-center">
            <h3 style="color:var(--success);">Launch KE</h3>
            <div style="font-size:3rem;" id="keValue">-</div>
            <small>ft-lbs</small>
          </div>
          <div class="card text-center">
            <h3 style="color:var(--warning);">Time to Impact</h3>
            <div style="font-size:3rem;" id="timeToImpact">-</div>
            <small>seconds</small>
          </div>
          <div class="card text-center">
            <h3 style="color:var(--primary);">Impact KE</h3>
            <div style="font-size:3rem;" id="impactKE">-</div>
            <small>ft-lbs</small>
          </div>
          <div class="card text-center">
            <h3 style="color:var(--danger);">Impact Momentum</h3>
            <div style="font-size:3rem;" id="impactMom">-</div>
            <small>slug·ft/s</small>
          </div>
        </div>
      </div>

      <!-- Game Effectiveness -->
      <div class="card">
        <div class="card-header"><h2>Game Effectiveness</h2></div>

        <div style="margin-bottom:0.75rem;font-size:0.95rem;color:var(--light);">
          Impact @ <span id="gameDistanceDisplay">50</span> yd:
          <span id="gameKE">–</span> ft-lbs,
          <span id="gameMom">–</span> slug·ft/s
        </div>

        <div class="grid-2" style="text-align:center; gap:1rem;">
          <div class="card">
            <h3 style="color:var(--success); margin:0;">Small / Thin-skinned</h3>
            <div style="font-size:1.1rem; margin:0.5rem 0;">Min: 25 ft-lbs • 0.30 slug·ft/s</div>
            <div style="font-size:2.8rem; font-weight:bold;" id="smallGameStatus">Send it</div>
          </div>

          <div class="card">
            <h3 style="color:var(--primary); margin:0;">Medium Game</h3>
            <div style="font-size:1.1rem; margin:0.5rem 0;">Min: 50 ft-lbs • 0.45 slug·ft/s</div>
            <div style="font-size:2.8rem; font-weight:bold;" id="deerStatus">Send it</div>
          </div>

          <div class="card">
            <h3 style="color:var(--warning); margin:0;">Large / Tough Game</h3>
            <div style="font-size:1.1rem; margin:0.5rem 0;">Min: 65 ft-lbs • 0.60 slug·ft/s</div>
            <div style="font-size:2.8rem; font-weight:bold;" id="elkStatus">Send it</div>
          </div>

          <div class="card">
            <h3 style="color:var(--danger); margin:0;">Dangerous / Extreme</h3>
            <div style="font-size:1.1rem; margin:0.5rem 0;">Min: 85 ft-lbs • 0.75 slug·ft/s</div>
            <div style="font-size:2.8rem; font-weight:bold;" id="mooseStatus">Send it</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><h2>Build Summary</h2><button class="btn-small" id="copySummary">Copy</button></div>
        <div id="summaryTable" style="font-size:1rem;"></div>
      </div>
    </div>
  </div>

  <a href="https://www.patreon.com/cw/ArrowTuneCalculator" target="_blank" class="patreon-btn">Support on Patreon</a>

  <div id="toast"></div>

<script>
  let toastTimer;
  function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.style.opacity = '1';
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => { toast.style.opacity = '0'; }, 2000);
  }

  // Dark mode
  const darkToggle = document.getElementById('darkModeToggle');
  if (localStorage.getItem('dark')==='1' || (!localStorage.getItem('dark') && matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.body.classList.add('dark'); darkToggle.checked = true;
  }
  darkToggle.addEventListener('change', () => {
    document.body.classList.toggle('dark', darkToggle.checked);
    localStorage.setItem('dark', darkToggle.checked ? '1' : '0');
  });

  // Build system
  const loadSelect = document.getElementById('loadBuildSelect');
  function refreshBuilds() {
    loadSelect.innerHTML = '<option value="">– Load Build –</option>';
    const builds = JSON.parse(localStorage.getItem('atc') || '{}');
    const keys = Object.keys(builds).sort();

    if (keys.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'No saved builds yet';
      opt.disabled = true;
      loadSelect.appendChild(opt);
      return;
    }

    keys.forEach(n => {
      const o = document.createElement('option'); o.value = n; o.textContent = n; loadSelect.appendChild(o);
    });
  }

  // Arrow weight mode UI
  function updateArrowWeightMode() {
    const toggle = document.getElementById('toggleArrow');
    const simpleTotal = document.getElementById('totalArrowWeightSimple');
    const hint = document.getElementById('totalWeightHint');
    const isAdv = toggle.checked;

    if (isAdv) {
      simpleTotal.readOnly = true;
      simpleTotal.style.opacity = 0.6;
      hint.textContent = 'In Advanced mode, total arrow weight is calculated from shaft, vanes, insert, nock, wrap, glue, and point.';
    } else {
      simpleTotal.readOnly = false;
      simpleTotal.style.opacity = 1;
      hint.textContent = 'When Advanced Components is off, this is the full arrow weight (shaft + point + components).';
    }
  }

  // Show/hide advanced sections + recalc
  document.getElementById('toggleString').onchange = e => {
    document.getElementById('stringAdvanced').style.display = e.target.checked ? 'block' : 'none';
    calculateEverything();
  };

  document.getElementById('toggleArrow').onchange = e => {
    document.getElementById('arrowAdvanced').style.display = e.target.checked ? 'block' : 'none';
    updateArrowWeightMode();
    calculateEverything();
  };

  // Save build (with checkbox support & overwrite confirmation)
  document.getElementById('saveBuild').onclick = () => {
    const n = document.getElementById('buildName').value.trim();
    if (!n) return alert('Name required');
    const all = JSON.parse(localStorage.getItem('atc') || '{}');

    if (all[n] && !confirm(`Overwrite existing build "${n}"?`)) {
      return;
    }

    const data = {};
    document.querySelectorAll('input,select,textarea').forEach(el => {
      if (!el.id) return;
      if (el.type === 'checkbox') {
        data[el.id] = { type: 'checkbox', checked: el.checked };
      } else {
        data[el.id] = { type: 'value', value: el.value };
      }
    });

    all[n] = data;
    localStorage.setItem('atc', JSON.stringify(all));
    showToast('Build saved');
    refreshBuilds();
  };

  // Load build (handles new structured format + legacy simple values)
  loadSelect.onchange = () => {
    const n = loadSelect.value;
    if (!n) return;
    const all = JSON.parse(localStorage.getItem('atc') || '{}');
    const d = all[n];
    if (!d) return;

    Object.keys(d).forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;

      const stored = d[id];

      if (stored && typeof stored === 'object' && 'type' in stored) {
        if (stored.type === 'checkbox') {
          el.checked = !!stored.checked;
          el.dispatchEvent(new Event('change'));
        } else {
          el.value = stored.value ?? '';
        }
      } else {
        if (el.type !== 'checkbox') {
          el.value = stored ?? '';
        }
      }
    });

    updateArrowWeightMode();
    calculateEverything();
    showToast('Build loaded');
  };

  document.getElementById('deleteBuild').onclick = () => {
    const n = loadSelect.value;
    if (!n || !confirm('Delete this build?')) return;
    const all = JSON.parse(localStorage.getItem('atc') || '{}');
    delete all[n];
    localStorage.setItem('atc', JSON.stringify(all));
    refreshBuilds();
    showToast('Build deleted');
  };

  // Suggest Name
  document.getElementById('suggestName').onclick = () => {
    const d = new Date().toISOString().slice(0,10);
    const b = document.getElementById('bowModel').value.trim() || 'Bow';
    const dw = document.getElementById('drawWeight').value || '70';
    const arrow = document.getElementById('arrowName').value.trim() || 'Arrow';
    const weight = getArrowWeight().toFixed(0);
    document.getElementById('buildName').value = `${d} ${b} ${dw}lb ${arrow} ${weight}gr`;
  };

  // FPS source indicators
  const fpsInput = document.getElementById('actualFPS');
  const fpsSource = document.getElementById('fpsSource');

  function markFpsEstimated() {
    fpsSource.textContent = 'Estimated from IBO, draw, arrow & string weight';
  }

  function markFpsChrono() {
    fpsSource.textContent = 'Using manual FPS (chronograph)';
  }

  // Arrow weight helper
  function getArrowWeight() {
    const pointWeight = parseFloat(document.getElementById('pointWeight').value) || 125;

    if (document.getElementById('toggleArrow').checked) {
      const bare   = parseFloat(document.getElementById('bareShaft').value)        || 0;
      const nock   = parseFloat(document.getElementById('nockWeight').value)       || 0;
      const wrap   = parseFloat(document.getElementById('wrapWeight').value)       || 0;
      const vanes  = (parseFloat(document.getElementById('vaneWeightEach').value)  || 0) *
                     (parseFloat(document.getElementById('vaneCount').value)       || 0);
      const insert = parseFloat(document.getElementById('insertWeight').value)     || 0;
      const glue   = parseFloat(document.getElementById('glueWeight').value)       || 0;

      const advTotal = bare + nock + wrap + vanes + insert + glue;

      document.getElementById('arrowTotal').textContent = advTotal.toFixed(1);

      return advTotal + pointWeight;
    }

    return parseFloat(document.getElementById('totalArrowWeightSimple').value) || 0;
  }

  function calculateEverything(recalcFPS = false) {
    const len = parseFloat(document.getElementById('arrowLength').value) || 28;
    const weight = getArrowWeight();
    const balance = parseFloat(document.getElementById('balancePoint').value) || 18.5;
    const ibo = parseFloat(document.getElementById('iboRating').value) || 350;
    const dw = parseFloat(document.getElementById('drawWeight').value) || 70;
    const stringW = document.getElementById('toggleString').checked ?
      ['peepWeight','dloopWeight','kisserWeight','silencersWeight'].reduce((a,id)=>a+(parseFloat(document.getElementById(id).value)||0),0) :
      parseFloat(document.getElementById('stringWeightSimple').value) || 25;

    if (document.getElementById('toggleString').checked) {
      const total = ['peepWeight','dloopWeight','kisserWeight','silencersWeight'].reduce((a,id)=>a+(parseFloat(document.getElementById(id).value)||0),0);
      document.getElementById('stringTotal').textContent = total;
    }

    let fps = parseFloat(fpsInput.value);
    if (recalcFPS || isNaN(fps) || fps <= 0) {
      const base = ibo * Math.sqrt((450 + stringW) / (450 + weight + stringW));
      fps = base * 0.94;
      fpsInput.value = fps.toFixed(1);
      markFpsEstimated();
    }

    const foc = ((balance - len/2) / len) * 100;
    document.getElementById('focValue').textContent = foc.toFixed(1) + '%';
    document.getElementById('balanceMarker').setAttribute('cx', 50 + (balance/len)*400);
    document.getElementById('balanceText').textContent = balance.toFixed(2) + '"';

    const gpp = weight / dw;
    const gpi = weight / len;
    document.getElementById('gppValue').textContent = gpp.toFixed(1);
    document.getElementById('gpiValue').textContent = gpi.toFixed(1);
    document.getElementById('finalArrowWeight').textContent = weight.toFixed(1) + ' gr';

    // GPP hint
    const gppHint = document.getElementById('gppHint');
    let gppText = '';
    let gppColor = 'var(--light)';

    if (gpp < 5) {
      gppText = 'Very light – often not recommended for most hunting bows.';
      gppColor = 'var(--danger)';
    } else if (gpp < 6) {
      gppText = 'Light arrow – flatter trajectory, more 3D/target style.';
    } else if (gpp <= 8) {
      gppText = 'Solid all-around hunting weight.';
      gppColor = 'var(--success)';
    } else {
      gppText = 'Heavy arrow – penetration-focused setups.';
    }
    gppHint.textContent = gppText;
    gppHint.style.color = gppColor;

    const launchKE = (weight * fps * fps) / 450240;
    const launchMom = (weight * fps) / 225400;
    document.getElementById('keValue').textContent = launchKE.toFixed(1);

    const distYards = parseFloat(document.getElementById('distanceSlider').value) || 50;
    document.getElementById('distanceValue').textContent = distYards;

    const currentV = fps * Math.exp(-distYards/300);
    const impactKE = (weight * currentV * currentV) / 450240;
    const impactMom = (weight * currentV) / 225400;
    const time = (distYards * 3) / (fps * 0.8);

    document.getElementById('impactKE').textContent = impactKE.toFixed(1);
    document.getElementById('impactMom').textContent = impactMom.toFixed(3);
    document.getElementById('timeToImpact').textContent = time.toFixed(2);

    // Velocity card
    document.getElementById('velocityDistanceLabel').textContent = distYards;
    document.getElementById('velocityAtDistance').textContent = currentV.toFixed(0);

    // --- New: closed-form projectile peak height ---
    // Use feet for distance and ft/s for speed
    const g = 32.174;              // ft/s^2
    const v0 = fps;                // ft/s
    const R_ft = distYards * 3;    // yards -> feet

    let peakHeightFt = 0;
    let peakYard = 0;

    if (v0 > 0 && R_ft > 0) {
      // Range equation: R = v0^2 * sin(2θ) / g
      // => sin(2θ) = R * g / v0^2
      let sin2theta = (R_ft * g) / (v0 * v0);

      if (sin2theta > 0) {
        // Clamp to [0,1] in case of tiny numeric overshoot
        sin2theta = Math.min(1, Math.max(0, sin2theta));

        const theta = 0.5 * Math.asin(sin2theta); // radians
        const sinTheta = Math.sin(theta);

        // H_max = v0^2 * sin^2(θ) / (2g)
        peakHeightFt = (v0 * v0 * sinTheta * sinTheta) / (2 * g);

        // For a symmetric trajectory (start & end at same height),
        // the apex is halfway to the target.
        peakYard = distYards / 2;
      }
    }

    document.getElementById('peakHeightValue').textContent = peakHeightFt.toFixed(1);
    document.getElementById('peakDistanceValue').textContent = peakYard.toFixed(0);

    // Game effectiveness header
    document.getElementById('gameDistanceDisplay').textContent = distYards;
    document.getElementById('gameKE').textContent = impactKE.toFixed(1);
    document.getElementById('gameMom').textContent = impactMom.toFixed(3);

    // Arrow Weight Composition
    const isAdv = document.getElementById('toggleArrow').checked;
    let shaft = 0, point = 0, comp = 0;
    if (isAdv) {
      shaft = parseFloat(document.getElementById('bareShaft').value) || 0;
      const nock = parseFloat(document.getElementById('nockWeight').value) || 0;
      const wrap = parseFloat(document.getElementById('wrapWeight').value) || 0;
      const vanes = (parseFloat(document.getElementById('vaneWeightEach').value) || 0) *
                    (parseFloat(document.getElementById('vaneCount').value) || 0);
      const insert = parseFloat(document.getElementById('insertWeight').value) || 0;
      const glue = parseFloat(document.getElementById('glueWeight').value) || 0;
      comp = nock + wrap + vanes + insert + glue;
      point = parseFloat(document.getElementById('pointWeight').value) || 125;
    } else {
      point = parseFloat(document.getElementById('pointWeight').value) || 125;
      shaft = weight - point;
      comp = 0;
    }

    const totalW = 400;
    const shaftW = (shaft / weight) * totalW;
    const pointW = (point / weight) * totalW;
    const compW = (comp / weight) * totalW;

    document.getElementById('shaftBar').setAttribute('width', shaftW);
    document.getElementById('pointBar').setAttribute('x', 50 + shaftW);
    document.getElementById('pointBar').setAttribute('width', pointW);
    document.getElementById('compBar').setAttribute('x', 50 + shaftW + pointW);
    document.getElementById('compBar').setAttribute('width', compW);

    document.getElementById('shaftLabel').textContent = `Shaft: ${((shaft/weight)*100).toFixed(0)}%`;
    document.getElementById('pointLabel').textContent = `Point: ${((point/weight)*100).toFixed(0)}%`;
    document.getElementById('compLabel').textContent = `Comp.: ${((comp/weight)*100).toFixed(0)}%`;

    // Game Effectiveness
    const games = [
      { ke: 25, mom: 0.30, id: "smallGameStatus" },
      { ke: 50, mom: 0.45, id: "deerStatus" },
      { ke: 65, mom: 0.60, id: "elkStatus" },
      { ke: 85, mom: 0.75, id: "mooseStatus" }
    ];

    games.forEach(g => {
      const ok = impactKE >= g.ke && impactMom >= g.mom;
      const el = document.getElementById(g.id);
      el.textContent = ok ? "Send it" : "Don’t";
      el.style.color = ok ? "var(--success)" : "var(--danger)";
    });

    // Build Summary
    const summary = {
      "Build Name": document.getElementById('buildName').value || "Unnamed",
      "Bow Model": document.getElementById('bowModel').value || "-",
      "Draw Weight": dw + " lbs",
      "IBO Speed": ibo + " FPS",
      "Arrow Length": len.toFixed(2) + " in",
      "Total Arrow Weight": weight.toFixed(1) + " gr",
      "Point Weight": (parseFloat(document.getElementById('pointWeight').value) || 125).toFixed(0) + " gr",
      "FOC": foc.toFixed(1) + "%",
      "GPP": gpp.toFixed(1),
      "GPI": gpi.toFixed(1),
      "Launch FPS": fps.toFixed(1),
      "Launch KE": launchKE.toFixed(1) + " ft-lbs",
      "Launch Momentum": launchMom.toFixed(3) + " slug·ft/s",
      [`Impact @ ${distYards} yd`]: "",
      "Impact Velocity": currentV.toFixed(0) + " FPS",
      "Impact KE": impactKE.toFixed(1) + " ft-lbs",
      "Impact Momentum": impactMom.toFixed(3) + " slug·ft/s",
      "Time to Impact": time.toFixed(2) + " s"
    };

    document.getElementById('summaryTable').innerHTML = '<table>' +
      Object.entries(summary).map(([k,v]) =>
        `<tr><td style="font-weight:600;padding:0.5rem;">${k}</td><td style="text-align:right;padding:0.5rem;">${v}</td></tr>`
      ).join('') + '</table>';
  }

  // Recalculate button
  document.getElementById('recalcFPS').onclick = () => calculateEverything(true);

  // Copy to clipboard
  document.getElementById('copySummary').onclick = () => {
    const text = `Arrow Tune Build - ${new Date().toLocaleDateString()}\n\n` +
      `Build: ${document.getElementById('buildName').value||"Unnamed"}\n` +
      `FPS: ${document.getElementById('actualFPS').value}\n` +
      `Weight: ${getArrowWeight().toFixed(1)} gr\n` +
      `FOC: ${document.getElementById('focValue').textContent}\n` +
      `Launch KE: ${document.getElementById('keValue').textContent} ft-lbs\n` +
      `Impact KE @ ${document.getElementById('distanceValue').textContent}yd: ${document.getElementById('impactKE').textContent} ft-lbs\n` +
      `Time to Impact: ${document.getElementById('timeToImpact').textContent}s`;
    navigator.clipboard.writeText(text).then(()=>showToast('Summary copied'));
  };

  // Distance slider
  document.getElementById('distanceSlider').oninput = e => {
    document.getElementById('distanceValue').textContent = e.target.value;
    calculateEverything();
  };

  // All inputs trigger calculation (FPS stays manual if you're actively editing it)
  document.querySelectorAll('input,select,textarea').forEach(el => {
    el.addEventListener('input', () => {
      if (document.activeElement.id === 'actualFPS') {
        markFpsChrono();
        calculateEverything(false);
      } else {
        calculateEverything();
      }
    });
  });

  // Init
  refreshBuilds();
  updateArrowWeightMode();
  calculateEverything(true);
</script>
</body>
</html>