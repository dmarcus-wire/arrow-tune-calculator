<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArrowForge – Smart Arrow Tuner</title>
  <meta name="description" content="Offline-first archery calculator with AI advisor. Perfect arrow tuning made simple.">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQXJyb3dGb3JnZSIsInNob3J0X25hbWUiOiJBcnJvd0ZvcmdlIiwic3RhcnRfdXJsIjoiaHR0cHM6Ly9hIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCxiYXNlNjQsdmFsdWUiOiJkYXRhOmltYWdlL3N2Zyt4bWwgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCB5PSIuOWVtIiBmb250LXNpemU9IjkwIj7wn5iBLTwvdGV4dD48L3N2Zz4iLCJzaXplcyI6IjEyOHgxMjgiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCIsInB1cnBvc2UiOiJhbnkgbWFza2FibGUifV19">
  <link href="https://rsms.me/inter/inter.css" rel="stylesheet">
  <style>
    :root {
      --bg:#f8fafc; --card:#ffffff; --text:#1e293b; --light:#64748b; --border:#e2e8f0;
      --primary:#0ea5e9; --success:#22c55e; --warning:#f59e0b; --danger:#ef4444; --purple:#8b5cf6;
    }
    .dark {
      --bg:#0f172a; --card:#020617; --text:#e2e8f0; --light:#94a3b8; --border:#1e293b;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Inter',sans-serif;
      background:var(--bg);
      color:var(--text);
      padding:0.5rem;
      min-height:100vh;
    }
    .container {
      max-width:1600px;
      margin:auto;
      display:grid;
      gap:1rem 1.5rem;
    }
    @media (max-width:1023px) { .container { grid-template-columns:1fr; } }
    @media (min-width:1024px) { .container { grid-template-columns:460px 1fr; } }
    .card {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:1rem;
      box-shadow:0 4px 12px rgba(15,23,42,0.08);
    }

    /* Minimal tick marks for range sliders */
    input[type="range"] {
      -webkit-appearance: none; /* Remove default styling */
      appearance: none;
      background: linear-gradient(to right, 
        transparent 0%, 
        transparent 4%, 
        var(--light) 4%, 
        var(--light) 6%, 
        transparent 6%, 
        transparent 100%
      ) repeat-x;
      background-size: 10% 6px; /* Adjust for interval spacing (10% = every 10 units on 0-100 scale) */
      background-position: 0 center;
    }

    /* Optional: make ticks even subtler */
    .dark input[type="range"] {
      background-color: var(--border);
    }

    #inputs-column .card { padding:0.8rem; }
    #inputs-column input, #inputs-column select { padding:0.5rem; font-size:0.95rem; }
    #outputs-column .card { padding:1.25rem; }
    #outputs-column h2 { font-size:1.4rem; margin-bottom:1rem; }
    .card-header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.75rem; }
    h1 { font-size:1.5rem; margin:0; }
    input, select {
      width:100%;
      border:1px solid var(--border);
      border-radius:8px;
      background:var(--card);
      color:var(--text);
      padding:0.5rem;
    }
    .input-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:0.5rem 0;
      gap:0.75rem;
    }
    .input-row label {
      margin:0;
      font-weight:600;
      font-size:0.95rem;
      white-space:nowrap;
      color:var(--text);
      flex-shrink:0;
    }
    .input-row label::after { content:":"; margin-left:0.25rem; color:var(--light); }
    .input-row input, .input-row select {
      flex:1;
      min-width:140px;
      text-align:right;
      font-size:1rem;
    }
    @media (min-width:769px) {
      .input-row { gap:1rem; }
      .input-row input, .input-row select { max-width:240px; text-align:left; font-size:1.05rem; }
      .input-row label { font-size:1rem; }
    }
    .collapsible-trigger {
      cursor:pointer;
      padding:0.75rem 0 0.5rem;
      margin-top:0.75rem;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:600;
      color:var(--primary);
    }
    .collapsible-trigger .chevron {
      font-size:1.5rem;
      transition:transform 0.25s ease;
      color:var(--light);
    }
    .collapsible-trigger.open .chevron { transform:rotate(90deg); }
    .collapsible-content { display:none; padding-top:0.5rem; }
    .collapsible-trigger.open + .collapsible-content { display:block; }
    @media (max-width:768px) {
      .collapsible-mobile .card-content { display:none; }
      .collapsible-mobile.open .card-content { display:block; }
      .mobile-only-trigger {
        display:flex !important;
        cursor:pointer;
        padding:0.75rem 1rem;
        background:var(--card);
        border-top:1px solid var(--border);
        justify-content:space-between;
        align-items:center;
        font-weight:600;
        color:var(--primary);
        margin-top:0.5rem;
        border-radius:0 0 14px 14px;
      }
      .collapsible-mobile.open .mobile-only-trigger .chevron { transform:rotate(90deg); }
    }
    @media (min-width:769px) {
      .mobile-only-trigger { display:none !important; }
      .collapsible-mobile .card-content { display:block !important; }
    }
    .mobile-only-trigger { display:none; }
    button {
      padding:0.5rem 1rem;
      border:none;
      border-radius:999px;
      background:var(--primary);
      color:white;
      font-weight:600;
      font-size:0.95rem;
      line-height:1;
      cursor:pointer;
      min-height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btn-small { padding:0.35rem 0.7rem; font-size:0.85rem; }
    .secondary { background:transparent; color:var(--primary); border:1px solid var(--primary); }
    .flex { display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; }
    .toggle-switch { position:relative; width:50px; height:26px; }
    .toggle-switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; inset:0; background:#cbd5e1; border-radius:34px; transition:.3s; }
    .slider:before { position:absolute; content:""; height:20px; width:20px; left:3px; bottom:3px; background:white; border-radius:50%; transition:.3s; }
    input:checked + .slider { background:var(--primary); }
    input:checked + .slider:before { transform:translateX(24px); }
    .info-overlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.5);
      display:none; align-items:center; justify-content:center; z-index:1000;
    }
    .info-panel {
      background:var(--card);
      border-radius:12px;
      max-width:600px;
      width:90%;
      max-height:90vh;
      padding:1.5rem;
      box-shadow:0 20px 40px rgba(0,0,0,0.3);
      position:relative;
      overflow-y:auto;
    }
    .info-close {
      position:absolute; top:0.8rem; right:1rem;
      background:none; border:none; font-size:1.8rem;
      color:var(--light); cursor:pointer;
    }
  .game-table { width:100%; border-collapse:collapse; font-size:0.95rem; margin-top:0.5rem; }
    .game-table th, .game-table td { padding:0.5rem; text-align:center; border-bottom:1px solid var(--border); }
    .game-table th { background:var(--border); font-weight:600; }
    .send { color:var(--success); font-weight:700; }
    .marginal { color:var(--warning); font-weight:700; }
    .adjust { color:var(--danger); font-weight:700; }
  
  .stats-list { display:flex; flex-direction:column; gap:0.75rem; }
  .stat-item { }
    .bar {
      height:12px;
      border-radius:999px;
      background:var(--border);
      position:relative;
      overflow:visible; /* changed from hidden */
    }

    .stat-row {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .stat-title {
      width: 120px; /* fixed width for all titles — adjust as needed */
      text-align: right;
      flex-shrink: 0;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 0.5rem;
    }

    .stat-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .bar-fill {
      height:100%;
      border-radius:999px;
      transition:width 0.3s ease;
    }
    .sweet-spot {
      position:absolute;
      top:0; 
      left:40%; /* 12% of 30% scale = 40% position */
      width:20%; /* 6% range (18-12) = 20% of bar */
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
    }

    .bar-labels {
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      margin-top: 0.3rem;
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--light);
      pointer-events: none;
    }

    .gpp-sweet-spot {
      position:absolute;
      top:0; 
      left:30%; /* 6.5 on 5-10 scale = 30% position */
      width:20%; /* 1 unit range (7.5-6.5) = 20% of bar */
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
    }

    .gpi-sweet-spot {
      position:absolute;
      top:0; 
      left:35%; /* 7 GPI = 35% of 0–20 scale */
      width:12.5%; /* 2.5 unit range (9.5-7) = 12.5% of bar */
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
    }

    .totalwt-sweet-spot {
      position:absolute;
      top:0; left:31.58%; /* 350 on 50-1000 scale = ~31.58% */
      width:21.05%; /* 200 unit range (550-350) = ~21.05% of bar */
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
    }

    .stiffness-sweet-spot {
      position:absolute;
      top:0; 
      left:25%;
      width:50%;
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
    }

    .flatness-sweet-spot {
        position: absolute;
        top: 0;
        left: 33.33%; /* starts at ~4.5 ft on the bar (right = flatter) */
        width: 66.67%; /* covers from ~4.5 ft to 0 ft (Very Flat) */
        height: 100%;
        background: rgba(34,197,94,0.25);
        border-radius: 999px;
      }

    .group-stability-sweet-spot {
      position: absolute;
      top: 0;
      left: 66.67%; /* starts at 2/3 mark */
      width: 33.33%; /* covers 2 to 3 */
      height: 100%;
      background: rgba(34,197,94,0.25);
      border-radius: 999px;
    }

    .drop-table {
      width:100%;
      border-collapse:collapse;
      margin-top:0.5rem;
      font-size:0.95rem;
    }
    .drop-table th, .drop-table td {
      padding:0.4rem;
      text-align:center;
      border:1px solid var(--border);
    }
    .drop-table th {
      background:var(--border);
      font-weight:600;
    }

    .bar-marker {
      position: absolute;
      top: 0;
      width: 4px;
      height: 100%;
      background: #ef4444; /* red (same as your --danger) */
      border-radius: 2px;
      transform: translateX(-50%);
      transition: left 0.3s ease;
    }

      /* Re-use your existing Quick Stats bar styles, just add fill */
      .bar-fill {
        height: 100%;
        width: 0;
        background: var(--primary);
        border-radius: 999px;
        transition: width 0.3s ease;
      }

      /* Green fill for effective load */
      #effectiveLoadFill {
        background: var(--success) !important;
      }

    .stat-bar-container {
      width: 100%; /* takes full width of the flex item */
      min-width: 240px; /* minimum for small screens */
      max-width: 1000px; /* maximum for large screens — adjust if you want wider */
      margin-right: 0;
      position: relative;
    }

    @media (max-width: 768px) {
      .stat-bar-container {
        max-width: 300px; /* slightly smaller on mobile */
      }
    }

    .info-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem; /* smaller and consistent with text */
      color: var(--primary);
      padding: 0;
      margin-left: 0.4rem;
      line-height: 1;
      opacity: 0.8;
      transition: opacity 0.2s ease;
    }

    .info-btn:hover {
      opacity: 1;
    }

    /* Ensure it looks good in dark mode too */
    .dark .info-btn {
      color: var(--primary);
      opacity: 0.8;
    }

    .dark .info-btn:hover {
      opacity: 1;
    }

    .moving-value {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: .85rem;
      font-weight: 400;
      opacity: 0.9;
      color: var(--text);
      white-space: nowrap;
      pointer-events: none;
      transition: left 0.3s ease;
      z-index: 10;
    }

    .bar-marker {
      background: #ef4444; /* red */
    }

    /* Better spacing for Group Stability 0-1-2-3 labels */
    #groupStabilityValue ~ .stat-bar-container .bar-labels {
      justify-content: space-between;
      width: 100%;
      padding: 0 4px; /* small padding so labels don't touch edges */
    }

    #groupStabilityValue ~ .stat-bar-container .bar-labels span:nth-child(1) { left: 0%; }
    #groupStabilityValue ~ .stat-bar-container .bar-labels span:nth-child(2) { left: 33.33%; }
    #groupStabilityValue ~ .stat-bar-container .bar-labels span:nth-child(3) { left: 66.67%; }
    #groupStabilityValue ~ .stat-bar-container .bar-labels span:nth-child(4) { left: 100%; }

    #groupStabilityValue ~ .stat-bar-container .bar-labels span {
      position: absolute;
      transform: translateX(-50%);
      font-size: 0.85rem;
      color: var(--light);
    }

    #groupStabilityValue ~ .stat-bar-container .bar-labels span:nth-child(4) {
      transform: translateX(-100%); /* align "3" to the right edge */
    }

    .effective-load-sweet-spot {
      position:absolute;
      top:0; left:30%;
      width:50%;
      height:100%;
      background:rgba(34,197,94,0.25);
      border-radius:999px;
    }

    /* Make Effective Draw Weight titles match Game Effectiveness class names */
    .effective-dw-title {
      font-weight: 400;
      font-size: .95rem;
      color: var(--text);
    }
  </style>
</head>
<body>
<div class="container">
  <div id="inputs-column">
    <div class="card">
      <div class="card-header">
        <h1>ArrowForge</h1>
        <div class="flex">
          <span style="color:var(--light);">Light</span>
          <label class="toggle-switch">
            <input type="checkbox" id="darkToggle"><span class="slider"></span>
          </label>
          <span style="color:var(--light);">Dark</span>
          <button id="aiButton" class="btn-small" style="background:var(--purple);">AI Advisor</button>
        </div>
      </div>
      <p style="color:var(--light);font-size:0.85rem;">Offline • Live • v0.0.8</p>
    </div>
    <div class="card">
      <h2>Build</h2>
      <div class="input-row">
        <label for="buildName">Build Name</label>
        <div class="flex" style="gap:0.5rem;">
          <input type="text" id="buildName" placeholder="e.g. 2025 Elk Slayer">
          <button class="btn-small secondary">Suggest</button>
        </div>
      </div>
      <div class="flex" style="margin-top:0.75rem; gap:0.5rem;">
        <button id="saveBuild">Save</button>
        <select id="loadBuild" style="flex:1;"><option>– Load Build –</option></select>
        <button id="deleteBuild" style="background:var(--danger);">Delete</button>
      </div>
    </div>
    <div class="card collapsible-mobile" id="bowCard">
      <h2 style="margin:0 0 0.75rem 0;">Bow</h2>
      <div class="card-content">
        <div class="input-row"><label for="appType">Application</label><select id="appType"><option>Target</option><option selected>Hunting</option><option>Other</option></select></div>
        <div class="input-row"><label for="bowModel">Model</label><input type="text" id="bowModel" placeholder="Hoyt RX-9"></div>
        <div class="input-row"><label for="ibo">IBO fps</label><input type="number" id="ibo" value="340"></div>
        <div class="input-row"><label for="drawWt">Draw wt lb</label><input type="number" id="drawWt" value="70" step="0.5"></div>
        <div class="input-row"><label for="drawLen">Draw length in</label><input type="number" id="drawLen" value="29" step="0.1"></div>
        <div class="input-row"><label for="stringWt">String add-ons gr</label><input type="number" id="stringWt" value="20"></div>
        <div class="collapsible-trigger" onclick="this.classList.toggle('open'); this.nextElementSibling.style.display = this.classList.contains('open') ? 'block' : 'none';">
          <span>String Details</span>
          <span class="chevron">></span>
        </div>
        <div class="collapsible-content">
          <div class="input-row"><label for="peepWt">Peep weight gr</label><input type="number" id="peepWt" value="0" step="0.5"></div>
          <div class="input-row"><label for="dloopWt">D-loop gr</label><input type="number" id="dloopWt" value="0" step="0.5"></div>
          <div class="input-row"><label for="kisserWt">Kisser gr</label><input type="number" id="kisserWt" value="0" step="0.5"></div>
          <div class="input-row"><label for="silencerWt">Silencers gr</label><input type="number" id="silencerWt" value="0" step="0.5"></div>
          <div class="input-row"><label for="nockWt">Nock weight gr</label><input type="number" id="nockWt" value="0" step="0.5"></div>
        </div>
      </div>
      <div class="mobile-only-trigger" onclick="this.parentElement.classList.toggle('open')">
        <span>Details</span>
        <span class="chevron">></span>
      </div>
    </div>
    <div class="card collapsible-mobile" id="arrowCard">
      <h2 style="margin:0 0 0.75rem 0;">Arrow</h2>
      <div class="card-content">
        <div class="input-row"><label for="arrowName">Name</label><input type="text" id="arrowName" placeholder="Victory VAP TKO"></div>
        <div class="input-row"><label for="spine">Spine</label><input type="number" id="spine" value="300" min="100" max="600" step="10"></div>
        <div class="input-row"><label for="arrowLen">Length in</label><input type="number" id="arrowLen" value="28.5" step="0.1"></div>
        <div class="input-row"><label for="totalWt">Total weight gr</label><input type="number" id="totalWt" value="495" step="0.5"></div>
        <div class="input-row"><label for="pointWt">Point weight gr</label><input type="number" id="pointWt" value="125"></div>
        <div class="input-row"><label for="balancePt">Balance point in</label><input type="number" id="balancePt" value="17.2" step="0.05"></div>
        <div class="collapsible-trigger" onclick="this.classList.toggle('open'); this.nextElementSibling.style.display = this.classList.contains('open') ? 'block' : 'none';">
          <span>Component Details</span>
          <span class="chevron">></span>
        </div>
        <div class="collapsible-content">
          <div class="input-row"><label for="insertWt">Insert/Outsert gr</label><input type="number" id="insertWt" value="0" step="0.5"></div>
          <div class="input-row"><label for="wrapWt">Wrap gr</label><input type="number" id="wrapWt" value="0" step="0.5"></div>
          <div class="input-row"><label for="vaneWt">Vane weight (each) gr</label><input type="number" id="vaneWt" value="0" step="0.1"></div>
          <div class="input-row"><label for="vaneCount">Vane count</label><input type="number" id="vaneCount" value="0"></div>
          <div class="input-row"><label for="glueWt">Glue / Pin gr</label><input type="number" id="glueWt" value="0" step="0.5"></div>
        </div>
      </div>
      <div class="mobile-only-trigger" onclick="this.parentElement.classList.toggle('open')">
        <span>Details</span>
        <span class="chevron">></span>
      </div>
    </div>
  </div>
  <div id="outputs-column">
    <div class="card">
      <h2>Live Settings</h2>
      <div style="margin:1.2rem 0;">
        <div style="display:flex; align-items:center; gap:0.75rem; margin-bottom:0.6rem;">
          <label style="font-weight:600; margin:0;">Actual Speed (fps)</label>
          <button onclick="recalculateAndShowMath()" style="background:none;border:none;cursor:pointer;font-size:1.3rem;color:var(--primary);padding:0;" title="Recalculate and show estimate">Calculate</button>
        </div>
        <div style="display:flex; align-items:center; gap:1rem;">
          <input type="range" id="fpsSlider" min="150" max="400" value="278" step="1" style="background-size: 12.5% 6px;">
          <input type="number" id="fpsInput" value="278" min="150" max="400" style="width:80px; padding:0.45rem; text-align:center; font-weight:600; font-size:1rem;">
        </div>
      </div>
      <div style="margin:1.2rem 0;">
        <label style="display:block; margin-bottom:0.4rem; font-weight:600;">Crosswind (mph)</label>
        <div style="display:flex; align-items:center; gap:1rem;">
          <input type="range" id="windSlider" min="0" max="40" value="0" step="0.1" style="background-size: 12.5% 6px;">
          <input type="number" id="windInput" value="0" min="0" max="40" step="0.1" style="width:70px; padding:0.45rem; text-align:center; font-weight:600; font-size:1rem;">
        </div>
      </div>
      <div style="margin:1.2rem 0;">
        <label style="display:block; margin-bottom:0.4rem; font-weight:600;">Range (yards)</label>
        <div style="display:flex; align-items:center; gap:1rem;">
          <input type="range" id="rangeSlider" min="5" max="150" value="0" step="1" style="background-size: 12.5% 6px;">
          <input type="number" id="rangeInput" value="0" min="5" max="150" style="width:70px; padding:0.45rem; text-align:center; font-weight:600; font-size:1rem;">
        </div>
      </div>
    </div>

        <!-- Effective Draw Weight Card -->
    <div class="card">
      <h2 style="display:flex; align-items:center; gap:0.75rem;">
        Effective Draw Weight
        <button onclick="showEffectiveLoadPopup()" class="info-btn" title="Explain Effective Draw Weight">ⓘ</button>
      </h2>
      <div class="stats-list">
        <!-- Input Draw Weight -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <span class="effective-dw-title">Input Draw Wt.</span>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-fill" id="inputDwFill" style="width:50%; background:var(--primary);"></div>
                  <div class="bar-marker" id="inputDwMarker" style="left:50%;"></div>
                </div>
                <span class="moving-value" id="inputDwValue">70 lb</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Calculated Effective Draw Weight -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <span class="effective-dw-title">Effective Load</span>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-fill" id="effectiveLoadFill" style="width:50%; background:var(--success);"></div>
                  <div class="bar-marker" id="effectiveLoadMarker" style="left:50%;"></div>
                </div>
                <span class="moving-value" id="effectiveLoadValue">80 lb</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Game Effectiveness card -->
    <div class="card">
      <h2 style="display:flex; align-items:center; gap:0.75rem;">
        Game Effectiveness @ <span id="gameDist">50</span> yd
        <button onclick="showGameMathPopup()" style="background:none;border:none;cursor:pointer;font-size:1.3rem;color:var(--primary);padding:0;" title="Show math breakdown">ⓘ</button>
      </h2>
      <div style="overflow-x:auto;">
        <table class="game-table">
          <thead>
            <tr>
              <th>Class</th>
              <th>KE Min (ft·lbs)</th>
              <th>Mom Min (slug·ft/s)</th>
              <th>Impact KE (ft·lbs)</th>
              <th>Impact Mom (slug·ft/s)</th>
              <th>Result</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Small Game</td>
              <td>15+</td>
              <td>0.20+</td>
              <td id="smallKE">-</td>
              <td id="smallMom">-</td>
              <td id="smallRes" class="send">Send it</td>
            </tr>
            <tr>
              <td>Deer / Antelope</td>
              <td>25+</td>
              <td>0.30+</td>
              <td id="deerKE">-</td>
              <td id="deerMom">-</td>
              <td id="deerRes" class="send">Send it</td>
            </tr>
            <tr>
              <td>Elk / Large Game</td>
              <td>42+</td>
              <td>0.45+</td>
              <td id="elkKE">-</td>
              <td id="elkMom">-</td>
              <td id="elkRes" class="send">Send it</td>
            </tr>
            <tr>
              <td>Toughest Game</td>
              <td>65+</td>
              <td>0.60+</td>
              <td id="mooseKE">-</td>
              <td id="mooseMom">-</td>
              <td id="mooseRes" class="marginal">Marginal</td>
            </tr>
          </tbody>
        </table>
      </div>
      <p style="margin-top:0.75rem;font-size:0.9rem;color:var(--light);text-align:center;">
        Based on kinetic energy and momentum at impact. Broadhead type and shot placement matter!
      </p>
    </div>
    <!-- Quick Stats – Final Polished Version -->
    <div class="card">
      <h2>Quick Stats</h2>
      <div class="stats-list">
        <!-- FOC -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>FOC %</strong>
              <button onclick="showFocPopup()" class="info-btn" title="Explain FOC">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-marker" id="focMarker" style="left:50%;"></div>
                  <div class="sweet-spot"></div>
                </div>
                <div class="bar-labels">
                  <span>tail heavy</span>
                  <span>balanced</span>
                  <span>tip heavy</span>
                </div>
                <span class="moving-value" id="focValue">0.0%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- GPP -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>GPP</strong>
              <button onclick="showGppPopup()" class="info-btn" title="Explain GPP">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-marker" id="gppMarker" style="left:50%;"></div>
                  <div class="gpp-sweet-spot"></div>
                </div>
                <div class="bar-labels">
                  <span>light</span>
                  <span>balanced</span>
                  <span>heavy</span>
                </div>
                <span class="moving-value" id="gppValue">0.0 gr</span>
              </div>
            </div>
          </div>
        </div>

        <!-- GPI -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>GPI</strong>
              <button onclick="showGpiPopup()" class="info-btn" title="Explain GPI">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-marker" id="gpiMarker" style="left:50%;"></div>
                  <div class="gpi-sweet-spot"></div>
                </div>
                <div class="bar-labels">
                  <span>light</span>
                  <span>balanced</span>
                  <span>heavy</span>
                </div>
                <span class="moving-value" id="gpiValue">0.0 gr/in</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Total Wt -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>Total Wt</strong>
              <button onclick="showTotalWtPopup()" class="info-btn" title="Explain Total Weight">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-marker" id="totalWtMarker" style="left:50%;"></div>
                  <div class="totalwt-sweet-spot"></div>
                </div>
                <div class="bar-labels">
                  <span>light</span>
                  <span>medium</span>
                  <span>heavy</span>
                </div>
                <span class="moving-value" id="totalWtValue">0 gr</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Stiffness -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>Stiffness</strong>
              <button onclick="showStiffnessPopup()" class="info-btn" title="Explain Stiffness">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-marker" id="stiffnessMarker" style="left:50%;"></div>
                  <div class="stiffness-sweet-spot"></div>
                </div>
                <div class="bar-labels">
                  <span>stiff</span>
                  <span>good</span>
                  <span>weak</span>
                </div>
                <span class="moving-value" id="stiffnessValue">300</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Flatness -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>Flatness</strong>
              <button onclick="showFlatnessPopup()" class="info-btn" title="Explain Flatness">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-marker" id="flatnessMarker" style="left:50%;"></div>
                  <div class="flatness-sweet-spot"></div>
                </div>
                <div class="bar-labels">
                  <span>curved</span>
                  <span>flat</span>
                  <span>very flat</span>
                </div>
                <span class="moving-value" id="flatnessValue">0.0 ft</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Group Stability -->
        <div class="stat-item">
          <div class="stat-row">
            <div class="stat-title">
              <strong>Stability</strong>
              <button onclick="showGroupStabilityPopup()" class="info-btn" title="Explain Group Stability">ⓘ</button>
            </div>
            <div class="stat-content">
              <div class="stat-bar-container">
                <div class="bar" style="height:16px;">
                  <div class="bar-marker" id="groupStabilityMarker" style="left:50%;"></div>
                  <div class="group-stability-sweet-spot"></div>
                </div>
                <div class="bar-labels">
                  <span>0</span>
                  <span>1</span>
                  <span>2</span>
                  <span>3</span>
                </div>
                <span class="moving-value" id="groupStabilityValue">0/3</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Trajectory: Peak Height & Drop -->
    <div class="card">
      <h2>Trajectory (20 yd zero)</h2>
      <div style="margin-bottom:1rem;">
        <div style="display:flex; align-items:center; gap:0.75rem;">
          <strong>Peak Height</strong>
          <button onclick="showTrajectoryPopup()" style="background:none;border:none;cursor:pointer;font-size:1.1rem;color:var(--primary);padding:0;" title="Explain Trajectory">ⓘ</button>
        </div>
        <p style="margin:0.5rem 0; font-size:1.1rem; font-weight:700;">
          <span id="peakHeightValue">0.0</span> ft to <span id="peakDistanceValue">0</span> yd
        </p>
      </div>
      <div>
        <strong>Downrange Drop (in)</strong>
        <table class="drop-table">
          <thead>
            <tr>
              <th>30 yd</th>
              <th>40 yd</th>
              <th>50 yd</th>
              <th>60 yd</th>
              <th>70 yd</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="drop30">-</td>
              <td id="drop40">-</td>
              <td id="drop50">-</td>
              <td id="drop60">-</td>
              <td id="drop70">-</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Build Summary Table (collapsible) -->
    <div class="card collapsible-mobile" id="summaryCard">
      <div class="collapsible-trigger" onclick="this.classList.toggle('open')">
        <span>Build Summary & Export</span>
        <span class="chevron">></span>
      </div>
      <div class="collapsible-content"> <!-- ← changed from card-content -->
        <div style="margin-bottom:1rem;">
          <button id="copyCsvBtn" class="secondary">Copy as CSV</button>
        </div>
        <div style="overflow-x:auto;">
          <table class="game-table" id="summaryTable">
            <tbody>
              <!-- Rows will be filled by JS -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="mobile-only-trigger" onclick="this.parentElement.classList.toggle('open')">
        <span>Details</span>
        <span class="chevron">></span>
      </div>
    </div>
  </div>
</div>
<div id="fpsMathModal" class="info-overlay">
  <div class="info-panel" style="max-width:500px;">
    <button class="info-close" onclick="closeFpsMath()">×</button>
    <h2>FPS Estimate Breakdown</h2>
    <div id="fpsMathPopupContent" style="font-size:0.95rem;line-height:1.5;">
      Fill in bow details to see the estimate.
    </div>
  </div>
</div>
<!-- Game Effectiveness Math Popup Modal -->
<div id="gameMathModal" class="info-overlay">
  <div class="info-panel" style="max-width:600px;">
    <button class="info-close" onclick="closeGameMath()">×</button>
    <h2>Math Breakdown</h2>
    <div id="gameMathContent" style="font-size:0.95rem;line-height:1.5;">
      <!-- Filled by JS -->
    </div>
  </div>
</div>
<div id="aiModal" class="info-overlay">
  <div class="info-panel">
    <button class="info-close" onclick="closeModal()">×</button>
    <h2>AI Arrow Advisor</h2>
    <div id="chatHist" style="max-height:300px;overflow-y:auto;margin-bottom:1rem;padding:0.5rem;background:#00000004;border-radius:8px;"></div>
    <div class="flex">
      <input id="aiIn" type="text" placeholder="Ask about arrows, broadheads, tuning..." style="flex:1;">
      <button onclick="sendAi()" class="btn-small">Send</button>
    </div>
  </div>
</div>

<!---SCRIPTS-->
<script>
const $ = id => document.getElementById(id);
let fpsWasRecalculated = false;

function calculateEstimatedFPS() {
  const ibo = parseFloat($('ibo').value) || 340;
  const drawWt = parseFloat($('drawWt').value) || 70;
  const drawLen = parseFloat($('drawLen').value) || 29;
  const totalWt = parseFloat($('totalWt').value) || 495;
  const peepWt = parseFloat($('peepWt').value) || 8;
  const dloopWt = parseFloat($('dloopWt').value) || 8;
  const kisserWt = parseFloat($('kisserWt').value) || 0;
  const silencerWt = parseFloat($('silencerWt').value) || 12;
  const nockWt = parseFloat($('nockWt').value) || 10;
  const totalStringAddons = peepWt + dloopWt + kisserWt + silencerWt + nockWt;

  const refDrawWt = 70;
  const refDrawLen = 30;
  const refArrowWt = 350;
  const refStringFree = 20;

  let est = ibo;
  est += (drawWt - refDrawWt) * 1.8;
  est += (drawLen - refDrawLen) * 10;
  est -= Math.max(0, (totalWt - refArrowWt) / 5);
  est -= Math.max(0, (totalStringAddons - refStringFree) / 10);
  est *= 0.97;

  const estimated = Math.max(150, Math.round(est * 10) / 10);

  return {
    estimated: estimated,
    breakdown: {
      base: ibo,
      adjDrawWt: (drawWt - refDrawWt) * 1.8,
      adjDrawLen: (drawLen - refDrawLen) * 10,
      adjArrowWt: -Math.max(0, (totalWt - refArrowWt) / 5),
      adjString: -Math.max(0, (totalStringAddons - refStringFree) / 10),
      correction: est * -0.03
    }
  };
}

function showFpsMathPopup() {
  const content = $('fpsMathPopupContent');
  const currentFps = parseFloat($('fpsSlider').value);
  const hasManualFps = !isNaN(currentFps) && currentFps > 0;

  if (hasManualFps) {
    content.innerHTML = `
      <p><strong>Using your chronographed speed:</strong> ${currentFps.toFixed(1)} FPS</p>
      <p style="margin-top:0.75rem;color:var(--light);">
        Manual entry overrides estimate — this is the most accurate!
      </p>
    `;
  } else {
    const est = calculateEstimatedFPS();
    content.innerHTML = `
      <p><strong>Calculated estimate:</strong> ${est.estimated.toFixed(1)} FPS</p>
      <p style="margin-top:0.75rem;color:var(--light);font-size:0.9rem;">
        No manual FPS entered — using estimate.
      </p>
    `;
  }
  $('fpsMathModal').style.display = 'flex';
}

function showEffectiveLoadPopup() {
  // Recalculate everything needed (same as in calculateEverything)
  const drawWt = parseFloat($('drawWt').value) || 70;
  const arrowLen = parseFloat($('arrowLen').value) || 28.5;
  const pointWt = parseFloat($('pointWt').value) || 125;
  const totalWt = parseFloat($('totalWt').value) || 495;

  const lengthFactor = (arrowLen - 28) * 2.5;
  const pointFactor = (pointWt - 100) * 0.15;
  const weightFactor = (totalWt - 400) * 0.05;
  const effectiveLoad = Math.round(drawWt + lengthFactor + pointFactor + weightFactor);

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>Effective Draw Weight Math</strong></p>
    <p>The calculator starts from your real draw weight and adds tuned bumps for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Longer arrows (more leverage on the shaft)</li>
      <li>Heavier points (more load out front)</li>
      <li>Overall finished arrow weight</li>
    </ul>
    <hr>
    <p><strong>Your inputs:</strong></p>
    <p>• Draw weight ≈ ${drawWt.toFixed(1)} lb</p>
    <p>• Arrow length ≈ ${arrowLen.toFixed(2)} in</p>
    <p>• Point weight ≈ ${pointWt} gr</p>
    <p>• Total arrow weight ≈ ${totalWt.toFixed(1)} gr</p>
    <hr>
    <p><strong>Breakdown:</strong></p>
    <p>Base: ${drawWt} lb</p>
    <p>+ Length factor: +${lengthFactor.toFixed(2)}</p>
    <p>+ Point factor: +${pointFactor.toFixed(2)}</p>
    <p>+ Weight factor: +${weightFactor.toFixed(2)}</p>
    <p><strong>Effective load ≈ ${effectiveLoad} lb</strong></p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      This is the "load" the shaft actually feels — used to recommend spine.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function showGameMathPopup() {
  const rangeYd = parseFloat($('rangeSlider').value) || 50;
  const fps = parseFloat($('fpsSlider').value) || 278;
  const totalWt = parseFloat($('totalWt').value) || 495;

  const k = 0.532;
  const retention = Math.exp(- (k * rangeYd) / totalWt);
  const velImpact = Math.round(fps * retention);
  const keImpact = Math.round(totalWt * velImpact * velImpact / 450240);
  const momImpact = parseFloat((totalWt * velImpact / 225400).toFixed(3));

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>Launch Speed:</strong> ${fps} fps</p>
    <p><strong>Arrow Weight:</strong> ${totalWt} gr</p>
    <p><strong>Range:</strong> ${rangeYd} yd</p>
    <hr>
    <p><strong>Velocity Retention Model:</strong></p>
    <p>retention = e^(-k × range / weight)</p>
    <p>k = 0.532 (calibrated for typical hunting arrows)</p>
    <p>Retention = ${retention.toFixed(3)} (${(retention * 100).toFixed(1)}%)</p>
    <p><strong>Impact Velocity:</strong> ${velImpact} fps</p>
    <hr>
    <p><strong>Impact KE:</strong> ${keImpact.toFixed(1)} ft-lbs</p>
    <p>KE = (weight × velocity²) / 450240</p>
    <p>KE = (${totalWt} × ${velImpact}²) / 450240</p>
    <hr>
    <p><strong>Impact Momentum:</strong> ${momImpact.toFixed(3)} slug·ft/s</p>
    <p>Momentum = (weight × velocity) / 225400</p>
    <p>Momentum = (${totalWt} × ${velImpact}) / 225400</p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      <strong>Where do the constants come from?</strong><br>
      • 450240 = 2 × 32.174 × 7000 (converts grain·fps² to ft-lbs)<br>
      • 225400 = 450240 / 2 (for momentum in slug·ft/s)<br>
      • k = 0.532 is calibrated from real-world hunting arrow data (350–500gr arrows, typical shafts/broadheads).<br><br>
      This is an approximation using arrow mass for drag resistance.<br>
      Real-world results vary with arrow diameter, broadhead, fletching, and air density.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function closeGameMath() {
  $('gameMathModal').style.display = 'none';
}

function recalculateAndShowMath() {
  const est = calculateEstimatedFPS();
  const b = est.breakdown;

  $('fpsSlider').value = est.estimated;
  $('fpsInput').value = est.estimated;

  const content = $('fpsMathPopupContent');
  content.innerHTML = `
    <p style="color:var(--success);font-weight:700;">✓ Speed updated to calculated estimate!</p>
    <p><strong>New FPS:</strong> ${est.estimated.toFixed(1)}</p>
    <p style="margin-top:0.75rem;"><strong>Breakdown:</strong></p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Base IBO: ${b.base.toFixed(0)} FPS</li>
      <li>Draw weight: ${b.adjDrawWt > 0 ? '+' : ''}${b.adjDrawWt.toFixed(1)} FPS</li>
      <li>Draw length: ${b.adjDrawLen > 0 ? '+' : ''}${b.adjDrawLen.toFixed(1)} FPS</li>
      <li>Arrow weight: ${b.adjArrowWt.toFixed(1)} FPS</li>
      <li>String add-ons: ${b.adjString.toFixed(1)} FPS</li>
      <li>Real-world correction: ${b.correction.toFixed(1)} FPS</li>
    </ul>
    <p style="margin-top:0.75rem;color:var(--light);font-size:0.9rem;">
      Your previous value has been replaced with the current estimate.
    </p>
  `;

  $('fpsMathModal').style.display = 'flex';
}

function closeFpsMath() {
  $('fpsMathModal').style.display = 'none';
}

function showFocPopup() {
  const arrowLen = parseFloat($('arrowLen').value) || 28.5;
  const balancePt = parseFloat($('balancePt').value) || 17.2;
  const midPoint = arrowLen / 2;
  const focPercent = ((balancePt - midPoint) / arrowLen) * 100;

  const content = $('gameMathContent'); // reuse modal
  content.innerHTML = `
    <p><strong>FOC (Front of Center) Math</strong></p>
    <p>FOC measures how far the arrow’s balance point sits in front of the midpoint. Higher FOC generally improves broadhead stability and penetration; lower FOC produces flatter trajectories and is more forgiving to shoot.</p>
    <hr>
    <p><strong>Formula:</strong></p>
    <p>FOC = ((Balance Point − Midpoint) ÷ Arrow Length) × 100</p>
    <hr>
    <p><strong>Your inputs:</strong></p>
    <p>• Arrow Length = ${arrowLen.toFixed(2)} in</p>
    <p>• Midpoint = Arrow Length ÷ 2 = ${midPoint.toFixed(2)} in</p>
    <p>• Balance Point = ${balancePt.toFixed(2)} in</p>
    <hr>
    <p><strong>Step-by-step:</strong></p>
    <p>FOC = ((${balancePt.toFixed(2)} − ${midPoint.toFixed(2)}) ÷ ${arrowLen.toFixed(2)}) × 100</p>
    <p>FOC = <strong>${focPercent.toFixed(1)}%</strong></p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      Typical hunting arrows fall between 10–18%. Higher FOC (18%+) is often preferred for fixed-blade broadheads and heavier setups, while moderate FOC (12–16%) gives a good blend of forgiveness and stability.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function showGppPopup() {
  const totalWt = parseFloat($('totalWt').value) || 495;
  const drawWt = parseFloat($('drawWt').value) || 70;
  const gpp = (totalWt / drawWt).toFixed(1);

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>GPP (Grains Per Pound)</strong></p>
    <p>GPP is one of the simplest ways to express how heavy or light your arrow is relative to your bow’s draw weight.</p>
    <p><strong>Formula:</strong> GPP = Total Arrow Weight ÷ Draw Weight</p>
    <p>Your GPP = ${totalWt} gr ÷ ${drawWt} lb = <strong>${gpp}</strong></p>
    <hr>
    <p><strong>Interpretation:</strong></p>
    <p>• Low GPP (≈5–6) → fast, flat, loud, lower momentum</p>
    <p>• Mid GPP (≈6.5–7.5) → balanced speed + penetration (highlighted)</p>
    <p>• High GPP (≈8–10+) → slower, quiet, higher momentum, bow-friendly</p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      GPP also influences velocity retention in this calculator:<br>
      • Lighter arrows (low GPP) lose speed faster downrange.<br>
      • Heavier arrows (high GPP) hold their speed longer.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function showGpiPopup() {
  const totalWt = parseFloat($('totalWt').value) || 495;
  const arrowLen = parseFloat($('arrowLen').value) || 28.5;
  const gpi = (totalWt / arrowLen).toFixed(1);

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>GPI (Grains Per Inch)</strong></p>
    <p>GPI tells you how much of your arrow’s finished weight comes from the shaft itself. It is simply your total arrow weight divided by your arrow length.</p>
    <p><strong>Formula:</strong> GPI = Total Arrow Weight ÷ Arrow Length</p>
    <p>Your GPI = ${totalWt} gr ÷ ${arrowLen.toFixed(1)} in = <strong>${gpi}</strong></p>
    <hr>
    <p>A lower GPI generally means a lighter, faster shaft (often thinner-walled or smaller diameter). A higher GPI usually indicates a heavier, more robust shaft that can boost momentum and stability, especially for broadheads.</p>
    <p>Unlike spine, GPI is not a stiffness rating — it’s purely a mass-per-inch measurement.</p>
    <p>Sweet spot (highlighted): 7–9.5 — good balance of speed and momentum for most hunting setups.</p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      GPI helps inform group stability, velocity retention, and downrange KE/momentum in this calculator.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function showTotalWtPopup() {
  const totalWt = parseFloat($('totalWt').value) || 495; // <-- add this line

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>Total Arrow Weight (TW) Math</strong></p>
    <p>TW is your finished arrow weight in grains — shaft, components, and point all added together. This is the number that drives almost every other output in the app.</p>
    <p><strong>Your build:</strong></p>
    <p>Total Arrow Weight = <strong>${totalWt.toFixed(1)} grains</strong></p>
    <hr>
    <p>This same TW value is reused in:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>GPP (grains per pound)</li>
      <li>GPI (grains per inch)</li>
      <li>Launch KE and Impact KE</li>
      <li>Momentum and Game Effectiveness</li>
      <li>The Arrow Weight Composition bar</li>
    </ul>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      If this number is off, every downstream calculation will be off with it — so TW is the most important value to get as close as possible to your real, finished arrow.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function showStiffnessPopup() {
  const drawWt = parseFloat($('drawWt').value) || 70;
  const arrowLen = parseFloat($('arrowLen').value) || 28.5;
  const pointWt = parseFloat($('pointWt').value) || 125;
  const totalWt = parseFloat($('totalWt').value) || 495;
  const actualSpine = parseFloat($('spine').value) || 300;

  const lengthFactor = (arrowLen - 28) * 2.5;
  const pointFactor = (pointWt - 100) * 0.15;
  const weightFactor = (totalWt - 400) * 0.05;
  const effectiveLoad = Math.round(drawWt + lengthFactor + pointFactor + weightFactor);

  const recommendedCenter = Math.max(200, Math.min(500, 600 - effectiveLoad * 5));
  const spineDiff = actualSpine - recommendedCenter;

  let status = 'Good';
  if (spineDiff > 50) status = 'Weak';
  else if (spineDiff < -50) status = 'Stiff';

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>Stiffness / Forgiveness Math</strong></p>
    <p>This badge compares your actual arrow spine to a recommended spine band built from draw weight, arrow length, point weight, and finished arrow weight — similar in spirit to a modernized Easton-style chart.</p>
    <hr>
    <p><strong>1) Build an “effective draw weight”</strong></p>
    <p>The calculator starts from your real draw weight and adds tuned bumps for:</p>
    <ul style="margin-left:1.25rem;font-size:0.9rem;">
      <li>Longer arrows (more leverage on the shaft)</li>
      <li>Heavier points (more load out front)</li>
      <li>Overall finished arrow weight</li>
    </ul>
    <p>Your inputs for this build are:</p>
    <p>• Draw weight ≈ ${drawWt.toFixed(1)} lb</p>
    <p>• Arrow length ≈ ${arrowLen.toFixed(2)} in</p>
    <p>• Point weight ≈ ${pointWt} gr</p>
    <p>• Total arrow weight ≈ ${totalWt.toFixed(1)} gr</p>
    <p>Those are combined into a single load number the shaft “feels”:<br>
    <strong>effective draw weight ≈ ${effectiveLoad} lb</strong></p>
    <hr>
    <p><strong>2) Map effective draw weight → spine band</strong></p>
    <p>That effective load is then mapped to a static spine band — lighter loads want weaker shafts (higher spine numbers), heavier loads want stiffer shafts (lower spine numbers).</p>
    <p>Recommended spine band center ≈ <strong>${recommendedCenter}</strong></p>
    <hr>
    <p><strong>3) Compare your spine to the chart recommendation</strong></p>
    <p>• Your actual spine = ${actualSpine}</p>
    <p>• Recommended center spine = ${recommendedCenter}</p>
    <p>• Difference = ${actualSpine} − ${recommendedCenter} = ${spineDiff}</p>
    <p><strong>Result: ${status}</strong></p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      <strong>Good</strong> — Your actual spine is very close to the recommended number. Tuning should be straightforward.<br>
      <strong>Adjust (Stiff)</strong> — Arrow is too stiff (lower spine number than recommended). Add point weight or move to weaker spine.<br>
      <strong>Adjust (Weak)</strong> — Arrow is too weak (higher spine number than recommended). Shorten arrow or move to stiffer spine.<br><br>
      This doesn’t replace paper tuning or broadhead flight testing, but it gives a fast “does this shaft live in the right neighborhood?” sanity check.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function showFlatnessPopup() {
  let currentFps = parseFloat($('fpsSlider').value);
  if (isNaN(currentFps) || currentFps <= 0) {
    const est = calculateEstimatedFPS();
    currentFps = est.estimated;
  }
  const fps = currentFps; // now available

  const g = 32.174;
  const t20 = 20 * 3 / fps;
  const t60 = 60 * 3 / fps;
  const drop20 = 0.5 * g * t20 * t20 * 12;
  const drop60 = 0.5 * g * t60 * t60 * 12;
  const extraDropInches = drop60 - drop20;
  const arcHeightFt = extraDropInches / 12;

  let status = 'Curved';
  if (arcHeightFt < 3) status = 'Very Flat';
  else if (arcHeightFt <= 4.5) status = 'Flat';

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>Flatness Score (20→60 yd) Math</strong></p>
    <p>Flatness looks at how tall your arc needs to be by 60 yards when you are zeroed at 20 yards.</p>
    <hr>
    <p><strong>1) Compute gravity drop at 20 and 60 yd</strong></p>
    <p>Using your launch FPS ≈ ${fps.toFixed(0)} fps</p>
    <p>Drop at 20 yd ≈ ${drop20.toFixed(1)} in</p>
    <p>Drop at 60 yd ≈ ${drop60.toFixed(1)} in</p>
    <hr>
    <p><strong>2) Re-anchor to your 20 yd zero</strong></p>
    <p>Extra drop 20 → 60 yd = ${extraDropInches.toFixed(1)} in</p>
    <hr>
    <p><strong>3) Convert extra drop into effective arc height</strong></p>
    <p>Height ≈ extra drop ÷ 12 = <strong>${arcHeightFt.toFixed(2)} ft</strong></p>
    <hr>
    <p><strong>4) Map height → Flatness label</strong></p>
    <p>Your current build falls into: <strong>${status}</strong></p>
    <p>• Very Flat → effective arc < ~3 ft</p>
    <p>• Flat → ~3–4.5 ft</p>
    <p>• Curved → > ~4.5 ft</p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      Use this to compare builds — it isn’t meant to be exact sight tape data, just a feel for how “flat” the rig is by 60 yards with your current FPS.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function showGroupStabilityPopup() {
  // Recalculate everything needed for the popup
  const arrowLen = parseFloat($('arrowLen').value) || 28.5;
  const balancePt = parseFloat($('balancePt').value) || 17.2;
  const totalWt = parseFloat($('totalWt').value) || 495;
  const fps = parseFloat($('fpsSlider').value) || 278;

  const midPoint = arrowLen / 2;
  const foc = ((balancePt - midPoint) / arrowLen) * 100;
  const gpi = totalWt / arrowLen;

  const fpsGood = fps >= 270;
  const focGood = foc >= 12 && foc <= 18;
  const gpiGood = gpi <= 9.5;

  const goodCount = (fpsGood ? 1 : 0) + (focGood ? 1 : 0) + (gpiGood ? 1 : 0);

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>Group Stability (Target / 3D)</strong></p>
    <p>This rates how optimized your setup is for tight groups in target/3D shooting.</p>
    <hr>
    <p><strong>Current score: ${goodCount}/3</strong></p>
    <p>• FPS ≥ 270: ${fpsGood ? '✓' : '✗'} (${fps.toFixed(0)} fps)</p>
    <p>• FOC 12–18%: ${focGood ? '✓' : '✗'} (${foc.toFixed(1)}%)</p>
    <p>• GPI ≤ 9.5: ${gpiGood ? '✓' : '✗'} (${gpi.toFixed(1)} gr/in)</p>
    <hr>
    <p>3/3 = Tight groups likely with good tuning<br>
       2/3 = Close — small tweaks help<br>
       0–1/3 = Average — more forgiveness trade-offs</p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      Execution and tuning always matter most — this is just a starting point.
    </p>
  `;

  $('gameMathModal').style.display = 'flex';
}

function showTrajectoryPopup() {
  let currentFps = parseFloat($('fpsSlider').value);
  if (isNaN(currentFps) || currentFps <= 0) {
    const est = calculateEstimatedFPS();
    currentFps = est.estimated;
  }
  const fps = currentFps;

  // Use the same 3° approximation as the main display
  const approxThetaDeg = 3;
  const approxThetaRad = approxThetaDeg * Math.PI / 180;
  const v0y = fps * Math.sin(approxThetaRad);
  const peakHeightFt = (v0y * v0y) / (2 * 32.174);
  const timeToPeak = v0y / 32.174;
  const peakDistanceYd = (fps * Math.cos(approxThetaRad) * timeToPeak) / 3;

  const content = $('gameMathContent');
  content.innerHTML = `
    <p><strong>Peak Height vs Downrange Drop</strong></p>
    <p>Most archery charts talk about drop — how far the arrow is below your line of sight at longer distances. Peak Height uses a different reference: how high the arrow climbs above a horizontal launch line.</p>
    <hr>
    <p><strong>Peak Height</strong></p>
    <p>Measures the highest point of the arc above a flat launch line.</p>
    <p>Your peak: <strong>${peakHeightFt.toFixed(1)} ft to ${Math.round(peakDistanceYd)} yd</strong></p>
    <p>Useful for clearance over brush, branches, or blind windows.</p>
    <hr>
    <p><strong>Downrange Drop</strong></p>
    <p>Shows extra drop (in inches) beyond your 20 yd zero at longer ranges.</p>
    <p>This is what your sight tape or pin gaps will feel like.</p>
    <hr>
    <p style="font-size:0.9rem;color:var(--light);">
      These are simplified projectile estimates using a typical ~3° launch angle for a 20 yd zero (no drag). Real flight is slightly flatter due to lift from fletching, but this gives a good relative comparison between builds.
    </p>
  `;
  $('gameMathModal').style.display = 'flex';
}

function calculateEverything() {
  // Parse all inputs first
  const drawWt = parseFloat($('drawWt').value) || 70;
  const totalWt = parseFloat($('totalWt').value) || 495;
  const windMph = parseFloat($('windSlider').value) || 0;
  const rangeYd = parseFloat($('rangeSlider').value) || 50;
  const arrowLen = parseFloat($('arrowLen').value) || 28.5;
  const balancePt = parseFloat($('balancePt').value) || 17.2;
  // For the Total Weight
  const pointWt = parseFloat($('pointWt').value) || 125;

  let userFps = parseFloat($('fpsSlider').value);
  if (isNaN(userFps) || userFps <= 0) {
    const est = calculateEstimatedFPS();
    userFps = est.estimated;
  }
  const fps = userFps;

  // Sync number inputs
  $('windInput').value = windMph;
  $('rangeInput').value = rangeYd;
  $('fpsInput').value = fps;

  // Update game distance
  $('gameDist').textContent = rangeYd;

  // === FOC Progress Bar ===
  const midPoint = arrowLen / 2;
  const foc = ((balancePt - midPoint) / arrowLen) * 100;
  const focClamped = Math.max(0, Math.min(30, foc));
  $('focMarker').style.left = (focClamped / 30 * 100) + '%';
  $('focValue').style.left = (focClamped / 30 * 100) + '%';
  $('focValue').textContent = foc.toFixed(1) + '%';

  // GPP
  const gpp = totalWt / drawWt;
  const gppPercent = Math.max(0, Math.min(100, (gpp - 5) / 5 * 100));
  $('gppMarker').style.left = `${gppPercent}%`;
  $('gppValue').style.left = `${gppPercent}%`;
  $('gppValue').textContent = gpp.toFixed(1) + ' gr';

  // GPI
  const gpi = totalWt / arrowLen;
  const gpiPercent = (gpi / 20) * 100;
  $('gpiMarker').style.left = `${gpiPercent}%`;
  $('gpiValue').style.left = `${gpiPercent}%`;
  $('gpiValue').textContent = gpi.toFixed(1) + ' gr/in';

  // Total Wt
  const totalWtPercent = ((totalWt - 50) / 950) * 100;
  $('totalWtMarker').style.left = `${totalWtPercent}%`;
  $('totalWtValue').style.left = `${totalWtPercent}%`;
  $('totalWtValue').textContent = Math.round(totalWt) + ' gr';

  // === Game Effectiveness ===
  const k = 0.532;
  const retention = Math.exp(- (k * rangeYd) / totalWt);
  const velImpact = Math.round(fps * retention);
  const keImpact = Math.round(totalWt * velImpact * velImpact / 450240);
  const momImpact = parseFloat((totalWt * velImpact / 225400).toFixed(3));

  const classes = [
    {id: 'small', keMin: 15, momMin: 0.20},
    {id: 'deer', keMin: 25, momMin: 0.30},
    {id: 'elk', keMin: 42, momMin: 0.45},
    {id: 'moose', keMin: 65, momMin: 0.60}
  ];

  classes.forEach(c => {
    const keOk = keImpact >= c.keMin;
    const momOk = momImpact >= c.momMin;
    const bothOk = keOk && momOk;

    $(`${c.id}KE`).textContent = `${keImpact.toFixed(1)} ${keOk ? '(✓)' : '(×)'}`;
    $(`${c.id}Mom`).textContent = `${momImpact.toFixed(3)} ${momOk ? '(✓)' : '(×)'}`;

    const resCell = $(`${c.id}Res`);
    if (bothOk) {
      resCell.textContent = 'Send it';
      resCell.className = 'send';
    } else if (keOk || momOk) {
      resCell.textContent = 'Marginal';
      resCell.className = 'marginal';
    } else {
      resCell.textContent = 'Adjust';
      resCell.className = 'adjust';
    }
  });

    // === Stiffness / Forgiveness ===
  const actualSpine = parseFloat($('spine').value) || 300;
  const baseLoad = drawWt;
  const lengthFactor = (arrowLen - 28) * 2.5;
  const pointFactor = (pointWt - 100) * 0.15;
  const weightFactor = (totalWt - 400) * 0.05;
  const effectiveLoad = Math.round(baseLoad + lengthFactor + pointFactor + weightFactor);
  const recommendedCenter = Math.max(200, Math.min(500, 600 - effectiveLoad * 5));
  const spineDiff = actualSpine - recommendedCenter;

  let stiffnessPercent = 50 + spineDiff / 2;

  if (spineDiff > 100) {
    stiffnessPercent = 75 + (spineDiff - 100);
  } else if (spineDiff < -100) {
    stiffnessPercent = 25 + (spineDiff + 100);
  }

  stiffnessPercent = Math.max(0, Math.min(100, stiffnessPercent));

   // Effective Draw Weight bars
  const maxLoad = 100; // scale to 100 lb max for nice bar length
  const inputDwPercent = (drawWt / maxLoad) * 100;
  const effectivePercent = (effectiveLoad / maxLoad) * 100;

  // Input Draw Weight
  $('inputDwFill').style.width = `${inputDwPercent}%`;
  $('inputDwMarker').style.left = `${inputDwPercent}%`;
  $('inputDwValue').style.left = `${inputDwPercent}%`;
  $('inputDwValue').textContent = drawWt + ' lb';

  // Effective Load
  $('effectiveLoadFill').style.width = `${effectivePercent}%`;
  $('effectiveLoadMarker').style.left = `${effectivePercent}%`;
  $('effectiveLoadValue').style.left = `${effectivePercent}%`;
  $('effectiveLoadValue').textContent = effectiveLoad + ' lb';

  // Show spine + status
  let status = 'Good';
  if (spineDiff > 100) status = 'Weakest';
  else if (spineDiff < -100) status = 'Stiffest';
  else if (spineDiff > 60) status = 'Weaker)';
  else if (spineDiff < -60) status = 'Stiffer)';

  $('stiffnessValue').textContent = actualSpine + ' (' + status + ')';
  $('stiffnessValue').style.left = `${stiffnessPercent}%`;
  $('stiffnessMarker').style.left = `${stiffnessPercent}%`;

// === Flatness Score (20→60 yd) ===
  const g = 32.174;
  const t20 = 20 * 3 / fps;
  const t60 = 60 * 3 / fps;
  const drop20 = 0.5 * g * t20 * t20 * 12;
  const drop60 = 0.5 * g * t60 * t60 * 12;
  const extraDropInches = drop60 - drop20;
  const arcHeightFt = extraDropInches / 12;

  // Marker logic FIRST (right = flatter = better)
  let flatnessPercent = 0;
  if (arcHeightFt < 3) {
    flatnessPercent = 100;
  } else if (arcHeightFt <= 4.5) {
    flatnessPercent = 66.67 + ((arcHeightFt - 3) / 1.5) * 33.33;
  } else {
    flatnessPercent = Math.max(0, 66.67 - ((arcHeightFt - 4.5) / 3) * 66.67);
  }

  // Now update value and marker using the correct percent
  $('flatnessValue').textContent = arcHeightFt.toFixed(1) + ' ft';
  $('flatnessValue').style.left = `${flatnessPercent}%`;
  $('flatnessMarker').style.left = `${flatnessPercent}%`;

  // === Group Stability (Target / 3D) ===
  const fpsGood = fps >= 270;
  const focGood = foc >= 12 && foc <= 18;
  const gpiGood = gpi <= 9.5;

  const goodCount = (fpsGood ? 1 : 0) + (focGood ? 1 : 0) + (gpiGood ? 1 : 0);
  const groupPercent = (goodCount / 3) * 100; // 0, 33.33, 66.67, 100

  // DELETE DEBUG
  console.log('goodCount:', goodCount, 'percent:', groupPercent);

  $('groupStabilityValue').textContent = `${goodCount}/3`;
  $('groupStabilityMarker').style.left = `${groupPercent}%`; // exact

  // === Trajectory: Peak Height & Downrange Drop (approximation) ===
  // Simple approximation: peak height ≈ (fps^2 * sin^2(approx_angle)) / (2g)
  // Use a fixed reasonable launch angle of ~3 degrees for comparison
  const approxThetaDeg = 3; // typical for 20 yd zero
  const approxThetaRad = approxThetaDeg * Math.PI / 180;
  const v0y = fps * Math.sin(approxThetaRad);
  const peakHeightFt = (v0y * v0y) / (2 * 32.174);
  const timeToPeak = v0y / 32.174;
  const peakDistanceYd = (fps * Math.cos(approxThetaRad) * timeToPeak) / 3;

  $('peakHeightValue').textContent = peakHeightFt.toFixed(1);
  $('peakDistanceValue').textContent = Math.round(peakDistanceYd);

  // Downrange drop relative to launch line (not zeroed)
  const dropAtDistance = (distYd) => {
    const distFt = distYd * 3;
    const time = distFt / fps;
    return 0.5 * 32.174 * time * time * 12; // inches
  };

  const distances = [30, 40, 50, 60, 70];
  distances.forEach(d => {
    const dropIn = dropAtDistance(d);
    $(`drop${d}`).textContent = dropIn.toFixed(1);
  });

    // === Update Build Summary Table ===
  const table = $('summaryTable').querySelector('tbody');
  table.innerHTML = ''; // clear

  const addRow = (label, value) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td style="font-weight:600; padding:0.5rem 0;">${label}</td>
      <td style="padding:0.5rem 0;">${value || '-'}</td>
    `;
    table.appendChild(row);
  };

  // User Inputs
  addRow('Build Name', $('buildName').value || 'Unnamed');
  addRow('Application', $('appType').value);
  addRow('Bow Model', $('bowModel').value);
  addRow('IBO Speed', $('ibo').value ? $('ibo').value + ' fps' : '-');
  addRow('Draw Weight', drawWt + ' lb');
  addRow('Draw Length', $('drawLen').value + ' in');
  addRow('String Add-ons', $('stringWt').value + ' gr');
  addRow('Arrow Name', $('arrowName').value);
  addRow('Spine', actualSpine);
  addRow('Arrow Length', arrowLen + ' in');
  addRow('Total Arrow Weight', totalWt + ' gr');
  addRow('Point Weight', pointWt + ' gr');
  addRow('Balance Point', balancePt + ' in');
  addRow('Actual Speed', fps.toFixed(1) + ' fps');
  addRow('Crosswind', windMph.toFixed(1) + ' mph');
  addRow('Range', rangeYd + ' yd');

  // Calculated Outputs
  addRow('FOC', foc.toFixed(1) + '%');
  addRow('GPP', gpp.toFixed(1));
  addRow('GPI', gpi.toFixed(1) + ' gr/in');

  addRow('Effective Draw Weight', effectiveLoad + ' lb');
  
  // Add stiffness with status
  let stiffnessStatus = 'Good';
  if (spineDiff > 100) stiffnessStatus = 'Weakest';
  else if (spineDiff < -100) stiffnessStatus = 'Stiffest';
  else if (spineDiff > 60) stiffnessStatus = 'Weaker';
  else if (spineDiff < -60) stiffnessStatus = 'Stiffer';

  addRow('Stiffness', actualSpine + ' (' + stiffnessStatus + ')');

  // Calculated Outputs 
  addRow('Flatness (20→60 yd)', arcHeightFt.toFixed(1) + ' ft arc');
  addRow('Group Stability', `${goodCount}/3 conditions met`);

  // Trajectory
  addRow('Peak Height', peakHeightFt.toFixed(1) + ' ft');
  addRow('Peak Distance', Math.round(peakDistanceYd) + ' yd');

  // Downrange Drop
  addRow('Drop at 30 yd', $(`drop30`).textContent);
  addRow('Drop at 40 yd', $(`drop40`).textContent);
  addRow('Drop at 50 yd', $(`drop50`).textContent);
  addRow('Drop at 60 yd', $(`drop60`).textContent);
  addRow('Drop at 70 yd', $(`drop70`).textContent);

  // Game Effectiveness
  addRow('Impact Velocity @ ' + rangeYd + ' yd', velImpact + ' fps');
  addRow('Impact KE @ ' + rangeYd + ' yd', keImpact.toFixed(1) + ' ft-lbs');
  addRow('Impact Momentum @ ' + rangeYd + ' yd', momImpact.toFixed(3) + ' slug·ft/s');
}

// Move this outside calculateEverything()
$('copyCsvBtn').addEventListener('click', () => {
  let csv = 'Label,Value\n';
  const rows = $('summaryTable').querySelectorAll('tr');
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length === 2) {
      const label = cells[0].textContent.trim();
      const value = cells[1].textContent.trim();
      csv += `"${label}","${value}"\n`;
    }
  });
  navigator.clipboard.writeText(csv).then(() => {
    alert('Build summary copied to clipboard as CSV!');
  });
});

function closeFpsMath() {
  $('fpsMathModal').style.display = 'none';
}

function closeModal() {
  $('aiModal').style.display = 'none';
}

function sendAi() {
  const msg = $('aiIn').value.trim();
  if (!msg) return;
  $('chatHist').innerHTML += `<p><strong>You:</strong> ${msg}</p>`;
  $('chatHist').innerHTML += `<p style="color:var(--purple);"><strong>AI:</strong> Got it! Example response...</p>`;
  $('aiIn').value = '';
  $('chatHist').scrollTop = $('chatHist').scrollHeight;
}

// Suggest Build Name
document.querySelector('.secondary').addEventListener('click', () => {
  const today = new Date();
  const dateStr = today.toISOString().slice(0, 10);
  const appType = $('appType').value.trim() || 'Hunting';
  const arrowWeight = $('totalWt').value.trim() || '???';
  const bowModel = $('bowModel').value.trim() || 'Bow';
  const drawWt = $('drawWt').value || '??';
  const templates = [
    `${dateStr} ${appType} ${bowModel} ${drawWt}# ${arrowWeight}gr`,
    `${dateStr} ${bowModel} ${drawWt}lb ${appType} ${arrowWeight}gr`,
    `${dateStr} ${appType} Build ${arrowWeight}gr`,
    `${dateStr} ${bowModel} ${appType} Setup`
  ];
  const best = templates.find(t => !t.includes('??') && !t.includes('???')) || templates[0];
  $('buildName').value = best.trim();
});

// Save / Load / Delete Builds
function updateLoadDropdown() {
  const select = $('loadBuild');
  const builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  select.innerHTML = '<option>– Load Build –</option>';
  builds.sort((a, b) => b.date.localeCompare(a.date)).forEach(build => {
    const opt = document.createElement('option');
    opt.value = build.name;
    opt.textContent = `${build.date} – ${build.name}`;
    select.appendChild(opt);
  });
}

// Preloaded Sample Profiles (prefixed with SAMPLE)
const sampleProfiles = [
  {
    name: "SAMPLE Cameron Hanes Heavy Hunter",
    date: "2025-01-01",
    appType: "Hunting",
    bowModel: "Hoyt RX-8",
    ibo: "340",
    drawWt: "80",
    drawLen: "27",
    stringWt: "20",
    arrowName: "Easton FMJ",
    spine: "300",
    arrowLen: "27.5",
    totalWt: "500",
    pointWt: "125",
    balancePt: "18",
    fpsSlider: "290"
  },
  {
    name: "SAMPLE Josh Bowmar Beast Mode",
    date: "2025-01-01",
    appType: "Hunting",
    bowModel: "PSE Evo NXT",
    ibo: "342",
    drawWt: "90",
    drawLen: "29",
    stringWt: "20",
    arrowName: "Victory VAP TKO",
    spine: "200",
    arrowLen: "29",
    totalWt: "520",
    pointWt: "200",
    balancePt: "18.5",
    fpsSlider: "280"
  },
  {
    name: "SAMPLE John Dudley Nock On Pro",
    date: "2025-01-01",
    appType: "Hunting",
    bowModel: "PSE Carbon Levitate",
    ibo: "340",
    drawWt: "70",
    drawLen: "29",
    stringWt: "15",
    arrowName: "Easton Axis",
    spine: "300",
    arrowLen: "28",
    totalWt: "450",
    pointWt: "125",
    balancePt: "17",
    fpsSlider: "295"
  },
  {
    name: "SAMPLE Levi Morgan Champion",
    date: "2025-01-01",
    appType: "Target",
    bowModel: "Mathews TRX",
    ibo: "350",
    drawWt: "60",
    drawLen: "27.5",
    stringWt: "10",
    arrowName: "Altra Centrum",
    spine: "300",
    arrowLen: "27",
    totalWt: "420",
    pointWt: "100",
    balancePt: "16",
    fpsSlider: "310"
  },
  {
    name: "SAMPLE Tim Gillingham Gold Tip Pro",
    date: "2025-01-01",
    appType: "Target",
    bowModel: "Bowtech Reckoning",
    ibo: "340",
    drawWt: "65",
    drawLen: "28",
    stringWt: "15",
    arrowName: "Gold Tip Triple X",
    spine: "250",
    arrowLen: "28",
    totalWt: "460",
    pointWt: "140",
    balancePt: "17",
    fpsSlider: "295"
  },
  {
    name: "SAMPLE James Yates Backcountry",
    date: "2025-01-01",
    appType: "Hunting",
    bowModel: "Hoyt RX-8",
    ibo: "340",
    drawWt: "70",
    drawLen: "28",
    stringWt: "20",
    arrowName: "Easton Axis",
    spine: "250",
    arrowLen: "28",
    totalWt: "480",
    pointWt: "125",
    balancePt: "17",
    fpsSlider: "285"
  }
];

// Load samples on first run
if (!localStorage.getItem('arrowForgeSamplesLoaded')) {
  let builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  sampleProfiles.forEach(sample => {
    if (!builds.some(b => b.name === sample.name)) {
      builds.push(sample);
    }
  });
  localStorage.setItem('arrowForgeBuilds', JSON.stringify(builds));
  localStorage.setItem('arrowForgeSamplesLoaded', 'true');
}

function updateLoadDropdown() {
  const select = $('loadBuild');
  const builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  select.innerHTML = '<option>– Load Build –</option>';
  builds
    .sort((a, b) => {
      const dateA = a.date || '0000-00-00';
      const dateB = b.date || '0000-00-00';
      return dateB.localeCompare(dateA); // newest first
    })
    .forEach(build => {
      const opt = document.createElement('option');
      opt.value = build.name;
      opt.textContent = `${build.date ? build.date + ' – ' : ''}${build.name}`;
      select.appendChild(opt);
    });
}

// Load samples if none exist
if (!localStorage.getItem('arrowForgeSamplesLoaded')) {
  let builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  sampleProfiles.forEach(sample => {
    if (!builds.some(b => b.name === sample.name)) {
      builds.push(sample);
    }
  });
  localStorage.setItem('arrowForgeBuilds', JSON.stringify(builds));
  localStorage.setItem('arrowForgeSamplesLoaded', 'true');
}

function saveBuild() {
  const buildName = $('buildName').value.trim();
  if (!buildName) {
    alert('Please enter a Build Name first');
    return;
  }
  const buildData = {
    name: buildName,
    date: new Date().toISOString().slice(0,10),
    appType: $('appType').value,
    bowModel: $('bowModel').value,
    ibo: $('ibo').value,
    drawWt: $('drawWt').value,
    drawLen: $('drawLen').value,
    stringWt: $('stringWt').value,
    peepWt: $('peepWt').value,
    dloopWt: $('dloopWt').value,
    kisserWt: $('kisserWt').value,
    silencerWt: $('silencerWt').value,
    nockWt: $('nockWt').value,
    arrowName: $('arrowName').value,
    spine: $('spine').value,
    arrowLen: $('arrowLen').value,
    totalWt: $('totalWt').value,
    pointWt: $('pointWt').value,
    balancePt: $('balancePt').value,
    insertWt: $('insertWt').value,
    wrapWt: $('wrapWt').value,
    vaneWt: $('vaneWt').value,
    vaneCount: $('vaneCount').value,
    glueWt: $('glueWt').value,
    fpsSlider: $('fpsSlider').value,
    windSlider: $('windSlider').value,
    rangeSlider: $('rangeSlider').value,
  };
  let builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  builds = builds.filter(b => b.name !== buildName);
  builds.push(buildData);
  localStorage.setItem('arrowForgeBuilds', JSON.stringify(builds));
  updateLoadDropdown();
  alert(`Build "${buildName}" saved!`);
}

function loadBuild() {
  const select = $('loadBuild');
  const selectedName = select.value;
  if (!selectedName || selectedName === '– Load Build –') return;
  const builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
  const build = builds.find(b => b.name === selectedName);
  if (!build) return;
  $('buildName').value = build.name;
  $('appType').value = build.appType || 'Hunting';
  $('bowModel').value = build.bowModel || '';
  $('ibo').value = build.ibo || '';
  $('drawWt').value = build.drawWt || '';
  $('drawLen').value = build.drawLen || '';
  $('stringWt').value = build.stringWt || '';
  $('peepWt').value = build.peepWt || '8';
  $('dloopWt').value = build.dloopWt || '8';
  $('kisserWt').value = build.kisserWt || '0';
  $('silencerWt').value = build.silencerWt || '12';
  $('nockWt').value = build.nockWt || '10';
  $('arrowName').value = build.arrowName || '';
  $('spine').value = build.spine || '';
  $('arrowLen').value = build.arrowLen || '';
  $('totalWt').value = build.totalWt || '';
  $('pointWt').value = build.pointWt || '';
  $('balancePt').value = build.balancePt || '';
  $('insertWt').value = build.insertWt || '50';
  $('wrapWt').value = build.wrapWt || '8';
  $('vaneWt').value = build.vaneWt || '8';
  $('vaneCount').value = build.vaneCount || '3';
  $('glueWt').value = build.glueWt || '5';
  alert(`Build "${build.name}" loaded!`);
  $('fpsSlider').value = build.fpsSlider || '278';
  $('fpsInput').value = build.fpsSlider || '278';
  $('windSlider').value = build.windSlider || '5';
  $('windInput').value = build.windSlider || '5';
  $('rangeSlider').value = build.rangeSlider || '50';
  $('rangeInput').value = build.rangeSlider || '50';
  calculateEverything(); // to sync everything
}

function deleteBuild() {
  const select = $('loadBuild');
  const selectedName = select.value;
  if (!selectedName || selectedName === '– Load Build –') {
    alert('Select a build to delete');
    return;
  }
  if (confirm(`Delete "${selectedName}" forever?`)) {
    let builds = JSON.parse(localStorage.getItem('arrowForgeBuilds') || '[]');
    builds = builds.filter(b => b.name !== selectedName);
    localStorage.setItem('arrowForgeBuilds', JSON.stringify(builds));
    updateLoadDropdown();
    alert(`Build deleted`);
  }
}

function syncSlider(sliderId, inputId) {
  const slider = $(sliderId);
  const input = $(inputId);
  if (!slider || !input) return;
  slider.addEventListener('input', () => {
    input.value = slider.value;
    calculateEverything(); // optional, if you have calculations
  });
  input.addEventListener('input', () => {
    let val = parseFloat(input.value);
    if (isNaN(val)) val = slider.min;
    val = Math.max(slider.min, Math.min(slider.max, val));
    slider.value = val;
    input.value = val;
    calculateEverything();
  });
}

// Capitalize Bow Model
$('bowModel').addEventListener('input', e => {
  e.target.value = toTitleCase(e.target.value);
});

// Capitalize Arrow Name
$('arrowName').addEventListener('input', e => {
  e.target.value = toTitleCase(e.target.value);
});

//Capitalize the first letter of each word
function toTitleCase(str) {
  return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
}

// Connect the sliders
syncSlider('fpsSlider', 'fpsInput');
syncSlider('windSlider', 'windInput');
syncSlider('rangeSlider', 'rangeInput');

// Event listeners
document.querySelectorAll('input, select').forEach(el => {
  el.addEventListener('input', calculateEverything);
});
$('darkToggle').addEventListener('change', e => {
  document.body.classList.toggle('dark', e.target.checked);
});
$('aiButton').addEventListener('click', () => $('aiModal').style.display = 'flex');
$('saveBuild').addEventListener('click', saveBuild);
$('loadBuild').addEventListener('change', loadBuild);
$('deleteBuild').addEventListener('click', deleteBuild);

// Init
updateLoadDropdown();
calculateEverything();
</script>
</body>
</html>