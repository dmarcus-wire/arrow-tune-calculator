<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Arrow Tune Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Arrow Tune Calculator v1.0.4 ‚Äì velocity drop + efficiency ratio -->
  <style>
    :root {
      --bg: #020617;
      --bg-card: #030712;
      --bg-soft: #0b1220;
      --border: #1f2937;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --accent-strong: #16a34a;
      --accent-warn: #f97316;
      --accent-bad: #ef4444;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --text-soft: #6b7280;
      --shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.8);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --focus-ring: 0 0 0 1px #22c55e, 0 0 0 4px rgba(34, 197, 94, 0.3);
      --info: #38bdf8;
    }

    [data-theme="light"] {
      --bg: #f5f3e8;
      --bg-card: #ffffff;
      --bg-soft: #f2eee2;
      --border: #d4d4d4;
      --accent: #15803d;
      --accent-soft: rgba(21, 128, 61, 0.08);
      --accent-strong: #16a34a;
      --accent-warn: #ea580c;
      --accent-bad: #b91c1c;
      --text: #111827;
      --text-muted: #4b5563;
      --text-soft: #6b7280;
      --shadow-soft: 0 10px 24px rgba(15, 23, 42, 0.2);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0b1120, var(--bg));
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      background:
        radial-gradient(circle at top left, rgba(34,197,94,0.03), transparent),
        radial-gradient(circle at bottom right, rgba(59,130,246,0.03), transparent),
        var(--bg-card);
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      padding: 20px 18px 24px;
      border: 1px solid rgba(148,163,184,0.5);
    }

    @media (min-width: 960px) {
      .app-shell { padding: 24px 28px 30px; }
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .title-block { display: flex; flex-direction: column; gap: 4px; }

    h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #a3e635);
      box-shadow: 0 0 12px rgba(34,197,94,0.8);
    }

    .subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 2px;
    }

    .chip {
      border-radius: 999px;
      padding: 2px 10px;
      border: 1px solid rgba(148,163,184,0.6);
      font-size: 0.75rem;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, rgba(15,23,42,0.9), rgba(30,64,175,0.5));
    }

    [data-theme="light"] .chip {
      background: linear-gradient(135deg, #fefce8, #ffffff);
    }

    .version-pill {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .toolbar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }

    .theme-toggle,
    .btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      padding: 4px 10px;
      font-size: 0.8rem;
      background: linear-gradient(135deg, rgba(15,23,42,0.95), rgba(30,64,175,0.5));
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
    }

    [data-theme="light"] .theme-toggle,
    [data-theme="light"] .btn {
      background: linear-gradient(135deg, #fefce8, #ffffff);
    }

    .theme-toggle:hover,
    .btn:hover {
      transform: translateY(-0.5px);
      box-shadow: 0 0 0 1px rgba(148,163,184,0.7);
    }

    .btn-primary {
      border-color: var(--accent-strong);
      background: linear-gradient(135deg, var(--accent-strong), #22c55e);
      color: #022c22;
      font-weight: 600;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.2fr);
      gap: 16px;
      margin-top: 10px;
    }

    @media (max-width: 960px) {
      main { grid-template-columns: minmax(0,1fr); }
    }

    .col { display: flex; flex-direction: column; gap: 12px; }

    .panel {
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), var(--bg-card));
      border: 1px solid rgba(148,163,184,0.55);
      padding: 12px 12px 14px;
      box-shadow: 0 8px 18px rgba(15,23,42,0.7);
    }

    [data-theme="light"] .panel {
      background: radial-gradient(circle at top, #fefce8, #ffffff);
      border-color: rgba(148,163,184,0.8);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 8px;
    }

    .panel-title {
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .panel-subtitle {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .field-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px 10px;
    }

    @media (max-width: 720px) {
      .field-grid { grid-template-columns: minmax(0,1fr); }
    }

    .field { display: flex; flex-direction: column; gap: 2px; }

    .field-label {
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text-muted);
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .field-label .aux {
      font-weight: 400;
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .field input,
    .field textarea,
    .field select {
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.8);
      background: rgba(15,23,42,0.85);
      color: var(--text);
      font-size: 0.84rem;
      padding: 6px 8px;
      outline: none;
      width: 100%;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s, transform 0.08s;
    }

    [data-theme="light"] .field input,
    [data-theme="light"] .field textarea,
    [data-theme="light"] .field select {
      background: #ffffff;
    }

    .field input:focus,
    .field textarea:focus,
    .field select:focus {
      border-color: var(--accent);
      box-shadow: var(--focus-ring);
      transform: translateY(-0.5px);
    }

    .field input[readonly] {
      background: rgba(15,23,42,0.6);
      color: var(--text-soft);
    }

    [data-theme="light"] .field input[readonly] {
      background: #f9fafb;
    }

    .field textarea { min-height: 70px; resize: vertical; }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .toggle-row input[type=checkbox] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .info-icon {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      color: var(--info);
      width: 18px;
      height: 18px;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }

    [data-theme="light"] .info-icon { background: #ffffff; }

    .info-text {
      font-size: 0.76rem;
      color: var(--text-soft);
      margin-top: 4px;
      padding: 4px 6px;
      border-left: 2px solid rgba(148,163,184,0.7);
      background: radial-gradient(circle at left, rgba(15,23,42,0.7), transparent);
      border-radius: 0 10px 10px 0;
    }

    [data-theme="light"] .info-text {
      background: radial-gradient(circle at left, #fefce8, transparent);
    }

    .info-text[hidden] { display: none; }

    .chip-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.76rem;
      border: 1px solid rgba(148,163,184,0.9);
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(15,23,42,0.8));
      color: var(--text-soft);
      margin-top: 4px;
    }

    [data-theme="light"] .chip-tag {
      background: radial-gradient(circle at top, #fefce8, #ffffff);
    }

    .chip-tag.good {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .chip-tag.warn {
      border-color: var(--accent-warn);
      background: rgba(249,115,22,0.12);
      color: var(--accent-warn);
    }

    .chip-tag.bad {
      border-color: var(--accent-bad);
      background: rgba(239,68,68,0.12);
      color: var(--accent-bad);
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
    }

    @media (max-width: 720px) {
      .results-grid { grid-template-columns: minmax(0,1fr); }
    }

    .result-pill {
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.8);
      padding: 6px 8px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,0.7));
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.8rem;
    }

    [data-theme="light"] .result-pill {
      background: radial-gradient(circle at top, #fefce8, #ffffff);
    }

    .result-label { font-size: 0.75rem; color: var(--text-soft); }
    .result-value { font-size: 0.9rem; font-weight: 600; }

    .efficiency-dial {
      margin-top: 4px;
    }

    .efficiency-bar {
      position: relative;
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      background: linear-gradient(
        90deg,
        rgba(248,113,113,0.6),
        rgba(34,197,94,0.7),
        rgba(234,179,8,0.7)
      );
    }

    .efficiency-marker {
      position: absolute;
      top: -3px;
      bottom: -3px;
      width: 2px;
      background: #f9fafb;
      box-shadow: 0 0 6px rgba(248,250,252,0.9);
    }

    .efficiency-scale {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .visual-section {
      margin-top: 8px;
      border-radius: var(--radius-md);
      padding: 8px 10px;
      border: 1px solid rgba(148,163,184,0.7);
      background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,0.7));
    }

    [data-theme="light"] .visual-section {
      background: radial-gradient(circle at top, #fefce8, #ffffff);
    }

    .visual-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .visual-title { font-size: 0.86rem; font-weight: 700; }

    .balance-bar {
      position: relative;
      height: 10px;
      margin: 6px 0 3px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(37,99,235,0.3), rgba(22,163,74,0.3));
      overflow: hidden;
    }

    .balance-mid {
      position: absolute;
      left: 50%;
      top: -3px;
      bottom: -3px;
      width: 2px;
      background: rgba(248,250,252,0.9);
      opacity: 0.8;
    }

    .balance-marker {
      position: absolute;
      width: 4px;
      top: -3px;
      bottom: -3px;
      background: #f97316;
      border-radius: 999px;
      box-shadow: 0 0 6px rgba(249,115,22,0.9);
    }

    .balance-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .gauge-bar {
      position: relative;
      margin: 6px 0 2px;
      height: 14px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(148,163,184,0.3), rgba(148,163,184,0.6));
      overflow: hidden;
    }

    .gauge-range {
      position: absolute;
      left: 45%;
      width: 25%;
      top: 0;
      bottom: 0;
      background: linear-gradient(90deg, rgba(34,197,94,0.3), rgba(22,163,74,0.7));
    }

    .gauge-marker {
      position: absolute;
      top: -3px;
      bottom: -3px;
      width: 2px;
      background: #22c55e;
      box-shadow: 0 0 6px rgba(34,197,94,0.9);
    }

    .gauge-axis-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .weight-bar {
      position: relative;
      height: 16px;
      max-width: 360px;
      width: 100%;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 6px;
      display: flex;
    }

    .weight-segment { height: 100%; }

    .weight-segment.shaft {
      background: linear-gradient(90deg, rgba(59,130,246,0.9), rgba(37,99,235,0.95));
    }

    .weight-segment.point {
      background: linear-gradient(90deg, rgba(220,38,38,0.9), rgba(248,113,113,0.95));
    }

    .weight-segment.tail {
      background: linear-gradient(90deg, rgba(16,185,129,0.9), rgba(52,211,153,0.95));
    }

    .weight-midline {
      position: absolute;
      left: 50%;
      top: -3px;
      bottom: -3px;
      width: 2px;
      background: rgba(248,250,252,0.9);
      opacity: 0.8;
    }

    .weight-legend {
      font-size: 0.75rem;
      color: var(--text-soft);
      text-align: center;
      margin-top: 4px;
      white-space: pre-line;
    }

    .momentum-icons {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      margin-top: 4px;
      font-size: 0.78rem;
    }

    .game-icon {
      flex: 1;
      text-align: center;
      border-radius: 999px;
      padding: 4px 3px;
      border: 1px solid rgba(148,163,184,0.6);
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1px;
    }

    .game-icon span.emoji { font-size: 1rem; }
    .game-icon span.label { font-size: 0.7rem; }

    .game-icon.active {
      border-color: var(--accent-strong);
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-weight: 600;
    }

    .game-icon.muted { opacity: 0.55; }

    .learn-link {
      font-size: 0.75rem;
      color: var(--info);
      cursor: pointer;
      margin-top: 4px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .trajectory-svg {
      width: 100%;
      max-width: 380px;
      height: auto;
      max-height: 260px;
      display: block;
      margin: 0 auto;
      border-radius: 12px;
      background: radial-gradient(circle at top, #0b1120, #020617);
      border: 1px solid rgba(148,163,184,0.8);
    }

    [data-theme="light"] .trajectory-svg {
      background: radial-gradient(circle at top, #eef2ff, #ffffff);
    }

    .trajectory-meta {
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .data-table-wrap {
      margin-top: 8px;
      max-height: 260px;
      overflow: auto;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148,163,184,0.7);
      background: radial-gradient(circle at top, rgba(15,23,42,0.98), rgba(15,23,42,0.9));
    }

    [data-theme="light"] .data-table-wrap {
      background: radial-gradient(circle at top, #fefce8, #ffffff);
    }

    table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }

    thead {
      position: sticky;
      top: 0;
      background: rgba(15,23,42,0.95);
      z-index: 1;
    }

    [data-theme="light"] thead { background: #fef3c7; }

    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(148,163,184,0.5);
      text-align: left;
      white-space: nowrap;
    }

    tbody tr:nth-child(odd) { background: rgba(15,23,42,0.7); }
    tbody tr:nth-child(even){ background: rgba(15,23,42,0.85); }

    [data-theme="light"] tbody tr:nth-child(odd) { background: rgba(254,249,195,0.5); }
    [data-theme="light"] tbody tr:nth-child(even){ background: #ffffff; }

    .type-badge {
      display: inline-block;
      padding: 1px 5px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(148,163,184,0.7);
      color: var(--text-soft);
    }

    .type-badge.input {
      border-color: rgba(59,130,246,0.9);
      color: #60a5fa;
    }

    .type-badge.calc {
      border-color: var(--accent-strong);
      color: var(--accent-strong);
    }

    .small { font-size: 0.72rem; }
  </style>
</head>
<body data-theme="dark">
  <div class="app-shell">
    <header class="header-row">
      <div class="title-block">
        <h1><span class="logo-dot"></span>Arrow Tune Calculator</h1>
        <div class="subtitle">Visual, data-rich arrow tuning for bowhunters &amp; target archers.</div>
        <div class="chip-row">
          <div class="chip">Live FOC, GPP, GPI &amp; momentum</div>
          <div class="chip">üèπ Works offline in your browser</div>
          <span class="version-pill">v1.0.4 ¬∑ 2025-11-30</span>
        </div>
      </div>
      <div class="toolbar">
        <button id="themeToggle" type="button" class="theme-toggle">üåó Theme</button>
        <button id="saveBuildBtn" type="button" class="btn btn-primary">üíæ Save build</button>
        <button id="downloadInputsCsvBtn" type="button" class="btn">‚¨áÔ∏è Inputs-only CSV</button>

        <!-- Patreon support button -->
        <a
          href="https://patreon.com/ArrowTuneCalculator"
          target="_blank"
          rel="noopener noreferrer"
          class="btn"
          style="text-decoration:none;display:inline-flex;align-items:center;gap:6px;"
          title="Help fund new features like AI suggestions, gear presets, and mobile enhancements."
        >
          ‚ù§Ô∏è Support on Patreon
        </a>
      </div>
    </header>

    <main>
      <!-- LEFT COLUMN -->
      <section class="col">
        <!-- Bow -->
        <article class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                Bow
                <button type="button" class="info-icon" data-info-target="bow-info">i</button>
              </div>
              <div class="panel-subtitle"></div>
              <div id="bow-info" class="info-text" hidden>
                Basic bow setup so we can relate arrow weight to draw weight and estimate speed, momentum, and efficiency.
              </div>
            </div>
          </div>
          <div class="field-grid">
            <div class="field">
              <label class="field-label" for="bowModel">Bow model &amp; year
                <span class="aux">(e.g. 2025 Hoyt RX-9)</span>
              </label>
              <input id="bowModel" type="text" placeholder="2025 Hoyt RX-9">
            </div>
            <div class="field">
              <label class="field-label" for="shooterName">Shooter name
                <span class="aux">(optional)</span>
              </label>
              <input id="shooterName" type="text" placeholder="Shooter">
            </div>
            <div class="field">
              <label class="field-label" for="drawWeight">Draw weight (lb)
                <span class="aux">Rule: ~15‚Äì20 fps per 10 lb change</span>
              </label>
              <input id="drawWeight" type="number" min="10" max="100" step="0.5" value="70">
            </div>
            <div class="field">
              <label class="field-label" for="drawLength">Draw length (in)
                <span class="aux">Rule: ~10 fps per inch change</span>
              </label>
              <input id="drawLength" type="number" min="20" max="34" step="0.25" value="28">
            </div>
            <div class="field">
              <label class="field-label" for="letOffPct">Let-off (%)</label>
              <input id="letOffPct" type="number" min="0" max="100" step="1" placeholder="80">
            </div>
            <div class="field">
              <label class="field-label" for="launchFps">
                IBO rating (FPS)
                <span class="aux">(optional manual override)</span>
              </label>
              <input id="launchFps" type="number" min="200" max="370" step="1" placeholder="e.g. 340">
            </div>
          </div>
        </article>

        <!-- Arrow info -->
        <article class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                Arrow info
                <button type="button" class="info-icon" data-info-target="arrow-info">i</button>
              </div>
              <div class="panel-subtitle"></div>
              <div id="arrow-info" class="info-text" hidden>
                High-level labels so you can compare different arrow builds. Useful when saving multiple arrows or shooters.
              </div>
            </div>
          </div>
          <div class="field-grid">
            <div class="field">
              <label class="field-label" for="arrowName">Arrow name
                <span class="aux">(e.g. Easton 5.0 250 spine match grade)</span>
              </label>
              <input id="arrowName" type="text" placeholder="Easton 5.0 250 spine match grade">
            </div>
            <div class="field">
              <label class="field-label" for="arrowSpine">Arrow spine
                <span class="aux">(e.g. 250, 300, 350)</span>
              </label>
              <input id="arrowSpine" type="number" min="150" max="800" step="10" placeholder="300">
            </div>
            <div class="field">
              <label class="field-label" for="straightness">Straightness
                <span class="aux">(e.g. ¬±0.001")</span>
              </label>
              <input id="straightness" type="text" placeholder="¬±0.001&quot;">
            </div>
          </div>
        </article>

        <!-- Arrow shaft & total weight + components -->
        <article class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                Arrow shaft &amp; total weight
                <button type="button" class="info-icon" data-info-target="shaft-info">i</button>
              </div>
              <div class="panel-subtitle">
                Arrow length and finished total arrow weight from your scale. Component details are optional.
              </div>
              <div id="shaft-info" class="info-text" hidden>
                Arrow length and the finished total arrow weight from your scale. Most people only need arrow length,
                total arrow weight, and balance point.
                If you enter a full component breakdown in the advanced section, that total will be used instead of this field.
              </div>
            </div>
          </div>
          <div class="field-grid">
            <div class="field">
              <label class="field-label" for="arrowLength">Arrow length (in)
                <span class="aux">nock throat to end of shaft (excluding point)</span>
              </label>
              <input id="arrowLength" type="number" min="20" max="36" step="0.25" value="28.25">
            </div>
            <div class="field">
              <label class="field-label" for="totalArrowWeight">Total arrow weight (gr)
                <span class="aux">finished arrow on scale; rule: +5 gr ‚âà ‚àí1‚Äì1.5 fps</span>
              </label>
              <input id="totalArrowWeight" type="number" min="200" max="900" step="0.1" value="500">
            </div>
            <div class="field">
              <label class="field-label" for="balancePoint">Balance point (in from nock)
                <span class="aux">(measure to balance point)</span>
              </label>
              <input id="balancePoint" type="number" min="10" max="36" step="0.01" value="18.5">
            </div>
          </div>

          <div class="toggle-row">
            <input id="showComponents" type="checkbox">
            <label for="showComponents">Show advanced component breakdown</label>
          </div>

          <div id="componentsSection" class="panel" style="margin-top:6px; padding:8px 10px; display:none;">
            <div class="panel-header" style="margin-bottom:4px;">
              <div>
                <div class="panel-title" style="font-size:0.9rem;">
                  Components (Advanced)
                  <button type="button" class="info-icon" data-info-target="components-info">i</button>
                </div>
                <div class="panel-subtitle">
                  Detailed component weights are only needed if you track each part with a small scale.
                </div>
                <div id="components-info" class="info-text" hidden>
                  Detailed component weights, including bare shaft, are only needed if you track each part with a small scale.
                  If you complete all the main component fields (bare shaft, nock, vanes, insert, point), the calculator will
                  use their sum as the total arrow weight. Otherwise, it will use the total arrow weight field above.
                </div>
              </div>
            </div>
            <div class="field-grid">
              <div class="field">
                <label class="field-label" for="bareShaftWeight">Bare shaft weight (gr)</label>
                <input id="bareShaftWeight" type="number" min="100" max="600" step="0.1">
              </div>
              <div class="field">
                <label class="field-label" for="nockWeight">Nock weight (gr)</label>
                <input id="nockWeight" type="number" min="3" max="30" step="0.1">
              </div>
              <div class="field">
                <label class="field-label" for="wrapWeight">Wrap weight (gr)
                  <span class="aux">(optional)</span>
                </label>
                <input id="wrapWeight" type="number" min="0" max="40" step="0.1">
              </div>
              <div class="field">
                <label class="field-label" for="vaneCount">Vane count</label>
                <input id="vaneCount" type="number" min="0" max="6" step="1" value="3">
              </div>
              <div class="field">
                <label class="field-label" for="vaneWeight">Vane weight (each, gr)</label>
                <input id="vaneWeight" type="number" min="1" max="25" step="0.1">
              </div>
              <div class="field">
                <label class="field-label" for="insertWeight">Insert / outsert / half-out (gr)</label>
                <input id="insertWeight" type="number" min="0" max="120" step="0.1">
              </div>
              <div class="field">
                <label class="field-label" for="pointWeight">Point weight (gr)</label>
                <input id="pointWeight" type="number" min="50" max="300" step="0.1">
              </div>
              <div class="field">
                <label class="field-label" for="glueWeight">Glue weight estimate (gr)
                  <span class="aux">(5‚Äì10 gr typical)</span>
                </label>
                <input id="glueWeight" type="number" min="0" max="30" step="0.1">
              </div>
            </div>
          </div>
        </article>

        <!-- FOC & weight distribution (moved above kinetics) -->
        <article class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">FOC &amp; weight distribution</div>
              <div class="panel-subtitle">
                Visualize front-of-center, balance point, and how your arrow‚Äôs weight is distributed.
              </div>
            </div>
          </div>

          <div class="visual-section">
            <div class="visual-header">
              <div class="visual-title">
                Arrow Balance (Nock ‚Üí Point)
                <button type="button" class="info-icon" data-info-target="balance-info">i</button>
              </div>
            </div>
            <div id="balance-info" class="info-text" hidden>
              Center line = geometric center, orange marker = balance point (driven by FOC).
            </div>
            <div class="balance-bar">
              <div class="balance-mid"></div>
              <div id="balanceMarker" class="balance-marker" style="left:50%;"></div>
            </div>
            <div class="balance-labels">
              <span>Nock end</span><span>Point end</span>
            </div>
            <div class="chip-tag" id="balanceSummaryTag">
              Balance point: <strong><span id="balancePointOut">0.0</span>"</strong> from nock
            </div>
          </div>

          <div class="visual-section" style="margin-top:8px;">
            <div class="visual-header">
              <div class="visual-title">
                FOC Shift Gauge
                <button type="button" class="info-icon" data-info-target="foc-gauge-info">i</button>
              </div>
            </div>
            <div id="foc-gauge-info" class="info-text" hidden>
              Shaded zone ‚âà common bowhunting FOC range (~10‚Äì18% forward of center).
            </div>
            <div class="gauge-bar">
              <div class="gauge-range"></div>
              <div id="focMarker" class="gauge-marker" style="left:50%;"></div>
            </div>
            <div class="gauge-axis-labels">
              <span>-10%</span><span>+30%</span>
            </div>
            <div id="focTag" class="chip-tag">
              FOC: <strong><span id="focValue">0.0</span>%</strong>
              <span id="focBandLabel">(no data)</span>
            </div>
          </div>

          <div class="visual-section" style="margin-top:8px;">
            <div class="visual-header">
              <div class="visual-title">
                Weight Composition
                <button type="button" class="info-icon" data-info-target="weight-comp-info">i</button>
              </div>
            </div>
            <div id="weight-comp-info" class="info-text" hidden>
              Center line shows the halfway mark: if the blue shaft segment crosses it, more than half of total arrow
              weight is in the shaft.
            </div>
            <div style="display:flex;flex-direction:column;align-items:center;">
              <div class="weight-bar">
                <div id="shaftSegment" class="weight-segment shaft" style="width:40%;"></div>
                <div id="pointSegment" class="weight-segment point" style="width:40%;"></div>
                <div id="tailSegment" class="weight-segment tail" style="width:20%;"></div>
                <div class="weight-midline"></div>
              </div>
              <div id="weightLegend" class="weight-legend">
                Shaft: 0.0 gr (0.0%)
                ¬∑ Point system: 0.0 gr (0.0%)
                ¬∑ Nock / wrap / vanes + glue: 0.0 gr (0.0%)
              </div>
            </div>
          </div>
        </article>
      </section>
            <!-- RIGHT COLUMN -->
      <section class="col">
        <!-- Kinetics -->
        <article class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                Kinetics (FPS, Momentum &amp; Trajectory)
                <button type="button" class="info-icon" data-info-target="kinetics-info">i</button>
              </div>
              <div class="panel-subtitle">
                Estimate FPS at distance using bow/arrow rules-of-thumb, then see momentum and arc approximations.
              </div>
              <div id="kinetics-info" class="info-text" hidden>
                Launch FPS is estimated from common archery rules-of-thumb and can be overridden with your bow‚Äôs IBO rating:
                ~15‚Äì20 fps per 10 lb of draw weight, ~10 fps per inch of draw length,
                and ~1‚Äì1.5 fps lost for every +5 grains of arrow weight.
              </div>
            </div>
          </div>

          <!-- 1) FPS -->
          <div class="visual-section">
            <div class="visual-header">
              <div class="visual-title">1) FPS estimate at distances</div>
            </div>
            <div class="field-grid">
              <div class="field">
                <label class="field-label" for="speedLossPer10">Speed loss per 10 yd (fps)
                  <span class="aux">heavier arrows usually lose fewer fps; suggested, but editable</span>
                </label>
                <input id="speedLossPer10" type="number" min="0" max="30" step="0.5">
              </div>
              <div class="field">
                <label class="field-label" for="distance1">Distance 1 (yd)</label>
                <input id="distance1" type="number" min="5" max="150" step="1" value="30">
              </div>
              <div class="field">
                <label class="field-label" for="distance2">Distance 2 (yd, farthest)</label>
                <input id="distance2" type="number" min="5" max="150" step="1" value="60">
              </div>
              <div class="field">
                <label class="field-label" for="fpsAtD1">FPS @ Distance 1</label>
                <input id="fpsAtD1" type="number" readonly>
              </div>
              <div class="field">
                <label class="field-label" for="fpsAtD2">FPS @ Distance 2</label>
                <input id="fpsAtD2" type="number" readonly>
              </div>
            </div>
          </div>

          <!-- 2) Game momentum band -->
          <div class="visual-section">
            <div class="visual-header">
              <div class="visual-title">
                2) Game momentum band (farthest distance)
                <button type="button" class="info-icon" data-info-target="momentum-info">i</button>
              </div>
            </div>
            <div id="momentum-info" class="info-text" hidden>
              Momentum is computed as: (arrow grains √ó fps) / 225,400.
              These are still approximations, but they help compare different builds under similar conditions.
            </div>
            <div class="result-pill" style="margin-top:4px;">
              <div class="result-label">Momentum at farthest distance</div>
              <div class="result-value" id="momentumBandResult">
                At ~60 yd: 0.000 slug¬∑ft/s ‚Üí (no band yet)
              </div>
              <div class="small">
                Uses total arrow weight and FPS at your farthest distance to approximate kill-effectiveness bands.
              </div>
            </div>
            <div class="momentum-icons">
              <div id="iconSmall" class="game-icon muted">
                <span class="emoji">ü¶É</span><span class="label">Small game</span>
              </div>
              <div id="iconDeer" class="game-icon muted">
                <span class="emoji">ü¶å</span><span class="label">Deer-size</span>
              </div>
              <div id="iconElk" class="game-icon muted">
                <span class="emoji">ü´é</span><span class="label">Large game</span>
              </div>
              <div id="iconDanger" class="game-icon muted">
                <span class="emoji">üêÉ</span><span class="label">Very large / dangerous</span>
              </div>
            </div>
            <div class="learn-link" id="learnMomentum">Learn more about these bands</div>
            <div id="momentumLearnPanel" class="info-text" hidden>
              <p>
                These momentum bands are based on commonly cited bowhunting guidelines and are meant as a comparison tool,
                not a hard safety rule:
              </p>
              <ul>
                <li><strong>~0.35 slug¬∑ft/s</strong>: small game / practice</li>
                <li><strong>~0.45 slug¬∑ft/s</strong>: deer-sized game</li>
                <li><strong>~0.55 slug¬∑ft/s</strong>: large game (elk / grizzly bears)</li>
                <li><strong>~0.65 slug¬∑ft/s and above</strong>: very large / dangerous game</li>
              </ul>
              <p>
                Momentum formula: <code>(arrow grains √ó fps) / 225,400</code>.
              </p>
              <p>
                For deeper reading, see:
              </p>
              <ul>
                <li>
                  <a href="https://www.ashbybowhunting.org" target="_blank" rel="noopener noreferrer">
                    Ashby Bowhunting Foundation ‚Äì Momentum &amp; arrow lethality research
                  </a>
                </li>
                <li>
                  <a href="https://eastonarchery.com" target="_blank" rel="noopener noreferrer">
                    Easton Archery ‚Äì arrow selection and tuning resources
                  </a>
                </li>
              </ul>
            </div>
          </div>

          <!-- 3) Trajectory Arc -->
          <div class="visual-section">
            <div class="visual-header">
              <div class="visual-title">
                3) Trajectory Arc (Distance vs Height)
                <button type="button" class="info-icon" data-info-target="trajectory-info">i</button>
              </div>
            </div>
            <div id="trajectory-info" class="info-text" hidden>
              Shows a simple arc from bow to target based on your arc range, with a little extra room beyond the target.
            </div>
            <div class="field-grid">
              <div class="field">
                <label class="field-label" for="arcRange">Arc range (yd)
                  <span class="aux">(graph max distance)</span>
                </label>
                <input id="arcRange" type="number" min="10" max="155" step="1" value="60">
              </div>
              <div class="field">
                <label class="field-label" for="arcMetaInline">Peak height (ft) &amp; launch angle</label>
                <input id="arcMetaInline" type="text" readonly>
              </div>
            </div>
            <svg id="trajectorySvg" class="trajectory-svg" viewBox="0 0 320 210" preserveAspectRatio="xMidYMid meet"></svg>
            <div class="trajectory-meta" id="trajectorySummary">
              Horizontal axis ‚âà 0‚Äì61 yd (arc set to ~55 yd). Peak height ‚âà 3.8 ft.
            </div>
          </div>

          <!-- 4) Velocity Drop-Off & Time-of-Flight -->
          <div class="visual-section">
            <div class="visual-header">
              <div class="visual-title">
                4) Velocity Drop-Off &amp; Time-of-Flight
                <button type="button" class="info-icon" data-info-target="veldrop-info">i</button>
              </div>
            </div>
            <div id="veldrop-info" class="info-text" hidden>
              Estimates how your arrow slows down over distance using the same FPS loss-per-10-yd setting, and
              approximates time-of-flight. Helpful for visualizing pin gaps and how ‚Äúforgiving‚Äù your setup is at range.
            </div>

            <div class="field">
              <label class="field-label" for="velDropDistance">
                Distance for sample (yd)
                <span class="aux">(linked to your speed loss setting)</span>
              </label>
              <input id="velDropDistance" type="range" min="0" max="100" step="1" value="40">
              <div class="small">
                Sample distance: <strong><span id="velDropDistanceValue">40</span> yd</strong>
              </div>
            </div>

            <div class="results-grid" style="margin-top:6px;">
              <div class="result-pill">
                <div class="result-label">Velocity at sample distance</div>
                <div class="result-value">
                  <span id="velDropVelocity">0</span> fps
                </div>
                <div class="small">
                  Uses your launch FPS and speed loss per 10 yd.
                </div>
              </div>
              <div class="result-pill">
                <div class="result-label">Time-of-flight (approx)</div>
                <div class="result-value">
                  <span id="velDropTof">0.00</span> s
                </div>
                <div class="small" id="velDropNote">
                  Approximated using average velocity over that distance (ignores vertical drop).
                </div>
              </div>
            </div>
          </div>
        </article>

        <!-- Results + notes + data table -->
        <article class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                Results &amp; notes
                <button type="button" class="info-icon" data-info-target="results-info">i</button>
              </div>
              <div class="panel-subtitle">
                Summary of your build with bands for FOC, GPP, GPI, momentum, and bow/arrow efficiency.
              </div>
              <div id="results-info" class="info-text" hidden>
                FOC, GPP and GPI bands use common bowhunting guidelines. Efficiency compares your bow‚Äôs approximate stored
                energy to the arrow‚Äôs kinetic energy. These are not hard rules, but useful zones to compare different setups.
              </div>
            </div>
          </div>

          <div class="results-grid">
            <div class="result-pill">
              <div class="result-label">Total arrow weight (used for calcs)</div>
              <div class="result-value"><span id="totalWeightOut">0.0</span> gr</div>
              <div class="small">
                Uses component sum when advanced breakdown is fully filled; otherwise uses Total arrow weight field.
              </div>
            </div>
            <div class="result-pill">
              <div class="result-label">Grains per pound (GPP)</div>
              <div class="result-value"><span id="gppValue">0.0</span> GPP</div>
              <div id="gppTag" class="chip-tag">
                GPP band: <strong><span id="gppBandLabel">(no data)</span></strong>
              </div>
            </div>
            <div class="result-pill">
              <div class="result-label">Arrow GPI (full arrow)</div>
              <div class="result-value"><span id="gpiFullValue">0.0</span> GPI</div>
              <div id="gpiTag" class="chip-tag">
                GPI band: <strong><span id="gpiBandLabel">(no data)</span></strong>
              </div>
            </div>
            <div class="result-pill">
              <div class="result-label">Momentum at farthest distance</div>
              <div class="result-value"><span id="momentumValue">0.000</span> slug¬∑ft/s</div>
              <div class="small">
                Your setup: <span id="momentumBandShort">0.000 slug¬∑ft/s ‚Üí (no band)</span>
              </div>
            </div>
            <div class="result-pill">
              <div class="result-label">Efficiency ratio (bow ‚Üî arrow match)</div>
              <div class="result-value">
                <span id="efficiencyValue">0</span>% match
              </div>
              <div id="efficiencyTag" class="chip-tag">
                Match band: <strong><span id="efficiencyBandLabel">(no data)</span></strong>
              </div>
              <div class="efficiency-dial">
                <div class="efficiency-bar">
                  <div class="efficiency-marker" id="efficiencyMarker" style="left:0%;"></div>
                </div>
                <div class="efficiency-scale">
                  <span>Under-driven</span>
                  <span>Balanced</span>
                  <span>Very heavy</span>
                </div>
              </div>
              <div class="small" id="efficiencyTip">
                Enter draw weight, draw length, and arrow details to see the match score.
              </div>
            </div>
          </div>

          <div style="margin-top:8px;">
            <div class="field">
              <label class="field-label" for="notes">
                Notes
                <span class="aux">(what this build is for ‚Äì e.g. elk 0‚Äì60 yd, TAC, practice)</span>
              </label>
              <textarea id="notes" placeholder="Hunting elk out to ~60 yd. Quiet, forgiving build."></textarea>
            </div>

            <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin-top:6px;">
              <div class="field" style="flex:1;">
                <label class="field-label" for="savedBuildName">Saved build name (auto-suggested)</label>
                <input id="savedBuildName" type="text" placeholder="2025-11 Hoyt RX-9 Easton 5.0 500 gr 70 lb draw">
              </div>
              <button id="refreshNameBtn" type="button" class="btn">‚ú® Suggest name</button>
            </div>

            <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin-top:6px;" class="small">
              <span>Saved builds:</span>
              <select id="savedBuildsSelect" style="max-width:260px;">
                <option value="">(none yet)</option>
              </select>
              <button id="loadBuildBtn" type="button" class="btn">üìÇ Load selected</button>
              <!-- Secondary Save button that reuses the main handler -->
              <button type="button" class="btn" onclick="document.getElementById('saveBuildBtn').click();">
                üíæ Save build
              </button>
            </div>

            <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin-top:6px;" class="small">
              <span>Upload inputs CSV:</span>
              <input id="csvUpload" type="file" accept=".csv" style="max-width:230px;">
              <span>(uses first data row, exported from this tool)</span>
            </div>
          </div>

          <div class="data-table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Field</th>
                  <th>Value</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody id="dataTableBody"></tbody>
            </table>
          </div>
        </article>

        <!-- Feedback panel -->
        <article class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                Feedback
                <button type="button" class="info-icon" data-info-target="feedback-info">i</button>
              </div>
              <div class="panel-subtitle">
                Help improve this calculator by sharing what works, what‚Äôs confusing, and what you‚Äôd like next.
              </div>
              <div id="feedback-info" class="info-text" hidden>
                Feedback helps improve this calculator for real-world bowhunting and practice setups.
                Share what makes sense, what doesn‚Äôt, and any numbers or visuals you‚Äôd like added.
              </div>
            </div>
          </div>

          <div class="field">
            <label class="field-label">How to send feedback</label>
            <div class="small">
              You can either email feedback directly, or open a GitHub issue with your notes.
            </div>
          </div>

          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;">
            <!-- EMAIL BUTTON -->
            <button
              type="button"
              class="btn btn-primary"
              onclick="window.location.href='mailto:arrow-tune-calculator@tuta.io?subject=Arrow%20Tune%20Calculator%20Feedback&body=Browser%3A%20%0ADevice%3A%20%0ABuild%20summary%20(FOC%2C%20GPP%2C%20GPI%2C%20momentum)%3A%20%0AWhat%20worked%3A%20%0AWhat%20was%20confusing%3A%20%0AWhat%20you%20wish%20it%20did%3A%20';"
            >
              ‚úâÔ∏è Email feedback
            </button>

            <!-- GITHUB ISSUE -->
            <a
              class="btn"
              style="text-decoration:none;display:inline-flex;align-items:center;gap:6px;"
              href="https://github.com/dmarcus-wire/arrow-tune-calculator/issues/new?title=Feedback%3A+Arrow+Tune+Calculator&body=Browser%3A+%0ADevice%3A+%0ABuild+details+(draw+weight%2C+GPP%2C+FOC)%3A+%0AFeedback%3A+"
              target="_blank"
              rel="noopener noreferrer"
            >
              üêõ Open GitHub issue
            </a>
          </div>

          <p class="small" style="margin-top:6px;">
            If this calculator helps you tune your setup, you can support its development on
            <a href="https://patreon.com/ArrowTuneCalculator" target="_blank" rel="noopener noreferrer">
              Patreon
            </a>.
            Help fund new features like AI suggestions, gear presets, and mobile enhancements.
          </p>
        </article>
      </section>
    </main>
  </div>
  <script>
    const state = { inputs: {}, computed: {}, savedBuilds: [] };
    let speedLossManual = false;

    const DATA_FIELDS_ORDER = [
      'timestamp',
      'bowModel',
      'shooterName',
      'drawWeight',
      'drawLength',
      'letOffPct',
      'launchFpsManual',
      'arrowName',
      'arrowSpine',
      'straightness',
      'arrowLength',
      'totalArrowWeight',
      'balancePoint',
      'bareShaftWeight',
      'nockWeight',
      'wrapWeight',
      'vaneCount',
      'vaneWeight',
      'insertWeight',
      'pointWeight',
      'glueWeight',
      'focPct',
      'focBand',
      'gpp',
      'gppBand',
      'gpiFull',
      'gpiBand',
      'launchFpsUsed',
      'speedLossPer10',
      'fpsAtD1',
      'fpsAtD2',
      'momentumFarthest',
      'momentumBand',
      'efficiencyPct',
      'efficiencyBand',
      'velDropDistance',
      'velDropVelocity',
      'velDropTof',
      'weightSummary',
      'trajectorySummary',
      'notes'
    ];

    function $(id) { return document.getElementById(id); }

    function getNum(id) {
      const el = $(id);
      if (!el) return 0;
      const v = parseFloat(el.value);
      return isNaN(v) ? 0 : v;
    }

    function getStr(id) {
      const el = $(id);
      return el ? (el.value || '').trim() : '';
    }

    function setText(id, value) {
      const el = $(id);
      if (el) el.textContent = value;
    }

    function setValue(id, value) {
      const el = $(id);
      if (el != null) el.value = value;
    }

    function toggleInfo(e) {
      const targetId = e.currentTarget.getAttribute('data-info-target');
      if (!targetId) return;
      const node = $(targetId);
      if (!node) return;
      node.hidden = !node.hidden;
    }

    function loadTheme() {
      const stored = localStorage.getItem('arrowTheme');
      const theme = stored === 'light' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', theme);
    }

    function toggleTheme() {
      const current = document.body.getAttribute('data-theme') || 'dark';
      const next = current === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', next);
      localStorage.setItem('arrowTheme', next);
    }

    function readInputs() {
      state.inputs = {
        bowModel: getStr('bowModel'),
        shooterName: getStr('shooterName'),
        drawWeight: getNum('drawWeight'),
        drawLength: getNum('drawLength'),
        letOffPct: getNum('letOffPct'),
        launchFpsManual: getNum('launchFps'), // IBO rating override
        arrowName: getStr('arrowName'),
        arrowSpine: getNum('arrowSpine'),
        straightness: getStr('straightness'),
        arrowLength: getNum('arrowLength'),
        totalArrowWeight: getNum('totalArrowWeight'),
        balancePoint: getNum('balancePoint'),
        showComponents: $('showComponents').checked,
        bareShaftWeight: getNum('bareShaftWeight'),
        nockWeight: getNum('nockWeight'),
        wrapWeight: getNum('wrapWeight'),
        vaneCount: getNum('vaneCount'),
        vaneWeight: getNum('vaneWeight'),
        insertWeight: getNum('insertWeight'),
        pointWeight: getNum('pointWeight'),
        glueWeight: getNum('glueWeight'),
        speedLossPer10: getNum('speedLossPer10'),
        distance1: getNum('distance1'),
        distance2: getNum('distance2'),
        arcRange: getNum('arcRange'),
        velDropDistance: getNum('velDropDistance'),
        notes: getStr('notes')
      };
    }

    function calcTotalWeight() {
      const i = state.inputs;
      let componentsOk = false;

      if (i.showComponents) {
        if (i.bareShaftWeight > 0 && i.nockWeight >= 0 &&
            i.vaneCount >= 0 && i.vaneWeight >= 0 &&
            i.insertWeight >= 0 && i.pointWeight > 0) {
          componentsOk = true;
        }
      }

      let totalComponents = 0;
      if (componentsOk) {
        const vanesTotal = i.vaneCount * i.vaneWeight;
        totalComponents = i.bareShaftWeight + i.nockWeight + i.wrapWeight +
                          vanesTotal + i.insertWeight + i.pointWeight + i.glueWeight;
      }

      const total = componentsOk && totalComponents > 0
        ? totalComponents
        : i.totalArrowWeight;

      return { totalWeight: total, componentsUsed: componentsOk && totalComponents > 0, totalComponents };
    }

    function calcFOC() {
      const i = state.inputs;
      const L = i.arrowLength || 0;
      const bp = i.balancePoint || 0;
      if (L <= 0 || bp <= 0) {
        return { focPct: 0, band: 'no data', bandClass: 'bad' };
      }
      const center = L / 2;
      const foc = ((bp - center) / L) * 100;

      let band = 'no data';
      let bandClass = 'bad';
      if (foc < 8) {
        band = 'Low FOC';
        bandClass = 'warn';
      } else if (foc >= 8 && foc <= 10) {
        band = 'Borderline hunting FOC';
        bandClass = 'good';
      } else if (foc > 10 && foc <= 18) {
        band = 'Typical hunting FOC';
        bandClass = 'good';
      } else if (foc > 18 && foc <= 25) {
        band = 'High FOC';
        bandClass = 'warn';
      } else if (foc > 25) {
        band = 'Extreme FOC';
        bandClass = 'warn';
      }

      return { focPct: foc, band, bandClass };
    }

    function calcGPP(totalWeight) {
      const dw = state.inputs.drawWeight || 0;
      if (dw <= 0 || totalWeight <= 0) return { gpp: 0, band: 'no data', bandClass: 'bad' };
      const gpp = totalWeight / dw;
      let band = 'no data';
      let bandClass = 'bad';
      if (gpp < 5.3) {
        band = 'Very light';
        bandClass = 'warn';
      } else if (gpp >= 5.3 && gpp <= 6.3) {
        band = 'Light hunting';
        bandClass = 'good';
      } else if (gpp > 6.3 && gpp <= 8.0) {
        band = 'Typical hunting';
        bandClass = 'good';
      } else if (gpp > 8.0) {
        band = 'Heavy hunting';
        bandClass = 'warn';
      }
      return { gpp, band, bandClass };
    }

    function calcGPI(totalWeight) {
      const L = state.inputs.arrowLength || 0;
      if (L <= 0 || totalWeight <= 0) {
        return { gpi: 0, band: 'no data', bandClass: 'bad' };
      }
      const gpi = totalWeight / L;
      let band = 'no data';
      let bandClass = 'bad';
      if (gpi < 8) {
        band = 'Light full arrow';
        bandClass = 'warn';
      } else if (gpi >= 8 && gpi <= 10) {
        band = 'Typical hunting GPI';
        bandClass = 'good';
      } else if (gpi > 10) {
        band = 'Heavy full arrow';
        bandClass = 'warn';
      }
      return { gpi, band, bandClass };
    }

    function estimateLaunchFPS(totalWeight) {
      const dw = state.inputs.drawWeight || 0;
      const dl = state.inputs.drawLength || 0;
      if (dw <= 0 || totalWeight <= 0) return 0;

      // Simple baseline model: 70 lb / 28" / 500 gr ‚âà 280 fps
      const baseDw = 70;
      const baseWt = 500;
      const baseDl = 28;
      const baseFps = 280;

      const dwDelta = (dw - baseDw) * 2;
      const dlDelta = (dl - baseDl) * 10;
      const wtDelta = - (totalWeight - baseWt) / 5;

      let fps = baseFps + dwDelta + dlDelta + wtDelta;
      fps = Math.max(140, Math.min(340, fps));
      return fps;
    }

    function fpsAtDistance(launchFps, distanceYards) {
      const lossPer10 = state.inputs.speedLossPer10 || 0;
      if (launchFps <= 0) return 0;
      const segments = distanceYards / 10;
      const totalLossFps = lossPer10 * segments;
      const remaining = launchFps - totalLossFps;
      return Math.max(0, remaining);
    }

    function calcMomentum(grains, fps) {
      if (grains <= 0 || fps <= 0) return 0;
      return (grains * fps) / 225400;
    }

    function classifyMomentumBand(momentum) {
      let band = 'no data';
      let bandClass = 'bad';
      if (momentum <= 0) {
        band = 'no data';
        bandClass = 'bad';
      } else if (momentum < 0.35) {
        band = 'Small game / practice';
        bandClass = 'warn';
      } else if (momentum >= 0.35 && momentum < 0.45) {
        band = 'Light deer / small game';
        bandClass = 'good';
      } else if (momentum >= 0.45 && momentum < 0.55) {
        band = 'Deer-sized game';
        bandClass = 'good';
      } else if (momentum >= 0.55 && momentum < 0.65) {
        band = 'Large game (elk / grizzly bears)';
        bandClass = 'good';
      } else if (momentum >= 0.65) {
        band = 'Very large / dangerous game';
        bandClass = 'warn';
      }
      return { band, bandClass };
    }

    function updateMomentumIcons(momentum) {
      const icons = [
        { id: 'iconSmall', min: 0,    max: 0.45 },
        { id: 'iconDeer',  min: 0.45, max: 0.55 },
        { id: 'iconElk',   min: 0.55, max: 0.65 },
        { id: 'iconDanger',min: 0.65, max: 999 }
      ];
      icons.forEach(icon => {
        const el = $(icon.id);
        if (!el) return;
        el.classList.remove('active','muted');
        if (momentum <= 0) {
          el.classList.add('muted');
        } else if (momentum >= icon.min && momentum < icon.max) {
          el.classList.add('active');
        } else {
          el.classList.add('muted');
        }
      });
    }

    function updateFOCAndBalance(focInfo) {
      const i = state.inputs;
      const L = i.arrowLength || 0;
      const bp = i.balancePoint || 0;

      let balancePct = 50;
      if (L > 0 && bp > 0) {
        balancePct = Math.max(0, Math.min(100, (bp / L) * 100));
      }
      const marker = $('balanceMarker');
      if (marker) marker.style.left = balancePct + '%';
      setText('balancePointOut', bp.toFixed(2));

      const focMarker = $('focMarker');
      if (focMarker) {
        const scaled = Math.max(-10, Math.min(30, focInfo.focPct));
        const pct = ((scaled + 10) / 40) * 100;
        focMarker.style.left = pct + '%';
      }
      const focValue = isFinite(focInfo.focPct) ? focInfo.focPct.toFixed(1) : '0.0';
      setText('focValue', focValue);
      setText('focBandLabel', focInfo.band);
      const focTag = $('focTag');
      if (focTag) {
        focTag.classList.remove('good','warn','bad');
        focTag.classList.add(focInfo.bandClass || 'bad');
      }
    }

    function updateWeightComposition(totalWeight, componentsUsed) {
      const i = state.inputs;
      let shaft = 0, pointSystem = 0, tail = 0;

      if (componentsUsed) {
        shaft = i.bareShaftWeight || 0;
        pointSystem = (i.insertWeight || 0) + (i.pointWeight || 0);
        const tailPieces =
          (i.nockWeight || 0) +
          (i.wrapWeight || 0) +
          (i.vaneCount || 0) * (i.vaneWeight || 0) +
          (i.glueWeight || 0);
        tail = tailPieces;
      } else {
        if (totalWeight <= 0) {
          shaft = pointSystem = tail = 0;
        } else {
          shaft = totalWeight * 0.55;
          pointSystem = totalWeight * 0.35;
          tail = totalWeight * 0.10;
        }
      }

      const sum = shaft + pointSystem + tail;
      let sp = 0, pp = 0, tp = 0;
      if (sum > 0) {
        sp = (shaft / sum) * 100;
        pp = (pointSystem / sum) * 100;
        tp = (tail / sum) * 100;
      }

      const shaftSegment = $('shaftSegment');
      const pointSegment = $('pointSegment');
      const tailSegment = $('tailSegment');
      if (shaftSegment) shaftSegment.style.width = sp + '%';
      if (pointSegment) pointSegment.style.width = pp + '%';
      if (tailSegment) tailSegment.style.width = tp + '%';

      const legend = $('weightLegend');
      if (legend) {
        legend.textContent =
          `Shaft: ${shaft.toFixed(1)} gr (${sp.toFixed(1)} %)\n` +
          `Point system: ${pointSystem.toFixed(1)} gr (${pp.toFixed(1)} %)\n` +
          `Nock / wrap / vanes + glue: ${tail.toFixed(1)} gr (${tp.toFixed(1)} %)`;
      }

      state.computed.weightSummary = legend ? legend.textContent : '';
    }

    function drawTrajectory(totalWeight, launchFps, momentumAtFar) {
      const svg = $('trajectorySvg');
      if (!svg) return;
      while (svg.firstChild) svg.removeChild(svg.firstChild);

      const i = state.inputs;
      const arcRange = i.arcRange || i.distance2 || 60;
      const extra = 5;
      const maxX = arcRange + extra;
      const viewWidth = 320;
      const viewHeight = 210;

      let peakHeightFt = Math.min((arcRange / 60) * 4.0, 12);
      if (arcRange <= 20) peakHeightFt = 1.0 + (arcRange / 20) * 2.0;
      const yMaxFeet = peakHeightFt * 1.4 || 6;

      const padLeft = 30, padRight = 18, padTop = 20, padBottom = 35;
      const w = viewWidth - padLeft - padRight;
      const h = viewHeight - padTop - padBottom;

      function xScale(yd) { return padLeft + (yd / maxX) * w; }
      function yScale(ft) {
        const norm = Math.max(0, Math.min(yMaxFeet, ft));
        return padTop + h - (norm / yMaxFeet) * h;
      }

      const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      xAxis.setAttribute('x1', padLeft);
      xAxis.setAttribute('y1', padTop + h);
      xAxis.setAttribute('x2', padLeft + w);
      xAxis.setAttribute('y2', padTop + h);
      xAxis.setAttribute('stroke', 'rgba(148,163,184,0.9)');
      xAxis.setAttribute('stroke-width', '1');
      svg.appendChild(xAxis);

      const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      yAxis.setAttribute('x1', padLeft);
      yAxis.setAttribute('y1', padTop);
      yAxis.setAttribute('x2', padLeft);
      yAxis.setAttribute('y2', padTop + h);
      yAxis.setAttribute('stroke', 'rgba(148,163,184,0.8)');
      yAxis.setAttribute('stroke-width', '1');
      svg.appendChild(yAxis);

      const xLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      xLabel.setAttribute('x', padLeft + w / 2);
      xLabel.setAttribute('y', padTop + h + 22);
      xLabel.setAttribute('text-anchor', 'middle');
      xLabel.setAttribute('font-size', '9');
      xLabel.setAttribute('fill', 'rgba(148,163,184,0.9)');
      xLabel.textContent = 'Distance (yd)';
      svg.appendChild(xLabel);

      const yLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      yLabel.setAttribute('x', padLeft - 22);
      yLabel.setAttribute('y', padTop + h / 2);
      yLabel.setAttribute('text-anchor', 'middle');
      yLabel.setAttribute('font-size', '9');
      yLabel.setAttribute('fill', 'rgba(148,163,184,0.9)');
      yLabel.setAttribute('transform', `rotate(-90 ${padLeft-22} ${padTop + h/2})`);
      yLabel.textContent = 'Height (ft)';
      svg.appendChild(yLabel);

      const midX = arcRange / 2;
      const k = peakHeightFt / (midX * midX || 1);

      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      let d = '';
      const steps = 40;
      let peakX = xScale(midX);
      let peakY = yScale(peakHeightFt);

      for (let s = 0; s <= steps; s++) {
        const yd = (arcRange * s) / steps;
        const xRel = yd - midX;
        const heightFt = peakHeightFt - k * xRel * xRel;
        const X = xScale(yd);
        const Y = yScale(Math.max(0, heightFt));
        if (s === 0) {
          d += 'M' + X + ' ' + Y + ' ';
        } else {
          d += 'L' + X + ' ' + Y + ' ';
        }
      }
      path.setAttribute('d', d.trim());
      path.setAttribute('fill', 'none');
      path.setAttribute('stroke', '#22c55e');
      path.setAttribute('stroke-width', '2');
      svg.appendChild(path);

      const peakLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      peakLabel.setAttribute('x', peakX);
      peakLabel.setAttribute('y', peakY - 4);
      peakLabel.setAttribute('text-anchor', 'middle');
      peakLabel.setAttribute('font-size', '9');
      peakLabel.setAttribute('fill', 'rgba(248,250,252,0.95)');
      peakLabel.textContent = `${peakHeightFt.toFixed(1)} ft`;
      svg.appendChild(peakLabel);

      const launchLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      launchLabel.setAttribute('x', padLeft + 4);
      launchLabel.setAttribute('y', padTop + h - 6);
      launchLabel.setAttribute('font-size', '9');
      launchLabel.setAttribute('fill', 'rgba(148,163,184,0.9)');
      launchLabel.textContent = '0 yd';
      svg.appendChild(launchLabel);

      const tgtLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      tgtLabel.setAttribute('x', xScale(arcRange) - 4);
      tgtLabel.setAttribute('y', padTop + h - 6);
      tgtLabel.setAttribute('font-size', '9');
      tgtLabel.setAttribute('fill', 'rgba(148,163,184,0.9)');
      tgtLabel.setAttribute('text-anchor', 'end');
      tgtLabel.textContent = `${arcRange.toFixed(0)} yd`;
      svg.appendChild(tgtLabel);

      const maxYd = maxX;
      const summary = `Horizontal axis ‚âà 0‚Äì${maxYd.toFixed(0)} yd (arc set to ~${arcRange.toFixed(0)} yd). Peak height ‚âà ${peakHeightFt.toFixed(1)} ft.`;
      setText('trajectorySummary', summary);
      setValue('arcMetaInline', `Peak ‚âà ${peakHeightFt.toFixed(1)} ft`);
      state.computed.trajectorySummary = summary;
    }

    function maybeSuggestSpeedLoss(launchFpsUsed, gpp) {
      if (speedLossManual) return;
      let suggested = 5;

      if (gpp > 8 || launchFpsUsed < 250) {
        suggested = 4;
      } else if (gpp < 6 && launchFpsUsed > 280) {
        suggested = 6;
      }

      setValue('speedLossPer10', suggested.toFixed(1).replace(/\.0$/, ''));
      state.inputs.speedLossPer10 = suggested;
    }

    function updateVelocityDropAndTof(launchFpsUsed) {
      const distEl = $('velDropDistance');
      if (!distEl) return;

      const distYd = parseFloat(distEl.value) || 0;
      setText('velDropDistanceValue', distYd.toFixed(0));

      if (launchFpsUsed <= 0 || distYd <= 0) {
        setText('velDropVelocity', '0');
        setText('velDropTof', '0.00');
        state.computed.velDropDistance = distYd;
        state.computed.velDropVelocity = 0;
        state.computed.velDropTof = 0;
        return;
      }

      const vAtD = fpsAtDistance(launchFpsUsed, distYd);
      setText('velDropVelocity', vAtD.toFixed(1));

      const avgVel = (launchFpsUsed + vAtD) / 2;
      let tof = 0;
      if (avgVel > 0) {
        const distanceFeet = distYd * 3; // yards ‚Üí feet
        tof = distanceFeet / avgVel;
      }
      setText('velDropTof', tof.toFixed(2));

      state.computed.velDropDistance = distYd;
      state.computed.velDropVelocity = vAtD;
      state.computed.velDropTof = tof;
    }

    function updateEfficiency(totalWeight, launchFpsUsed) {
      const dw = state.inputs.drawWeight || 0;
      const dl = state.inputs.drawLength || 0;
      const efficiencyValueEl = $('efficiencyValue');
      const efficiencyTag = $('efficiencyTag');
      const efficiencyBandLabel = $('efficiencyBandLabel');
      const efficiencyMarker = $('efficiencyMarker');
      const efficiencyTip = $('efficiencyTip');

      if (!efficiencyValueEl || !efficiencyTag || !efficiencyBandLabel || !efficiencyMarker || !efficiencyTip) {
        return;
      }

      if (dw <= 0 || dl <= 0 || totalWeight <= 0 || launchFpsUsed <= 0) {
        efficiencyValueEl.textContent = '0';
        efficiencyBandLabel.textContent = '(no data)';
        efficiencyTag.classList.remove('good','warn','bad');
        efficiencyTag.classList.add('bad');
        efficiencyMarker.style.left = '0%';
        efficiencyTip.textContent = 'Enter draw weight, draw length, and arrow details to see the match score.';
        state.computed.efficiencyPct = 0;
        state.computed.efficiencyBand = 'no data';
        return;
      }

      // Stored energy (approx) in ft-lbs: (DW * DL / 2) / 12 (DL in inches)
      const storedEnergy = (dw * dl / 2) / 12;

      // Arrow KE (ft-lbs): (grains * v^2) / 450240
      const ke = (totalWeight * launchFpsUsed * launchFpsUsed) / 450240;

      let effPct = storedEnergy > 0 ? (ke / storedEnergy) * 100 : 0;
      effPct = Math.max(0, Math.min(120, effPct)); // clamp

      let band = 'no data';
      let bandClass = 'bad';
      let tip = '';

      if (effPct < 60) {
        band = 'Under-driven (light arrow for this bow)';
        bandClass = 'warn';
        tip = 'You may gain penetration and consistency by adding some arrow weight (heavier point or insert).';
      } else if (effPct >= 60 && effPct <= 85) {
        band = 'Balanced (good energy transfer)';
        bandClass = 'good';
        tip = 'Nice match. You can tweak FOC or point weight based on your hunting or 3D goals.';
      } else {
        band = 'Very heavy / sluggish';
        bandClass = 'warn';
        tip = 'Arrow may be overly heavy for this bow. Consider lightening the point or total weight for flatter trajectory.';
      }

      efficiencyValueEl.textContent = effPct.toFixed(1);
      efficiencyBandLabel.textContent = band;
      efficiencyTag.classList.remove('good','warn','bad');
      efficiencyTag.classList.add(bandClass);
      efficiencyTip.textContent = tip;

      const markerPct = (effPct / 120) * 100;
      efficiencyMarker.style.left = markerPct.toFixed(1) + '%';

      state.computed.efficiencyPct = effPct;
      state.computed.efficiencyBand = band;
    }

    function updateDataTable(totalWeight, focInfo, gppInfo, gpiInfo, launchFpsUsed, fps1, fps2, momentum, momentumBandObj) {
      const body = $('dataTableBody');
      if (!body) return;
      body.innerHTML = '';

      if (!state.inputs.showComponents) {
        return;
      }

      const rows = [];
      const now = new Date();
      const timestamp = now.toISOString();
      state.computed.timestamp = timestamp;

      function addRow(field, value, type) {
        rows.push({ field, value, type });
      }

      addRow('Timestamp', timestamp, 'calc');

      // Bow
      addRow('Bow model & year', state.inputs.bowModel, 'input');
      addRow('Shooter name', state.inputs.shooterName, 'input');
      addRow('Draw weight (lb)', state.inputs.drawWeight, 'input');
      addRow('Draw length (in)', state.inputs.drawLength, 'input');
      addRow('Let-off (%)', state.inputs.letOffPct, 'input');
      addRow('IBO rating / manual FPS', state.inputs.launchFpsManual, 'input');

      // Arrow
      addRow('Arrow name', state.inputs.arrowName, 'input');
      addRow('Arrow spine', state.inputs.arrowSpine, 'input');
      addRow('Straightness', state.inputs.straightness, 'input');
      addRow('Arrow length (in)', state.inputs.arrowLength, 'input');
      addRow('Total arrow weight (gr, used)', totalWeight.toFixed(1), 'calc');
      addRow('Balance point (in)', state.inputs.balancePoint.toFixed(2), 'input');

      // Components
      addRow('Bare shaft weight (gr)', state.inputs.bareShaftWeight, 'input');
      addRow('Nock weight (gr)', state.inputs.nockWeight, 'input');
      addRow('Wrap weight (gr)', state.inputs.wrapWeight, 'input');
      addRow('Vane count', state.inputs.vaneCount, 'input');
      addRow('Vane weight (gr)', state.inputs.vaneWeight, 'input');
      addRow('Insert weight (gr)', state.inputs.insertWeight, 'input');
      addRow('Point weight (gr)', state.inputs.pointWeight, 'input');
      addRow('Glue weight (gr)', state.inputs.glueWeight, 'input');

      // FOC / GPP / GPI
      addRow('FOC (%)', focInfo.focPct.toFixed(2), 'calc');
      addRow('FOC band', focInfo.band, 'calc');
      addRow('GPP', gppInfo.gpp.toFixed(2), 'calc');
      addRow('GPP band', gppInfo.band, 'calc');
      addRow('Arrow GPI (full)', gpiInfo.gpi.toFixed(2), 'calc');
      addRow('GPI band', gpiInfo.band, 'calc');

      // Kinetics
      addRow('Launch FPS (used)', launchFpsUsed.toFixed(1), 'calc');
      addRow('Speed loss per 10 yd (fps)', state.inputs.speedLossPer10.toFixed(1), 'input');
      addRow('FPS @ Distance 1', fps1.toFixed(1), 'calc');
      addRow('FPS @ Distance 2', fps2.toFixed(1), 'calc');
      addRow('Momentum @ farthest', momentum.toFixed(3) + ' slug¬∑ft/s', 'calc');
      addRow('Momentum band', momentumBandObj.band, 'calc');

      // Efficiency
      addRow('Efficiency (%)', (state.computed.efficiencyPct || 0).toFixed(1), 'calc');
      addRow('Efficiency band', state.computed.efficiencyBand || 'no data', 'calc');

      // Velocity drop sample
      addRow('Vel-drop sample distance (yd)', state.computed.velDropDistance ?? 0, 'calc');
      addRow('Vel-drop velocity at distance (fps)', (state.computed.velDropVelocity ?? 0).toFixed(1), 'calc');
      addRow('Vel-drop time-of-flight (s)', (state.computed.velDropTof ?? 0).toFixed(2), 'calc');

      // Weight & trajectory
      addRow('Weight composition', state.computed.weightSummary || '', 'calc');
      addRow('Trajectory summary', state.computed.trajectorySummary || '', 'calc');

      // Notes
      addRow('Notes', state.inputs.notes, 'input');

      rows.forEach(r => {
        const tr = document.createElement('tr');
        const tdField = document.createElement('td');
        const tdValue = document.createElement('td');
        const tdType = document.createElement('td');

        tdField.textContent = r.field;
        tdValue.textContent = r.value;

        const span = document.createElement('span');
        span.className = 'type-badge ' + (r.type === 'input' ? 'input' : 'calc');
        span.textContent = r.type === 'input' ? 'input' : 'calc';
        tdType.appendChild(span);

        tr.appendChild(tdField);
        tr.appendChild(tdValue);
        tr.appendChild(tdType);
        body.appendChild(tr);
      });
    }

    function refreshSavedBuildName(totalWeight, focInfo) {
      const bowModel = state.inputs.bowModel || 'Bow';
      const arrowName = state.inputs.arrowName || 'Arrow';
      const dw = state.inputs.drawWeight || 0;
      const month = String(new Date().getMonth() + 1).padStart(2, '0');
      const year = new Date().getFullYear();
      const label = `${year}-${month} ${bowModel} ${arrowName} ${totalWeight.toFixed(0)} gr ${dw.toFixed(0)} lb draw`;
      setValue('savedBuildName', label);
    }

    function saveBuild() {
      const name = getStr('savedBuildName') || '(unnamed build)';
      if (!state.computed || !state.inputs) return;
      const build = {
        name,
        savedAt: new Date().toISOString(),
        inputs: state.inputs,
        computed: state.computed
      };
      state.savedBuilds.push(build);
      localStorage.setItem('arrowSavedBuilds', JSON.stringify(state.savedBuilds));
      renderSavedBuildsSelect();
    }

    function loadSavedBuildsFromStorage() {
      const raw = localStorage.getItem('arrowSavedBuilds');
      if (!raw) {
        state.savedBuilds = [];
        return;
      }
      try {
        state.savedBuilds = JSON.parse(raw) || [];
      } catch {
        state.savedBuilds = [];
      }
    }

    function renderSavedBuildsSelect() {
      const select = $('savedBuildsSelect');
      if (!select) return;
      select.innerHTML = '<option value="">(none yet)</option>';
      state.savedBuilds.forEach((b, idx) => {
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = b.name;
        select.appendChild(opt);
      });
    }

    function loadBuildIntoForm(index) {
      const idx = parseInt(index, 10);
      if (isNaN(idx) || idx < 0 || idx >= state.savedBuilds.length) return;
      const b = state.savedBuilds[idx];
      const i = b.inputs || {};

      function maybeSet(id, v) {
        if ($(id) != null && v !== undefined && v !== null) setValue(id, v);
      }

      maybeSet('bowModel', i.bowModel);
      maybeSet('shooterName', i.shooterName);
      maybeSet('drawWeight', i.drawWeight);
      maybeSet('drawLength', i.drawLength);
      maybeSet('letOffPct', i.letOffPct);
      maybeSet('launchFps', i.launchFpsManual);
      maybeSet('arrowName', i.arrowName);
      maybeSet('arrowSpine', i.arrowSpine);
      maybeSet('straightness', i.straightness);
      maybeSet('arrowLength', i.arrowLength);
      maybeSet('totalArrowWeight', i.totalArrowWeight);
      maybeSet('balancePoint', i.balancePoint);
      $('showComponents').checked = !!i.showComponents;
      maybeSet('bareShaftWeight', i.bareShaftWeight);
      maybeSet('nockWeight', i.nockWeight);
      maybeSet('wrapWeight', i.wrapWeight);
      maybeSet('vaneCount', i.vaneCount);
      maybeSet('vaneWeight', i.vaneWeight);
      maybeSet('insertWeight', i.insertWeight);
      maybeSet('pointWeight', i.pointWeight);
      maybeSet('glueWeight', i.glueWeight);
      maybeSet('speedLossPer10', i.speedLossPer10);
      maybeSet('distance1', i.distance1);
      maybeSet('distance2', i.distance2);
      maybeSet('arcRange', i.arcRange);
      maybeSet('velDropDistance', i.velDropDistance || 40);
      maybeSet('notes', i.notes);

      $('componentsSection').style.display = i.showComponents ? 'block' : 'none';

      readInputs();
      recalcAndRender();
    }

    function downloadInputsCsv() {
      const i = state.inputs;
      const headers = DATA_FIELDS_ORDER.join(',');
      const vals = DATA_FIELDS_ORDER.map(f => {
        if (f === 'timestamp') return new Date().toISOString();
        return JSON.stringify(
          (i[f] !== undefined ? i[f] : state.computed[f]) ?? ''
        );
      }).join(',');
      const csv = headers + '\n' + vals + '\n';
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'arrow-tune-inputs.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function handleCsvUpload(e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const text = String(reader.result || '');
        const lines = text.trim().split(/\r?\n/);
        if (lines.length < 2) return;
        const headers = lines[0].split(',');
        const vals = lines[1].split(',');
        const map = {};
        headers.forEach((h, idx) => {
          const key = h.trim();
          let v = vals[idx] || '';
          v = v.trim();
          if ((v.startsWith('"') && v.endsWith('"')) || (v.startsWith("'") && v.endsWith("'"))) {
            v = v.slice(1, -1);
          }
          map[key] = v;
        });

        function numericOrZero(k) {
          const v = parseFloat(map[k]);
          return isNaN(v) ? 0 : v;
        }

        setValue('bowModel', map.bowModel || '');
        setValue('shooterName', map.shooterName || '');
        setValue('drawWeight', numericOrZero('drawWeight'));
        setValue('drawLength', numericOrZero('drawLength'));
        setValue('letOffPct', numericOrZero('letOffPct'));
        setValue('launchFps', numericOrZero('launchFpsManual') || numericOrZero('launchFpsUsed'));
        setValue('arrowName', map.arrowName || '');
        setValue('arrowSpine', numericOrZero('arrowSpine'));
        setValue('straightness', map.straightness || '');
        setValue('arrowLength', numericOrZero('arrowLength'));
        setValue('totalArrowWeight', numericOrZero('totalArrowWeight'));
        setValue('balancePoint', numericOrZero('balancePoint'));
        setValue('bareShaftWeight', numericOrZero('bareShaftWeight'));
        setValue('nockWeight', numericOrZero('nockWeight'));
        setValue('wrapWeight', numericOrZero('wrapWeight'));
        setValue('vaneCount', numericOrZero('vaneCount'));
        setValue('vaneWeight', numericOrZero('vaneWeight'));
        setValue('insertWeight', numericOrZero('insertWeight'));
        setValue('pointWeight', numericOrZero('pointWeight'));
        setValue('glueWeight', numericOrZero('glueWeight'));
        setValue('speedLossPer10', numericOrZero('speedLossPer10'));
        setValue('distance1', numericOrZero('distance1'));
        setValue('distance2', numericOrZero('distance2'));
        setValue('arcRange', numericOrZero('arcRange'));
        setValue('velDropDistance', numericOrZero('velDropDistance') || 40);
        setValue('notes', map.notes || '');

        const showComp = !!map.showComponents;
        $('showComponents').checked = showComp;
        $('componentsSection').style.display = showComp ? 'block' : 'none';

        speedLossManual = true;

        readInputs();
        recalcAndRender();
      };
      reader.readAsText(file);
    }

    function recalcAndRender() {
      const totalInfo = calcTotalWeight();
      const totalWeight = totalInfo.totalWeight || 0;
      const focInfo = calcFOC();
      const gppInfo = calcGPP(totalWeight);
      const gpiInfo = calcGPI(totalWeight);

      const launchFpsAuto = estimateLaunchFPS(totalWeight);
      const launchFpsUsed = state.inputs.launchFpsManual > 0
        ? state.inputs.launchFpsManual
        : launchFpsAuto;

      maybeSuggestSpeedLoss(launchFpsUsed, gppInfo.gpp);

      const fpsD1 = fpsAtDistance(launchFpsUsed, state.inputs.distance1 || 0);
      const fpsD2 = fpsAtDistance(launchFpsUsed, state.inputs.distance2 || 0);
      const momentumFarthest = calcMomentum(totalWeight, fpsD2);
      const momentumBandObj = classifyMomentumBand(momentumFarthest);

      state.computed = {
        ...state.computed,
        totalWeight,
        focPct: focInfo.focPct,
        focBand: focInfo.band,
        gpp: gppInfo.gpp,
        gppBand: gppInfo.band,
        gpiFull: gpiInfo.gpi,
        gpiBand: gpiInfo.band,
        launchFpsUsed,
        fpsAtD1: fpsD1,
        fpsAtD2: fpsD2,
        momentumFarthest,
        momentumBand: momentumBandObj.band
      };

      // Summary outputs
      setText('totalWeightOut', totalWeight.toFixed(1));
      setText('gppValue', gppInfo.gpp.toFixed(2));
      setText('gppBandLabel', gppInfo.band);
      const gppTag = $('gppTag');
      if (gppTag) {
        gppTag.classList.remove('good','warn','bad');
        gppTag.classList.add(gppInfo.bandClass || 'bad');
      }

      setText('gpiFullValue', gpiInfo.gpi.toFixed(2));
      setText('gpiBandLabel', gpiInfo.band);
      const gpiTag = $('gpiTag');
      if (gpiTag) {
        gpiTag.classList.remove('good','warn','bad');
        gpiTag.classList.add(gpiInfo.bandClass || 'bad');
      }

      setValue('fpsAtD1', fpsD1 ? fpsD1.toFixed(1) : '');
      setValue('fpsAtD2', fpsD2 ? fpsD2.toFixed(1) : '');
      setText('momentumValue', momentumFarthest.toFixed(3));
      updateMomentumIcons(momentumFarthest);

      const bandShort = `${momentumFarthest.toFixed(3)} slug¬∑ft/s ‚Üí ${momentumBandObj.band}`;
      setText('momentumBandShort', bandShort);
      const farLabel = `At ~${(state.inputs.distance2 || 60).toFixed(0)} yd: ${momentumFarthest.toFixed(3)} slug¬∑ft/s ‚Üí ${momentumBandObj.band}`;
      setText('momentumBandResult', farLabel);

      updateFOCAndBalance(focInfo);
      updateWeightComposition(totalWeight, totalInfo.componentsUsed);
      drawTrajectory(totalWeight, launchFpsUsed, momentumFarthest);

      // New: velocity drop & TOF and efficiency ratio
      updateVelocityDropAndTof(launchFpsUsed);
      updateEfficiency(totalWeight, launchFpsUsed);

      updateDataTable(totalWeight, focInfo, gppInfo, gpiInfo, launchFpsUsed, fpsD1, fpsD2, momentumFarthest, momentumBandObj);
    }

    function onAnyInputChange() {
      readInputs();
      recalcAndRender();
    }

    function onArcRangeChange() {
      readInputs();
      recalcAndRender();
    }

    function onVelDropChange() {
      readInputs();
      const totalInfo = calcTotalWeight();
      const totalWeight = totalInfo.totalWeight || 0;
      const launchFpsAuto = estimateLaunchFPS(totalWeight);
      const launchFpsUsed = state.inputs.launchFpsManual > 0
        ? state.inputs.launchFpsManual
        : launchFpsAuto;
      updateVelocityDropAndTof(launchFpsUsed);
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadTheme();

      document.querySelectorAll('.info-icon').forEach(btn => {
        btn.addEventListener('click', toggleInfo);
      });

      const themeToggle = $('themeToggle');
      if (themeToggle) themeToggle.addEventListener('click', toggleTheme);

      document.addEventListener('input', (e) => {
        const target = e.target;
        if (!target) return;
        if (target.id === 'csvUpload') return;

        if (target.id === 'speedLossPer10') {
          speedLossManual = true;
        }

        if (target.id === 'arcRange') {
          onArcRangeChange();
          return;
        }

        if (target.id === 'velDropDistance') {
          onVelDropChange();
          return;
        }

        onAnyInputChange();
      });

      const showComponents = $('showComponents');
      if (showComponents) {
        showComponents.addEventListener('change', () => {
          $('componentsSection').style.display = showComponents.checked ? 'block' : 'none';
          onAnyInputChange();
        });
      }

      const csvUpload = $('csvUpload');
      if (csvUpload) {
        csvUpload.addEventListener('change', handleCsvUpload);
      }

      const saveBtn = $('saveBuildBtn');
      if (saveBtn) {
        saveBtn.addEventListener('click', () => {
          readInputs();
          recalcAndRender();
          saveBuild();
        });
      }

      const refreshNameBtn = $('refreshNameBtn');
      if (refreshNameBtn) {
        refreshNameBtn.addEventListener('click', () => {
          readInputs();
          const totalInfo = calcTotalWeight();
          const focInfo = calcFOC();
          refreshSavedBuildName(totalInfo.totalWeight || 0, focInfo);
        });
      }

      const loadBuildBtn = $('loadBuildBtn');
      if (loadBuildBtn) {
        loadBuildBtn.addEventListener('click', () => {
          const select = $('savedBuildsSelect');
          if (!select) return;
          const idx = select.value;
          if (!idx) return;
          loadBuildIntoForm(idx);
        });
      }

      const downloadInputsCsvBtn = $('downloadInputsCsvBtn');
      if (downloadInputsCsvBtn) {
        downloadInputsCsvBtn.addEventListener('click', downloadInputsCsv);
      }

      const learnMomentum = $('learnMomentum');
      if (learnMomentum) {
        learnMomentum.addEventListener('click', () => {
          const panel = $('momentumLearnPanel');
          if (!panel) return;
          panel.hidden = !panel.hidden;
        });
      }

      loadSavedBuildsFromStorage();
      renderSavedBuildsSelect();
      readInputs();
      recalcAndRender();
    });
  </script>
</body>
</html>