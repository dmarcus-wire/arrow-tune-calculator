<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Arrow Tune Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Arrow Tune Calculator v1.0.1 ‚Äì 2025-11-24 -->
  <style>
    :root {
      --bg: #020617;
      --bg-card: #030712;
      --bg-elevated: #020617;
      --bg-soft: #0b1220;
      --border: #1f2937;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --accent-strong: #16a34a;
      --accent-warn: #f97316;
      --accent-bad: #ef4444;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --text-soft: #6b7280;
      --shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.8);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --focus-ring: 0 0 0 1px #22c55e, 0 0 0 4px rgba(34, 197, 94, 0.3);
      --danger: #ef4444;
      --info: #38bdf8;
    }

    [data-theme="light"] {
      --bg: #f5f3e8;
      --bg-card: #ffffff;
      --bg-elevated: #fdfaf3;
      --bg-soft: #f2eee2;
      --border: #d4d4d4;
      --accent: #15803d;
      --accent-soft: rgba(21, 128, 61, 0.08);
      --accent-strong: #16a34a;
      --accent-warn: #ea580c;
      --accent-bad: #b91c1c;
      --text: #111827;
      --text-muted: #4b5563;
      --text-soft: #6b7280;
      --shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.18);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0b1120, var(--bg));
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      background: radial-gradient(circle at top left, rgba(34, 197, 94, 0.03), transparent),
        radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.03), transparent),
        var(--bg-card);
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      padding: 20px 18px 24px;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    @media (min-width: 960px) {
      .app-shell {
        padding: 24px 28px 30px;
      }
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h1 span.logo-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #a3e635);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.8);
    }

    .subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .chip-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 2px;
    }

    .chip {
      border-radius: 999px;
      padding: 2px 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-size: 0.75rem;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.9),
        rgba(30, 64, 175, 0.4)
      );
    }

    [data-theme="light"] .chip {
      background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 1),
        rgba(254, 250, 241, 0.9)
      );
    }

    .chip svg {
      width: 12px;
      height: 12px;
      opacity: 0.9;
    }

    .version-pill {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .theme-toggle {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 3px 8px;
      font-size: 0.75rem;
      cursor: pointer;
      background: radial-gradient(circle at top, rgba(250, 250, 250, 0.06), transparent),
        transparent;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.25s ease, border-color 0.25s ease, transform 0.15s ease;
    }

    .theme-toggle:hover {
      border-color: var(--accent);
      color: var(--accent-strong);
      transform: translateY(-0.5px);
    }

    .theme-toggle span.icon {
      font-size: 0.85rem;
    }

    .save-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 4px 10px;
      font-size: 0.8rem;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 64, 175, 0.5));
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.18s ease, transform 0.12s ease, box-shadow 0.18s ease;
    }

    [data-theme="light"] .btn {
      background: radial-gradient(circle at top, #fefce8, #f9fafb);
    }

    .btn:hover {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(30, 64, 175, 0.7));
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.7);
      transform: translateY(-0.5px);
    }

    .btn-primary {
      border-color: var(--accent-strong);
      background: linear-gradient(135deg, var(--accent-strong), #22c55e);
      color: #022c22;
      font-weight: 600;
    }

    .btn-primary:hover {
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.9);
      transform: translateY(-0.5px);
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.1fr);
      gap: 16px;
      margin-top: 10px;
    }

    @media (max-width: 960px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .col {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .panel {
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), var(--bg-card));
      border: 1px solid rgba(148, 163, 184, 0.55);
      padding: 12px 12px 14px;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.7);
    }

    [data-theme="light"] .panel {
      background: radial-gradient(circle at top, #fefce8, #ffffff);
      border-color: rgba(148, 163, 184, 0.8);
      box-shadow: 0 10px 20px rgba(148, 163, 184, 0.4);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 8px;
    }

    .panel-title {
      font-size: 1.0rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text);
    }

    .panel-subtitle {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .section-title-sm {
      font-size: 0.95rem;
      font-weight: 700;
      margin: 4px 0 4px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .info-icon {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--info);
      width: 18px;
      height: 18px;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    [data-theme="light"] .info-icon {
      background: #ffffff;
    }

    .info-icon:hover {
      border-color: var(--info);
    }

    .info-text {
      font-size: 0.76rem;
      color: var(--text-soft);
      margin-top: 4px;
      padding: 4px 6px;
      border-left: 2px solid rgba(148, 163, 184, 0.7);
      background: radial-gradient(circle at left, rgba(15, 23, 42, 0.7), transparent);
      border-radius: 0 10px 10px 0;
    }

    [data-theme="light"] .info-text {
      background: radial-gradient(circle at left, #fefce8, transparent);
    }

    .info-text[hidden] {
      display: none;
    }

    .field-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 10px;
    }

    @media (max-width: 720px) {
      .field-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .field-label {
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text-muted);
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .field-label span.aux {
      font-weight: 400;
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .field input,
    .field textarea,
    .field select {
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text);
      font-size: 0.84rem;
      padding: 6px 8px;
      outline: none;
      width: 100%;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background 0.15s ease, transform 0.08s ease;
    }

    [data-theme="light"] .field input,
    [data-theme="light"] .field textarea,
    [data-theme="light"] .field select {
      background: #ffffff;
    }

    .field input:focus,
    .field textarea:focus,
    .field select:focus {
      border-color: var(--accent);
      box-shadow: var(--focus-ring);
      transform: translateY(-0.5px);
    }

    .field input[readonly] {
      background: rgba(15, 23, 42, 0.65);
      color: var(--text-muted);
    }

    [data-theme="light"] .field input[readonly] {
      background: #f9fafb;
    }

    .field textarea {
      min-height: 70px;
      resize: vertical;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .toggle-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .chip-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.76rem;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.8));
      color: var(--text-soft);
      margin-top: 4px;
    }

    [data-theme="light"] .chip-tag {
      background: radial-gradient(circle at top, #fefce8, #ffffff);
    }

    .chip-tag.good {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .chip-tag.warn {
      border-color: var(--accent-warn);
      background: rgba(249, 115, 22, 0.12);
      color: var(--accent-warn);
    }

    .chip-tag.bad {
      border-color: var(--accent-bad);
      background: rgba(239, 68, 68, 0.12);
      color: var(--accent-bad);
    }

    .chip-tag strong {
      font-weight: 700;
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    @media (max-width: 720px) {
      .results-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .result-pill {
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      padding: 6px 8px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.7));
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.8rem;
      min-height: 40px;
    }

    [data-theme="light"] .result-pill {
      background: radial-gradient(circle at top, #fefce8, #ffffff);
    }

    .result-label {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .result-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text);
    }

    .result-note {
      font-size: 0.72rem;
      color: var(--text-soft);
    }

    .visual-section {
      margin-top: 8px;
      border-radius: var(--radius-md);
      padding: 8px 10px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.7));
    }

    [data-theme="light"] .visual-section {
      background: radial-gradient(circle at top, #fefce8, #ffffff);
    }

    .visual-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .visual-title {
      font-size: 0.86rem;
      font-weight: 700;
      color: var(--text);
      text-align: left;
    }

    .visual-subtext {
      font-size: 0.72rem;
      color: var(--text-soft);
    }

    .visual-row {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 10px;
    }

    @media (max-width: 900px) {
      .visual-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .gauge-bar {
      position: relative;
      margin: 6px 0 2px;
      height: 14px;
      border-radius: 999px;
      background: linear-gradient(
        90deg,
        rgba(148, 163, 184, 0.3),
        rgba(148, 163, 184, 0.6)
      );
      overflow: hidden;
    }

    .gauge-range {
      position: absolute;
      left: 40%;
      width: 18%;
      top: 0;
      bottom: 0;
      background: linear-gradient(90deg, rgba(34, 197, 94, 0.3), rgba(22, 163, 74, 0.7));
    }

    .gauge-marker {
      position: absolute;
      top: -3px;
      width: 2px;
      bottom: -3px;
      background: #22c55e;
      box-shadow: 0 0 6px rgba(34, 197, 94, 0.9);
    }

    .gauge-axis-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .balance-bar {
      position: relative;
      height: 10px;
      margin: 6px 0 3px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(37, 99, 235, 0.3), rgba(22, 163, 74, 0.3));
      overflow: hidden;
    }

    .balance-mid {
      position: absolute;
      width: 2px;
      top: -3px;
      bottom: -3px;
      left: 50%;
      background: rgba(249, 250, 252, 0.85);
      opacity: 0.7;
    }

    .balance-marker {
      position: absolute;
      width: 4px;
      top: -3px;
      bottom: -3px;
      background: #f97316;
      box-shadow: 0 0 6px rgba(249, 115, 22, 0.9);
      border-radius: 999px;
    }

    .balance-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .weight-composition-layout {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .weight-bar {
      position: relative;
      margin-top: 6px;
      height: 16px;
      max-width: 360px;
      width: 100%;
      border-radius: 999px;
      overflow: hidden;
      display: flex;
    }

    .weight-segment {
      height: 100%;
    }

    .weight-segment.shaft {
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.95));
    }

    .weight-segment.point {
      background: linear-gradient(90deg, rgba(220, 38, 38, 0.9), rgba(248, 113, 113, 0.95));
    }

    .weight-segment.tail {
      background: linear-gradient(90deg, rgba(16, 185, 129, 0.9), rgba(52, 211, 153, 0.95));
    }

    .weight-midline {
      position: absolute;
      left: 50%;
      top: -3px;
      bottom: -3px;
      width: 2px;
      background: rgba(248, 250, 252, 0.9);
      opacity: 0.8;
    }

    .weight-legend {
      font-size: 0.75rem;
      color: var(--text-soft);
      text-align: center;
      margin-top: 4px;
      white-space: pre-line;
    }

    .momentum-icons {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      margin-top: 4px;
      font-size: 0.78rem;
    }

    .game-icon {
      flex: 1;
      text-align: center;
      border-radius: 999px;
      padding: 4px 3px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1px;
    }

    .game-icon span.emoji {
      font-size: 1rem;
    }

    .game-icon span.label {
      font-size: 0.7rem;
    }

    .game-icon.active {
      border-color: var(--accent-strong);
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-weight: 600;
    }

    .game-icon.muted {
      opacity: 0.55;
    }

    .learn-link {
      font-size: 0.75rem;
      color: var(--info);
      cursor: pointer;
      margin-top: 4px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .learn-link:hover {
      text-decoration: underline;
    }

    .trajectory-wrap {
      margin-top: 6px;
    }

    .trajectory-svg {
      width: 100%;
      max-width: 380px;
      height: auto;
      max-height: 260px;
      display: block;
      margin: 0 auto;
      border-radius: 12px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(2, 6, 23, 1));
      border: 1px solid rgba(148, 163, 184, 0.8);
    }

    [data-theme="light"] .trajectory-svg {
      background: radial-gradient(circle at top, #eef2ff, #ffffff);
    }

    .trajectory-meta {
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .notes-layout {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .notes-layout textarea {
      min-height: 80px;
    }

    .data-table-wrap {
      margin-top: 6px;
      max-height: 260px;
      overflow: auto;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.9));
    }

    [data-theme="light"] .data-table-wrap {
      background: radial-gradient(circle at top, #fefce8, #ffffff);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: rgba(15, 23, 42, 0.95);
      z-index: 1;
    }

    [data-theme="light"] thead {
      background: #fef3c7;
    }

    th,
    td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.5);
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      color: var(--text-soft);
    }

    tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.7);
    }

    [data-theme="light"] tbody tr:nth-child(odd) {
      background: rgba(254, 249, 195, 0.5);
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.85);
    }

    [data-theme="light"] tbody tr:nth-child(even) {
      background: #ffffff;
    }

    .type-badge {
      display: inline-block;
      padding: 1px 5px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--text-soft);
    }

    .type-badge.input {
      border-color: rgba(59, 130, 246, 0.9);
      color: #60a5fa;
    }

    .type-badge.calc {
      border-color: var(--accent-strong);
      color: var(--accent-strong);
    }

    .saved-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-top: 4px;
    }

    .saved-row input {
      max-width: 320px;
    }

    .csv-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-top: 4px;
      font-size: 0.76rem;
      color: var(--text-soft);
    }

    .csv-row input[type="file"] {
      font-size: 0.72rem;
      max-width: 230px;
    }

    .small {
      font-size: 0.72rem;
    }
  </style>
</head>
<body data-theme="dark">
  <div class="app-shell">
    <header class="header-row">
      <div class="title-block">
        <h1>
          <span class="logo-dot"></span>
          Arrow Tune Calculator
        </h1>
        <div class="subtitle">
          Visual, data-rich arrow tuning for bowhunters & target archers.
        </div>
        <div class="chip-row">
          <div class="chip">
            <svg aria-hidden="true" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="1.5" />
              <path d="M12 6v6l3 3" fill="none" stroke="currentColor" stroke-width="1.5"
                stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            Live FOC, GPP, GPI & momentum
          </div>
          <div class="chip">
            üèπ Works offline in your browser
          </div>
          <span class="version-pill">v1.0.1 ¬∑ 2025-11-24</span>
        </div>
      </div>
      <div class="toolbar">
        <button id="themeToggle" type="button" class="theme-toggle">
          <span class="icon" aria-hidden="true">üåó</span>
          <span>Theme</span>
        </button>
        <div class="save-controls">
          <button id="saveBuildBtn" type="button" class="btn-primary btn">
            üíæ Save build
          </button>
          <button id="downloadInputsCsvBtn" type="button" class="btn">
            ‚¨áÔ∏è Inputs-only CSV
          </button>
        </div>
      </div>
    </header>

    <main>
      <!-- LEFT COLUMN: Inputs + FOC / Balance + Weight -->
      <section class="col">
        <!-- Bow -->
        <article class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                Bow
                <button type="button" class="info-icon" data-info-target="bow-info">i</button>
              </div>
              <div class="panel-subtitle">
                Basic bow setup so we can relate arrow weight to draw weight and estimate speed and momentum.
              </div>
              <div id="bow-info" class="info-text" hidden>
                Basic bow setup so we can relate arrow weight to draw weight and estimate speed and momentum.
              </div>
            </div>
          </div>
          <div class="field-grid">
            <div class="field">
              <label class="field-label" for="bowModel">
                Bow model &amp; year
                <span class="aux">(e.g. 2025 Hoyt RX-9)</span>
              </label>
              <input id="bowModel" type="text" placeholder="2025 Hoyt RX-9" />
            </div>
            <div class="field">
              <label class="field-label" for="shooterName">
                Shooter name
                <span class="aux">(optional)</span>
              </label>
              <input id="shooterName" type="text" placeholder="Shooter" />
            </div>
            <div class="field">
              <label class="field-label" for="drawWeight">
                Draw weight (lb)
              </label>
              <input id="drawWeight" type="number" min="10" max="100" step="0.5" value="70" />
            </div>
            <div class="field">
              <label class="field-label" for="drawLength">
                Draw length (in)
              </label>
              <input id="drawLength" type="number" min="20" max="34" step="0.25" value="28" />
            </div>
          </div>
        </article>

        <!-- Arrow Info -->
        <article class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                Arrow info
                <button type="button" class="info-icon" data-info-target="arrow-info">i</button>
              </div>
              <div class="panel-subtitle">
                High-level labels so you can compare different arrow builds.
              </div>
              <div id="arrow-info" class="info-text" hidden>
                High-level info so you can label and compare different arrow builds. Useful when saving multiple
                arrows or shooters.
              </div>
            </div>
          </div>
          <div class="field-grid">
            <div class="field">
              <label class="field-label" for="arrowName">
                Arrow name
                <span class="aux">(e.g. Easton 5.0 250 spine match grade)</span>
              </label>
              <input id="arrowName" type="text" placeholder="Easton 5.0 250 spine match grade" />
            </div>
            <div class="field">
              <label class="field-label" for="arrowSpine">
                Arrow spine
                <span class="aux">(e.g. 250, 300, 350)</span>
              </label>
              <input id="arrowSpine" type="number" min="150" max="800" step="10" placeholder="300" />
            </div>
          </div>
        </article>

        <!-- Arrow Shaft & Total Weight + Components -->
        <article class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                Arrow shaft &amp; total weight
                <button type="button" class="info-icon" data-info-target="shaft-info">i</button>
              </div>
              <div class="panel-subtitle">
                Arrow length and finished total arrow weight from your scale. Component details are optional.
              </div>
              <div id="shaft-info" class="info-text" hidden>
                Arrow length and the finished total arrow weight from your scale. Most people only need arrow length,
                total arrow weight, and balance point.
                If you enter a full component breakdown in the advanced section, that total will be used instead of this
                field.
              </div>
            </div>
          </div>
          <div class="field-grid">
            <div class="field">
              <label class="field-label" for="arrowLength">
                Arrow length (in)
              </label>
              <input id="arrowLength" type="number" min="20" max="36" step="0.25" value="28.25" />
            </div>
            <div class="field">
              <label class="field-label" for="totalArrowWeight">
                Total arrow weight (gr)
                <span class="aux">(finished arrow on scale)</span>
              </label>
              <input id="totalArrowWeight" type="number" min="200" max="900" step="0.1" value="500" />
            </div>
            <div class="field">
              <label class="field-label" for="balancePoint">
                Balance point (in from nock)
                <span class="aux">(measure to balance point)</span>
              </label>
              <input id="balancePoint" type="number" min="10" max="36" step="0.01" value="18.5" />
            </div>
            <div class="field">
              <label class="field-label" for="shaftGpiEstimate">
                Shaft GPI (auto)
                <span class="aux">(bare shaft gr √∑ arrow length)</span>
              </label>
              <input
                id="shaftGpiEstimate"
                type="number"
                step="0.01"
                placeholder="computed from bare shaft & length"
                readonly
              />
            </div>
          </div>

          <div class="toggle-row">
            <input id="showComponents" type="checkbox" />
            <label for="showComponents">
              Show advanced component breakdown
            </label>
          </div>

          <div id="componentsSection" class="panel" style="margin-top:6px; padding:8px 10px; display:none;">
            <div class="panel-header" style="margin-bottom:4px;">
              <div>
                <div class="panel-title" style="font-size:0.9rem;">
                  Components (Advanced)
                  <button type="button" class="info-icon" data-info-target="components-info">i</button>
                </div>
                <div class="panel-subtitle">
                  Detailed component weights are only needed if you track each part with a small scale.
                </div>
                <div id="components-info" class="info-text" hidden>
                  Detailed component weights, including bare shaft, are only needed if you track each part with a small
                  scale.
                  If you complete all the main component fields (bare shaft, nock, vanes, insert, point), the calculator
                  will use their sum as the total arrow weight.
                  Otherwise, it will use the total arrow weight field above.
                </div>
              </div>
            </div>
            <div class="field-grid">
              <div class="field">
                <label class="field-label" for="bareShaftWeight">
                  Bare shaft weight (gr)
                </label>
                <input id="bareShaftWeight" type="number" min="100" max="600" step="0.1" />
              </div>
              <div class="field">
                <label class="field-label" for="nockWeight">
                  Nock weight (gr)
                </label>
                <input id="nockWeight" type="number" min="3" max="30" step="0.1" />
              </div>
              <div class="field">
                <label class="field-label" for="wrapWeight">
                  Wrap weight (gr)
                  <span class="aux">(optional)</span>
                </label>
                <input id="wrapWeight" type="number" min="0" max="40" step="0.1" />
              </div>
              <div class="field">
                <label class="field-label" for="vaneCount">
                  Vane count
                </label>
                <input id="vaneCount" type="number" min="0" max="6" step="1" value="3" />
              </div>
              <div class="field">
                <label class="field-label" for="vaneWeight">
                  Vane weight (each, gr)
                </label>
                <input id="vaneWeight" type="number" min="1" max="25" step="0.1" />
              </div>
              <div class="field">
                <label class="field-label" for="insertWeight">
                  Insert / outsert / half-out (gr)
                </label>
                <input id="insertWeight" type="number" min="0" max="120" step="0.1" />
              </div>
              <div class="field">
                <label class="field-label" for="pointWeight">
                  Point weight (gr)
                </label>
                <input id="pointWeight" type="number" min="50" max="300" step="0.1" />
              </div>
              <div class="field">
                <label class="field-label" for="glueWeight">
                  Glue weight estimate (gr)
                  <span class="aux">(5‚Äì10 gr typical)</span>
                </label>
                <input id="glueWeight" type="number" min="0" max="30" step="0.1" />
              </div>
            </div>
          </div>
        </article>

        <!-- FOC & Balance & Weight Composition -->
        <article class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                FOC &amp; weight distribution
              </div>
              <div class="panel-subtitle">
                Visualize front-of-center, balance point, and how your arrow‚Äôs weight is distributed.
              </div>
            </div>
          </div>

          <div class="visual-section">
            <div class="visual-row">
              <!-- Arrow Balance -->
              <div>
                <div class="visual-header">
                  <div class="visual-title">
                    Arrow Balance (Nock ‚Üí Point)
                    <button type="button" class="info-icon" data-info-target="balance-info">i</button>
                  </div>
                </div>
                <div id="balance-info" class="info-text" hidden>
                  Green line = geometric center, orange marker = balance point (driven by FOC).
                </div>
                <div class="balance-bar">
                  <div class="balance-mid"></div>
                  <div id="balanceMarker" class="balance-marker" style="left:50%;"></div>
                </div>
                <div class="balance-labels">
                  <span>Nock end</span>
                  <span>Point end</span>
                </div>
                <div class="chip-tag" id="balanceSummaryTag">
                  Balance point:
                  <strong><span id="balancePointOut">0.0</span>"</strong> from nock
                </div>
              </div>

              <!-- FOC Shift Gauge -->
              <div>
                <div class="visual-header">
                  <div class="visual-title">
                    FOC Shift Gauge
                    <button type="button" class="info-icon" data-info-target="foc-gauge-info">i</button>
                  </div>
                </div>
                <div id="foc-gauge-info" class="info-text" hidden>
                  Shaded zone ‚âà common bowhunting FOC range (~10‚Äì18% forward of center).
                </div>
                <div class="gauge-bar">
                  <div class="gauge-range"></div>
                  <div id="focMarker" class="gauge-marker" style="left:50%;"></div>
                </div>
                <div class="gauge-axis-labels">
                  <span>-10%</span>
                  <span>+30%</span>
                </div>
                <div id="focTag" class="chip-tag">
                  FOC:
                  <strong><span id="focValue">0.0</span>%</strong>
                  <span id="focBandLabel">(no data)</span>
                </div>
              </div>
            </div>

            <!-- Weight Composition -->
            <div class="visual-section" style="margin-top:10px;">
              <div class="visual-header">
                <div class="visual-title">
                  Weight Composition
                  <button type="button" class="info-icon" data-info-target="weight-comp-info">i</button>
                </div>
              </div>
              <div id="weight-comp-info" class="info-text" hidden>
                Center line shows the halfway mark: if the blue shaft segment crosses it, more than half of total arrow
                weight is in the shaft.
              </div>
              <div class="weight-composition-layout">
                <div class="weight-bar">
                  <div id="shaftSegment" class="weight-segment shaft" style="width:40%;"></div>
                  <div id="pointSegment" class="weight-segment point" style="width:40%;"></div>
                  <div id="tailSegment" class="weight-segment tail" style="width:20%;"></div>
                  <div class="weight-midline"></div>
                </div>
                <div id="weightLegend" class="weight-legend">
                  Shaft: 0.0 gr (0.0%)
                  ‚Ä¢ Point system: 0.0 gr (0.0%)
                  ‚Ä¢ Nock / wrap / vanes + glue: 0.0 gr (0.0%)
                </div>
              </div>
            </div>
          </div>
        </article>
      </section>

      <!-- RIGHT COLUMN: Kinetics + Notes + Data Table -->
      <section class="col">
        <!-- Kinetics -->
        <article class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                Kinetics (FPS, Momentum &amp; Trajectory)
                <button type="button" class="info-icon" data-info-target="kinetics-info">i</button>
              </div>
              <div class="panel-subtitle">
                Estimate FPS, momentum at distance, and visualize your arrow‚Äôs flight.
              </div>
              <div id="kinetics-info" class="info-text" hidden>
                Momentum is computed as: (arrow grains √ó fps) / 225,400.
                These are still approximations, but they help compare different builds under similar conditions.
              </div>
            </div>
          </div>

          <!-- 1) FPS -->
          <div class="visual-section">
            <div class="visual-header">
              <div class="visual-title">1) FPS estimate</div>
            </div>
            <div class="field-grid">
              <div class="field">
                <label class="field-label" for="launchFps">
                  Launch FPS (estimated)
                  <span class="aux">(you can override this)</span>
                </label>
                <input
                  id="launchFps"
                  type="number"
                  min="120"
                  max="350"
                  step="1"
                  placeholder="auto or manual"
                />
              </div>
              <div class="field">
                <label class="field-label" for="speedLossPer10">
                  Speed loss per 10 yd (%)
                </label>
                <input id="speedLossPer10" type="number" min="0" max="10" step="0.1" value="3" />
              </div>
              <div class="field">
                <label class="field-label" for="distance1">
                  Distance 1 (yd)
                </label>
                <input id="distance1" type="number" min="5" max="150" step="1" value="30" />
              </div>
              <div class="field">
                <label class="field-label" for="distance2">
                  Distance 2 (yd, farthest)
                </label>
                <input id="distance2" type="number" min="5" max="150" step="1" value="60" />
              </div>
              <div class="field">
                <label class="field-label" for="fpsAtD1">
                  FPS @ Distance 1
                </label>
                <input id="fpsAtD1" type="number" readonly />
              </div>
              <div class="field">
                <label class="field-label" for="fpsAtD2">
                  FPS @ Distance 2
                </label>
                <input id="fpsAtD2" type="number" readonly />
              </div>
            </div>
          </div>

          <!-- 2) Game momentum band -->
          <div class="visual-section">
            <div class="visual-header">
              <div class="visual-title">2) Game momentum band (farthest distance)</div>
            </div>
            <div class="result-pill" style="margin-top:4px;">
              <div class="result-label">Momentum at farthest distance</div>
              <div class="result-value" id="momentumBandResult">
                At ~60 yd: 0.000 slug¬∑ft/s ‚Üí (no band yet)
              </div>
              <div class="result-note">
                Uses total arrow weight and FPS at your farthest distance to approximate kill-effectiveness bands.
              </div>
            </div>
            <div class="momentum-icons">
              <div id="iconSmall" class="game-icon muted">
                <span class="emoji">ü¶É</span>
                <span class="label">Small game</span>
              </div>
              <div id="iconDeer" class="game-icon muted">
                <span class="emoji">ü¶å</span>
                <span class="label">Deer-size</span>
              </div>
              <div id="iconElk" class="game-icon muted">
                <span class="emoji">ü´é</span>
                <span class="label">Large game</span>
              </div>
              <div id="iconDanger" class="game-icon muted">
                <span class="emoji">üêÉ</span>
                <span class="label">Very large / dangerous</span>
              </div>
            </div>
            <div class="learn-link" id="learnMomentum">
              Learn more about these bands
            </div>
          </div>

          <!-- 3) Trajectory Arc -->
          <div class="visual-section">
            <div class="visual-header">
              <div class="visual-title">
                3) Trajectory Arc (Distance vs Height)
                <button type="button" class="info-icon" data-info-target="trajectory-info">i</button>
              </div>
            </div>
            <div id="trajectory-info" class="info-text" hidden>
              Shows a simple arc from bow to target based on your arc range, with a little extra room beyond the target.
            </div>
            <div class="field-grid">
              <div class="field">
                <label class="field-label" for="arcRange">
                  Arc range (yd)
                  <span class="aux">(graph max distance)</span>
                </label>
                <input id="arcRange" type="number" min="10" max="155" step="1" value="60" />
              </div>
              <div class="field">
                <label class="field-label">
                  Peak height (ft) &amp; launch angle
                </label>
                <input id="arcMetaInline" type="text" readonly />
              </div>
            </div>
            <div class="trajectory-wrap">
              <svg id="trajectorySvg" class="trajectory-svg" viewBox="0 0 320 210" preserveAspectRatio="xMidYMid meet">
                <!-- Axes & arc drawn by JS -->
              </svg>
            </div>
            <div class="trajectory-meta" id="trajectorySummary">
              Horizontal axis ‚âà 0‚Äì61 yd (arc set to ~55 yd). Peak height ‚âà 3.8 ft, launch angle ‚âà 5.2¬∞, impact ‚âà
              0.585 slug¬∑ft/s.
            </div>
          </div>
        </article>

        <!-- Results + Notes + Data Table -->
        <article class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                Results &amp; notes
                <button type="button" class="info-icon" data-info-target="results-info">i</button>
              </div>
              <div class="panel-subtitle">
                Summary of your build with bands for FOC, GPP, GPI, and momentum.
              </div>
              <div id="results-info" class="info-text" hidden>
                FOC, GPP and GPI bands use common bowhunting guidelines. They are not hard rules, but useful zones to
                compare different setups.
              </div>
            </div>
          </div>

          <div class="results-grid">
            <div class="result-pill">
              <div class="result-label">Total arrow weight (used for calcs)</div>
              <div class="result-value">
                <span id="totalWeightOut">0.0</span> gr
              </div>
              <div class="result-note">
                Uses component sum when advanced breakdown is fully filled; otherwise uses Total arrow weight field.
              </div>
            </div>
            <div class="result-pill">
              <div class="result-label">Grains per pound (GPP)</div>
              <div class="result-value">
                <span id="gppValue">0.0</span> GPP
              </div>
              <div id="gppTag" class="chip-tag">
                GPP band: <strong><span id="gppBandLabel">(no data)</span></strong>
              </div>
            </div>
            <div class="result-pill">
              <div class="result-label">Arrow GPI (full arrow)</div>
              <div class="result-value">
                <span id="gpiFullValue">0.0</span> GPI
              </div>
              <div id="gpiTag" class="chip-tag">
                GPI band: <strong><span id="gpiBandLabel">(no data)</span></strong>
              </div>
            </div>
            <div class="result-pill">
              <div class="result-label">Momentum at farthest distance</div>
              <div class="result-value">
                <span id="momentumValue">0.000</span> slug¬∑ft/s
              </div>
              <div class="result-note">
                Your setup: <span id="momentumBandShort">0.000 slug¬∑ft/s ‚Üí (no band)</span>
              </div>
            </div>
          </div>

          <div class="notes-layout" style="margin-top:8px;">
            <div class="field">
              <label class="field-label" for="notes">
                Notes
                <span class="aux">(what this build is for ‚Äì e.g. elk 0‚Äì60 yd, TAC, practice)</span>
              </label>
              <textarea id="notes" placeholder="Hunting elk out to ~60 yd. Quiet, forgiving build."></textarea>
            </div>

            <!-- Saved build name + controls -->
            <div class="saved-row">
              <div class="field" style="flex:1;">
                <label class="field-label" for="savedBuildName">
                  Saved build name (auto-suggested)
                </label>
                <input id="savedBuildName" type="text" placeholder="2025-11 Hoyt RX-9 Easton 5.0 500 gr 70 lb draw" />
              </div>
              <button id="refreshNameBtn" type="button" class="btn">
                üîÅ Refresh name
              </button>
            </div>

            <div class="csv-row">
              <span class="small">Saved builds:</span>
              <select id="savedBuildsSelect" class="field" style="max-width:260px;">
                <option value="">(none yet)</option>
              </select>
              <button id="loadBuildBtn" type="button" class="btn">
                üìÇ Load selected
              </button>
            </div>

            <div class="csv-row">
              <span class="small">Upload inputs CSV:</span>
              <input id="csvUpload" type="file" accept=".csv" />
              <span class="small">(uses first data row, exported from this tool)</span>
            </div>
          </div>

          <!-- Data Table -->
          <div class="data-table-wrap" style="margin-top:8px;">
            <table>
              <thead>
                <tr>
                  <th>Field</th>
                  <th>Value</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody id="dataTableBody">
                <!-- Rows populated by JS -->
              </tbody>
            </table>
          </div>
        </article>
      </section>
    </main>
  </div>

  <script>
    const state = {
      inputs: {},
      computed: {},
      savedBuilds: []
    };

    const INPUT_FIELDS_ORDER = [
      'timestamp', 'buildName', 'bowModel', 'shooterName',
      'drawWeight', 'drawLength',
      'arrowName', 'arrowSpine',
      'arrowLength', 'totalArrowWeight', 'balancePoint',
      'bareShaftWeight', 'nockWeight', 'wrapWeight',
      'vaneCount', 'vaneWeight',
      'insertWeight', 'pointWeight', 'glueWeight',
      'notes'
    };

    function $(id) {
      return document.getElementById(id);
    }

    function getNum(id) {
      const el = $(id);
      if (!el) return 0;
      const v = parseFloat(el.value);
      return isNaN(v) ? 0 : v;
    }

    function getStr(id) {
      const el = $(id);
      return el ? (el.value || '').trim() : '';
    }

    function setText(id, value) {
      const el = $(id);
      if (el) el.textContent = value;
    }

    function setValue(id, value) {
      const el = $(id);
      if (el) el.value = value;
    }

    function toggleInfo(e) {
      const targetId = e.currentTarget.getAttribute('data-info-target');
      if (!targetId) return;
      const node = $(targetId);
      if (!node) return;
      node.hidden = !node.hidden;
    }

    function loadTheme() {
      const stored = localStorage.getItem('arrowTheme');
      const theme = stored === 'light' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', theme);
    }

    function toggleTheme() {
      const current = document.body.getAttribute('data-theme') || 'dark';
      const next = current === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', next);
      localStorage.setItem('arrowTheme', next);
    }

    function readInputs() {
      state.inputs = {
        bowModel: getStr('bowModel'),
        shooterName: getStr('shooterName'),
        drawWeight: getNum('drawWeight'),
        drawLength: getNum('drawLength'),
        arrowName: getStr('arrowName'),
        arrowSpine: getNum('arrowSpine'),
        arrowLength: getNum('arrowLength'),
        totalArrowWeight: getNum('totalArrowWeight'),
        balancePoint: getNum('balancePoint'),
        shaftGpiEstimate: getNum('shaftGpiEstimate'),
        showComponents: $('showComponents').checked,
        bareShaftWeight: getNum('bareShaftWeight'),
        nockWeight: getNum('nockWeight'),
        wrapWeight: getNum('wrapWeight'),
        vaneCount: getNum('vaneCount'),
        vaneWeight: getNum('vaneWeight'),
        insertWeight: getNum('insertWeight'),
        pointWeight: getNum('pointWeight'),
        glueWeight: getNum('glueWeight'),
        launchFpsManual: getNum('launchFps'),
        speedLossPer10: getNum('speedLossPer10'),
        distance1: getNum('distance1'),
        distance2: getNum('distance2'),
        arcRange: getNum('arcRange'),
        notes: getStr('notes')
      };
    }

    function calcTotalWeight() {
      const i = state.inputs;
      let componentsOk = false;
      if (i.showComponents) {
        if (i.bareShaftWeight > 0 && i.nockWeight >= 0 && i.vaneCount >= 0 &&
          i.vaneWeight >= 0 && i.insertWeight >= 0 && i.pointWeight > 0) {
          componentsOk = true;
        }
      }
      let totalComponents = 0;
      if (componentsOk) {
        const vanesTotal = i.vaneCount * i.vaneWeight;
        totalComponents = i.bareShaftWeight + i.nockWeight + i.wrapWeight +
          vanesTotal + i.insertWeight + i.pointWeight + i.glueWeight;
      }
      const total = componentsOk && totalComponents > 0
        ? totalComponents
        : i.totalArrowWeight;
      return {
        totalWeight: total,
        componentsUsed: componentsOk && totalComponents > 0,
        totalComponents
      };
    }

    function calcFOC(totalWeight) {
      const i = state.inputs;
      const L = i.arrowLength || 0;
      const bp = i.balancePoint || 0;
      if (L <= 0 || bp <= 0) {
        return { focPct: 0, band: 'no data', bandClass: 'bad' };
      }
      const center = L / 2;
      const foc = ((bp - center) / L) * 100;
      let band = 'no data';
      let bandClass = 'bad';
      if (foc < 8) {
        band = 'Low FOC';
        bandClass = 'warn';
      } else if (foc >= 8 && foc <= 10) {
        band = 'Borderline hunting FOC';
        bandClass = 'good';
      } else if (foc > 10 && foc <= 18) {
        band = 'Typical hunting FOC';
        bandClass = 'good';
      } else if (foc > 18 && foc <= 25) {
        band = 'High FOC';
        bandClass = 'warn';
      } else if (foc > 25) {
        band = 'Extreme FOC';
        bandClass = 'warn';
      }
      return { focPct: foc, band, bandClass };
    }

    function calcGPP(totalWeight) {
      const dw = state.inputs.drawWeight || 0;
      if (dw <= 0 || totalWeight <= 0) return { gpp: 0, band: 'no data', bandClass: 'bad' };
      const gpp = totalWeight / dw;
      let band = 'no data';
      let bandClass = 'bad';
      if (gpp < 5.3) {
        band = 'Very light';
        bandClass = 'warn';
      } else if (gpp >= 5.3 && gpp <= 6.3) {
        band = 'Light hunting';
        bandClass = 'good';
      } else if (gpp > 6.3 && gpp <= 8.0) {
        band = 'Typical hunting';
        bandClass = 'good';
      } else if (gpp > 8.0) {
        band = 'Heavy hunting';
        bandClass = 'warn';
      }
      return { gpp, band, bandClass };
    }

    function calcGPI(totalWeight) {
      const L = state.inputs.arrowLength || 0;
      if (L <= 0 || totalWeight <= 0) {
        return { gpi: 0, band: 'no data', bandClass: 'bad' };
      }
      const gpi = totalWeight / L;
      let band = 'no data';
      let bandClass = 'bad';
      if (gpi < 8) {
        band = 'Light full arrow';
        bandClass = 'warn';
      } else if (gpi >= 8 && gpi <= 10) {
        band = 'Typical hunting GPI';
        bandClass = 'good';
      } else if (gpi > 10) {
        band = 'Heavy full arrow';
        bandClass = 'warn';
      }
      return { gpi, band, bandClass };
    }

    function estimateLaunchFPS(totalWeight) {
      const dw = state.inputs.drawWeight || 0;
      if (dw <= 0 || totalWeight <= 0) return 0;
      const baseDw = 70;
      const baseWt = 500;
      let fps = 280 + (dw - baseDw) * 2 - (totalWeight - baseWt) / 5;
      if (isNaN(fps)) fps = 0;
      fps = Math.max(140, Math.min(340, fps));
      return fps;
    }

    function fpsAtDistance(launchFps, distanceYards) {
      const lossPer10 = state.inputs.speedLossPer10 || 0;
      if (launchFps <= 0) return 0;
      const segments = distanceYards / 10;
      const totalLossPct = (lossPer10 / 100) * segments;
      const remaining = launchFps * (1 - totalLossPct);
      return Math.max(0, remaining);
    }

    function calcMomentum(grains, fps) {
      if (grains <= 0 || fps <= 0) return 0;
      return (grains * fps) / 225400;
    }

    function classifyMomentumBand(momentum) {
      let band = 'no data';
      let bandClass = 'bad';
      if (momentum <= 0) {
        band = 'no data';
        bandClass = 'bad';
      } else if (momentum < 0.35) {
        band = 'Small game / practice';
        bandClass = 'warn';
      } else if (momentum >= 0.35 && momentum < 0.45) {
        band = 'Light deer / small game';
        bandClass = 'good';
      } else if (momentum >= 0.45 && momentum < 0.55) {
        band = 'Deer-sized game';
        bandClass = 'good';
      } else if (momentum >= 0.55 && momentum < 0.65) {
        band = 'Large game (elk / big hogs)';
        bandClass = 'good';
      } else if (momentum >= 0.65) {
        band = 'Very large / dangerous game';
        bandClass = 'warn';
      }
      return { band, bandClass };
    }

    function updateMomentumIcons(momentum) {
      const icons = [
        { id: 'iconSmall', min: 0, max: 0.45 },
        { id: 'iconDeer', min: 0.45, max: 0.55 },
        { id: 'iconElk', min: 0.55, max: 0.65 },
        { id: 'iconDanger', min: 0.65, max: 999 }
      ];
      icons.forEach(icon => {
        const el = $(icon.id);
        if (!el) return;
        el.classList.remove('active', 'muted');
        if (momentum <= 0) {
          el.classList.add('muted');
        } else if (momentum >= icon.min && momentum < icon.max) {
          el.classList.add('active');
        } else {
          el.classList.add('muted');
        }
      });
    }

    function updateFOCAndBalance(totalWeight, focInfo) {
      const i = state.inputs;
      const L = i.arrowLength || 0;
      const bp = i.balancePoint || 0;
      let balancePct = 50;
      if (L > 0 && bp > 0) {
        balancePct = Math.max(0, Math.min(100, (bp / L) * 100));
      }
      const marker = $('balanceMarker');
      if (marker) {
        marker.style.left = balancePct + '%';
      }
      setText('balancePointOut', bp.toFixed(2));

      const focMarker = $('focMarker');
      if (focMarker) {
        const scaled = Math.max(-10, Math.min(30, focInfo.focPct));
        const pct = ((scaled + 10) / 40) * 100;
        focMarker.style.left = pct + '%';
      }
      const focValue = isFinite(focInfo.focPct) ? focInfo.focPct.toFixed(1) : '0.0';
      setText('focValue', focValue);
      setText('focBandLabel', focInfo.band);
      const focTag = $('focTag');
      if (focTag) {
        focTag.classList.remove('good', 'warn', 'bad');
        focTag.classList.add(focInfo.bandClass || 'bad');
      }
    }

    function updateWeightComposition(totalWeight, componentsUsed) {
      const i = state.inputs;
      let shaft = 0, pointSystem = 0, tail = 0;

      if (componentsUsed) {
        shaft = i.bareShaftWeight || 0;
        pointSystem = (i.insertWeight || 0) + (i.pointWeight || 0);
        const tailPieces = (i.nockWeight || 0) + (i.wrapWeight || 0) +
          (i.vaneCount || 0) * (i.vaneWeight || 0) + (i.glueWeight || 0);
        tail = tailPieces;
      } else {
        if (totalWeight <= 0) {
          shaft = pointSystem = tail = 0;
        } else {
          shaft = totalWeight * 0.55;
          pointSystem = totalWeight * 0.35;
          tail = totalWeight * 0.10;
        }
      }

      const sum = shaft + pointSystem + tail;
      let sp = 0, pp = 0, tp = 0;
      if (sum > 0) {
        sp = (shaft / sum) * 100;
        pp = (pointSystem / sum) * 100;
        tp = (tail / sum) * 100;
      }

      const shaftSegment = $('shaftSegment');
      const pointSegment = $('pointSegment');
      const tailSegment = $('tailSegment');
      if (shaftSegment) shaftSegment.style.width = sp + '%';
      if (pointSegment) pointSegment.style.width = pp + '%';
      if (tailSegment) tailSegment.style.width = tp + '%';

      const legend = $('weightLegend');
      if (legend) {
        legend.textContent =
          `Shaft: ${shaft.toFixed(1)} gr (${sp.toFixed(1)} %)\n` +
          `Point system: ${pointSystem.toFixed(1)} gr (${pp.toFixed(1)} %)\n` +
          `Nock / wrap / vanes + glue: ${tail.toFixed(1)} gr (${tp.toFixed(1)} %)`;
      }
    }

    function drawTrajectory(totalWeight, launchFps, momentumAtFar) {
      const svg = $('trajectorySvg');
      if (!svg) return;
      while (svg.firstChild) svg.removeChild(svg.firstChild);

      const arcRange = state.inputs.arcRange || state.inputs.distance2 || 60;
      const extra = 5;
      const maxX = arcRange + extra;
      const viewWidth = 320;
      const viewHeight = 210;

      let peakHeightFt = Math.min((arcRange / 60) * 4.0, 12);
      if (arcRange <= 20) peakHeightFt = 1.0 + (arcRange / 20) * 2.0;

      const yMaxFeet = peakHeightFt * 1.4 || 6;

      const padLeft = 30;
      const padRight = 18;
      const padTop = 20;
      const padBottom = 35;
      const w = viewWidth - padLeft - padRight;
      const h = viewHeight - padTop - padBottom;

      function xScale(yd) {
        return padLeft + (yd / maxX) * w;
      }
      function yScale(ft) {
        const norm = Math.max(0, Math.min(yMaxFeet, ft));
        return padTop + h - (norm / yMaxFeet) * h;
      }

      const axis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      axis.setAttribute('x1', padLeft);
      axis.setAttribute('y1', padTop + h);
      axis.setAttribute('x2', padLeft + w);
      axis.setAttribute('y2', padTop + h);
      axis.setAttribute('stroke', 'rgba(148,163,184,0.9)');
      axis.setAttribute('stroke-width', '1');
      svg.appendChild(axis);

      const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      yAxis.setAttribute('x1', padLeft);
      yAxis.setAttribute('y1', padTop);
      yAxis.setAttribute('x2', padLeft);
      yAxis.setAttribute('y2', padTop + h);
      yAxis.setAttribute('stroke', 'rgba(148,163,184,0.8)');
      yAxis.setAttribute('stroke-width', '1');
      svg.appendChild(yAxis);

      const xLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      xLabel.textContent = 'Distance (yd)';
      xLabel.setAttribute('x', padLeft + w / 2);
      xLabel.setAttribute('y', padTop + h + 22);
      xLabel.setAttribute('fill', 'rgba(148,163,184,0.95)');
      xLabel.setAttribute('font-size', '10');
      xLabel.setAttribute('text-anchor', 'middle');
      svg.appendChild(xLabel);

      const yLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      yLabel.textContent = 'Height (ft)';
      yLabel.setAttribute('x', padLeft - 22);
      yLabel.setAttribute('y', padTop + h / 2);
      yLabel.setAttribute('fill', 'rgba(148,163,184,0.95)');
      yLabel.setAttribute('font-size', '10');
      yLabel.setAttribute('text-anchor', 'middle');
      yLabel.setAttribute('transform', `rotate(-90 ${padLeft - 22} ${padTop + h / 2})`);
      svg.appendChild(yLabel);

      const tick0 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      tick0.textContent = '0';
      tick0.setAttribute('x', xScale(0));
      tick0.setAttribute('y', padTop + h + 14);
      tick0.setAttribute('fill', 'rgba(148,163,184,0.8)');
      tick0.setAttribute('font-size', '9');
      tick0.setAttribute('text-anchor', 'middle');
      svg.appendChild(tick0);

      const tickMax = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      tickMax.textContent = `${maxX.toFixed(0)}`;
      tickMax.setAttribute('x', xScale(maxX));
      tickMax.setAttribute('y', padTop + h + 14);
      tickMax.setAttribute('fill', 'rgba(148,163,184,0.8)');
      tickMax.setAttribute('font-size', '9');
      tickMax.setAttribute('text-anchor', 'middle');
      svg.appendChild(tickMax);

      const tickYmax = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      tickYmax.textContent = `${yMaxFeet.toFixed(1)}`;
      tickYmax.setAttribute('x', padLeft - 4);
      tickYmax.setAttribute('y', yScale(yMaxFeet) + 3);
      tickYmax.setAttribute('fill', 'rgba(148,163,184,0.8)');
      tickYmax.setAttribute('font-size', '9');
      tickYmax.setAttribute('text-anchor', 'end');
      svg.appendChild(tickYmax);

      const tickY0 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      tickY0.textContent = `0.0`;
      tickY0.setAttribute('x', padLeft - 4);
      tickY0.setAttribute('y', yScale(0) + 3);
      tickY0.setAttribute('fill', 'rgba(148,163,184,0.8)');
      tickY0.setAttribute('font-size', '9');
      tickY0.setAttribute('text-anchor', 'end');
      svg.appendChild(tickY0);

      const midX = arcRange / 2;
      const arcPoints = [];
      const n = 40;
      for (let k = 0; k <= n; k++) {
        const yd = (arcRange * k) / n;
        const t = yd / arcRange;
        const height = 4 * peakHeightFt * t * (1 - t);
        arcPoints.push({ yd, height });
      }

      let d = '';
      arcPoints.forEach((p, idx) => {
        const x = xScale(p.yd);
        const y = yScale(p.height);
        if (idx === 0) d += `M ${x} ${y}`;
        else d += ` L ${x} ${y}`;
      });
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', d);
      path.setAttribute('fill', 'none');
      path.setAttribute('stroke', '#22c55e');
      path.setAttribute('stroke-width', '2');
      svg.appendChild(path);

      const midHeight = 4 * peakHeightFt * 0.5 * (1 - 0.5);
      const launchAngle = Math.atan((midHeight * 2) / arcRange) * (180 / Math.PI);
      const impactY = 0;
      const impactX = arcRange;

      const angleText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      angleText.textContent = `Angle ‚âà ${launchAngle.toFixed(1)}¬∞`;
      angleText.setAttribute('x', padLeft + 4);
      angleText.setAttribute('y', yScale(peakHeightFt) - 10);
      angleText.setAttribute('fill', 'rgba(248,250,252,0.9)');
      angleText.setAttribute('font-size', '10');
      angleText.setAttribute('text-anchor', 'start');
      svg.appendChild(angleText);

      const momentumText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      momentumText.textContent = `${momentumAtFar.toFixed(3)} slug¬∑ft/s`;
      const mx = xScale(impactX) + 4;
      const my = yScale(impactY) - 6;
      momentumText.setAttribute('x', Math.min(mx, padLeft + w - 4));
      momentumText.setAttribute('y', my);
      momentumText.setAttribute('fill', 'rgba(248,250,252,0.9)');
      momentumText.setAttribute('font-size', '10');
      momentumText.setAttribute('text-anchor', 'start');
      svg.appendChild(momentumText);

      const arcMetaInline = $('arcMetaInline');
      if (arcMetaInline) {
        arcMetaInline.value =
          `Peak ‚âà ${peakHeightFt.toFixed(1)} ft, angle ‚âà ${launchAngle.toFixed(1)}¬∞, ` +
          `impact ‚âà ${momentumAtFar.toFixed(3)} slug¬∑ft/s`;
      }

      const summary = $('trajectorySummary');
      if (summary) {
        summary.textContent =
          `Horizontal axis ‚âà 0‚Äì${maxX.toFixed(0)} yd (arc set to ~${arcRange.toFixed(0)} yd). ` +
          `Peak height ‚âà ${peakHeightFt.toFixed(1)} ft, launch angle ‚âà ${launchAngle.toFixed(1)}¬∞, ` +
          `impact ‚âà ${momentumAtFar.toFixed(3)} slug¬∑ft/s.`;
      }
    }

    function buildDataTableRows(totalWeight, focInfo, gppInfo, gpiInfo, momentumInfo, momentumValue, trajectorySummaryText, weightLegendText) {
      const tbody = $('dataTableBody');
      if (!tbody) return;
      while (tbody.firstChild) tbody.removeChild(tbody.firstChild);

      const i = state.inputs;
      const now = new Date();
      const ts = now.toISOString();
      const tsLocal = now.toLocaleString();

      const rows = [
        { field: 'Timestamp', value: tsLocal, type: 'calc' },
        { field: 'Shooter', value: i.shooterName || '', type: 'input' },
        { field: 'Bow model & year', value: i.bowModel || '', type: 'input' },
        { field: 'Draw weight (lb)', value: i.drawWeight || '', type: 'input' },
        { field: 'Draw length (in)', value: i.drawLength || '', type: 'input' },
        { field: 'Arrow name', value: i.arrowName || '', type: 'input' },
        { field: 'Arrow spine', value: i.arrowSpine || '', type: 'input' },
        { field: 'Arrow length (in)', value: i.arrowLength || '', type: 'input' },
        { field: 'Total arrow weight (gr, used)', value: totalWeight.toFixed(1), type: 'calc' },
        { field: 'FOC (%)', value: focInfo.focPct.toFixed(2), type: 'calc' },
        { field: 'FOC band', value: focInfo.band, type: 'calc' },
        { field: 'GPP', value: gppInfo.gpp.toFixed(2), type: 'calc' },
        { field: 'GPP band', value: gppInfo.band, type: 'calc' },
        { field: 'Arrow GPI (full)', value: gpiInfo.gpi.toFixed(2), type: 'calc' },
        { field: 'GPI band', value: gpiInfo.band, type: 'calc' },
        { field: 'Momentum at farthest distance (slug¬∑ft/s)', value: momentumValue.toFixed(3), type: 'calc' },
        { field: 'Game momentum band (farthest distance)', value: momentumInfo.band, type: 'calc' },
        { field: 'Trajectory summary', value: trajectorySummaryText, type: 'calc' },
        { field: 'Weight composition breakdown', value: weightLegendText.replace(/\n/g, ' | '), type: 'calc' },
        { field: 'Notes', value: i.notes || '', type: 'input' }
      ];

      rows.forEach(r => {
        const tr = document.createElement('tr');
        const tdField = document.createElement('td');
        const tdValue = document.createElement('td');
        const tdType = document.createElement('td');
        tdField.textContent = r.field;
        tdValue.textContent = r.value;
        const span = document.createElement('span');
        span.className = 'type-badge ' + (r.type === 'input' ? 'input' : 'calc');
        span.textContent = r.type === 'input' ? 'input' : 'calc';
        tdType.appendChild(span);
        tr.appendChild(tdField);
        tr.appendChild(tdValue);
        tr.appendChild(tdType);
        tbody.appendChild(tr);
      });

      state.computed.lastDataTableTimestamp = ts;
    }

    function refreshSavedBuildName(totalWeight, focInfo) {
      const now = new Date();
      const ym = now.toISOString().slice(0, 7);
      const model = state.inputs.bowModel || '';
      const arrowName = state.inputs.arrowName || '';
      const weightStr = `${totalWeight.toFixed(0)} gr`;
      const drawStr = state.inputs.drawWeight ? `${state.inputs.drawWeight.toFixed(0)} lb draw` : '';
      const focStr = `FOC ${focInfo.focPct.toFixed(1)}%`;

      const pieces = [ym, model, arrowName, weightStr, drawStr, focStr].filter(Boolean);
      const autoName = pieces.join(' ');
      setValue('savedBuildName', autoName);
    }

    function saveBuild() {
      const totalInfo = calcTotalWeight();
      const totalWeight = totalInfo.totalWeight || 0;
      const focInfo = calcFOC(totalWeight);
      const gppInfo = calcGPP(totalWeight);
      const gpiInfo = calcGPI(totalWeight);
      let launchFps = state.inputs.launchFpsManual || 0;
      if (!launchFps) {
        launchFps = estimateLaunchFPS(totalWeight);
      }
      const farFps = fpsAtDistance(launchFps, state.inputs.distance2 || 60);
      const momentumVal = calcMomentum(totalWeight, farFps);
      const momentumInfo = classifyMomentumBand(momentumVal);
      const trajectorySummaryText = $('trajectorySummary') ? $('trajectorySummary').textContent : '';
      const weightLegendText = $('weightLegend') ? $('weightLegend').textContent : '';

      const now = new Date();
      const ts = now.toISOString();

      const buildName = getStr('savedBuildName') ||
        `Build ${now.toLocaleString()}`;

      const build = {
        timestamp: ts,
        buildName,
        inputs: { ...state.inputs },
        computed: {
          totalWeight,
          focPct: focInfo.focPct,
          focBand: focInfo.band,
          gpp: gppInfo.gpp,
          gppBand: gppInfo.band,
          gpi: gpiInfo.gpi,
          gpiBand: gpiInfo.band,
          launchFps,
          momentumAtFar: momentumVal,
          momentumBand: momentumInfo.band,
          trajectorySummary: trajectorySummaryText,
          weightLegend: weightLegendText
        }
      };

      state.savedBuilds.push(build);
      try {
        localStorage.setItem('arrowBuilds', JSON.stringify(state.savedBuilds));
      } catch (e) {
        console.warn('Could not persist builds to localStorage', e);
      }
      renderSavedBuildsSelect();
    }

    function loadSavedBuildsFromStorage() {
      try {
        const raw = localStorage.getItem('arrowBuilds');
        if (!raw) return;
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) {
          state.savedBuilds = arr;
        }
      } catch (e) {
        console.warn('Error loading saved builds', e);
      }
    }

    function renderSavedBuildsSelect() {
      const select = $('savedBuildsSelect');
      if (!select) return;
      while (select.firstChild) select.removeChild(select.firstChild);
      const empty = document.createElement('option');
      empty.value = '';
      empty.textContent = '(none yet)';
      select.appendChild(empty);

      state.savedBuilds.forEach((b, idx) => {
        const opt = document.createElement('option');
        opt.value = String(idx);
        const dt = new Date(b.timestamp);
        const label = `${dt.toLocaleDateString()} ‚Äì ${b.buildName}`;
        opt.textContent = label;
        select.appendChild(opt);
      });
    }

    function loadBuildIntoForm(index) {
      const idx = parseInt(index, 10);
      if (isNaN(idx) || idx < 0 || idx >= state.savedBuilds.length) return;
      const build = state.savedBuilds[idx];
      const i = build.inputs || {};
      $('bowModel').value = i.bowModel || '';
      $('shooterName').value = i.shooterName || '';
      $('drawWeight').value = i.drawWeight || '';
      $('drawLength').value = i.drawLength || '';
      $('arrowName').value = i.arrowName || '';
      $('arrowSpine').value = i.arrowSpine || '';
      $('arrowLength').value = i.arrowLength || '';
      $('totalArrowWeight').value = i.totalArrowWeight || '';
      $('balancePoint').value = i.balancePoint || '';
      $('shaftGpiEstimate').value = ''; // will be recomputed
      $('showComponents').checked = !!i.showComponents;
      $('componentsSection').style.display = i.showComponents ? 'block' : 'none';
      $('bareShaftWeight').value = i.bareShaftWeight || '';
      $('nockWeight').value = i.nockWeight || '';
      $('wrapWeight').value = i.wrapWeight || '';
      $('vaneCount').value = i.vaneCount || '';
      $('vaneWeight').value = i.vaneWeight || '';
      $('insertWeight').value = i.insertWeight || '';
      $('pointWeight').value = i.pointWeight || '';
      $('glueWeight').value = i.glueWeight || '';
      $('speedLossPer10').value = i.speedLossPer10 || '';
      $('distance1').value = i.distance1 || '';
      $('distance2').value = i.distance2 || '';
      $('arcRange').value = i.arcRange || i.distance2 || '';
      $('notes').value = i.notes || '';
      $('launchFps').value = i.launchFpsManual || ''; // user can still override
      $('savedBuildName').value = build.buildName || '';

      readInputs();
      recalcAndRender();
    }

    function downloadInputsCsv() {
      if (!state.savedBuilds.length) {
        saveBuild();
      }
      if (!state.savedBuilds.length) return;
      const lines = [];
      lines.push(INPUT_FIELDS_ORDER.join(','));
      state.savedBuilds.forEach(build => {
        const row = [];
        const i = build.inputs || {};
        const c = build.computed || {};
        const map = {
          timestamp: build.timestamp || '',
          buildName: build.buildName || '',
          bowModel: i.bowModel || '',
          shooterName: i.shooterName || '',
          drawWeight: i.drawWeight || '',
          drawLength: i.drawLength || '',
          arrowName: i.arrowName || '',
          arrowSpine: i.arrowSpine || '',
          arrowLength: i.arrowLength || '',
          totalArrowWeight: i.totalArrowWeight || '',
          balancePoint: i.balancePoint || '',
          bareShaftWeight: i.bareShaftWeight || '',
          nockWeight: i.nockWeight || '',
          wrapWeight: i.wrapWeight || '',
          vaneCount: i.vaneCount || '',
          vaneWeight: i.vaneWeight || '',
          insertWeight: i.insertWeight || '',
          pointWeight: i.pointWeight || '',
          glueWeight: i.glueWeight || '',
          notes: i.notes || ''
        };
        INPUT_FIELDS_ORDER.forEach(key => {
          let v = map[key];
          if (v === undefined || v === null) v = '';
          const s = String(v).replace(/"/g, '""');
          row.push('"' + s + '"');
        });
        lines.push(row.join(','));
      });

      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'arrow-tune-inputs.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function handleCsvUpload(evt) {
      const file = evt.target.files && evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        if (typeof text !== 'string') return;
        const lines = text.trim().split(/\r?\n/);
        if (lines.length < 2) return;
        const header = lines[0].split(',');
        const dataLine = lines[1];
        const cols = dataLine.split(',');
        const map = {};
        header.forEach((hRaw, idx) => {
          const h = hRaw.replace(/^"|"$/g, '');
          const valRaw = cols[idx] || '';
          const val = valRaw.replace(/^"|"$/g, '').replace(/""/g, '"');
          map[h.trim()] = val;
        });

        INPUT_FIELDS_ORDER.forEach(key => {
          const v = map[key];
          if (v === undefined) return;
          switch (key) {
            case 'timestamp':
            case 'buildName':
              break;
            case 'bowModel':
              setValue('bowModel', v);
              break;
            case 'shooterName':
              setValue('shooterName', v);
              break;
            case 'drawWeight':
              setValue('drawWeight', v);
              break;
            case 'drawLength':
              setValue('drawLength', v);
              break;
            case 'arrowName':
              setValue('arrowName', v);
              break;
            case 'arrowSpine':
              setValue('arrowSpine', v);
              break;
            case 'arrowLength':
              setValue('arrowLength', v);
              break;
            case 'totalArrowWeight':
              setValue('totalArrowWeight', v);
              break;
            case 'balancePoint':
              setValue('balancePoint', v);
              break;
            case 'bareShaftWeight':
              setValue('bareShaftWeight', v);
              break;
            case 'nockWeight':
              setValue('nockWeight', v);
              break;
            case 'wrapWeight':
              setValue('wrapWeight', v);
              break;
            case 'vaneCount':
              setValue('vaneCount', v);
              break;
            case 'vaneWeight':
              setValue('vaneWeight', v);
              break;
            case 'insertWeight':
              setValue('insertWeight', v);
              break;
            case 'pointWeight':
              setValue('pointWeight', v);
              break;
            case 'glueWeight':
              setValue('glueWeight', v);
              break;
            case 'notes':
              setValue('notes', v);
              break;
          }
        });

        $('showComponents').checked = true;
        $('componentsSection').style.display = 'block';
        readInputs();
        recalcAndRender();
      };
      reader.readAsText(file);
    }

    function recalcAndRender() {
      const totalInfo = calcTotalWeight();
      const totalWeight = totalInfo.totalWeight || 0;
      const focInfo = calcFOC(totalWeight);
      const gppInfo = calcGPP(totalWeight);
      const gpiInfo = calcGPI(totalWeight);

      // Launch FPS: use manual if provided, else estimate
      let launchFps = state.inputs.launchFpsManual || 0;
      if (!launchFps) {
        launchFps = estimateLaunchFPS(totalWeight);
      }

      const fpsD1 = fpsAtDistance(launchFps, state.inputs.distance1 || 30);
      const fpsD2 = fpsAtDistance(launchFps, state.inputs.distance2 || 60);
      const momentumVal = calcMomentum(totalWeight, fpsD2);
      const momentumInfo = classifyMomentumBand(momentumVal);

      // Auto-calc Shaft GPI (bare shaft gr √∑ arrow length)
      let shaftGpi = 0;
      if (state.inputs.bareShaftWeight > 0 && state.inputs.arrowLength > 0) {
        shaftGpi = state.inputs.bareShaftWeight / state.inputs.arrowLength;
      }
      const shaftGpiField = $('shaftGpiEstimate');
      if (shaftGpiField) {
        shaftGpiField.value = shaftGpi > 0 ? shaftGpi.toFixed(2) : '';
      }

      setText('totalWeightOut', totalWeight.toFixed(1));
      setText('gppValue', gppInfo.gpp.toFixed(2));
      setText('gppBandLabel', gppInfo.band);
      const gppTag = $('gppTag');
      if (gppTag) {
        gppTag.classList.remove('good', 'warn', 'bad');
        gppTag.classList.add(gppInfo.bandClass || 'bad');
      }

      setText('gpiFullValue', gpiInfo.gpi.toFixed(2));
      setText('gpiBandLabel', gpiInfo.band);
      const gpiTag = $('gpiTag');
      if (gpiTag) {
        gpiTag.classList.remove('good', 'warn', 'bad');
        gpiTag.classList.add(gpiInfo.bandClass || 'bad');
      }

      setValue('launchFps', launchFps ? launchFps.toFixed(0) : '');
      setValue('fpsAtD1', fpsD1 ? fpsD1.toFixed(0) : '');
      setValue('fpsAtD2', fpsD2 ? fpsD2.toFixed(0) : '');
      setText('momentumValue', momentumVal.toFixed(3));
      const bandText = `Your setup: ${momentumVal.toFixed(3)} slug¬∑ft/s ‚Üí in the '${momentumInfo.band}' band.`;
      setText('momentumBandShort', bandText);
      setText('momentumBandResult', `At ~${(state.inputs.distance2 || 60).toFixed(0)} yd: ${momentumVal.toFixed(3)} slug¬∑ft/s ‚Üí in the '${momentumInfo.band}' band.`);
      updateMomentumIcons(momentumVal);

      updateFOCAndBalance(totalWeight, focInfo);
      updateWeightComposition(totalWeight, totalInfo.componentsUsed);

      if (!state.inputs.arcRange) {
        state.inputs.arcRange = state.inputs.distance2 || 60;
        setValue('arcRange', state.inputs.arcRange);
      }

      drawTrajectory(totalWeight, launchFps, momentumVal);

      const trajectorySummaryText = $('trajectorySummary') ? $('trajectorySummary').textContent : '';
      const weightLegendText = $('weightLegend') ? $('weightLegend').textContent : '';

      buildDataTableRows(
        totalWeight,
        focInfo,
        gppInfo,
        gpiInfo,
        momentumInfo,
        momentumVal,
        trajectorySummaryText,
        weightLegendText
      );

      refreshSavedBuildName(totalWeight, focInfo);
    }

    function onAnyInputChange(e) {
      if (e && e.target && e.target.id === 'distance2') {
        const d2 = getNum('distance2');
        if (d2 > 0) {
          setValue('arcRange', d2);
        }
      }
      readInputs();
      const show = state.inputs.showComponents;
      $('componentsSection').style.display = show ? 'block' : 'none';
      recalcAndRender();
    }

    function onArcRangeChange() {
      state.inputs.arcRange = getNum('arcRange');
      recalcAndRender();
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadTheme();
      document.querySelectorAll('.info-icon').forEach(btn => {
        btn.addEventListener('click', toggleInfo);
      });
      const themeToggle = $('themeToggle');
      if (themeToggle) themeToggle.addEventListener('click', toggleTheme);

      document.querySelectorAll('input, textarea, select').forEach(el => {
        if (el.id === 'arcRange') {
          el.addEventListener('input', onArcRangeChange);
        } else if (el.id === 'csvUpload') {
          el.addEventListener('change', handleCsvUpload);
        } else {
          el.addEventListener('input', onAnyInputChange);
        }
      });

      const showComponents = $('showComponents');
      if (showComponents) {
        showComponents.addEventListener('change', onAnyInputChange);
      }

      const saveBtn = $('saveBuildBtn');
      if (saveBtn) saveBtn.addEventListener('click', () => {
        readInputs();
        recalcAndRender();
        saveBuild();
      });

      const refreshNameBtn = $('refreshNameBtn');
      if (refreshNameBtn) refreshNameBtn.addEventListener('click', () => {
        readInputs();
        const totalInfo = calcTotalWeight();
        const totalWeight = totalInfo.totalWeight || 0;
        const focInfo = calcFOC(totalWeight);
        refreshSavedBuildName(totalWeight, focInfo);
      });

      const loadBuildBtn = $('loadBuildBtn');
      if (loadBuildBtn) loadBuildBtn.addEventListener('click', () => {
        const select = $('savedBuildsSelect');
        if (!select) return;
        const idx = select.value;
        if (!idx) return;
        loadBuildIntoForm(idx);
      });

      const downloadInputsCsvBtn = $('downloadInputsCsvBtn');
      if (downloadInputsCsvBtn) downloadInputsCsvBtn.addEventListener('click', downloadInputsCsv);

      const learnMomentum = $('learnMomentum');
      if (learnMomentum) {
        learnMomentum.addEventListener('click', () => {
          alert(
            'These bands are based on commonly-cited bowhunting guidelines:\n' +
            '- ~0.35 slug¬∑ft/s: small game / practice\n' +
            '- ~0.45 slug¬∑ft/s: deer-sized game\n' +
            '- ~0.55 slug¬∑ft/s: large game (elk / big hogs)\n' +
            '- ~0.65 slug¬∑ft/s and above: very large / dangerous game\n\n' +
            'Momentum is computed as: (arrow grains √ó fps) / 225,400. Values are approximate, but they help compare builds.'
          );
        });
      }

      loadSavedBuildsFromStorage();
      renderSavedBuildsSelect();
      readInputs();
      recalcAndRender();
    });
  </script>
</body>
</html>
